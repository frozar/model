<!-- NAME: main.tpl -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
  <head>
    <title>L i n u x [inetdoc]: (Guides) </title>
    <meta HTTP-EQUIV="Content-Type" content="text/html; charset=ISO-8859-1">
    <meta name="Content-Language" content="fr">
    <meta name="description" content="inet doc linux">
    <meta name="author" content="philippe.latu@linux-france.org">
    <meta name="copyright" content="(c)2000 Philippe Latu">
    <meta name="publisher" content="philippe.latu@linux-france.org">
    <meta name="keywords" content="documentation, ethernet, formation, guide, ieee, ifconfig, inet, interface, ip, iproute2, iptables, isdn, IUT, IUP, latu, linux, net, OSI, ping, reseau, RNIS, route, routage, TCP, TCP/IP, UDP">
    <meta name="audience" content="All, Tous">
    <meta name="robots" content="INDEX,FOLLOW">
    <link rel="STYLESHEET" type="text/css" href="/prj/inetdoc/style/docstyle.css">
    <script language="javascript" type="text/javascript">
      <!-- for javascript enabled browser's only
        if (top.location != location) top.location.href = location.href;
	
        function popup(form) {
          optionIndex = form.banner.SelectedIndex;
          if (optionIndex == 0) return;
          location.href = form.banner.options[form.banner.selectedIndex].value;
          }
      // end script hiding -->
    </script>
  </head>
<BODY BGCOLOR="#FFFFFF" TEXT="#990000" LINK="#990000" VLINK="#990000" ALINK="#990000" leftMargin="0" topMargin="0" marginheight="0" marginwidth="0">
<TABLE width=100% border=0 cellspacing=2 cellpadding=0 align=center>
  <TR>
    <TD width=25% bgcolor=#990000 align=center valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
        <TR align=right> 
	  <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
      	</TR>
	<TR>
	  <TD bgcolor=#990000 align=center>
	    <a class="nodecor" href="/prj/inetdoc">
              <IMG src="/prj/inetdoc/images/upleft.png" border=0 width=158 height=96 hspace=10 alt="logo">
      	    </a>
	  <TD>
	</TR>
      </TABLE>
    </TD>
    <TD width=75% bgcolor=#FFFFFF align=left valign=top>
      <!-- banner menu start -->
      <form>
        <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
	  <!-- 1st row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor=#FF9966>
	      <TABLE width="100%" border="0" cellspacing="3" cellpadding="0" width="100%">
	        <TR>
		  <th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/">&nbsp;Accueil</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/articles/">&nbsp;Articles</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/courses/">&nbsp;Cours</a>
</th>
<th align="left" valign="top" bgcolor="white">
  <a class="reduced" href="/prj/inetdoc/i/net/guides/">&nbsp;Guides</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/formation/">&nbsp;Formation</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/download/">&nbsp;Téléchargement</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/source/">&nbsp;Source</a>
</th>

		</TR>
	      </TABLE>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#FFFFFF><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <!-- 2nd row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor=#FFCC66>
	      <FONT color=#990000 size=-1 face="Arial, 'Myriad Web', Syntax, sans-serif"><B>
	       <SELECT name="banner" onChange="popup(this.form)">
	         <OPTION value="/prj/inetdoc/i/net/../../download/NAT-HOWTO.pdf">
  Téléchargement NAT HOWTO VF
</OPTION>
<OPTION value="/prj/inetdoc/i/net/guides/">
  Autres guides
</OPTION>

	       </SELECT>
	      </B></FONT>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#FFFFFF><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <!-- 3rd row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor="#990000" align="left" valign="middle" width="100%" height="100%">
	      <div class="browse"><font size=1>&nbsp;&nbsp;Références : <a href="http://netfilter.kernelnotes.org/" class="browse"><font size=1>Netfilter Home</font></a>&nbsp;
</font></div>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	</TABLE>
      </form>
      <!-- banner menu end -->
    </TD>
  </TR>
  <TR>
    <TD width=25% bgcolor=#330066 align=left valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
        <TR align=right> 
	  <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	</TR>
	<TR>
	  <TD bgcolor=#330066 align=center>
	    &nbsp;<!-- no Toc section in guides/NAT-HOWTO/NAT-HOWTO.html -->
      	    <br>
      	    <TABLE width=100% border=0 cellpadding=0 cellspacing=4>
              <TR>
	  	<TD bgcolor=#000000 align=center>
	    	  <TABLE width=100% border=0 cellpadding=2 cellspacing=1>
              	    <TR>
	              <TH bgcolor=#FFCC66 align="center" valign="top" class="toc-title">
		        <a class="toc-title" href="mailto:philippe.latu@linux-france.org">
	        	  Contact<img src="/prj/inetdoc/images/envelope.gif" border=0 width=50 height=35 align="middle" alt="mail">
		  	</a>
		      </TH>
              	    </TR>
              	    <TR>
	              <TD bgcolor=#FFCC99 align=center valign=top class="toc-item">
		        &nbsp;<a class="toc-item" href="/prj/inetdoc/log/">Carnet de bord</a>
		      </TD>
              	    </TR>
              	    <TR>
	              <TD bgcolor=#FFCC99 align=center valign=top class="toc-item">
		  	&nbsp;<a class="toc-item" href="/prj/inetdoc/legal/">Notice légale</a>
		      </TD>
              	    </TR>
            	  </TABLE>
	  	</TD>
              </TR>
      	    </TABLE>
          </TD>
        </TR>
      </TABLE>
    </TD>
    <TD width=75% bgcolor=#FFFFFF align=left valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=8 align=center>
        <TR>
	  <TD bgcolor=#FFFFFF align=left valign=top>
            <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta name="generator" content=
"HTML Tidy for Linux/x86 (vers 1st March 2002), see www.w3.org">
<meta name="GENERATOR" content="LinuxDoc-Tools 0.9.21">
<title>Linux 2.4 NAT HOWTO: Specifier Comment Modifier Les
Paquets</title>
<link href="NAT-HOWTO-7.html" rel="next">
<link href="NAT-HOWTO-5.html" rel="previous">
<link href="NAT-HOWTO.html#toc6" rel="contents">
</head>
<body>
<a href="NAT-HOWTO-7.html">Page suivante</a> <a href=
"NAT-HOWTO-5.html">Page précédente</a> <a href=
"NAT-HOWTO.html#toc6">Table des matières</a> 

<hr>
<h2><a name="s6">6.</a> <a href="NAT-HOWTO.html#toc6">Specifier
Comment Modifier Les Paquets</a></h2>

<p>Maintenant nous savons comment selectionner les paquets à
modifier. Pour completer notre règle, nous devons dire au noyau
exactement ce qu'il doit faire avec les paquets.</p>

<h2><a name="ss6.1">6.1</a> <a href="NAT-HOWTO.html#toc6.1">NAT
Source</a></h2>

<p>Tu veux effectuer du NAT Source; changer l'adresse source des
connections en quelque chose de différent. Ceci est réalisé dans la
chaine POSTROUTING, juste avant que il ne soit finallement envoyé;
c'est un détail important, car il veut dire que tout sur la machine
linux elle-mème (routage, filtrage de paquets) verra le paquet non
modifié. Ca veut aussi dire que l'option `-o' (interface de sortie)
peut être utilisée.</p>

<p>Le NAT Source est spécifié en utilisant les options `-j SNAT',
et `--to-source' qui spécifie une adresse IP, un bloc d'adresses
IP, et un port ou un bloc de ports optionnels (pour UDP et TCP
seulement).</p>

<blockquote>
<pre>
<code>## Changer l'adresse source en 1.2.3.4.
# iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to 1.2.3.4

## Changer l'adresse source en 1.2.3.4, 1.2.3.5 ou 1.2.3.6
# iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to 1.2.3.4-1.2.3.6

## Changer l'adresse source en 1.2.3.4, port 1-1023
# iptables -t nat -A POSTROUTING -p tcp -o eth0 -j SNAT --to 1.2.3.4:1-1023
</code>
</pre>
</blockquote>

<br>
<br>
 

<h3>Masquerading</h3>

<p>C'est un cas spécial de SNAT appelé masquerading : il devrait
seulement être utilisé pour des adresses IP assignées
dynamiquement, comme des connections standard (pour les adresses IP
statiques, utilises SNAT).</p>

<p>Tu n'as pas besoin de specifier l'adresse source explicitement
avec le masquerading : il utilisera l'adresse source de l'interface
par laquelle le paquet sort. Mais plus important, si le lien est
déconnecté, les connections (qui sont de toutes facons perdues)
sont oubliées, ce qui evite des problèmes éventuels quand la
connection est rétablie avec une nouvelle adresse IP.</p>

<blockquote>
<pre>
<code>## Masquerader tout ce qui sort par ppp0.
# iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE
</code>
</pre>
</blockquote>

<br>
<br>
 

<h2><a name="ss6.2">6.2</a> <a href="NAT-HOWTO.html#toc6.2">NAT De
Destination</a></h2>

<p>Ceci est réalisé dans la chaine PREROUTING, juste comme le
paquet arrive; cela veut dire que tout le reste sur la machine
Linux (routage, filtrage de paquets) va voir le paquet aller vers
sa destination `réelle'. Cela veut aussi dire que l'option `-i'
(interface d'entrée) peut être utilisée.</p>

<p>Pour altérer la destination de paquets générés locallement, la
chaine OUTPUT peut être utilisée, mais c'est moins courant.</p>

<p>Le NAT de Destination est spécifié en utilisant `-j DNAT', et
l'option `--to-destination' spécifie une adresse ip, un bloc
d'adresses IP, et un port ou un bloc de ports optionnels (pour les
protocoles UDP et TCP seulement).</p>

<blockquote>
<pre>
<code>## Changer l'adresse de destination en 5.6.7.8
# iptables -t nat -A PREROUTING -i eth1 -j DNAT --to 5.6.7.8

## Changer l'adresse de destination en 5.6.7.8, 5.6.7.9 ou 5.6.7.10.
# iptables -t nat -A PREROUTING -i eth1 -j DNAT --to 5.6.7.8-5.6.7.10

## Changer l'adresse de destination du traffic web en 5.6.7.8, port 8080.
# iptables -t nat -A PREROUTING -p tcp --dport 80 -i eth1 \
        -j DNAT --to 5.6.7.8:8080

## Rediriger les paquets locaux destinés à 1.2.3.4 en loopback.
# iptables -t nat -A OUTPUT -d 1.2.3.4 -j DNAT --to 127.0.0.1
</code>
</pre>
</blockquote>

<br>
<br>
 

<h3>Redirection</h3>

<p>Il y a un cas spécialisé de NAT de Destination appelé
redirection : c'est une simplification qui est exactement
équivalente à faire du DNAT vers l'adresse de l'interface
d'entrée.</p>

<blockquote>
<pre>
<code>## Envoyer le traffic web entrant du port port-80 vers notre proxy (transparent) squid
# iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 \
        -j REDIRECT --to-port 3128
</code>
</pre>
</blockquote>

<br>
<br>
 

<h2><a name="ss6.3">6.3</a> <a href=
"NAT-HOWTO.html#toc6.3">Mappings En Profondeur</a></h2>

<p>Il y a plusieurs subtilités du NAT que la pluspart des gens
n'auront jamais à utiliser. Elles sont documentées ici pour les
curieux.</p>

<h3>Selection D'adresses Multiples Dans Un Bloc</h3>

<p>Si un bloc d'adresses IP est donné, l'adresse IP à utiliser est
choisie sur la base de l'adresse dernièrement utilisée pour les
connectiosn que la machine connait. Cela donne du load-balancing
primitif.</p>

<h3>Créer Des Mappings De Null NAT</h3>

<p>Tu peux utiliser la cible `-j ACCEPT' pour laisser une
connection passer sans réaliser de NAT.</p>

<h3>NAT Standard</h3>

<p>Le comportement par défaut est d'altèrer la connection aussi peu
que possible, dans les contraintes de la règle définie par
l'utilisateur. Cela veut dire qu'on ne redirige pas les ports à
moins d'y être forcé.</p>

<h3>Mapping De Port Source Implicite</h3>

<p>Même quand aucun NAT n'est requis pour une connection, une
translation de port source peut être implicitement effectuée, si
une autre connection a été mappée au dessus de la nouvelle.
Considerons le cas du masquerading qui est plutot commun:</p>

<ol>
<li>Une connection web est établie par une machine 192.1.1.1 du
port 1024 au port 80 de www.netscape.com .</li>

<li>Ceci est masqueradé pas la machine qui masquerade pour utiliser
son adresse IP source (1.2.3.4).</li>

<li>La machine masqueradante essaye de realiser une connection web
vers le port 80 de www.netscape.com à partir de 1.2.3.4 (l'adresse
de son interface externe) port 1024.</li>

<li>Le code NAT va altèrer le port source de la seconde connection
en 1025, pour que les deux ne colisionnent pas.</li>
</ol>

<br>
<br>
 

<p>Quand ce mapping de source implicite est effectué, les ports
sont divisés en 3 classes:</p>

<ul>
<li>Les ports en dessous de 512</li>

<li>Les ports entre 512 et 1023</li>

<li>Les ports au dessus de 1024.</li>
</ul>

<br>
<br>
 

<p>Un port ne sera jamais implicitement mappé dans une classe
différente.</p>

<h3>Que Se Passe-t-il Quand Le NAT Foire ?</h3>

<p>Si il n'y a pas de possibilité de mapper la connection quand
l'utilisateur la demande, on la laisse tomber. Ceci s'applique
aussi aux paquets qui ne peuvent pas être classifiés comme faisant
partie d'une connection, parce qu'ils sont malformés, ou que la
machine est saturée en mémoire, etc.</p>

<h3>Mappings Multiples, Dépassements et Clashs</h3>

<p>Tu peux avoir des règles NAT qui mappent des paquets sur le mème
bloc; le code NAT est assez propre pour éviter les Clashs. Donc
avoir deux règles qui mappent les adresses source 192.168.1.1 et
192.168.1.2 respectivement sur 1.2.3.4 fonctionnera.</p>

<p>Encore mieux, tu peux mapper des adresses IP réelles utilisées,
aussi longtemps que ces adresses passent par la machine qui réalise
le mapping. Donc si tu as un réseau assigné (1.2.3.0/24), et un
réseau interne utilisant ces adresses et un réseau utilisant des
adresses internet privées 192.168.1.0/24, tu peux simplement NAT
les adresses sources 192.168.1.0/24 sur le réseau 1.2.3.0, sans
peur de clasher :</p>

<blockquote>
<pre>
<code># iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth1 \
        -j SNAT --to 1.2.3.0/24
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>La même logique est appliquée aux adresses utilisées par la
machine NAT elle-même : c'est comme ça que le masquerading
fonctionne (en partageant l'adresse de l'interface entre des
paquets masqueradés et des paquets `réels' venant de la machine
elle-mème).</p>

<p>De plus, tu peux mapper les mêmes paquets sur différentes cible
et ils seront partagés. Par exemple, si tu ne veux pas mapper
quelquechose sur 1.2.3.5, tu peux utiliser:</p>

<blockquote>
<pre>
<code># iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth1 \
        -j SNAT --to 1.2.3.0-1.2.3.4 --to 1.2.3.6-1.2.3.254
</code>
</pre>
</blockquote>

<br>
<br>
 

<h3>Altération de la Destination de Connections Générées
Locallement</h3>

<p>Si la destination d'un paquet généré locallement est changée
(p.e. par la chaine OUTPUT), et que cela fait passer le paquet sur
une interface différente, alors l'adresse source est aussi changée
en celle de cette interface. Par exemple, changer la destination
d'un paquet de loopback pour sortir par eth0 résultera dans la
source de ce paquet qui sera altérée de 127.0.0.1 en l'adresse de
eth0; contrairement à d'autres mappings de source, ceci est fait
immédiatement. Naturellement, ces deux mappings sont inversés sur
les paquets de réponses qui reviennent.</p>

<hr>
<a href="NAT-HOWTO-7.html">Page suivante</a> <a href=
"NAT-HOWTO-5.html">Page précédente</a> <a href=
"NAT-HOWTO.html#toc6">Table des matières</a>
</body>
</html>


	  </TD>
	</TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD colspan=2 width=100% bgcolor=#990000 align=left>
      <TABLE width=100% border=0 cellpadding=0 cellspacing=4>
        <TR>
	  <TD bgcolor=#990000 align=right>
	    <div class="filemodtime">
	      <i>Dernière modification le : 9 May 2002 13:52</i>
	    </div>
      	    <a style="text-decoration:none" href="http://www.php.net">
              <img src="/prj/inetdoc/images/php-small-trans-dark.gif" border=0 width=88 height=31 alt="php logo">
      	    </a>
      	    &nbsp;&nbsp;
      	    <a style="text-decoration:none" href="http://www.debian.org">
              <img src="/prj/inetdoc/images/openlogo-25.jpg" border=0 width=25 height=30 alt="debian logo">
      	    </a>
      	    &nbsp;&nbsp;
	    <!-- stat_code_start
	    <a style="text-decoration:none" href="http://www.estat.com/getstats?serial=21701747824">
	      <img src="http://perso.estat.com/cgi-bin/perso/21701747824?page=marque_perso" border=0>
	    </a>
	     stat_code_end -->
	    <!-- eStat -->
	    <SCRIPT LANGUAGE="JavaScript">
	      <!--
	      var _UJS=0;
	      //-->
	    </SCRIPT>
	    <SCRIPT LANGUAGE="JavaScript" SRC="http://perso.estat.com/js/m.js">
	    </SCRIPT>
	    <SCRIPT LANGUAGE="JavaScript">
	      <!--
	      if(_UJS) _estat('21701747824','Page_D_Accueil','Accueil');
	      //-->
	    </SCRIPT>
	    <!-- /eStat -->
	  </TD>
	</TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
</body>
</html>
<!-- END: main.tpl -->
