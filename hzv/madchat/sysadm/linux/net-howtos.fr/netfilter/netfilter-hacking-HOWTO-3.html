<!-- NAME: main.tpl -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
  <head>
    <title>L i n u x [inetdoc]: (Guides) </title>
    <meta HTTP-EQUIV="Content-Type" content="text/html; charset=ISO-8859-1">
    <meta name="Content-Language" content="fr">
    <meta name="description" content="inet doc linux">
    <meta name="author" content="philippe.latu@linux-france.org">
    <meta name="copyright" content="(c)2000 Philippe Latu">
    <meta name="publisher" content="philippe.latu@linux-france.org">
    <meta name="keywords" content="documentation, ethernet, formation, guide, ieee, ifconfig, inet, interface, ip, iproute2, iptables, isdn, IUT, IUP, latu, linux, net, OSI, ping, reseau, RNIS, route, routage, TCP, TCP/IP, UDP">
    <meta name="audience" content="All, Tous">
    <meta name="robots" content="INDEX,FOLLOW">
    <link rel="STYLESHEET" type="text/css" href="/prj/inetdoc/style/docstyle.css">
    <script language="javascript" type="text/javascript">
      <!-- for javascript enabled browser's only
        if (top.location != location) top.location.href = location.href;
	
        function popup(form) {
          optionIndex = form.banner.SelectedIndex;
          if (optionIndex == 0) return;
          location.href = form.banner.options[form.banner.selectedIndex].value;
          }
      // end script hiding -->
    </script>
  </head>
<BODY BGCOLOR="#FFFFFF" TEXT="#990000" LINK="#990000" VLINK="#990000" ALINK="#990000" leftMargin="0" topMargin="0" marginheight="0" marginwidth="0">
<TABLE width=100% border=0 cellspacing=2 cellpadding=0 align=center>
  <TR>
    <TD width=25% bgcolor=#990000 align=center valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
        <TR align=right> 
	  <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
      	</TR>
	<TR>
	  <TD bgcolor=#990000 align=center>
	    <a class="nodecor" href="/prj/inetdoc">
              <IMG src="/prj/inetdoc/images/upleft.png" border=0 width=158 height=96 hspace=10 alt="logo">
      	    </a>
	  <TD>
	</TR>
      </TABLE>
    </TD>
    <TD width=75% bgcolor=#FFFFFF align=left valign=top>
      <!-- banner menu start -->
      <form>
        <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
	  <!-- 1st row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor=#FF9966>
	      <TABLE width="100%" border="0" cellspacing="3" cellpadding="0" width="100%">
	        <TR>
		  <th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/">&nbsp;Accueil</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/articles/">&nbsp;Articles</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/courses/">&nbsp;Cours</a>
</th>
<th align="left" valign="top" bgcolor="white">
  <a class="reduced" href="/prj/inetdoc/i/net/guides/">&nbsp;Guides</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/formation/">&nbsp;Formation</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/download/">&nbsp;Téléchargement</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/source/">&nbsp;Source</a>
</th>

		</TR>
	      </TABLE>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#FFFFFF><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <!-- 2nd row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor=#FFCC66>
	      <FONT color=#990000 size=-1 face="Arial, 'Myriad Web', Syntax, sans-serif"><B>
	       <SELECT name="banner" onChange="popup(this.form)">
	         <OPTION value="/prj/inetdoc/i/net/../../download/netfilter-hacking-HOWTO.pdf">
  Téléchargement netfilter hacking HOWTO VF
</OPTION>
<OPTION value="/prj/inetdoc/i/net/guides/">
  Autres guides
</OPTION>

	       </SELECT>
	      </B></FONT>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#FFFFFF><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <!-- 3rd row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor="#990000" align="left" valign="middle" width="100%" height="100%">
	      <div class="browse"><font size=1>&nbsp;&nbsp;Références : <a href="http://netfilter.samba.org/" class="browse"><font size=1>Netfilter Home</font></a>&nbsp;
</font></div>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	</TABLE>
      </form>
      <!-- banner menu end -->
    </TD>
  </TR>
  <TR>
    <TD width=25% bgcolor=#330066 align=left valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
        <TR align=right> 
	  <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	</TR>
	<TR>
	  <TD bgcolor=#330066 align=center>
	    &nbsp;<!-- no Toc section in guides/netfilter-hacking-HOWTO/netfilter-hacking-HOWTO.html -->
      	    <br>
      	    <TABLE width=100% border=0 cellpadding=0 cellspacing=4>
              <TR>
	  	<TD bgcolor=#000000 align=center>
	    	  <TABLE width=100% border=0 cellpadding=2 cellspacing=1>
              	    <TR>
	              <TH bgcolor=#FFCC66 align="center" valign="top" class="toc-title">
		        <a class="toc-title" href="mailto:philippe.latu@linux-france.org">
	        	  Contact<img src="/prj/inetdoc/images/envelope.gif" border=0 width=50 height=35 align="middle" alt="mail">
		  	</a>
		      </TH>
              	    </TR>
              	    <TR>
	              <TD bgcolor=#FFCC99 align=center valign=top class="toc-item">
		        &nbsp;<a class="toc-item" href="/prj/inetdoc/log/">Carnet de bord</a>
		      </TD>
              	    </TR>
              	    <TR>
	              <TD bgcolor=#FFCC99 align=center valign=top class="toc-item">
		  	&nbsp;<a class="toc-item" href="/prj/inetdoc/legal/">Notice légale</a>
		      </TD>
              	    </TR>
            	  </TABLE>
	  	</TD>
              </TR>
      	    </TABLE>
          </TD>
        </TR>
      </TABLE>
    </TD>
    <TD width=75% bgcolor=#FFFFFF align=left valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=8 align=center>
        <TR>
	  <TD bgcolor=#FFFFFF align=left valign=top>
            <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta name="generator" content=
"HTML Tidy for Linux/x86 (vers 1st March 2002), see www.w3.org">
<meta name="GENERATOR" content="LinuxDoc-Tools 0.9.21">
<title>Linux netfilter Hacking HOWTO: Architecture de
Netfilter</title>
<link href="netfilter-hacking-HOWTO-4.html" rel="next">
<link href="netfilter-hacking-HOWTO-2.html" rel="previous">
<link href="netfilter-hacking-HOWTO.html#toc3" rel="contents">
</head>
<body>
<a href="netfilter-hacking-HOWTO-4.html">Page suivante</a> <a href=
"netfilter-hacking-HOWTO-2.html">Page précédente</a> <a href=
"netfilter-hacking-HOWTO.html#toc3">Table des matières</a> 

<hr>
<h2><a name="s3">3.</a> <a href=
"netfilter-hacking-HOWTO.html#toc3">Architecture de
Netfilter</a></h2>

<p>Netfilter est pratiquement une série de ``hooks'' (accroches) à
quelques endroits dans la pile de protocoles (pour le moment, IPv4,
IPv6, DECnet). Le shema de traversé ressemble (idéalement) à
cela:</p>

<blockquote>
<pre>
<code>Un paquet qui traverse le système Netfilter:

   ---&gt;[1]---&gt;[ROUTE]---&gt;[3]---&gt;[4]---&gt;
                 |            ^
                 |            |
                 |         [ROUTE]
                 v            |
                [2]          [5]
                 |            ^
                 |            |
                 v            |
</code>
</pre>
</blockquote>

<a name="netfilter-traversal"></a> <br>
<br>
 

<p>Sur la gauche, c'est la ou les paquets arrivent : en ayant passé
un simple test de sanité (par exemple: pas coupé, IP checksum est
OK, et que ce n'est pas un paquet reçu en promiscuous), ils sont
passés au ``hook'' NF_IP_PRE_ROUTING [1] du canevas de
netfilter.</p>

<p>Ensuite, il entrent dans le code de routage, qui décide si oui
ou non le paquet est destiné à une autre interface, ou pour un
processus en local. Le code de routage peut éventuellement détruire
le paquet si il n'est pas routable.</p>

<p>Si il est destine pour la machine elle même, le canevas
netfilter est appelé pour le hook NF_IP_LOCAL_IN [2], avant d'être
passé au processus, si il y en a un.</p>

<p>Si à la place le paquet est destiné pour une autre interface, le
canevas netfilter est appelé pour le hook NF_IP_FORWARD [3].</p>

<p>Le paquet passe ensuite le dernier hook de netfilter, le
NF_POST_ROUTING [4], avant d'être envoyé sur le cable.</p>

<p>Le hook NF_IP_LOCAL_OUT [5] est appelé pour les paquets qui sont
générés localement. Ici vous pouvez voir que le routage ce fait
après que ce hook est appelé : en fait, le code de routage est
appelé avant (pour trouver l'adresse source IP, et quelques options
IP) : si vous voulez modifier le routage, vous devez modifier le
champs `skb-&gt;dst' par vous même, comme dans le code de NAT.</p>

<h2><a name="ss3.1">3.1</a> <a href=
"netfilter-hacking-HOWTO.html#toc3.1">La base de Netfilter</a></h2>

<p>Maintenant nous avons un exemple de netfilter pour IPv4, vous
pouvez voir quand chacun des hooks est activé. C'est l'essence même
de netfilter.</p>

<p>Les modules kernel peuvent s'enregistrer pour écouter à chacun
de ces hooks. Un module qui enregistre une fonction doit spécifier
la priorité de cette fonctions à l'intérieur du hook. De telle
sorte que quand ce hook est appelé par netfilter, le code réseaux
central appellera les fonctions du hook dans l'ordre des priorités.
Le module peut dire à netfilter de faire l'une de ces 5 choses
:</p>

<ol>
<li>NF_ACCEPT: le paquet peut continuer sa traversé comme
normal.</li>

<li>NF_DROP: détruit le paquet, la traversé est arrêtée net.</li>

<li>NF_STOLEN: J'ai pris possession du paquet, arrête la
traversée.</li>

<li>NF_QUEUE: queute le paquet (habituellement pour manipulation
future en userspace).</li>

<li>NF_REPEAT: Appelle ce hook encore une fois.</li>
</ol>

<br>
<br>
 

<p>Les autres parties de Netfilter (gérer les paquets queutés, et
les commentaires cools) seront couverts dans la section kernel un
peu plus tard.</p>

<p>Basé sur cette fondation, nous pouvons construire des
manipulations de paquets relativement complexes, comme démontré
dans les deux sections suivantes.</p>

<h2><a name="ss3.2">3.2</a> <a href=
"netfilter-hacking-HOWTO.html#toc3.2">Sélection de Paquets</a></h2>

<p>Un système de sélection de paquets appelé `iptables' a été
construit par dessus le canevas netfilter. C'est le descendant
direct de `ipchains' (qui descendait de `ipfwadm', qui venait lui
même de ipfw de BSD) mais amélioré car plus extensible. Les modules
kernels peuvent demander à enregistrer une table nouvelle, et
demander à ce qu'un paquet traverse un table donnée. Cette méthode
de sélection de paquets est utilisée pour filtrer les paquets (la
table `filter'), pour NAT (la table `nat') et pour modifier des
paquets avant routage (la table `mangle').</p>

<p>Les hooks qui sont enregistrés avec netfilter sont comme suit
(avec les fonctions de chaque hooks dans l'ordre ou ils sont
appelles) :</p>

<blockquote>
<pre>
<code>
   ---&gt;PRE------&gt;[ROUTE]---&gt;FWD----------&gt;POST------&gt;
       Conntrack    |       Mangle   ^    Mangle
       Mangle       |       Filter   |    NAT (Src)
       NAT (Dst)    |                |    Conntrack
       (QDisc)      |             [ROUTE]
                    v                |
                    IN Filter       OUT Conntrack
                    |  Conntrack     ^  Mangle
                    |  Mangle        |  NAT (Dst)
                    v                |  Filter
</code>
</pre>
</blockquote>

<br>
<br>
 

<h3>Filtrage de paquets</h3>

<p>Cette table, `filter', ne devrait jamais modifier les paquets :
seulement les filtrer.</p>

<p>Un des avantages des filtres de iptables comparés à ceux de
ipchains est que c'est petit et rapide, et que ça s'accroche dans
netfilter aux points NF_IP_LOCAL_IN, NF_IP_FORWARD, et
NF_IP_LOCAL_OUT. Ça veut dire que pour un paquet donné, il n'y a
qu'une et un seule place pour le filtrer. Cela rend les choses bien
plus simples pour l'utilisateur que ipchains ne l'était. Aussi, le
fait que le canevas netfilter fournit l'interface input et output
pour les hooks NF_IP_FORWARD signifie que beaucoup de types de
filtrage sont rendus plus simples.</p>

<p>Note: J'ai porté les parties kernel de ipchains et de ipfwadm en
modules par dessus le canevas netfilter. Cela permet l'usage des
vieux utilitaires en userspace ipfwadm et ipchains, sans avoir à
mettre à jour.</p>

<h3>NAT</h3>

<p>Voici la réaction de la table `nat', à qui l'on passe des
paquets par deux hooks netfilter : pour les paquets qui ne sont pas
générés localement, les hooks NF_IP_PRE_ROUTING et
NF_IP_POST_ROUTING sont une place parfaite pour modifier
respectivement la destination et la source d'un paquet. Si
CONFIG_IP_NF_NAT_LOCAL est définie, le hook NF_IP_LOCAL_IN est
utilisé pour modifier la destination des paquets générés
localement.</p>

<p>Cette table est légèrement différente de la table `filter',
effectivement, seulement le premier paquet d'une nouvelle connexion
va traverser la table : le résultat de cette traversé est ensuite
appliquée à tous les futurs paquets qui font partie de la même
connexion.</p>

<h3>Masquerading, Port Forwarding, et Proxy transparent</h3>

<p>Je divise NAT en Source NAT (ou le premier paquet voit sa source
être modifiée) et Destination NAT (ou le premier paquet voit sa
destination être modifiée).</p>

<p>Le Masquerading est une forme spéciale de Source NAT,
port-forwarding et transparent proxying sont des formes spéciales
de Destination NAT. Elles sont toutes maintenant effectuées à
l'aide du canevas NAT, plutôt que d'être des entités
indépendantes.</p>

<h3>Modification de Paquets</h3>

<p>La table de modification de paquets (la table `mangle') est
utilisée pour des changements concrets des informations d'un
paquet. Les exemples sont la target TOS et la target TCPMSS. La
table mangle s'accroche aux 3 hooks de netfilter (veuillez noter
que ceci a changé à partir du noyau 2.4.18. Les noyaux précédents
n'avaient pas la table mangle accrochée à tout les hooks).</p>

<h2><a name="ss3.3">3.3</a> <a href=
"netfilter-hacking-HOWTO.html#toc3.3">Suivi de connexions</a></h2>

<p>Le suivi des connexions est fondamental pour NAT, mais il est
implémenté dans un module à part entière. Cela permet une extension
au code de filtrage de paquets pour simplement et proprement
implémenter le suivi de connexions (le module `state').</p>

<h2><a name="ss3.4">3.4</a> <a href=
"netfilter-hacking-HOWTO.html#toc3.4">Autres additions</a></h2>

<p>Cette nouvelle flexibilité fournit une opportunité de faire des
choses vraiment cools, et de manière plus importante permet aux
gens d'écrire des améliorations ou des remplacement complets.</p>

<hr>
<a href="netfilter-hacking-HOWTO-4.html">Page suivante</a> <a href=
"netfilter-hacking-HOWTO-2.html">Page précédente</a> <a href=
"netfilter-hacking-HOWTO.html#toc3">Table des matières</a>
</body>
</html>


	  </TD>
	</TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD colspan=2 width=100% bgcolor=#990000 align=left>
      <TABLE width=100% border=0 cellpadding=0 cellspacing=4>
        <TR>
	  <TD bgcolor=#990000 align=right>
	    <div class="filemodtime">
	      <i>Dernière modification le : 30 May 2002 21:11</i>
	    </div>
      	    <a style="text-decoration:none" href="http://www.php.net">
              <img src="/prj/inetdoc/images/php-small-trans-dark.gif" border=0 width=88 height=31 alt="php logo">
      	    </a>
      	    &nbsp;&nbsp;
      	    <a style="text-decoration:none" href="http://www.debian.org">
              <img src="/prj/inetdoc/images/openlogo-25.jpg" border=0 width=25 height=30 alt="debian logo">
      	    </a>
      	    &nbsp;&nbsp;
	    <!-- stat_code_start
	    <a style="text-decoration:none" href="http://www.estat.com/getstats?serial=21701747824">
	      <img src="http://perso.estat.com/cgi-bin/perso/21701747824?page=marque_perso" border=0>
	    </a>
	     stat_code_end -->
	    <!-- eStat -->
	    <SCRIPT LANGUAGE="JavaScript">
	      <!--
	      var _UJS=0;
	      //-->
	    </SCRIPT>
	    <SCRIPT LANGUAGE="JavaScript" SRC="http://perso.estat.com/js/m.js">
	    </SCRIPT>
	    <SCRIPT LANGUAGE="JavaScript">
	      <!--
	      if(_UJS) _estat('21701747824','Page_D_Accueil','Accueil');
	      //-->
	    </SCRIPT>
	    <!-- /eStat -->
	  </TD>
	</TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
</body>
</html>
<!-- END: main.tpl -->
