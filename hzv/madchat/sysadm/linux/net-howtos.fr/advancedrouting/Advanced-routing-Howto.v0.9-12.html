<!-- NAME: main.tpl -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
  <head>
    <title>L i n u x [inetdoc]: (Guides) </title>
    <meta HTTP-EQUIV="Content-Type" content="text/html; charset=ISO-8859-1">
    <meta name="Content-Language" content="fr">
    <meta name="description" content="inet doc linux">
    <meta name="author" content="philippe.latu@linux-france.org">
    <meta name="copyright" content="(c)2000 Philippe Latu">
    <meta name="publisher" content="philippe.latu@linux-france.org">
    <meta name="keywords" content="documentation, ethernet, formation, guide, ieee, ifconfig, inet, interface, ip, iproute2, iptables, isdn, IUT, IUP, latu, linux, net, OSI, ping, reseau, RNIS, route, routage, TCP, TCP/IP, UDP">
    <meta name="audience" content="All, Tous">
    <meta name="robots" content="INDEX,FOLLOW">
    <link rel="STYLESHEET" type="text/css" href="/prj/inetdoc/style/docstyle.css">
    <script language="javascript" type="text/javascript">
      <!-- for javascript enabled browser's only
        if (top.location != location) top.location.href = location.href;
	
        function popup(form) {
          optionIndex = form.banner.SelectedIndex;
          if (optionIndex == 0) return;
          location.href = form.banner.options[form.banner.selectedIndex].value;
          }
      // end script hiding -->
    </script>
  </head>
<BODY BGCOLOR="#FFFFFF" TEXT="#990000" LINK="#990000" VLINK="#990000" ALINK="#990000" leftMargin="0" topMargin="0" marginheight="0" marginwidth="0">
<TABLE width=100% border=0 cellspacing=2 cellpadding=0 align=center>
  <TR>
    <TD width=25% bgcolor=#990000 align=center valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
        <TR align=right> 
	  <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
      	</TR>
	<TR>
	  <TD bgcolor=#990000 align=center>
	    <a class="nodecor" href="/prj/inetdoc">
              <IMG src="/prj/inetdoc/images/upleft.png" border=0 width=158 height=96 hspace=10 alt="logo">
      	    </a>
	  <TD>
	</TR>
      </TABLE>
    </TD>
    <TD width=75% bgcolor=#FFFFFF align=left valign=top>
      <!-- banner menu start -->
      <form>
        <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
	  <!-- 1st row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor=#FF9966>
	      <TABLE width="100%" border="0" cellspacing="3" cellpadding="0" width="100%">
	        <TR>
		  <th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/">&nbsp;Accueil</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/articles/">&nbsp;Articles</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/courses/">&nbsp;Cours</a>
</th>
<th align="left" valign="top" bgcolor="white">
  <a class="reduced" href="/prj/inetdoc/i/net/guides/">&nbsp;Guides</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/formation/">&nbsp;Formation</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/download/">&nbsp;Téléchargement</a>
</th>
<th align="left" valign="top" bgcolor="#FFCC99">
  <a class="reduced" href="/prj/inetdoc/i/net/source/">&nbsp;Source</a>
</th>

		</TR>
	      </TABLE>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#FFFFFF><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <!-- 2nd row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor=#FFCC66>
	      <FONT color=#990000 size=-1 face="Arial, 'Myriad Web', Syntax, sans-serif"><B>
	       <SELECT name="banner" onChange="popup(this.form)">
	         <OPTION value="/prj/inetdoc/i/net/articles/model/tcpip.html">
  Modélisation TCP/IP
</OPTION>
<OPTION value="/prj/inetdoc/i/net/../../download/Advanced-routing-Howto.pdf">
  Téléchargement Linux 2.4 Advanced Routing HOWTO VF
</OPTION>
<OPTION value="/prj/inetdoc/i/net/guides/">
  Autres guides
</OPTION>

	       </SELECT>
	      </B></FONT>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#FFFFFF><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <!-- 3rd row -->
	  <TR align=right> 
	    <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR>
	    <TD bgcolor="#990000" align="left" valign="middle" width="100%" height="100%">
	      <div class="browse"><font size=1>&nbsp;&nbsp;Références : <a href="http://netfilter.samba.org/" class="browse"><font size=1>Netfilter Home</font></a>&nbsp;|&nbsp;
<a href="http://lartc.org/" class="browse"><font size=1>Linux Advanced Routing & Traffic Control Home</font></a>&nbsp;|&nbsp;
<a href="http://www.linux-france.org/prj/inetdoc/download/Advanced-routing-Howto.pdf" class="browse"><font size=1>Version Française en PDF</font></a>&nbsp;
</font></div>
	    </TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#990000><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=4 alt=""></TD>
	  </TR>
	  <TR align=right> 
	    <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	  </TR>
	</TABLE>
      </form>
      <!-- banner menu end -->
    </TD>
  </TR>
  <TR>
    <TD width=25% bgcolor=#330066 align=left valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=0 align=center>
        <TR align=right> 
	  <TD bgcolor=#FF9966><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=2 alt=""></TD>
	</TR>
	<TR align=right> 
	  <TD bgcolor=#330066><IMG src="/prj/inetdoc/images/blank.gif" width=1 height=1 alt=""></TD>
	</TR>
	<TR>
	  <TD bgcolor=#330066 align=center>
	    &nbsp;<!-- no Toc section in guides/Advanced-routing-Howto/Advanced-routing-Howto.v0.9.html -->
      	    <br>
      	    <TABLE width=100% border=0 cellpadding=0 cellspacing=4>
              <TR>
	  	<TD bgcolor=#000000 align=center>
	    	  <TABLE width=100% border=0 cellpadding=2 cellspacing=1>
              	    <TR>
	              <TH bgcolor=#FFCC66 align="center" valign="top" class="toc-title">
		        <a class="toc-title" href="mailto:philippe.latu@linux-france.org">
	        	  Contact<img src="/prj/inetdoc/images/envelope.gif" border=0 width=50 height=35 align="middle" alt="mail">
		  	</a>
		      </TH>
              	    </TR>
              	    <TR>
	              <TD bgcolor=#FFCC99 align=center valign=top class="toc-item">
		        &nbsp;<a class="toc-item" href="/prj/inetdoc/log/">Carnet de bord</a>
		      </TD>
              	    </TR>
              	    <TR>
	              <TD bgcolor=#FFCC99 align=center valign=top class="toc-item">
		  	&nbsp;<a class="toc-item" href="/prj/inetdoc/legal/">Notice légale</a>
		      </TD>
              	    </TR>
            	  </TABLE>
	  	</TD>
              </TR>
      	    </TABLE>
          </TD>
        </TR>
      </TABLE>
    </TD>
    <TD width=75% bgcolor=#FFFFFF align=left valign=top>
      <TABLE width=100% border=0 cellspacing=0 cellpadding=8 align=center>
        <TR>
	  <TD bgcolor=#FFFFFF align=left valign=top>
            <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta name="generator" content=
"HTML Tidy for Linux/x86 (vers 1st February 2002), see www.w3.org">
<meta name="GENERATOR" content="LinuxDoc-Tools 0.9.18">
<title>HOWTO du routage avancé et du contrôle de trafic sous Linux:
Filtres avancés pour la (re-) classification des paquets</title>
<link href="Advanced-routing-Howto.v0.9-13.html" rel="next">
<link href="Advanced-routing-Howto.v0.9-11.html" rel="previous">
<link href="Advanced-routing-Howto.v0.9.html#toc12" rel="contents">
</head>
<body>
<a href="Advanced-routing-Howto.v0.9-13.html">Page suivante</a> <a
href="Advanced-routing-Howto.v0.9-11.html">Page précédente</a> <a
href="Advanced-routing-Howto.v0.9.html#toc12">Table des
matières</a> 

<hr>
<h2><a name="s12">12.</a> <a href=
"Advanced-routing-Howto.v0.9.html#toc12">Filtres avancés pour la
(re-) classification des paquets</a></h2>

<p>Comme expliqué dans la section sur les gestionnaires de mise en
file d'attente basés sur des classes, les filtres sont nécessaires
pour classifier les paquets dans n'importe laquelle des sous-files
d'attente. Ces filtres sont appelés à l'intérieur des gestionnaires
de mise en files d'attente basés sur des classes.</p>

<p>Voici une liste incomplète des classificateurs
disponibles&nbsp;:</p>

<dl>
<dt><b>fw</b></dt>

<dd>
<p>Base la décision sur la façon dont le pare-feu a marqué les
paquets. Ceci peut être un passage facile si vous ne voulez pas
apprendre la syntaxe tc liée aux filtres. Voir le chapitre sur les
gestionnaires de mise en file d'attente pour plus de détails.</p>
</dd>

<dt><b>u32</b></dt>

<dd>
<p>Base la décision sur les champs à l'intérieur du paquet
(c'est-à-dire l'adresse IP source, etc.)</p>
</dd>

<dt><b>route</b></dt>

<dd>
<p>Base la décision sur la route que va emprunter le paquet.</p>
</dd>

<dt><b>rsvp, rsvp6</b></dt>

<dd>
<p>Route les paquets en se basant sur <a href=
"http://www.isi.edu/div7/rsvp/overview.html">RSVP</a> . Seulement
utile sur les réseaux que vous contrôlez. Internet ne respecte pas
RSVP.</p>
</dd>

<dt><b>tcindex</b></dt>

<dd>
<p>Utilisé par le gestionnaire de file d'attente DSMARK. Voir la
section appropriée.</p>
</dd>
</dl>

<br>
<br>
 

<p>Notez qu'il y a généralement plusieurs manières de classifier un
paquet. Cela dépend du système de classification que vous souhaitez
utiliser.</p>

<p>Les classificateurs acceptent en général quelques arguments
communs. Ils sont listés ici pour des raisons pratiques&nbsp;:</p>

<dl>
<dt><b>protocol</b></dt>

<dd>
<p>Le protocole que ce classificateur acceptera. Généralement, on
n'acceptera que le trafic IP. Exigé.</p>
</dd>

<dt><b>parent</b></dt>

<dd>
<p>Le descripteur auquel ce classificateur est attaché. Ce
descripteur doit être une classe déjà existante. Exigé.</p>
</dd>

<dt><b>prio</b></dt>

<dd>
<p>La priorité de ce classificateur. Les plus petits nombres seront
testés en premier.</p>
</dd>

<dt><b>handle</b></dt>

<dd>
<p>Cette référence a plusieurs significations suivant les
différents filtres.</p>
</dd>
</dl>

<br>
<br>
 

<p>Toutes les sections suivantes supposeront que vous essayez de
mettre en forme le trafic allant vers <code>HostA</code>. Ces
sections supposeront que la classe racine a été configurée sur 1:
et que la classe vers laquelle vous voulez envoyer le trafic
sélectionné est 1:1.</p>

<h2><a name="ss12.1">12.1</a> <a href=
"Advanced-routing-Howto.v0.9.html#toc12.1">Le classificateur
"u32"</a></h2>

<p>Le filtre u32 est le filtre le plus avancé dans l'implémentation
courante. Il est entièrement basé sur des tables de hachage, ce qui
le rend robuste quand il y a beaucoup de règles de filtrage.</p>

<p>Dans sa forme la plus simple, le filtre u32 est une liste
d'enregistrements, chacun consistant en deux champs&nbsp;: un
sélecteur et une action. Les sélecteurs, décrits ci-dessous, sont
comparés avec le paquet IP traité jusqu'à la première
correspondance, et l'action associée est réalisée. Le type d'action
le plus simple serait de diriger le paquet vers une classe CBQ
définie.</p>

<p>La ligne de commande du programme <code>tc filter</code>,
utilisé pour configurer le filtre, consiste en trois parties&nbsp;:
la spécification du filtre, un sélecteur et une action. La
spécification du filtre peut être définie comme&nbsp;:</p>

<blockquote>
<pre>
<code>tc filter add dev IF [ protocol PROTO ]
                     [ (preference|priority) PRIO ]
                     [ parent CBQ ]
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Le champ <code>protocol</code> décrit le protocole sur lequel le
filtre sera appliqué. Nous ne discuterons que du cas du protocole
<code>ip</code>. Le champ <code>preference</code>
(<code>priority</code> peut être utilisé comme alternative) fixe la
priorité du filtre que l'on définit. C'est important dans la mesure
où vous pouvez avoir plusieurs filtres (listes de règles) avec des
priorités différentes. Chaque liste sera scrutée dans l'ordre
d'ajout des règles. Alors, la liste avec la priorité la plus faible
(celle qui a le numéro de préférence le plus élevé) sera traitée.
Le champ <code>parent</code> définit le sommet de l'arbre CBQ (par
ex. 1:0) auquel le filtre doit être attaché.</p>

<p>Les options décrites s'appliquent à tous les filtres, pas
seulement à u32.</p>

<h3>Le sélecteur U32</h3>

<p>Le sélecteur U32 contient la définition d'un modèle, qui sera
comparé au paquet traité. Plus précisément, il définit quels bits
doivent correspondre dans l'en-tête du paquet, et rien de plus,
mais cette méthode simple est très puissante. Jetons un oeil sur
l'exemple suivant, directement tiré d'un filtre assez complexe
réellement existant&nbsp;:</p>

<blockquote>
<pre>
<code># filter parent 1: protocol ip pref 10 u32 fh 800::800 order 2048 key ht 800 bkt 0 flowid 1:3 \
  match 00100000/00ff0000 at 0
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Pour l'instant, laissons de côté la première ligne - tous ces
paramètres décrivent les tables de hachage du filtre.
Focalisons-nous sur la ligne de sélection contenant le mot-clé
<code>match</code>. Ce sélecteur fera correspondre les en-têtes IP
dont le second octet sera 0x10 (0010). Comme nous pouvons le
deviner, le nombre 00ff est le masque de correspondance, disant au
filtre quels bits il doit regarder. Ici, c'est 0xff, donc l'octet
correspondra si c'est exactement 0x10. Le mot-clé <code>at</code>
signifie que la correspondance doit démarrer au décalage spécifié
(en octets) -&nbsp;dans notre cas, c'est au début du paquet.
Traduisons tout cela en langage humain&nbsp;: le paquet
correspondra si son champ Type de Service (TOS) a le bit "faible
délai" positionné. Analysons une autre règle&nbsp;:</p>

<blockquote>
<pre>
<code># filter parent 1: protocol ip pref 10 u32 fh 800::803 order 2051 key ht 800 bkt 0 flowid 1:3 \
  match 00000016/0000ffff at nexthdr+0
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>L'option <code>nexthdr</code> désigne l'en-tête suivant
encapsulé dans le paquet IP, c'est à dire celui du protocole de la
couche supérieure. La correspondance commencera également au début
du prochain en-tête. Elle devrait avoir lieu dans le deuxième mot
de 32 bits de l'en-tête. Dans les protocoles TCP et UDP, ce champ
contient le port de destination du paquet. Le nombre est donné dans
le format big-endian, c'est-à-dire les bits les plus significatifs
en premier. Il faut donc lire 0x0016 comme 22 en décimal, qui
correspond au service SSH dans le cas de TCP. Comme vous le
devinez, cette correspondance est ambiguë sans un contexte, et nous
en discuterons plus loin.</p>

<p>Ayant compris tout cela, nous trouverons le sélecteur suivant
très facile à lire&nbsp;: <code>match c0a80100/ffffff00 at
16</code>. Ce que nous avons ici, c'est une correspondance de trois
octets au 17ème octet, en comptant à partir du début de l'en-tête
IP. Cela correspond aux paquets qui ont une adresse de destination
quelconque dans le réseau 192.168.1/24. Après avoir analysé les
exemples, nous pouvons résumer ce que nous avons appris.</p>

<h3>Sélecteurs généraux</h3>

<p>Les sélecteurs généraux définissent le modèle, le masque et le
décalage qui seront comparés au contenu du paquet. En utilisant les
sélecteurs généraux, vous pouvez rechercher des correspondances sur
n'importe quel bit de l'en-tête IP (ou des couches supérieures).
Ils sont quand même plus difficiles à écrire et à lire que les
sélecteurs spécifiques décrits ci-dessus. La syntaxe générale des
sélecteurs est&nbsp;:</p>

<blockquote>
<pre>
<code>match [ u32 | u16 | u8 ] PATTERN MASK [ at OFFSET | nexthdr+OFFSET]
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Un des mots-clés <code>u32</code>,<code>u16</code> ou
<code>u8</code> doit spécifier la longueur du modèle en bits.
PATTERN et MASK se rapporteront à la longueur définie par ce
mot-clé. Le paramètre OFFSET est le décalage, en octets, pour le
démarrage de la recherche de correspondance. Si le mot-clef
<code>nexthdr+</code> est présent, le décalage sera relatif à
l'en-tête de la couche réseau supérieure.</p>

<p>Quelques exemples&nbsp;:</p>

<blockquote>
<pre>
<code># tc filter add dev ppp14 parent 1:0 prio 10 u32 \
     match u8 64 0xff at 8 \
     flowid 1:4
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Un paquet correspondra à cette règle si sa "durée de vie" (TTL)
est de 64. TTL est le champ démarrant juste après le 8ème octet de
l'en-tête IP.</p>

<blockquote>
<pre>
<code># tc filter add dev ppp14 parent 1:0 prio 10 u32 \
     match u8 0x10 0xff at nexthdr+13 \
     protocol tcp \
     flowid 1:3 \
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>FIXME: Il a été montré que cette syntaxe ne marche pas
correctement.</p>

<p>Utilisez ceci pour déterminer la présence du ACK sur les paquets
d'une longueur inférieure à 64 octets&nbsp;:</p>

<blockquote>
<pre>
<code>## Vérifie la présence d'un ACK,
## protocol IP 6,
## longueur de l'entête IP 0x5(mots de 32 bits),
## longueur total IP 0x34 (ACK + 12 octets d'options TCP)
## TCP ack actif (bit 5, offset 33)
# tc filter add dev ppp14 parent 1:0 protocol ip prio 10 u32 \
            match ip protocol 6 0xff \
            match u8 0x05 0x0f at 0 \
            match u16 0x0000 0xffc0 at 2 \
            match u8 0x10 0xff at 33 \
            flowid 1:3
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Seuls les paquets TCP sans charge utile et avec le bit ACK
positionné vérifieront cette règle. Ici, nous pouvons voir un
exemple d'utilisation de deux sélecteurs, le résultat final étant
un ET logique de leur résultat. Si nous jetons un coup d'oeil sur
un schéma de l'en-tête TCP, nous pouvons voir que le bit ACK est le
second bit (0x10) du 14ème octet de l'en-tête TCP (<code>at
nexthdr+13</code>). Comme second sélecteur, si nous voulons nous
compliquer la vie, nous pouvons écrire <code>match u8 0x06 0xff at
9</code> à la place du sélecteur spécifique <code>protocol
tcp</code>, puisque 6 est le numéro du protocole TCP, spécifié au
10ème octet de l'en-tête IP. D'un autre coté, dans cet exemple,
nous ne pourrons pas utiliser de sélecteur spécifique pour la
première correspondance, simplement parce qu'il n'y a pas de
sélecteur spécifique pour désigner les bits TCP ACK.</p>

<h3>Les sélecteurs spécifiques</h3>

<p>La table suivante contient la liste de tous les sélecteurs
spécifiques que les auteurs de cette section ont trouvés dans le
code source du programme <code>tc</code>. Ils rendent simplement la
vie plus facile en accroissant la lisibilité de la configuration du
filtre.</p>

<p>FIXME: emplacement de la table -&nbsp;la table est dans un
fichier séparé "selector.html"</p>

<p>FIXME: C'est encore en Polonais&nbsp;:-( FIXME: doit être
"sgmlisé"</p>

<p>Quelques exemples&nbsp;:</p>

<blockquote>
<pre>
<code># tc filter add dev ppp0 parent 1:0 prio 10 u32 \
     match ip tos 0x10 0xff \
     flowid 1:4
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>FIXME: tcp dst match does not work as described below:</p>

<p>La règle ci-dessus correspondra à des paquets qui ont le champ
TOS égal à 0x10. Le champ TOS commence au deuxième octet du paquet
et occupe 1 octet, ce qui nous permet d'écrire un sélecteur général
équivalent&nbsp;: <code>match u8 0x10 0xff at 1</code>. Cela nous
donne une indication sur l'implémentation du filtre u32&nbsp;; les
règles spécifiques sont toujours traduites en règles générales, et
c'est sous cette forme qu'elles sont stockées en mémoire par le
noyau. Cela amène à une autre conclusion&nbsp;: les sélecteurs
<code>tcp</code> et <code>udp</code> sont exactement les mêmes et
c'est la raison pour laquelle vous ne pouvez pas utiliser un simple
sélecteur <code>match tcp dst 53 0xffff</code> pour désigner un
paquet TCP envoyé sur un port donné&nbsp;: cela désigne aussi les
paquets UDP envoyés sur ce port. Vous devez également spécifier le
protocole avec la règle suivante&nbsp;:</p>

<blockquote>
<pre>
<code># tc filter add dev ppp0 parent 1:0 prio 10 u32 \
        match tcp dst 53 0xffff \
        match ip protocol 0x6 0xff \
        flowid 1:2
</code>
</pre>
</blockquote>

<br>
<br>
 

<h2><a name="ss12.2">12.2</a> <a href=
"Advanced-routing-Howto.v0.9.html#toc12.2">Le classificateur
"route"</a></h2>

<p>Ce classificateur filtre en se basant sur les informations des
tables de routage. Quand un paquet passant à travers les classes en
atteint une qui est marquée avec le filtre "route", il divise le
paquet en se basant sur l'information de la table de routage.</p>

<blockquote>
<pre>
<code># tc filter add dev eth1 parent 1:0 protocol ip prio 100 route
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Ici, nous ajoutons un classificateur <code>route</code> sur le
noeud parent 1:0, avec la priorité 100. Quand un paquet atteint ce
noeud (ce qui, puisqu'il est racine, arrive immédiatement), il
consulte la table de routage et si une entrée de la table
correspond, il envoie le paquet vers la classe donnée et lui donne
une priorité de 100. Ensuite, pour finalement activer les choses,
vous ajoutez l'entrée de routage appropriée.</p>

<p>L'astuce ici est de définir "realm" en se basant soit sur la
destination, soit sur la source. Voici la façon de faire
cela&nbsp;:</p>

<blockquote>
<pre>
<code># ip route add Host/Network via Gateway dev Device realm RealmNumber
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Par exemple, nous pouvons définir notre réseau de destination
192.168.10.0 avec le nombre "realm" égal à 10&nbsp;:</p>

<blockquote>
<pre>
<code># ip route add 192.168.10.0/24 via 192.168.10.1 dev eth1 realm 10
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Quand on ajoute des filtres "route", on peut utiliser les
nombres "realm" pour représenter les réseaux ou les hôtes et
spécifier quelle est la correspondance entre les routes et les
filtres.</p>

<blockquote>
<pre>
<code># tc filter add dev eth1 parent 1:0 protocol ip prio 100 \
  route to 10 classid 1:10
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>La règle ci-dessus indique que les paquets allant vers le réseau
192.168.10.0 correspondent à la classe 1:10.</p>

<p>Le filtre route peut aussi être utilisé avec les routes sources.
Par exemple, il y a un sous-réseau attaché à notre routeur Linux
sur eth2.</p>

<blockquote>
<pre>
<code># ip route add 192.168.2.0/24 dev eth2 realm 2
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 \
  route from 2 classid 1:2
</code>
</pre>
</blockquote>

<br>
<br>
 

<p>Ici, le filtre spécifie que les paquets venant du réseau
192.168.2.0 (realm 2) correspondront à la classe 1:2.</p>

<h2><a name="ss12.3">12.3</a> <a href=
"Advanced-routing-Howto.v0.9.html#toc12.3">Les filtres de
réglementation (Policing filters)</a></h2>

<p>Pour réaliser des configurations encore plus compliquées, vous
pouvez avoir des filtres qui analysent le trafic que jusqu'à une
certaine bande passante. Vous pouvez configurer un filtre pour
qu'il cesse entièrement l'analyse de tout le trafic au-dessus d'un
certain débit ou pour qu'il n'analyse pas la bande passante
dépassant un certain débit.</p>

<p>Ainsi, si vous décidez de réglementer à 4mbit/s, mais qu'un
trafic de 5mbit/s est présent, vous pouvez cesser d'analyser
l'ensemble des 5mbit/s ou seulement cesser d'analyser le 1 mbit/s
supplémentaire et envoyer 4 mbit/s à la classe correspondante.</p>

<p>Si la bande passante dépasse le débit configuré, vous pouvez
rejeter un paquet, le reclassifier ou voir si un autre filtre y
correspond.</p>

<h3>Manières de réglementer</h3>

<p>Il y a essentiellement deux façons de réglementer. Si vous avez
compilé le noyau avec 'Estimators', celui-ci peut mesurer plus ou
moins pour chaque filtre le trafic qui est passé. Ces estimations
ne sont pas coûteuses en temps CPU, étant donné qu'il ne compte que
25 fois par seconde le nombre de données qui sont passées, et qu'il
calcule le débit à partir de cela.</p>

<p>L'autre manière utilise encore le Token Bucket Filter qui, cette
fois, réside à l'intérieur du filtre. Le TBF n'analyse seulement le
trafic que JUSQU'A la bande passante que vous avez configurée. Si
cette bande passante est dépassée, seul l'excès est traité par
l'action de dépassement de limite configurée.</p>

<h3>Avec l'estimateur du noyau</h3>

<p>Ceci est très simple et il n'y a qu'un seul paramètre&nbsp;:
avrate. Soit le flux demeure sous avrate, et le filtre classifie le
trafic vers la classe appropriée, soit votre débit le dépasse et,
dans ce cas, l'action indiquée est réalisée qui, par défaut, est la
'reclassification'.</p>

<p>Le noyau utilise l'algorithme EWMA pour votre bande passante, ce
qui la rend moins sensible aux courtes rafales de données.</p>

<h3>Avec le Token Bucket Filter</h3>

<p>Utilisez les paramètres suivants&nbsp;:</p>

<ul>
<li>buffer/maxburst</li>

<li>mtu/minburst</li>

<li>mpu</li>

<li>rate</li>
</ul>

<br>
<br>
 

<p>Ceux-ci se comporte la plupart du temps de manière identique à
ceux décrits dans la section Token Bucket Filter. Notez cependant
que si vous configurez le mtu du filtre de réglementation TBF trop
bas, aucun paquet ne passera, tandis que le gestionnaire de mise en
file d'attente de sortie TBF ne fait que les ralentir.</p>

<p>Une autre différence est que la réglementation ne peut que
laisser passer ou jeter un paquet. Il ne peut pas le retenir dans
le but de le retarder.</p>

<h3>Actions de dépassement de limite (Overlimit actions)</h3>

<p>Si votre filtre décide qu'un dépassement de limite est atteint,
il peut mettre en oeuvre des 'actions'. Actuellement, trois actions
sont disponibles&nbsp;:</p>

<dl>
<dt><b>continue</b></dt>

<dd>
<p>Provoque l'arrêt de l'analyse du filtre, bien que d'autres
filtres puissent peut-être continuer à le faire.</p>
</dd>

<dt><b>drop</b></dt>

<dd>
<p>Ceci est une option très féroce qui supprime simplement le
trafic excédant un certain débit. Elle est souvent employée dans le
"Ingress policer" et a des utilisations limitées. Par exemple, si
vous avez un serveur de nom qui s'écroule s'il traite plus de
5mbit/s de paquets, alors, dans ce cas, vous pourrez utiliser un
filtre d'entrée pour être sûr qu'il ne traitera jamais plus de
5mbit/s.</p>
</dd>

<dt><b>Pass/OK</b></dt>

<dd>
<p>Transmettre le trafic. Pourrait être utilisé pour mettre hors
service un filtre compliqué, tout en le laissant en place.</p>
</dd>

<dt><b>reclassify</b></dt>

<dd>
<p>Permet le plus souvent une reclassification vers Best Effort.
Ceci est l'action par défaut.</p>
</dd>
</dl>

<br>
<br>
 

<h3>Exemples</h3>

<p>Le seul vrai exemple connu est mentionné dans la section
'Protéger votre machine des inondations SYN'</p>

<p>FIXME: Si vous avez déjà utilisé ceci, partagez s'il vous plaît
votre expérience avec nous.</p>

<h2><a name="ss12.4">12.4</a> <a href=
"Advanced-routing-Howto.v0.9.html#toc12.4">Filtres hachés pour un
filtrage massive très rapide</a></h2>

<p>Si vous avez besoin de milliers de règles, par exemple, dans le
cas où vous avez beaucoup de clients ou d'ordinateurs, tous avec
des spécifications QoS différentes, vous pourrez constater que le
noyau passe beaucoup de temps à analyser toutes ces règles.</p>

<p>Par défaut, tous les filtres résident dans une grande chaîne qui
est analysée par ordre décroissant des priorités. Si vous avez 1000
règles, 1000 contrôles peuvent être nécessaires pour déterminer ce
qu'il faut faire d'un paquet.</p>

<p>La vérification irait plus vite s'il y avait 256 chaînes avec
chacune quatre règles. Si vous pouviez répartir les paquets sur ces
256 chaînes, afin que la bonne règle soit présente.</p>

<p>Ceci est rendu possible par le hachage. Imaginons que vous ayez
sur votre réseau 1024 clients avec des modems câble, avec des
adresses IP allant de 1.2.0.0 à 1.2.3.255, et que chacun doit avoir
un classement particulier, par exemple 'pauvre', 'moyen' et
'bourge'. Cela vous ferait alors 1024 règles, dans le
genre&nbsp;:</p>

<pre>
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.0 classid 1:1
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.1 classid 1:1
...
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.3.254 classid 1:3
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.3.255 classid 1:2
</pre>

<br>
<br>
 

<p>Pour aller plus vite, nous pouvons utiliser la dernière partie
de l'adresse IP comme 'clé de hachage'. Nous obtenons alors 256
tables, la première ressemblant à ceci&nbsp;:</p>

<pre>
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.0 classid 1:1
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.1.0 classid 1:1
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.2.0 classid 1:3
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.3.0 classid 1:2
</pre>

<br>
<br>
 

<p>La suivante commence comme ceci&nbsp;:</p>

<pre>
# tc filter add dev eth1 parent 1:0 protocol ip prio 100 match ip src \
  1.2.0.1 classid 1:1
...
</pre>

<br>
<br>
 

<p>De cette manière, seuls quatre recherches au plus sont
nécessaires, deux en moyenne.</p>

<p>La configuration est plutôt compliqué, mais elle en vaut
vraiment la peine du fait des nombreuses règles. Nous créons
d'abord un filtre racine, puis une table avec 256
entrées&nbsp;:</p>

<pre>
# tc filter add dev eth1 parent 1:0 prio 5 protocol ip u32
# tc filter add dev eth1 parent 1:0 prio 5 handle 2: u32 divisor 256
</pre>

<br>
<br>
 

<p>Nous ajoutons maintenant des règles dans la table précédemment
créée&nbsp;:</p>

<pre>
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.0.123 flowid 1:1
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.1.123 flowid 1:2
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.3.123 flowid 1:3
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 2:7b: \
        match ip src 1.2.4.123 flowid 1:2
</pre>

Ceci est l'entrée 123, qui contient les correspondances pour
1.2.0.13, 1.2.1.123, 1.2.2.123 et 1.2.3.123 et qui les envoient
respectivement vers 1:1, 1:2, 1:3 et 1:2. Notez que nous devons
spécifier notre seau de hachage en hexadécimal, 0x7b pour 123.<br>
<br>
 

<p>Nous créons ensuite un 'filtre de hachage' qui dirige le trafic
vers la bonne entrée de la table de hachage&nbsp;:</p>

<pre>
# tc filter add dev eth1 protocol ip parent 1:0 prio 5 u32 ht 800:: \
        match ip src 1.2.0.0/16 \
        hashkey mask 0x000000ff at 12 \
        link 2:
</pre>

Ok, certains nombres doivent être expliqués. La table de hachage
par défaut est appelée 800:: et tous les filtres démarrent de là.
Nous sélectionnons alors l'adresse source qui est en position 12,
13, 14 et 15 dans l'entête IP, et indiquons que seule la dernière
partie nous intéresse. Ceci est envoyé vers la table de hachage 1:
qui a été créé plus tôt.<br>
<br>
 

<p>C'est plutôt compliqué, mais cela marche en pratique et les
performances seront époustouflantes. Notez que cet exemple pourrait
être améliorer pour que chaque chaîne contienne un filtre, ce qui
représenterait le cas idéal&nbsp;!</p>

<hr>
<a href="Advanced-routing-Howto.v0.9-13.html">Page suivante</a> <a
href="Advanced-routing-Howto.v0.9-11.html">Page précédente</a> <a
href="Advanced-routing-Howto.v0.9.html#toc12">Table des
matières</a>
</body>
</html>


	  </TD>
	</TR>
      </TABLE>
    </TD>
  </TR>
  <TR>
    <TD colspan=2 width=100% bgcolor=#990000 align=left>
      <TABLE width=100% border=0 cellpadding=0 cellspacing=4>
        <TR>
	  <TD bgcolor=#990000 align=right>
	    <div class="filemodtime">
	      <i>Dernière modification le : 4 March 2002 12:04</i>
	    </div>
      	    <a style="text-decoration:none" href="http://www.php.net">
              <img src="/prj/inetdoc/images/php-small-trans-dark.gif" border=0 width=88 height=31 alt="php logo">
      	    </a>
      	    &nbsp;&nbsp;
      	    <a style="text-decoration:none" href="http://www.debian.org">
              <img src="/prj/inetdoc/images/openlogo-25.jpg" border=0 width=25 height=30 alt="debian logo">
      	    </a>
      	    &nbsp;&nbsp;
	    <!-- stat_code_start
	    <a style="text-decoration:none" href="http://www.estat.com/getstats?serial=21701747824">
	      <img src="http://perso.estat.com/cgi-bin/perso/21701747824?page=marque_perso" border=0>
	    </a>
	     stat_code_end -->
	    <!-- eStat -->
	    <SCRIPT LANGUAGE="JavaScript">
	      <!--
	      var _UJS=0;
	      //-->
	    </SCRIPT>
	    <SCRIPT LANGUAGE="JavaScript" SRC="http://perso.estat.com/js/m.js">
	    </SCRIPT>
	    <SCRIPT LANGUAGE="JavaScript">
	      <!--
	      if(_UJS) _estat('21701747824','Page_D_Accueil','Accueil');
	      //-->
	    </SCRIPT>
	    <!-- /eStat -->
	  </TD>
	</TR>
      </TABLE>
    </TD>
  </TR>
</TABLE>
</body>
</html>
<!-- END: main.tpl -->
