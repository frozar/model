<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 99.2beta8 (1.46)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>20. Advanced Shell Scripting</TITLE>
<META NAME="description" CONTENT="20. Advanced Shell Scripting">
<META NAME="keywords" CONTENT="rute">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<META NAME="Generator" CONTENT="LaTeX2HTML v99.2beta8">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="rute.css">

<LINK REL="next" HREF="node24.html">
<LINK REL="previous" HREF="node22.html">
<LINK REL="up" HREF="rute.html">
<LINK REL="next" HREF="node24.html">
</HEAD>

<BODY BGCOLOR=#FFFFFF >
<TABLE width="100%" border="0" cellspacing="0" cellpadding="0">
<TR><TD align=left bgcolor="#000000">
<FONT COLOR=white>
&nbsp;<A HREF="http://www.icon.co.za/~psheer/rute-purchase.html"><FONT COLOR=white>Purchase</FONT></A>&nbsp;
</FONT>
</TD><TD align=center bgcolor="#000000">
<FONT COLOR=white>
Copyright&nbsp;&#169;&nbsp;2002&nbsp;Paul Sheer. <A HREF="copying.html"><FONT COLOR=white>Click here for copying permissions.</FONT></A>
</FONT>
</TD><TD align=right bgcolor="#000000">
<FONT COLOR=white>
&nbsp;<A HREF="http://www.icon.co.za/~psheer/rute-home.html"><FONT COLOR=white>Home</FONT></A>&nbsp;
</FONT>
</TD></TR>
<TR><TD colspan=2 align=left bgcolor="#ECEBF4">
<IMG SRC="va-btn-small-light-60.png">
</TD><TD align=right bgcolor="#ECEBF4">
<IMG SRC="sflogo2-steel-60.png">
</TD></TR>
</TABLE><BR>

<!--Navigation Panel-->
<A NAME="tex2html2123"
  HREF="node24.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html2119"
  HREF="rute.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html2113"
  HREF="node22.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html2121"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html2124"
  HREF="node24.html">21. System Services and</A>
<B> Up:</B> <A NAME="tex2html2120"
  HREF="rute.html">rute</A>
<B> Previous:</B> <A NAME="tex2html2114"
  HREF="node22.html">19. Partitions, File Systems,</A>
 &nbsp <B>  <A NAME="tex2html2122"
  HREF="node1.html">Contents</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsections</STRONG></A>

<UL>
<LI><A NAME="tex2html2125"
  HREF="#SECTION002310000000000000000">20.1 Lists of Commands</A>
<LI><A NAME="tex2html2126"
  HREF="#SECTION002320000000000000000">20.2 Special Parameters: <TT>
<FONT COLOR="#0000ff">$?</FONT></TT>, <TT>
<FONT COLOR="#0000ff">$*</FONT></TT>,...</A>
<LI><A NAME="tex2html2127"
  HREF="#SECTION002330000000000000000">20.3 Expansion</A>
<LI><A NAME="tex2html2128"
  HREF="#SECTION002340000000000000000">20.4 Built-in Commands</A>
<LI><A NAME="tex2html2129"
  HREF="#SECTION002350000000000000000">20.5 Trapping Signals -- the <TT>
<FONT COLOR="#0000ff">trap</FONT></TT> Command</A>
<LI><A NAME="tex2html2130"
  HREF="#SECTION002360000000000000000">20.6 Internal Settings -- the <TT>
<FONT COLOR="#0000ff">set</FONT></TT> Command</A>
<LI><A NAME="tex2html2131"
  HREF="#SECTION002370000000000000000">20.7 Useful Scripts and Commands</A>
<UL>
<LI><A NAME="tex2html2132"
  HREF="#SECTION002371000000000000000">20.7.1 <TT>
<FONT COLOR="#0000ff">chroot</FONT></TT></A>
<LI><A NAME="tex2html2133"
  HREF="#SECTION002372000000000000000">20.7.2 <TT>
<FONT COLOR="#0000ff">if</FONT></TT> conditionals</A>
<LI><A NAME="tex2html2134"
  HREF="#SECTION002373000000000000000">20.7.3 <TT>
<FONT COLOR="#0000ff">patch</FONT></TT>ing and <TT>
<FONT COLOR="#0000ff">diff</FONT></TT>ing</A>
<LI><A NAME="tex2html2135"
  HREF="#SECTION002374000000000000000">20.7.4 Internet connectivity test</A>
<LI><A NAME="tex2html2136"
  HREF="#SECTION002375000000000000000">20.7.5 Recursive <TT>
<FONT COLOR="#0000ff">grep</FONT></TT> (search)</A>
<LI><A NAME="tex2html2137"
  HREF="#SECTION002376000000000000000">20.7.6 Recursive search and replace</A>
<LI><A NAME="tex2html2138"
  HREF="#SECTION002377000000000000000">20.7.7 <TT>
<FONT COLOR="#0000ff">cut</FONT></TT> and <TT>
<FONT COLOR="#0000ff">awk</FONT></TT> -- manipulating text file fields</A>
<LI><A NAME="tex2html2139"
  HREF="#SECTION002378000000000000000">20.7.8 Calculations with <TT>
<FONT COLOR="#0000ff">bc</FONT></TT></A>
<LI><A NAME="tex2html2140"
  HREF="#SECTION002379000000000000000">20.7.9 Conversion of graphics formats of many files</A>
<LI><A NAME="tex2html2141"
  HREF="#SECTION0023710000000000000000">20.7.10 Securely erasing files</A>
<LI><A NAME="tex2html2142"
  HREF="#SECTION0023711000000000000000">20.7.11 Persistent background processes</A>
<LI><A NAME="tex2html2143"
  HREF="#SECTION0023712000000000000000">20.7.12 Processing the process list</A>
</UL>
<LI><A NAME="tex2html2144"
  HREF="#SECTION002380000000000000000">20.8 Shell Initialization</A>
<UL>
<LI><A NAME="tex2html2145"
  HREF="#SECTION002381000000000000000">20.8.1 Customizing the <TT>
<FONT COLOR="#0000ff">PATH</FONT></TT> and <TT>
<FONT COLOR="#0000ff">LD_LIBRARY_PATH</FONT></TT></A>
</UL>
<LI><A NAME="tex2html2146"
  HREF="#SECTION002390000000000000000">20.9 File Locking</A>
<UL>
<LI><A NAME="tex2html2147"
  HREF="#SECTION002391000000000000000">20.9.1 Locking a mailbox file</A>
<LI><A NAME="tex2html2148"
  HREF="#SECTION002392000000000000000">20.9.2 Locking over NFS</A>
<LI><A NAME="tex2html2149"
  HREF="#SECTION002393000000000000000">20.9.3 Directory versus file locking</A>
<LI><A NAME="tex2html2150"
  HREF="#SECTION002394000000000000000">20.9.4 Locking inside <B>C</B> programs</A>
</UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H1><A NAME="SECTION002300000000000000000">
20. Advanced Shell Scripting</A>
</H1>

<P>
<A NAME="chap:advancedscript"></A>
<P>
This chapter completes our discussion of <TT>
<FONT COLOR="#0000ff">sh</FONT></TT> shell scripting
begun in Chapter <A HREF="node10.html#chap:shellscript">7</A> and expanded on in
Chapter <A HREF="node12.html#chap:processenviron">9</A>. These three chapters represent
almost everything you can do with the <TT>
<FONT COLOR="#0000ff">bash</FONT></TT> shell.

<P>

<H1><A NAME="SECTION002310000000000000000">
20.1 Lists of Commands</A>
</H1>

<P>
The special operator <TT>
<FONT COLOR="#0000ff">&amp;&amp;</FONT></TT> and <TT>
<FONT COLOR="#0000ff">&#124;&#124;</FONT></TT> can be used to
execute functions in sequence. For instance:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>grep&nbsp;'^harry:'&nbsp;/etc/passwd&nbsp;||&nbsp;useradd&nbsp;harry</code><br>
</FONT></TD></TR></TABLE><P>
The <TT>
<FONT COLOR="#0000ff">&#124;&#124;</FONT></TT> means to only execute the second
command if the first command returns an error. In the above
case, <TT>
<FONT COLOR="#0000ff">grep</FONT></TT> will return an exit code of 1 if <TT>
<FONT COLOR="#0000ff">harry</FONT></TT>
is not in the <TT>
<FONT COLOR="#0000ff">/etc/passwd</FONT></TT> file, causing <TT>
<FONT COLOR="#0000ff">useradd</FONT></TT>
to be executed.

<P>
An alternate representation is

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>grep&nbsp;-v&nbsp;'^harry:'&nbsp;/etc/passwd&nbsp;&#038;&#038;&nbsp;useradd&nbsp;harry</code><br>
</FONT></TD></TR></TABLE><P>
where the <TT>
<FONT COLOR="#0000ff">-v</FONT></TT> option inverts the sense of matching
of <TT>
<FONT COLOR="#0000ff">grep</FONT></TT>. <TT>
<FONT COLOR="#0000ff">&amp;&amp;</FONT></TT> has the opposite meaning to <TT>
<FONT COLOR="#0000ff">&#124;&#124;</FONT></TT>,
that is, to execute the second command only if the first succeeds.

<P>
Adept script writers often string together many commands
to create the most succinct representation of an operation:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>grep&nbsp;-v&nbsp;'^harry:'&nbsp;/etc/passwd&nbsp;&#038;&#038;&nbsp;useradd&nbsp;harry&nbsp;||&nbsp;\</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"`date`:&nbsp;useradd&nbsp;failed"&nbsp;&#062;&#062;&nbsp;/var/log/my_special_log</code><br>
</FONT></TD></TR></TABLE><P>

<P>

<H1><A NAME="SECTION002320000000000000000">
20.2 Special Parameters: <TT>
<FONT COLOR="#0000ff">$?</FONT></TT>, <TT>
<FONT COLOR="#0000ff">$*</FONT></TT>,...</A>
</H1>

<P>
An ordinary variable can be expanded with <TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VARNAME</I>.
Commonly used variables like <TT>
<FONT COLOR="#0000ff">PATH</FONT></TT> and special variables
like <TT>
<FONT COLOR="#0000ff">PWD</FONT></TT> and <TT>
<FONT COLOR="#0000ff">RANDOM</FONT></TT> were covered in Chapter
<A HREF="node12.html#chap:processenviron">9</A>. Further special expansions are
documented in the following section, quoted verbatim from the
<TT>
<FONT COLOR="#0000ff">bash</FONT></TT> man page (the footnotes are
mine).<FONT COLOR="#ffa500">(footnote follows)</FONT> <FONT COLOR="#ffa500">[Thanks to Brian Fox and Chet Ramey for this material.]</FONT>
<P>

<BLOCKQUOTE><FONT SIZE="-1"><B>Special Parameters</B>
<BR>
<BR>
The shell treats several parameters specially. These
parameters may only be referenced; assignment to them is
not allowed.
</FONT></BLOCKQUOTE><DL>
<DT><STRONG><B>$*</B></STRONG></DT>
<DD>Expands to the positional parameters (i.e., the command-line arguments
passed to the shell script, with <B>$1</B> being the
first argument, <B>$2</B> the second etc.), starting from
one. When the expansion occurs within double
quotes, it expands to a single word with the value
of each parameter separated by the first character
of the <B>IFS</B> special variable. That is, "<B>$*</B>" is
equivalent to "<B>$1</B><I>c</I><B>$2</B><I>c</I><B>...</B>", where <I>c</I> is the first
character of the value of the <B>IFS</B> variable. If <B>IFS</B>
is unset, the parameters are separated by spaces.
If <B>IFS</B> is null, the parameters are joined without
intervening separators.
</DD>
<DT><STRONG><B>$@</B></STRONG></DT>
<DD>Expands to the positional parameters, starting from
one. When the expansion occurs within double
quotes, each parameter expands to a separate word.
That is, "<B>$@</B>" is equivalent to "<B>$1</B>" "<B>$2</B>" ... When
there are no positional parameters, "<B>$@</B>" and <B>$@</B>
expand to nothing (i.e., they are removed). <FONT COLOR="#ffa500">[Hint: this is
very useful for writing wrapper shell scripts that just add
one argument.]</FONT>
</DD>
<DT><STRONG><B>$#</B></STRONG></DT>
<DD>Expands to the number of positional parameters in
decimal (i.e. the number of command-line arguments).
</DD>
<DT><STRONG><B>$?</B></STRONG></DT>
<DD>Expands to the status of the most recently executed
foreground pipeline. <FONT COLOR="#ffa500">[I.e., the exit code of the last
command.]</FONT>
</DD>
<DT><STRONG><B>$-</B></STRONG></DT>
<DD>Expands to the current option flags as specified
upon invocation, by the <B>set</B> builtin command, or
those set by the shell itself (such as the <B>-i</B>
option).
</DD>
<DT><STRONG><B>$$</B></STRONG></DT>
<DD>Expands to the process ID of the shell. In a ()
subshell, it expands to the process ID of the current 
shell, not the subshell.
</DD>
<DT><STRONG><B>$!</B></STRONG></DT>
<DD>Expands to the process ID of the most recently executed 
background (asynchronous) command. <FONT COLOR="#ffa500">[I.e., after executing
a background command with <I>command&nbsp;</I><B>&amp;</B>, the variable
<B>$!</B> will give its process ID.]</FONT>
</DD>
<DT><STRONG><B>$0</B></STRONG></DT>
<DD>Expands to the name of the shell or shell script.
This is set at shell initialization. If <B>bash</B> is
invoked with a file of commands, <B>$0</B> is set to the
name of that file. If <B>bash</B> is started with the <B>-c</B>
option, then <B>$0</B> is set to the first argument after
the string to be executed, if one is present. Otherwise,
it is set to the file name used to invoke
<B>bash</B>, as given by argument zero. <FONT COLOR="#ffa500">[Note that <B>basename&nbsp;$0</B>
is a useful way to get the name of the current command without the leading
path.]</FONT>
</DD>
<DT><STRONG><B>$-</B></STRONG></DT>
<DD>At shell startup, set to the absolute file name of
the shell or shell script being executed as passed
in the argument list. Subsequently, expands to the
last argument to the previous command, after expansion.
Also set to the full file name of each command 
executed and placed in the environment
exported to that command. When checking mail, this
parameter holds the name of the mail file currently
being checked.
</DD>
</DL><BLOCKQUOTE></BLOCKQUOTE>

<P>

<H1><A NAME="SECTION002330000000000000000">
20.3 Expansion</A>
</H1>

<P>
<I>Expansion</I> refers to the way <TT>
<FONT COLOR="#0000ff">bash</FONT></TT> modifies
the command-line before executing it. <TT>
<FONT COLOR="#0000ff">bash</FONT></TT> performs several
textual modifications to the command-line, proceeding in the following order:
<DL>
<DT><STRONG><I>Brace expansion</I></STRONG></DT>
<DD>We have already shown how you can use, for example,
the shorthand <TT>
<FONT COLOR="#0000ff">touch&nbsp;file_&#123;one,two,three&#125;.txt</FONT></TT> to create multiple
files <TT>
<FONT COLOR="#0000ff">file_one.txt</FONT></TT>, <TT>
<FONT COLOR="#0000ff">file_two.txt</FONT></TT>, and <TT>
<FONT COLOR="#0000ff">file_three.txt</FONT></TT>.
This is known as brace expansion and occurs before any other kind of modification
to the command-line.
</DD>
<DT><STRONG><I>Tilde expansion</I></STRONG></DT>
<DD>The special character <TT>
<FONT COLOR="#0000ff">~</FONT></TT> is replaced with
the full path contained in the <TT>
<FONT COLOR="#0000ff">HOME</FONT></TT> environment variable or the home
directory of the users login (if <TT>
<FONT COLOR="#0000ff">$HOME</FONT></TT> is null). <TT>
<FONT COLOR="#0000ff">~+</FONT></TT> is replaced with
the current working directory and <TT>
<FONT COLOR="#0000ff">~-</FONT></TT> is replaced with the most recent
previous working directory. The last two are rarely used.
</DD>
<DT><STRONG><I>Parameter expansion</I></STRONG></DT>
<DD>This refers to expanding anything that begins
with a <TT>
<FONT COLOR="#0000ff">$</FONT></TT>. Note that <TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I> and <TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT>
do exactly the same thing, except in the latter case, <I>VAR</I> can contain
non-``whole word'' characters that would normally confuse <TT>
<FONT COLOR="#0000ff">bash</FONT></TT>.

<P>
There are several parameter expansion tricks that you can use to do string manipulation.
Most shell programmers never bother with these, probably because
they are not well supported by other U<SMALL>NIX</SMALL> systems.
<DL>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">:-</FONT></TT><I>default</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>This will result in
<TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I> unless <I>VAR</I> is unset or null, in which case
it will result in <I>default</I>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">:=</FONT></TT><I>default</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>Same as previous
except that <I>default</I> is also assigned to <TT>
<FONT COLOR="#0000ff">VAR</FONT></TT> if it is empty.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">:-</FONT></TT><I>default</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>This will result in
an empty string if <I>VAR</I> is unset or null; otherwise it will result in
<I>default</I>. This is the opposite behavior of
<TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">:-</FONT></TT><I>default</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">:?</FONT></TT><I>message</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>This will result in
<TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I> unless <I>VAR</I> is unset or null, in which case
an error message containing <I>message</I> is displayed.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">:</FONT></TT><I>offset</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT> or <TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">:</FONT></TT><I>n</I><TT>
<FONT COLOR="#0000ff">:</FONT></TT><I>l</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>This produces the <I>n</I>th character of <TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I> and then the following
<I>l</I> characters. If <I>l</I> is not present, then all characters to the right of
the <I>n</I>th character are produced. This is useful for splitting up strings. Try:
</DD>
</DL>
</DD>
</DL>

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>TEXT=scripting_for_phun</code><br>
<code>echo&nbsp;${TEXT:10:3}</code><br>
<code>echo&nbsp;${TEXT:10}</code><br>
</FONT></TD></TR></TABLE><P>
<DL>
<DT><STRONG>&nbsp;</STRONG></DT>
<DD>&nbsp;
<BR>
<DL>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;#</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>Gives the length of <TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;!</FONT></TT><I>PRE</I><TT>
<FONT COLOR="#0000ff">*&#125;</FONT></TT></STRONG></DT>
<DD>Gives a list of all variables whose
names begin with <I>PRE</I>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">#</FONT></TT><I>pattern</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD><TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I>
is returned with the glob expression <I>pattern</I> removed from the leading
part of the string. For instance, <TT>
<FONT COLOR="#0000ff">$&#123;TEXT#scr&#125;</FONT></TT> in the above example
will return <TT>
<FONT COLOR="#0000ff">ripting_for_phun</FONT></TT>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">##</FONT></TT><I>pattern</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>This is the same as
the previous expansion except that if <I>pattern</I> contains wild cards, then it
will try to match the maximum length of characters.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">%</FONT></TT><I>pattern</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>The same as
<TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">#</FONT></TT><I>pattern</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT> except that characters are
removed from the trailing part of the string.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">%%</FONT></TT><I>pattern</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>The same as
<TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">##</FONT></TT><I>pattern</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT> except that characters are
removed from the trailing part of the string.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>search</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>replace</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD><TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I> is returned with the first occurrence of the string <I>search</I>
replaced with <I>replace</I>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">/#</FONT></TT><I>search</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>replace</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>Same as <TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>search</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>replace</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT>
except that the match is attempted from the leading part of <TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">/%</FONT></TT><I>search</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>replace</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>Same as <TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>search</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>replace</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT>
except that the match is attempted at the trailing part of <TT>
<FONT COLOR="#0000ff">$</FONT></TT><I>VAR</I>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">//</FONT></TT><I>search</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>replace</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT></STRONG></DT>
<DD>Same as <TT>
<FONT COLOR="#0000ff">$&#123;</FONT></TT><I>VAR</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>search</I><TT>
<FONT COLOR="#0000ff">/</FONT></TT><I>replace</I><TT>
<FONT COLOR="#0000ff">&#125;</FONT></TT>
except that all instances of <I>search</I> are replaced.
</DD>
</DL>
</DD>
<DT><STRONG><I>Backquote expansion</I></STRONG></DT>
<DD>We have already shown backquote expansion
in <A HREF="node10.html#sec:backquote">7.12</A>. Note that the additional notation
<TT>
<FONT COLOR="#0000ff">$(</FONT></TT><I>command</I>) is equivalent to <TT>
<FONT COLOR="#0000ff">`</FONT></TT><I>command</I>` except
that escapes (i.e., <TT>
<FONT COLOR="#0000ff">&#92;</FONT></TT>) are not required for special characters.
</DD>
<DT><STRONG><I>Arithmetic expansion</I></STRONG></DT>
<DD>We have already shown arithmetic expansion
on page <A HREF="node10.html#page:arithshellbrace"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>. Note that the additional notation
<TT>
<FONT COLOR="#0000ff">$((</FONT></TT><I>expression</I>)) is equivalent to <TT>
<FONT COLOR="#0000ff">$[</FONT></TT><I>expression</I>].
</DD>
<DT><STRONG><I>Finally</I></STRONG></DT>
<DD>The last modifications to the command-line are
the splitting of the command-line into words according to the white space
between them. The <TT>
<FONT COLOR="#0000ff">IFS</FONT></TT> (<I>Internal Field Separator</I>) environment
variable
determines what characters delimit command-line words (usually whitespace).
With the command-line divided into words, path names are expanded according
to glob wild cards. Consult <TT>
<FONT COLOR="#0000ff">bash</FONT></TT>(1) for a comprehensive
description of the pattern matching options that most people don't know
about.
</DD>
</DL>

<P>

<H1><A NAME="SECTION002340000000000000000">
20.4 Built-in Commands</A>
</H1>

<P>
Many commands operate some built-in functionality of <TT>
<FONT COLOR="#0000ff">bash</FONT></TT> or are
especially interpreted. These do not invoke an executable off the
file system. Some of these were described in Chapter
<A HREF="node10.html#chap:shellscript">7</A>, and a few more are discussed here. For an
exhaustive description, consult <TT>
<FONT COLOR="#0000ff">bash</FONT></TT>(1).
<DL>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">:</FONT></TT></STRONG></DT>
<DD>A single colon by itself does nothing. It is useful
for a ``no operation'' line such as:
</DD>
</DL>

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>if&nbsp;&#060;command&#062;&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;:</code><br>
<code>else</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"&#060;command&#062;&nbsp;was&nbsp;unsuccessful"</code><br>
<code>fi</code><br>
</FONT></TD></TR></TABLE><P>
<DL>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">.</FONT></TT> <I>filename args ...</I></STRONG></DT>
<DD>A single dot is the same as
the <TT>
<FONT COLOR="#0000ff">source</FONT></TT> command. See below.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">alias</FONT></TT> <I>command</I><TT>
<FONT COLOR="#0000ff">=</FONT></TT><I>value</I></STRONG></DT>
<DD>Creates a
pseudonym for a command. Try:
</DD>
</DL>

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>alias&nbsp;necho="echo&nbsp;-n"</code><br>
<code>necho&nbsp;"hello"</code><br>
</FONT></TD></TR></TABLE><P>
<DL>
<DT></DT>
<DD>Some distributions <TT>
<FONT COLOR="#0000ff">alias</FONT></TT> the <TT>
<FONT COLOR="#0000ff">mv</FONT></TT>, <TT>
<FONT COLOR="#0000ff">cp</FONT></TT>,
and <TT>
<FONT COLOR="#0000ff">rm</FONT></TT> commands to the same pseudonym with the <TT>
<FONT COLOR="#0000ff">-i</FONT></TT>
(<TT>
<FONT COLOR="#0000ff">i</FONT></TT>nteractive) option set. This prevents files from being deleted
without prompting, but can be irritating for the administrator.
See your <TT>
<FONT COLOR="#0000ff">~/.bashrc</FONT></TT> file for these settings. See also <TT>
<FONT COLOR="#0000ff">unalias</FONT></TT>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">unalias</FONT></TT> <I>command</I></STRONG></DT>
<DD>Removes an alias created with <TT>
<FONT COLOR="#0000ff">alias</FONT></TT>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">alias -p</FONT></TT></STRONG></DT>
<DD>Prints list of aliases.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">eval</FONT></TT> <I>arg ...</I></STRONG></DT>
<DD>Executes <I>arg</I>s as a line of shell script.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">exec</FONT></TT> <I>command arg ...</I></STRONG></DT>
<DD>Begins executing <I>command</I>
under the same process ID as the current script. This is most often
used for shell scripts that are mere ``wrapper'' scripts for
real programs. The wrapper script sets any environment variables
and then <TT>
<FONT COLOR="#0000ff">exec</FONT></TT>s the real program binary as its last line.
<TT>
<FONT COLOR="#0000ff">exec</FONT></TT> should never return.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">local</FONT></TT> <I>var</I><TT>
<FONT COLOR="#0000ff">=</FONT></TT><I>value</I></STRONG></DT>
<DD>Assigns a value
to a variable. The resulting variable is visible only within
the current function.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">pushd</FONT></TT> <I>directory</I> and <TT>
<FONT COLOR="#0000ff">popd</FONT></TT></STRONG></DT>
<DD>These two commands
are useful for jumping around directories. <TT>
<FONT COLOR="#0000ff">pushd</FONT></TT> can be used
instead of <TT>
<FONT COLOR="#0000ff">cd</FONT></TT>, but unlike <TT>
<FONT COLOR="#0000ff">cd</FONT></TT>, the directory is saved onto
a list of directories. At any time, entering <TT>
<FONT COLOR="#0000ff">popd</FONT></TT> returns you
to the previous directory. This is nice for navigation since it
keeps a history of wherever you have been.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">printf</FONT></TT> <I>format args ...</I></STRONG></DT>
<DD>This is like the <B>C</B> <TT>
<FONT COLOR="#0000ff">printf</FONT></TT>
function. It outputs to the terminal like <TT>
<FONT COLOR="#0000ff">echo</FONT></TT> but is useful
for more complex formatting of output. See <TT>
<FONT COLOR="#0000ff">printf</FONT></TT>(3) for details
and try <TT>
<FONT COLOR="#0000ff">printf&nbsp;"%10.3e&#92;n"&nbsp;12</FONT></TT> as an example.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">pwd</FONT></TT></STRONG></DT>
<DD>Prints the present working directory.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set</FONT></TT></STRONG></DT>
<DD>Prints the value of all environment variables.
See also Section <A HREF="node23.html#sec:setbashbuiltin">20.6</A> on the <TT>
<FONT COLOR="#0000ff">set</FONT></TT> command.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">source</FONT></TT> <I>filename args ...</I></STRONG></DT>
<DD>Reads <I>filename</I>
into the current current shell environment. This is useful for 
executing a shell script when environment variables set by
that script must be preserved.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">times</FONT></TT></STRONG></DT>
<DD>Prints the accumulated user and system times
for the shell and for processes run from the shell.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">type</FONT></TT> <I>command</I></STRONG></DT>
<DD>Tells whether <I>command</I>
is an alias, a built-in or a system executable.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">ulimit</FONT></TT></STRONG></DT>
<DD>Prints and sets various user resource limits
like memory usage limits and CPU limits. See <TT>
<FONT COLOR="#0000ff">bash</FONT></TT>(1) for details.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">umask</FONT></TT></STRONG></DT>
<DD>See Section <A HREF="node17.html#sec:umask">14.2</A>.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">unset</FONT></TT> <I>VAR</I></STRONG></DT>
<DD>Deletes a variable or environment variable.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">unset -f</FONT></TT> <I>func</I></STRONG></DT>
<DD>Deletes a function.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">wait</FONT></TT></STRONG></DT>
<DD>Pauses until all background jobs have completed.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">wait</FONT></TT> <I>PID</I></STRONG></DT>
<DD>Pauses until background process with
process ID of <I>PID</I> has exited, then returns the exit code
of the background process.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">wait&nbsp;%</FONT></TT><I>job</I></STRONG></DT>
<DD>Same with respect to a job spec.
</DD>
</DL>

<P>

<H1><A NAME="SECTION002350000000000000000">
20.5 Trapping Signals -- the <TT>
<FONT COLOR="#0000ff">trap</FONT></TT> Command</A>
</H1>

<P>
You will often want to make your script perform certain
actions in response to a signal. A list of signals can
be found on page <A HREF="node12.html#page:commonsignals"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>. To trap
a signal, create a function and then use the <TT>
<FONT COLOR="#0000ff">trap</FONT></TT>
command to bind the function to the signal.

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>#!/bin/sh</code><br>
<code>&nbsp;</code><br>
<code>function&nbsp;on_hangup&nbsp;()</code><br>
<code>{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;'Hangup&nbsp;(SIGHUP)&nbsp;signal&nbsp;recieved'</code><br>
<code>}</code><br>
<code>&nbsp;</code><br>
<code>trap&nbsp;on_hangup&nbsp;SIGHUP</code><br>
<code>&nbsp;</code><br>
<code>while&nbsp;true&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;sleep&nbsp;1</code><br>
<code>done</code><br>
<code>&nbsp;</code><br>
<code>exit&nbsp;0</code><br>
</FONT></TD></TR></TABLE><P>
Run the above script and then send the process ID the <TT>
<FONT COLOR="#0000ff">-HUP</FONT></TT>
signal to test it. (See Section <A HREF="node12.html#sec:killingproc">9.5</A>.)

<P>
An important function of a program is to clean up
after itself on exit. The special signal <TT>
<FONT COLOR="#0000ff">EXIT</FONT></TT> (not
really a signal) executes code on exit of the script:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>#!/bin/sh</code><br>
<code>&nbsp;</code><br>
<code>function&nbsp;on_exit&nbsp;()</code><br>
<code>{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;'I&nbsp;should&nbsp;remove&nbsp;temp&nbsp;files&nbsp;now'</code><br>
<code>}</code><br>
<code>&nbsp;</code><br>
<code>trap&nbsp;on_exit&nbsp;EXIT</code><br>
<code>&nbsp;</code><br>
<code>while&nbsp;true&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;sleep&nbsp;1</code><br>
<code>done</code><br>
<code>&nbsp;</code><br>
<code>exit&nbsp;0</code><br>
</FONT></TD></TR></TABLE><P>
Breaking the above program will cause it to print its
own epitaph.

<P>
If <TT>
<FONT COLOR="#0000ff">-</FONT></TT> is given instead of a function name, then the signal
is unbound (i.e., set to its default value).

<P>

<H1><A NAME="SECTION002360000000000000000">
20.6 Internal Settings -- the <TT>
<FONT COLOR="#0000ff">set</FONT></TT> Command</A>
</H1>

<P>
<A NAME="sec:setbashbuiltin"></A>
<P>
The <TT>
<FONT COLOR="#0000ff">set</FONT></TT> command can modify certain behavioral
settings of the shell. Your current options can be displayed
with <TT>
<FONT COLOR="#0000ff">echo&nbsp;$-</FONT></TT>. Various <TT>
<FONT COLOR="#0000ff">set</FONT></TT> commands are
usually entered at the top of a script or given as command-line
options to <TT>
<FONT COLOR="#0000ff">bash</FONT></TT>. Using
<TT>
<FONT COLOR="#0000ff">set&nbsp;+</FONT></TT><I>option</I> instead of <TT>
<FONT COLOR="#0000ff">set&nbsp;-</FONT></TT><I>option</I>
disables the option. Here are a few examples:
<DL>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -e</FONT></TT></STRONG></DT>
<DD>Exit immediately if any simple command gives an error.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -h</FONT></TT></STRONG></DT>
<DD>Cache the location of commands in your <TT>
<FONT COLOR="#0000ff">PATH</FONT></TT>.
The shell will become confused if binaries are suddenly inserted into the directories
of your <TT>
<FONT COLOR="#0000ff">PATH</FONT></TT>, perhaps causing a <TT>
<FONT COLOR="#0000ff">No such file or directory</FONT></TT> error.
In this case, disable this option or restart your shell. This option is
enabled by default.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -n</FONT></TT></STRONG></DT>
<DD>Read commands without executing them. This command is useful
for syntax checking.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -o posix</FONT></TT></STRONG></DT>
<DD>Comply exactly with the POSIX 1003.2 standard.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -u</FONT></TT></STRONG></DT>
<DD>Report an error when trying to reference a variable that
is unset. Usually <TT>
<FONT COLOR="#0000ff">bash</FONT></TT> just fills in an empty string.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -v</FONT></TT></STRONG></DT>
<DD>Print each line of script as it is executed.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -x</FONT></TT></STRONG></DT>
<DD>Display each command expansion as it is executed.
</DD>
<DT><STRONG><TT>
<FONT COLOR="#0000ff">set -C</FONT></TT></STRONG></DT>
<DD>Do not overwrite existing files when using <TT>
<FONT COLOR="#0000ff">&#62;</FONT></TT>.
You can use <TT>
<FONT COLOR="#0000ff">&#62;&#124;</FONT></TT> to force overwriting.
</DD>
</DL>

<P>

<H1><A NAME="SECTION002370000000000000000">
20.7 Useful Scripts and Commands</A>
</H1>

<P>
Here is a collection of useful utility scripts that people
are always asking for on the mailing lists. See page
<A HREF="node47.html#page:knownrisksscripts"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A> for several security check
scripts.

<P>

<H2><A NAME="SECTION002371000000000000000">
20.7.1 <TT>
<FONT COLOR="#0000ff">chroot</FONT></TT></A>
</H2>

<P>
The <TT>
<FONT COLOR="#0000ff">chroot</FONT></TT> command makes a process think that its root
file system is not actually <TT>
<FONT COLOR="#0000ff">/</FONT></TT>. For example, on one system
I have a complete Debian installation residing under a directory,
say, <TT>
<FONT COLOR="#0000ff">/mnt/debian</FONT></TT>. I can issue the command

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>chroot&nbsp;/mnt/debian&nbsp;bash&nbsp;-i</code><br>
</FONT></TD></TR></TABLE><P>
to run the <TT>
<FONT COLOR="#0000ff">bash</FONT></TT> shell interactively, under the root
file system <TT>
<FONT COLOR="#0000ff">/mnt/debian</FONT></TT>. This command will hence run the command
<TT>
<FONT COLOR="#0000ff">/mnt/debian/bin/bash&nbsp;-i</FONT></TT>. All further commands processed under
this shell will have no knowledge of the real root directory,
so I can use my Debian installation without having to reboot.
All further commands will effectively behave as though they are
inside a separate U<SMALL>NIX</SMALL> machine. One caveat: you may have to
remount your <TT>
<FONT COLOR="#0000ff">/proc</FONT></TT> file system inside your <TT>
<FONT COLOR="#0000ff">chroot</FONT></TT>'d
file system--see page <A HREF="node22.html#page:mountproc"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A>.<A NAME="page:useingchroot"></A>
<P>
This useful for improving security. Insecure network services
can change to a different root directory--any corruption will not
affect the real system.

<P>
Most rescue disks have a <TT>
<FONT COLOR="#0000ff">chroot</FONT></TT> command. After booting
the disk, you can manually mount the file systems on your hard drive,
and then issue a <TT>
<FONT COLOR="#0000ff">chroot</FONT></TT> to begin using your machine as usual.
Note that the command <TT>
<FONT COLOR="#0000ff">chroot&nbsp;&lt;new-root&gt;</FONT></TT> without arguments
invokes a shell by default.

<P>

<H2><A NAME="SECTION002372000000000000000">
20.7.2 <TT>
<FONT COLOR="#0000ff">if</FONT></TT> conditionals</A>
</H2>

<P>
The <TT>
<FONT COLOR="#0000ff">if&nbsp;test&nbsp;</FONT></TT><I>...</I> was used to control program flow
in Chapter <A HREF="node10.html#chap:shellscript">7</A>. Bash, however, has a built-in
alias for the <TT>
<FONT COLOR="#0000ff">test</FONT></TT> function: the left square brace, <TT>
<FONT COLOR="#0000ff">[</FONT></TT>.

<P>
Using <TT>
<FONT COLOR="#0000ff">[</FONT></TT> instead of <TT>
<FONT COLOR="#0000ff">test</FONT></TT> adds only elegance:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>if&nbsp;[&nbsp;5&nbsp;-le&nbsp;3&nbsp;]&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;'5&nbsp;&#060;&nbsp;3'</code><br>
<code>fi</code><br>
</FONT></TD></TR></TABLE><P>

<P>
It is important at this point to realize that the <TT>
<FONT COLOR="#0000ff">if</FONT></TT>
command understands nothing of arithmetic. It merely executes a command
<TT>
<FONT COLOR="#0000ff">test</FONT></TT> (or in this case <TT>
<FONT COLOR="#0000ff">[</FONT></TT>) and tests the exit code. If the
exit code is zero, then the command is considered to be successful and
<TT>
<FONT COLOR="#0000ff">if</FONT></TT> proceeds with the body of the <TT>
<FONT COLOR="#0000ff">if</FONT></TT> statement block. The
onus is on the  <TT>
<FONT COLOR="#0000ff">test</FONT></TT> command to properly evaluate the expression
given to it.

<P>
<TT>
<FONT COLOR="#0000ff">if</FONT></TT> can equally well be used with any command:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>if&nbsp;echo&nbsp;"$PATH"&nbsp;|&nbsp;grep&nbsp;-qwv&nbsp;/usr/local/bin&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;export&nbsp;PATH="$PATH:/usr/local/bin"</code><br>
<code>fi</code><br>
</FONT></TD></TR></TABLE><P>
conditionally adds <TT>
<FONT COLOR="#0000ff">/usr/local/bin</FONT></TT> if <TT>
<FONT COLOR="#0000ff">grep</FONT></TT>
does not find it in your <TT>
<FONT COLOR="#0000ff">PATH</FONT></TT>.

<P>

<H2><A NAME="SECTION002373000000000000000">
20.7.3 <TT>
<FONT COLOR="#0000ff">patch</FONT></TT>ing and <TT>
<FONT COLOR="#0000ff">diff</FONT></TT>ing</A>
</H2>

<P>
<A NAME="sec:applyingpatches"></A>
<P>
You may often want to find the differences between two files, for example to
see what changes have been made to a file between versions. Or, when a large
batch of source code may have been updated, it is silly to download the
entire directory tree if there have been only a few small changes. You
would want a list of alterations instead.

<P>
The <TT>
<FONT COLOR="#0000ff">diff</FONT></TT> utility dumps the lines that differ between two files. It can
be used as follows:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>diff&nbsp;-u&nbsp;&#060;old-file&#062;&nbsp;&#060;new-file&#062;</code><br>
</FONT></TD></TR></TABLE><P>
You can also use <TT>
<FONT COLOR="#0000ff">diff</FONT></TT> to see difference netween two directory trees.
<TT>
<FONT COLOR="#0000ff">diff</FONT></TT> recursively compares all corresponding files:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>diff&nbsp;-u&nbsp;--recursive&nbsp;--new-file&nbsp;&#060;old-dir&#062;&nbsp;&#060;new-dir&#062;&nbsp;&#062;&nbsp;&#060;patch-file&#062;.diff</code><br>
</FONT></TD></TR></TABLE><P>
The output is known as a <I>patch file</I> against a directory tree, that
can be used both to see changes, and to bring <TT>
<FONT COLOR="#0000ff">&lt;old-dir&gt;</FONT></TT> up to date
with <TT>
<FONT COLOR="#0000ff">&lt;new-dir&gt;</FONT></TT>.

<P>
Patch files may also end in <TT>
<FONT COLOR="#0000ff">.patch</FONT></TT> and are often <TT>
<FONT COLOR="#0000ff">gzip</FONT></TT>ped.
The patch file can be applied to <TT>
<FONT COLOR="#0000ff">&lt;old-dir&gt;</FONT></TT> with

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>cd&nbsp;&#060;old-dir&#062;</code><br>
<code>patch&nbsp;-p1&nbsp;-s&nbsp;&#060;&nbsp;&#060;patch-file&#062;.diff</code><br>
</FONT></TD></TR></TABLE><P>
which makes <TT>
<FONT COLOR="#0000ff">&lt;old-dir&gt;</FONT></TT> identical to <TT>
<FONT COLOR="#0000ff">&lt;new-dir&gt;</FONT></TT>. The <TT>
<FONT COLOR="#0000ff">-p1</FONT></TT>
option strips the leading directory name from the patch file. The presence of a leading
directory name in the patch file often confuses the <TT>
<FONT COLOR="#0000ff">patch</FONT></TT> command.

<P>

<H2><A NAME="SECTION002374000000000000000">
20.7.4 Internet connectivity test</A>
</H2>

<P>
<A NAME="sec:internconntest"></A>
<P>
You may want to leave this example until you have covered
more networking theory.

<P>
The acid test for an Internet connection is a successful
DNS query. You can use <TT>
<FONT COLOR="#0000ff">ping</FONT></TT> to test whether a server
is up, but some networks filter ICMP messages and <TT>
<FONT COLOR="#0000ff">ping</FONT></TT> does
not check that your DNS is working. <TT>
<FONT COLOR="#0000ff">dig</FONT></TT> sends a
single UDP packet similar to <TT>
<FONT COLOR="#0000ff">ping</FONT></TT>. Unfortunately, it takes
rather long to time out, so we fudge in a <TT>
<FONT COLOR="#0000ff">kill</FONT></TT> after
2 seconds.

<P>
This script blocks until it successfully queries a remote name server.
Typically, the next few lines of following script would run
<TT>
<FONT COLOR="#0000ff">fetchmail</FONT></TT> and a mail server
queue flush, or possibly <TT>
<FONT COLOR="#0000ff">uucico</FONT></TT>.
Do set the name server IP to something appropriate like that of your
local ISP; and increase the 2 second time out if your name server
typically takes longer to respond.

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>MY_DNS_SERVER=197.22.201.154</code><br>
<code>&nbsp;</code><br>
<code>while&nbsp;true&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;(</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dig&nbsp;@$MY_DNS_SERVER&nbsp;netscape.com&nbsp;IN&nbsp;A&nbsp;&#038;</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIG_PID=$!</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;sleep&nbsp;2&nbsp;&#059;&nbsp;kill&nbsp;$DIG_PID&nbsp;&#059;&nbsp;}&nbsp;&#038;</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep&nbsp;1</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wait&nbsp;$DIG_PID</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;2&#062;/dev/null&nbsp;|&nbsp;grep&nbsp;-q&nbsp;'^[^&#059;]*netscape.com'&nbsp;&#038;&#038;&nbsp;break</code><br>
<code>done</code><br>
</FONT></TD></TR></TABLE><P>

<P>

<H2><A NAME="SECTION002375000000000000000">
20.7.5 Recursive <TT>
<FONT COLOR="#0000ff">grep</FONT></TT> (search)</A>
</H2>

<P>
<A NAME="sec:recursivegrepxargs"></A>
<P>
Recursively searching through a directory tree can be done easily
with the <TT>
<FONT COLOR="#0000ff">find</FONT></TT> and <TT>
<FONT COLOR="#0000ff">xargs</FONT></TT> commands. You should consult
both these man pages. The following command pipe searches through
the kernel source for anything about the ``pcnet'' Ethernet card,
printing also the line number:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>find&nbsp;/usr/src/linux&nbsp;-follow&nbsp;-type&nbsp;f&nbsp;|&nbsp;xargs&nbsp;grep&nbsp;-iHn&nbsp;pcnet</code><br>
</FONT></TD></TR></TABLE><P>
(You will notice how this command returns rather a lot of data. However,
going through it carefully can be quite instructive.)

<P>
Limiting a search to a certain file extension is just another common
use of this pipe sequence.

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>find&nbsp;/usr/src/linux&nbsp;-follow&nbsp;-type&nbsp;f&nbsp;-name&nbsp;'*.[ch]'&nbsp;|&nbsp;xargs&nbsp;grep&nbsp;-iHn&nbsp;pcnet</code><br>
</FONT></TD></TR></TABLE><P>

<P>
Note that new versions of <TT>
<FONT COLOR="#0000ff">grep</FONT></TT> also have a <TT>
<FONT COLOR="#0000ff">-r</FONT></TT>
option to recursively search through directories.

<P>

<H2><A NAME="SECTION002376000000000000000">
20.7.6 Recursive search and replace</A>
</H2>

<P>
Often you will want to perform a search-and-replace throughout all the files
in an entire source tree. A typical example is the changing of a function call name
throughout lots of <B>C</B> source. The following script is a must
for any <TT>
<FONT COLOR="#0000ff">/usr/local/bin/</FONT></TT>. Notice the way it recursively
calls itself.

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>15</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>20</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>25</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>30</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>35</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>40</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>#!/bin/sh</code><br>
<code>&nbsp;</code><br>
<code>N=`basename&nbsp;$0`</code><br>
<code>&nbsp;</code><br>
<code>if&nbsp;[&nbsp;"$1"&nbsp;=&nbsp;"-v"&nbsp;]&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;VERBOSE="-v"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;shift</code><br>
<code>fi</code><br>
<code>&nbsp;</code><br>
<code>if&nbsp;[&nbsp;"$3"&nbsp;=&nbsp;""&nbsp;-o&nbsp;"$1"&nbsp;=&nbsp;"-h"&nbsp;-o&nbsp;"$1"&nbsp;=&nbsp;"--help"&nbsp;]&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"$N:&nbsp;Usage"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$N&nbsp;[-h|--help]&nbsp;[-v]&nbsp;&#060;regexp-search&#062;&nbsp;\</code><br>
<code>&#060;regexp-replace&#062;&nbsp;&#060;glob-file&#062;"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;0</code><br>
<code>fi</code><br>
<code>&nbsp;</code><br>
<code>S="$1"&nbsp;&#059;&nbsp;shift&nbsp;&#059;&nbsp;R="$1"&nbsp;&#059;&nbsp;shift</code><br>
<code>T=$$replc</code><br>
<code>&nbsp;</code><br>
<code>if&nbsp;echo&nbsp;"$1"&nbsp;|&nbsp;grep&nbsp;-q&nbsp;/&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;"$@"&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SEARCH=`echo&nbsp;"$S"&nbsp;|&nbsp;sed&nbsp;'s,/,\\\\/,g'`</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REPLACE=`echo&nbsp;"$R"&nbsp;|&nbsp;sed&nbsp;'s,/,\\\\/,g'`</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cat&nbsp;$i&nbsp;|&nbsp;sed&nbsp;"s/$SEARCH/$REPLACE/g"&nbsp;&#062;&nbsp;$T</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D="$?"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;[&nbsp;"$D"&nbsp;=&nbsp;"0"&nbsp;]&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;diff&nbsp;-q&nbsp;$T&nbsp;$i&nbsp;&#062;/dev/null&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;[&nbsp;"$VERBOSE"&nbsp;=&nbsp;"-v"&nbsp;]&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$i</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fi</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cat&nbsp;$T&nbsp;&#062;&nbsp;$i</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fi</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm&nbsp;-f&nbsp;$T</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fi</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;done</code><br>
<code>else</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;find&nbsp;.&nbsp;-type&nbsp;f&nbsp;-name&nbsp;"$1"&nbsp;|&nbsp;xargs&nbsp;$0&nbsp;$VERBOSE&nbsp;"$S"&nbsp;"$R"</code><br>
<code>fi</code><br>
</FONT></TD></TR></TABLE><P>

<P>

<H2><A NAME="SECTION002377000000000000000">
20.7.7 <TT>
<FONT COLOR="#0000ff">cut</FONT></TT> and <TT>
<FONT COLOR="#0000ff">awk</FONT></TT> -- manipulating text file fields</A>
</H2>

<P>
The <TT>
<FONT COLOR="#0000ff">cut</FONT></TT> command is useful for slicing files into fields; try

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>cut&nbsp;-d:&nbsp;-f1&nbsp;/etc/passwd</code><br>
<code>cat&nbsp;/etc/passwd&nbsp;|&nbsp;cut&nbsp;-d:&nbsp;-f1</code><br>
</FONT></TD></TR></TABLE><P>
The <TT>
<FONT COLOR="#0000ff">awk</FONT></TT> program is an interpreter for a complete programming language
call AWK. A common use for <TT>
<FONT COLOR="#0000ff">awk</FONT></TT> is in field stripping. It is slightly more
flexible than <TT>
<FONT COLOR="#0000ff">cut</FONT></TT>--

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>cat&nbsp;/etc/passwd&nbsp;|&nbsp;awk&nbsp;-F&nbsp;:&nbsp;'{print&nbsp;$1}'</code><br>
</FONT></TD></TR></TABLE><P>
--especially where whitespace gets in the way,

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>ls&nbsp;-al&nbsp;|&nbsp;awk&nbsp;'{print&nbsp;$6&nbsp;"&nbsp;"&nbsp;$7&nbsp;"&nbsp;"&nbsp;$8}'</code><br>
<code>ls&nbsp;-al&nbsp;|&nbsp;awk&nbsp;'{print&nbsp;$5&nbsp;"&nbsp;bytes"}'</code><br>
</FONT></TD></TR></TABLE><P>
which isolates the time and size of the file respectively.

<P>
Get your nonlocal IP addresses with:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>ifconfig&nbsp;|&nbsp;grep&nbsp;'inet&nbsp;addr:'&nbsp;|&nbsp;fgrep&nbsp;-v&nbsp;'127.0.0.'&nbsp;|&nbsp;\</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cut&nbsp;-d:&nbsp;-f2&nbsp;|&nbsp;cut&nbsp;-d'&nbsp;'&nbsp;-f1</code><br>
</FONT></TD></TR></TABLE><P>

<P>
Reverse an IP address with:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>echo&nbsp;192.168.3.2&nbsp;|&nbsp;awk&nbsp;-F&nbsp;.&nbsp;'{print&nbsp;$4&nbsp;"."&nbsp;$3&nbsp;"."&nbsp;$2&nbsp;"."&nbsp;$1&nbsp;}'</code><br>
</FONT></TD></TR></TABLE><P>

<P>
Print all common user names (i.e., users with UID values greater than 499 on RedHat and greater
than 999 on Debian):

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>awk&nbsp;-F:&nbsp;'$3&nbsp;&#062;=&nbsp;500&nbsp;{print&nbsp;$1}'&nbsp;/etc/passwd</code><br>
<code>(&nbsp;awk&nbsp;-F:&nbsp;'$3&nbsp;&#062;=&nbsp;1000&nbsp;{print&nbsp;$1}'&nbsp;/etc/passwd&nbsp;)</code><br>
</FONT></TD></TR></TABLE><P>

<P>

<H2><A NAME="SECTION002378000000000000000">
20.7.8 Calculations with <TT>
<FONT COLOR="#0000ff">bc</FONT></TT></A>
</H2>

<P>
Scripts can easily use <TT>
<FONT COLOR="#0000ff">bc</FONT></TT> to do calculations that <TT>
<FONT COLOR="#0000ff">expr</FONT></TT>
can't handle. For example, convert to decimal with

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>echo&nbsp;-e&nbsp;'ibase=16&#059;FFFF'&nbsp;|&nbsp;bc</code><br>
</FONT></TD></TR></TABLE><P>
to binary with

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>echo&nbsp;-e&nbsp;'obase=2&#059;12345'&nbsp;|&nbsp;bc</code><br>
</FONT></TD></TR></TABLE><P>
or work out the SIN of 45 degrees with

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>pi=`echo&nbsp;"scale=10&#059;&nbsp;4*a(1)"&nbsp;|&nbsp;bc&nbsp;-l`</code><br>
<code>echo&nbsp;"scale=10&#059;&nbsp;s(45*$pi/180)"&nbsp;|&nbsp;bc&nbsp;-l</code><br>
</FONT></TD></TR></TABLE><P>

<P>

<H2><A NAME="SECTION002379000000000000000">
20.7.9 Conversion of graphics formats of many files</A>
</H2>

<P>
The <TT>
<FONT COLOR="#0000ff">convert</FONT></TT> program of the <I>ImageMagick</I> package is a command
many Windows users would love. It can easily be used to convert multiple
files from one format to another. Changing a file's extension can be done
with <TT>
<FONT COLOR="#0000ff">echo&nbsp;</FONT></TT><I>filename</I><TT>
<FONT COLOR="#0000ff"> &#124; sed&nbsp;-e&nbsp;'s/&#92;.</FONT></TT><I>old</I><TT>
<FONT COLOR="#0000ff">$/.</FONT></TT><I>new</I><TT>
<FONT COLOR="#0000ff">/'`</FONT></TT>.
The <TT>
<FONT COLOR="#0000ff">convert</FONT></TT> command does the rest:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>for&nbsp;i&nbsp;in&nbsp;*.pcx&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;CMD="convert&nbsp;-quality&nbsp;625&nbsp;$i&nbsp;`echo&nbsp;$i&nbsp;|&nbsp;sed&nbsp;-e&nbsp;'s/\.pcx$/.png/'`"</code><br>
<code>#&nbsp;Show&nbsp;the&nbsp;command-line&nbsp;to&nbsp;the&nbsp;user:</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$CMD</code><br>
<code>#&nbsp;Execute&nbsp;the&nbsp;command-line:</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;eval&nbsp;$CMD</code><br>
<code>done</code><br>
</FONT></TD></TR></TABLE><P>
Note that the search-and-replace expansion mechanism could also be used
to replace the extensions: <TT>
<FONT COLOR="#0000ff">$&#123;i/%.pcx/.png&#125;</FONT></TT> produces the
desired result.

<P>
Incidentally, the above nicely compresses high-resolution <TT>
<FONT COLOR="#0000ff">pcx</FONT></TT>
files--possibly the output of a scanning operation, or a L<SUP><SMALL>A</SMALL></SUP>T<SMALL>E</SMALL>X compilation
into PostScript rendered with GhostScript
(i.e. <TT>
<FONT COLOR="#0000ff">gs&nbsp;-sDEVICE=pcx256&nbsp;-sOutputFile='page%d.pcx'&nbsp;</FONT></TT><I>file</I>.ps).

<P>

<H2><A NAME="SECTION0023710000000000000000">
20.7.10 Securely erasing files</A>
</H2>

<P>
Removing a file with <TT>
<FONT COLOR="#0000ff">rm</FONT></TT> only unlinks the file name from the data.
The file blocks may still be on disk, and will only be reclaimed when the
file system reuses that data. To
erase a file proper, requires writing
random bytes into the disk blocks occupied by the file. The following
overwrites all the files in the current directory:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>for&nbsp;i&nbsp;in&nbsp;*&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;dd&nbsp;if=/dev/urandom&nbsp;&nbsp;&nbsp;&nbsp;\</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of="$i"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bs=1024&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count=`expr&nbsp;1&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;\</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\`stat&nbsp;"$i"&nbsp;|&nbsp;grep&nbsp;'Size:'&nbsp;|&nbsp;awk&nbsp;'{print&nbsp;$2}'\`&nbsp;&nbsp;\</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;1024`</code><br>
<code>done</code><br>
</FONT></TD></TR></TABLE><P>
You can then remove the files normally with <TT>
<FONT COLOR="#0000ff">rm</FONT></TT>.

<P>

<H2><A NAME="SECTION0023711000000000000000">
20.7.11 Persistent background processes</A>
</H2>

<P>
Consider trying to run a process, say, the <TT>
<FONT COLOR="#0000ff">rxvt</FONT></TT> terminal,
in the background. This can be done simply with:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>rxvt&nbsp;&#038;</code><br>
</FONT></TD></TR></TABLE><P>
However, <TT>
<FONT COLOR="#0000ff">rxvt</FONT></TT> still has its output connected
to the shell and is a child process of the shell. When a
login shell exits, it may take its child processes
with it. <TT>
<FONT COLOR="#0000ff">rxvt</FONT></TT> may also die of its own accord from
trying to read or write to a terminal that does not exist
without the parent shell. Now try:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>{&nbsp;rxvt&nbsp;&#062;/dev/null&nbsp;2&#062;&#038;1&nbsp;&#060;/dev/null&nbsp;&#038;&nbsp;}&nbsp;&#038;</code><br>
</FONT></TD></TR></TABLE><P>
This technique is known as <I>forking twice</I>, and
<I>redirecting the terminal to dev null</I>. The shell
can know about its child processes but not about the
its ``grand child'' processes. We have hence create a daemon process
proper with the above command.

<P>
Now, it is easy to create a daemon process that restarts itself
if it happens to die. Although such functionality is best
accomplished within <B>C</B> (which you will get a taste of
in Chapter <A HREF="node25.html#chap:trivintroc">22</A>), you can make do with:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>{&nbsp;{&nbsp;while&nbsp;true&nbsp;&#059;&nbsp;do&nbsp;rxvt&nbsp;&#059;&nbsp;done&nbsp;&#059;&nbsp;}&nbsp;&#062;/dev/null&nbsp;2&#062;&#038;1&nbsp;&#060;/dev/null&nbsp;&#038;&nbsp;}&nbsp;&#038;</code><br>
</FONT></TD></TR></TABLE><P>
You will notice the effects of all these tricks
with:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>ps&nbsp;awwwxf</code><br>
</FONT></TD></TR></TABLE><P>

<P>

<H2><A NAME="SECTION0023712000000000000000">
20.7.12 Processing the process list</A>
</H2>

<P>
The following command uses the custom format option of <TT>
<FONT COLOR="#0000ff">ps</FONT></TT>
to print every conceivable attribute of a process:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>ps&nbsp;-awwwxo&nbsp;%cpu,%mem,alarm,args,blocked,bsdstart,bsdtime,c,caught,cmd,comm,\</code><br>
<code>command,cputime,drs,dsiz,egid,egroup,eip,esp,etime,euid,euser,f,fgid,fgroup,\</code><br>
<code>flag,flags,fname,fsgid,fsgroup,fsuid,fsuser,fuid,fuser,gid,group,ignored,\</code><br>
<code>intpri,lim,longtname,lstart,m_drs,m_trs,maj_flt,majflt,min_flt,minflt,ni,\</code><br>
<code>nice,nwchan,opri,pagein,pcpu,pending,pgid,pgrp,pid,pmem,ppid,pri,rgid,rgroup,\</code><br>
<code>rss,rssize,rsz,ruid,ruser,s,sess,session,sgi_p,sgi_rss,sgid,sgroup,sid,sig,\</code><br>
<code>sig_block,sig_catch,sig_ignore,sig_pend,sigcatch,sigignore,sigmask,stackp,\</code><br>
<code>start,start_stack,start_time,stat,state,stime,suid,suser,svgid,svgroup,svuid,\</code><br>
<code>svuser,sz,time,timeout,tmout,tname,tpgid,trs,trss,tsiz,tt,tty,tty4,tty8,ucomm,\</code><br>
<code>uid,uid_hack,uname,user,vsize,vsz,wchan</code><br>
</FONT></TD></TR></TABLE><P>
The output is best piped to a file and viewed with a nonwrapping text editor.
More interestingly, the <TT>
<FONT COLOR="#0000ff">awk</FONT></TT> command can print the process ID of a process
with

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>ps&nbsp;awwx&nbsp;|&nbsp;grep&nbsp;-w&nbsp;'htt[p]d'&nbsp;|&nbsp;awk&nbsp;'{print&nbsp;$1}'</code><br>
</FONT></TD></TR></TABLE><P>
which prints all the processes having <TT>
<FONT COLOR="#0000ff">httpd</FONT></TT> in the command
name or command-line. This filter is useful for
killing <TT>
<FONT COLOR="#0000ff">netscape</FONT></TT> as follows:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>kill&nbsp;-9&nbsp;`ps&nbsp;awx&nbsp;|&nbsp;grep&nbsp;'netsc[a]pe'&nbsp;|&nbsp;awk&nbsp;'{print&nbsp;$1}'`</code><br>
</FONT></TD></TR></TABLE><P>
(Note that the <TT>
<FONT COLOR="#0000ff">[a]</FONT></TT> in the regular expression
prevents <TT>
<FONT COLOR="#0000ff">grep</FONT></TT> from
finding itself in the process list.)

<P>
Other useful <TT>
<FONT COLOR="#0000ff">ps</FONT></TT> variations are:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>ps&nbsp;awwxf</code><br>
<code>ps&nbsp;awwxl</code><br>
<code>ps&nbsp;awwxv</code><br>
<code>ps&nbsp;awwxu</code><br>
<code>ps&nbsp;awwxs</code><br>
</FONT></TD></TR></TABLE><P>
The <TT>
<FONT COLOR="#0000ff">f</FONT></TT> option is most useful for showing parent-child relationships.
It stands for <TT>
<FONT COLOR="#0000ff">f</FONT></TT>orest, and shows the full process tree. For example, here
I am running an <B>X</B> desktop with two windows:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>15</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>20</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>25</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>&nbsp;&nbsp;PID&nbsp;TTY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STAT&nbsp;&nbsp;&nbsp;TIME&nbsp;COMMAND</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:05&nbsp;init&nbsp;[5]</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:02&nbsp;[kflushd]</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:02&nbsp;[kupdate]</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;[kpiod]</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:01&nbsp;[kswapd]</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SW&#060;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;[mdrecoveryd]</code><br>
<code>&nbsp;&nbsp;262&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:02&nbsp;syslogd&nbsp;-m&nbsp;0</code><br>
<code>&nbsp;&nbsp;272&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;klogd</code><br>
<code>&nbsp;&nbsp;341&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;xinetd&nbsp;-reuse&nbsp;-pidfile&nbsp;/var/run/xinetd.pid</code><br>
<code>&nbsp;&nbsp;447&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;crond</code><br>
<code>&nbsp;&nbsp;480&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:02&nbsp;xfs&nbsp;-droppriv&nbsp;-daemon</code><br>
<code>&nbsp;&nbsp;506&nbsp;tty1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;/sbin/mingetty&nbsp;tty1</code><br>
<code>&nbsp;&nbsp;507&nbsp;tty2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;/sbin/mingetty&nbsp;tty2</code><br>
<code>&nbsp;&nbsp;508&nbsp;tty3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;/sbin/mingetty&nbsp;tty3</code><br>
<code>&nbsp;&nbsp;509&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;/usr/bin/gdm&nbsp;-nodaemon</code><br>
<code>&nbsp;&nbsp;514&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7:04&nbsp;&nbsp;_&nbsp;/etc/X11/X&nbsp;-auth&nbsp;/var/gdm/:0.Xauth&nbsp;:0</code><br>
<code>&nbsp;&nbsp;515&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;&nbsp;_&nbsp;/usr/bin/gdm&nbsp;-nodaemon</code><br>
<code>&nbsp;&nbsp;524&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;/opt/icewm/bin/icewm</code><br>
<code>&nbsp;&nbsp;748&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;rxvt&nbsp;-bg&nbsp;black&nbsp;-cr&nbsp;green&nbsp;-fg&nbsp;whi</code><br>
<code>&nbsp;&nbsp;749&nbsp;pts/0&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;_&nbsp;bash</code><br>
<code>&nbsp;5643&nbsp;pts/0&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;mc</code><br>
<code>&nbsp;5645&nbsp;pts/6&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;bash&nbsp;-rcfile&nbsp;.bashrc</code><br>
<code>25292&nbsp;pts/6&nbsp;&nbsp;&nbsp;&nbsp;R&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;ps&nbsp;awwxf</code><br>
<code>11780&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;/usr/lib/netscape/netscape-commu</code><br>
<code>11814&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;(dns&nbsp;helper)</code><br>
<code>15534&nbsp;pts/6&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:12&nbsp;cooledit&nbsp;-I&nbsp;/root/.cedit/projects/Rute</code><br>
<code>15535&nbsp;pts/6&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6:03&nbsp;&nbsp;_&nbsp;aspell&nbsp;-a&nbsp;-a</code><br>
</FONT></TD></TR></TABLE><P>
The  <TT>
<FONT COLOR="#0000ff">u</FONT></TT> option shows the useful <TT>
<FONT COLOR="#0000ff">u</FONT></TT>ser format,
and the others show <TT>
<FONT COLOR="#0000ff">v</FONT></TT>irtual memory, <TT>
<FONT COLOR="#0000ff">s</FONT></TT>ignal and
<TT>
<FONT COLOR="#0000ff">l</FONT></TT>ong format.

<P>

<H1><A NAME="SECTION002380000000000000000">
20.8 Shell Initialization</A>
</H1>

<P>
<A NAME="sec:shellinitializ"></A>
<P>
Here I will briefly discuss what
initialization takes place after
logging in and how to modify it.

<P>
The interactive shell invoked after <TT>
<FONT COLOR="#0000ff">login</FONT></TT> will be the shell specified
in the last field of the user's entry in the <TT>
<FONT COLOR="#0000ff">/etc/passwd</FONT></TT> file.
The <TT>
<FONT COLOR="#0000ff">login</FONT></TT> program will invoke the shell after authenticating the
user, placing a <TT>
<FONT COLOR="#0000ff">-</FONT></TT> in front of the the command name, which
indicates to the shell that it is a <I>login shell</I>, meaning that it
reads and execute several scripts to initialize the environment. In the
case of <TT>
<FONT COLOR="#0000ff">bash</FONT></TT>, the files it reads are: <TT>
<FONT COLOR="#0000ff">/etc/profile</FONT></TT>,
<TT>
<FONT COLOR="#0000ff">~/.bash_profile</FONT></TT>, 
<TT>
<FONT COLOR="#0000ff">~/.bash_login</FONT></TT> and
<TT>
<FONT COLOR="#0000ff">~/.profile</FONT></TT>, in
that order. In addition, an interactive shell that is not a login shell
also reads
<TT>
<FONT COLOR="#0000ff">~/.bashrc</FONT></TT>. Note that traditional <TT>
<FONT COLOR="#0000ff">sh</FONT></TT> shells only
read <TT>
<FONT COLOR="#0000ff">/etc/profile</FONT></TT> and <TT>
<FONT COLOR="#0000ff">~/.profile</FONT></TT>.

<P>

<H2><A NAME="SECTION002381000000000000000">
20.8.1 Customizing the <TT>
<FONT COLOR="#0000ff">PATH</FONT></TT> and <TT>
<FONT COLOR="#0000ff">LD_LIBRARY_PATH</FONT></TT></A>
</H2>

<P>
Administrators can customise things like the environment variables
by modifying these startup scripts. Consider the classic
case of an installation tree under <TT>
<FONT COLOR="#0000ff">/opt/</FONT></TT>. Often, a package like
<TT>
<FONT COLOR="#0000ff">/opt/staroffice/</FONT></TT> or <TT>
<FONT COLOR="#0000ff">/opt/oracle/</FONT></TT> will require the <TT>
<FONT COLOR="#0000ff">PATH</FONT></TT>
and <TT>
<FONT COLOR="#0000ff">LD_LIBRARY_PATH</FONT></TT> variables to be adjusted accordingly. In
the case of RedHat, a script,

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>15</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>20</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>for&nbsp;i&nbsp;in&nbsp;/opt/*/bin&nbsp;/usr/local/bin&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;-d&nbsp;$i&nbsp;||&nbsp;continue</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$PATH&nbsp;|&nbsp;grep&nbsp;-wq&nbsp;"$i"&nbsp;&#038;&#038;&nbsp;continue</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;PATH=$PATH:$i</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;export&nbsp;PATH</code><br>
<code>done</code><br>
<code>&nbsp;</code><br>
<code>if&nbsp;test&nbsp;`id&nbsp;-u`&nbsp;-eq&nbsp;0&nbsp;&#059;&nbsp;then</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;/opt/*/sbin&nbsp;/usr/local/sbin&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;-d&nbsp;$i&nbsp;||&nbsp;continue</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$PATH&nbsp;|&nbsp;grep&nbsp;-wq&nbsp;"$i"&nbsp;&#038;&#038;&nbsp;continue</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PATH=$PATH:$i</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;export&nbsp;PATH</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;done</code><br>
<code>fi</code><br>
<code>&nbsp;</code><br>
<code>for&nbsp;i&nbsp;in&nbsp;/opt/*/lib&nbsp;/usr/local/lib&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;-d&nbsp;$i&nbsp;||&nbsp;continue</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$LD_LIBRARY_PATH&nbsp;|&nbsp;grep&nbsp;-wq&nbsp;"$i"&nbsp;&#038;&#038;&nbsp;continue</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$i</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;export&nbsp;LD_LIBRARY_PATH</code><br>
<code>done</code><br>
</FONT></TD></TR></TABLE><P>
can be placed as <TT>
<FONT COLOR="#0000ff">/etc/profile.d/my_local.sh</FONT></TT> with
execute permissions. This will take care of anything installed
under <TT>
<FONT COLOR="#0000ff">/opt/</FONT></TT> or <TT>
<FONT COLOR="#0000ff">/usr/local/</FONT></TT>. For Debian, the script can be
inserted directly into <TT>
<FONT COLOR="#0000ff">/etc/profile</FONT></TT>.

<P>
Page <A HREF="node26.html#page:ldlibpathvar"><IMG  ALIGN="BOTTOM" BORDER="1" ALT="[*]" SRC="crossref.png"></A> of Section <A HREF="node26.html#page:ldlibpathvar">23.3</A>
contains details of exactly what <TT>
<FONT COLOR="#0000ff">LD_LIBRARY_PATH</FONT></TT> is.

<P>
(Unrelated, but you should also edit your <TT>
<FONT COLOR="#0000ff">/etc/man.config</FONT></TT> to
add <TT>
<FONT COLOR="#0000ff">man</FONT></TT> page paths that appear under all installation trees
under <TT>
<FONT COLOR="#0000ff">/opt/</FONT></TT>.)

<P>

<H1><A NAME="SECTION002390000000000000000">
20.9 File Locking</A>
</H1>

<P>
Often, one would like a process to have
<I>exclusive access</I> to a file. By this we mean that only one process can
access the file at any one time. Consider a mail folder: if two
processes were to write to the folder simultaneously, it could
become corrupted. We also sometimes want to ensure that a
program can never be run twice at the same time; this insurance
is another use for ``locking.''

<P>
In the case of a mail folder, if the file is being
written to, then <I>no</I> other process should try read it or
write to it: and we would like to create a <I>write lock</I> on
the file. However if the file is being read from, <I>no</I> other
process should try to write to it: and we would like to create a
<I>read lock</I> on the file. Write locks are sometimes called
<I>exclusive locks</I>; read locks are sometimes called
<I>shared locks</I>. Often, <I>exclusive locks</I> are preferred
for simplicity.

<P>
Locking can be implemented by simply creating a temporary file
to indicate to other processes to wait before trying some kind of
access. U<SMALL>NIX</SMALL> also has some more sophisticated builtin functions.

<P>

<H2><A NAME="SECTION002391000000000000000">
20.9.1 Locking a mailbox file</A>
</H2>

<P>
There are currently four methods of file locking. <FONT COLOR="#ffa500">[The
<TT>
<FONT COLOR="#0000ff">exim</FONT></TT> sources seem to indicate
thorough research in this area, so this is what I am going on.]</FONT>
<P>
<DL COMPACT>
<DT>1.</DT>
<DD>``dot lock'' file locking. Here, a temporary file
is created with the same name as the mail folder and the extension
<TT>
<FONT COLOR="#0000ff">.lock</FONT></TT> added. So long as this file exists, no program should
try to access the folder. This is an exclusive lock only. It is
easy to write a shell script to do this kind of file locking.
</DD>
<DT>2.</DT>
<DD>``MBX'' file locking. Similar to 1, but a temporary file
is created in <TT>
<FONT COLOR="#0000ff">/tmp</FONT></TT>. This is also an exclusive lock.
</DD>
<DT>3.</DT>
<DD><TT>
<FONT COLOR="#0000ff">fcntl</FONT></TT> locking. Databases require areas of a file
to be locked. <TT>
<FONT COLOR="#0000ff">fcntl</FONT></TT> is a system call to be used inside <B>C</B>
programs.
</DD>
<DT>4.</DT>
<DD><TT>
<FONT COLOR="#0000ff">flock</FONT></TT> file locking. Same as <TT>
<FONT COLOR="#0000ff">fcntl</FONT></TT>, but locks
whole files.
</DD>
</DL>

<P>
The following shell function does proper mailbox file locking.

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>15</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>20</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>25</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>30</code></font><code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>function&nbsp;my_lockfile&nbsp;()</code><br>
<code>{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEMPFILE="$1.$$"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOCKFILE="$1.lock"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$$&nbsp;&#062;&nbsp;$TEMPFILE&nbsp;2&#062;/dev/null&nbsp;||&nbsp;{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"You&nbsp;don't&nbsp;have&nbsp;permission&nbsp;to&nbsp;access&nbsp;`dirname&nbsp;$TEMPFILE`"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ln&nbsp;$TEMPFILE&nbsp;$LOCKFILE&nbsp;2&#062;/dev/null&nbsp;&#038;&#038;&nbsp;{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm&nbsp;-f&nbsp;$TEMPFILE</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STALE_PID=`&#060;&nbsp;$LOCKFILE`</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;"$STALE_PID"&nbsp;-gt&nbsp;"0"&nbsp;&#062;/dev/null&nbsp;||&nbsp;{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kill&nbsp;-0&nbsp;$STALE_PID&nbsp;2&#062;/dev/null&nbsp;&#038;&#038;&nbsp;{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm&nbsp;-f&nbsp;$TEMPFILE</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm&nbsp;$LOCKFILE&nbsp;2&#062;/dev/null&nbsp;&#038;&#038;&nbsp;{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"Removed&nbsp;stale&nbsp;lock&nbsp;file&nbsp;of&nbsp;process&nbsp;$STALE_PID"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ln&nbsp;$TEMPFILE&nbsp;$LOCKFILE&nbsp;2&#062;/dev/null&nbsp;&#038;&#038;&nbsp;{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm&nbsp;-f&nbsp;$TEMPFILE</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm&nbsp;-f&nbsp;$TEMPFILE</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1</code><br>
<code>}</code><br>
</FONT></TD></TR></TABLE><P>
(Note how instead of <TT>
<FONT COLOR="#0000ff">`cat $LOCKFILE`</FONT></TT>, we use
<TT>
<FONT COLOR="#0000ff">`&lt; $LOCKFILE`</FONT></TT>, which is faster.)

<P>
You can include the above function in scripts that need to lock
any kind file. Use the function as follows:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>10</code></font><code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>#&nbsp;wait&nbsp;for&nbsp;a&nbsp;lock</code><br>
<code>until&nbsp;my_lockfile&nbsp;/etc/passwd&nbsp;&#059;&nbsp;do</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep&nbsp;1</code><br>
<code>done</code><br>
<code>&nbsp;</code><br>
<code>#&nbsp;The&nbsp;body&nbsp;of&nbsp;the&nbsp;program&nbsp;might&nbsp;go&nbsp;here</code><br>
<code>#&nbsp;[...]</code><br>
<code>&nbsp;</code><br>
<code>#&nbsp;Then&nbsp;to&nbsp;remove&nbsp;the&nbsp;lock,</code><br>
<code>rm&nbsp;-f&nbsp;/etc/passwd.lock</code><br>
</FONT></TD></TR></TABLE><P>

<P>
This script is of academic interest only
but has a couple of interesting features. Note how
the <TT>
<FONT COLOR="#0000ff">ln</FONT></TT> function is used to ensure ``exclusivity.'' <TT>
<FONT COLOR="#0000ff">ln</FONT></TT>
is one of the few U<SMALL>NIX</SMALL> functions that is <I>atomic</I>,
meaning that only one link of the same name can exist, and its
creation excludes the possibility that another program would
think that it had successfully created the same link. One might
naively expect that the program

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<font size="-1"><code>5</code></font><code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>function&nbsp;my_lockfile&nbsp;()</code><br>
<code>{</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOCKFILE="$1.lock"</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;-e&nbsp;$LOCKFILE&nbsp;&#038;&#038;&nbsp;return&nbsp;1</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;touch&nbsp;$LOCKFILE</code><br>
<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0</code><br>
<code>}</code><br>
</FONT></TD></TR></TABLE><P>
is sufficient for file locking. However, consider if two programs,
running simultaneously, executed line 4 at the same time. <I>Both</I> would
think that the lock did not exist and proceed to line 5. Then both
would successfully create the lock file--not what you wanted.

<P>
The <TT>
<FONT COLOR="#0000ff">kill</FONT></TT> command is then useful for checking whether
a process is running. Sending the <TT>
<FONT COLOR="#0000ff">0</FONT></TT> signal does nothing to
the process, but the signal fails if the process does not exist. This
technique can be used to remove a lock of a process that died before
removing the lock itself: that is, a <I>stale</I> lock.

<P>

<H2><A NAME="SECTION002392000000000000000">
20.9.2 Locking over NFS</A>
</H2>

<P>
The preceding script does <I>not</I> work if your file system is
mounted over NFS (<I>network file system</I>--see
Chapter <A HREF="node31.html#chap:nfs">28</A>). This is obvious because the script relies on the
PID of the process, which is not visible across different
machines. Not so obvious is that the <TT>
<FONT COLOR="#0000ff">ln</FONT></TT> function does not
work exactly right over NFS--you need to <TT>
<FONT COLOR="#0000ff">stat</FONT></TT> the
file and actually check that the link count has increased to 2.

<P>
The commands <TT>
<FONT COLOR="#0000ff">lockfile</FONT></TT> (from the <TT>
<FONT COLOR="#0000ff">procmail</FONT></TT> package)
and <TT>
<FONT COLOR="#0000ff">mutt_dotlock</FONT></TT> (from the <TT>
<FONT COLOR="#0000ff">mutt</FONT></TT> email reader but
perhaps not distributed) do similar file locking. These commands,
however, but do not store the PID in the lock file. Hence it
is not possible to detect a stale lock file. For example, to search
your mailbox, you can run:

<P><TABLE nowrap="1" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD valign="top" class="source" width="2%"><FONT color=red>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
<code>&nbsp;</code><br>
</FONT></TD><TD valign="top" class="source" bgcolor="#FFE0C0"><FONT color=blue>
<code>lockfile&nbsp;/var/spool/mail/mary.lock</code><br>
<code>grep&nbsp;freddy&nbsp;/var/spool/mail/mary</code><br>
<code>rm&nbsp;-f&nbsp;/var/spool/mail/mary.lock</code><br>
</FONT></TD></TR></TABLE><P>
This sequence ensures that you are searching a clean mailbox
even if <TT>
<FONT COLOR="#0000ff">/var</FONT></TT> is a remote NFS share.

<P>

<H2><A NAME="SECTION002393000000000000000">
20.9.3 Directory versus file locking</A>
</H2>

<P>
File locking is a headache for the developer. The
problem with U<SMALL>NIX</SMALL> is that whereas we are intuitively thinking
about locking a <I>file</I>, what we really mean is locking a
<I>file name</I> within a directory. <I>File</I> locking
<I>per se</I> should only be used on perpetual files, such as
database files. For mailbox and <TT>
<FONT COLOR="#0000ff">passwd</FONT></TT> files we need
<I>directory locking</I> <FONT COLOR="#ffa500">[My own term.]</FONT>, meaning the
exclusive access of one process to a particular directory entry.
In my opinion, lack of such a feature is a serious deficiency in
U<SMALL>NIX</SMALL>, but because it will require kernel, NFS, and (possibly)
<B>C</B> library extensions, will probably not come into being any
time soon.

<P>

<H2><A NAME="SECTION002394000000000000000">
20.9.4 Locking inside <B>C</B> programs</A>
</H2>

<P>
This topic is certainly outside of the scope of this text, except
to say that you should consult the source code of reputable packages
rather than invent your own locking scheme.

<P>

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html2123"
  HREF="node24.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png"></A> 
<A NAME="tex2html2119"
  HREF="rute.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png"></A> 
<A NAME="tex2html2113"
  HREF="node22.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png"></A> 
<A NAME="tex2html2121"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html2124"
  HREF="node24.html">21. System Services and</A>
<B> Up:</B> <A NAME="tex2html2120"
  HREF="rute.html">rute</A>
<B> Previous:</B> <A NAME="tex2html2114"
  HREF="node22.html">19. Partitions, File Systems,</A>
 &nbsp <B>  <A NAME="tex2html2122"
  HREF="node1.html">Contents</A></B> 
<!--End of Navigation Panel-->

</BODY>
</HTML>
