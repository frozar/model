%!PS-Adobe-3.0
%%Creator: groff version 1.17
%%CreationDate: Tue Dec  4 10:54:36 2001
%%DocumentNeededResources: font Times-Bold
%%+ font Times-Roman
%%+ font Times-Italic
%%+ font Courier
%%DocumentSuppliedResources: file snapshot.eps
%%+ procset grops 1.17 0
%%Pages: 10
%%PageOrder: Ascend
%%Orientation: Portrait
%%EndComments
%%BeginProlog
%%BeginResource: procset grops 1.17 0
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/MF{
findfont
[5 2 roll
0 3 1 roll
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}bind def
/DA{
newpath arcn stroke
}bind def
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
/DL{
SN
moveto
SN
lineto stroke
}bind def
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
/FL{
currentgray exch setgray fill setgray
}bind def
/BL/fill load def
/LW/setlinewidth load def
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
}bind def
/PEND{
clear
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%IncludeResource: font Times-Bold
%%IncludeResource: font Times-Roman
%%IncludeResource: font Times-Italic
%%IncludeResource: font Courier
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Courier@0 ENC0/Courier RE/Times-Italic@0 ENC0/Times-Italic RE
/Times-Roman@0 ENC0/Times-Roman RE/Times-Bold@0 ENC0/Times-Bold RE
%%EndProlog
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 14/Times-Bold@0 SF(Running `)198.494 123 Q(`Fsck')-.882 E 3.5('i)
-.882 G 3.5(nt)-3.5 G(he Backgr)-3.5 E(ound)-.252 E/F1 12/Times-Roman@0
SF(Marshall Kirk McK)245.766 147 Q(usick)-.18 E/F2 12/Times-Italic@0 SF
-.24(Au)251.112 165 S(thor and Consultant).24 E/F3 12/Times-Bold@0 SF
(Abstract)283.674 207 Q/F4 10/Times-Roman@0 SF -.35(Tr)97 246.6 S
(aditionally).35 E 2.646(,r)-.65 G(eco)-2.646 E -.15(ve)-.15 G .146
(ry of a).15 F/F5 9/Times-Roman@0 SF(BSD)2.646 E F4 -.1(fa)2.646 G .146
(st \214lesystem after an uncontrolled system crash such as a po).1 F
.145(wer f)-.25 F .145(ailure or a)-.1 F .754
(system panic required the use of the \214lesystem checking program, `)
72 258.6 R(`fsck')-.74 E 3.255('. Because)-.74 F .755
(the \214lesystem cannot be used)3.255 F .299(while it is being check)72
270.6 R .299(ed by `)-.1 F(`fsck')-.74 E .299(', a lar)-.74 F .299
(ge serv)-.18 F .299(er may e)-.15 F .299
(xperience unacceptably long periods of una)-.15 F -.25(va)-.2 G .298
(ilability after).25 F 2.5(ac)72 282.6 S(rash.)-2.5 E .145
(Rather than write a ne)97 298.2 R 2.645(wv)-.25 G .145(ersion of `)
-2.795 F(`fsck')-.74 E 2.645('t)-.74 G .145(hat can run on an acti)
-2.645 F .445 -.15(ve \214)-.25 H .145(lesystem, I ha).15 F .446 -.15
(ve a)-.2 H .146(dded the ability to tak).15 F(e)-.1 E 2.683(as)72 310.2
S .183(napshot of a \214lesystem partition to create a quiescent \214le\
system on which a slightly modi\214ed v)-2.683 F .182
(ersion of the tradi-)-.15 F(tional `)72 322.2 Q(`fsck')-.74 E 2.5('c)
-.74 G(an run.)-2.5 E 2.983(Ak)97 337.8 S .783 -.15(ey f)-3.083 H .484
(eature of these snapshots is that the).15 F 2.984(yu)-.15 G .484
(sually require \214lesystem write acti)-2.984 F .484
(vity to be suspended for less)-.25 F .306(than one second.)72 349.8 R
.306
(The suspension time is independent of the size of the \214lesystem.)
5.306 F 1.906 -.8(To r)5.306 H .305(educe the number and types).8 F
1.101(of corruption,)72 361.8 R/F6 10/Times-Italic@0 SF 1.102
(soft updates)3.601 F F4 1.102(were added to ensure that the only \214l\
esystem inconsistencies are lost resources.)3.602 F -.4(Wi)6.102 G(th).4
E 1.559(these tw)72 373.8 R 4.059(oa)-.1 G 1.559(dditions it is no)
-4.059 F 4.059(wp)-.25 G 1.558(ossible to bring the system up immediate\
ly after a crash and then run checks to)-4.059 F
(reclaim the lost resources on the acti)72 385.8 Q .3 -.15(ve \214)-.25
H(lesystems.).15 E .283(Background `)97 401.4 R(`fsck')-.74 E 2.783('r)
-.74 G .284(uns by taking a snapshot and then running its traditional \
\214rst four passes to calculate the)-2.783 F .623
(correct bitmaps for the allocations in the \214lesystem snapshot.)72
413.4 R .622(From these bitmaps, `)5.622 F(`fsck')-.74 E 3.122<278c>-.74
G .622(nds an)-3.122 F 3.122(yl)-.15 G .622(ost resources)-3.122 F
(and in)72 425.4 Q -.2(vo)-.4 G -.1(ke).2 G 2.5(ss).1 G
(pecial system calls to reclaim them in the underlying acti)-2.5 E .3
-.15(ve \214)-.25 H(lesystem.).15 E/F7 10/Times-Bold@0 SF(1.)72 453 Q F3
(Backgr)5 E(ound and Intr)-.216 E(oduction)-.216 E F4 -.35(Tr)97 468.6 S
(aditionally).35 E 3.952(,r)-.65 G(eco)-3.952 E -.15(ve)-.15 G 1.452
(ry of the).15 F F5(BSD)3.953 E F4 -.1(fa)3.953 G 1.453(st \214lesys-).1
F 2.498(tem [McK)72 480.6 R 2.497
(usick, et al., 1996] after an uncontrolled)-.15 F .047
(system crash such as a po)72 492.6 R .047(wer f)-.25 F .047
(ailure or a system panic)-.1 F 2.332(required the use of the `)72 504.6
R(`fsck')-.74 E 4.831<278c>-.74 G 2.331(lesystem checking)-4.831 F 4.042
(program [McK)72 516.6 R 4.042(usick & K)-.15 F -2.1 -.25(ow a)-.35 H
4.042(lski, 1994].).25 F -.74(``)9.042 G(Fsck').74 E(')-.74 E -.1(wo)72
528.6 S 2.298(uld inspect all the \214lesystem metadata \(bitmaps,).1 F
1.665(inodes, and directories\) and correct an)72 540.6 R 4.165(yi)-.15
G(nconsisten-)-4.165 E 3.23(cies that were found.)72 552.6 R 3.23
(As the metadata comprises)8.23 F .4(about three to \214v)72 564.6 R 2.9
(ep)-.15 G .4(ercent of the disk space, checking)-2.9 F 2.637(al)72
576.6 S(ar)-2.637 E .137(ge \214lesystem can tak)-.18 F 2.637(ea)-.1 G
2.637(nh)-2.637 G .136(our or longer)-2.637 F 5.136(.B)-.55 G(ecause)
-5.136 E .162(the \214lesystem is inaccessible while it is being check)
72 588.6 R(ed)-.1 E 1.732(by `)72 600.6 R(`fsck')-.74 E 1.732(', a lar)
-.74 F 1.731(ge serv)-.18 F 1.731(er may e)-.15 F 1.731
(xperience unaccept-)-.15 F(ably long periods of una)72 612.6 Q -.25(va)
-.2 G(ilability after a crash.).25 E(Man)97 628.2 Q 4.693(ym)-.15 G
2.193(ethods e)-4.693 F 2.193(xist for solving the metadata)-.15 F
(consistenc)72 640.2 Q 2.423(ya)-.15 G -.077(nd reco)-2.423 F -.15(ve)
-.15 G -.077(ry problem [Ganger et al, 2000;).15 F .54
(Seltzer et al, 2000].)72 652.2 R .54(The solution selected for the f)
5.331 F(ast)-.1 E 2.222(\214lesystem is)72 664.2 R F6 2.221
(soft updates)4.722 F F4 7.012(.S)C 2.221(oft updates control the)-7.012
F 3.464(ordering of \214lesystem updates such that the only)72 676.2 R
1.498(inconsistencies in the on-disk representation are that)72 688.2 R
.382(free blocks and inodes may be claimed as `)72 700.2 R .382
(`in use')-.74 F 2.882('i)-.74 G(n)-2.882 E -.209
(the on-disk bitmaps when the)72 712.2 R 2.291(ya)-.15 G -.209
(re really unused.)-2.291 F .98
(Soft updates eliminates the need to run `)346.6 453 R(`fsck')-.74 E(')
-.74 E .24(after a system crash e)321.6 465 R .24(xcept in the rare e)
-.15 F -.15(ve)-.25 G .24(nt of a hard-).15 F -.1(wa)321.6 477 S 3.648
(re f).1 F 3.647(ailure in the disk on which the \214lesystem)-.1 F
5.315(resides. Since)321.6 489 R 2.815
(the only \214lesystem inconsistenc)5.315 F 5.315(yi)-.15 G(s)-5.315 E
.099(lost blocks and inodes, the only ill ef)321.6 501 R .099
(fect from running)-.25 F 2.899
(on the \214lesystem after a crash is that part of the)321.6 513 R 1.12
(\214lesystem space that should ha)321.6 525 R 1.42 -.15(ve b)-.2 H 1.12
(een a).15 F -.25(va)-.2 G 1.12(ilable will).25 F .492(be lost.)321.6
537 R(An)5.492 E 2.992(yt)-.15 G .492
(ime the lost space from crashes reaches)-2.992 F 2.07
(an unacceptable le)321.6 549 R -.15(ve)-.25 G 2.07
(l, the \214lesystem must be tak).15 F(en)-.1 E(of)321.6 561 Q .974
(\215ine long enough to run `)-.25 F(`fsck')-.74 E 3.475('t)-.74 G 3.475
(or)-3.475 G .975(eclaim the lost)-3.475 F(resources.)321.6 573 Q .878
(Because man)346.6 588.6 R 3.377(ys)-.15 G(erv)-3.377 E .877
(er systems need to be a)-.15 F -.25(va)-.2 G(il-).25 E .64
(able 24x7, there is ne)321.6 600.6 R -.15(ve)-.25 G 3.14(ra).15 G 3.14
(na)-3.14 G -.25(va)-3.34 G .64(ilable multi-hour time).25 F 3.24
(when a traditional v)321.6 612.6 R 3.24(ersion of `)-.15 F(`fsck')-.74
E 5.74('c)-.74 G 3.24(an be run.)-5.74 F 1.452(Thus, I ha)321.6 624.6 R
1.752 -.15(ve b)-.2 H 1.452(een moti).15 F -.25(va)-.25 G 1.453
(ted to de).25 F -.15(ve)-.25 G 1.453(lop a \214lesystem).15 F .581
(check program that can run on an acti)321.6 636.6 R .881 -.15(ve \214)
-.25 H .581(lesystem to).15 F(reclaim the lost resources.)321.6 648.6 Q
.026(The \214rst approach that I considered w)346.6 664.2 R .027
(as to write)-.1 F 3.613(an)321.6 676.2 S 1.613 -.25(ew u)-3.613 H 1.112
(tility that w).25 F 1.112(ould operate on an acti)-.1 F 1.412 -.15
(ve \214)-.25 H(lesys-).15 E 1.644
(tem to identify the lost resources and reclaim them.)321.6 688.2 R
1.976(Such a utility w)321.6 700.2 R 1.976(ould f)-.1 F 1.975
(all into the class of real-time)-.1 F -.05(ga)321.6 712.2 S 5.868
(rbage collection.).05 F 5.868(Despite much research and)10.868 F EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 7.668(literature, g)72 84 R 7.668
(arbage collection of acti)-.05 F -.15(ve)-.25 G 7.668(ly used).15 F .48
(resources remains challenging to implement.)72 96 R .48(In addi-)5.48 F
.36(tion to the comple)72 108 R .36(xity of real-time g)-.15 F .36
(arbage collection,)-.05 F 1.933(the ne)72 120 R 4.433(wu)-.25 G 1.933
(tility w)-4.433 F 1.933(ould need to recreate much of the)-.1 F 1.042
(functionality of the e)72 132 R 1.041(xisting `)-.15 F(`fsck')-.74 E
3.541('u)-.74 G(tility)-3.541 E 6.041(.H)-.65 G -.2(av)-6.041 G 1.041
(ing a).2 F 1.975(second utility w)72 144 R 1.975
(ould lead to additional maintenance)-.1 F(comple)72 156 Q .277
(xity as b)-.15 F .276(ugs or feature additions w)-.2 F .276
(ould need to)-.1 F(be implemented in tw)72 168 Q 2.5(ou)-.1 G
(tilities rather than just one.)-2.5 E 2.026 -.8(To a)97 183.6 T -.2(vo)
.6 G .426(id the comple).2 F .427(xity and maintenance prob-)-.15 F .406
(lems, I decided to tak)72 195.6 R 2.906(ea)-.1 G 2.905(na)-2.906 G .405
(pproach that w)-2.905 F .405(ould enable)-.1 F(me to use most of the e)
72 207.6 Q(xisting `)-.15 E(`fsck')-.74 E 2.5('p)-.74 G(rogram.)-2.5 E
-.74(``)97 223.2 S(Fsck').74 E 3.08('r)-.74 G .58
(uns on the assumption that the \214lesys-)-3.08 F 1.575
(tem it is checking is quiescent.)72 235.2 R 3.174 -.8(To c)6.574 H
1.574(reate an appar).8 F(-)-.2 E .144
(ently quiescent \214lesystem, I added the ability to tak)72 247.2 R
2.645(ea)-.1 G/F1 10/Times-Italic@0 SF(snapshot)72 259.2 Q F0 4.667
(of a \214lesystem partition [McK)7.167 F 4.666(usick &)-.15 F(Ganger)72
271.2 Q 3.25(,1)-.4 G 3.25(999]. Using)-3.25 F(cop)3.25 E .75
(y-on-write, a snapshot pro-)-.1 F 1.029
(vides a \214lesystem image frozen at a speci\214c point in)72 283.2 R
4.02(time. The)72 295.2 R(ne)4.02 E 1.52
(xt section describes the details on ho)-.15 F(w)-.25 E
(snapshots are tak)72 307.2 Q(en and managed.)-.1 E 2.32
(As lost resources will not be used until the)97 322.8 R(y)-.15 E(ha)72
334.8 Q 1.721 -.15(ve b)-.2 H 1.421(een found and mark).15 F 1.421
(ed as free in the bitmaps,)-.1 F -.052(there are no limits on ho)72
346.8 R 2.448(wl)-.25 G -.053(ong a background reclama-)-2.448 F -.067
(tion scheme can tak)72 358.8 R 2.433(et)-.1 G 2.433<6f8c>-2.433 G -.067
(nd and reco)-2.433 F -.15(ve)-.15 G 2.433(rt).15 G 2.224(hem. Thus,)
-2.433 F(I)2.433 E .735(can run the traditional `)72 370.8 R(`fsck')-.74
E 3.234('o)-.74 G -.15(ve)-3.384 G 3.234(ras).15 G .734
(napshot to \214nd)-3.234 F .451(all the missing resources e)72 382.8 R
-.15(ve)-.25 G 2.951(ni).15 G 2.951(fi)-2.951 G 2.951(tt)-2.951 G(ak)
-2.951 E .451(es se)-.1 F -.15(ve)-.25 G .452(ral hours).15 F -.209
(and the \214lesystem is being acti)72 394.8 R -.15(ve)-.25 G -.209
(ly changed.).15 F 1.427(Snapshots may seem a more comple)97 410.4 R
3.926(xs)-.15 G(olution)-3.926 E 2.096
(to the problem of running space reclamation on an)72 422.4 R(acti)72
434.4 Q 6.234 -.15(ve \214)-.25 H 5.933
(lesystem than a more straight forw).15 F(ard)-.1 E -.05(ga)72 446.4 S
1.038(rbage-collection utility).05 F 6.038(.H)-.65 G -.25(ow)-6.038 G
-2.15 -.25(ev e).25 H 1.838 -.4(r, t).25 H 1.038(heir cost \(about).4 F
.57(1300 lines of code\) is amortized o)72 458.4 R -.15(ve)-.15 G 3.07
(rt).15 G .57(he other useful)-3.07 F .06
(functionality: the ability to do reliable dumps of acti)72 470.4 R -.15
(ve)-.25 G .863(\214lesystems and the ability to pro)72 482.4 R .862
(vide back-ups of the)-.15 F .628(\214lesystem at se)72 494.4 R -.15(ve)
-.25 G .629(ral times during the day).15 F 5.629(.T)-.65 G .629
(his func-)-5.629 F .975(tionality w)72 506.4 R .975
(as \214rst popularized by Netw)-.1 F .975(ork Appliance)-.1 F
([Hitz et al, 1994; Hutchinson et al, 1999].)72 518.4 Q .031
(Snapshots enable the safe backup of li)97 534 R .332 -.15(ve \214)-.25
H(lesys-).15 E 4.155(tems. When)72 546 R/F2 10/Times-Bold@0 SF(dump)
4.155 E F0 1.654(notices that it is being ask)4.155 F 1.654(ed to)-.1 F
.143(dump a mounted \214lesystem, it can simply tak)72 558 R 2.644(eas)
-.1 G(nap-)-2.644 E 3.52(shot of the \214lesystem and run o)72 570 R
-.15(ve)-.15 G 6.02(rt).15 G 3.52(he snapshot)-6.02 F 1.24
(instead of on the li)72 582 R 1.54 -.15(ve \214)-.25 H 3.74
(lesystem. When).15 F F2(dump)3.74 E F0(com-)3.74 E
(pletes, it releases the snapshot.)72 594 Q 2.147
(Periodic snapshots can be made accessible to)97 609.6 R 4.252
(users. When)72 621.6 R(tak)4.252 E 1.752(en e)-.1 F -.15(ve)-.25 G
1.752(ry fe).15 F 4.253(wh)-.25 G 1.753(ours during the day)-4.253 F(,)
-.65 E(the)72 633.6 Q 3.242(ya)-.15 G(llo)-3.242 E 3.242(wu)-.25 G .742
(sers to retrie)-3.242 F 1.042 -.15(ve a \214)-.25 H .742(le that the)
.15 F 3.242(yw)-.15 G .742(rote se)-3.242 F(v-)-.25 E 1.999
(eral hours earlier and later deleted or o)72 645.6 R -.15(ve)-.15 G
1.999(rwrote by).15 F(mistak)72 657.6 Q 3.202(e. Snapshots)-.1 F .701
(are much more con)3.202 F -.15(ve)-.4 G .701(nient to use).15 F 1.28
(than dump tapes and can be created much more fre-)72 669.6 R(quently)72
681.6 Q(.)-.65 E 2.259 -.8(To m)97 697.2 T(ak).8 E 3.159(eas)-.1 G .658
(napshot accessible to users through)-3.159 F 3.519(at)72 709.2 S 1.019
(raditional \214lesystem interf)-3.519 F(ace,)-.1 E/F3 9/Times-Roman@0
SF(BSD)3.519 E F0 1.02(uses the mem-)3.519 F .778(ory-disk dri)72 721.2
R -.15(ve)-.25 G -.4(r,).15 G F1(md)3.677 E F0 5.777(.T)C(he)-5.777 E F2
(mdcon\214g)3.277 E F0 .777(command tak)3.277 F .777(es a)-.1 F .889
(snapshot \214le as input and produces a)321.6 84 R F2(/de)3.389 E
(v/md0)-.15 E F0(char)3.389 E(-)-.2 E(acter)321.6 96 Q(-de)-.2 E 3.564
(vice interf)-.25 F 3.563(ace to access it.)-.1 F(The)8.563 E F2(/de)
6.063 E(v/md0)-.15 E F0 .842(character de)321.6 108 R .842
(vice can then be used as the input de)-.25 F(vice)-.25 E .211
(for a standard)321.6 120 R F3 .21(BSD FFS)2.711 F F0 .21
(mount command, allo)2.71 F .21(wing the)-.25 F 1.279
(snapshot to appear as a replica of the frozen \214lesys-)321.6 132 R
2.078(tem at whate)321.6 144 R -.15(ve)-.25 G 4.578(rl).15 G 2.077
(ocation in the namespace that the)-4.578 F 1.358
(system administrator chooses to mount it.)321.6 156 R 1.359(Thus, the)
6.359 F(follo)321.6 168 Q .535
(wing script could be run at noon to create a mid-)-.25 F 1.213
(day backup of the)321.6 180 R F2(/usr)3.713 E F0 1.213
(\214lesystem and mak)3.713 F 3.714(ei)-.1 G 3.714(ta)-3.714 G -.25(va)
-3.914 G(il-).25 E(able at)321.6 192 Q F2(/backups/usr/noon)2.5 E F0(:)A
2.5(#T)357.6 210 S(ak)-3.3 E 2.5(et)-.1 G(he snapshot)-2.5 E
(mount -u -o snapshot /usr/snap.noon /usr)357.6 222 Q 2.5(#A)357.6 234 S
(ttach it to /de)-2.5 E(v/md0)-.25 E
(mdcon\214g -a -t vnode -u 0 -f /usr/snap.noon)357.6 246 Q 2.5(#M)357.6
258 S(ount it for user access)-2.5 E(mount -r /de)357.6 270 Q
(v/md0 /backups/usr/noon)-.25 E(When no longer needed, it can be remo)
321.6 291.6 Q -.15(ve)-.15 G 2.5(dw).15 G(ith:)-2.5 E 2.5(#U)357.6 309.6
S(nmount snapshot)-2.5 E(umount /backups/usr/noon)357.6 321.6 Q 2.5(#D)
357.6 333.6 S(etach it from /de)-2.5 E(v/md0)-.25 E(mdcon\214g -d -u 0)
357.6 345.6 Q 2.5(#D)357.6 357.6 S(elete the snapshot)-2.5 E
(rm -f /usr/snap.noon)357.6 369.6 Q F2(2.)321.6 399.6 Q/F4 12
/Times-Bold@0 SF(Cr)5 E(eating a Filesystem Snapshot)-.216 E 0 0 144 254
-174.614 308 358.8 592.214 PBEGIN
%%BeginDocument: snapshot.eps
%%Title: stdin
%%Creator: fig2dev Version 3.1 Patchlevel 2
%%CreationDate: Sat Apr 24 14:20:00 1999
%%For: mckusick@flamingo.McKusick.COM (Kirk McKusick,1614 Oxford St. Berkeley CA 94709-1608,510-843-9542,)
%%Magnification: 1.00
%%Orientation: Portrait
%%BoundingBox: 0 0 254 308
%%Pages: 0
%%BeginSetup
%%IncludeFeature: *PageSize Letter
%%EndSetup
%%EndComments
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-53.0 361.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawSplineSection {
	/y3 exch def
	/x3 exch def
	/y2 exch def
	/x2 exch def
	/y1 exch def
	/x1 exch def
	/xa x1 x2 x1 sub 0.666667 mul add def
	/ya y1 y2 y1 sub 0.666667 mul add def
	/xb x3 x2 x3 sub 0.666667 mul add def
	/yb y3 y2 y3 sub 0.666667 mul add def
	x1 y1 lineto
	xa ya xb yb x3 y3 curveto
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 792 m 0 0 l 612 0 l 612 792 l cp clip
 0.06000 0.06000 sc
/Times-Roman ff 240.00 scf sf
1515 1425 m
gs 1 -1 sc (Header) dup sw pop 2 div neg 0 rm  col-1 sh gr
7.500 slw
% Polyline
n 2700 5100 m 3900 5100 l gs col-1 s gr 
% Polyline
n 2700 4800 m 3900 4800 l gs col-1 s gr 
% Polyline
n 2700 4500 m 3900 4500 l gs col-1 s gr 
% Polyline
n 2700 4200 m 3900 4200 l gs col-1 s gr 
% Polyline
n 2700 3900 m 3900 3900 l gs col-1 s gr 
% Polyline
n 2700 3600 m 3900 3600 l gs col-1 s gr 
% Polyline
n 2700 3300 m 3900 3300 l gs col-1 s gr 
% Polyline
n 2700 3000 m 3900 3000 l gs col-1 s gr 
% Polyline
n 2700 2700 m 3900 2700 l 3900 6000 l 2700 6000 l cp gs col-1 s gr 
/Times-Bold ff 240.00 scf sf
3150 5700 m
gs 1 -1 sc (. . .) col-1 sh gr
% Polyline
n 900 3900 m 2100 3900 l gs col-1 s gr 
% Polyline
n 900 3600 m 2100 3600 l gs col-1 s gr 
% Polyline
n 900 3000 m 2100 3000 l gs col-1 s gr 
% Polyline
n 900 2700 m 2100 2700 l gs col-1 s gr 
% Polyline
n 900 2400 m 2100 2400 l gs col-1 s gr 
% Polyline
n 900 2100 m 2100 2100 l gs col-1 s gr 
% Polyline
n 900 1800 m 2100 1800 l gs col-1 s gr 
% Polyline
n 900 1500 m 2100 1500 l gs col-1 s gr 
% Polyline
n 900 900 m 2100 900 l 2100 4200 l 900 4200 l cp gs col-1 s gr 
% Polyline
n 900 3300 m 2100 3300 l gs col-1 s gr 
% Polyline
n 4500 3000 m 5100 3000 l 5100 3600 l 4500 3600 l cp gs col-1 s gr 
% Polyline
n 4500 4200 m 5100 4200 l 5100 4800 l 4500 4800 l cp gs col-1 s gr 
% Polyline
n 4500 5100 m 5100 5100 l 5100 5700 l 4500 5700 l cp gs col-1 s gr 
% Polyline
gs  clippath
4353 5220 m 4473 5250 l 4353 5280 l 4515 5280 l 4515 5220 l  cp clip
n 3900 5250 m 4500 5250 l gs col-1 s gr gr

% arrowhead
n 4353 5220 m 4473 5250 l 4353 5280 l  col-1 s
% Polyline
gs  clippath
4353 4320 m 4473 4350 l 4353 4380 l 4515 4380 l 4515 4320 l  cp clip
n 3900 4350 m 4500 4350 l gs col-1 s gr gr

% arrowhead
n 4353 4320 m 4473 4350 l 4353 4380 l  col-1 s
% Polyline
gs  clippath
4353 3120 m 4473 3150 l 4353 3180 l 4515 3180 l 4515 3120 l  cp clip
n 3900 3150 m 4500 3150 l gs col-1 s gr gr

% arrowhead
n 4353 3120 m 4473 3150 l 4353 3180 l  col-1 s
% Polyline
n 2700 1800 m 3300 1800 l 3300 2400 l 2700 2400 l cp gs col-1 s gr 
% Polyline
gs  clippath
2553 1920 m 2673 1950 l 2553 1980 l 2715 1980 l 2715 1920 l  cp clip
n 2100 1950 m 2700 1950 l gs col-1 s gr gr

% arrowhead
n 2553 1920 m 2673 1950 l 2553 1980 l  col-1 s
% Open spline
gs  clippath
2553 2820 m 2673 2850 l 2553 2880 l 2715 2880 l 2715 2820 l  cp clip
n 2100.0 3450.0 m 2212.5 3450.0 l
	2212.5 3450.0 2325.0 3450.0 2325.0 3450.0 DrawSplineSection
	2325.0 3450.0 2325.0 3450.0 2362.5 3412.5 DrawSplineSection
	2362.5 3412.5 2400.0 3375.0 2400.0 3300.0 DrawSplineSection
	2400.0 3300.0 2400.0 3225.0 2400.0 3112.5 DrawSplineSection
	2400.0 3112.5 2400.0 3000.0 2400.0 2962.5 DrawSplineSection
	2400.0 2962.5 2400.0 2925.0 2437.5 2887.5 DrawSplineSection
	2437.5 2887.5 2475.0 2850.0 2550.0 2850.0 DrawSplineSection
	2550.0 2850.0 2625.0 2850.0 2662.5 2850.0 DrawSplineSection
	2700.0 2850.0 l  gs col-1 s gr
 gr

% arrowhead
n 2553 2820 m 2673 2850 l 2553 2880 l  col-1 s
/Times-Roman ff 240.00 scf sf
1500 4110 m
gs 1 -1 sc (triple) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 3825 m
gs 1 -1 sc (double) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 3525 m
gs 1 -1 sc (single) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 1710 m
gs 1 -1 sc (not copied) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 2310 m
gs 1 -1 sc (not copied) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 2625 m
gs 1 -1 sc (not used) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 2925 m
gs 1 -1 sc (not used) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 3225 m
gs 1 -1 sc (not used) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
3300 2910 m
gs 1 -1 sc (not copied) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
3300 3510 m
gs 1 -1 sc (not copied) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
3300 3825 m
gs 1 -1 sc (not used) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
3300 4125 m
gs 1 -1 sc (not used) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
3300 4710 m
gs 1 -1 sc (not copied) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
3300 5010 m
gs 1 -1 sc (not copied) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Times-Roman ff 240.00 scf sf
1500 1125 m
gs 1 -1 sc (Inode) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
n 2700 5400 m 3900 5400 l gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
end PEND F2(Figur)356.63 610.214 Q 2.5(e1)-.18 G F0(:)-2.5 E F1
(Structur)2.5 E 2.5(eo)-.37 G 2.5(fas)-2.5 G(napshot \214le)-2.5 E F0
4.525<418c>346.6 634.214 S(lesystem)-4.525 E F1(snapshot)4.525 E F0
2.025(is a frozen image of a)4.525 F 1.931(\214lesystem at a gi)321.6
646.214 R -.15(ve)-.25 G 4.431(ni).15 G 1.932(nstant in time.)-4.431 F
(Implementing)6.932 E .732(snapshots in the)321.6 658.214 R F3(BSD)3.232
E F0 -.1(fa)3.232 G .732(st \214lesystem has pro).1 F -.15(ve)-.15 G
3.231(nt).15 G 3.231(ob)-3.231 G(e)-3.231 E(straightforw)321.6 670.214 Q
2.893(ard. T)-.1 F .393(aking a snapshot entails the follo)-.8 F(w-)-.25
E(ing steps:)321.6 682.214 Q 4.17(1\) A)321.6 697.814 R F1 .537
(snapshot \214le)3.037 F F0 .537(is created to track later changes to)
3.037 F 1.052(the \214lesystem; a snapshot \214le is sho)336.6 709.814 R
1.053(wn in Fig. 1.)-.25 F 1.397
(This snapshot \214le is initialized to the size of the)336.6 721.814 R
EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF(\214lesystem')87 84 Q 2.351(sp)-.55 G -.149
(artition, and its \214le block pointers are)-2.351 F(mark)87 96 Q .133
(ed as zero which means `)-.1 F .133(`not copied.)-.74 F 3.488 -.74
('' A)-.7 H(fe)3.373 E(w)-.25 E(strate)87 108 Q -.44
(gic blocks are allocated, such as those holding)-.15 F -.625
(copies of the superblock and c)87 120 R -.625(ylinder group maps.)-.15
F 4.17(2\) A)72 135.6 R .217(preliminary pass is made o)2.717 F -.15(ve)
-.15 G 2.717(re).15 G .216(ach of the c)-2.717 F(ylin-)-.15 E 1.621
(der groups to cop)87 147.6 R 4.121(yi)-.1 G 4.121(tt)-4.121 G 4.121(oi)
-4.121 G 1.622(ts preallocated backing)-4.121 F 5.909
(block. Additionally)87 159.6 R 5.909(,t)-.65 G 3.408
(he block bitmap in each)-5.909 F -.15(cy)87 171.6 S 3.56
(linder group is scanned to determine which).15 F .525(blocks are free.)
87 183.6 R -.15(Fo)5.525 G 3.025(re).15 G .524
(ach free block that is found,)-3.025 F 1.4
(the corresponding location in the snapshot \214le is)87 195.6 R(mark)87
207.6 Q 1.177(ed with a distinguished block number \(1\) to)-.1 F(sho)87
219.6 Q 4.354(wt)-.25 G 1.854(hat the block is `)-4.354 F 1.855
(`not used.)-.74 F 5.835 -.74('' T)-.7 H 1.855(here is no).74 F .688
(need to cop)87 231.6 R 3.188(yt)-.1 G .688(hose unused blocks if the)
-3.188 F 3.187(ya)-.15 G .687(re later)-3.187 F(allocated and written.)
87 243.6 Q 4.17(3\) The)72 259.2 R 3.281(\214lesystem is mark)5.781 F
3.281(ed as `)-.1 F(`w)-.74 E 3.282(anting to sus-)-.1 F(pend.)87 271.2
Q 4.433 -.74('' I)-.7 H 2.953(nt).74 G .452
(his state, processes that wish to in)-2.953 F -.2(vo)-.4 G -.1(ke).2 G
2.193(system calls that will modify the \214lesystem are)87 283.2 R
(block)87 295.2 Q 2.673(ed from running, while processes that are)-.1 F
1.22(already in progress on such system calls are per)87 307.2 R(-)-.2 E
.847(mitted to \214nish them.)87 319.2 R .847
(These actions are enforced)5.847 F .777(by inserting a g)87 331.2 R
.777(ate at the top of e)-.05 F -.15(ve)-.25 G .777(ry system call).15 F
1.899(that can write to a \214lesystem.)87 343.2 R 1.899(The set of g)
6.899 F(ated)-.05 E .376(system calls includes `)87 355.2 R(`write')-.74
E .377(', `)-.74 F(`open')-.74 E 2.877('\()-.74 G .377(when cre-)-2.877
F 1.425(ating or truncating\), `)87 367.2 R(`fhopen')-.74 E 3.925('\()
-.74 G 1.425(when creating or)-3.925 F 2.017(truncating\), `)87 379.2 R
(`mknod')-.74 E 2.017(', `)-.74 F(`mk\214fo')-.74 E 2.018(', `)-.74 F
(`link')-.74 E 2.018(', `)-.74 F(`sym-)-.74 E(link')87 391.2 Q 14.45
(', `)-.74 F(`unlink')-.74 E 14.45(', `)-.74 F(`ch\215ags')-.74 E 14.45
(', `)-.74 F(`fch\215ags')-.74 E(',)-.74 E -.74(``)87 403.2 S(chmod').74
E 8.12(', `)-.74 F(`lchmod')-.74 E 8.12(', `)-.74 F(`fchmod')-.74 E 8.12
(', `)-.74 F(`cho)-.74 E(wn')-.25 E(',)-.74 E -.74(``)87 415.2 S(lcho)
.74 E(wn')-.25 E 7.83(', `)-.74 F(`fcho)-.74 E(wn')-.25 E 7.83(', `)-.74
F(`utimes')-.74 E 7.83(', `)-.74 F(`lutimes')-.74 E(',)-.74 E -.74(``)87
427.2 S(futimes').74 E 3.786(', `)-.74 F(`truncate')-.74 E 3.787(', `)
-.74 F(`ftruncate')-.74 E 3.787(', `)-.74 F(`rename')-.74 E(',)-.74 E
-.74(``)87 439.2 S(mkdir').74 E .01(', `)-.74 F(`rmdir')-.74 E .01(', `)
-.74 F(`fsync')-.74 E .01(', `)-.74 F(`sync')-.74 E .01(', `)-.74 F
(`unmount')-.74 E(',)-.74 E -.74(``)87 451.2 S(undelete').74 E 3.66
(', `)-.74 F(`quotactl')-.74 E 3.66(', `)-.74 F(`re)-.74 E -.2(vo)-.25 G
-.1(ke).2 G -.74('').1 G 6.16(,a).74 G 3.66(nd `)-6.16 F(`e)-.74 E
(xtat-)-.15 E(trctl')87 463.2 Q 3.26('. In)-.74 F .76(addition g)3.26 F
.76(ates must be added to `)-.05 F(`page-)-.74 E(out')87 475.2 Q .731
(', `)-.74 F(`ktrace')-.74 E .732(', local domain sock)-.74 F .732
(et creation, and)-.1 F 4.235(core dump creation.)87 487.2 R 4.235
(The g)9.235 F 4.235(ate tracks acti)-.05 F(vity)-.25 E .806
(within a system call for each mounted \214lesystem.)87 499.2 R 3.668
(Ag)87 511.2 S 1.168(ate has tw)-3.718 F 3.668(op)-.1 G 3.668
(urposes. The)-3.668 F 1.167(\214rst is to suspend)3.668 F .865
(processes that w)87 523.2 R .865(ant to enter the g)-.1 F .865
(ated system call)-.05 F .766
(during periods that the \214lesystem that the process)87 535.2 R -.1
(wa)87 547.2 S 1.55(nts to modify is suspended.).1 F 1.55
(The second is to)6.55 F -.1(ke)87 559.2 S .057
(ep track of the number of processes that are run-).1 F .087
(ning inside the g)87 571.2 R .088(ated system call for each mounted)
-.05 F 3.118(\214lesystem. When)87 583.2 R 3.117(ap)3.117 G .617
(rocess enters a g)-3.117 F .617(ated system)-.05 F 3.45
(call, a counter in the mount structure for the)87 595.2 R .897
(\214lesystem that it w)87 607.2 R .897(ants to modify is incremented.)
-.1 F 1.947(When the process e)87 619.2 R 1.947(xits a g)-.15 F 1.948
(ated system call, the)-.05 F(counter is decremented.)87 631.2 Q 4.17
(4\) The)72 646.8 R(\214lesystem')3.395 E 3.395(ss)-.55 G .895
(tatus is changed from `)-3.395 F(`w)-.74 E(anting)-.1 E 2.908
(to suspend')87 658.8 R 5.408('t)-.74 G 5.408(o`)-5.408 G 2.908
(`fully suspended.)-6.148 F 6.889 -.74('' T)-.7 H 2.909(his status).74 F
1.527(change is done by allo)87 670.8 R 1.526(wing all system calls cur)
-.25 F(-)-.2 E .209
(rently writing to the \214lesystem being suspended to)87 682.8 R 6
(\214nish. The)87 694.8 R 3.5(transition to `)6 F 3.5(`fully suspended')
-.74 F 6('i)-.74 G(s)-6 E 3.905
(complete when the count of processes within)87 706.8 R -.05(ga)87 718.8
S(ted system calls drops to zero.).05 E 4.17(5\) The)321.6 84 R .102
(\214lesystem is synchronized to disk as if it were)2.603 F
(about to be unmounted.)336.6 96 Q 4.17(6\) An)321.6 111.6 R 3.015(yc)
-.15 G .516(ylinder groups that were modi\214ed after the)-3.165 F(y)
-.15 E .797(were copied in step tw)336.6 123.6 R 3.297(oa)-.1 G .796
(re recopied to their pre-)-3.297 F 1.814(allocated backing block.)336.6
135.6 R(Additionally)6.814 E 4.314(,t)-.65 G 1.814(he block)-4.314 F
2.855(bitmap in each recopied c)336.6 147.6 R 2.854
(ylinder group is res-)-.15 F 1.085
(canned to determine which blocks were changed.)336.6 159.6 R(Ne)336.6
171.6 Q 5.109(wly allocated blocks are mark)-.25 F 5.108(ed as `)-.1 F
(`not)-.74 E(copied')336.6 183.6 Q 5.015('a)-.74 G 2.515(nd ne)-5.015 F
2.516(wly freed blocks are mark)-.25 F 2.516(ed as)-.1 F -.74(``)336.6
195.6 S 1.988(not used.).74 F 5.967 -.74('' T)-.7 H 1.987
(he details on ho).74 F 4.487(wt)-.25 G 1.987(hese modi\214ed)-4.487 F
-.15(cy)336.6 207.6 S 1.257
(linder groups are identi\214ed is described belo).15 F -.65(w.)-.25 G
1.054(The amount of space initially claimed by a snap-)336.6 219.6 R
.667(shot is small, usually less than a tenth of one per)336.6 231.6 R
(-)-.2 E 6.31(cent. Actual)336.6 243.6 R 3.81
(snapshot \214le space utilization is)6.31 F(gi)336.6 255.6 Q -.15(ve)
-.25 G 2.5(ni).15 G 2.5(ns)-2.5 G(ection 4.)-2.5 E 4.17(7\) W)321.6
271.2 R 2.556(ith the snapshot \214le in place, acti)-.4 F 2.557
(vity on the)-.25 F 4.55(\214lesystem resumes.)336.6 283.2 R(An)9.55 E
7.05(yp)-.15 G 4.55(rocesses that were)-7.05 F(block)336.6 295.2 Q 2.262
(ed at a g)-.1 F 2.262(ate are a)-.05 F -.1(wa)-.15 G -.1(ke).1 G 2.263
(ned and allo).1 F 2.263(wed to)-.25 F(proceed with their system call.)
336.6 307.2 Q 4.17(8\) Blocks)321.6 322.8 R 2.137
(that had been claimed by an)4.638 F 4.637(ys)-.15 G(napshots)-4.637 E
1.557(that e)336.6 334.8 R 1.558
(xisted at the time that the current snapshot)-.15 F -.1(wa)336.6 346.8
S 2.59(st).1 G(ak)-2.59 E .09(en are e)-.1 F .09(xpunged from the ne)
-.15 F 2.59(ws)-.25 G .09(napshot for)-2.59 F(reasons described belo)
336.6 358.8 Q -.65(w.)-.25 G .286
(During steps three through six, all write acti)346.6 374.4 R(vity)-.25
E 1.192(on the \214lesystem is suspended.)321.6 386.4 R 1.191
(Steps three and four)6.191 F .562(complete in at most a fe)321.6 398.4
R 3.062(wm)-.25 G 3.062(illiseconds. The)-3.062 F .563(time for)3.063 F
.603(step \214v)321.6 410.4 R 3.103(ei)-.15 G 3.103(saf)-3.103 G .603
(unction of the number of dirty pages in)-3.103 F 1.41(the k)321.6 422.4
R 3.91(ernel. It)-.1 F 1.41(is bounded by the amount of memory)3.91 F
1.336(that is dedicated to storing \214le pages.)321.6 434.4 R 1.335
(It is typically)6.335 F 1.455
(less than a second and is independent of the size of)321.6 446.4 R
2.879(the \214lesystem.)321.6 458.4 R -.8(Ty)7.879 G 2.878
(pically step six needs to recop).8 F(y)-.1 E .021(only a fe)321.6 470.4
R 2.521(wc)-.25 G .021(ylinder groups, so it also completes in less)
-2.671 F(than a second.)321.6 482.4 Q .051
(The splitting of the bitmap copies between steps)346.6 498 R(tw)321.6
510 Q 2.757(oa)-.1 G .257(nd six is the w)-2.757 F .257(ay that I a)-.1
F -.2(vo)-.2 G .258(id ha).2 F .258(ving the suspend)-.2 F 1.453
(time be a function of the size of the \214lesystem.)321.6 522 R(By)
6.453 E .647(making our primary cop)321.6 534 R 3.147(yp)-.1 G .648
(ass while the \214lesystem is)-3.147 F 3.644(still acti)321.6 546 R
-.15(ve)-.25 G 6.144(,a).15 G 3.644(nd then ha)-6.144 F 3.644
(ving only a fe)-.2 F 6.143(wc)-.25 G(ylinder)-6.293 E 2.4
(groups in need of recop)321.6 558 R 2.4(ying after it has been sus-)-.1
F .739(pended, I k)321.6 570 R .739(eep the suspend time do)-.1 F .739
(wn to a small and)-.25 F(usually \214lesystem size independent time.)
321.6 582 Q .233(The details of the tw)346.6 597.6 R .234
(o-pass algorithm are as fol-)-.1 F(lo)321.6 609.6 Q 4.804(ws. Before)
-.25 F 2.304(starting the cop)4.804 F 4.803(ya)-.1 G 2.303
(nd scan of all the)-4.803 F -.15(cy)321.6 621.6 S 5.922
(linder groups, the snapshot code allocates a).15 F -.74(``)321.6 633.6
S(progress').74 E 3.115('b)-.74 G .615
(itmap whose size is equal to the number)-3.115 F 1.141(of c)321.6 645.6
R 1.141(ylinder groups in the \214lesystem.)-.15 F 1.142(The purpose of)
6.141 F .113(the `)321.6 657.6 R(`progress')-.74 E 2.613('b)-.74 G .112
(itmap is to k)-2.613 F .112(eep track of which c)-.1 F(ylin-)-.15 E
.368(der groups ha)321.6 669.6 R .669 -.15(ve b)-.2 H .369(een scanned.)
.15 F(Initially)5.369 E 2.869(,a)-.65 G .369(ll the bits in)-2.869 F
2.77(the `)321.6 681.6 R(`progress')-.74 E 5.27('m)-.74 G 2.77
(ap are cleared.)-5.27 F 2.77(The \214rst pass is)7.77 F 2.106
(completed in step tw)321.6 693.6 R 4.606(ob)-.1 G 2.106
(efore the \214lesystem is sus-)-4.606 F 3.577(pended. In)321.6 705.6 R
1.077(this \214rst pass, all the c)3.577 F 1.076(ylinder groups are)-.15
F 8.308(scanned. When)321.6 717.6 R 5.809
(the clinder group is read, its)8.308 F EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 2.764(corresponding bit is set in the `)72 84 R
(`progress')-.74 E 5.264('b)-.74 G(itmap.)-5.264 E .135(The c)72 96 R
.135(ylinder group is then copied and its block map is)-.15 F 1.4
(consulted to update the snapshot \214le as described in)72 108 R 1.355
(step tw)72 120 R 3.855(o. Since)-.1 F 1.355
(the \214lesystem is still acti)3.855 F -.15(ve)-.25 G 3.855<2c8c>.15 G
(lesys-)-3.855 E 3.139(tem blocks may be allocated and freed while the)
72 132 R -.15(cy)72 144 S .191(linder groups are being scanned.).15 F
.192(Each time a c)5.191 F(ylin-)-.15 E 1.587
(der group is updated because of a block being allo-)72 156 R .374
(cated or freed, its corresponding bit in the `)72 168 R(`progress')-.74
E(')-.74 E .709(bitmap is cleared.)72 180 R .709
(Once this \214rst pass o)5.709 F -.15(ve)-.15 G 3.209(rt).15 G .708
(he c)-3.209 F(ylin-)-.15 E 4.086
(der groups is completed, the \214lesystem is `)72 192 R(`sus-)-.74 E
(pended.)72 204 Q -.74('')-.7 G 1.779(Step six no)97 219.6 R 4.279(wb)
-.25 G 1.779(ecomes the second pass of the)-4.279 F 4.537
(algorithm. The)72 231.6 R 2.037(second pass need only identify and)
4.537 F .538(update the snapshot for an)72 243.6 R 3.037(yc)-.15 G .537
(ylinder groups that were)-3.187 F 1.274
(modi\214ed after it handled them in the \214rst pass.)72 255.6 R(The)
6.275 E 2.45(changed c)72 267.6 R 2.45
(ylinder groups are identi\214ed by scanning)-.15 F 2.168(the `)72 279.6
R(`progress')-.74 E 4.668('b)-.74 G 2.168(itmap and rescanning an)-4.668
F 4.669(yc)-.15 G(ylinder)-4.819 E 1.699(groups whose bits are zero.)72
291.6 R 1.698(Although e)6.698 F -.15(ve)-.25 G 1.698(ry bitmap).15 F
-.1(wo)72 303.6 S 2.048(uld ha).1 F 2.349 -.15(ve t)-.2 H 4.549(ob).15 G
4.549(er)-4.549 G 2.049(eprocessed in the w)-4.549 F 2.049
(orst case, in)-.1 F 1.184(practice only a fe)72 315.6 R 3.683(wb)-.25 G
1.183(itmaps need to be recopied and)-3.683 F(check)72 327.6 Q(ed.)-.1 E
/F1 10/Times-Bold@0 SF(3.)72 351.6 Q/F2 12/Times-Bold@0 SF
(Maintaining a Filesystem Snapshot)5 E F0 .652(Each time an e)97 367.2 R
.653(xisting block in the \214lesystem is)-.15 F 2.653
(modi\214ed, the \214lesystem checks whether that block)72 379.2 R -.1
(wa)72 391.2 S 4.539(si).1 G 4.539(nu)-4.539 G 2.039
(se at the time that the snapshot w)-4.539 F 2.039(as tak)-.1 F(en)-.1 E
.557(\(i.e., it is not mark)72 403.2 R .557(ed `)-.1 F .557(`not used')
-.74 F 3.057('\). If)-.74 F .556(so, and if it has)3.057 F 1.585
(not already been copied \(i.e., it is still mark)72 415.2 R 1.586(ed `)
-.1 F(`not)-.74 E(copied')72 427.2 Q 1.909('\), a ne)-.74 F 4.409(wb)
-.25 G 1.909(lock is allocated from among the)-4.409 F -.74(``)72 439.2
S 1.193(not used').74 F 3.693('b)-.74 G 1.193
(locks and placed in the snapshot \214le to)-3.693 F .08(replace the `)
72 451.2 R .08(`not copied')-.74 F 2.58('e)-.74 G(ntry)-2.58 E 5.08(.T)
-.65 G .08(he pre)-5.08 F .08(vious contents)-.25 F 1.368
(of the block are copied to the ne)72 463.2 R 1.368(wly allocated snap-)
-.25 F .748
(shot \214le block, and the modi\214cation to the original is)72 475.2 R
.446(then allo)72 487.2 R .446(wed to proceed.)-.25 F(Whene)5.446 E -.15
(ve)-.25 G 2.946(ra\214).15 G .447(le is remo)-2.946 F -.15(ve)-.15 G
(d,).15 E 1.61(the snapshot code inspects each of the blocks being)72
499.2 R 1.311(freed and claims an)72 511.2 R 3.812(yt)-.15 G 1.312
(hat were in use at the time of)-3.812 F 1.869(the snapshot.)72 523.2 R
1.869(Those blocks mark)6.869 F 1.868(ed `)-.1 F 1.868(`not used')-.74 F
4.368('a)-.74 G(re)-4.368 E(returned to the free list.)72 535.2 Q 1.922
(When a snapshot \214le is read, reads of blocks)97 550.8 R(mark)72
562.8 Q .423(ed `)-.1 F .423(`not copied')-.74 F 2.923('r)-.74 G .422
(eturn the contents of the corre-)-2.923 F .008
(sponding block in the \214lesystem.)72 574.8 R .009
(Reads of blocks that)5.009 F(ha)72 586.8 Q 2.58 -.15(ve b)-.2 H 2.28
(een copied return the contents in the copied).15 F .753
(block \(e.g., the contents that were stored at that loca-)72 598.8 R
.239(tion in the \214lesystem at the time that the snapshot w)72 610.8 R
(as)-.1 E(tak)72 622.8 Q 5.225(en\). Writes)-.1 F 2.726
(to snapshot \214les are not permitted.)5.225 F 1.538
(When a snapshot \214le is no longer needed, it can be)72 634.8 R(remo)
72 646.8 Q -.15(ve)-.15 G 3.231(di).15 G 3.231(nt)-3.231 G .731
(he same w)-3.231 F .731(ay as an)-.1 F 3.231(yo)-.15 G .731
(ther \214le; its blocks)-3.231 F 2.009
(are simply returned to the free list and its inode is)72 658.8 R
(zeroed and returned to the free inode list.)72 670.8 Q 3.045
(Snapshots may li)97 686.4 R 3.345 -.15(ve a)-.25 H 3.045
(cross reboots.).15 F 3.045(When a)8.045 F .32
(snapshot \214le is created, the inode number of the snap-)72 698.4 R
3.762(shot \214le is recorded in the superblock.)72 710.4 R 3.763
(When a)8.763 F 1.964(\214lesystem is mounted, the snapshot list is tra)
321.6 84 R -.15(ve)-.2 G(rsed).15 E 1.88
(and all the listed snapshots are acti)321.6 96 R -.25(va)-.25 G 4.38
(ted. The).25 F(only)4.38 E 1.133
(limit on the number of snapshots that may e)321.6 108 R 1.133
(xist in a)-.15 F 1.77
(\214lesystem is the size of the array in the superblock)321.6 120 R
1.236(that holds the list of snapshots.)321.6 132 R(Currently)6.236 E
3.736(,t)-.65 G 1.236(his array)-3.736 F
(can hold up to twenty snapshots.)321.6 144 Q 1.954
(Multiple snapshot \214les can e)346.6 159.6 R 1.954(xist concurrently)
-.15 F(.)-.65 E 4.297(As described abo)321.6 171.6 R -.15(ve)-.15 G
6.797(,e).15 G 4.296(arlier snapshot \214les w)-6.797 F(ould)-.1 E 2.375
(appear in later snapshots.)321.6 183.6 R 2.375
(If an earlier snapshot is)7.375 F(remo)321.6 195.6 Q -.15(ve)-.15 G
3.403(d, a later snapshot w).15 F 3.403(ould claim its blocks)-.1 F
1.614(rather than allo)321.6 207.6 R 1.615
(wing them to be returned to the free)-.25 F 3.007(list. This)321.6
219.6 R .506(semantic means that it w)3.007 F .506(ould be impossible)
-.1 F .957(to free an)321.6 231.6 R 3.458(ys)-.15 G .958
(pace on the \214lesystem e)-3.458 F .958(xcept by remo)-.15 F(v-)-.15 E
1.407(ing the ne)321.6 243.6 R 1.406(west snapshot.)-.25 F 3.006 -.8
(To a)6.406 H -.2(vo).6 G 1.406(id this problem, the).2 F 1.426
(snapshot code goes through and e)321.6 255.6 R 1.426
(xpunges all earlier)-.15 F .686(snapshots by changing its vie)321.6
267.6 R 3.186(wo)-.25 G 3.185(ft)-3.186 G .685(hem to being zero)-3.185
F .016(length \214les.)321.6 279.6 R -.4(Wi)5.016 G .017
(th this technique, the freeing of an ear).4 F(-)-.2 E .534
(lier snapshot releases the space held by that snapshot.)321.6 291.6 R
1.327(When a block is o)346.6 307.2 R -.15(ve)-.15 G 1.327
(rwritten, all snapshots are).15 F(gi)321.6 319.2 Q -.15(ve)-.25 G 2.68
(na).15 G 2.68(no)-2.68 G .18(pportunity to cop)-2.68 F 2.68(yt)-.1 G
.18(he block.)-2.68 F 2.68(Ac)5.18 G(op)-2.68 E 2.68(yo)-.1 G 2.68(ft)
-2.68 G(he)-2.68 E 1.523
(block is made for each snapshot in which the block)321.6 331.2 R 2.578
(resides. Ov)321.6 343.2 R .077
(erwrites typically occur only for inode and)-.15 F .69
(directory blocks.)321.6 355.2 R .69(File data is usually not o)5.69 F
-.15(ve)-.15 G(rwritten.).15 E .137
(Instead, a \214le will be truncated and then reallocated as)321.6 367.2
R .565(it is re)321.6 379.2 R 3.066(written. Thus,)-.25 F .566(the slo)
3.066 F 3.066(wa)-.25 G(nd)-3.066 E/F3 9/Times-Roman@0 SF(I/O)3.066 E F0
(intensi)3.066 E .866 -.15(ve b)-.25 H(lock).15 E(cop)321.6 391.2 Q
(ying is infrequent.)-.1 E .539(Deleted blocks are handled dif)346.6
406.8 R(ferently)-.25 E 5.538(.T)-.65 G .538(he list)-5.538 F .982
(of snapshots is consulted.)321.6 418.8 R .983(When a snapshot is found)
5.982 F 3.616(in which the block is acti)321.6 430.8 R 3.916 -.15(ve \()
-.25 H -.74(``).15 G 3.616(not copied').74 F 3.616('\), the)-.74 F .29
(deleted block is claimed by that snapshot.)321.6 442.8 R .29(The tra)
5.29 F -.15(ve)-.2 G -.2(r-).15 G .102
(sal of the snapshot list is then terminated.)321.6 454.8 R .102
(Other snap-)5.102 F 1.385(shots for which the block are acti)321.6
466.8 R 1.685 -.15(ve a)-.25 H 1.385(re left with an).15 F 1.936
(entry of `)321.6 478.8 R 1.936(`not copied')-.74 F 4.436('f)-.74 G
1.936(or that block.)-4.436 F 1.935(The result is)6.935 F .537
(that when the)321.6 490.8 R 3.038(ya)-.15 G .538
(ccess that location, the)-3.038 F 3.038(yw)-.15 G .538(ill still ref-)
-3.038 F .43(erence the deleted block.)321.6 502.8 R .43
(Since snapshots may not be)5.43 F .947
(modi\214ed, the block will not change.)321.6 514.8 R .948
(Since the block)5.948 F 1.591
(is claimed by a snapshot, it will not be allocated to)321.6 526.8 R
3.228(another use.)321.6 538.8 R 3.229
(If the snapshot claiming the deleted)8.228 F 3.424
(block is deleted, the remaining snapshots will be)321.6 550.8 R(gi)
321.6 562.8 Q -.15(ve)-.25 G 3.323(nt).15 G .824
(he opportunity to claim the block.)-3.323 F .824(Only when)5.824 F 1.69
(none of the remaining snapshots w)321.6 574.8 R 1.69(ants to claim the)
-.1 F .051(block \(i.e., it is mark)321.6 586.8 R .051(ed `)-.1 F .051
(`not used')-.74 F 2.551('i)-.74 G 2.551(na)-2.551 G .051
(ll of them\) will)-2.551 F(it be returned to the freelist.)321.6 598.8
Q F1(4.)321.6 631.2 Q F2(Snapshot P)5 E(erf)-.24 E(ormance)-.3 E F0 1.8
(The e)346.6 646.8 R 1.8(xperiments described in this section and)-.15 F
1.01(the background `)321.6 658.8 R(`fsck')-.74 E 3.51('p)-.74 G 1.01
(erformance section used the)-3.51 F(follo)321.6 670.8 Q(wing hardw)-.25
E(are/softw)-.1 E(are con\214guration:)-.1 E 7.314
(Computer: Dual Processor using tw)321.6 686.4 R 9.814(oC)-.1 G(eleron)
-9.814 E 2.432(350MHz CPUs.)321.6 698.4 R 2.433
(The machine has 256Mb of main)7.433 F(memory)321.6 710.4 Q(.)-.65 E EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF
(O/S: FreeBSD 5.0-current as of December 30, 2001)72 84 Q
(I/O Controller: Adaptec 2940 Ultra2 SCSI adapter)72 99.6 Q 5.244
(Disk: T)72 115.2 R 5.444 -.1(wo <)-.8 H 5.244
(IBM DDRS-39130D DC1B> Fix).1 F(ed)-.15 E 5.126(Direct Access SCSI-2 de)
72 127.2 R 5.126(vice, 80MB/s transfers,)-.25 F -.8(Ta)72 139.2 S 1.788
(gged Queuing Enabled, 8715MB, 17,850,000 512).8 F
(byte sectors: 255H 63S/T 1111C)72 151.2 Q 3.16
(Small Filesystem: 0.5Gb, 8K block, 1K fragment,)72 166.8 R 1.676
(90% full, 70874 \214les, initial snapshot size 0.392Mb)72 178.8 R
(\(0.08% of \214lesystem space\).)72 190.8 Q(Lar)72 206.4 Q 2.36
(ge Filesystem: 7.7Gb, 16K block, 2K fragment,)-.18 F .961
(90% full, 520715 \214les, initial snapshot size 2.672Mb)72 218.4 R
(\(0.03% of \214lesystem space\).)72 230.4 Q 7.692(Load: F)72 246 R
7.693(our continuously running simultaneous)-.15 F(Andre)72 258 Q 2.753
(wb)-.25 G .253(enchmarks that create a moderate amount of)-2.753 F
2.809(\214lesystem acti)72 270 R 2.809(vity intermix)-.25 F 2.809
(ed with periods of)-.15 F/F1 9/Times-Roman@0 SF(CPU)5.31 E F0(intensi)
72 282 Q .3 -.15(ve a)-.25 H(cti).15 E(vity [Ho)-.25 E -.1(wa)-.25 G
(rd et al, 1988].).1 E .4 LW 278.97 296.1 83.43 296.1 DL 12.5
(Filesystem Elapsed)88.43 305.6 R 18.6(CPU Suspend)19.16 F 31.01(Size T)
101.49 317.6 R 21.455(ime T)-.35 F 24.51(ime T)-.35 F(ime)-.35 E 23.755
(0.5Gb 0.7)97.74 329.6 R 14.445(sec 0.1)2.5 F 12.5(sec 0.025)2.5 F(sec)
2.5 E 23.755(7.7Gb 3.5)97.74 341.6 R 14.445(sec 0.4)2.5 F 12.5
(sec 0.034)2.5 F(sec)2.5 E 278.97 346.1 83.43 346.1 DL 278.97 296.1
278.97 346.1 DL 83.43 296.1 83.43 346.1 DL/F2 10/Times-Bold@0 SF -.92
(Ta)90.965 359.6 S(ble 1).92 E F0(:)A/F3 10/Times-Italic@0 SF
(Snapshot times on an idle \214lesystem)2.5 E F0 -.8(Ta)97 383.6 S .346
(ble 1 sho).8 F .346(ws the time to tak)-.25 F 2.846(eas)-.1 G .346
(napshot on an)-2.846 F .174(idle \214lesystem.)72 395.6 R .174
(The elapsed time to tak)5.174 F 2.675(eas)-.1 G .175(napshot is)-2.675
F 1.053(proportional to the size of the \214lesystem being snap-)72
407.6 R 3.442(shotted. Ho)72 419.6 R(we)-.25 E -.15(ve)-.25 G 1.742 -.4
(r, n).15 H .942(early all the time to tak).4 F 3.443(eas)-.1 G(nap-)
-3.443 E .185(shot is spent in steps one, tw)72 431.6 R .185
(o, and eight.)-.1 F .185(Because the)5.185 F 4.18
(\214lesystem permits other processes to modify the)72 443.6 R 1.307
(\214lesystem during steps one, tw)72 455.6 R 1.306
(o, and eight, this part)-.1 F 1.817
(of taking a snapshot does not interfere with normal)72 467.6 R .119
(system operation.)72 479.6 R .118(The `)5.119 F .118(`suspend time')
-.74 F 2.618('c)-.74 G .118(olumn sho)-2.618 F(ws)-.25 E 2.451
(the amount of real-time that processes are block)72 491.6 R(ed)-.1 E
1.682(from e)72 503.6 R -.15(xe)-.15 G 1.681
(cuting system calls that modify the \214lesys-).15 F 2.688(tem. As)72
515.6 R -.8(Ta)2.689 G .189(ble 1 sho).8 F .189
(ws, the period during which write)-.25 F(acti)72 527.6 Q 1.24
(vity is suspended, and thus apparent to processes)-.25 F 1.206
(in the system, is short and does not increase propor)72 539.6 R(-)-.2 E
(tionally to \214lesystem size.)72 551.6 Q 279.525 565.7 82.875 565.7 DL
13.055(Filesystem Elapsed)87.875 575.2 R 18.6(CPU Suspend)19.715 F
31.565(Size T)100.935 587.2 R 22.01(ime T)-.35 F 24.51(ime T)-.35 F(ime)
-.35 E 26.81(0.5Gb 3.7)97.185 599.2 R 12.5(sec 0.1)2.5 F 12.5(sec 0.027)
2.5 F(sec)2.5 E 21.81(7.7Gb 12.1)97.185 611.2 R 12.5(sec 0.4)2.5 F 12.5
(sec 0.036)2.5 F(sec)2.5 E 279.525 615.7 82.875 615.7 DL 279.525 565.7
279.525 615.7 DL 82.875 565.7 82.875 615.7 DL F2 -.92(Ta)86.525 629.2 S
(ble 2).92 E F0(:)A F3(Snapshot times on an active \214lesystem)2.5 E F0
-.8(Ta)97 653.2 S .002(ble 2 sho).8 F .001
(ws the times to snapshot a \214lesystem)-.25 F 3.373
(that has four acti)72 665.2 R 3.673 -.15(ve c)-.25 H 3.374
(oncurrent processes running.).15 F .709
(The elapsed time rises because the process taking the)72 677.2 R .985
(snapshot has to compete with the other processes for)72 689.2 R 1.33
(access to the \214lesystem.)72 701.2 R 1.33(Note that the suspend time)
6.33 F .223(has risen slightly)72 713.2 R 2.723(,b)-.65 G .223
(ut is still insigni\214cant and does not)-2.923 F 2.373
(increase in proportion to the size of the \214lesystem)321.6 84 R 2.244
(under test.)321.6 96 R 2.244(Instead, it is a function of the le)7.244
F -.15(ve)-.25 G 4.744(lo).15 G(f)-4.744 E(write acti)321.6 108 Q
(vity present on the \214lesystem.)-.25 E 504.685 122.1 356.915 122.1 DL
12.5(Filesystem Elapsed)361.915 131.6 R(CPU)21.66 E 31.01(Size T)374.975
143.6 R 23.955(ime T)-.35 F(ime)-.35 E 23.755(0.5Gb 0.5)371.225 155.6 R
14.445(sec 0.02)2.5 F(sec)2.5 E 23.755(7.7Gb 2.3)371.225 167.6 R 14.445
(sec 0.09)2.5 F(sec)2.5 E 504.685 172.1 356.915 172.1 DL 504.685 122.1
504.685 172.1 DL 356.915 122.1 356.915 172.1 DL F2 -.92(Ta)325.11 185.6
S(ble 3).92 E F0(:)A F3(Snapshot r)2.5 E(emo)-.37 E
(val time on an idle \214lesystem)-.1 E F0 -.8(Ta)346.6 209.6 S 1.36
(ble 3 sho).8 F 1.36(ws the times to remo)-.25 F 1.66 -.15(ve a s)-.15 H
(napshot).15 E 1.185(on an idle \214lesystem.)321.6 221.6 R 1.186
(The elapsed time to remo)6.185 F 1.486 -.15(ve a)-.15 H 1.329
(snapshot is proportional to the size of the \214lesystem)321.6 233.6 R
.08(being snapshotted.)321.6 245.6 R .08
(The \214lesystem does not need to be)5.08 F(suspended to remo)321.6
257.6 Q .3 -.15(ve a s)-.15 H(napshot.).15 E 504.685 271.7 356.915 271.7
DL 12.5(Filesystem Elapsed)361.915 281.2 R(CPU)21.66 E 31.01(Size T)
374.975 293.2 R 23.955(ime T)-.35 F(ime)-.35 E 23.755(0.5Gb 1.4)371.225
305.2 R 14.445(sec 0.03)2.5 F(sec)2.5 E 23.755(7.7Gb 4.9)371.225 317.2 R
14.445(sec 0.10)2.5 F(sec)2.5 E 504.685 321.7 356.915 321.7 DL 504.685
271.7 504.685 321.7 DL 356.915 271.7 356.915 321.7 DL F2 -.92(Ta)321.6
335.2 S(ble 4).92 E F0(:)A F3(Snapshot r)2.5 E(emo)-.37 E
(val time on an active \214lesystem)-.1 E F0 -.8(Ta)346.6 359.2 S -.18
(ble 4 sho).8 F -.18(ws the times to remo)-.25 F .12 -.15(ve a s)-.15 H
-.18(napshot on).15 F 3.407<618c>321.6 371.2 S .907
(lesystem that has four acti)-3.407 F 1.207 -.15(ve c)-.25 H .908
(oncurrent processes).15 F 3.647(running. The)321.6 383.2 R 1.355
(elapsed time rises because the process)3.856 F(remo)321.6 395.2 Q .932
(ving the snapshot has to compete with the other)-.15 F .56
(processes for access to the \214lesystem.)321.6 407.2 R .559
(The \214lesystem)5.351 F -.209(does not need to be suspended to remo)
321.6 419.2 R .091 -.15(ve a s)-.15 H(napshot.).15 E F2(5.)321.6 443.2 Q
/F4 12/Times-Bold@0 SF(Implementation of Backgr)5 E(ound `)-.216 E
(`Fsck')-.756 E(')-.756 E F0 1.56(Background `)346.6 458.8 R(`fsck')-.74
E 4.06('r)-.74 G 1.56(uns by taking a snapshot)-4.06 F 1.126
(then running its traditional algorithms o)321.6 470.8 R -.15(ve)-.15 G
3.625(rt).15 G 1.125(he snap-)-3.625 F 3.843(shot. Because)321.6 482.8 R
1.344(the snapshot is tak)3.843 F 1.344(en of a completely)-.1 F 1.809
(quiescent \214lesystem, all of whose dirty blocks ha)321.6 494.8 R -.15
(ve)-.2 G 1.275(been written to disk, the snapshot appears to `)321.6
506.8 R(`fsck')-.74 E(')-.74 E 1.902(to be e)321.6 518.8 R 1.901
(xactly lik)-.15 F 4.401(ea)-.1 G 4.401(nu)-4.401 G 1.901(nmounted ra)
-4.401 F 4.401(wd)-.15 G 1.901(isk partition.)-4.401 F -.74(``)321.6
530.8 S(Fsck').74 E 2.971('r)-.74 G .471(uns in \214v)-2.971 F 2.971(ep)
-.15 G .471(asses that can be summarized as)-2.971 F(follo)321.6 542.8 Q
(ws:)-.25 E 4.17(1\) Scan)321.6 558.4 R 1.192
(all the allocated inodes to accumulate a list)3.693 F 1.624
(of all their allocated blocks.)336.6 570.4 R 1.625(The f)6.833 F 1.625
(ast \214lesystem)-.1 F .924
(preallocates all the inodes that the \214lesystem will)336.6 582.4 R
-2.15 -.25(ev e)336.6 594.4 T 3.438(rb).25 G 3.438(ea)-3.438 G .938
(ble to use at the time that the \214lesystem)-3.438 F 2.035
(is created.)336.6 606.4 R 2.034(The superblock contains information)
7.243 F .327(on where all the preallocated inodes can be found.)336.6
618.4 R .485(Thus, `)336.6 630.4 R(`fsck')-.74 E 2.985('c)-.74 G .484
(an \214nd all of them without need of)-2.985 F(an)336.6 642.4 Q 4.788
(ya)-.15 G 2.288(dditional information such as an inde)-4.788 F(x-of-)
-.15 E .239(inodes \214le or an)336.6 654.4 R 2.739(yo)-.15 G 2.739(ft)
-2.739 G .238(he \214lesystem directory struc-)-2.739 F 3.354(ture. As)
336.6 666.4 R .647(part of scanning all the allocated inodes,)3.146 F
-.74(``)336.6 678.4 S(fsck').74 E 3.532('a)-.74 G 1.031
(lso identi\214es all the inodes that are allo-)-3.532 F 3.714
(cated as directories for use in the ne)336.6 690.4 R 3.714(xt three)
-.15 F 5.577(passes. When)336.6 702.4 R 2.869
(the \214rst pass completes, `)5.369 F(`fsck')-.74 E(')-.74 E .208
(has a list of all the allocated blocks and inodes.)336.6 714.4 R EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 4.17(2\) Scan)72 84 R 2.252
(all the directories found in pass one.)4.752 F -.15(Fo)7.253 G(r).15 E
.549(each entry found in a directory)87 96 R 3.049(,i)-.65 G .548
(ncrement the ref-)-3.049 F .539
(erence count in the inode that it references.)87 108 R .539(If the)
5.539 F .705(referenced inode is a directory)87 120 R 3.205(,v)-.65 G
.705(erify that its dot-)-3.355 F .995(dot entry points back properly)87
132 R 5.995(.A)-.65 G .995(lso note that an)-5.995 F 2.028
(entry to the directory has been found.)87 144 R 2.027(The one)7.027 F
-.15(ex)87 156 S .802
(ception to the dot-dot rule is for the root of the).15 F .4
(\214lesystem \(inode tw)87 168 R .4(o\) whose dot-dot entry should)-.1
F(point to itself.)87 180 Q 4.17(3\) Check)72 195.6 R 1.578(that e)4.078
F -.15(ve)-.25 G 1.578(ry directory \(e).15 F 1.579(xcept the root\) w)
-.15 F(as)-.1 E 1.585(found during the second pass.)87 207.6 R 1.584
(If an)6.584 F 4.084(yd)-.15 G(irectories)-4.084 E 2.978
(were not found, the)87 219.6 R 5.479(yh)-.15 G -2.25 -.2(av e)-5.479 H
2.979(been someho)5.679 F 5.479(wl)-.25 G(ost)-5.479 E .634
(from the main tree.)87 231.6 R .634(In traditional `)5.634 F(`fsck')
-.74 E 3.133('a)-.74 G .933 -.15(ny l)-3.133 H(ost).15 E 2.085
(directories w)87 243.6 R 2.085(ould be placed into the)-.1 F/F1 10
/Times-Bold@0 SF(lost+f)4.585 E(ound)-.25 E F0(directory)87 255.6 Q 5.45
(.W)-.65 G .45(hen running with soft updates, unref-)-5.45 F .937
(erenced directories only occur if the)87 267.6 R 3.438(yw)-.15 G .938
(ere in the)-3.438 F 2.126(process of being deleted.)87 279.6 R 2.126
(So, if an)7.126 F 4.625(yt)-.15 G 2.125(urn up in)-4.625 F .233
(pass three, `)87 291.6 R(`fsck')-.74 E 2.734('m)-.74 G .234
(arks them for deletion in pass)-2.734 F(four)87 303.6 Q(.)-.55 E 4.17
(4\) If)72 319.2 R(an)3.899 E 3.899(yi)-.15 G 1.399(nodes ha)-3.899 F
1.699 -.15(ve a h)-.2 H 1.398(igher reference count than).15 F 3.725
(the number of directory entries that reference)87 331.2 R 1.841
(them, their reference count is adjusted to re\215ect)87 343.2 R 3.356
(the correct number of references.)87 355.2 R 3.357(Such errors)8.357 F
.596(occur when a directory entry has been deleted b)87 367.2 R(ut)-.2 E
2.517(the system crashed before updating the on-disk)87 379.2 R .616
(reference count in the inode.)87 391.2 R .615(The reference count)5.616
F .15(should ne)87 403.2 R -.15(ve)-.25 G 2.65(rn).15 G .15
(eed to be increased; if such a condi-)-2.65 F 3.399(tion is found, `)87
415.2 R(`fsck')-.74 E 5.899('m)-.74 G 3.398(arks the \214lesystem as)
-5.899 F .572(needing manual interv)87 427.2 R .573(ention and e)-.15 F
3.073(xits. There)-.15 F .573(is a)3.073 F .477
(special case in which no entries for an inode were)87 439.2 R 2.911
(found. When)87 451.2 R .412(running with soft updates, an unref-)2.911
F 1.412(erenced inode can only happen if the \214le w)87 463.2 R 1.412
(as in)-.1 F 2.008(the process of being deleted.)87 475.2 R 2.009
(Thus, background)7.009 F -.74(``)87 487.2 S(fsck').74 E 3.053('r)-.74 G
.553(equests the k)-3.053 F .553(ernel to decrement the refer)-.1 F(-)
-.2 E .919(ence count on the inode to zero.)87 499.2 R .919(The k)5.919
F .919(ernel then)-.1 F(follo)87 511.2 Q .502
(ws the usual code path for inodes with a zero)-.25 F 1.595
(reference count that releases the inode')87 523.2 R 4.095(sc)-.55 G
(laimed)-4.095 E 3.07(blocks and then releases the inode itself.)87
535.2 R(The)8.07 E 2.671(freed inode and an)87 547.2 R 5.171(yb)-.15 G
2.671(locks that it claimed are)-5.171 F(remo)87 559.2 Q -.15(ve)-.15 G
3.76(df).15 G 1.26(rom the list of v)-3.76 F 1.26
(alid inodes and blocks)-.25 F .961(found in the \214rst pass.)87 571.2
R .961(In traditional `)5.961 F(`fsck')-.74 E 3.462('r)-.74 G(un-)-3.462
E .439(ning on a \214lesystem that is not using soft updates,)87 583.2 R
1.055(unreferenced inodes are placed in the)87 595.2 R F1(lost+f)3.555 E
(ound)-.25 E F0(directory)87 607.2 Q(.)-.65 E 4.17(5\) The)72 622.8 R
1.014(list of v)3.514 F 1.014(alid inodes and blocks determined in)-.25
F 2.386(the \214rst pass and updated in the fourth pass is)87 634.8 R
4.03(compared ag)87 646.8 R 4.03(ainst the bitmaps in the c)-.05 F
(ylinder)-.15 E 1.625(group maps.)87 658.8 R 1.626(If there are an)6.625
F 4.126(yd)-.15 G 1.626(isagreements, the)-4.126 F 1.82
(bitmaps in the c)87 670.8 R 1.82(ylinder groups are updated with)-.15 F
(the correct entries.)87 682.8 Q .327(The ne)72 698.4 R 2.827(wb)-.25 G
.327(ackground v)-2.827 F .327(ersion of `)-.15 F(`fsck')-.74 E 2.827
('c)-.74 G .328(annot update)-2.827 F 1.19
(the on-disk image of the \214lesystem as the \214lesystem)72 710.4 R
.007(state will be dif)321.6 84 R .008
(ferent from that of the snapshot.)-.25 F(Addi-)5.008 E(tionally)321.6
96 Q 4.166(,au)-.65 G(ser)-4.166 E(-le)-.2 E -.15(ve)-.25 G 4.166(lp).15
G 1.666(rogram cannot obtain the k)-4.166 F(er)-.1 E(-)-.2 E(nel-le)
321.6 108 Q -.15(ve)-.25 G 4.275(ll).15 G 1.775(ocks needed to pro)
-4.275 F 1.775(vide consistent updates)-.15 F 3.977
(of \214lesystem data structures.)321.6 120 R 5.577 -.8(To e)8.977 H
3.977(nsure that the).8 F 2.114
(\214lesystem state is set using the appropriate locking)321.6 132 R
1.875(protocol, a set of system calls w)321.6 144 R 1.874
(as added to enable)-.1 F -.74(``)321.6 156 S(fsck').74 E 2.531('t)-.74
G 2.531(op)-2.531 G .031(ass the resource-update requests to the k)
-2.531 F(er)-.1 E(-)-.2 E 1.913(nel so that the)321.6 168 R 4.412(yc)
-.15 G 1.912(an be made under the appropriate)-4.412 F(lock.)321.6 180 Q
(Fi)346.6 195.6 Q .306 -.15(ve o)-.25 H .007
(perations were implemented in the k).15 F(ernel:)-.1 E 4.17
(1\) set/clear)321.6 211.2 R(superblock \215ags)2.5 E 4.17(2\) adjust)
321.6 226.8 R(an inode block count)2.5 E 4.17(3\) adjust)321.6 242.4 R
(an inode reference count)2.5 E 4.17(4\) free)321.6 258 R 2.5(ar)2.5 G
(ange of inodes)-2.5 E 4.17(5\) free)321.6 273.6 R 2.5(ar)2.5 G
(ange of blocks/fragments)-2.5 E .2(The background v)321.6 289.2 R .2
(ersion of `)-.15 F(`fsck')-.74 E 2.7('i)-.74 G 2.7(sd)-2.7 G(eri)-2.7 E
-.15(ve)-.25 G 2.7(df).15 G .2(rom the)-2.7 F 1.283
(traditional disk-based `)321.6 301.2 R(`fsck')-.74 E 3.783('b)-.74 G
3.783(ya)-3.783 G 1.284(ugmenting the tra-)-3.783 F 1.668(ditional `)
321.6 313.2 R(`fsck')-.74 E 4.168('w)-.74 G 1.668(ith calls to the k)
-4.168 F 1.667(ernel functions in)-.1 F 1.601
(place of writes to the \214lesystem partition.)321.6 325.2 R 1.601
(If at an)6.601 F(y)-.15 E .802(time, `)321.6 337.2 R(`fsck')-.74 E
3.302<278c>-.74 G .802(nds an)-3.302 F 3.301(yi)-.15 G .801
(nconsistencies other than lost)-3.301 F 1.16
(blocks and inodes or high block or reference counts,)321.6 349.2 R .809
(then either a hardw)321.6 361.2 R .809(are or softw)-.1 F .808
(are error has occurred)-.1 F .52(and a traditional e)321.6 373.2 R -.15
(xe)-.15 G .52(cution of `).15 F(`fsck')-.74 E 3.02('n)-.74 G .52
(eeds to be run.)-3.02 F -.74(``)321.6 385.2 S(Fsck').74 E 3.809('s)-.74
G 1.309(ets a superblock \215ag \(using operation 1\) to)-3.809 F 1.082
(force this check to be done before the ne)321.6 397.2 R 1.082
(xt time that)-.15 F .817(the \214lesystem is mounted.)321.6 409.2 R
(Optionally)5.817 E 3.317(,i)-.65 G 3.317(tc)-3.317 G .817(an forcibly)
-3.317 F(do)321.6 421.2 Q 2.853
(wngrade a corrupted \214lesystem to read-only)-.25 F 7.854(.I)-.65 G(n)
-7.854 E .301(more detail, the changes to each pass of `)321.6 433.2 R
(`fsck')-.74 E 2.801('a)-.74 G .301(re as)-2.801 F(follo)321.6 445.2 Q
(ws:)-.25 E 4.17(1\) After)321.6 460.8 R .593
(scanning each allocated inode, `)3.093 F(`fsck')-.74 E 3.094('c)-.74 G
(om-)-3.094 E .966(pares the number of blocks that it claims with its)
336.6 472.8 R 1.008(count of the number of blocks that it is using.)
336.6 484.8 R(If)6.008 E 1.96(these v)336.6 496.8 R 1.96(alues dif)-.25
F(fer)-.25 E 4.46(,t)-.4 G 1.96(he traditional `)-4.46 F(`fsck')-.74 E
4.46('w)-.74 G(ould)-4.56 E 3.78
(write back the inode with the updated v)336.6 508.8 R(alue.)-.25 E .324
(Incorrect block counts typically occur when a par)336.6 520.8 R(-)-.2 E
1.685(tially truncated inode is encountered.)336.6 532.8 R 1.685
(The back-)6.685 F .395(ground `)336.6 544.8 R(`fsck')-.74 E 2.895('u)
-.74 G .395(ses operation 2 to ha)-2.895 F .695 -.15(ve t)-.2 H .395
(he k).15 F(ernel)-.1 E 3.255(adjust the count.)336.6 556.8 R 3.255
(As the \214le may be acti)8.255 F -.15(ve)-.25 G(ly).15 E(gro)336.6
568.8 Q 1.477(wing, the adjustment is done as an increment)-.25 F 1.089
(or decrement to the current v)336.6 580.8 R 1.089
(alue rather than set-)-.25 F 1.085(ting an absolute v)336.6 592.8 R
3.585(alue. No)-.25 F 1.085(other changes to pass)3.585 F
(one are required.)336.6 604.8 Q 4.17(2\) No)321.6 620.4 R
(changes to pass tw)2.5 E 2.5(oa)-.1 G(re required.)-2.5 E 4.17(3\) If)
321.6 636 R(an)2.5 E 2.5(yo)-.15 G
(rphaned directories are found in pass three,)-2.5 E(the)336.6 648 Q
4.019(ya)-.15 G 1.519(re assumed to ha)-4.019 F 1.819 -.15(ve b)-.2 H
1.519(een in the process of).15 F .964(being deleted.)336.6 660 R .964
(Thus the)5.964 F 3.464(ya)-.15 G .964(re mark)-3.464 F .965
(ed for deletion)-.1 F(in pass four)336.6 672 Q(.)-.55 E 4.17(4\) In)
321.6 687.6 R 2.713(the traditional `)5.213 F(`fsck')-.74 E 2.713
(', inodes with high b)-.74 F(ut)-.2 E .22
(non-zero reference counts need to ha)336.6 699.6 R .52 -.15(ve t)-.2 H
.22(heir refer).15 F(-)-.2 E 1.134(ence counts adjusted.)336.6 711.6 R
1.133(Inodes with zero reference)6.133 F EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF 1.752(counts need to be zeroed out on disk.)87
84 R -.4(Wi)6.753 G 1.753(th the).4 F 2.044(background `)87 96 R(`fsck')
-.74 E 4.544('t)-.74 G 2.043(hese tw)-4.544 F 4.543(oo)-.1 G 2.043
(perations can be)-4.543 F 1.48
(subsumed into a single system call \(operation 3\))87 108 R .106
(that adjusts the reference count on an inode.)87 120 R .105(If the)
5.105 F .27(count is reduced to zero, the k)87 132 R .27
(ernel will deallocate)-.1 F .344
(and zero out the inode as part of its normal course)87 144 R .058
(of operation.)87 156 R .059(So, no additional w)5.058 F .059
(ork is required of)-.1 F -.74(``)87 168 S(fsck').74 E 6.019('. As)-.74
F 3.518(with the adjustment of the block)6.019 F .074
(count in pass one, the reference count on the inode)87 180 R 1.298
(may ha)87 192 R 1.597 -.15(ve c)-.2 H 1.297
(hanged since the snapshot because of).15 F .97
(ongoing \214lesystem acti)87 204 R(vity)-.25 E 5.97(.T)-.65 G .97
(hus, the adjustment)-5.97 F .465(is gi)87 216 R -.15(ve)-.25 G 2.965
(na).15 G 2.965(sad)-2.965 G .465(elta rather than as an absolute v)
-2.965 F(alue)-.25 E 1.43
(to ensure that the inode retains the correct refer)87 228 R(-)-.2 E
(ence count.)87 240 Q 4.17(5\) The)72 255.6 R .279(\214nal pass tak)
2.779 F .279(en by the traditional `)-.1 F(`fsck')-.74 E 2.779('i)-.74 G
2.778(st)-2.779 G(o)-2.778 E(re)87 267.6 Q .169
(write the \214lesystem bitmaps to re\215ect the alloca-)-.25 F 2.143
(tions that it has found.)87 279.6 R 2.142(As an acti)7.142 F 2.442 -.15
(ve \214)-.25 H(lesystem).15 E .464(will ha)87 291.6 R .764 -.15(ve c)
-.2 H .464(ontinued to allocate and free resources,).15 F .636
(the state of the bitmaps calculated in the snapshot)87 303.6 R .053
(by the background `)87 315.6 R(`fsck')-.74 E 2.553('w)-.74 G .054
(ill not be correct, so it)-2.553 F .1
(cannot write them back in their entirety)87 327.6 R 5.1(.H)-.65 G -.25
(ow)-5.1 G -2.15 -.25(ev e).25 H -.4(r,).25 G .843
(it can \214gure out which blocks and inodes are lost)87 339.6 R 2.51
(by doing an e)87 351.6 R(xclusi)-.15 E -.15(ve)-.25 G 2.51
(-or of the bitmaps in the).15 F 1.757
(snapshot with the bitmaps that it has calculated.)87 363.6 R 4.813
(The resulting non-zero bits will be the lost)87 375.6 R 6.052
(resources. Ha)87 387.6 R 3.553(ving determined which resources)-.2 F
.653(are lost, `)87 399.6 R(`fsck')-.74 E 3.152('m)-.74 G .652
(ust cause the li)-3.152 F .952 -.15(ve b)-.25 H .652(itmaps to be).15 F
(repaired.)87 411.6 Q 1.392(If an inode has been zeroed on the disk, b)
87 427.2 R 1.392(ut has)-.2 F .88(not been mark)87 439.2 R .88
(ed free in the bitmaps, then it is so)-.1 F(mark)87 451.2 Q 2.791
(ed \(using operation 4\).)-.1 F 2.792(If there were an)7.791 F(y)-.15 E
3.167(unclaimed blocks that were not released when)87 463.2 R 3.702
(adjusting the inode reference counts, the)87 475.2 R 6.202(ya)-.15 G
(re)-6.202 E .019(freed \(using operation 5\).)87 487.2 R .018
(These unclaimed blocks)5.018 F 1.341(arise from an inode that w)87
499.2 R 1.341(as zeroed on disk, b)-.1 F(ut)-.2 E 2.89
(whose formerly claimed blocks were not freed)87 511.2 R
(before the system crashed.)87 523.2 Q 1.699
(The \214nal step after a successful background `)72 538.8 R(`fsck')-.74
E(')-.74 E 6.05(run is to update the \214lesystem status in the)72 550.8
R 2.665(superblock. There)72 562.8 R .165(are tw)2.665 F 2.665<6f8d>-.1
G .165(ags in the superblock that)-2.665 F .159
(track the state of a \214lesystem.)72 574.8 R .159
(The \214rst is the `)5.159 F(`clean')-.74 E(')-.74 E .174
(\215ag that is set when a \214lesystem is unmounted \(by the)72 586.8 R
3.758(system administrator or at system shutdo)72 598.8 R 3.758
(wn\) and)-.25 F .22(cleared while it is mounted with writing enabled.)
72 610.8 R(The)5.22 E 6.282(second is the `)72 622.8 R
(`unclean-at-mount')-.74 E 8.782<278d>-.74 G 6.281(ag that is)-8.782 F
(described belo)72 634.8 Q -.65(w.)-.25 G 3.44(The `)97 650.4 R(`clean')
-.74 E 5.94<278d>-.74 G 3.44(ag is used by the traditional)-5.94 F -.74
(``)72 662.4 S(fsck').74 E 7.29('t)-.74 G 7.29(od)-7.29 G 4.79
(ecide which \214lesystems need to be)-7.29 F(check)72 674.4 Q 6.218
(ed. Those)-.1 F 3.719(\214lesystems with the \215ag set are)6.218 F
3.544(skipped; those \214lesystems with the \215ag clear are)72 686.4 R
(check)72 698.4 Q 3.916(ed. F)-.1 F(ollo)-.15 E 1.417
(wing a successful check, the `)-.25 F(`clean')-.74 E(')-.74 E 2.244
(\215ag is set.)72 710.4 R 2.243(Before soft updates, the k)7.244 F
2.243(ernel did not)-.1 F(allo)321.6 84 Q 4.36(wu)-.25 G 1.86
(nclean \214lesystems \(e.g., \214lesystems with the)-4.36 F -.74(``)
321.6 96 S(clean').74 E 2.772<278d>-.74 G .271
(ag cleared\) to be mounted for writing as the)-2.772 F
(corruption could cause the system to panic.)321.6 108 Q .376(The `)
346.6 123.6 R(`unclean-at-mount')-.74 E 2.876<278d>-.74 G .377(ag w)
-2.876 F .377(as added as part)-.1 F .052(of soft updates.)321.6 135.6 R
.051(Unclean \214lesystems running with soft)5.052 F 3.029
(updates are safe to mount with writing permitted.)321.6 147.6 R(Ho)
321.6 159.6 Q(we)-.25 E -.15(ve)-.25 G 3.029 -.4(r, t).15 H 2.229
(he system needs to remember that some).4 F 3.616
(cleanup may be required.)321.6 171.6 R 3.617(Thus, the `)8.617 F
(`unclean-at-)-.74 E(mount')321.6 183.6 Q 4.409<278d>-.74 G 1.909
(ag gets set when an unclean \214lesystem is)-4.409 F .8
(mounted \(e.g., mounted with writing enabled without)321.6 195.6 R
1.279(the `)321.6 207.6 R(`clean')-.74 E 3.779<278d>-.74 G 1.279(ag ha)
-3.779 F 1.279(ving been set\).)-.2 F 1.278(The `)6.278 F(`unclean-at-)
-.74 E(mount')321.6 219.6 Q 6.384<278d>-.74 G 3.884(ag serv)-6.384 F
3.884(es tw)-.15 F 6.384(op)-.1 G 6.384(urposes. First,)-6.384 F 3.885
(when a)6.385 F 12.198(\214lesystem with the `)321.6 231.6 R
(`unclean-at-mount')-.74 E 14.697('i)-.74 G(s)-14.697 E 1.56
(unmounted, the `)321.6 243.6 R(`clean')-.74 E 4.06<278d>-.74 G 1.56
(ag is not set to sho)-4.06 F 4.06(wt)-.25 G(hat)-4.06 E .567
(cleaning is still required.)321.6 255.6 R .566
(Second it tracks the \214lesys-)5.566 F .358(tems that need cleaning.)
321.6 267.6 R .359(By the time that background)5.359 F -.74(``)321.6
279.6 S(fsck').74 E 2.799('i)-.74 G 2.799(sr)-2.799 G .299
(un, all the \214lesystems are mounted so none)-2.799 F .857(will ha)
321.6 291.6 R 1.157 -.15(ve t)-.2 H .857(heir `).15 F(`clean')-.74 E
3.357<278d>-.74 G .858(ag set.)-3.357 F .858(Thus, the `)5.858 F
(`unclean-)-.74 E(at-mount')321.6 303.6 Q 3.833<278d>-.74 G 1.333
(ag is used by the background `)-3.833 F(`fsck')-.74 E 3.832('t)-.74 G
(o)-3.832 E 3.225(distinguish which \214lesystems need to be check)321.6
315.6 R(ed.)-.1 E .58(Those \214lesystems with the \215ag set are check)
321.6 327.6 R .58(ed; those)-.1 F
(\214lesystems with the \215ag clear are skipped.)321.6 339.6 Q 2.419
(So, the \214nal step after a successful run of a)346.6 355.2 R 5.115
(background `)321.6 367.2 R(`fsck')-.74 E 7.615('i)-.74 G 7.615(st)
-7.615 G 7.615(oc)-7.615 G 5.115(lear the `)-7.615 F(`unclean-at-)-.74 E
(mount')321.6 379.2 Q 4.061('b)-.74 G 1.561
(it in the superblock \(using operation 1\) so)-4.061 F .711
(that the \214lesystem will be mark)321.6 391.2 R .711(ed `)-.1 F
(`clean')-.74 E 3.211('w)-.74 G .711(hen it is)-3.211 F 1.32
(unmounted by the system administrator or at system)321.6 403.2 R
(shutdo)321.6 415.2 Q(wn.)-.25 E/F1 10/Times-Bold@0 SF(6.)321.6 439.2 Q
/F2 12/Times-Bold@0 SF(Operation of Backgr)5 E(ound `)-.216 E(`Fsck')
-.756 E(')-.756 E F0 -.35(Tr)346.6 454.8 S(aditionally).35 E 7.046(,`)
-.65 G(`fsck')-7.786 E 7.046('i)-.74 G 7.046(si)-7.046 G -1.9 -.4(nv o)
-7.046 H -.1(ke).4 G 7.046(db).1 G 4.546(efore the)-7.046 F 4.023
(\214lesystems are mounted and all checks are syn-)321.6 466.8 R .984
(chronously done to completion at that time.)321.6 478.8 R .983
(If back-)5.983 F .114(ground checking is a)321.6 490.8 R -.25(va)-.2 G
.114(ilable, `).25 F(`fsck')-.74 E 2.614('i)-.74 G 2.615(si)-2.614 G
-1.9 -.4(nv o)-2.615 H -.1(ke).4 G 2.615(dt).1 G(wice.)-2.615 E 1.939
(It is \214rst in)321.6 502.8 R -.2(vo)-.4 G -.1(ke).2 G 4.439(da).1 G
4.439(tt)-4.439 G 1.939(he traditional time, before the)-4.439 F .247
(\214lesystems are mounted, with the)321.6 514.8 R/F3 9/Times-Roman@0 SF
<ad46>2.748 E F0 .248(\215ag to do check-)2.748 F 1.26
(ing on all the \214lesystems that cannot do background)321.6 526.8 R
3.798(checking. Filesystems)321.6 538.8 R 1.298
(that require traditional check-)3.798 F 1.708
(ing are those that are not running with soft updates)321.6 550.8 R 1.15
(and those that will not be mounted at system startup)321.6 562.8 R .385
(\(e.g., those mark)321.6 574.8 R .385(ed `)-.1 F(`noauto')-.74 E 2.885
('i)-.74 G(n)-2.885 E F1(/etc/fstab)2.885 E F0 2.885(\). It)B .385
(is then)2.885 F(in)321.6 586.8 Q -.2(vo)-.4 G -.1(ke).2 G 2.635(das).1
G .135(econd time, after the system has completed)-2.635 F .079
(going multiuser)321.6 598.8 R 2.578(,w)-.4 G .078(ith the)-2.578 F F3
<ad42>2.578 E F0 .078(\215ag to do checking on all)2.578 F 3.673
(the \214lesystems that can do background checking.)321.6 610.8 R(Unlik)
321.6 622.8 Q 7.35(et)-.1 G 4.85(he fore)-7.35 F 4.85
(ground checking, the background)-.15 F 1.164
(checking is started asynchronously so that other sys-)321.6 634.8 R
.997(tem acti)321.6 646.8 R .996(vity can proceed e)-.25 F -.15(ve)-.25
G 3.496(no).15 G 3.496(nt)-3.496 G .996(he \214lesystems that)-3.496 F
(are being check)321.6 658.8 Q(ed.)-.1 E 1.657(The `)346.6 674.4 R
(`fsck')-.74 E 4.157('p)-.74 G 1.658(rogram is really just a front end)
-4.157 F 2.595(that reads the)321.6 686.4 R F1(/etc/fstab)5.094 E F0
2.594(\214le and determines which)5.094 F 1.438
(\214lesystems need to be check)321.6 698.4 R 3.939(ed. F)-.1 F 1.439
(or each \214lesystem)-.15 F 1.782(to be check)321.6 710.4 R 1.781
(ed, the appropriate back end is in)-.1 F -.2(vo)-.4 G -.1(ke).2 G(d.).1
E EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF -.15(Fo)72 84 S 5.912(rt).15 G 3.413(he f)-5.912
F 3.413(ast \214lesystem, `)-.1 F(`fsck_f)-.74 E(fs')-.25 E 5.913('i)
-.74 G 5.913(si)-5.913 G -1.9 -.4(nv o)-5.913 H -.1(ke).4 G 5.913(d. If)
.1 F -.74(``)72 96 S(fsck').74 E 2.974('i)-.74 G 2.973(si)-2.974 G -1.9
-.4(nv o)-2.973 H -.1(ke).4 G 2.973(dw).1 G .473(ith neither the)-2.973
F/F1 9/Times-Roman@0 SF<ad46>2.973 E F0 .473(nor the)2.973 F F1<ad42>
2.973 E F0(\215ag,)2.973 E 2.422
(it runs in traditional mode and checks e)72 108 R -.15(ve)-.25 G 2.423
(ry listed).15 F 5.017(\214lesystem. Otherwise)72 120 R 2.516(it is in)
5.017 F -.2(vo)-.4 G -.1(ke).2 G 5.016(dw).1 G 2.516(ith the)-5.016 F F1
<ad46>5.016 E F0(to)5.016 E .467(request that it run in fore)72 132 R
.468(ground mode.)-.15 F .468(In fore)5.468 F(ground)-.15 E 4.221
(mode, the check program for each \214lesystem is)72 144 R(in)72 156 Q
-.2(vo)-.4 G -.1(ke).2 G 5.782(dw).1 G 3.282(ith the)-5.782 F F1<ad46>
5.782 E F0 3.283(\215ag to determine whether it)5.782 F .726
(wishes to run as part of the boot up sequence, or if it)72 168 R .689
(is able to do its job in background after the system is)72 180 R .306
(up and running.)72 192 R 2.806(An)5.306 G .306(on-zero e)-2.806 F .305
(xit code indicates that it)-.15 F -.1(wa)72 204 S 2.189
(nts to run in fore).1 F 2.189(ground and it is in)-.15 F -.2(vo)-.4 G
-.1(ke).2 G 4.689(da).1 G -.05(ga)-4.689 G(in).05 E .024
(with neither the)72 216 R F1<ad46>2.523 E F0 .023(nor the)2.523 F F1
<ad42>2.523 E F0 .023(\215ag so that it will run in)2.523 F .427
(its traditional mode.)72 228 R 2.928(Az)5.428 G .428(ero e)-2.928 F
.428(xit code indicates that it)-.15 F .956
(is able to run later in background and just a deferred)72 240 R 1.06
(message is printed.)72 252 R 1.06(The `)6.06 F(`fsck')-.74 E 3.56('p)
-.74 G 1.06(rogram attempts to)-3.56 F .757(run as man)72 264 R 3.256
(yc)-.15 G .756(hecks in parallel as possible.)-3.256 F -.8(Ty)5.756 G
(pically).8 E(it can run a check on each disk in parallel.)72 276 Q .997
(After the system has gone multiuser)97 295.2 R 3.497(,`)-.4 G(`fsck')
-4.237 E 3.498('i)-.74 G(s)-3.498 E(in)72 307.2 Q -.2(vo)-.4 G -.1(ke).2
G 2.751(dw).1 G .251(ith the)-2.751 F F1<ad42>2.751 E F0 .251
(\215ag to request that it run in back-)2.751 F .294(ground mode.)72
319.2 R .294(The check program for each \214lesystem)5.294 F 1.899
(is in)72 331.2 R -.2(vo)-.4 G -.1(ke).2 G 4.399(dw).1 G 1.899(ith the)
-4.399 F F1<ad46>4.399 E F0 1.899(\215ag to determine whether it)4.399 F
.726(wishes to run as part of the boot up sequence, or if it)72 343.2 R
.689(is able to do its job in background after the system is)72 355.2 R
.305(up and running.)72 367.2 R 2.805(An)5.305 G .306(on-zero e)-2.805 F
.306(xit code indicates that it)-.15 F -.1(wa)72 379.2 S 1.281
(nted to run in fore).1 F 1.281(ground that is assumed to ha)-.15 F -.15
(ve)-.2 G 1.261(been done, so the \214lesystem is skipped.)72 391.2 R
3.761(Az)6.261 G 1.262(ero e)-3.761 F(xit)-.15 E 1.009
(code indicates that it is able to run in background so)72 403.2 R .304
(the check program is in)72 415.2 R -.2(vo)-.4 G -.1(ke).2 G 2.804(dw).1
G .304(ith the)-2.804 F F1<ad42>2.804 E F0 .304(\215ag to indi-)2.804 F
1.63(cate that a check on the acti)72 427.2 R 1.93 -.15(ve \214)-.25 H
1.63(lesystem should be).15 F 3.862(done. When)72 439.2 R 1.363
(running in background mode, only one)3.863 F 3.528
(\214lesystem at a time will be check)72 451.2 R 6.027(ed. T)-.1 F 6.027
(of)-.8 G(urther)-6.027 E .882
(reduce the load on the system, the background check)72 463.2 R
(is typically run at a)72 475.2 Q/F2 10/Times-Italic@0 SF(nice)2.5 E F0
-.25(va)2.5 G(lue of plus four).25 E(.)-.55 E .682(The `)97 494.4 R
(`fsck_f)-.74 E(fs')-.25 E 3.182('p)-.74 G .682
(rogram does the actual check-)-3.182 F .775(ing of the f)72 506.4 R
.776(ast \214lesystem.)-.1 F .776(When in)5.984 F -.2(vo)-.4 G -.1(ke).2
G 3.276(dw).1 G .776(ith the)-3.276 F F1<ad46>3.276 E F0 3.146
(\215ag, `)72 518.4 R(`fsck_f)-.74 E(fs')-.25 E 5.646('d)-.74 G 3.146
(etermines whether the \214lesystem)-5.646 F 1.156(needs to be check)72
530.4 R 1.156(ed immediately in fore)-.1 F 1.157(ground or if)-.15 F
2.034(its checking can be deferred to background.)72 542.4 R 3.634 -.8
(To b)7.242 H(e).8 E 1.93(eligible for background checking it must ha)72
554.4 R 2.23 -.15(ve b)-.2 H(een).15 E 1.631
(running with soft updates, not ha)72 566.4 R 1.931 -.15(ve b)-.2 H
1.631(een mark).15 F 1.631(ed as)-.1 F 3.054(needing a fore)72 578.4 R
3.054(ground check, and be mounted and)-.15 F .391
(writable when the background check is to be done.)72 590.4 R(If)5.599 E
.561(these conditions are met, then `)72 602.4 R(`fsck_f)-.74 E(fs')-.25
E 3.061('e)-.74 G .562(xits with a)-3.211 F 1.899(zero e)72 614.4 R
1.899(xit status.)-.15 F 1.899(Otherwise it e)7.107 F 1.899
(xits with a non-zero)-.15 F -.15(ex)72 626.4 S .71(it status.).15 F .71
(If the \214lesystem is clean, it will e)5.918 F .711(xit with)-.15 F
4.025(an)72 638.4 S 1.525(on-zero e)-4.025 F 1.525
(xit status so that the clean status of the)-.15 F 2.933
(\214lesystem can be v)72 650.4 R 2.933
(eri\214ed and reported during the)-.15 F(fore)72 662.4 Q .584
(ground checks.)-.15 F .583(Note that, when in)5.791 F -.2(vo)-.4 G -.1
(ke).2 G 3.083(dw).1 G .583(ith the)-3.083 F F1<ad46>72 674.4 Q F0 2.446
(\215ag, no checking is done.)4.945 F 2.446(The only thing that)7.654 F
-.74(``)72 686.4 S(fsck_f).74 E(fs')-.25 E 2.986('d)-.74 G .486
(oes is to determine whether a fore)-2.986 F(ground)-.15 E 3.505
(or background check is needed and e)72 698.4 R 3.505(xit with an)-.15 F
.208(appropriate status code.)72 710.4 R .564(When `)346.6 84 R(`fsck_f)
-.74 E(fs')-.25 E 3.064('i)-.74 G 3.064(si)-3.064 G -1.9 -.4(nv o)-3.064
H -.1(ke).4 G 3.064(dw).1 G .564(ith the)-3.064 F F1<ad42>3.064 E F0
.563(\215ag, a)3.064 F 2.492
(check is done on the speci\214ed and possibly acti)321.6 96 R -.15(ve)
-.25 G 3.345(\214lesystem. The)321.6 108 R .844
(potential set of corrections is limited)3.345 F 2.152(to those a)321.6
120 R -.25(va)-.2 G 2.153(ilable when running in preen mode \(as).25 F
3.129(further detailed in the pre)321.6 132 R 3.128(vious section\).)
-.25 F 3.128(If une)8.128 F(x-)-.15 E 1.659
(pected errors are found, the \214lesystem is mark)321.6 144 R 1.659
(ed as)-.1 F 3.787(needing a fore)321.6 156 R 3.787(ground check and `)
-.15 F(`fsck_f)-.74 E(fs')-.25 E 6.286('e)-.74 G(xits)-6.436 E
(without attempting an)321.6 168 Q 2.5(yf)-.15 G(urther checking.)-2.5 E
/F3 10/Times-Bold@0 SF(7.)321.6 192 Q/F4 12/Times-Bold@0 SF(Backgr)5 E
(ound `)-.216 E(`Fsck')-.756 E 3('P)-.756 G(erf)-3.24 E(ormance)-.3 E F0
(Ov)346.6 207.6 Q 3.631(er man)-.15 F 6.131(yy)-.15 G 3.632
(ears of tuning and re\214nement,)-6.131 F -.74(``)321.6 219.6 S(fsck')
.74 E 2.698('h)-.74 G .197
(as been optimized to minimize and cluster its)-2.698 F F1(I/O)321.6
231.6 Q F0 4.956(requests. Further)4.956 F 4.956(,i)-.4 G 2.456
(ts data structures ha)-4.956 F 2.757 -.15(ve b)-.2 H(een).15 E 1.118
(tuned to the point where it consumes little)321.6 243.6 R F1(CPU)3.618
E F0(time)3.618 E 1.087
(and thus its running time is totally dominated by the)321.6 255.6 R
1.619(time that it tak)321.6 267.6 R 1.618(es to do the needed)-.1 F F1
(I/O)4.118 E F0 6.618(.T)C 1.618(he perfor)-6.618 F(-)-.2 E 2.171
(mance of background `)321.6 279.6 R(`fsck')-.74 E 4.671('i)-.74 G 4.672
(sa)-4.671 G 2.172(lmost identical to)-4.672 F 1.934
(that of the traditional `)321.6 291.6 R(`fsck')-.74 E 4.433('. Since)
-.74 F 1.933(it is using the)4.433 F 2.227
(same algorithms, the number and pattern of its)321.6 303.6 R F1(I/O)
4.727 E F0 4.415(requests are identical to the traditional program.)
321.6 315.6 R 1.499(Though the update requests are done through k)321.6
327.6 R(ernel)-.1 E 1.504
(calls rather than direct writes to the disk, the k)321.6 339.6 R(ernel)
-.1 E .607(calls typically e)321.6 351.6 R -.15(xe)-.15 G .608
(cute the same \(or through the bene-).15 F 1.848
(\214ts of soft updates\) slightly fe)321.6 363.6 R 1.847
(wer disk writes.)-.25 F(The)6.847 E 1.519
(main added delay of background `)321.6 375.6 R(`fsck')-.74 E 4.019('i)
-.74 G 4.019(st)-4.019 G 1.519(he time)-4.019 F .582(required to tak)
321.6 387.6 R 3.081(ea)-.1 G .581(nd remo)-3.081 F .881 -.15(ve a s)-.15
H .581(napshot of the \214lesys-).15 F 3.207(tem. The)321.6 399.6 R .708
(time for the snapshot operation has already)3.207 F(been co)321.6 411.6
Q -.15(ve)-.15 G(red in section 4 abo).15 E -.15(ve)-.15 G(.).15 E .445
(Because of `)346.6 427.2 R(`fsck')-.74 E -1.57 -.74('' s)-.74 H F1(I/O)
3.685 E F0 .444(clustering, it is capable)2.945 F .472
(of using nearly all the bandwidth of a disk.)321.6 439.2 R(Although)
5.473 E 1.007(background `)321.6 451.2 R(`fsck')-.74 E 3.507('o)-.74 G
1.007(nly checks one \214lesystem parti-)-3.507 F .824
(tion at a time \(as compared to traditional `)321.6 463.2 R(`fsck')-.74
E 3.325('t)-.74 G(hat)-3.325 E .003
(checks all separate disks containing \214lesystems in par)321.6 475.2 R
(-)-.2 E .286(allel\), e)321.6 487.2 R -.15(ve)-.25 G 2.786(nas).15 G
.287(ingle instance of `)-2.786 F(`fsck')-.74 E 2.787('c)-.74 G .287
(an cause seri-)-2.787 F 1.348(ously increased latenc)321.6 499.2 R
3.847(yt)-.15 G 3.847(op)-3.847 G 1.347(rocesses trying to access)-3.847
F 1.291(\214les on the \214lesystem \(or an)321.6 511.2 R 1.291
(ything else on the same)-.15 F(disk\) that is being check)321.6 523.2 Q
(ed.)-.1 E .818(As there is no ur)346.6 538.8 R(genc)-.18 E 3.317(yi)
-.15 G 3.317(nc)-3.317 G .817(ompleting the space)-3.317 F 3.645
(reclamation, background `)321.6 550.8 R(`fsck')-.74 E 6.145('i)-.74 G
6.145(su)-6.145 G 3.645(sually run at)-6.145 F(lo)321.6 562.8 Q .474
(wer priority than other processes.)-.25 F .474(The usual w)5.474 F .473
(ay to)-.1 F .641(reduce priority is to)321.6 574.8 R F2(nice)3.141 E F0
.641(the process to some positi)3.141 F -.15(ve)-.25 G -.25(va)321.6
586.8 S 1.578(lue which results in it getting a lo).25 F 1.577
(wer priority for)-.25 F(the)321.6 598.8 Q F1(CPU)4.822 E F0 7.322(.B)C
2.322(ecause `)-7.322 F(`fsck')-.74 E 4.823('i)-.74 G 4.823(sn)-4.823 G
2.323(early completely)-4.823 F F1(I/O)4.823 E F0 1.452(bound, gi)321.6
610.8 R 1.452(ving it a lo)-.25 F(wer)-.25 E F1(CPU)3.952 E F0 1.451
(priority has almost no)3.952 F(ef)321.6 622.8 Q .076
(fect on the time in which it runs and hence in its rate)-.25 F
(of issuing)321.6 634.8 Q F1(I/O)2.5 E F0(requests.)2.5 E 1.404
(As a general solution to reducing the resource)346.6 650.4 R 2.944
(usage of)321.6 662.4 R F1(I/O)5.444 E F0 2.945
(bound processes such as background)5.445 F -.74(``)321.6 674.4 S(fsck')
.74 E 2.214(', a small change has been made to the disk)-.74 F(strate)
321.6 686.4 Q 1.482(gy routine.)-.15 F 1.483(When an)6.483 F F1(I/O)
3.983 E F0 1.483(request is posted, the)3.983 F 1.029(disk strate)321.6
698.4 R 1.029(gy routine \214rst checks whether the process)-.15 F .309
(is running at a positi)321.6 710.4 R -.15(ve)-.25 G F2(nice)2.959 E F0
5.309(.I)C 2.809(fi)-5.309 G 2.809(ti)-2.809 G .309(s, and there are an)
-2.809 F(y)-.15 E EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Roman@0 SF .145(other outstanding)72 84 R/F1 9
/Times-Roman@0 SF(I/O)2.644 E F0 .144
(requests for the disk, the process)2.644 F .482(is put to sleep for)72
96 R/F2 10/Times-Italic@0 SF(nice)2.982 E F0 .482
(hundredths of a second.)2.982 F(Thus,)5.482 E 2.94(ap)72 108 S .44
(rocess running at a)-2.94 F F2(nice)2.94 E F0 .44
(of four will sleep for forty)2.94 F 2.516(millisecond each time it mak)
72 120 R 2.517(es a disk)-.1 F F1(I/O)5.017 E F0(request.)5.017 E .746
(Such a process will be able to do at most twenty-\214v)72 132 R(e)-.15
E(disk)72 144 Q F1(I/O)4.468 E F0 1.968
(requests per second \255 about a third of the)4.468 F .429
(bandwidth of a current technology disk.)72 156 R .428(At the maxi-)
5.429 F(mum)72 168 Q F2(nice)3.03 E F0 -.25(va)3.03 G .53(lue of twenty)
.25 F 3.03(,ap)-.65 G .53(rocess is limited to \214v)-3.03 F(e)-.15 E F1
(I/O)72 180 Q F0 2.008(requests per second which is lo)4.509 F 4.508(we)
-.25 G 2.008(nough to be)-4.508 F .48
(almost unnoticeable by other processes competing for)72 192 R .144
(access to the disk.)72 204 R .144(Because the slo)5.144 F(w-do)-.25 E
.143(wn is imposed)-.25 F 1.443
(only when there are other outstanding disk requests,)72 216 R F1(I/O)72
228 Q F0 .387(bound processes can run at full speed on an other)2.888 F
(-)-.2 E(wise idle system.)72 240 Q .4 LW 253.14 254.1 109.26 254.1 DL
13.055(Filesystem Elapsed)114.26 263.6 R(CPU)19.715 E 31.565(Size T)
127.32 275.6 R 22.01(ime T)-.35 F(ime)-.35 E 26.81(0.5Gb 5.8)123.57
287.6 R 12.5(sec 1.1)2.5 F(sec)2.5 E 21.81(7.7Gb 50.9)123.57 299.6 R
12.5(sec 8.3)2.5 F(sec)2.5 E 253.14 304.1 109.26 304.1 DL 253.14 254.1
253.14 304.1 DL 109.26 254.1 109.26 304.1 DL/F3 10/Times-Bold@0 SF -.92
(Ta)77.94 317.6 S(ble 5).92 E F0(:)A F2 -1.55 -.55(Tr a)2.5 H
(ditional fsc).55 E 2.5(kt)-.2 G(imes on an idle \214lesystem)-2.5 E F0
-.8(Ta)97 341.6 S 1.668(ble 5 sho).8 F 1.669
(ws the times to run the traditional)-.25 F -.74(``)72 353.6 S(fsck').74
E 4.619('o)-.74 G 4.619(na\214)-4.619 G 2.119
(lesystem that is otherwise idle.)-4.619 F 2.118(It is)7.119 F .865
(running with a)72 365.6 R F2(nice)3.365 E F0 -.25(va)3.365 G .865
(lue of zero.).25 F .866(It is the only pro-)5.866 F .208(cess acti)72
377.6 R .508 -.15(ve o)-.25 H 2.708(nt).15 G .208
(he system, so represents a lo)-2.708 F .207(wer bound)-.25 F
(on the time that a traditional disk check can be done.)72 389.6 Q
282.025 403.7 80.375 403.7 DL 13.055(Filesystem Elapsed)85.375 413.2 R
21.1(CPU Suspend)22.215 F 31.565(Size T)98.435 425.2 R 24.51(ime T)-.35
F 27.01(ime T)-.35 F(ime)-.35 E 26.81(0.5Gb 8.1)94.685 437.2 R 17.5
(sec 2.5)2.5 F 12.5(sec 0.025)2.5 F(sec)2.5 E 21.81(7.7Gb 61.5)94.685
449.2 R 12.5(sec 14.9)2.5 F 12.5(sec 0.050)2.5 F(sec)2.5 E 282.025 453.7
80.375 453.7 DL 282.025 403.7 282.025 453.7 DL 80.375 403.7 80.375 453.7
DL F3 -.92(Ta)76.26 467.2 S(ble 6).92 E F0(:)A F2(Bac)2.5 E(kgr)-.2 E
(ound fsc)-.45 E 2.5(kt)-.2 G(imes on an idle \214lesystem)-2.5 E F0 -.8
(Ta)97 491.2 S 3.138(ble 6 sho).8 F 3.139
(ws the times to run background)-.25 F -.74(``)72 503.2 S(fsck').74 E
2.533('o)-.74 G 2.533(na\214)-2.533 G .033
(lesystem that is otherwise idle.)-2.533 F .032(It is run-)4.615 F .903
(ning with a)72 515.2 R F2(nice)3.403 E F0 -.25(va)3.403 G .903
(lue of zero.).25 F .904(It is the only process)5.486 F(acti)72 527.2 Q
1.248 -.15(ve o)-.25 H 3.448(nt).15 G .948
(he system, so represents a lo)-3.448 F .947(wer bound on)-.25 F 1.556
(the time that a background disk check can be done.)72 539.2 R .409
(Note that its running time is only slightly greater than)72 551.2 R -.1
(wo)72 563.2 S 2.241(uld be e).1 F 2.241
(xpected by adding the time to tak)-.15 F 4.742(ea)-.1 G(nd)-4.742 E
(remo)72 575.2 Q .055 -.15(ve a s)-.15 H -.245(napshot \(see T).15 F
-.245(able 1 and T)-.8 F -.246(able 3\) to the run-)-.8 F -.417
(ning time of the traditional `)72 587.2 R(`fsck')-.74 E 2.083('s)-.74 G
(ho)-2.083 E -.417(wn in T)-.25 F -.417(able 5.)-.8 F 281.47 601.3 80.93
601.3 DL 12.5(Filesystem Elapsed)85.93 610.8 R 21.1(CPU Suspend)21.66 F
31.01(Size T)98.99 622.8 R 23.955(ime T)-.35 F 27.01(ime T)-.35 F(ime)
-.35 E 22.505(0.5Gb 122)95.24 634.8 R 18.195(sec 2.9)2.5 F 12.5
(sec 0.025)2.5 F(sec)2.5 E 22.505(7.7Gb 591)95.24 646.8 R 13.195
(sec 16.2)2.5 F 12.5(sec 0.050)2.5 F(sec)2.5 E 281.47 651.3 80.93 651.3
DL 281.47 601.3 281.47 651.3 DL 80.93 601.3 80.93 651.3 DL F3 -.92(Ta)72
664.8 S(ble 7).92 E F0(:)A F2(Bac)2.5 E(kgr)-.2 E(ound fsc)-.45 E 2.5
(kt)-.2 G(imes on an active \214lesystem)-2.5 E F0 -.8(Ta)97 688.8 S
3.138(ble 7 sho).8 F 3.139(ws the times to run background)-.25 F -.74
(``)72 700.8 S(fsck').74 E 2.657('o)-.74 G 2.657(na)-2.657 G .156
(\214lesystem that has four processes concur)-.001 F(-)-.2 E .711
(rently writing to it.)72 712.8 R .712(It is running with a)5.712 F F2
(nice)3.212 E F0 -.25(va)3.212 G .712(lue of).25 F(four)321.6 84 Q 5.856
(.N)-.55 G .856(ote that its running time increases by a f)-5.856 F
(actor)-.1 E .703
(of ten as it is yielding to the other running processes.)321.6 96 R
.965(By contrast, its ef)321.6 108 R .964
(fect on the other processes is mini-)-.25 F 1.803(mal as their aggre)
321.6 120 R -.05(ga)-.15 G 1.804(te throughput is slo).05 F 1.804
(wed by less)-.25 F(than ten percent.)321.6 132 Q F3(8.)321.6 163.2 Q/F4
12/Times-Bold@0 SF(Conclusions and Futur)5 E 3(eW)-.216 G(ork)-3.9 E F0
.58(This paper has described ho)346.6 178.8 R 3.08(wt)-.25 G 3.08(ot)
-3.08 G(ak)-3.08 E 3.08(es)-.1 G(napshots)-3.08 E 1.528(of the f)321.6
190.8 R 1.529(ast \214lesystem with suspension interv)-.1 F 1.529
(als typi-)-.25 F .29
(cally less than one second and independent of the size)321.6 202.8 R
2.143(of the \214lesystem being snapshotted.)321.6 214.8 R 2.144
(When running)7.144 F 1.121
(with soft updates, the only \214lesystem corruption that)321.6 226.8 R
1.645(occurs is the loss of inodes and data blocks.)321.6 238.8 R(Using)
6.646 E .547(snapshots together with a slightly modi\214ed v)321.6 250.8
R .547(ersion of)-.15 F .547(the traditional `)321.6 262.8 R(`fsck')-.74
E 3.048('i)-.74 G 3.048(ti)-3.048 G 3.048(sp)-3.048 G .548
(ossible to reco)-3.048 F -.15(ve)-.15 G 3.048(rt).15 G .548(he lost)
-3.048 F 3.204(inodes and data blocks while the \214lesystem is in)321.6
274.8 R(acti)321.6 286.8 Q 2.426 -.15(ve u)-.25 H 4.626(se. While).15 F
4.626(ab)4.626 G 2.126(ackground `)-4.626 F(`fsck')-.74 E 4.626('c)-.74
G 2.127(an run in)-4.626 F 4.178
(about the same amount of time as a traditional)321.6 298.8 R -.74(``)
321.6 310.8 S(fsck').74 E 1.601
(', it is generally desirable to run it at a lo)-.74 F(wer)-.25 E .837
(priority so that it causes less slo)321.6 322.8 R(wdo)-.25 E .836
(wn on other pro-)-.25 F(cesses on the system.)321.6 334.8 Q 1.427
(Snapshots may seem a more comple)346.6 350.4 R 3.927(xs)-.15 G(olution)
-3.927 E 2.096(to the problem of running space reclamation on an)321.6
362.4 R(acti)321.6 374.4 Q 6.233 -.15(ve \214)-.25 H 5.933
(lesystem than a more straight forw).15 F(ard)-.1 E -.05(ga)321.6 386.4
S 1.038(rbage-collection utility).05 F 6.038(.H)-.65 G -.25(ow)-6.038 G
-2.15 -.25(ev e).25 H 1.838 -.4(r, t).25 H 1.038(heir cost \(about).4 F
.57(1300 lines of code\) is amortized o)321.6 398.4 R -.15(ve)-.15 G
3.07(rt).15 G .57(he other useful)-3.07 F .06
(functionality: the ability to do reliable dumps of acti)321.6 410.4 R
-.15(ve)-.25 G .862(\214lesystems and the ability to pro)321.6 422.4 R
.863(vide back-ups of the)-.15 F(\214lesystem at se)321.6 434.4 Q -.15
(ve)-.25 G(ral times during the day).15 E(.)-.65 E -.15(Fo)346.6 450 S
4.12(rt).15 G 1.62(he future, I need to g)-4.12 F 1.62(ain e)-.05 F 1.62
(xperience with)-.15 F 2.217(using background `)321.6 462 R(`fsck')-.74
E 2.217(', to g)-.74 F 2.217(ain con\214dence in its)-.05 F(rob)321.6
474 Q 1.734(ustness, and to \214nd the optimal priority to mini-)-.2 F
.832(mize its slo)321.6 486 R(wdo)-.25 E .833
(wn on the system while still \214nishing)-.25 F
(its job in a reasonable amount of time.)321.6 498 Q F3(9.)321.6 529.2 Q
F4(Curr)5 E(ent Status)-.216 E F0 2.556(Snapshots and background `)346.6
544.8 R(`fsck')-.74 E 5.056('h)-.74 G -2.25 -.2(av e)-5.056 H(been)5.256
E 2.034(running on FreeBSD 5.0 systems since April 2001.)321.6 556.8 R
1.282(All the rele)321.6 568.8 R -.25(va)-.25 G 1.281
(nt code including snapshots, the g).25 F(ating)-.05 E 2.754
(functions, the system call additions for the use of)321.6 580.8 R -.74
(``)321.6 592.8 S(fsck').74 E .549(', and the changes to `)-.74 F
(`fsck')-.74 E 3.049('i)-.74 G .548(tself are a)-3.049 F -.25(va)-.2 G
(ilable).25 E(as open-source under a Berk)321.6 604.8 Q(ele)-.1 E
(y-style cop)-.15 E(yright.)-.1 E F3(10.)321.6 636 Q F4(Ackno)5 E
(wledgments)-.12 E F0 3.95(It)346.6 651.6 S 1.45(hank Rob K)-3.95 F 1.45
(olstad for his helpful comments)-.35 F .086(and re)321.6 663.6 R(vie)
-.25 E 2.586(wo)-.25 G 2.586(fd)-2.586 G .086(rafts of this paper)-2.586
F 5.086(.H)-.55 G 2.586(ep)-5.086 G .086(ointed out se)-2.586 F(v-)-.25
E .145(eral non-ob)321.6 675.6 R .145(vious g)-.15 F .145(aps in the co)
-.05 F -.15(ve)-.15 G 2.645(rage. Thanks).15 F .145(also to)2.645 F
(Matthe)321.6 687.6 Q 3.436(wD)-.25 G .936(illon, Ian Do)-3.436 F .936
(wse, Peter W)-.25 F .935(emm, and man)-.8 F(y)-.15 E .56
(other FreeBSD de)321.6 699.6 R -.15(ve)-.25 G .56
(lopers that put up with my k).15 F(ernel)-.1 E
(breakage and helped track do)321.6 711.6 Q(wn the b)-.25 E(ugs.)-.2 E
EP
%%Page: 10 10
%%BeginPageSetup
BP
%%EndPageSetup
/F0 10/Times-Bold@0 SF(11.)72 84 Q/F1 12/Times-Bold@0 SF(Refer)5 E
(ences)-.216 E/F2 10/Times-Roman@0 SF(Ganger et al, 2000.)72 99.6 Q .537
(G. Ganger)97 111.6 R 3.037(,M)-.4 G 3.036(.M)-3.037 G(cK)-3.036 E .536
(usick, C. Soules, & Y)-.15 F 3.036(.P)-1.29 G(att,)-3.186 E 3.902
(\231Soft Updates: A Solution to the Metadata)97 123.6 R .132
(Update Problem in Filesystems,)97 135.6 R<9a>-.7 E/F3 10/Times-Italic@0
SF -.3(AC)2.632 G 2.632(MT).3 G -.15(ra)-3.182 G(nsac-).15 E 4.025
(tions on Computer Systems,)97 147.6 R F2 4.025(2, p. 127\255153)6.525 F
(\(May 2000\).)97 159.6 Q(Hitz et al, 1994.)72 175.2 Q 1.536
(D. Hitz, J. Lau, & M. Malcolm, \231File System)97 187.2 R .2
(Design for an NFS File Serv)97 199.2 R .2(er Appliance,)-.15 F<9a>-.7 E
F3(Pr)2.7 E(o-)-.45 E .535(ceedings of the San F)97 211.2 R -.15(ra)-.55
G .535(ncisco USENIX Confer).15 F(-)-.2 E(ence)97 223.2 Q(,)-.1 E F2
(p. 235\255246 \(January 1994\).)2.5 E(Ho)72 238.8 Q -.1(wa)-.25 G
(rd et al, 1988.).1 E 1.828(J. Ho)97 250.8 R -.1(wa)-.25 G 1.828
(rd, M. Kazar).1 F 4.329(,S)-.4 G 4.329(.M)-4.329 G 1.829
(enees, D. Nichols,)-4.329 F .055
(M. Satyanarayanan, R. Sidebotham, & M. W)97 262.8 R(est,)-.8 E 1.995
(\231Scale and Performance in a Distrib)97 274.8 R 1.995(uted Sys-)-.2 F
(tem,)97 286.8 Q<9a>-.7 E F3 -.3(AC)3.132 G 3.132(MT).3 G -.15(ra)-3.682
G .632(nsactions on Computer Systems,).15 F F2
(6, 1, p. 51\25581 \(February 1988\).)97 298.8 Q
(Hutchinson et al, 1999.)72 314.4 Q 1.675(N. Hutchinson, S. Manle)97
326.4 R 2.975 -.65(y, M)-.15 H 4.175(.F).65 G 1.675(ederwisch, G.)-4.175
F 2.983(Harris, D. Hitz, S. Kleiman, & S. OMalle)97 338.4 R -.65(y,)-.15
G 3.776(\231Logical vs. Ph)97 350.4 R 3.776(ysical File System Backup,)
-.05 F<9a>-.7 E F3(Thir)97 362.4 Q(d)-.37 E/F4 9/Times-Italic@0 SF
(USENIX)5.475 E F3 2.975(Symposium on Oper)5.475 F 2.974(ating Sys-)-.15
F 2.166(tems Design and Implementation,)97 374.4 R F2 2.166
(p. 239\255250)4.666 F(\(February 1999\).)97 386.4 Q(McK)72 402 Q
(usick, et al., 1996.)-.15 E .368(M. McK)97 414 R .367
(usick, K. Bostic, M. Karels, & J. Quar)-.15 F(-)-.2 E(terman,,)97 426 Q
F3 .755(The Design and Implementation of the)3.255 F 1.974(4.4BSD Oper)
97 438 R 1.974(ating System,)-.15 F F2 1.974(p. 269\255271, Addi-)4.474
F .53(son W)97 450 R(esle)-.8 E 3.03(yP)-.15 G .53(ublishing Compan)
-3.03 F 1.83 -.65(y, R)-.15 H .53(eading, MA).65 F(\(1996\).)97 462 Q
(McK)72 477.6 Q(usick & Ganger)-.15 E 2.5(,1)-.4 G(999.)-2.5 E 1.442
(M. McK)97 489.6 R 1.442(usick & G. Ganger)-.15 F 3.941<2c99>-.4 G 1.441
(Soft Updates: A)-3.941 F -.7(Te)97 501.6 S 2.555
(chnique for Eliminating Most Synchronous).7 F .393(Writes in the F)97
513.6 R .393(ast Filesystem,)-.15 F<9a>-.7 E F3 -1.77 -.55(Fr e)2.893 H
.393(enix T).55 F -.15(ra)-.55 G .792 -.2(ck a).15 H(t).2 E 2.27
(the Annual USENIX T)97 525.6 R(ec)-.92 E 2.27(hnical Confer)-.15 F
(ence)-.37 E(,)-.1 E F2(p.)4.77 E(1\25517 \(June 1999\).)97 537.6 Q(McK)
72 553.2 Q(usick & K)-.15 E -2.1 -.25(ow a)-.35 H(lski, 1994.).25 E
2.699(M. McK)97 565.2 R 2.699(usick & T)-.15 F 5.199(.K)-.74 G -2.1 -.25
(ow a)-5.549 H 2.698(lski, \231FSCK - The).25 F 1.89
(UNIX File System Check Program,)97 577.2 R<9a>-.7 E F3 1.89(4.4 BSD)
4.39 F 1.454(System Mana)97 589.2 R -.1(ge)-.1 G(r').1 E 3.954(sM)-.4 G
(anual,)-3.954 E F2 1.454(p. 3:1\25521, O'Reil-)3.954 F(le)97 601.2 Q
4.298(y&A)-.15 G 1.798(ssociates, Inc., Sebastopol, CA \(April)-4.298 F
(1994\).)97 613.2 Q(Seltzer et al, 2000.)72 628.8 Q .268(M. Seltzer)97
640.8 R 2.767(,G)-.4 G 2.767(.G)-2.767 G(anger)-2.767 E 2.767(,M)-.4 G
2.767(.M)-2.767 G(cK)-2.767 E .267(usick, K. Smith,)-.15 F 1.26
(C. Soules, & C. Stein, \231Journaling v)97 652.8 R 1.26(ersus Soft)-.15
F .163(Updates: Asynchronous Meta-data Protection in)97 664.8 R 2.446
(File Systems,)97 676.8 R<9a>-.7 E F3(Pr)4.946 E 2.447
(oceedings of the San Die)-.45 F(go)-.4 E(USENIX Confer)97 688.8 Q(ence)
-.37 E(,)-.1 E F2(p. 71\25584 \(June 2000\).)2.5 E F0(12.)321.6 84 Q F1
(Biograph)5 E(y)-.18 E F2(Dr)346.6 99.6 Q 3.79(.M)-.55 G 1.29
(arshall Kirk McK)-3.79 F 1.29(usick writes books and)-.15 F 1.406
(articles, consults, and teaches classes on UNIX- and)321.6 111.6 R .309
(BSD-related subjects. While at the Uni)321.6 123.6 R -.15(ve)-.25 G
.308(rsity of Cali-).15 F 1.704(fornia at Berk)321.6 135.6 R(ele)-.1 E
3.004 -.65(y, h)-.15 H 4.204(ei).65 G 1.705(mplemented the 4.2BSD f)
-4.204 F(ast)-.1 E 1.189(\214lesystem, and w)321.6 147.6 R 1.188
(as the Research Computer Scientist)-.1 F 2.095(at the Berk)321.6 159.6
R(ele)-.1 E 4.595(yC)-.15 G 2.095(omputer Systems Research Group)-4.595
F 2.265(\(CSRG\) o)321.6 171.6 R -.15(ve)-.15 G 2.265(rseeing the de).15
F -.15(ve)-.25 G 2.265(lopment and release of).15 F 1.363
(4.3BSD and 4.4BSD. His particular areas of interest)321.6 183.6 R .649
(are the virtual-memory system and the \214lesystem. He)321.6 195.6 R
2.206(earned his under)321.6 207.6 R 2.207(graduate de)-.18 F 2.207
(gree in Electrical Engi-)-.15 F .64(neering from Cornell Uni)321.6
219.6 R -.15(ve)-.25 G(rsity).15 E 3.14(,a)-.65 G .64
(nd did his graduate)-3.14 F -.1(wo)321.6 231.6 S 3.627(rk at the Uni).1
F -.15(ve)-.25 G 3.627(rsity of California at Berk).15 F(ele)-.1 E -.65
(y,)-.15 G 2.063(where he earned Masters de)321.6 243.6 R 2.063
(grees in Computer Sci-)-.15 F .807
(ence and Business Administration, and a doctorate in)321.6 255.6 R .743
(Computer Science. He is a past president and present)321.6 267.6 R
2.339(board member of the Usenix Association, and is a)321.6 279.6 R
(member of A)321.6 291.6 Q(CM and IEEE.)-.4 E 1.653
(In his spare time, he enjo)346.6 307.2 R 1.653(ys swimming, scuba)-.1 F
(di)321.6 319.2 Q 1.55
(ving, and wine collecting. The wine is stored in a)-.25 F 3.858
(specially constructed wine cellar \(accessible from)321.6 331.2 R 6.263
(the web at http://www)321.6 343.2 R(.mckusick.com/~mckusick/\))-.65 E
3.004(in the basement of the house that he shares with)321.6 355.2 R
2.378(Eric Allman, his domestic partner of 20-and-some-)321.6 367.2 R
4.968(odd years.)321.6 379.2 R -1.1(Yo)11.426 G 7.468(uc)1.1 G 4.968
(an contact him via email at)-7.468 F/F5 10/Courier@0 SF
(<mckusick@mckusick.com>)321.6 391.2 Q F2(.)A EP
%%Trailer
end
%%EOF
