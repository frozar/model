%!PS-Adobe-2.0
%%Creator: dvipsk 5.58f Copyright 1986, 1994 Radical Eye Software
%%Title: diss.dvi
%%Pages: 270
%%PageOrder: Ascend
%%BoundingBox: 0 0 612 792
%%DocumentFonts: Times-Roman Times-Italic Times-Bold Courier
%%+ Courier-Bold
%%DocumentPaperSizes: Letter
%%EndComments
%DVIPSCommandLine: dvips -o /tmp/diss.ps diss
%DVIPSParameters: dpi=600, comments removed
%DVIPSSource:  TeX output 1998.08.05:1833
%%BeginProcSet: tex.pro
/TeXDict 250 dict def TeXDict begin /N{def}def /B{bind def}N /S{exch}N
/X{S N}B /TR{translate}N /isls false N /vsize 11 72 mul N /hsize 8.5 72
mul N /landplus90{false}def /@rigin{isls{[0 landplus90{1 -1}{-1 1}
ifelse 0 0 0]concat}if 72 Resolution div 72 VResolution div neg scale
isls{landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div
hsize mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul
TR[matrix currentmatrix{dup dup round sub abs 0.00001 lt{round}if}
forall round exch round exch]setmatrix}N /@landscape{/isls true N}B
/@manualfeed{statusdict /manualfeed true put}B /@copies{/#copies X}B
/FMat[1 0 0 -1 0 0]N /FBB[0 0 0 0]N /nn 0 N /IE 0 N /ctr 0 N /df-tail{
/nn 8 dict N nn begin /FontType 3 N /FontMatrix fntrx N /FontBBox FBB N
string /base X array /BitMaps X /BuildChar{CharBuilder}N /Encoding IE N
end dup{/foo setfont}2 array copy cvx N load 0 nn put /ctr 0 N[}B /df{
/sf 1 N /fntrx FMat N df-tail}B /dfs{div /sf X /fntrx[sf 0 0 sf neg 0 0]
N df-tail}B /E{pop nn dup definefont setfont}B /ch-width{ch-data dup
length 5 sub get}B /ch-height{ch-data dup length 4 sub get}B /ch-xoff{
128 ch-data dup length 3 sub get sub}B /ch-yoff{ch-data dup length 2 sub
get 127 sub}B /ch-dx{ch-data dup length 1 sub get}B /ch-image{ch-data
dup type /stringtype ne{ctr get /ctr ctr 1 add N}if}B /id 0 N /rw 0 N
/rc 0 N /gp 0 N /cp 0 N /G 0 N /sf 0 N /CharBuilder{save 3 1 roll S dup
/base get 2 index get S /BitMaps get S get /ch-data X pop /ctr 0 N ch-dx
0 ch-xoff ch-yoff ch-height sub ch-xoff ch-width add ch-yoff
setcachedevice ch-width ch-height true[1 0 0 -1 -.1 ch-xoff sub ch-yoff
.1 sub]{ch-image}imagemask restore}B /D{/cc X dup type /stringtype ne{]}
if nn /base get cc ctr put nn /BitMaps get S ctr S sf 1 ne{dup dup
length 1 sub dup 2 index S get sf div put}if put /ctr ctr 1 add N}B /I{
cc 1 add D}B /bop{userdict /bop-hook known{bop-hook}if /SI save N @rigin
0 0 moveto /V matrix currentmatrix dup 1 get dup mul exch 0 get dup mul
add .99 lt{/QV}{/RV}ifelse load def pop pop}N /eop{SI restore userdict
/eop-hook known{eop-hook}if showpage}N /@start{userdict /start-hook
known{start-hook}if pop /VResolution X /Resolution X 1000 div /DVImag X
/IE 256 array N 0 1 255{IE S 1 string dup 0 3 index put cvn put}for
65781.76 div /vsize X 65781.76 div /hsize X}N /p{show}N /RMat[1 0 0 -1 0
0]N /BDot 260 string N /rulex 0 N /ruley 0 N /v{/ruley X /rulex X V}B /V
{}B /RV statusdict begin /product where{pop product dup length 7 ge{0 7
getinterval dup(Display)eq exch 0 4 getinterval(NeXT)eq or}{pop false}
ifelse}{false}ifelse end{{gsave TR -.1 .1 TR 1 1 scale rulex ruley false
RMat{BDot}imagemask grestore}}{{gsave TR -.1 .1 TR rulex ruley scale 1 1
false RMat{BDot}imagemask grestore}}ifelse B /QV{gsave newpath transform
round exch round exch itransform moveto rulex 0 rlineto 0 ruley neg
rlineto rulex neg 0 rlineto fill grestore}B /a{moveto}B /delta 0 N /tail
{dup /delta X 0 rmoveto}B /M{S p delta add tail}B /b{S p tail}B /c{-4 M}
B /d{-3 M}B /e{-2 M}B /f{-1 M}B /g{0 M}B /h{1 M}B /i{2 M}B /j{3 M}B /k{
4 M}B /w{0 rmoveto}B /l{p -4 w}B /m{p -3 w}B /n{p -2 w}B /o{p -1 w}B /q{
p 1 w}B /r{p 2 w}B /s{p 3 w}B /t{p 4 w}B /x{0 S rmoveto}B /y{3 2 roll p
a}B /bos{/SS save N}B /eos{SS restore}B end
%%EndProcSet
%%BeginFont: Times-Roman
% @@psencodingfile@{
%   author = "S. Rahtz, P. MacKay, Alan Jeffrey, B. Horn, K. Berry",
%   version = "0.6",
%   date = "22 June 1996",
%   filename = "8r.enc",
%   email = "kb@@mail.tug.org",
%   address = "135 Center Hill Rd. // Plymouth, MA 02360",
%   codetable = "ISO/ASCII",
%   checksum = "119     662    4424",
%   docstring = "Encoding for TrueType or Type 1 fonts to be used with TeX."
% @}
% 
% Idea is to have all the characters normally included in Type 1 fonts
% available for typesetting. This is effectively the characters in Adobe
% Standard Encoding + ISO Latin 1 + extra characters from Lucida.
% 
% Character code assignments were made as follows:
% 
% (1) the Windows ANSI characters are almost all in their Windows ANSI
% positions, because some Windows users cannot easily reencode the
% fonts, and it makes no difference on other systems. The only Windows
% ANSI characters not available are those that make no sense for
% typesetting -- rubout (127 decimal), nobreakspace (160), softhyphen
% (173). quotesingle and grave are moved just because it's such an
% irritation not having them in TeX positions.
% 
% (2) Remaining characters are assigned arbitrarily to the lower part
% of the range, avoiding 0, 10 and 13 in case we meet dumb software.
% 
% (3) Y&Y Lucida Bright includes some extra text characters; in the
% hopes that other PostScript fonts, perhaps created for public
% consumption, will include them, they are included starting at 0x12.
% 
% (4) Remaining positions left undefined are for use in (hopefully)
% upward-compatible revisions, if someday more characters are generally
% available.
% 
% (5) hyphen appears twice for compatibility with both ASCII and Windows.
% 
/TeXBase1Encoding [
% 0x00 (encoded characters from Adobe Standard not in Windows 3.1)
  /.notdef /dotaccent /fi /fl
  /fraction /hungarumlaut /Lslash /lslash
  /ogonek /ring /.notdef
  /breve /minus /.notdef 
% These are the only two remaining unencoded characters, so may as
% well include them.
  /Zcaron /zcaron 
% 0x10
 /caron /dotlessi 
% (unusual TeX characters available in, e.g., Lucida Bright)
 /dotlessj /ff /ffi /ffl 
 /.notdef /.notdef /.notdef /.notdef
 /.notdef /.notdef /.notdef /.notdef
 % very contentious; it's so painful not having quoteleft and quoteright
 % at 96 and 145 that we move the things normally found there down to here.
 /grave /quotesingle 
% 0x20 (ASCII begins)
 /space /exclam /quotedbl /numbersign
 /dollar /percent /ampersand /quoteright
 /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
% 0x30
 /zero /one /two /three /four /five /six /seven
 /eight /nine /colon /semicolon /less /equal /greater /question
% 0x40
 /at /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O
% 0x50
 /P /Q /R /S /T /U /V /W
 /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
% 0x60
 /quoteleft /a /b /c /d /e /f /g /h /i /j /k /l /m /n /o
% 0x70
 /p /q /r /s /t /u /v /w
 /x /y /z /braceleft /bar /braceright /asciitilde
 /.notdef % rubout; ASCII ends
% 0x80
 /.notdef /.notdef /quotesinglbase /florin
 /quotedblbase /ellipsis /dagger /daggerdbl
 /circumflex /perthousand /Scaron /guilsinglleft
 /OE /.notdef /.notdef /.notdef
% 0x90
 /.notdef /.notdef /.notdef /quotedblleft
 /quotedblright /bullet /endash /emdash
 /tilde /trademark /scaron /guilsinglright
 /oe /.notdef /.notdef /Ydieresis
% 0xA0
 /.notdef % nobreakspace
 /exclamdown /cent /sterling
 /currency /yen /brokenbar /section
 /dieresis /copyright /ordfeminine /guillemotleft
 /logicalnot
 /hyphen % Y&Y (also at 45); Windows' softhyphen
 /registered
 /macron
% 0xD0
 /degree /plusminus /twosuperior /threesuperior
 /acute /mu /paragraph /periodcentered
 /cedilla /onesuperior /ordmasculine /guillemotright
 /onequarter /onehalf /threequarters /questiondown
% 0xC0
 /Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla
 /Egrave /Eacute /Ecircumflex /Edieresis
 /Igrave /Iacute /Icircumflex /Idieresis
% 0xD0
 /Eth /Ntilde /Ograve /Oacute
 /Ocircumflex /Otilde /Odieresis /multiply
 /Oslash /Ugrave /Uacute /Ucircumflex
 /Udieresis /Yacute /Thorn /germandbls
% 0xE0
 /agrave /aacute /acircumflex /atilde
 /adieresis /aring /ae /ccedilla
 /egrave /eacute /ecircumflex /edieresis
 /igrave /iacute /icircumflex /idieresis
% 0xF0
 /eth /ntilde /ograve /oacute
 /ocircumflex /otilde /odieresis /divide
 /oslash /ugrave /uacute /ucircumflex
 /udieresis /yacute /thorn /ydieresis
] def
%%EndFont
%%BeginProcSet: texps.pro
TeXDict begin /rf{findfont dup length 1 add dict begin{1 index /FID ne 2
index /UniqueID ne and{def}{pop pop}ifelse}forall[1 index 0 6 -1 roll
exec 0 exch 5 -1 roll VResolution Resolution div mul neg 0 0]/Metrics
exch def dict begin Encoding{exch dup type /integertype ne{pop pop 1 sub
dup 0 le{pop}{[}ifelse}{FontMatrix 0 get div Metrics 0 get div def}
ifelse}forall Metrics /Metrics currentdict end def[2 index currentdict
end definefont 3 -1 roll makefont /setfont load]cvx def}def
/ObliqueSlant{dup sin S cos div neg}B /SlantFont{4 index mul add}def
/ExtendFont{3 -1 roll mul exch}def /ReEncodeFont{/Encoding exch def}def
end
%%EndProcSet
%%BeginProcSet: special.pro
TeXDict begin /SDict 200 dict N SDict begin /@SpecialDefaults{/hs 612 N
/vs 792 N /ho 0 N /vo 0 N /hsc 1 N /vsc 1 N /ang 0 N /CLIP 0 N /rwiSeen
false N /rhiSeen false N /letter{}N /note{}N /a4{}N /legal{}N}B
/@scaleunit 100 N /@hscale{@scaleunit div /hsc X}B /@vscale{@scaleunit
div /vsc X}B /@hsize{/hs X /CLIP 1 N}B /@vsize{/vs X /CLIP 1 N}B /@clip{
/CLIP 2 N}B /@hoffset{/ho X}B /@voffset{/vo X}B /@angle{/ang X}B /@rwi{
10 div /rwi X /rwiSeen true N}B /@rhi{10 div /rhi X /rhiSeen true N}B
/@llx{/llx X}B /@lly{/lly X}B /@urx{/urx X}B /@ury{/ury X}B /magscale
true def end /@MacSetUp{userdict /md known{userdict /md get type
/dicttype eq{userdict begin md length 10 add md maxlength ge{/md md dup
length 20 add dict copy def}if end md begin /letter{}N /note{}N /legal{}
N /od{txpose 1 0 mtx defaultmatrix dtransform S atan/pa X newpath
clippath mark{transform{itransform moveto}}{transform{itransform lineto}
}{6 -2 roll transform 6 -2 roll transform 6 -2 roll transform{
itransform 6 2 roll itransform 6 2 roll itransform 6 2 roll curveto}}{{
closepath}}pathforall newpath counttomark array astore /gc xdf pop ct 39
0 put 10 fz 0 fs 2 F/|______Courier fnt invertflag{PaintBlack}if}N
/txpose{pxs pys scale ppr aload pop por{noflips{pop S neg S TR pop 1 -1
scale}if xflip yflip and{pop S neg S TR 180 rotate 1 -1 scale ppr 3 get
ppr 1 get neg sub neg ppr 2 get ppr 0 get neg sub neg TR}if xflip yflip
not and{pop S neg S TR pop 180 rotate ppr 3 get ppr 1 get neg sub neg 0
TR}if yflip xflip not and{ppr 1 get neg ppr 0 get neg TR}if}{noflips{TR
pop pop 270 rotate 1 -1 scale}if xflip yflip and{TR pop pop 90 rotate 1
-1 scale ppr 3 get ppr 1 get neg sub neg ppr 2 get ppr 0 get neg sub neg
TR}if xflip yflip not and{TR pop pop 90 rotate ppr 3 get ppr 1 get neg
sub neg 0 TR}if yflip xflip not and{TR pop pop 270 rotate ppr 2 get ppr
0 get neg sub neg 0 S TR}if}ifelse scaleby96{ppr aload pop 4 -1 roll add
2 div 3 1 roll add 2 div 2 copy TR .96 dup scale neg S neg S TR}if}N /cp
{pop pop showpage pm restore}N end}if}if}N /normalscale{Resolution 72
div VResolution 72 div neg scale magscale{DVImag dup scale}if 0 setgray}
N /psfts{S 65781.76 div N}N /startTexFig{/psf$SavedState save N userdict
maxlength dict begin /magscale true def normalscale currentpoint TR
/psf$ury psfts /psf$urx psfts /psf$lly psfts /psf$llx psfts /psf$y psfts
/psf$x psfts currentpoint /psf$cy X /psf$cx X /psf$sx psf$x psf$urx
psf$llx sub div N /psf$sy psf$y psf$ury psf$lly sub div N psf$sx psf$sy
scale psf$cx psf$sx div psf$llx sub psf$cy psf$sy div psf$ury sub TR
/showpage{}N /erasepage{}N /copypage{}N /p 3 def @MacSetUp}N /doclip{
psf$llx psf$lly psf$urx psf$ury currentpoint 6 2 roll newpath 4 copy 4 2
roll moveto 6 -1 roll S lineto S lineto S lineto closepath clip newpath
moveto}N /endTexFig{end psf$SavedState restore}N /@beginspecial{SDict
begin /SpecialSave save N gsave normalscale currentpoint TR
@SpecialDefaults count /ocount X /dcount countdictstack N}N /@setspecial
{CLIP 1 eq{newpath 0 0 moveto hs 0 rlineto 0 vs rlineto hs neg 0 rlineto
closepath clip}if ho vo TR hsc vsc scale ang rotate rwiSeen{rwi urx llx
sub div rhiSeen{rhi ury lly sub div}{dup}ifelse scale llx neg lly neg TR
}{rhiSeen{rhi ury lly sub div dup scale llx neg lly neg TR}if}ifelse
CLIP 2 eq{newpath llx lly moveto urx lly lineto urx ury lineto llx ury
lineto closepath clip}if /showpage{}N /erasepage{}N /copypage{}N newpath
}N /@endspecial{count ocount sub{pop}repeat countdictstack dcount sub{
end}repeat grestore SpecialSave restore end}N /@defspecial{SDict begin}
N /@fedspecial{end}B /li{lineto}B /rl{rlineto}B /rc{rcurveto}B /np{
/SaveX currentpoint /SaveY X N 1 setlinecap newpath}N /st{stroke SaveX
SaveY moveto}N /fil{fill SaveX SaveY moveto}N /ellipse{/endangle X
/startangle X /yrad X /xrad X /savematrix matrix currentmatrix N TR xrad
yrad scale 0 0 1 startangle endangle arc savematrix setmatrix}N end
%%EndProcSet
TeXDict begin 40258431 52099146 1000 600 600 (diss.dvi)
@start /Fa 1 50 df<000030000000F0000001F0000003F000001FF00000FFF000FFFF
F000FFE7F000FF07F0000007F0000007F0000007F0000007F0000007F0000007F0000007
F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007
F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007
F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007
F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007
F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007F0000007
F000000FF800001FFC007FFFFFFF7FFFFFFF7FFFFFFF204278C131>49
D E /Fb 137[72 72 72 4[72 1[72 72 1[72 3[72 72 1[72 72
72 16[72 2[72 72 2[72 2[72 72 3[72 65[{ TeXBase1Encoding ReEncodeFont }
19 119.999948 /Courier-Bold rf /Fc 2 115 df<07C007E0001FE03FF80018F8783E
003879E01E00307B801F00707F001F00607F001F0060FE001F00E0FC001F00C0FC001F00
C0F8001F0081F8003F0001F8003E0001F0003E0001F0003E0003F0007E0003F0007C0003
E0007C0003E000FC0007E000F80807E000F81807C001F81807C001F0180FC001F0380FC0
03E0300F8003E0700F8003E0E01F8001E0C01F8001E3C01F0000FF000E00003E00251F7E
9D2B>110 D<07C01F000FF07FC01CF8E0E03879C1E0307B87E0707F07E0607E07E060FC
07E0E0FC0380C0F80000C0F8000081F8000001F8000001F0000001F0000003F0000003F0
000003E0000003E0000007E0000007E0000007C0000007C000000FC000000FC000000F80
00000F8000001F8000001F8000001F0000000E0000001B1F7E9D20>114
D E /Fd 133[60 60 60 60 60 60 60 60 60 1[60 60 60 60
60 60 60 60 60 60 60 60 60 60 60 60 7[60 1[60 60 60 60
60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60
60 65[{ TeXBase1Encoding ReEncodeFont }49 100.000003
/Courier-Bold rf /Fe 136[50 50 50 50 1[50 1[50 50 50
50 50 2[50 50 50 50 50 1[50 50 50 11[50 1[50 50 1[50
1[50 8[50 50 21[50 46[{ TeXBase1Encoding ReEncodeFont }26
83.333337 /Courier rf /Ff 134[60 60 86 60 66 40 47 53
1[66 60 66 100 33 66 40 33 66 60 40 53 66 53 66 60 9[120
86 86 80 66 86 1[73 93 86 113 80 93 1[47 93 93 73 80
86 86 80 86 6[40 60 60 60 60 60 60 60 60 60 60 33 30
40 5[40 36[66 2[{ TeXBase1Encoding ReEncodeFont }61 119.999948
/Times-Bold rf /Fg 134[72 1[104 72 80 48 56 64 1[80 72
80 120 40 80 48 40 80 72 48 64 80 64 80 72 9[143 104
104 96 80 104 1[88 112 104 135 96 112 1[56 112 112 88
96 104 104 96 104 6[48 72 72 72 72 72 72 72 72 72 72
1[36 48 45[{ TeXBase1Encoding ReEncodeFont }57 143.999997
/Times-Bold rf /Fh 104[83 2[37 37 24[37 42 42 60 42 42
23 32 28 42 42 42 42 65 23 42 23 23 42 42 28 37 42 37
42 37 3[28 1[28 2[60 78 60 60 51 46 55 2[60 60 74 51
60 1[28 1[60 46 51 60 55 55 60 8[42 42 42 42 42 42 42
42 42 23 21 28 21 2[28 28 28 35[46 46 2[{
 TeXBase1Encoding ReEncodeFont }69 83.333337 /Times-Roman
rf /Fi 202[29 29 29 29 29 49[{ TeXBase1Encoding ReEncodeFont }5
58.333334 /Times-Roman rf /Fj 202[33 33 33 33 33 49[{
 TeXBase1Encoding ReEncodeFont }5 66.666667 /Times-Roman
rf /Fk 134[50 2[50 50 28 39 33 2[50 50 4[28 50 50 1[44
3[44 9[94 1[72 1[55 6[61 10[72 7[50 50 6[50 49[{
 .167 SlantFont TeXBase1Encoding ReEncodeFont }21 100.000003
/Times-Roman rf /Fl 140[47 40 2[60 60 1[33 3[60 2[53
3[53 28[86 80 20[30 46[{ TeXBase1Encoding ReEncodeFont }11
119.999948 /Times-Roman rf /Fm 103[60 26[60 1[60 60 60
60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60
60 60 60 60 60 60 1[60 1[60 1[60 60 60 60 60 60 60 60
60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60
60 1[60 60 60 1[60 60 2[60 1[60 2[60 60 60 60 60 60 60
60 60 60 60 60 60 3[60 60 33[{ TeXBase1Encoding ReEncodeFont }80
100.000003 /Courier rf /Fn 21 121 df<1E007F807F80FFC0FFC0FFC0FFC07F807F
801E000A0A78891B>58 D<00000000000001C000000000000007E00000000000001FE000
00000000007FC0000000000001FF00000000000007FC0000000000001FF0000000000000
7FC0000000000001FF0000000000000FFC0000000000003FF0000000000000FFC0000000
000003FF0000000000000FF80000000000003FE0000000000000FF80000000000003FE00
00000000001FF80000000000007FE0000000000001FF80000000000007FE000000000000
1FF00000000000007FC0000000000001FF00000000000007FC0000000000001FF0000000
0000007FC0000000000000FF00000000000000FF000000000000007FC00000000000001F
F000000000000007FC00000000000001FF000000000000007FC00000000000001FF00000
0000000007FE00000000000001FF800000000000007FE00000000000001FF80000000000
0003FE00000000000000FF800000000000003FE00000000000000FF800000000000003FF
00000000000000FFC00000000000003FF00000000000000FFC00000000000001FF000000
000000007FC00000000000001FF000000000000007FC00000000000001FF000000000000
007FC00000000000001FE000000000000007E000000000000001C03B3878B44C>60
D<7000000000000000FC00000000000000FF000000000000007FC00000000000001FF000
000000000007FC00000000000001FF000000000000007FC00000000000001FF000000000
000007FE00000000000001FF800000000000007FE00000000000001FF800000000000003
FE00000000000000FF800000000000003FE00000000000000FF800000000000003FF0000
0000000000FFC00000000000003FF00000000000000FFC00000000000001FF0000000000
00007FC00000000000001FF000000000000007FC00000000000001FF000000000000007F
C00000000000001FE00000000000001FE00000000000007FC0000000000001FF00000000
000007FC0000000000001FF00000000000007FC0000000000001FF0000000000000FFC00
00000000003FF0000000000000FFC0000000000003FF0000000000000FF8000000000000
3FE0000000000000FF80000000000003FE0000000000001FF80000000000007FE0000000
000001FF80000000000007FE0000000000001FF00000000000007FC0000000000001FF00
000000000007FC0000000000001FF00000000000007FC0000000000000FF000000000000
00FC0000000000000070000000000000003B3878B44C>62 D<0000000000003000000000
00000000700000000000000000F00000000000000000F00000000000000001F000000000
00000003F00000000000000003F00000000000000007F80000000000000007F800000000
0000000FF8000000000000001FF8000000000000001FF80000000000000037F800000000
00000037F80000000000000067F800000000000000E7F800000000000000C7F800000000
00000187FC0000000000000187FC0000000000000307FC0000000000000703FC00000000
00000603FC0000000000000C03FC0000000000000C03FC0000000000001803FC00000000
00003803FC0000000000003003FC0000000000006003FE0000000000006003FE00000000
0000C003FE000000000001C001FE0000000000018001FE0000000000030001FE00000000
00030001FE0000000000060001FE00000000000E0001FE00000000000C0001FE00000000
00180001FE0000000000180001FF0000000000300001FF0000000000700000FF00000000
00600000FF0000000000C00000FF0000000000C00000FF0000000001800000FF00000000
03FFFFFFFF0000000003FFFFFFFF0000000007FFFFFFFF0000000006000000FF80000000
0C000000FF800000001C0000007F80000000180000007F80000000300000007F80000000
300000007F80000000600000007F80000000E00000007F80000000C00000007F80000001
800000007F80000001800000007FC0000003000000007FC0000007000000003FC0000006
000000003FC000000E000000003FC000001C000000003FC000003C000000003FC000007C
000000003FC00000FE000000007FE00007FF00000001FFE0007FFFF000007FFFFFC0FFFF
F000007FFFFFC0FFFFE000007FFFFFC042477DC649>65 D<0000FFFFFFFFFF80000000FF
FFFFFFFFF0000000FFFFFFFFFFFC00000000FFC00003FF000000007F800000FF80000000
FF8000003FC0000000FF8000003FE0000000FF0000001FE0000000FF0000000FF0000000
FF0000000FF0000001FF0000000FF8000001FE00000007F8000001FE00000007F8000001
FE00000007F8000003FE00000007F8000003FC00000007F8000003FC0000000FF8000003
FC0000000FF8000007FC0000000FF0000007F80000001FF0000007F80000001FE0000007
F80000003FE000000FF80000003FC000000FF00000007F8000000FF0000000FF0000000F
F0000001FE0000001FF0000003FC0000001FE0000007F80000001FE000001FF00000001F
E000003FC00000003FE00001FF000000003FC0001FFC000000003FFFFFFFF0000000003F
FFFFFFFE000000007FC000007F800000007F8000001FC00000007F8000000FF00000007F
80000007F8000000FF80000003FC000000FF00000003FC000000FF00000001FE000000FF
00000001FE000001FF00000001FF000001FE00000001FF000001FE00000001FF000001FE
00000001FF000003FE00000001FF000003FC00000001FF000003FC00000001FF000003FC
00000001FF000007FC00000001FE000007F800000003FE000007F800000003FE000007F8
00000007FC00000FF800000007FC00000FF00000000FF800000FF00000001FF000000FF0
0000001FF000001FF00000003FE000001FE00000007FC000001FE0000001FF8000003FE0
000003FE0000003FE000000FFC0000003FC000003FF8000000FFC00001FFE00000FFFFFF
FFFFFF800000FFFFFFFFFFFC000000FFFFFFFFFFC000000045447CC34A>I<0000000001
FF800018000000003FFFF0003800000001FFFFFC003800000007FF007E00780000001FF0
000F80F00000007F800003C1F0000001FE000001C3F0000003FC000000E7F000000FF000
00007FE000001FE00000003FE000003FC00000003FE00000FF000000001FE00001FE0000
00001FC00003FC000000000FC00007F8000000000FC0000FF8000000000FC0000FF00000
00000F80001FE0000000000780003FC0000000000780007FC000000000078000FF800000
0000070000FF0000000000070001FF0000000000070003FE0000000000070003FE000000
0000060007FC0000000000060007FC000000000006000FF8000000000006000FF8000000
000000001FF8000000000000001FF0000000000000001FF0000000000000003FF0000000
000000003FE0000000000000003FE0000000000000003FE0000000000000007FE0000000
000000007FC0000000000000007FC0000000000000007FC0000000000000007FC0000000
00000000FF8000000000000000FF8000000000000000FF8000000000000000FF80000000
00000000FF800000000000C000FF800000000000C000FF800000000001C000FF80000000
000180007F80000000000180007F80000000000380007F80000000000300007F80000000
000700007F80000000000600003FC0000000000E00003FC0000000001C00003FC0000000
001800001FC0000000003800001FE0000000007000000FE000000000E000000FF0000000
01C0000007F80000000380000003F80000000700000001FC0000000E00000000FE000000
3C000000007F00000078000000003FC00001E0000000001FF0000FC00000000007FE007F
000000000001FFFFFC0000000000003FFFE000000000000007FF000000000045487CC546
>I<0000FFFFFFFFFFFFFC0000FFFFFFFFFFFFFC0000FFFFFFFFFFFFFC000000FFC00000
3FFC0000007F80000003F8000000FF80000001F8000000FF80000000F8000000FF000000
0078000000FF0000000078000000FF0000000038000001FF0000000038000001FE000000
0038000001FE0000000038000001FE0000000038000003FE0000000030000003FC000000
0030000003FC0000000030000003FC0000000030000007FC0000000030000007F8000060
0030000007F80000600030000007F80000E0003000000FF80000C0000000000FF00000C0
000000000FF00000C0000000000FF00001C0000000001FF0000180000000001FE0000380
000000001FE0000780000000001FE0000F80000000003FE0007F00000000003FFFFFFF00
000000003FFFFFFF00000000003FFFFFFF00000000007FC0007E00000000007F80001E00
000000007F80001E00000000007F80000E0000000000FF80000C0000000000FF00000C00
00000000FF00000C0000000000FF00001C0000000001FF0000180003000001FE00001800
03000001FE0000180007000001FE0000180006000003FE0000000006000003FC00000000
0E000003FC000000000C000003FC000000001C000007FC0000000018000007F800000000
38000007F80000000030000007F8000000007000000FF8000000007000000FF000000000
E000000FF000000001E000000FF000000001C000001FF000000003C000001FE000000007
C000001FE00000000F8000003FE00000003F8000003FE00000007F0000003FC0000003FF
000000FFC000003FFE0000FFFFFFFFFFFFFE0000FFFFFFFFFFFFFE0000FFFFFFFFFFFFFC
000046447CC348>69 D<0000FFFFFFFFFFFFF80000FFFFFFFFFFFFF80000FFFFFFFFFFFF
F8000000FFC000003FF80000007F80000007F0000000FF80000003F0000000FF80000001
F0000000FF00000000F0000000FF00000000F0000000FF0000000070000001FF00000000
70000001FE0000000070000001FE0000000070000001FE0000000070000003FE00000000
60000003FC0000000060000003FC0000000060000003FC0000000060000007FC00000000
60000007F80000000060000007F80000C00060000007F80001C0006000000FF800018000
0000000FF0000180000000000FF0000180000000000FF0000380000000001FF000030000
0000001FE0000700000000001FE0000700000000001FE0000F00000000003FE0001E0000
0000003FC000FE00000000003FFFFFFE00000000003FFFFFFE00000000007FFFFFFC0000
0000007F8000FC00000000007F80003C00000000007F80003C0000000000FF8000180000
000000FF0000180000000000FF0000180000000000FF0000380000000001FF0000300000
000001FE0000300000000001FE0000300000000001FE0000700000000003FE0000600000
000003FC0000000000000003FC0000000000000003FC0000000000000007FC0000000000
000007F80000000000000007F80000000000000007F8000000000000000FF80000000000
00000FF0000000000000000FF0000000000000000FF0000000000000001FF00000000000
00001FE0000000000000001FE0000000000000003FE0000000000000003FE00000000000
00003FE000000000000000FFE0000000000000FFFFFFF80000000000FFFFFFF800000000
00FFFFFFF8000000000045447CC33F>I<0000FFFFFFE003FFFFFF800000FFFFFFE003FF
FFFF800000FFFFFFE003FFFFFF80000000FFE0000003FF80000000007F80000001FE0000
000000FF80000003FE0000000000FF80000003FE0000000000FF00000003FC0000000000
FF00000003FC0000000000FF00000007FC0000000001FF00000007FC0000000001FE0000
0007F80000000001FE00000007F80000000001FE0000000FF80000000003FE0000000FF8
0000000003FC0000000FF00000000003FC0000000FF00000000003FC0000001FF0000000
0007FC0000001FF00000000007F80000001FE00000000007F80000001FE00000000007F8
0000003FE0000000000FF80000003FE0000000000FF00000003FC0000000000FF0000000
3FC0000000000FF00000007FC0000000001FF00000007FC0000000001FE00000007F8000
0000001FE00000007F80000000001FE0000000FF80000000003FE0000000FF8000000000
3FFFFFFFFFFF00000000003FFFFFFFFFFF00000000003FFFFFFFFFFF00000000007FC000
0001FF00000000007F80000001FE00000000007F80000001FE00000000007F80000003FE
0000000000FF80000003FE0000000000FF00000003FC0000000000FF00000003FC000000
0000FF00000007FC0000000001FF00000007FC0000000001FE00000007F80000000001FE
00000007F80000000001FE0000000FF80000000003FE0000000FF80000000003FC000000
0FF00000000003FC0000000FF00000000003FC0000001FF00000000007FC0000001FF000
00000007F80000001FE00000000007F80000001FE00000000007F80000003FE000000000
0FF80000003FE0000000000FF00000003FC0000000000FF00000003FC0000000000FF000
00007FC0000000001FF00000007FC0000000001FE00000007F80000000001FE00000007F
80000000003FE0000000FF80000000003FE0000000FF80000000003FC0000000FF000000
0000FFE0000003FF80000000FFFFFFE003FFFFFF800000FFFFFFE003FFFFFF800000FFFF
FFE003FFFFFF80000051447CC351>72 D<00007FFFFFF800007FFFFFF800007FFFFFF000
00007FF0000000003FC0000000007FC0000000007FC0000000007F80000000007F800000
00007F8000000000FF8000000000FF0000000000FF0000000000FF0000000001FF000000
0001FE0000000001FE0000000001FE0000000003FE0000000003FC0000000003FC000000
0003FC0000000007FC0000000007F80000000007F80000000007F8000000000FF8000000
000FF0000000000FF0000000000FF0000000001FF0000000001FE0000000001FE0000000
001FE0000000003FE0000000003FC0000000003FC0000000003FC0000000007FC0000000
007F80000000007F80000000007F8000000000FF8000000000FF0000000000FF00000000
00FF0000000001FF0000000001FE0000000001FE0000000001FE0000000003FE00000000
03FC0000000003FC0000000003FC0000000007FC0000000007F80000000007F800000000
07F8000000000FF8000000000FF0000000000FF0000000001FF0000000001FF000000000
1FE0000000007FF00000007FFFFFF00000FFFFFFF00000FFFFFFF000002D447DC32B>I<
0000FFFFC00000000003FFFE0000FFFFC00000000007FFFE0000FFFFC0000000000FFFFE
000000FFC0000000000FFE000000006FE0000000001BF800000000EFE0000000001FF800
000000EFE00000000037F800000000CFE00000000067F000000000CFE00000000067F000
000000CFE000000000CFF000000001CFE0000000018FF0000000018FE0000000018FE000
00000187F0000000030FE00000000187F0000000031FE00000000387F0000000061FE000
00000307F00000000C1FC00000000307F00000000C1FC00000000307F0000000183FC000
00000707F0000000303FC00000000607F0000000303F800000000603F8000000603F8000
00000603F8000000607F800000000E03F8000000C07F800000000C03F8000001807F0000
00000C03F8000001807F000000000C03F800000300FF000000001C03F800000600FF0000
00001803F800000600FE000000001801FC00000C00FE000000001801FC00000C01FE0000
00003801FC00001801FE000000003001FC00003001FC000000003001FC00003001FC0000
00003001FC00006003FC000000007001FC0000C003FC000000006001FC0000C003F80000
00006000FE00018003F8000000006000FE00018007F800000000E000FE00030007F80000
0000C000FE00060007F000000000C000FE00060007F000000000C000FE000C000FF00000
0001C000FE0018000FF0000000018000FE0018000FE00000000180007F0030000FE00000
000180007F0030001FE00000000380007F0060001FE00000000300007F00C0001FC00000
000300007F00C0001FC00000000300007F0180003FC00000000700007F0300003FC00000
000600007F0300003F800000000600003F8600003F800000000600003F8600007F800000
000E00003F8C00007F800000000C00003F9800007F000000000C00003F9800007F000000
000C00003FB00000FF000000001C00003FE00000FF000000001800003FE00000FE000000
003800001FC00000FE000000003800001FC00001FE000000007800001F800001FE000000
00FC00001F000001FC00000003FF00001F000007FE000000FFFFF8001E0007FFFFFE0000
FFFFF8001C0007FFFFFE0000FFFFF8000C0007FFFFFE00005F447BC35E>77
D<0000FFFFC000000FFFFF800000FFFFE000000FFFFF800000FFFFE000000FFFFF800000
007FE00000007FE0000000007FF00000001F80000000007FF00000000F0000000000EFF8
0000000E0000000000CFF80000000E0000000000C7F80000000C0000000000C7FC000000
1C0000000001C7FC0000001C000000000183FE00000018000000000183FE000000180000
00000181FF00000038000000000381FF00000038000000000300FF000000300000000003
00FF80000030000000000300FF800000700000000007007FC00000700000000006007FC0
0000600000000006003FC00000600000000006003FE00000E0000000000E003FE00000E0
000000000C001FF00000C0000000000C001FF00000C0000000000C000FF80001C0000000
001C000FF80001C000000000180007F800018000000000180007FC000180000000001800
07FC00038000000000380003FE00038000000000300003FE00030000000000300001FE00
030000000000300001FF00070000000000700001FF00070000000000600000FF80060000
000000600000FF800600000000006000007FC00E0000000000E000007FC00E0000000000
C000003FC00C0000000000C000003FE00C0000000000C000003FE01C0000000001C00000
1FF01C00000000018000001FF01800000000018000000FF01800000000018000000FF838
00000000038000000FF838000000000300000007FC30000000000300000007FC30000000
000300000003FE70000000000700000003FE70000000000600000001FE60000000000600
000001FF60000000000600000001FFE0000000000E00000000FFE0000000000C00000000
FFC0000000000C000000007FC0000000000C000000007FC0000000001C000000007FC000
00000018000000003F800000000038000000003F800000000038000000001F8000000000
78000000001F8000000000FC000000000F0000000003FF000000000F00000000FFFFF800
00000F00000000FFFFF80000000700000000FFFFF8000000060000000051447CC34E>I<
0000FFFFFFFFF000000000FFFFFFFFFF00000000FFFFFFFFFFE000000000FFC0003FF800
0000007F800007FC00000000FF800001FE00000000FF8000007F00000000FF0000003F80
000000FF0000003FC0000000FF0000001FE0000001FF0000001FE0000001FE0000001FE0
000001FE0000001FF0000001FE0000001FF0000003FE0000001FF0000003FC0000001FF0
000003FC0000001FF0000003FC0000001FF0000007FC0000003FE0000007F80000003FE0
000007F80000003FE0000007F80000007FC000000FF80000007F8000000FF0000000FF80
00000FF0000000FF0000000FF0000001FE0000001FF0000003FC0000001FE0000007F800
00001FE000000FE00000001FE000001FC00000003FE000007F000000003FC00003FC0000
00003FC0001FF0000000003FFFFFFF80000000007FFFFFFE00000000007F80007F800000
00007F80000FC0000000007F800007F000000000FF800003F800000000FF000003FC0000
0000FF000001FC00000000FF000001FE00000001FF000001FE00000001FE000000FE0000
0001FE000000FE00000001FE000001FE00000003FE000001FE00000003FC000001FE0000
0003FC000001FE00000003FC000003FE00000007FC000003FE00000007F8000003FE0000
0007F8000003FE00000007F8000007FC0000000FF8000007FC0000000FF0000007FC0000
000FF0000007FC0000000FF0000007FC0000001FF0000007FC0018001FE0000007FC0018
001FE0000007FC0018003FE0000007F80038003FE0000007F80030003FC0000007FC0070
00FFE0000003FC00E0FFFFFFE00003FC01C0FFFFFFE00001FC0380FFFFFFE00000FE0F00
0000000000003FFE0000000000000007F00045467CC34A>82 D<00000000FF8001800000
0007FFF003800000003FFFFC0380000000FF007E0780000001F8000F0F80000007E00007
9F0000000FC00003FF0000001F000001FF0000003E000000FF0000007C000000FE000000
7C0000007E000000F80000007E000001F00000007E000001F00000003C000003E0000000
3C000003E00000003C000007E00000003C000007C000000038000007C000000038000007
C00000003800000FC00000003800000FC00000003000000FE00000003000000FE0000000
3000000FE00000000000000FF000000000000007F800000000000007FC00000000000007
FF00000000000003FFE0000000000003FFFC000000000001FFFFC00000000000FFFFFC00
000000007FFFFF00000000003FFFFFC0000000000FFFFFE00000000003FFFFF800000000
003FFFF8000000000007FFFC0000000000007FFE0000000000000FFE00000000000003FE
00000000000001FF00000000000000FF000000000000007F000000000000007F00000000
0000003F000000000000003F000006000000003F000006000000003F000006000000003F
000006000000003F00000E000000003E00000E000000003E00000C000000003E00000C00
0000007E00001E000000007C00001E000000007C00001E00000000F800001E00000000F0
00003F00000001F000003F00000003E000003F80000007C000003F8000000F8000007FC0
00001F0000007FE000003E0000007CF800007C000000787E0001F8000000F01FC00FE000
0000E007FFFF80000000E001FFFE00000000C0003FF00000000039487BC53C>I<FFFFFF
8003FFFFFC0007FFFFFFFFFF8007FFFFFC0007FFFFFFFFFF0007FFFFF80007FFFF03FFC0
00001FFE0000007FE001FF0000000FF80000003F8001FF0000000FF80000001F0001FF00
00000FF80000001E0001FF0000000FF80000001C0001FF00000007F80000001C0000FF00
000007F8000000180000FF00000007F8000000300000FF0000000FF8000000700000FF00
00000FF8000000600000FF0000001FF8000000C00000FF0000001FF8000000C00000FF00
000037F8000001800000FF00000037F8000001800000FF00000067F8000003000000FF00
0000E7F8000003000000FF000000C7F8000006000000FF00000187F800000E000000FF00
000187FC00000C000000FF80000307FC000018000000FF80000307FC0000180000007F80
000603FC0000300000007F80000603FC0000300000007F80000C03FC0000600000007F80
001C03FC0000E00000007F80001803FC0000C00000007F80003003FC0001800000007F80
003003FC0001800000007F80006003FC0003000000007F80006003FC0003000000007F80
00C003FC0006000000007F8001C003FC0006000000007F80018003FC000C000000007F80
030003FC0018000000007F80030003FE0018000000007FC0060003FE0030000000007FC0
060001FE0030000000003FC00C0001FE0060000000003FC00C0001FE0060000000003FC0
180001FE00C0000000003FC0300001FE01C0000000003FC0300001FE0180000000003FC0
600001FE0300000000003FC0600001FE0300000000003FC0C00001FE0600000000003FC0
C00001FE0600000000003FC1800001FE0C00000000003FC3800001FE1C00000000003FC3
000001FE1800000000003FC6000001FF3000000000003FE6000001FF3000000000003FEC
000001FF6000000000003FEC000000FF6000000000001FF8000000FFC000000000001FF8
000000FFC000000000001FF0000000FF8000000000001FE0000000FF0000000000001FE0
000000FF0000000000001FC0000000FE0000000000001FC0000000FE0000000000001F80
000000FC0000000000001F80000000FC0000000000001F00000000F80000000000001F00
000000F80000000000001E00000000F00000000000001C00000000E00000000000000C00
00000060000000000060467BC35C>87 D<00003FFFFFE0001FFFFF00003FFFFFE0001FFF
FF00003FFFFFE0001FFFFF0000007FFE000003FFE00000003FF8000001FE000000001FF0
000000FC000000001FF0000000F0000000000FF8000001E0000000000FF8000001C00000
000007FC000003800000000007FC000006000000000007FC00000E000000000003FE0000
1C000000000003FE000038000000000001FF000070000000000001FF0000E00000000000
01FF8001C0000000000000FF800180000000000000FF8003000000000000007FC0060000
00000000007FC00C000000000000003FE018000000000000003FE030000000000000003F
E060000000000000001FF0C0000000000000001FF1C0000000000000000FFB8000000000
0000000FFF00000000000000000FFE000000000000000007FC000000000000000007FC00
0000000000000003FE000000000000000003FE000000000000000003FE00000000000000
0001FF000000000000000003FF000000000000000006FF80000000000000000CFF800000
00000000001C7FC000000000000000387FC000000000000000707FC000000000000000E0
3FE000000000000001C03FE000000000000003801FF000000000000003001FF000000000
000006001FF00000000000000C000FF800000000000018000FF8000000000000300007FC
000000000000600007FC000000000000C00007FC000000000001800003FE000000000003
800003FE000000000007000001FF00000000000E000001FF00000000001C000001FF0000
00000038000000FF800000000030000000FF8000000000E00000007FC000000001C00000
007FC000000003C00000003FE000000007800000003FE00000001F800000003FE0000000
3FC00000007FF0000003FFE0000001FFF800007FFFFC00001FFFFFF000FFFFFC00001FFF
FFF000FFFFFC00001FFFFFF00050447EC351>I<FFFFFF8000001FFFFCFFFFFF8000001F
FFFCFFFFFF8000001FFFF801FFE000000003FF8000FFC000000001FC0000FF8000000001
F000007FC000000001E000007FC000000003C000007FC0000000038000003FE000000007
0000003FE00000000E0000003FE00000001C0000001FF0000000180000001FF000000030
0000001FF8000000600000000FF8000000C00000000FF80000018000000007FC00000380
00000007FC0000070000000007FC0000060000000003FE00000C0000000003FE00001800
00000003FE0000300000000001FF0000600000000001FF0000E00000000001FF0001C000
00000000FF8001800000000000FF8003000000000000FFC0060000000000007FC00C0000
000000007FC0180000000000007FE0380000000000003FE0700000000000003FE0600000
000000001FF0C00000000000001FF1800000000000001FF3000000000000000FFE000000
000000000FFE000000000000000FFC0000000000000007F80000000000000007F0000000
000000000FF0000000000000000FF0000000000000000FF0000000000000000FE0000000
000000001FE0000000000000001FE0000000000000001FE0000000000000001FC0000000
000000003FC0000000000000003FC0000000000000003FC0000000000000003F80000000
000000007F80000000000000007F80000000000000007F80000000000000007F00000000
00000000FF0000000000000000FF0000000000000000FF0000000000000001FE00000000
00000001FE0000000000000001FE0000000000000007FF00000000000007FFFFFF000000
000007FFFFFF000000000007FFFFFE000000000046447CC339>I<00000FFFFFFFFFFFC0
00001FFFFFFFFFFFC000001FFFFFFFFFFF8000001FFF800001FF0000001FF8000001FF00
00003FE0000003FE0000003F80000007FC0000003F0000000FF80000007E0000001FF000
00007C0000003FE0000000780000007FC0000000F0000000FF80000000F0000000FF8000
0000E0000001FF00000000C0000003FE00000001C0000007FC00000001C000000FF80000
00018000001FF0000000038000003FE0000000030000007FC000000003000000FF800000
0003000000FF8000000000000001FF0000000000000003FE0000000000000007FC000000
000000000FF8000000000000001FF0000000000000003FE0000000000000007FC0000000
00000000FF8000000000000000FF8000000000000001FF0000000000000003FE00000000
00000007FC000000000000000FF8000000000000001FF0000000000000003FE000000000
0000007FC0000000000000007FC000000000000000FF8000000000000001FF0000000000
000003FE0000000000000007FC000006000000000FF8000006000000001FF00000060000
00003FE000000E000000007FC000000C000000007FC000000C00000000FF8000001C0000
0001FF0000001800000003FE0000003800000007FC000000380000000FF8000000700000
001FF0000000700000003FE0000000F00000007FC0000000E00000007FC0000001E00000
00FF80000003E0000001FF00000007C0000003FE0000000FC0000007FC0000001FC00000
0FF80000003F8000001FF0000000FF8000003FE0000003FF8000003FE000003FFF000000
7FFFFFFFFFFF000000FFFFFFFFFFFF000000FFFFFFFFFFFE00000042447BC343>I<00F8
0003FC000003FE001FFF0000071F007C0FC0000E0F80E007E0000C07C3C003E0001C07C7
0003F0001807CE0001F0003807DC0001F8003007D80001F800300FF80001F800700FF000
01F800600FE00001F800600FE00001F800E00FC00003F800C01FC00003F000C01F800003
F000001F800003F000001F800007F000003F800007E000003F000007E000003F000007E0
00003F00000FE000007F00000FC000007E00000FC000007E00001FC000007E00001F8000
00FE00001F800000FC00003F800000FC00003F000000FC00003F007001FC00007F006001
F800007E006001F80000FE006001F80000FC00E003F80000FC00C003F00000FC01C003F0
0000F8018003F00000F8038007F00000F8030007E00000F8070007E00000F80E0007E000
00781C000FE000007C38000FC000001FF0000380000007C000342D7DAB3A>110
D<00F8000FC003FE007FF0070F00F0380E0F83C07C0C07C701FC1C07CE01FC1807DC03FC
3807D803FC3007F803FC300FF003F8700FE000E0600FE00000600FC00000E00FC00000C0
1FC00000C01F800000001F800000001F800000003F800000003F000000003F000000003F
000000007F000000007E000000007E000000007E00000000FE00000000FC00000000FC00
000000FC00000001FC00000001F800000001F800000001F800000003F800000003F00000
0003F000000003F000000007F000000007E000000007E000000007E00000000FE0000000
0FC00000000380000000262D7DAB2C>114 D<0000FC0007E00003FF801FFC000F07C078
1E001C03E0E01F003801F1C07F007000F1807F00E000FB80FF01C000FF00FF018000FE00
FF038000FE00FE030000FE0038070000FC0000060000FC0000060001FC00000E0001F800
000C0001F80000000001F80000000003F80000000003F00000000003F00000000003F000
00000007F00000000007E00000000007E00000000007E0000000000FE0000000000FC000
0000000FC0000000000FC0000000001FC0003800001FC0003000001F80003000001F8000
7000003F8000601E003F8000603F003F8000E07F807F8001C07F806F800180FF80EF8003
80FF01CF800700FE0187C00E007C0383C01C003C0F01E078001FFC00FFE00003F0003F80
00302D7EAB37>120 D E /Fo 105[50 27[44 50 50 72 50 55
33 39 44 55 55 50 55 83 28 55 33 28 55 50 33 44 55 44
55 50 9[100 72 72 66 55 72 1[61 78 72 94 66 78 1[39 78
78 61 66 72 72 66 72 6[33 50 50 50 50 50 50 50 50 50
50 28 25 33 25 2[33 33 33 35[55 55 2[{ TeXBase1Encoding ReEncodeFont }
68 100.000003 /Times-Bold rf /Fp 134[103 103 149 103
115 69 80 92 1[115 103 115 172 57 115 1[57 115 103 69
92 115 92 115 103 9[207 149 149 138 115 149 1[126 161
1[195 138 2[80 161 161 126 138 149 149 138 149 7[103
103 103 103 103 103 103 103 103 103 48[{ TeXBase1Encoding ReEncodeFont }
52 207.333362 /Times-Bold rf /Fq 134[44 44 66 44 50 28
39 39 1[50 50 50 72 28 44 28 28 50 50 28 44 50 44 50
50 8[61 83 61 72 55 50 61 72 61 72 66 83 55 66 44 33
72 72 61 61 72 66 61 61 6[33 50 50 50 50 50 50 50 50
50 1[28 25 33 25 2[33 33 33 78 35[50 2[{ TeXBase1Encoding ReEncodeFont }
67 100.000003 /Times-Italic rf /Fr 2 16 df<7FFFFFFFFFFFFFE0FFFFFFFFFFFF
FFF0FFFFFFFFFFFFFFF07FFFFFFFFFFFFFE03C04789A4D>0 D<0001FF0000000FFFE000
003FFFF800007FFFFC0001FFFFFF0003FFFFFF8007FFFFFFC00FFFFFFFE01FFFFFFFF01F
FFFFFFF03FFFFFFFF87FFFFFFFFC7FFFFFFFFC7FFFFFFFFCFFFFFFFFFEFFFFFFFFFEFFFF
FFFFFEFFFFFFFFFEFFFFFFFFFEFFFFFFFFFEFFFFFFFFFEFFFFFFFFFEFFFFFFFFFEFFFFFF
FFFE7FFFFFFFFC7FFFFFFFFC7FFFFFFFFC3FFFFFFFF81FFFFFFFF01FFFFFFFF00FFFFFFF
E007FFFFFFC003FFFFFF8001FFFFFF00007FFFFC00003FFFF800000FFFE0000001FF0000
27267BAB32>15 D E /Fs 87[33 15[33 100 50 1[44 44 24[44
50 50 72 50 50 28 39 33 50 50 50 50 78 28 50 28 28 50
50 33 44 50 44 50 44 3[33 1[33 61 72 72 94 72 72 61 55
66 72 55 72 72 89 61 72 39 33 72 72 55 61 72 66 66 72
1[44 3[28 28 50 50 50 50 50 50 50 50 50 50 28 25 33 25
2[33 33 33 78 83 3[33 2[33 26[55 55 2[{ TeXBase1Encoding ReEncodeFont }
86 100.000003 /Times-Roman rf end
%%EndProlog
%%BeginSetup
%%Feature: *Resolution 600dpi
TeXDict begin
%%PaperSize: Letter

%%EndSetup
%%Page: 0 1
0 0 bop 1246 100 a Fs(SEVER)26 b(INSTITUTE)f(OF)g(TECHNOLOGY)1391
340 y(DOCT)n(OR)h(OF)f(SCIENCE)h(DEGREE)1424 817 y(DISSER)-6
b(T)d(A)e(TION)25 b(A)l(CCEPT)-9 b(ANCE)1050 1058 y(\(T)h(o)25
b(be)g(the)g(\002rst)g(page)g(of)g(each)g(cop)o(y)g(of)f(the)h
(dissertation\))300 1407 y(D)l(A)-11 b(TE:)24 b(July)g(24,)h(1998)300
1648 y(STUDENT'S)g(N)m(AME:)f(Charles)h(D.)g(Cranor)583
2096 y(This)c(student')-5 b(s)19 b(dissertation,)h(entitled)p
1981 2117 289 4 v 20 w(Design)p 2264 2117 25 4 v 2285
2117 150 4 v 20 w(and)p 2429 2117 25 4 v 2450 2117 637
4 v 21 w(Implementation)p 3081 2117 25 4 v 3102 2117
89 4 v 20 w(of)p 3185 2117 25 4 v 3206 2117 128 4 v 20
w(the)p 3328 2117 25 4 v 3349 2117 239 4 v 20 w(UVM)p
3582 2117 25 4 v 3603 2117 V 3624 2117 283 4 v 42 w(V)-6
b(irtual)p 298 2238 350 4 v 300 2216 a(Memory)p 642 2238
26 4 v 664 2238 300 4 v 21 w(System)21 b(has)g(been)h(e)o(xamined)e(by)
h(the)g(undersigned)g(committee)f(of)i(\002)n(v)o(e)f(f)o(aculty)g
(members)300 2336 y(and)28 b(has)f(recei)n(v)o(ed)g(full)g(appro)o(v)n
(al)g(for)g(acceptance)i(in)e(partial)g(ful\002llment)g(of)h(the)f
(requirements)g(for)300 2457 y(the)e(de)o(gree)g(Doctor)f(of)h
(Science.)1343 2931 y(APPR)l(O)-5 b(V)-13 b(AL:)p 1899
2980 1583 4 v 1899 3217 V 1899 3453 V 1899 3689 V 1899
3925 V 1633 w(Chairman)p eop
%%Page: 0 2
0 1 bop 300 2460 a Fs(Short)25 b(T)m(itle:)k(Design)24
b(and)h(Implementation)e(of)i(UVM)575 b(Cranor)l(,)25
b(D.Sc.)h(1998)p eop
%%Page: 0 3
0 2 bop 1458 891 a Fs(W)-12 b(ASHINGT)n(ON)25 b(UNIVERSITY)1246
1090 y(SEVER)h(INSTITUTE)f(OF)g(TECHNOLOGY)1193 1289
y(DEP)-9 b(AR)j(TMENT)24 b(OF)i(COMPUTER)f(SCIENCE)p
1050 1489 2100 4 v 1035 1688 a(DESIGN)g(AND)g(IMPLEMENT)-9
b(A)e(TION)24 b(OF)h(THE)f(UVM)1444 1887 y(VIR)-6 b(TU)l(AL)25
b(MEMOR)-6 b(Y)24 b(SYSTEM)2050 2086 y(by)1616 2286 y(Charles)i(D.)e
(Cranor)l(,)i(M.S.)818 2485 y(Prepared)g(under)f(the)g(direction)f(of)h
(Professor)g(Gurudatta)f(M.)h(P)o(arulkar)p 1050 2684
V 1140 2888 a(A)g(dissertation)f(presented)g(to)h(the)f(Se)n(v)o(er)h
(Institute)f(of)1229 3038 y(W)-8 b(ashington)23 b(Uni)n(v)o(ersity)g
(in)h(partial)h(ful\002llment)1370 3187 y(of)g(the)g(requirements)f
(for)h(the)g(de)o(gree)g(of)1740 3392 y(Doctor)g(of)g(Science)1832
3591 y(August,)e(1998)1670 3790 y(Saint)h(Louis,)g(Missouri)p
eop
%%Page: 1 4
1 3 bop 1458 345 a Fs(W)-12 b(ASHINGT)n(ON)25 b(UNIVERSITY)1246
525 y(SEVER)h(INSTITUTE)f(OF)g(TECHNOLOGY)1193 706 y(DEP)-9
b(AR)j(TMENT)24 b(OF)i(COMPUTER)f(SCIENCE)p 1050 887
2100 4 v 1842 1067 a(ABSTRA)l(CT)p 1050 1248 V 1035 1428
a(DESIGN)g(AND)g(IMPLEMENT)-9 b(A)e(TION)24 b(OF)h(THE)f(UVM)1444
1609 y(VIR)-6 b(TU)l(AL)25 b(MEMOR)-6 b(Y)24 b(SYSTEM)1674
1884 y(by)g(Charles)i(D.)e(Cranor)p 1050 2064 V 1205
2245 a(AD)l(VISOR:)h(Professor)g(Gurudatta)g(M.)f(P)o(arulkar)p
1050 2426 V 1832 2606 a(August,)f(1998)1670 2787 y(Saint)h(Louis,)g
(Missouri)p 1050 2967 V 583 3555 a(W)-8 b(e)24 b(introduce)e(UVM,)g(a)h
(ne)n(w)f(virtual)g(memory)g(subsystem)f(for)i(4.4BSD)g(that)f(mak)o
(es)g(better)300 3675 y(use)33 b(of)g(e)o(xisting)f(hardw)o(are)i
(memory)e(management)g(features)i(to)f(reduce)g(o)o(v)o(erhead)g(and)g
(impro)o(v)o(e)300 3795 y(performance.)53 b(Our)31 b(no)o(v)o(el)g
(approach)h(focuses)g(on)f(allo)n(wing)g(processes)g(to)h(pass)g
(memory)f(to)g(and)300 3916 y(from)25 b(other)g(processes)g(and)g(the)g
(k)o(ernel,)g(and)g(to)g(share)g(memory)-6 b(.)30 b(This)25
b(approach)g(reduces)h(or)f(elim-)300 4036 y(inates)36
b(the)g(need)h(to)f(cop)o(y)g(data)g(thus)g(reducing)g(the)g(time)g
(spent)g(within)f(the)h(k)o(ernel)h(and)f(freeing)300
4156 y(up)29 b(c)o(ycles)g(for)h(application)e(processing.)43
b(Unlik)o(e)29 b(the)g(approaches)g(that)g(focus)g(e)o(xclusi)n(v)o
(ely)e(on)i(the)300 4277 y(netw)o(orking)d(and)i(inter)n(-process)f
(communications)e(\(IPC\))k(subsystems,)d(our)h(approach)h(pro)o(vides)
e(a)300 4397 y(general)f(frame)n(w)o(ork)g(for)g(solutions)d(that)j
(can)g(impro)o(v)o(e)e(ef)n(\002cienc)o(y)i(of)g(the)f(entire)h(I/O)g
(subsystem.)583 4518 y(Our)33 b(primary)f(objecti)n(v)o(e)e(in)i
(creating)g(UVM)g(w)o(as)g(to)g(produce)h(a)f(virtual)g(memory)f
(system)300 4638 y(that)c(pro)o(vides)f(a)i(Unix-lik)o(e)e(operating)h
(system)f(k)o(ernel')-5 b(s)27 b(I/O)g(and)h(IPC)g(subsystems)d(with)i
(ef)n(\002cient)300 4758 y(VM-based)33 b(data)h(mo)o(v)o(ement)e(f)o
(acilities)g(that)i(ha)n(v)o(e)f(less)g(o)o(v)o(erhead)g(than)h(a)g
(traditional)e(data)i(cop)o(y)-6 b(.)300 4879 y(Our)25
b(w)o(ork)f(seeks)h(to:)445 5082 y Fr(\017)49 b Fs(allo)n(w)19
b(a)i(process)f(to)g(safely)g(let)g(a)h(shared)f(cop)o(y-on-write)g
(cop)o(y)g(of)h(its)e(memory)h(be)g(used)g(either)544
5203 y(by)k(other)h(processes,)g(the)f(I/O)h(system,)f(or)g(the)h(IPC)h
(system;)p eop
%%Page: 2 5
2 4 bop 445 100 a Fr(\017)49 b Fs(allo)n(w)20 b(pages)i(of)f(memory)g
(from)g(the)h(I/O)f(system,)g(the)g(IPC)i(system,)e(or)h(from)f(other)g
(processes)544 220 y(to)j(be)h(inserted)g(easily)f(into)g(a)h(process')
g(address)f(space;)h(and)445 423 y Fr(\017)49 b Fs(allo)n(w)39
b(processes)h(and)h(the)f(k)o(ernel)g(to)g(e)o(xchange)h(lar)n(ge)f
(chunks)g(of)h(their)f(virtual)f(address)544 544 y(spaces)25
b(using)f(the)g(VM)h(system')-5 b(s)23 b(higher)n(-le)n(v)o(el)g
(memory)h(mapping)g(data)h(structures.)583 747 y(UVM)20
b(allo)n(ws)f(processes)h(to)f(e)o(xchange)h(and)g(share)g(memory)f
(through)h(three)g(inno)o(v)n(ati)n(v)o(e)d(ne)n(w)300
868 y(mechanisms:)40 b(page)30 b(loanout,)h(page)f(transfer)l(,)i(and)e
(map)g(entry)g(passing.)46 b(W)-8 b(e)30 b(present)g(test)g(results)300
988 y(that)23 b(sho)n(w)g(that)h(our)g(ne)n(w)f(VM-based)h(data)g(mo)o
(v)o(ement)d(mechanisms)i(are)i(more)e(ef)n(\002cient)h(than)g(data)300
1108 y(cop)o(ying.)583 1229 y(UVM)i(is)f(implemented)f(entirely)h
(within)f(the)i(frame)n(w)o(ork)f(of)h(BSD)h(and)e(thus)g(maintains)f
(all)300 1349 y(the)i(features)g(and)f(standard)h(parts)f(of)h(the)f
(traditional)g(Unix)g(en)l(vironment)f(that)h(programmers)g(ha)n(v)o(e)
300 1469 y(come)i(to)h(e)o(xpect.)38 b(The)28 b(\002rst)f(release)i(of)
e(UVM)g(in)h(NetBSD)g(runs)f(on)g(se)n(v)o(eral)g(platforms)g
(including)300 1590 y(I386-PC,)32 b(DEC)g(Alpha,)g(Sun)g(Sparc,)i
(Motorola)c(m68k,)i(and)g(DEC)f(V)-13 b(AX)31 b(systems.)49
b(It)32 b(is)f(already)300 1710 y(being)24 b(used)h(on)f(systems)g
(around)g(the)h(w)o(orld.)p eop
%%Page: 3 6
3 5 bop 1485 2655 a Fs(to)25 b(my)f(f)o(amily)-6 b(,)23
b Fq(especially)i Fs(Lorrie)p eop
%%Page: 4 7
4 6 bop 300 824 a Fp(Contents)300 1405 y Fo(List)25 b(of)g(T)-9
b(ables)68 b Fn(:)50 b(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)
h(:)g(:)g(:)g(:)g(:)163 b Fo(xi)300 1654 y(List)25 b(of)g(Figur)n(es)99
b Fn(:)50 b(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g
(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)
g(:)136 b Fo(xii)300 1903 y(Ackno)o(wledgments)93 b Fn(:)50
b(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g
(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)141
b Fo(xv)300 2152 y(1)99 b(Intr)n(oduction)29 b Fn(:)50
b(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f
(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)191
b Fo(1)300 2401 y(2)99 b(Backgr)n(ound)46 b Fn(:)k(:)g(:)g(:)g(:)g(:)g
(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)
g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)191 b Fo(7)449
2550 y Fs(2.1)105 b(The)24 b(Role)i(of)e(the)h(VM)f(System)89
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)138 b(7)449 2700 y(2.2)105
b(The)24 b(VM)h(System)f(and)h(Process)g(Life)g(Cycle)59
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)88 b(10)679 2849 y(2.2.1)118 b(Process)26 b(Start-up)97
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(10)679 2999
y(2.2.2)118 b(Running)25 b(Processes)g(and)g(P)o(age)g(F)o(aults)85
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
88 b(13)679 3148 y(2.2.3)118 b(F)o(orking)24 b(and)h(Exiting)94
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(14)679 3297 y(2.2.4)118
b(VM)25 b(Operations)49 b(.)h(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(16)449 3447 y(2.3)105 b(The)24 b(Ev)n(olution)f(of)i(the)g(VM)f
(System)h(In)f(BSD)84 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(17)449 3596 y(2.4)105
b(Design)24 b(Ov)o(ervie)n(w)f(of)i(the)g(BSD)h(VM)e(System)65
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)88 b(19)679 3746 y(2.4.1)118 b(Layering)25 b(in)f(the)h(BSD)h(VM)e
(System)88 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)88 b(19)679 3895 y(2.4.2)118 b(The)25
b(Machine-Dependent)f(Layer)95 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(19)679 4044
y(2.4.3)118 b(The)25 b(Machine-Independent)f(Layer)34
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)88 b(21)679 4194 y(2.4.4)118 b(Cop)o(y-on-write)25
b(and)g(Object)f(Chaining)59 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(27)679 4343 y(2.4.5)118
b(P)o(age)25 b(F)o(ault)g(Handling)79 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
88 b(33)679 4493 y(2.4.6)118 b(Memory)24 b(Sharing)70
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(35)449 4642
y(2.5)105 b(Summary)80 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)88 b(35)300 4891 y Fo(3)99 b(UVM)25
b(Ov)o(er)o(view)g(and)g(Related)h(W)-7 b(ork)93 b Fn(:)50
b(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g
(:)g(:)g(:)g(:)141 b Fo(36)449 5040 y Fs(3.1)105 b(Goals)85
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)88 b(37)449 5190 y(3.2)105 b(UVM)24 b(Features)98
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(39)2062 5400 y(i)n(v)p eop
%%Page: 5 8
5 7 bop 679 100 a Fs(3.2.1)118 b(Ne)n(w)25 b(Features)50
b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(39)679
249 y(3.2.2)118 b(Impro)o(v)o(ed)24 b(Features)75 b(.)50
b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(41)449 398 y(3.3)105
b(High-Le)n(v)o(el)23 b(Design)h(Ov)o(ervie)n(w)38 b(.)50
b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(43)679 548 y(3.3.1)118
b(UVM')-5 b(s)24 b(Machine-Independent)g(Layer)40 b(.)49
b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(43)679 697 y(3.3.2)118 b(Data)25 b(Structure)h(Locking)35
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(45)679 847 y(3.3.3)118
b(VM)25 b(Maps)41 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)88 b(48)679 996 y(3.3.4)118 b(UVM)25 b(Objects)35
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(50)679
1145 y(3.3.5)118 b(Anon)o(ymous)23 b(Memory)h(Structures)62
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)88 b(50)679 1295 y(3.3.6)118 b(P)o(ager)26 b(Operations)59
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(52)679 1444
y(3.3.7)118 b(P)o(ages)68 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)88 b(52)449 1594 y(3.4)105 b(Related)25
b(W)-8 b(ork)69 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)88 b(57)679 1743 y(3.4.1)118 b(Other)25 b(V)-6
b(irtual)24 b(Memory)g(Systems)91 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(57)679
1892 y(3.4.2)118 b(I/O)25 b(and)g(IPC)h(Subsystems)d(That)i(Use)g(VM)f
(Features)31 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(69)449 2042 y(3.5)105 b(Summary)80 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(74)300 2291
y Fo(4)99 b(Anonymous)26 b(Memory)f(Handling)90 b Fn(:)50
b(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f
(:)h(:)g(:)g(:)g(:)g(:)141 b Fo(76)449 2440 y Fs(4.1)105
b(Anon)o(ymous)22 b(Memory)i(Ov)o(ervie)n(w)96 b(.)50
b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(76)449 2590 y(4.2)105 b(Amap)24
b(Interf)o(ace)72 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)88 b(77)449 2739 y(4.3)105 b(Amap)24 b(Implementation)f
(Options)49 b(.)g(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(79)679 2888
y(4.3.1)118 b(UVM)25 b(Reference)h(Amap)f(Implementation)56
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(81)679 3038 y(4.3.2)118 b(P)o(artial)25 b(Unmap)f(of)h(an)g(Amap)48
b(.)i(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(82)449 3187 y(4.4)105 b(Accessing)24
b(Anon)o(ymous)e(Backing)j(Store)78 b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(85)449
3337 y(4.5)105 b(The)24 b(Ef)n(fects)h(of)g(Amaps)f(on)h(P)o(ages)f
(and)h(Objects)60 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(87)449 3486 y(4.6)105 b(The)24
b(Ef)n(fect)h(of)g(Amaps)f(on)h(F)o(orking)f(and)g(Cop)o(y-on-write)34
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(88)679 3635 y(4.6.1)118 b(Cop)o(y-on-write)87 b(.)50
b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(88)679 3785
y(4.6.2)118 b(F)o(orking)59 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(90)449 3934 y(4.7)105 b(Inheritance)25
b(and)f(F)o(orking)35 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(95)679 4083 y(4.7.1)118 b(Share)26 b(Inheritance)f(when)g(Needs-cop)o
(y)g(is)f(T)m(rue)52 b(.)d(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)88 b(95)679 4233 y(4.7.2)118 b(Cop)o(y)25 b(Inheritance)g(when)g
(the)g(Amap)f(is)g(Shared)58 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)88 b(96)679 4382 y(4.7.3)118 b(Cop)o(y)25
b(Inheritance)g(of)g(a)g(Shared)h(Mapping)91 b(.)50 b(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(99)679 4532
y(4.7.4)118 b(Cop)o(y)25 b(Inheritance)g(when)g(the)g(Map)f(Entry)g(is)
h(W)l(ired)52 b(.)e(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(99)449 4681 y(4.8)105 b(Summary)80 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(99)300 4930
y Fo(5)99 b(Handling)25 b(P)o(age)g(F)n(aults)36 b Fn(:)50
b(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)92 b Fo(100)449
5079 y Fs(5.1)105 b(P)o(age)25 b(F)o(ault)f(Ov)o(ervie)n(w)81
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(100)679
5229 y(5.1.1)118 b(Calling)25 b Fm(uvm)p 1502 5229 30
4 v 35 w(fault)63 b Fs(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(101)2075 5400 y(v)p eop
%%Page: 6 9
6 8 bop 679 100 a Fs(5.1.2)118 b(F)o(ault)25 b(Address)f(Lookup)81
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(102)679 249 y(5.1.3)118
b(Post-lookup)24 b(Checks)97 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(104)679 398 y(5.1.4)118 b(Establishing)23 b(F)o(ault)h(Range)46
b(.)k(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)39 b(105)679 548 y(5.1.5)118 b(Mapping)24
b(Neighboring)g(Resident)g(P)o(ages)51 b(.)f(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(106)679 697 y(5.1.6)118
b(Anon)25 b(F)o(aults)33 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)39 b(106)679 847 y(5.1.7)118 b(Object)25 b(F)o(aults)64
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(109)679
996 y(5.1.8)118 b(Summary)61 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(111)449 1145 y(5.2)105 b(Error)25
b(Reco)o(v)o(ery)78 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)39 b(111)679 1295 y(5.2.1)118 b(In)l(v)n(alid)24
b(V)-6 b(irtual)24 b(Addresses)34 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(111)679 1444 y(5.2.2)118 b(Protection)25 b(V)-6 b(iolations)51
b(.)f(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(112)679 1594 y(5.2.3)118
b(Null)24 b(Mappings)71 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(113)679 1743 y(5.2.4)118 b(Out)25 b(of)g(Physical)f(Memory)57
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(113)679 1892 y(5.2.5)118
b(Out)25 b(of)g(Anon)o(ymous)d(V)-6 b(irtual)24 b(Memory)57
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
39 b(113)679 2042 y(5.2.6)118 b(F)o(ailure)25 b(T)-8
b(o)25 b(Relock)g(Data)g(Structures)62 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(114)679
2191 y(5.2.7)118 b(I/O)25 b(Errors)42 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(114)679 2341 y(5.2.8)118
b(Released)26 b(P)o(ages)57 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(115)449 2490 y(5.3)105 b(BSD)25 b(VM)g(F)o(ault)f(vs.)30
b(UVM)25 b(F)o(ault)52 b(.)d(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(115)679
2639 y(5.3.1)118 b(Map)25 b(Lookup)79 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(115)679 2789 y(5.3.2)118 b(Object)25
b(Chaining)f(vs.)30 b(T)-8 b(w)o(o-Le)n(v)o(el)24 b(Mappings)39
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(116)679 2938 y(5.3.3)118 b(Mapping)24 b(Neighboring)g(Resident)g(P)o
(ages)51 b(.)f(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(117)449 3087 y(5.4)105 b(Summary)80 b(.)50 b(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(117)300
3337 y Fo(6)99 b(P)o(ager)25 b(Interface)63 b Fn(:)50
b(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g
(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)92
b Fo(118)449 3486 y Fs(6.1)105 b(The)24 b(Role)i(of)e(the)h(P)o(ager)44
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(118)449
3635 y(6.2)105 b(P)o(ager)25 b(Operations)79 b(.)49 b(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(119)679 3785 y(6.2.1)118
b(The)25 b(Init)f(Operation)80 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(119)679 3934 y(6.2.2)118 b(The)25 b(Attach)g(Operation)i(.)50
b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(120)679 4083 y(6.2.3)118
b(The)25 b(Reference)i(Operation)38 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(120)679 4233 y(6.2.4)118 b(The)25 b(Detach)g(Operation)86
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(120)679 4382 y(6.2.5)118
b(The)25 b(Get)g(Operation)74 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(121)679 4532 y(6.2.6)118 b(The)25 b(Asyncget)f(Operation)66
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(123)679 4681 y(6.2.7)118
b(The)25 b(F)o(ault)f(Operation)90 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(123)679 4830 y(6.2.8)118 b(The)25 b(Put)g(Operation)85
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(124)679 4980
y(6.2.9)118 b(The)25 b(Flush)g(Operation)71 b(.)50 b(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)39 b(124)679 5129 y(6.2.10)68 b(The)25 b(Cluster)g(Operation)80
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(126)2061 5400 y(vi)p
eop
%%Page: 7 10
7 9 bop 679 100 a Fs(6.2.11)68 b(The)25 b(Mak)o(e)g(Put)g(Cluster)f
(Operation)45 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)39 b(126)679 249 y(6.2.12)68 b(The)25
b(Share)h(Protect)f(Operation)58 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(127)679 398 y(6.2.13)68 b(The)25 b(Async)g(I/O)f(Done)h(Operation)88
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)39 b(127)679 548 y(6.2.14)68 b(The)25 b(Release)h(P)o(age)f
(Operation)65 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(128)449 697 y(6.3)105
b(BSD)25 b(VM)g(P)o(ager)g(vs.)30 b(UVM)25 b(P)o(ager)83
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(129)679 847 y(6.3.1)118
b(Data)25 b(Structure)h(Layout)85 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(129)679 996 y(6.3.2)118 b(P)o(age)25 b(Access)99 b(.)50
b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(130)679
1145 y(6.3.3)118 b(Other)25 b(Minor)f(Dif)n(ferences)58
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(132)449 1295 y(6.4)105 b(Summary)80
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(133)300 1544 y Fo(7)99 b(Using)25 b(UVM)g(to)g(Mo)o(v)o(e)f
(Data)78 b Fn(:)50 b(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)
g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)92
b Fo(134)449 1693 y Fs(7.1)105 b(P)o(age)25 b(Loanout)67
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(135)679 1843 y(7.1.1)118 b(Loan)25 b(T)-8 b(ypes)24
b(and)h(Attrib)n(utes)64 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(136)679
1992 y(7.1.2)118 b(Loaning)24 b(and)h(Locking)38 b(.)50
b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(138)679 2141 y(7.1.3)118
b(Loanout)24 b(Data)h(Structures)g(and)g(Functions)82
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(139)679 2291 y(7.1.4)118 b(Anonget)24 b(and)h(Loaned)g(P)o(ages)k(.)
50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(139)679 2440 y(7.1.5)118 b(Loanout)24
b(Procedure)62 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(140)679 2590 y(7.1.6)118 b(Dropping)24 b(and)h(Freeing)g(Loaned-Out)f
(P)o(ages)77 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(142)679 2739 y(7.1.7)118 b(The)25 b(P)o(agedaemon)g(and)f
(Loaned)h(Out)g(P)o(ages)33 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)39 b(143)679 2888 y(7.1.8)118 b(F)o(aulting)24
b(on)g(a)i Fm(uvm)p 1733 2888 30 4 v 35 w(object)d Fs(with)h
(Loaned-Out)h(P)o(ages)79 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(144)679 3038 y(7.1.9)118 b(F)o(aulting)24 b(on)g(an)h(Anon)g(W)l(ith)
f(Loaned-Out)g(P)o(ages)65 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)39 b(144)679 3187 y(7.1.10)68 b(Using)24 b(P)o(age)h(Loanout)84
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(145)449 3337 y(7.2)105
b(P)o(age)25 b(T)m(ransfer)66 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(146)679 3486 y(7.2.1)118
b(K)n(ernel)25 b(P)o(age)g(T)m(ransfer)52 b(.)e(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
39 b(147)679 3635 y(7.2.2)118 b(Anon)o(ymous)23 b(P)o(age)i(T)m
(ransfer)59 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(148)679 3785 y(7.2.3)118
b(Disposing)23 b(of)i(T)m(ransfered)g(Data)93 b(.)49
b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)39 b(149)449 3934 y(7.3)105 b(Map)24 b(Entry)g(P)o(assing)84
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(149)679 4083 y(7.3.1)118 b(Export)24 b(and)h(Import)f(of)h(V)-6
b(irtual)24 b(Memory)55 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)39 b(150)679 4233 y(7.3.2)118 b(Implementation)23
b(of)i(Map)g(Entry)f(P)o(assing)47 b(.)j(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(152)679 4382 y(7.3.3)118
b(Usage)25 b(of)g(Map)g(Entry)f(P)o(assing)56 b(.)50
b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)39 b(153)449 4532 y(7.4)105 b(Summary)80 b(.)50
b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(155)300 4781 y Fo(8)99 b(Secondary)27 b(Design)d(Elements)82
b Fn(:)50 b(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)92 b Fo(156)449
4930 y Fs(8.1)105 b(Amap)24 b(Chunking)30 b(.)50 b(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(156)449 5079 y(8.2)105
b(Clustered)24 b(Anon)o(ymous)f(Memory)h(P)o(ageout)58
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)39 b(157)449 5229 y(8.3)105 b(The)24 b(Anon)o(ymous)f(Memory)h
(Object)g(P)o(ager)90 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(159)2047 5400 y(vii)p
eop
%%Page: 8 11
8 10 bop 679 100 a Fs(8.3.1)118 b(The)25 b Fm(uvm)p 1363
100 30 4 v 35 w(aobj)f Fs(Structure)97 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(159)679 249 y(8.3.2)118 b(The)25 b(Aobj)f(P)o(ager)i(Functions)72
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)39 b(160)449 398 y(8.4)105 b(The)24
b(De)n(vice)h(P)o(ager)58 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)39 b(160)449 548 y(8.5)105 b(The)24 b(Vnode)h(P)o(ager)72
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(161)679 697 y(8.5.1)118 b(BSD)26 b(VM)e(Vnode)h(Management)55
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)39 b(161)679 847 y(8.5.2)118 b(UVM)25 b(Vnode)f(Management)
52 b(.)e(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)39 b(163)679 996 y(8.5.3)118 b(Vnode)25
b(Helper)g(Functions)65 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(164)449
1145 y(8.6)105 b(Memory)24 b(Mapping)f(Functions)69 b(.)50
b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(166)449 1295 y(8.7)105
b(Unmapping)23 b(Memory)77 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)39 b(170)449 1444 y(8.8)105 b(K)n(ernel)24 b(Memory)g(Management)33
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(171)679 1594 y(8.8.1)118
b(K)n(ernel)25 b(Memory)f(Management)g(Functions)43 b(.)50
b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(171)679 1743 y(8.8.2)118 b(K)n(ernel)25 b(Memory)f(Objects)79
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(172)679 1892 y(8.8.3)118
b(Comparison)24 b(of)h(BSD)h(VM)e(and)h(UVM)f(K)n(ernel)h(Memory)f
(Management)57 b(.)39 b(173)449 2042 y(8.9)105 b(W)l(ired)24
b(Memory)79 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(175)679 2191 y(8.9.1)118 b(W)l(iring)25 b(and)f(Map)h(Entry)f
(Fragmentation)61 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)39 b(177)679 2341 y(8.9.2)118 b(W)l(iring)25
b(Under)f(UVM)87 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(178)449 2490 y(8.10)55 b(Minor)24 b(Mapping)f(Issues)89
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(179)679
2639 y(8.10.1)68 b(Buf)n(fer)26 b(Map)57 b(.)50 b(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(179)679 2789 y(8.10.2)68
b(Obsolete)24 b Fm(MAP)p 1562 2789 V 36 w(FILE)g Fs(Interf)o(ace)60
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)39 b(180)449 2938 y(8.11)55 b(P)o(age)25
b(Flags)35 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)39 b(180)449 3087 y(8.12)55 b(VM)24 b(System)g(Startup)50
b(.)g(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(182)679 3237 y(8.12.1)68 b(Before)26 b(VM)f(Startup:)30
b(Physical)24 b(Memory)g(Con\002guration)55 b(.)50 b(.)g(.)f(.)h(.)g(.)
g(.)f(.)39 b(182)679 3386 y(8.12.2)68 b(UVM')-5 b(s)24
b(Physical)g(Memory)g(Con\002guration)h(Interf)o(ace)33
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(184)679
3536 y(8.12.3)68 b(UVM)25 b(Startup)f(Procedure)73 b(.)50
b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)39 b(185)449 3685 y(8.13)55 b(Ne)n(w)24
b(Pmap)h(Interf)o(ace)i(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)39 b(185)679 3834 y(8.13.1)68 b(P)o(age)25 b(Functions)62
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(186)679
3984 y(8.13.2)68 b(K)n(ernel)25 b(Pmap)g(Enter)f(Functions)91
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)39 b(186)679 4133 y(8.13.3)68 b(Other)25
b(Changes)78 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(187)449 4283 y(8.14)55 b(Ne)n(w)24 b(I386)h(Pmap)f(Module)86
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(188)679
4432 y(8.14.1)68 b(UVM)25 b(Pmap)g(Features)g(From)g(Other)g(Operating)
f(Systems)46 b(.)k(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(189)679
4581 y(8.14.2)68 b(UVM-Speci\002c)26 b(Pmap)f(Features)70
b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)39 b(190)449 4731 y(8.15)55 b(Summary)80
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(191)300 4980 y Fo(9)99 b(Implementation)26 b(Methods)k
Fn(:)50 b(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)92 b Fo(193)449
5129 y Fs(9.1)105 b(UVM)24 b(Implementation)f(Strate)o(gy)46
b(.)j(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(193)2034 5400 y(viii)p
eop
%%Page: 9 12
9 11 bop 679 100 a Fs(9.1.1)118 b(Phase)26 b(1:)k(Study)25
b(of)f(BSD)i(VM)85 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(194)679 249 y(9.1.2)118
b(Phase)26 b(2:)k(UVM)24 b(Under)h(BSD)h(VM)68 b(.)50
b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(194)679 398 y(9.1.3)118 b(Phase)26 b(3:)k(Users)25
b(Under)g(UVM)71 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(195)679 548 y(9.1.4)118
b(Phase)26 b(4:)k(K)n(ernel)25 b(Under)f(UVM)30 b(.)50
b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)39 b(196)679 697 y(9.1.5)118 b(Source)26 b(T)m(ree)f
(Management)94 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(196)449 847 y(9.2)105
b(UVMHIST)-5 b(:)24 b(UVM)g(Function)h(Call)f(History)35
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)39 b(197)679 996 y(9.2.1)118 b(UVMHIST)25 b(As)g(an)g
(Educational)e(T)-8 b(ool)80 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(198)679 1145 y(9.2.2)118
b(UVMHIST)25 b(and)g(Redundant)f(VM)h(Calls)74 b(.)50
b(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(199)679 1295 y(9.2.3)118 b(UVMHIST)25 b(and)g(UVM)f(Design)g
(Adjustments)76 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
39 b(201)449 1444 y(9.3)105 b(UVM)24 b(and)h(the)f(K)n(ernel)h(Deb)n
(ugger)33 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(202)449 1594
y(9.4)105 b(UVM)24 b(User)n(-Le)n(v)o(el)g(Applications)55
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(202)449 1743 y(9.5)105
b(Summary)80 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(203)300 1992 y Fo(10)49 b(Results)27
b Fn(:)50 b(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)
g(:)g(:)g(:)g(:)92 b Fo(206)449 2141 y Fs(10.1)55 b(P)o(age)25
b(Loanout)f(Performance)58 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(206)679 2291 y(10.1.1)68 b(Sock)o(et)25 b(Layer)h(Modi\002cations)88
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(208)679 2440 y(10.1.2)68 b(P)o(age)25
b(Loanout)f(Measurements)40 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(210)449
2590 y(10.2)55 b(P)o(age)25 b(T)m(ransfer)g(Performance)56
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(211)679 2739
y(10.2.1)68 b(Sock)o(et)25 b(Layer)h(Modi\002cations)88
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(213)679 2888 y(10.2.2)68 b(P)o(age)25
b(T)m(ransfer)g(Measurements)38 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(214)449
3038 y(10.3)55 b(Using)23 b(UVM)i(to)f(T)m(ransfer)h(Data)g(Between)h
(Processes)82 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)39 b(216)679 3187 y(10.3.1)68 b(Sock)o(et)25 b(Layer)h
(Modi\002cations)88 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(217)679 3337
y(10.3.2)68 b(Process)26 b(Data)f(T)m(ransfer)f(Measurements)86
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(218)449 3486 y(10.4)55 b(Map)24 b(Entry)g(P)o(assing)g(Performance)75
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)39 b(220)679 3635 y(10.4.1)68
b(Data)25 b(Exchange)g(W)l(ith)f(Map)h(Entry)f(P)o(assing)g
(Measurements)j(.)50 b(.)f(.)h(.)g(.)g(.)f(.)39 b(220)679
3785 y(10.4.2)68 b(Data)25 b(Pipeline)g(W)l(ith)f(Map)h(Entry)f(P)o
(assing)g(and)g(P)o(age)i(Loanout)31 b(.)49 b(.)h(.)g(.)g(.)f(.)39
b(222)449 3934 y(10.5)55 b(Secondary)25 b(Design)f(Element)g
(Performance)46 b(.)k(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)39 b(224)679 4083 y(10.5.1)68
b(Process)26 b(Creation)f(and)f(Deletion)61 b(.)49 b(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(224)679 4233 y(10.5.2)68 b(Clustered)25 b(P)o(ageout)95
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(226)679 4382
y(10.5.3)68 b(Resident)25 b(P)o(age)g(F)o(aulting)49
b(.)g(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(227)679 4532 y(10.5.4)68
b(Map)25 b(Entry)f(Fragmentation)85 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(228)449 4681 y(10.6)55 b(UVM)24 b(Compared)h(to)f(Related)i(W)-8
b(ork)91 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(229)449 4830 y(10.7)55
b(Summary)80 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(230)2061 5400 y(ix)p eop
%%Page: 10 13
10 12 bop 300 100 a Fo(11)49 b(Conclusions)25 b(and)h(Futur)n(e)g
(Resear)n(ch)59 b Fn(:)50 b(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)92 b Fo(232)449
249 y Fs(11.1)55 b(Contrib)n(utions)69 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(232)449 398 y(11.2)55
b(Future)25 b(Research)43 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(235)300 647 y Fo(A)n(ppendix)26
b(A)e(Glossary)36 b Fn(:)50 b(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)
g(:)g(:)g(:)92 b Fo(237)300 896 y(Refer)n(ences)102 b
Fn(:)50 b(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)
g(:)g(:)g(:)92 b Fo(242)300 1145 y(V)l(ita)77 b Fn(:)50
b(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g
(:)g(:)g(:)g(:)g(:)g(:)f(:)h(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)g(:)f(:)
h(:)g(:)g(:)g(:)g(:)92 b Fo(249)2075 5400 y Fs(x)p eop
%%Page: 11 14
11 13 bop 300 824 a Fp(List)52 b(of)g(T)-19 b(ables)449
1388 y Fs(2.1)105 b(The)24 b(init)g(program')-5 b(s)24
b(virtual)g(address)h(space)g(attrib)n(utes)46 b(.)k(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(11)449 1538 y(2.2)105
b(VM)24 b(MD/MI)g(layering)69 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)88 b(19)449 1770 y(3.1)105 b(Changes)25 b(from)f(BSD)i(VM)f(.)
50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(53)449 1920
y(3.2)105 b(Issues)24 b(addressed)h(by)f(UVM)97 b(.)50
b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(54)449 2152 y(4.1)105
b(amap)24 b(API)68 b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)88 b(79)449 2301 y(4.2)105 b(The)24
b(symbols)f(used)i(in)f(a)i(memory)d(diagram)64 b(.)50
b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)88 b(92)449 2534 y(5.1)105 b(F)o(ault)24 b(lookup)f(functions)90
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(105)449
2766 y(6.1)105 b(The)24 b(P)o(ager)i(Operations)48 b(.)i(.)g(.)f(.)h(.)
g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(119)449 2999 y(8.1)105
b(The)24 b(Eight)g(BSD)i(VM)e(memory)g(mapping)g(functions)35
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(166)449 3148 y(8.2)105 b(The)24 b(\002)n(v)o(e)h(UVM)f(memory)g
(mapping)g(functions)k(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(168)449 3380 y(9.1)105
b(Useful)24 b(UVM)g(DDB)i(Commands)52 b(.)d(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(203)449 3613 y(10.1)55 b(P)o(age)25 b(f)o(ault)f(counts)83
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(228)449 3762 y(10.2)55 b(Comparison)24 b(of)g(the)h(number)f(of)h
(allocated)g(map)f(entries)62 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)39 b(229)2061 5400 y(xi)p eop
%%Page: 12 15
12 14 bop 300 824 a Fp(List)52 b(of)g(Figur)l(es)449
1388 y Fs(1.1)105 b(T)m(ransmitting)22 b(disk)i(data)h(o)o(v)o(er)f(a)h
(netw)o(ork)77 b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)138 b(2)449 1621 y(2.1)105
b(The)24 b(role)h(of)g(the)g(VM)f(system)63 b(.)50 b(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)138 b(9)449 1770 y(2.2)105 b(The)24 b(init)g(program')-5
b(s)24 b(virtual)g(memory)g(layout)80 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(12)449
1920 y(2.3)105 b(Handling)23 b(cop)o(y-on-write)i(pages)f(when)h(read)g
(and)g(write)g(f)o(aults)f(occur)98 b(.)49 b(.)h(.)g(.)g(.)f(.)88
b(15)449 2069 y(2.4)105 b(BSD)25 b(VM)g(f)o(amily)f(tree)79
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(18)449
2218 y(2.5)105 b(The)24 b(\002)n(v)o(e)h(main)f(machine-independent)g
(VM)g(data)h(structures)40 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)88 b(22)449 2368 y(2.6)105 b(The)24 b(VM)h(map)f(data)h(structure)39
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(23)449 2517
y(2.7)105 b(The)24 b(VM)h(map)f(entry)h(structure)75
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(24)449 2667 y(2.8)105
b(The)24 b(VM)h(object)f(structure)84 b(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)88 b(25)449 2816 y(2.9)105 b(The)24 b(VM)h(pager)g(data)g
(structure)64 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(26)449
2965 y(2.10)55 b(The)24 b(VM)h(page)g(structure)64 b(.)50
b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(27)449 3115
y(2.11)55 b(The)24 b(cop)o(y-on-write)h(mapping)e(of)i(a)g(\002le)69
b(.)50 b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)88 b(29)449 3264 y(2.12)55 b(The)24 b(cop)o(y-on-write)
h(mapping)e(after)j(a)f(fork)79 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(30)449 3413
y(2.13)55 b(The)24 b(cop)o(y-on-write)h(mapping)e(after)j(the)e(child)h
(e)o(xits)54 b(.)c(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)88 b(31)449 3563 y(2.14)55 b(Pri)n(v)n(ate)24 b(cop)o(y-on-write)g
(mapping)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(32)449 3712
y(2.15)55 b(Cop)o(y)24 b(cop)o(y-on-write)h(mapping)37
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(33)449 3945 y(3.1)105
b(UVM)24 b(data)h(structures)f(at)h(a)g(glance)78 b(.)50
b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(46)449 4094 y(3.2)105 b(The)24
b(UVM)h(pagedaemon)f(and)h(lock)f(ordering)70 b(.)50
b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(49)449 4243 y(3.3)105 b(The)24 b(UVM)h(object)f(structure)86
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(51)449 4476
y(4.1)105 b(The)24 b(aref)i(structure)59 b(.)49 b(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(78)449 4625 y(4.2)105
b(Splitting)23 b(an)i(aref)51 b(.)f(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)88 b(78)449 4775 y(4.3)105 b(The)24 b(anon)h(structure)
94 b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(79)449 4924 y(4.4)105 b(A)24 b(simple)g(array-based)i(amap)e
(implementation)68 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(80)449 5073 y(4.5)105 b(A)24
b(simple)g(list-based)g(amap)g(implementation)76 b(.)50
b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(80)449 5223 y(4.6)105 b(UVM)24 b(reference)i(amap)f(structure)48
b(.)h(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(81)2047 5400 y(xii)p
eop
%%Page: 13 16
13 15 bop 449 100 a Fs(4.7)105 b(UVM)24 b(reference)i(amap)f
(structure')-5 b(s)24 b(three)h(main)f(arrays)88 b(.)49
b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(81)449
249 y(4.8)105 b(A)24 b(partial)h(unmap)f(of)h(an)g(amap)g(.)50
b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(82)449 398 y(4.9)105
b(Per)n(-page)26 b(reference)g(counters)e(with)g(unmapping)j(.)49
b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(84)449 548 y(4.10)55 b(Per)n(-page)26 b(reference)g(counters)e(with)g
(length)77 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(85)449 697 y(4.11)55 b(Code)25
b(to)f(\002nd)h(the)g(per)n(-page)g(reference)i(count)d(and)h(length)90
b(.)50 b(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88
b(85)449 847 y(4.12)55 b(Encoded)24 b(per)n(-page)h(reference)i(count)d
(array)73 b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)88 b(86)449 996 y(4.13)55 b(Pseudo)24
b(code)h(for)g(fork)84 b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
88 b(92)449 1145 y(4.14)55 b(A)24 b(sample)h(memory)f(diagram)52
b(.)e(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(93)449 1295 y(4.15)55
b(Share)25 b(inheritance)73 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)88 b(93)449 1444 y(4.16)55 b(Cop)o(y)24
b(inheritance)85 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f
(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)88 b(94)449 1594 y(4.17)55 b(Clearing)25 b(needs-cop)o(y)f(after)i
(a)f(cop)o(y-inheritance)f(fork)56 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)88 b(94)449 1743 y(4.18)55 b(Erroneous)24
b(fork)92 b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)
88 b(95)449 1892 y(4.19)55 b(Erroneous)24 b(fork)h(after)g(process)g
(three)g(write-f)o(aults)48 b(.)i(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)88 b(96)449 2042 y(4.20)55 b(The)24
b(correct)i(handling)d(of)i(the)g(erroneous)g(fork)45
b(.)50 b(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)88 b(96)449 2191 y(4.21)55 b(T)-8 b(w)o(o)24 b(processes)h(sharing)
f(an)h(amap)32 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(97)449
2341 y(4.22)55 b(Erroneous)24 b(cop)o(y-inherit)g(fork)29
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(98)449 2490
y(4.23)55 b(Erroneous)24 b(cop)o(y-inherit)g(fork)29
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)88 b(98)449 2722
y(5.1)105 b(High-le)n(v)o(el)23 b(pseudo)h(code)h(for)g(the)f(f)o(ault)
h(routine)69 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)39 b(101)449 2872 y(5.2)105 b(The)24 b(f)o(aultinfo)g
(data)h(structure)54 b(.)c(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(103)449 3021 y(5.3)105 b(The)24 b Fm(uvmfault)p 1344
3021 30 4 v 34 w(anonget)g Fs(function)44 b(.)50 b(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(108)449 3171 y(5.4)105 b(Anon)24 b(f)o(ault)g(sub-cases)82
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(108)449
3320 y(5.5)105 b(Object)24 b(f)o(ault)h(sub-cases)37
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(110)449
3469 y(5.6)105 b(F)o(ault)24 b(pseudo)g(code)44 b(.)49
b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(112)449 3702 y(6.1)105 b(P)o(ager)25 b(data)g(structures)87
b(.)50 b(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(130)449
3851 y(6.2)105 b(The)24 b(unnecessary)h Fm(vm)p 1496
3851 V 36 w(pager)p 1832 3851 V 34 w(put)p 2046 3851
V 36 w(pages)e Fs(function)59 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)39 b(131)449 4084 y(7.1)105 b(P)o(age)25
b(loanout)h(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)
g(.)f(.)39 b(136)449 4233 y(7.2)105 b(P)o(age)25 b(transfer)96
b(.)50 b(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(147)449 4382 y(7.3)105 b(Map)24 b(entry)h(passing)30
b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)
g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(150)449 4532 y(7.4)105 b(The)24 b Fm(mexpimp)p 1284
4532 V 35 w(info)g Fs(structure)43 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f
(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(151)449 4764 y(8.1)105 b(The)24 b(BSD)i(VM)e(call)h(paths)f(for)i
(the)e(four)h(mapping)f(system)f(calls)87 b(.)49 b(.)h(.)g(.)f(.)h(.)g
(.)g(.)f(.)39 b(167)449 4914 y(8.2)105 b(UVM')-5 b(s)23
b(mapping)h(call)h(path)j(.)49 b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)
f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(169)449 5146 y(9.1)105 b(UVMHIST)24 b(usage)62 b(.)49
b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(198)2034 5400 y(xiii)p eop
%%Page: 14 17
14 16 bop 449 100 a Fs(9.2)105 b(A)24 b(screen)i(dump)e(of)h(the)f
Fm(xuvmstat)f Fs(program)90 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)
h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(205)449 332 y(10.1)55
b(Sock)o(et)25 b Fm(write)e Fs(code)i(path)63 b(.)49
b(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g
(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(209)449 481 y(10.2)55
b(Comparison)24 b(of)g(cop)o(y)h(and)g(loan)f(procedures)h(for)g
(writing)f(to)g(a)i(null)d(sock)o(et)61 b(.)50 b(.)g(.)f(.)39
b(211)449 631 y(10.3)55 b(Sock)o(et)25 b Fm(read)f Fs(code)h(path)47
b(.)j(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39 b(213)449
780 y(10.4)55 b(Comparison)24 b(of)g(cop)o(y)h(and)g(transfer)g
(procedures)g(for)g(reading)g(from)f(a)h(null)f(sock)o(et)h(.)39
b(215)449 930 y(10.5)55 b(Comparison)30 b(of)i(cop)o(y)-6
b(,)32 b(transfer)l(,)i(loan,)f(and)e(both)g(procedures)h(for)f(mo)o
(ving)f(data)679 1079 y(o)o(v)o(er)24 b(a)h(pipe)j(.)50
b(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g
(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(219)449 1228 y(10.6)55 b(Comparison)28 b(of)h(cop)o(y)g(and)g(map)f
(entry)h(passing)f(\(m.e.p.\))43 b(transferring)29 b(memory)679
1378 y(between)24 b(tw)o(o)h(processes)79 b(.)50 b(.)f(.)h(.)g(.)f(.)h
(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)
h(.)g(.)g(.)f(.)39 b(222)449 1527 y(10.7)55 b(Comparison)24
b(of)g(cop)o(y)h(and)g(map)f(entry)h(passing/page)e(loanout)h(pipeline)
92 b(.)50 b(.)g(.)g(.)f(.)39 b(223)449 1677 y(10.8)55
b(Process)25 b(creation)g(and)f(deletion)g(o)o(v)o(erhead)g(under)h
(BSD)h(VM)e(and)h(UVM)75 b(.)50 b(.)g(.)g(.)f(.)39 b(225)449
1826 y(10.9)55 b(Memory)24 b(allocation)f(time)h(under)h(BSD)h(VM)e
(and)h(UVM)67 b(.)49 b(.)h(.)g(.)g(.)f(.)h(.)g(.)f(.)h(.)g(.)g(.)f(.)39
b(227)2038 5400 y(xi)n(v)p eop
%%Page: 15 18
15 17 bop 300 824 a Fp(Ackno)n(wledgments)300 1288 y
Fs(Designing,)21 b(implementing,)e(and)i(testing)f(a)i(softw)o(are)f
(system)g(as)g(lar)n(ge)h(and)f(comple)o(x)f(as)h(UVM)g(w)o(as)300
1421 y(quite)30 b(a)h(challenge.)48 b(I)31 b(w)o(ould)f(ne)n(v)o(er)g
(ha)n(v)o(e)g(been)h(able)g(to)f(complete)g(such)h(a)g(task)f(without)f
(support)300 1553 y(from)34 b(my)f(colleagues,)j(friends,)f(and)f(f)o
(amily)-6 b(.)57 b(Thus,)35 b(I)f(am)g(pleased)g(to)f(ha)n(v)o(e)h(the)
g(opportunity)d(to)300 1686 y(thank)24 b(them)g(in)h(my)f
(dissertation.)583 1818 y(I)h(w)o(ould)f(\002rst)h(lik)o(e)f(to)g
(thank)g(my)g(advisor)g(Dr)-5 b(.)24 b(Gurudatta)g(P)o(arulkar)h(for)g
(encouraging)f(me)g(to)300 1950 y(attend)i(W)-8 b(ashington)26
b(Uni)n(v)o(ersity)e(and)j(for)g(pro)o(viding)e(funding)h(throughout)f
(my)i(years)g(in)f(St.)h(Louis)300 2083 y(\(e)n(v)o(en)d(during)f(the)i
(\223hard)f(times\224\).)30 b(Ha)n(ving)24 b(an)h(advisor)e(who)h(is)g
(accessible,)h(easy)f(to)g(communicate)300 2215 y(with,)g(and)h
(supporti)n(v)o(e)d(certainly)j(has)f(made)h(my)f(life)h(easier)-5
b(.)583 2348 y(I)38 b(w)o(ould)d(also)i(lik)o(e)f(to)h(thank)f(the)g
(rest)h(of)g(my)f(committee)g(for)h(taking)f(the)g(time)g(to)h(learn)
300 2480 y(about)25 b(my)h(w)o(ork)f(and)h(pro)o(viding)e(me)i(with)f
(v)n(aluable)g(feedback)i(on)e(ho)n(w)g(it)h(could)f(be)h(impro)o(v)o
(ed.)32 b(In)300 2613 y(addition)f(to)g(pro)o(viding)f(feedback)j(on)e
(my)h(research,)i(my)e(committee)e(has)i(also)g(been)g(a)g(source)g(of)
300 2745 y(inspiration.)42 b(Dr)-5 b(.)28 b(Geor)n(ge)i(V)-11
b(ar)n(ghese')-5 b(s)29 b(constant)f(enthusiasm)f(for)i(research)h(and)
f(my)g(w)o(ork)f(helped)300 2877 y(me)33 b(k)o(eep)f(my)g(spirits)g(up)
g(throughout)f(this)h(project.)54 b(Dr)-5 b(.)32 b(Douglas)g(Schmidt')
-5 b(s)31 b(boundless)h(ener)n(gy)300 3010 y(and)24 b(vie)n(ws)e(on)h
(ho)n(w)g(to)g(sell)g(systems)g(research)h(helped)f(me)h(impro)o(v)o(e)
e(the)h(presentation)g(of)g(my)g(w)o(ork)300 3142 y(by)30
b(teaching)g(me)h(to)f(look)f(at)i(it)f(from)g(ne)n(w)g(points)f(of)i
(vie)n(w)-6 b(.)47 b(Dr)-5 b(.)30 b(Ron)g(Cytron')-5
b(s)30 b(natural)g(curiosity)300 3275 y(and)c(willingness)e(to)i(e)o
(xamine)f(research)i(outside)e(of)h(his)g(primary)f(area)j(of)e
(interest)f(sho)n(wed)g(me)h(the)300 3407 y(v)n(alue)h(of)g(being)g
(open)f(minded.)37 b(Finally)-6 b(,)27 b(Dr)-5 b(.)27
b(Ronald)g(Minnich)f(taught)g(me)h(the)g(v)n(alue)g(of)g(patience)300
3539 y(and)e(perse)n(v)o(erance)g(when)f(w)o(orking)g(on)h(lar)n(ge)g
(softw)o(are)g(projects.)583 3672 y(Se)n(v)o(eral)31
b(BSD)h(de)n(v)o(elopers)e(helped)g(in)h(the)f(latter)h(stages)f(of)h
(this)f(project.)49 b(I)31 b(w)o(ould)f(lik)o(e)g(to)300
3804 y(thank)21 b(Matthe)n(w)f(Green)i(for)g(helping)e(to)h(write)g
(and)h(deb)n(ug)f(UVM')-5 b(s)20 b(sw)o(ap)h(management)g(code.)30
b(Matt)300 3937 y(also)h(coordinated)f(the)h(inte)o(gration)e(of)i(UVM)
g(into)f(the)h(NetBSD)g(source)g(tree.)50 b(Thanks)30
b(to)h(Chuck)300 4069 y(Silv)o(ers)g(for)h(writing)f(the)g(aobj)g
(pager)i(for)e(me)h(and)g(helping)e(with)h(deb)n(ugging.)50
b(Finally)-6 b(,)33 b(thanks)d(to)300 4202 y(Jason)24
b(Thorpe)h(for)g(helping)f(to)g(port)h(UVM)f(to)g(ne)n(w)h(platforms.)
583 4334 y(There)f(are)g(a)f(number)g(of)g(people)g(who)g(contrib)n
(uted)f(indirectly)g(to)g(the)h(success)g(of)h(the)f(UVM)300
4466 y(project.)71 b(I)39 b(w)o(ould)e(ha)n(v)o(e)h(ne)n(v)o(er)g(gone)
g(to)g(graduate)g(school)g(if)g(it)g(w)o(as)g(not)g(for)h(my)e(in)l(v)n
(olv)o(ement)300 4599 y(in)31 b(under)n(graduate)g(research)h(at)g(Uni)
n(v)o(ersity)d(of)i(Dela)o(w)o(are.)50 b(I)31 b(credit)h(Professor)f
(Da)n(vid)g(F)o(arber)h(for)300 4731 y(allo)n(wing)21
b(me)i(to)f(join)g(his)h(research)g(group)g(\223F-T)m(roup.)-7
b(\224)30 b(My)22 b(positi)n(v)o(e)f(e)o(xperiences)h(as)h(a)h(member)e
(of)300 4864 y(F-T)m(roup)29 b(con)l(vinced)g(me)g(that)g(I)g(w)o
(anted)g(to)g(continue)g(my)f(education)h(be)o(yond)f(my)h(under)n
(graduate)300 4996 y(de)o(gree.)i(I)25 b(w)o(ould)f(lik)o(e)g(to)h
(thank)f(all)g(my)h(friends)f(from)h(Uni)n(v)o(ersity)d(of)j(Dela)o(w)o
(are.)2050 5400 y(xv)p eop
%%Page: 16 19
16 18 bop 583 100 a Fs(W)-8 b(ashington)25 b(Uni)n(v)o(ersity')-5
b(s)23 b(Computer)j(Science)g(Department,)g(Computer)f(and)h(Communi-)
300 232 y(cations)20 b(Research)j(Center)e(\(CCRC\),)j(and)d(Applied)f
(Research)i(Lab)f(\(ARL\))h(ha)n(v)o(e)f(been)g(a)h(w)o(onderful)300
364 y(en)l(vironment)c(in)g(which)h(to)f(w)o(ork.)29
b(The)19 b(three)g(k)o(e)o(y)f(ingredients)g(to)h(this)f(en)l
(vironment)f(are)j(the)f(f)o(aculty)-6 b(,)300 497 y(staf)n(f,)29
b(and)g(students.)41 b(The)29 b(f)o(aculty)f(has)h(contrib)n(uted)f(to)
g(this)g(en)l(vironment)f(by)i(obtaining)e(research)300
629 y(funding)d(for)g(graduate)h(students,)e(teaching)h(interesting)f
(courses,)i(and)f(mentoring)f(their)i(students.)k(I)300
762 y(w)o(ould)23 b(particularly)g(lik)o(e)g(to)g(thank)g(Dr)-5
b(.)23 b(T)l(urner)l(,)g(Dr)-5 b(.)23 b(Cox,)h(Dr)-5
b(.)23 b(Franklin,)h(and)f(Dr)-5 b(.)24 b(Chamberlain)f(for)300
894 y(their)i(roles)f(in)h(forming)e(and)i(maintaining)e(the)i(CCRC)h
(and)f(ARL)g(research)h(labs.)583 1027 y(The)h(CS,)h(CCRC,)g(and)f(ARL)
g(of)n(\002ce)g(staf)n(f)f(ha)n(v)o(e)h(helped)f(me)h(maintain)e(my)h
(sense)h(of)g(humor)300 1159 y(while)22 b(I)h(ha)n(v)o(e)g(made)f(my)g
(w)o(ay)h(through)f(the)g(administrati)n(v)o(e)e(red)j(tape)g(that)f
(comes)h(with)e(a)i(uni)n(v)o(ersity)300 1291 y(b)n(ureaucrac)o(y)-6
b(.)37 b(I)27 b(w)o(ould)f(lik)o(e)g(to)h(thank)f(Jean,)i(Sharon,)f
(Myrna,)g(Pe)o(ggy)-6 b(,)27 b(P)o(aula,)g(Diana,)h(Vykk)o(y)-6
b(,)25 b(and)300 1424 y(the)g(rest)f(of)h(the)g(staf)n(f)f(for)h(their)
g(assistance)f(during)g(my)h(years)g(at)g(W)-8 b(ashington)23
b(Uni)n(v)o(ersity)-6 b(.)583 1556 y(I)40 b(w)o(ould)f(lik)o(e)g(to)g
(thank)g(my)g(fello)n(w)f(students)g(for)i(their)f(friendship)g(during)
g(my)f(stay)h(in)300 1689 y(St.)f(Louis.)71 b(First,)41
b(I)e(w)o(ould)f(lik)o(e)f(to)h(thank)g(the)h(members)e(of)i(my)e
(research)j(group.)71 b(Thanks)37 b(to)300 1821 y(Milind)29
b(Buddhik)o(ot,)h(Zubin)g(Dittia,)h(R.)g(Gopalakrishnan)e(\(Gopal\),)j
(and)e(Christos)g(P)o(apadopoulos.)300 1954 y(Milind)h(k)o(ept)g(me)h
(entertained)g(through)f(his)h(tales)g(of)g(w)o(oe)g(and)g(w)o(onder)g
(and)h(also)e(by)h(lea)n(ving)g(his)300 2086 y(k)o(e)o(ys)h(and)g(w)o
(allet)g(at)g(random)g(locations)f(throughout)g(CCRC)j(\(despite)e(my)g
(best)g(ef)n(forts)g(to)g(break)300 2218 y(him)23 b(of)g(this)g
(habit\).)30 b(Zubin)23 b(taught)g(me)g(the)h(v)n(alue)f(of)g
(\223great)h(fun\224)g(by)g(being)f(willing)f(to)h(drop)g(all)h(his)300
2351 y(w)o(ork)31 b(at)g Fq(any)h Fs(time)e(on)h(short)g(notice)f(so)h
(that)g(we)h(could)e(go)h(w)o(atch)g(a)h(mo)o(vie.)49
b(Gopal)31 b(shared)g(both)300 2483 y(his)c(wit)g(and)h(his)f
(technique)h(for)g(gi)n(ving)e(technical)h(presentations)g(\(the)h
(\223freight-train)g(approach\224\).)300 2616 y(Christos)35
b(went)h(from)g(spending)f(a)h(year)h(car)n(-less)f(to)g(becoming)f
(our)h(research)h(group')-5 b(s)35 b(top)g(auto)300 2748
y(mechanic,)24 b(and)h(I)g(thank)f(him)f(for)i(all)f(his)g(service.)31
b(I)25 b(w)o(ould)f(also)g(lik)o(e)g(to)g(thank)g(Anshul)f(Kanta)o(w)o
(ala)300 2880 y(for)35 b(coining)f(the)h(often-used)f(phrase)h(\223you)
g(fool!\224)61 b(and)35 b(Hari)g(Adiseshu)e(for)i(letting)f(me)h
(resolv)o(e)300 3013 y(some)30 b(of)h(his)f(technical)h(doubts.)48
b(Thanks)30 b(to)h(the)f(rest)h(of)g(the)g(group)f(\(James,)i(T)-8
b(on)o(y)i(,)31 b(Sanjay)-6 b(,)32 b(Jim,)300 3145 y(V)-6
b(ikas,)28 b(Deepak,)h(Larry)-6 b(,)28 b(Hossam,)g(Marcel,)g(Dan,)h
(Jane,)g(W)-8 b(oody)i(,)27 b(Sherlia,)i(Daphne,)f(Y)-11
b(uhang,)28 b(and)300 3278 y(Ed\))d(for)g(their)f(support.)583
3410 y(Thanks)29 b(to)g(Sarang)h(Joshi)e(and)h(Gaura)n(v)g(Gar)n(g)h
(for)f(helping)g(me)g(get)g(through)f(my)g(\002rst)i(year)300
3543 y(in)25 b(St.)g(Louis.)31 b(Thanks)24 b(to)h(Gre)o(g)g(Peterson)g
(for)g(helping)g(me)g(to)f(arrange)i(the)f(\223phool\224)g(mo)o(vie)f
(nights.)300 3675 y(Thanks)g(to)g(Brad)h(Noble)f(for)h(the)f(great)h
(con)l(v)o(ersations,)e(k)o(eeping)h(Rob)g(in)g(control,)g(and)h
(introducing)300 3807 y(Elvis)32 b(to)h(the)h(back)f(hall)o(w)o(ay)-6
b(.)56 b(Thanks)33 b(to)g(Giuseppe)g(Bianchi)g(\(Geppo\))g(for)h
(pulling)e(of)n(f)h(the)h(best)300 3940 y(practical)29
b(jok)o(es)f(and)h(not)f(making)f(me)i(a)g(tar)n(get.)43
b(Thanks)28 b(to)g(Re)o(x)h(Hill)f(for)h(introducing)e(me)h(to)h(my)300
4072 y(wife)j(and)g(for)g(helping)e(Zubin)h(mo)o(v)o(e)g(the)g(APIC)i
(a)f(little)f(closer)g(to)h(reality)-6 b(.)51 b(Thanks)31
b(to)g(Shree)i(for)300 4205 y(teaching)f(me)h(about)f(the)g(\223junta.)
-7 b(\224)54 b(And)32 b(thanks)g(to)h(Maurizio)e(Casoni,)k(Girish)d
(Chandranmenon,)300 4337 y(Apostolos)d(Dailianas,)j(Andy)e(Fingerhut,)i
(Rob)f(Jackson,)h(Ste)n(v)o(e)e(v)n(on)h(W)-8 b(orle)o(y)i(,)31
b(and)g(Ellen)f(Ze)o(gura)300 4470 y(for)25 b(making)f(the)h(back)g
(hall)f(a)h(more)g(interesting)e(place.)583 4602 y(Thanks)28
b(to)f(K)n(en)g(W)-8 b(ong)27 b(for)h(letting)f(me)g(help)g(manage)h
(the)f(CCRC)j(systems)c(and)i(for)g(being)300 4734 y(easy)k(and)g(fun)g
(to)g(w)o(ork)f(with.)52 b(Thanks)31 b(to)h(John)f(deHart)h(and)g(Fred)
h(K)o(uhns)e(for)h(helping)f(with)g(the)300 4867 y(ARL)25
b(equipment)f(that)g(I)h(used)g(in)f(my)g(research.)583
4999 y(I)38 b(w)o(ould)f(lik)o(e)h(to)f(thank)g(A)-11
b(T&T)i(-Research)38 b(for)g(allo)n(wing)e(me)h(to)h(use)f(their)h
(summer)f(stu-)300 5132 y(dent)30 b(space)h(during)e(the)h(winter)-5
b(.)47 b(In)30 b(particular)l(,)i(I)f(w)o(ould)e(lik)o(e)h(to)g(thank)g
(P)o(aul)g(Resnick)g(and)h(Brian)2036 5400 y(xvi)p eop
%%Page: 17 20
17 19 bop 300 100 a Fs(LaMacchia)34 b(for)h(allo)n(wing)d(me)i(to)g
(tag)g(along)g(with)f(their)h(group)f(when)h(I)h(w)o(as)f(not)g(in)f
(the)h(best)g(of)300 232 y(moods)d(\(ha)n(ving)g(had)h(to)f(mo)o(v)o(e)
g(to)g(Ne)n(w)h(Jerse)o(y)f(without)g(completing)f(UVM\).)i(I)g(w)o
(ould)f(also)h(lik)o(e)300 364 y(to)c(brie\003y)g(thank)g(the)g(follo)n
(wing)e(people)h(for)i(their)f(support:)36 b(Kalpana)28
b(P)o(arulkar)l(,)h(Nikita)e(P)o(arulkar)l(,)300 497
y(Betsy)j(Cytron,)i(Jessica)e(Cytron,)h(Melanie)f(Cytron,)h(Maya)f
(Gokhale,)h(Austin)e(Minnich,)h(Amanda)300 629 y(Minnich,)36
b(Luk)o(e)f(Bee)o(gle,)j(Chris)d(Handle)o(y)-6 b(,)37
b(P)o(am)e(Perkins,)i(Erik)e(Perkins,)j(Scott)d(Hassan,)i(Penn)o(y)300
762 y(Noble,)25 b(Theo)g(de)g(Raadt,)h(A)l(GES,)f(Joe)h(Edw)o(ards,)f
(Dr)-5 b(.)31 b(Hurle)o(y)-6 b(,)24 b(Elvis)g(Presle)o(y)-6
b(,)25 b(H.P)-11 b(.)26 b(Lo)o(v)o(ecraft,)e(and)300
894 y(the)h(authors)f(of)h(the)f(BSD)i(games)e(in)g Fm(/usr/games)p
Fs(.)583 1027 y(Finally)-6 b(,)25 b(I)g(w)o(ould)f(lik)o(e)h(to)f
(thank)h(my)g(f)o(amily)f(to)h(whom)f(this)g(dissertation)g(is)g
(dedicated.)32 b(My)300 1159 y(wife)h(Lorrie)f(has)h(been)g(a)g
(constant)e(source)i(of)g(support)e(throughout)g(the)i(de)n(v)o
(elopment)d(of)j(UVM.)300 1291 y(Her)21 b(feedback)h(on)e(both)g(the)h
(written)f(and)h(oral)g(presentation)e(of)i(UVM)g(helped)f(me)h
(present)f(comple)o(x)300 1424 y(ideas)j(in)g(a)h(w)o(ay)g(that)f(is)g
(clear)l(,)h(concise,)g(and)f(readable.)31 b(I)24 b(w)o(ould)e(lik)o(e)
h(to)g(thank)g(my)g(parents,)h(Morris)300 1556 y(and)d(Connie)f(Cranor)
l(,)i(for)f(raising)f(and)g(supporting)f(me.)29 b(I)21
b(w)o(ould)f(not)g(be)g(where)h(I)g(am)g(today)f(without)300
1689 y(their)g(support)e(and)i(I)g(am)g(proud)f(to)h(honor)f(them)g
(with)g(my)h(accomplishments.)27 b(I)20 b(w)o(ould)f(lik)o(e)g(to)h
(thank)300 1821 y(Lorrie')-5 b(s)26 b(parents,)g(Drs.)h(Michael)f(and)g
(Judy)g(Ack)o(erman,)h(for)f(accepting)h(me)f(into)f(their)h(f)o(amily)
g(and)300 1954 y(for)21 b(their)f(encouragement)h(and)g(understanding)e
(during)h(my)g(career)i(as)f(a)g(doctorial)f(student.)28
b(Finally)-6 b(,)300 2086 y(I)27 b(w)o(ould)f(lik)o(e)h(to)f(thank)g
(the)h(rest)g(of)g(my)f(f)o(amily)-6 b(,)26 b(including)g(\(b)n(ut)g
(not)g(limited)g(to\))g(my)h(sister)f(Ginn)o(y)-6 b(,)300
2218 y(my)24 b(brother)n(-in-la)o(w)g(Jeremy)-6 b(,)24
b(and)h(all)f(eight)h(of)f(my)h(grandparents)f(for)h(their)g(support.)
3027 2469 y Fl(Charles)k(D.)h(Cranor)300 2672 y Fk(W)-8
b(ashington)23 b(Uni)n(v)o(ersity)g(in)h(Saint)h(Louis)300
2805 y(August)f(1998)2022 5400 y Fs(xvii)p eop
%%Page: 1 21
1 20 bop 3850 100 a Fs(1)300 973 y Fp(Chapter)51 b(1)300
1448 y(Intr)l(oduction)300 1930 y Fs(Ne)n(w)25 b(computer)f
(applications)g(in)h(areas)h(such)f(as)g(multimedia,)e(imaging,)h(and)h
(distrib)n(uted)f(comput-)300 2079 y(ing)34 b(demand)h(high)f(le)n(v)o
(els)g(of)h(performance)g(from)g(the)g(entire)g(computer)f(system.)60
b(F)o(or)35 b(e)o(xample,)300 2229 y(multimedia)h(applications)g(often)
i(require)g(bandwidth)e(on)i(the)g(order)g(gigabits)e(per)i(second.)69
b(Al-)300 2378 y(though)21 b(hardw)o(are)j(speeds)e(ha)n(v)o(e)g(impro)
o(v)o(ed,)f(traditional)g(operating)h(systems)f(ha)n(v)o(e)h(had)g(a)h
(hard)g(time)300 2527 y(k)o(eeping)34 b(up)g([32,)h(50)o(].)60
b(One)35 b(major)f(problem)g(with)g(traditional)f(operating)h(systems)f
(is)h(that)g(the)o(y)300 2677 y(require)26 b(unnecessary)f(data)h
(copies.)33 b(Data)26 b(copies)f(are)h(e)o(xpensi)n(v)o(e)e(for)i(a)g
(number)f(of)g(reasons.)33 b(First,)300 2826 y(the)27
b(bandwidth)e(of)i(main)f(memory)g(is)g(limited.)34 b(Each)27
b(cop)o(y)g(made)f(of)h(the)g(data)f(is)h(ef)n(fected)g(by)f(this.)300
2976 y(Second,)31 b(to)f(cop)o(y)f(data,)i(the)f(CPU)h(must)d(mo)o(v)o
(e)g(it)i(w)o(ord-by-w)o(ord)f(from)h(the)f(source)h(b)n(uf)n(fer)g(to)
f(the)300 3125 y(destination.)47 b(While)30 b(the)g(CPU)i(is)e(b)n(usy)
g(mo)o(ving)e(data)j(it)f(is)g(una)n(v)n(ailable)g(to)g(the)h(user)f
(application.)300 3274 y(Finally)-6 b(,)27 b(data)g(cop)o(ying)f(often)
h(\003ushes)g(useful)g(information)e(out)i(of)g(the)g(cache.)38
b(since)27 b(the)g(CPU)h(ac-)300 3424 y(cesses)23 b(main)g(memory)f
(through)g(the)i(cache,)g(the)f(process)g(of)g(cop)o(ying)g(data)g
(\002lls)g(the)g(cache)h(with)e(the)300 3573 y(data)g(being)f(copied)g
(\227)g(displacing)f(potentially)g(useful)h(data)h(that)f(w)o(as)h
(resident)f(in)g(the)g(cache)i(before)300 3723 y(the)i(cop)o(y)-6
b(.)583 3872 y(Applications)25 b(that)g(transmit)g(data)h(from)g(disk)f
(storage)h(o)o(v)o(er)f(a)h(netw)o(ork)g(are)h(an)f(e)o(xample)f(of)300
4021 y(a)e(class)f(of)h(applications)e(that)h(suf)n(fer)h(from)f
(unnecessary)h(data)g(cop)o(ying.)29 b(Applications)20
b(in)j(this)e(class)300 4171 y(include)34 b(video,)i(\002le,)h(and)e
(web)f(serv)o(ers.)59 b(Figure)35 b(1.1)f(sho)n(ws)f(the)h(path)h(the)f
(data)g(in)g(this)g(class)g(of)300 4320 y(application)28
b(tak)o(es)i(in)f(a)h(traditional)e(system.)43 b(First)30
b(the)f(serv)o(er)h(issues)e(a)i(read)g(request.)45 b(T)-8
b(o)29 b(satisfy)300 4470 y(this)f(request,)i(the)f(k)o(ernel)g
(\002rst)g(has)g(the)g(disk)f(de)n(vice)h(store)f(the)h(data)g(into)g
(a)g(k)o(ernel)g(b)n(uf)n(fer)g(in)g(main)300 4619 y(memory)-6
b(.)28 b(T)-8 b(o)22 b(complete)e(the)i(read)g(request)f(the)g(k)o
(ernel)h(copies)f(the)g(data)h(from)f(the)g(\002rst)h(k)o(ernel)f(b)n
(uf)n(fer)300 4768 y(into)28 b(the)h(b)n(uf)n(fer)h(the)f(user)g
(speci\002ed.)44 b(Note)29 b(that)g(this)f(data)i(cop)o(y)f(tra)n(v)o
(erses)g(the)g(MMU)f(and)h(cache.)300 4918 y(Once)36
b(the)f(data)h(has)f(been)g(read,)k(the)c(serv)o(er)h(application)e
(then)h(immediately)f(writes)h(the)g(data)g(to)300 5067
y(the)c(netw)o(ork)f(sock)o(et)h(\(without)e(e)n(v)o(en)h(accessing)h
(the)g(data\).)49 b(This)30 b(causes)h(the)f(k)o(ernel)h(to)g(cop)o(y)f
(the)300 5217 y(data)e(from)g(the)g(user)h(b)n(uf)n(fer)f(into)f
(another)h(k)o(ernel)g(b)n(uf)n(fer)h(that)e(is)h(associated)g(with)f
(the)h(netw)o(orking)300 5366 y(system.)42 b(The)28 b(k)o(ernel)h(can)g
(then)g(program)f(the)h(netw)o(ork)f(interf)o(ace)i(to)e(read)i(the)e
(data)h(directly)f(from)p eop
%%Page: 2 22
2 21 bop 3850 100 a Fs(2)720 2016 y @beginspecial 0 @llx
0 @lly 473 @urx 320 @ury 3311 @rwi @setspecial
%%BeginDocument: ../figures/netcopy.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-68.0 489.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 8182 m 0 0 l 9052 0 l 9052 8182 l cp clip
 0.06000 0.06000 sc
% Polyline
30.000 slw
gs  clippath
1605 4857 m 1650 4677 l 1695 4857 l 1695 4605 l 1605 4605 l cp
clip
n 1650 5250 m 1650 4650 l gs col23 s gr gr

% arrowhead
7.500 slw
n 1605 4857 m 1650 4677 l 1695 4857 l 1650 4857 l 1605 4857 l  cp gs col23 1.00 shd ef gr  col23 s
% Polyline
30.000 slw
gs  clippath
2655 6057 m 2700 5877 l 2745 6057 l 2745 5805 l 2655 5805 l cp
clip
n 2700 6450 m 2700 5850 l gs col4 s gr gr

% arrowhead
7.500 slw
n 2655 6057 m 2700 5877 l 2745 6057 l 2700 6057 l 2655 6057 l  cp gs col4 1.00 shd ef gr  col4 s
% Polyline
30.000 slw
n 5700 6750 m 5550 6450 l 5550 3825 l 6150 3900 l gs col1 s gr 
% Polyline
n 6150 3900 m 5625 3975 l 5625 6450 l 5850 6750 l gs col4 s gr 
% Polyline
n 6000 6750 m 5700 6450 l 5700 4425 l 6150 4500 l gs col4 s gr 
% Polyline
gs  clippath
5655 6957 m 5700 6777 l 5745 6957 l 5745 6705 l 5655 6705 l cp
clip
n 4425 6750 m 4425 7275 l 5700 7275 l 5700 6750 l gs col1 s gr gr

% arrowhead
7.500 slw
n 5655 6957 m 5700 6777 l 5745 6957 l 5700 6957 l 5655 6957 l  cp gs col1 1.00 shd ef gr  col1 s
% Polyline
30.000 slw
gs  clippath
7830 7032 m 7875 6852 l 7920 7032 l 7920 6780 l 7830 6780 l cp
clip
n 6600 6750 m 6600 7500 l 7875 7500 l 7875 6825 l gs col14 s gr gr

% arrowhead
7.500 slw
n 7830 7032 m 7875 6852 l 7920 7032 l 7875 7032 l 7830 7032 l  cp gs col14 1.00 shd ef gr  col14 s
% Polyline
30.000 slw
gs  clippath
6405 6957 m 6450 6777 l 6495 6957 l 6495 6705 l 6405 6705 l cp
clip
n 1500 7050 m 1500 7875 l 6450 7875 l 6450 6750 l gs col23 s gr gr

% arrowhead
7.500 slw
n 6405 6957 m 6450 6777 l 6495 6957 l 6450 6957 l 6405 6957 l  cp gs col23 1.00 shd ef gr  col23 s
% Polyline
30.000 slw
gs  clippath
1605 7257 m 1650 7077 l 1695 7257 l 1695 7005 l 1605 7005 l cp
clip
n 6300 6750 m 6300 7800 l 1650 7800 l 1650 7050 l gs col23 s gr gr

% arrowhead
7.500 slw
n 1605 7257 m 1650 7077 l 1695 7257 l 1650 7257 l 1605 7257 l  cp gs col23 1.00 shd ef gr  col23 s
% Polyline
30.000 slw
n 6150 4500 m 5775 4575 l 5775 6450 l 6300 6750 l gs col23 s gr 
% Polyline
n 6150 5100 m 6675 5175 l 6675 6450 l 6450 6750 l gs col23 s gr 
% Polyline
n 1650 4650 m 1650 4500 l 1500 4500 l 1500 4650 l gs col23 s gr 
% Polyline
n 6600 6750 m 6750 6450 l 6750 5025 l 6150 5100 l gs col14 s gr 
% Polyline
gs  clippath
2595 6243 m 2550 6423 l 2505 6243 l 2505 6495 l 2595 6495 l cp
clip
n 2550 5850 m 2550 6450 l gs col4 s gr gr

% arrowhead
7.500 slw
n 2595 6243 m 2550 6423 l 2505 6243 l 2550 6243 l 2595 6243 l  cp gs col4 1.00 shd ef gr  col4 s
% Polyline
30.000 slw
gs  clippath
1545 6243 m 1500 6423 l 1455 6243 l 1455 6495 l 1545 6495 l cp
clip
n 1500 5850 m 1500 6450 l gs col23 s gr gr

% arrowhead
7.500 slw
n 1545 6243 m 1500 6423 l 1455 6243 l 1500 6243 l 1545 6243 l  cp gs col23 1.00 shd ef gr  col23 s
% Polyline
30.000 slw
gs  clippath
1605 6057 m 1650 5877 l 1695 6057 l 1695 5805 l 1605 5805 l cp
clip
n 1650 6450 m 1650 5850 l gs col23 s gr gr

% arrowhead
7.500 slw
n 1605 6057 m 1650 5877 l 1695 6057 l 1650 6057 l 1605 6057 l  cp gs col23 1.00 shd ef gr  col23 s
% Polyline
30.000 slw
gs  clippath
1545 5043 m 1500 5223 l 1455 5043 l 1455 5295 l 1545 5295 l cp
clip
n 1500 4650 m 1500 5250 l gs col23 s gr gr

% arrowhead
7.500 slw
n 1545 5043 m 1500 5223 l 1455 5043 l 1500 5043 l 1545 5043 l  cp gs col23 1.00 shd ef gr  col23 s
% Polyline
30.000 slw
gs  clippath
5955 6957 m 6000 6777 l 6045 6957 l 6045 6705 l 5955 6705 l cp
clip
n 2550 7050 m 2550 7500 l 6000 7500 l 6000 6750 l gs col4 s gr gr

% arrowhead
7.500 slw
n 5955 6957 m 6000 6777 l 6045 6957 l 6000 6957 l 5955 6957 l  cp gs col4 1.00 shd ef gr  col4 s
% Polyline
30.000 slw
gs  clippath
2655 7257 m 2700 7077 l 2745 7257 l 2745 7005 l 2655 7005 l cp
clip
n 5850 6750 m 5850 7425 l 2700 7425 l 2700 7050 l gs col4 s gr gr

% arrowhead
7.500 slw
n 2655 7257 m 2700 7077 l 2745 7257 l 2700 7257 l 2655 7257 l  cp gs col4 1.00 shd ef gr  col4 s
% Polyline
30.000 slw
n 2700 4650 m 2700 4500 l 2550 4500 l 2550 4650 l gs col4 s gr 
/Helvetica ff 300.00 scf sf
6975 4050 m
gs 1 -1 sc (kern buf1) col0 sh gr
/Helvetica ff 300.00 scf sf
6975 4650 m
gs 1 -1 sc (user buf) col0 sh gr
/Helvetica ff 300.00 scf sf
6975 5250 m
gs 1 -1 sc (kern buf2) col0 sh gr
% Polyline
gs  clippath
2655 4857 m 2700 4677 l 2745 4857 l 2745 4605 l 2655 4605 l cp
clip
n 2700 5250 m 2700 4650 l gs col4 s gr gr

% arrowhead
7.500 slw
n 2655 4857 m 2700 4677 l 2745 4857 l 2700 4857 l 2655 4857 l  cp gs col4 1.00 shd ef gr  col4 s
% Polyline
30.000 slw
gs  clippath
2595 5043 m 2550 5223 l 2505 5043 l 2505 5295 l 2595 5295 l cp
clip
n 2550 4650 m 2550 5250 l gs col4 s gr gr

% arrowhead
7.500 slw
n 2595 5043 m 2550 5223 l 2505 5043 l 2550 5043 l 2595 5043 l  cp gs col4 1.00 shd ef gr  col4 s
/Helvetica ff 300.00 scf sf
9000 8100 m
gs 1 -1 sc (bus) dup sw pop neg 0 rm  col0 sh gr
% Ellipse
n 6150 5100 300 225 0 360 DrawEllipse gs col0 s gr

% Ellipse
n 6150 4500 300 225 0 360 DrawEllipse gs col0 s gr

% Ellipse
n 6150 3900 300 225 0 360 DrawEllipse gs col0 s gr

% Polyline
n 2100 4650 m 2100 5250 l gs col0 s gr 
% Polyline
n 2100 5850 m 2100 6450 l gs col0 s gr 
% Polyline
n 2100 7050 m 2100 7650 l gs col0 s gr 
% Polyline
n 1200 7650 m 9000 7650 l gs col0 s gr 
% Polyline
n 4200 6750 m 4200 7650 l gs col0 s gr 
% Polyline
60.000 slw
n 3705 6150 m 3600 6150 3600 6645 105 arcto 4 {pop} repeat
  3600 6750 4695 6750 105 arcto 4 {pop} repeat
  4800 6750 4800 6255 105 arcto 4 {pop} repeat
  4800 6150 3705 6150 105 arcto 4 {pop} repeat
 cp gs col0 s gr 
% Polyline
7.500 slw
n 8100 6750 m 8100 7650 l gs col0 s gr 
% Polyline
60.000 slw
n 7605 6150 m 7500 6150 7500 6645 105 arcto 4 {pop} repeat
  7500 6750 8595 6750 105 arcto 4 {pop} repeat
  8700 6750 8700 6255 105 arcto 4 {pop} repeat
  8700 6150 7605 6150 105 arcto 4 {pop} repeat
 cp gs col0 s gr 
% Polyline
7.500 slw
n 6150 6750 m 6150 7650 l gs col0 s gr 
% Polyline
60.000 slw
n 1200 3450 m 3000 3450 l 3000 4650 l 1200 4650 l cp gs col0 s gr 
% Polyline
n 1200 5250 m 3000 5250 l 3000 5850 l 1200 5850 l cp gs col0 s gr 
% Polyline
n 1200 6450 m 3000 6450 l 3000 7050 l 1200 7050 l cp gs col0 s gr 
% Polyline
n 5475 3450 m 6825 3450 l 6825 6750 l 5475 6750 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
4200 6600 m
gs 1 -1 sc (disk) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8100 6600 m
gs 1 -1 sc (net) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 4200 m
gs 1 -1 sc (CPU) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 5700 m
gs 1 -1 sc (MMU) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 6900 m
gs 1 -1 sc (cache) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6150 3300 m
gs 1 -1 sc (memory) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6150 3000 m
gs 1 -1 sc (main) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1110 2220 a(Figure)25 b(1.1:)30 b(T)m(ransmitting)22
b(disk)i(data)h(o)o(v)o(er)f(a)h(netw)o(ork)300 2615
y(the)31 b(second)g(k)o(ernel)g(b)n(uf)n(fer)f(and)h(then)g(transmit)f
(it.)48 b(This)30 b(operation)h(requires)g(tw)o(o)f(processor)h(data)
300 2764 y(copies;)44 b(ho)n(we)n(v)o(er)36 b(if)i(the)g(operating)g
(system)e(used)i(only)f(one)h(b)n(uf)n(fer)g(instead)f(of)h(three,)k
(then)37 b(no)300 2913 y(processor)25 b(data)g(copies)f(w)o(ould)g(be)h
(required)g(to)f(read)i(and)e(transmit)g(the)g(data.)583
3063 y(A)31 b(v)n(ariety)e(of)h(ef)n(forts)g(ha)n(v)o(e)g(sought)e(to)i
(impro)o(v)o(e)e(system)h(performance)i(by)f(increasing)f(the)300
3212 y(ef)n(\002cienc)o(y)e(of)f(data)h(\003o)n(w)f(through)g(the)g
(operating)g(system.)35 b(Most)26 b(of)h(these)f(ef)n(forts)g(ha)n(v)o
(e)h(been)g(cen-)300 3362 y(tered)21 b(on)f(adapting)f(the)h(I/O)h(and)
f(netw)o(orking)f(subsystems)g(of)h(the)g(operating)g(system)f(to)h
(reduce)h(data)300 3511 y(cop)o(ying)f(and)i(protocol)e(o)o(v)o(erhead)
g([4,)i(24)o(,)g(27)o(,)f(53].)30 b(These)21 b(approaches)g(tend)g(to)g
(in)l(v)n(olv)o(e)f(super\002cial)300 3660 y(modi\002cations)g(of)i
(the)f(virtual)g(memory)f(subsystem)g(that)h(do)g(not)g(in)l(v)n(olv)o
(e)f(changing)h(the)g(underlying)300 3810 y(design)g(of)g(the)g
(system.)29 b(This)20 b(is)h(understandable)g(because)h(the)f(virtual)g
(memory)f(subsystem)g(is)h(typi-)300 3959 y(cally)j(much)f(lar)n(ger)i
(and)f(more)g(comple)o(x)f(than)g(the)h(netw)o(orking)f(subsystem.)29
b(Ho)n(we)n(v)o(er)l(,)23 b(substantial)300 4109 y(gains)j(can)i(be)f
(made)g(by)g(changing)f(the)h(design)g(of)g(the)g(virtual)f(memory)h
(subsystem)e(to)i(e)o(xploit)e(the)300 4258 y(ability)f(of)g(the)h
(hardw)o(are)h(to)e(map)g(a)i(physical)d(address)i(to)f(one)h(or)g
(more)f(virtual)h(addresses.)583 4407 y(This)41 b(research)h(seeks)f
(to)g(modify)f(a)h(traditional)f(Unix-lik)o(e)g(operating)g(system')-5
b(s)40 b(virtual)300 4557 y(memory)c(subsystem)f(to)h(allo)n(w)g
(applications)f(to)i(better)g(tak)o(e)f(adv)n(antage)h(of)g(the)f
(features)h(of)g(the)300 4706 y(memory)26 b(management)g(hardw)o(are)h
(of)g(the)g(computer)-5 b(.)36 b(Our)26 b(no)o(v)o(el)g(approach)h
(focuses)f(on)h(allo)n(wing)300 4856 y(processes)i(to)f(pass)g(memory)g
(to)g(and)h(from)g(other)f(processes)h(and)f(the)h(k)o(ernel,)h(and)e
(to)h(share)g(mem-)300 5005 y(ory)-6 b(.)30 b(The)23
b(memory)f(passed)h(or)h(shared)f(may)g(be)h(a)f(block)g(of)h(pages,)f
(or)h(it)e(may)h(be)h(a)g(chunk)e(of)i(virtual)300 5154
y(memory)e(space)g(that)g(may)h(not)f(be)g(entirely)g(mapped.)30
b(The)22 b(memory)g(may)g(or)g(may)g(not)g(be)h(pageable.)300
5304 y(This)34 b(approach)h(reduces)h(or)f(eliminates)e(the)i(need)g
(to)g(cop)o(y)g(data)g(thus)f(reducing)h(the)f(time)h(spent)p
eop
%%Page: 3 23
3 22 bop 3850 100 a Fs(3)300 249 y(within)27 b(the)h(k)o(ernel)g(and)g
(freeing)h(up)f(c)o(ycles)g(for)g(application)f(processing.)40
b(Unlik)o(e)28 b(the)g(approaches)300 398 y(that)f(focus)h(e)o(xclusi)n
(v)o(ely)d(on)i(the)g(netw)o(orking)g(and)g(inter)n(-process)h
(communications)d(\(IPC\))k(subsys-)300 548 y(tems,)24
b(our)g(approach)h(pro)o(vides)e(a)i(general)f(frame)n(w)o(ork)h(for)f
(solutions)f(that)h(can)h(impro)o(v)o(e)d(ef)n(\002cienc)o(y)300
697 y(of)j(the)g(entire)f(I/O)h(subsystem.)583 847 y(Modifying)f(the)h
(k)o(ernel')-5 b(s)24 b(virtual)h(memory)f(system)g(is)h(more)g(of)g(a)
g(challenge)g(than)g(w)o(orking)300 996 y(with)30 b(other)g(parts)g(of)
g(the)g(k)o(ernel)g(\(e.g.)48 b(writing)29 b(a)i(de)n(vice)e(dri)n(v)o
(er\))h(for)g(se)n(v)o(eral)g(reasons.)47 b(First,)31
b(the)300 1145 y(virtual)g(memory)g(system')-5 b(s)30
b(data)h(structures)g(are)i(shared)e(between)h(the)g(k)o(ernel)f(and)h
(the)f(processes)300 1295 y(running)21 b(on)g(the)h(system)f(and)h
(thus)f(must)g(be)h(properly)f(protected)h(for)g(concurrent)g(access)g
(with)f(lock-)300 1444 y(ing.)44 b(Second,)31 b(the)e(VM)h(system)e
(must)g(be)i(able)f(to)h(handle)f(both)g(synchronous)f(and)h
(asynchronous)300 1594 y(I/O)d(operations.)33 b(Managing)25
b(asynchronous)g(operations)g(is)g(more)h(dif)n(\002cult)f(than)h
(synchronous)e(op-)300 1743 y(erations.)55 b(Third,)35
b(errors)f(in)e(the)i(VM)e(system)g(can)i(be)f(harder)h(to)f(diagnose)f
(than)h(in)g(other)g(k)o(ernel)300 1892 y(subsystems)h(because)h(the)h
(k)o(ernel)f(itself)g(depends)g(on)h(the)f(VM)g(system)g(to)g(manage)g
(its)g(memory)300 2042 y(\(thus)26 b(if)h(an)g(error)g(occurs)g(it)f
(may)g(not)g(be)h(possible)f(to)g(get)h(the)f(k)o(ernel)h(into)f(a)h
(deb)n(ugable)f(state\))g(and)300 2191 y(also)h(because)i(the)f(VM)f
(system)g(is)g(typically)g(in)g(the)h(process)g(of)g(handling)f(man)o
(y)f(service)j(requests)300 2341 y(at)22 b(once.)30 b(F)o(ourth,)22
b(the)g(BSD)h(VM)f(system)f(is)h(poorly)g(documented)f(when)h(compared)
g(to)g(other)g(k)o(ernel)300 2490 y(subsystems)27 b(\(for)j(e)o
(xample,)f(the)g(netw)o(orking)f(stack)h(has)g(se)n(v)o(eral)f(books)g
(describing)g(its)h(operation)300 2639 y(while)d(the)h(BSD)h(VM)f
(system)f(is)g(only)h(documented)f(in)g(a)i(fe)n(w)f(book)f(chapters)h
(and)g(Mach)g(papers\).)300 2789 y(In)21 b(short,)g(the)g(virtual)f
(memory)g(system)g(is)g(both)g(lar)n(ge)i(and)f(complicated)f(and)h
(has)f(vital)h(components)300 2938 y(that)j(all)h(other)g(parts)f(of)h
(the)g(k)o(ernel)g(depend)f(on)h(to)f(function)g(properly)-6
b(.)583 3088 y(W)e(e)33 b(selected)e(NetBSD)i([54])f(as)g(the)f
(platform)g(for)h(this)f(w)o(ork.)51 b(NetBSD)33 b(is)e(a)h(descendant)
300 3237 y(of)f(the)g(well)g(kno)n(wn)e(4.4BSD-lite)i(operating)g
(system)f(from)g(Uni)n(v)o(ersity)f(of)i(California,)i(Berk)o(ele)o(y)
300 3386 y([39].)e(NetBSD)26 b(is)e(a)i(multi-platform)c(operating)j
(system)e(that)i(runs)f(on)h(systems)f(such)g(as)h(i386)f(PCs,)300
3536 y(DEC)30 b(Alphas,)g(and)f(Sun)h(Sparc)g(systems.)44
b(It)29 b(is)g(currently)g(being)g(used)g(by)h(numerous)e(institutions)
300 3685 y(and)34 b(indi)n(viduals)e(for)i(adv)n(anced)g(research)i(as)
e(well)g(as)g(recreational)h(computing.)57 b(NetBSD)35
b(is)f(an)300 3835 y(ideal)24 b(platform)g(for)h(uni)n(v)o(ersity)d
(research)j(because)g(the)f(source)h(code)g(is)f(freely)h(a)n(v)n
(ailable)e(on)i(the)f(In-)300 3984 y(ternet)e(and)h(well)f(documented)f
(in)h(books)g(and)g(papers,)h(and)f(the)g(TCP/IP)i(stack)e(is)g(the)g
(standard)g(BSD)300 4133 y(TCP/IP)h(that)e(is)h(used)g(throughout)e
(the)i(w)o(orld.)29 b(NetBSD)23 b(is)e(also)h(closely)f(related)h(to)g
(other)f(free)i(BSD)300 4283 y(operating)g(systems)g(such)h(as)g
(FreeBSD)i([25])e(and)g(OpenBSD)h([55],)f(thus)f(allo)n(wing)g
(applications)f(to)300 4432 y(easily)30 b(migrate)g(between)g(these)g
(systems.)46 b(When)30 b(we)h(be)o(gan)e(w)o(ork)i(on)f(this)f(project)
h(the)g(NetBSD)300 4581 y(virtual)24 b(memory)g(subsystem)f(w)o(as)i
(lar)n(gely)g(unchanged)f(from)h(its)f(roots)g(in)g(4.4BSD.)583
4731 y(The)31 b(primary)f(purpose)h(of)f(a)h(virtual)f(memory)g(system)
g(is)g(to)g(manage)h(the)f(virtual)g(address)300 4880
y(space)d(of)f(both)f(the)i(k)o(ernel)f(and)g(user)g(processes)g([18,)h
(19)o(].)35 b(A)27 b(virtual)e(address)h(space)h(is)f(de\002ned)g(by)
300 5030 y(a)e(map)g(structure.)30 b(There)24 b(is)g(a)g(map)g(for)g
(each)h(process)e(\(and)i(the)e(k)o(ernel\))i(on)e(the)h(system,)f
(consisting)300 5179 y(of)34 b(entries)f(that)h(describe)f(the)h
(locations)f(of)g(memory)g(objects)g(mapped)h(into)f(the)g(virtual)g
(address)300 5328 y(space.)j(In)26 b(addition,)f(the)h(virtual)g
(memory)f(system)h(manages)f(the)i(mappings)d(of)j(indi)n(vidual)d
(virtual)p eop
%%Page: 4 24
4 23 bop 3850 100 a Fs(4)300 249 y(memory)31 b(pages)h(to)g(the)g
(corresponding)f(physical)f(page)j(that)e(belongs)g(to)h(each)g(mapped)
g(memory)300 398 y(object.)e(The)25 b(virtual)f(memory)f(system)h(is)g
(responsible)f(for)i(managing)f(these)g(mappings)f(so)h(that)g(the)300
548 y(data)h(inte)o(grity)e(of)i(the)f(operating)h(system)e(is)i
(maintained.)583 697 y(In)e(this)f(dissertation)f(we)i(introduce)f(UVM)
2131 661 y Fj(1)2168 697 y Fs(,)h(a)g(ne)n(w)f(virtual)g(memory)g
(system)f(based)i(on)f(the)300 847 y(4.4BSD)j(VM)f(system.)29
b(UVM)24 b(allo)n(ws)f(processes)i(to)f(e)o(xchange)g(and)g(share)h
(memory)e(through)h(three)300 996 y(inno)o(v)n(ati)n(v)o(e)e(ne)n(w)i
(mechanisms:)29 b(page)c(loanout,)f(page)h(transfer)l(,)g(and)g(map)f
(entry)h(passing.)445 1228 y Fr(\017)49 b Fs(In)36 b(page)h(loanout,)h
(a)f(process)f(can)h(loan)f(its)g(memory)g(to)g(other)g(processes)g(or)
h(to)f(non-VM)544 1378 y(k)o(ernel)c(subsystems.)51 b(This)31
b(is)h(achie)n(v)o(ed)f(with)h(a)g(reference)i(counter)e(and)g(special)
g(handling)544 1527 y(of)j(k)o(ernel)f(memory)g(mappings.)58
b(Special)35 b(care)h(is)e(tak)o(en)h(to)f(handle)g(e)n(v)o(ents)f
(such)i(as)f(write)544 1677 y(f)o(aults)28 b(and)g(pageouts)f(that)h
(could)f(break)i(the)f(loan.)40 b(Applications)27 b(that)h(transfer)g
(data)g(o)o(v)o(er)g(a)544 1826 y(netw)o(ork)23 b(can)h(tak)o(e)g(adv)n
(antage)f(of)h(this)f(feature)i(to)e(loan)g(data)h(pages)g(from)f(the)h
(user')-5 b(s)23 b(address)544 1975 y(space)37 b(to)f(the)g(k)o(ernel')
-5 b(s)37 b(netw)o(orking)e(subsystem.)64 b(In)37 b(our)g(tests,)h
(single-page)e(loanouts)f(to)544 2125 y(the)g(netw)o(orking)g
(subsystem)e(took)i(26\045)g(less)g(time)g(than)g(cop)o(ying)f(data.)63
b(T)-7 b(ests)35 b(in)l(v)n(olving)544 2274 y(multi-page)28
b(loanouts)g(sho)n(w)g(that)g(page)i(loaning)e(can)h(reduce)h(the)f
(processing)g(time)f(further)l(,)544 2424 y(for)d(e)o(xample)f(a)h(256)
f(page)h(loanout)f(took)g(78\045)h(less)f(time)g(than)h(cop)o(ying)e
(data.)445 2656 y Fr(\017)49 b Fs(In)26 b(page)h(transfer)l(,)f(a)h
(process)f(can)g(recei)n(v)o(e)g(pages)g(of)h(memory)e(from)h(other)g
(processes)g(or)g(the)544 2805 y(k)o(ernel.)54 b(Once)32
b(a)h(page)g(has)f(been)h(transfered)g(into)e(a)i(process')g(address)f
(space)h(it)f(is)g(treated)544 2955 y(lik)o(e)23 b(an)o(y)g(other)g
(page)g(of)h(a)g(process')f(memory)-6 b(.)29 b(P)o(age)24
b(transfer)f(is)g(achie)n(v)o(ed)g(without)f(the)h(need)544
3104 y(for)30 b(comple)o(x)f(memory)g(object)h(operations)f(that)g
(occur)i(in)e(BSD)i(VM.)e(Our)h(tests)g(sho)n(w)f(that)544
3254 y(single)22 b(page)i(transfers)f(do)h(not)e(sho)n(w)h(an)g(impro)o
(v)o(ement)e(o)o(v)o(er)i(data)g(cop)o(ying,)g(b)n(ut)g(a)g(tw)o
(o-page)544 3403 y(transfer)f(sho)n(ws)f(a)h(22\045)g(reduction)g(in)f
(processing)h(time.)29 b(The)22 b(processing)f(time)g(decreases)i(as)
544 3552 y(lar)n(ger)g(chunks)f(of)h(pages)g(are)h(transfered,)f(for)g
(e)o(xample)f(a)h(eight-page)g(page)g(transfer)g(reduces)544
3702 y(processing)h(time)g(by)g(57\045.)445 3934 y Fr(\017)49
b Fs(In)21 b(map)f(entry)g(passing,)h(a)g(process)f(e)o(xports)g(a)h
(range)g(of)f(its)g(address)h(space)g(to)f(other)g(processes)544
4084 y(or)26 b(the)f(k)o(ernel)h(by)f(allo)n(wing)f(a)i(chunk)f(of)h
(its)e(map)i(entry)f(structures)g(to)g(be)h(copied.)33
b(This)24 b(map)544 4233 y(entry)g(cop)o(ying)f(can)h(be)g(done)g(in)f
(such)h(a)g(w)o(ay)g(that)g(the)f(e)o(xporting)g(process)h(can)g
(retain,)g(share,)544 4382 y(or)37 b(surrender)h(control)f(of)h(the)f
(mappings.)67 b(Map)37 b(entry)h(passing)e(can)i(be)g(used)f(to)g
(quickly)544 4532 y(transfer)f(memory)g(between)g(processes)g(in)g(w)o
(ays)g(that)g(were)g(not)g(possible)f(with)g(the)h(BSD)544
4681 y(VM)i(system.)71 b(Single-page)39 b(map)f(entry)h(passing)f
(tests)f(do)i(not)f(sho)n(w)g(an)o(y)g(impro)o(v)o(ement)544
4831 y(o)o(v)o(er)29 b(data)h(cop)o(ying,)g(ho)n(we)n(v)o(er)f(tw)o
(o-page)h(map)g(entry)f(passing)g(sho)n(ws)g(a)h(30\045)g(reduction)f
(in)544 4980 y(processing)j(time.)55 b(Processing)33
b(time)g(decreases)h(further)f(when)g(lar)n(ger)h(blocks)f(of)g(data)g
(are)p 300 5070 1440 4 v 416 5131 a Fi(1)449 5161 y Fh(F)o(ollo)n(wing)
24 b(Larry)g(W)-7 b(all)27 b([70)n(])f(we)f(pro)o(vide)e(no)i
(de\002niti)n(v)o(e)f(e)o(xplanation)f(for)h(what)h(UVM)h(stands)f(for)
-5 b(.)39 b(Expanding)300 5261 y(this)21 b(acron)o(ym)d(is)j(left)f(as)
h(an)f(e)o(x)o(ercise)g(for)f(the)h(reader)-5 b(.)p eop
%%Page: 5 25
5 24 bop 3850 100 a Fs(5)544 249 y(passed,)27 b(for)g(e)o(xample)e(an)i
(eight-page)g(transfer)g(of)f(memory)g(decreases)i(processing)d(time)h
(by)544 398 y(69\045.)583 631 y(UVM)e(also)h(includes)e
(well-documented)g(changes)i(to)f(the)g(BSD)i(VM)e(system)f(that)h
(impro)o(v)o(e)300 780 y(the)39 b(accessibility)e(of)i(the)f(code)h
(and)g(the)f(o)o(v)o(erall)g(performance)h(and)g(stability)d(of)j(the)g
(operating)300 930 y(system:)445 1162 y Fr(\017)49 b
Fs(The)28 b(old)g(anon)o(ymous)e(memory)h(handling)g(system)h(that)f
(used)h(\223shado)n(w\224)g(and)g(\223cop)o(y)h(object)544
1311 y(chains\224)d(is)f(completely)g(replaced)h(by)g(a)g(simpler)f(tw)
o(o-layer)h(system.)32 b(Anon)o(ymous)24 b(memory)544
1461 y(is)g(memory)g(that)h(is)f(freed)h(as)g(soon)f(as)h(it)g(is)f(no)
g(longer)h(referenced.)445 1693 y Fr(\017)49 b Fs(The)19
b(ne)n(w)g(anon)o(ymous)e(memory)i(pageout)f(clustering)h(code)g(can)h
(impro)o(v)o(e)d(anon)o(ymous)h(mem-)544 1843 y(ory)25
b(pageout)f(by)g(a)i(f)o(actor)f(of)g(six.)445 2075 y
Fr(\017)49 b Fs(The)29 b(ne)n(w)g(pager)h(interf)o(ace)g(gi)n(v)o(es)e
(the)h(pager)h(more)g(control)e(o)o(v)o(er)h(its)g(pages)g(and)g
(eliminates)544 2224 y(the)c(need)g(for)g(a)o(wkw)o(ard)f
(\223\002ctitious\224)g(de)n(vice)h(pages.)445 2457 y
Fr(\017)49 b Fs(The)21 b(ne)n(w)f(memory)g(object)g(handling)f(code)i
(eliminates)e(the)i(need)g(for)f(the)h(redundant)f(\223object-)544
2606 y(cache\224)25 b(and)f(allo)n(ws)f(vnode-based)h(objects)f(to)h
(persist)f(as)i(long)e(as)h(their)g(backing)g(vnodes)f(are)544
2756 y(v)n(alid.)445 2988 y Fr(\017)49 b Fs(K)n(ernel)24
b(map)f(fragmentation)g(has)h(been)h(reduced)f(by)g(re)n(vising)f(the)h
(handling)e(of)j(wired)f(mem-)544 3137 y(ory)-6 b(.)445
3370 y Fr(\017)49 b Fs(The)26 b(code)h(to)f(handle)h(contiguous)e(and)h
(non-contiguous)f(memory)g(has)i(been)f(mer)n(ged)h(into)f(a)544
3519 y(single)e(interf)o(ace)h(thus)f(reducing)h(the)f(comple)o(xity)f
(of)i(the)g(source)g(code.)445 3752 y Fr(\017)49 b Fs(Redundant)21
b(virtual)f(memory)h(calls)f(ha)n(v)o(e)h(been)h(eliminated)e(in)g(the)
h(fork-e)o(x)o(ec-e)o(xit)f(path,)i(thus)544 3901 y(reducing)29
b(the)g(processing)f(time)g(of)h(a)h(fork)f(operation.)43
b(F)o(or)29 b(e)o(xample,)g(the)g(processing)f(time)544
4051 y(of)d(a)g(fork)g(operation)f(on)h(a)g(small)e(process)i(has)g
(been)g(reduced)g(by)g(13\045)f(under)h(UVM.)445 4283
y Fr(\017)49 b Fs(A)38 b(ne)n(w)f(system)g(call)g(allo)n(ws)g(unpri)n
(vile)o(ged)e(process)j(to)f(get)h(the)f(virtual)g(memory)g(system)544
4432 y(status.)42 b(UVM)28 b(is)g(distrib)n(uted)g(with)g(an)h(X)f
(windo)n(w)g(program)g(that)h(uses)f(this)g(system)g(call)g(to)544
4582 y(display)c(virtual)g(memory)g(system)f(status)h(graphically)-6
b(.)445 4814 y Fr(\017)49 b Fs(The)31 b(ne)n(w)h(i386)e(pmap)h
(eliminates)g(\223ptdi\224)g(panics)g(and)g(deadlock)h(conditions)d
(that)j(plagued)544 4964 y(the)25 b(old)f(pmap)g(in)g(some)h(cases.)583
5196 y(UVM)i(has)f(been)h(designed)f(to)g(completely)g(replace)h(the)f
(BSD)i(VM)e(system)g(in)g(NetBSD.)h(It)300 5345 y(w)o(as)g
(incorporated)g(into)g(the)g(master)g(NetBSD)h(source)f(tree)h(in)f
(February)h(of)f(1998)g(and)g(has)g(pro)o(v)o(en)p eop
%%Page: 6 26
6 25 bop 3850 100 a Fs(6)300 249 y(stable)36 b(in)g(NetBSD')-5
b(s)37 b(Alpha,)i(ARM32,)h(Atari,)f(HP300,)g(I386,)g(MA)l(C68k,)g
(MVME68k,)f(Ne)n(ws-)300 398 y(Mips,)24 b(PC532,)h(PMAX,)f(Sparc,)i
(and)f(V)-13 b(AX)24 b(ports.)30 b(It)25 b(will)f(appear)h(in)g(NetBSD)
g(release)h(1.4.)583 548 y(The)i(rest)f(of)h(this)e(dissertation)g(is)h
(or)n(ganized)g(as)h(follo)n(ws:)34 b(In)28 b(Chapter)f(2)h(we)f
(present)h(back-)300 697 y(ground)22 b(on)g(the)g(VM)g(subsystem.)29
b(In)22 b(Chapter)h(3)g(we)f(detail)g(the)h(o)o(v)o(erall)e(UVM)h
(design)g(and)g(describe)300 847 y(related)29 b(w)o(ork.)41
b(W)-8 b(e)28 b(describe)h(anon)o(ymous)d(memory)i(handling,)f(our)i
(ne)n(w)f(page)g(f)o(ault)g(handler)l(,)h(our)300 996
y(ne)n(w)d(pager)i(interf)o(ace,)g(and)e(the)h(page/map)f(loanout)g
(interf)o(ace)i(in)e(Chapters)h(4,)g(5,)h(6,)f(and)g(7)f(respec-)300
1145 y(ti)n(v)o(ely)-6 b(.)28 b(W)-8 b(e)23 b(describe)g(secondary)g
(design)f(elements)g(in)h(Chapter)g(8.)30 b(In)23 b(Chapter)h(9)f(we)g
(introduce)f(our)300 1295 y(implementation)f(methods.)29
b(Finally)24 b(we)g(present)f(our)h(results)f(in)g(Chapter)i(10)e(and)h
(our)g(conclusions)300 1444 y(and)31 b(suggestions)e(for)i(future)g(w)o
(ork)g(in)g(Chapter)g(11.)49 b(De\002nitions)30 b(of)h(k)o(e)o(y)g
(terms)f(can)i(be)f(found)f(in)300 1594 y(the)25 b(glossary)-6
b(.)p eop
%%Page: 7 27
7 26 bop 3850 100 a Fs(7)300 973 y Fp(Chapter)51 b(2)300
1448 y(Backgr)l(ound)300 1930 y Fs(This)23 b(chapter)i(describes)f(the)
g(traditional)f(role)h(of)h(the)f(virtual)f(memory)g(subsystem.)29
b(It)24 b(e)o(xplains)f(the)300 2079 y(history)31 b(and)g(e)n(v)n
(olution)f(of)i(the)g(BSD)g(VM)f(and)h(presents)f(an)h(o)o(v)o(ervie)n
(w)e(of)i(the)g(current)g(BSD)h(VM)300 2229 y(system)24
b(as)h(background)f(for)h(understanding)e(the)i(UVM)f(system.)300
2608 y Fg(2.1)143 b(The)35 b(Role)g(of)g(the)g(VM)h(System)300
2860 y Fs(The)30 b(operating)f(system)g(k)o(ernel)h(manages)g(hardw)o
(are)h(resources)f(\227)g(including)e(memory)-6 b(,)30
b(de)n(vices,)300 3010 y(and)24 b(peripherals)f(\227)h(and)f(schedules)
g(when)h(processes)g(will)e(run.)31 b(The)23 b(k)o(ernel)h(has)g(a)g(v)
n(ariety)f(of)g(sub-)300 3159 y(systems)d(including)g(I/O,)h(netw)o
(orking,)g(\002le)h(systems,)f(process)g(management,)g(and)h(virtual)f
(memory)-6 b(.)300 3308 y(The)24 b(job)g(of)g(a)h(k)o(ernel')-5
b(s)23 b(virtual)h(memory)f(sub-system)g(is)g(to)h(manage)g(access)h
(to)f(the)g(physical)f(mem-)300 3458 y(ory)i(chips)f(where)h(data)g(is)
f(stored)h(while)f(in)h(use.)583 3607 y(When)k(a)f(process)g(is)g(run,)
h(the)f(VM)g(subsystem)e(\002rst)j(sets)e(up)h(the)g(process')h
(virtual)e(address)300 3757 y(space.)j(As)20 b(the)g(process)h(e)o(x)o
(ecutes,)f(each)h(instruction)e(must)g(be)i(fetched)g(from)f(virtual)g
(memory)-6 b(.)28 b(This)300 3906 y(requires)j(the)g(memory)f
(management)h(unit)f(\(MMU\))h(\227)g(a)g(hardw)o(are)h(component)e
(\227)h(to)f(translate)300 4055 y(a)f(virtual)f(address)g(into)f(a)i
(physical)e(memory)h(location)g(where)h(the)f(instruction)f(is)h
(actually)g(stored.)300 4205 y(Sometimes)d(the)h(MMU)f(is)h(unable)g
(to)f(complete)h(the)g(translation)e(because)j(the)f(virtual)f(address)
h(has)300 4354 y(not)d(been)h(mapped.)30 b(In)24 b(this)f(case)i(the)e
(MMU)g(signals)g(a)h(f)o(ault)g(and)g(the)g(virtual)f(memory)g
(sub-system)300 4504 y(is)e(called)h(again.)30 b(The)21
b(VM)h(either)g(establishes)f(a)h(mapping)e(or)i(signals)f(a)i(\223se)o
(gmentation)d(violation.)-7 b(\224)300 4653 y(The)25
b(VM)f(sub-system)f(is)i(also)f(called)h(as)g(part)g(of)g(some)f
(systems)f(calls.)583 4802 y(The)32 b(virtual)f(memory)f(subsystem)g
(allo)n(ws)g(processes)i(to)f(use)g(more)h(memory)e(than)h(physi-)300
4952 y(cally)21 b(a)n(v)n(ailable)f(by)g(using)g(a)h(computer')-5
b(s)20 b(disk)g(to)g(store)h(data)g(that)f(does)g(not)h(\002t)g(in)f
(memory)-6 b(.)28 b(Because)300 5101 y(accessing)i(data)f(on)h(disk)f
(is)g(slo)n(wer)g(than)h(accessing)f(data)h(in)f(physical)g(memory)-6
b(,)29 b(the)h(VM)f(system)300 5251 y(selects)h(data)f(that)h(has)g
(not)f(been)h(recently)g(accessed)g(for)g(disk)f(storage.)46
b(The)30 b(disk)f(space)h(used)g(for)300 5400 y(storing)f(memory)f
(data)i(is)f(kno)n(wn)g(as)h(\223backing)f(store.)-7
b(\224)45 b(Entire)30 b(programs)f(can)h(reside)f(in)h(backing)p
eop
%%Page: 8 28
8 27 bop 3850 100 a Fs(8)300 249 y(store;)32 b(the)e(VM)f(system)g
(will)g(load)g(needed)h(parts)g(of)g(the)f(program)h(into)f(physical)f
(memory)h(as)h(the)300 398 y(program)24 b(e)o(x)o(ecutes.)583
548 y(Another)i(function)f(of)g(the)h(VM)f(system)g(is)g(to)g(allo)n(w)
g(each)h(process)f(to)h(ha)n(v)o(e)f(its)g(o)n(wn)g(virtual)300
697 y(address)c(space.)30 b(As)22 b(a)g(result,)f(programs)g(can)h(be)g
(loaded)f(at)g(a)h(\002x)o(ed)g(virtual)e(address)i(without)e(ha)n
(ving)300 847 y(to)h(check)h(whether)f(that)g(address)g(is)g(in)g(use)g
(by)g(another)g(process.)29 b(Also,)22 b(since)f(each)h(process')f
(virtual)300 996 y(address)33 b(space)h(is)f(pri)n(v)n(ate,)i(the)e(VM)
g(system)g(allo)n(ws)f(processes)h(to)g(access)h(their)g(entire)f
(range)h(of)300 1145 y(allocated)25 b(memory)f(without)f(re)o(gard)h
(for)h(other)g(processes)g(memory)f(usage.)583 1295 y(Since)k(all)e
(processes)g(requires)h(the)f(use)h(of)f(physical)g(memory)-6
b(,)25 b(managing)h(memory)g(access)300 1444 y(is)e(a)h(comple)o(x)f
(task.)30 b(K)n(e)o(y)24 b(operations)g(that)g(the)h(virtual)f(memory)g
(system)g(performs)g(include:)445 1677 y Fr(\017)49 b
Fs(Allocation)22 b(of)h(a)g(computer')-5 b(s)22 b(physical)f(memory)-6
b(.)29 b(This)22 b(is)h(done)f(by)h(k)o(eeping)f(track)h(of)h(which)544
1826 y(pages)e(of)h(physical)e(memory)h(are)h(allocated)f(and)h(which)f
(are)h(free,)h(and)e(allocating)g(free)h(pages)544 1975
y(as)i(the)o(y)f(are)h(needed)g(by)g(the)g(k)o(ernel)f(and)h(other)g
(programs.)445 2208 y Fr(\017)49 b Fs(Allocation)20 b(of)i(each)g
(process')g(virtual)e(address)i(space.)30 b(This)21 b(is)g(done)g(by)g
(k)o(eeping)g(a)h(list)f(of)g(all)544 2357 y(allocated)26
b(re)o(gions)f(in)h(each)h(virtual)e(address)h(space)h(and)f
(allocating)f(free)i(re)o(gions)f(as)g(needed)544 2507
y(by)e(the)h(process.)445 2739 y Fr(\017)49 b Fs(Mapping)33
b(physical)f(pages)i(into)f(virtual)g(address)h(space.)59
b(This)33 b(is)g(done)h(by)g(programming)544 2888 y(the)25
b(computer')-5 b(s)24 b(MMU)g(to)h(map)g(physical)f(pages)h(into)g(one)
g(or)g(more)g(virtual)g(address)g(spaces)544 3038 y(with)f(the)h
(appropriate)f(protection.)445 3270 y Fr(\017)49 b Fs(Handling)29
b(in)l(v)n(alid)f(memory)h(accesses)i(\(i.e.)47 b(page)30
b(f)o(aults\).)46 b(This)29 b(is)h(done)g(through)f(the)h(VM)544
3420 y(system')-5 b(s)37 b(page)h(f)o(ault)g(handler)-5
b(.)71 b(P)o(age)39 b(f)o(aults)f(can)h(happen)f(when)g(unmapped)g
(memory)g(is)544 3569 y(referenced,)44 b(or)c(when)f(memory)f(is)h
(referenced)i(in)e(a)g(w)o(ay)h(that)e(is)h(inconsistent)f(with)g(the)
544 3718 y(current)25 b(protection)f(on)g(the)h(page.)445
3951 y Fr(\017)49 b Fs(Mo)o(ving)27 b(data)j(between)f(physical)f
(memory)g(and)h(backing)g(store.)44 b(This)28 b(is)h(done)g(by)g
(making)544 4100 y(requests)24 b(to)h(the)f(I/O)h(system)f(to)g(read)h
(and)g(write)g(data)g(into)f(physical)f(pages)i(of)g(memory)-6
b(.)445 4333 y Fr(\017)49 b Fs(Managing)36 b(memory)g(shortages)h(on)f
(the)h(system.)66 b(This)36 b(is)h(done)g(by)g(freeing)g(unused)f(and)
544 4482 y(inacti)n(v)o(e)23 b(pages)i(of)g(physical)e(memory)h(\(sa)n
(ving)g(to)h(backing)f(store)h(if)g(necessary\).)445
4714 y Fr(\017)49 b Fs(Duplicating)24 b(the)i(address)g(space)h(of)f(a)
g(process)g(during)g(a)g(fork.)35 b(This)25 b(can)h(include)g(changing)
544 4864 y(protection)21 b(of)h(a)g(virtual)g(memory)f(re)o(gion)g(to)h
(allo)n(w)f(for)h(\223cop)o(y-on-write.)-7 b(\224)30
b(In)22 b(cop)o(y-on-write)544 5013 y(the)39 b(VM)f(subsystem)f
(write-protects)i(the)g(pages)g(so)f(that)h(the)o(y)f(will)g(be)h
(duplicated)f(when)544 5163 y(modi\002ed)24 b([9].)p
eop
%%Page: 9 29
9 28 bop 3850 100 a Fs(9)587 2459 y @beginspecial 0 @llx
0 @lly 605 @urx 462 @ury 3630 @rwi @setspecial
%%BeginDocument: ../figures/vmrole.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-35.0 523.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 8752 m 0 0 l 10702 0 l 10702 8752 l cp clip
 0.06000 0.06000 sc
% Polyline
7.500 slw
n 7755 2100 m 7650 2100 7650 8595 105 arcto 4 {pop} repeat
  7650 8700 10545 8700 105 arcto 4 {pop} repeat
  10650 8700 10650 2205 105 arcto 4 {pop} repeat
  10650 2100 7755 2100 105 arcto 4 {pop} repeat
 cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
6037 5317 m
gs 1 -1 sc (VM SYSTEM) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 900 6000 m 4125 6000 l gs col0 s gr 
% Polyline
30.000 slw
n 900 5550 m 4125 5550 l 4125 7050 l 900 7050 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
975 5850 m
gs 1 -1 sc (process management) col0 sh gr
/Helvetica ff 300.00 scf sf
1125 6450 m
gs 1 -1 sc (fork) col0 sh gr
/Helvetica ff 300.00 scf sf
1125 6900 m
gs 1 -1 sc (exec) col0 sh gr
/Helvetica ff 300.00 scf sf
2625 6450 m
gs 1 -1 sc (exit) col0 sh gr
% Polyline
7.500 slw
n 900 2850 m 4125 2850 l gs col0 s gr 
% Polyline
30.000 slw
n 900 2400 m 4125 2400 l 4125 4650 l 900 4650 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
1125 3150 m
gs 1 -1 sc (mmap) col0 sh gr
/Helvetica ff 300.00 scf sf
1125 3480 m
gs 1 -1 sc (munmap) col0 sh gr
/Helvetica ff 300.00 scf sf
1125 3810 m
gs 1 -1 sc (mprotect) col0 sh gr
/Helvetica ff 300.00 scf sf
1125 4140 m
gs 1 -1 sc (minherit) col0 sh gr
/Helvetica ff 300.00 scf sf
1125 4470 m
gs 1 -1 sc (msync) col0 sh gr
/Helvetica ff 300.00 scf sf
2625 3150 m
gs 1 -1 sc (madvise) col0 sh gr
/Helvetica ff 300.00 scf sf
2625 3480 m
gs 1 -1 sc (mlock) col0 sh gr
/Helvetica ff 300.00 scf sf
2625 3810 m
gs 1 -1 sc (break) col0 sh gr
/Helvetica ff 300.00 scf sf
2625 4140 m
gs 1 -1 sc (swapctl) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
975 2700 m
gs 1 -1 sc (user system calls) col0 sh gr
% Polyline
n 900 7950 m 4125 7950 l 4125 8400 l 900 8400 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
975 8250 m
gs 1 -1 sc (page fault handler) col0 sh gr
% Polyline
7.500 slw
n 7950 6000 m 10350 6000 l gs col0 s gr 
% Polyline
30.000 slw
n 7950 5550 m 10350 5550 l 10350 7050 l 7950 7050 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
8025 5850 m
gs 1 -1 sc (vnode system) col0 sh gr
/Helvetica ff 300.00 scf sf
8175 6450 m
gs 1 -1 sc (ffs \(disk\)) col0 sh gr
/Helvetica ff 300.00 scf sf
8175 6900 m
gs 1 -1 sc (nfs \(network\)) col0 sh gr
% Polyline
7.500 slw
n 7950 3825 m 10350 3825 l gs col0 s gr 
% Polyline
30.000 slw
n 7950 3375 m 10350 3375 l 10350 4875 l 7950 4875 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
8025 3675 m
gs 1 -1 sc (device memory) col0 sh gr
/Helvetica ff 300.00 scf sf
8175 4275 m
gs 1 -1 sc (d_mmap) col0 sh gr
/Helvetica-Bold ff 330.00 scf sf
2550 1350 m
gs 1 -1 sc (Operations that) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 330.00 scf sf
2550 1740 m
gs 1 -1 sc (make calls to VM) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 330.00 scf sf
9150 1275 m
gs 1 -1 sc (Operations called) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 330.00 scf sf
9150 1665 m
gs 1 -1 sc (by VM) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
4950 5680 m 5016 5575 l 5007 5699 l 5058 5545 l 5001 5526 l cp
clip
n 4125 8250 m 5025 5550 l gs col0 s gr gr

% arrowhead
n 4950 5680 m 5016 5575 l 5007 5699 l 4979 5689 l 4950 5680 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4907 5342 m 5007 5270 l 4952 5381 l 5058 5258 l 5012 5219 l cp
clip
n 4125 6300 m 5025 5250 l gs col0 s gr gr

% arrowhead
n 4907 5342 m 5007 5270 l 4952 5381 l 4929 5362 l 4907 5342 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4961 4739 m 5008 4853 l 4913 4775 l 5010 4905 l 5058 4869 l cp
clip
n 4125 3675 m 5025 4875 l gs col0 s gr gr

% arrowhead
n 4961 4739 m 5008 4853 l 4913 4775 l 4937 4757 l 4961 4739 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7856 6183 m 7929 6282 l 7818 6229 l 7942 6333 l 7981 6287 l cp
clip
n 7050 5550 m 7950 6300 l gs col0 s gr gr

% arrowhead
n 7856 6183 m 7929 6282 l 7818 6229 l 7837 6206 l 7856 6183 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7818 4196 m 7929 4142 l 7856 4242 l 7981 4138 l 7942 4092 l cp
clip
n 7050 4875 m 7950 4125 l gs col0 s gr gr

% arrowhead
n 7818 4196 m 7929 4142 l 7856 4242 l 7837 4219 l 7818 4196 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 705 2100 m 600 2100 600 8595 105 arcto 4 {pop} repeat
  600 8700 4320 8700 105 arcto 4 {pop} repeat
  4425 8700 4425 2205 105 arcto 4 {pop} repeat
  4425 2100 705 2100 105 arcto 4 {pop} repeat
 cp gs col0 s gr 
% Polyline
30.000 slw
n 5025 4875 m 7050 4875 l 7050 5550 l 5025 5550 l cp gs col0 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 1328 2663 a(Figure)25 b(2.1:)30 b(The)25
b(role)g(of)f(the)h(VM)f(system)583 3058 y(The)i(role)f(of)h(the)f(VM)g
(system)f(is)h(sho)n(wn)f(in)h(Figure)h(2.1.)32 b(As)25
b(sho)n(wn)f(on)h(the)h(left)f(side)g(of)g(the)300 3207
y(\002gure,)i(the)e(services)h(of)g(the)g(VM)g(system)f(are)h
(requested)g(in)g(three)g(w)o(ays.)34 b(First,)26 b(system)f(calls)g
(such)300 3357 y(as)35 b Fm(mmap)e Fs(and)i Fm(mprotect)e
Fs(may)h(be)h(called)f(by)h(a)f(process)h(to)f(change)h(the)f
(con\002guration)g(of)h(its)300 3506 y(virtual)28 b(memory)g(address)g
(space.)43 b(Second,)30 b(virtual)e(memory)f(process)i(management)f
(services)g(are)300 3656 y(called)f(by)g(the)h(k)o(ernel)f(when)g(a)h
(process)f(is)g(in)g(the)g(midst)f(of)i(a)g Fm(fork)p
Fs(,)f Fm(exec)p Fs(,)g(or)g Fm(exit)g Fs(operation.)300
3805 y(Finally)-6 b(,)36 b(the)e(VM)g(system)f(is)h(called)g(when)g(a)h
(page)f(f)o(ault)g(occurs)g(to)g(resolv)o(e)g(the)g(f)o(ault)g(either)g
(by)300 3954 y(pro)o(viding)g(memory)h(for)h(the)g(process)g(to)f(use)h
(or)g(by)g(signaling)e(an)i(error)h(with)e(a)h(\223se)o(gmentation)300
4104 y(violation.)-7 b(\224)583 4253 y(In)33 b(the)f(course)h(of)g(its)
e(operation)h(the)h(VM)f(system)f(may)h(need)h(to)f(request)g(the)h
(services)f(of)300 4403 y(other)24 b(parts)g(of)h(the)f(k)o(ernel)g(in)
g(the)g(form)g(of)h(an)f(I/O)h(request.)30 b(The)24 b(VM)g(system)f
(mak)o(es)h(tw)o(o)g(types)g(of)300 4552 y(I/O)h(requests,)f(as)h(sho)n
(w)f(in)h(the)f(right)h(half)g(of)g(Figure)g(2.1.)31
b(F)o(or)25 b(de)n(vices)f(such)g(as)i(frame)f(b)n(uf)n(fers)g(that)300
4701 y(allo)n(w)20 b(their)g(de)n(vice)h(memory)f(to)g(be)h(memory)f
(mapped)h(\(with)f(the)h Fm(mmap)f Fs(system)g(call\),)h(the)g(de)n
(vice')-5 b(s)300 4851 y Fm(d)p 366 4851 30 4 v 36 w(mmap)27
b Fs(function)h(is)g(called)g(to)g(con)l(v)o(ert)f(an)i(of)n(fset)f
(into)f(the)h(de)n(vice)g(into)g(a)g(physical)f(address)i(that)300
5000 y(can)36 b(be)f(mapped)f(in.)62 b(F)o(or)35 b(normal)f(\002les)i
(the)f(vnode)f(system)g(is)h(called)g(to)g(perform)g(I/O)g(between)300
5150 y(the)d(VM)f(system')-5 b(s)30 b(b)n(uf)n(fers)i(and)g(the)f
(underlying)g(\002le.)52 b(As)32 b(sho)n(wn)e(in)i(the)g(\002gure,)i
(the)d(underlying)300 5299 y(\002le)j(may)f(reside)g(on)g(a)h(local)f
(\002lesystem)f(or)h(it)g(may)g(reside)g(on)g(a)h(remote)f(computer)g
(\(and)g(is)g(thus)p eop
%%Page: 10 30
10 29 bop 3800 100 a Fs(10)300 249 y(accessed)26 b(via)f(the)h(netw)o
(ork)f(\002le)h(system\).)31 b(Note,)26 b(because)g(it)f(is)g(possible)
f(for)i(these)f(I/O)g(systems)f(to)300 398 y(mak)o(e)h(requests)f(back)
h(into)f(the)h(VM)f(system,)g(care)h(must)f(be)h(tak)o(en)g(to)f(a)n(v)
n(oid)g(potential)g(deadlock.)300 780 y Fg(2.2)143 b(The)35
b(VM)h(System)e(and)h(Pr)m(ocess)f(Life)h(Cycle)300 1033
y Fs(Understanding)d(the)i(intimate)e(details)h(of)h(the)f(operation)g
(of)h(the)g(VM)f(system)g(is)g(a)h(dif)n(\002cult)f(task.)300
1182 y(Ho)n(we)n(v)o(er)l(,)h(after)g(getting)e(an)h(understanding)e
(of)j(the)f(role)g(of)g(the)g(VM)f(system,)i(a)g(good)e(ne)o(xt)h(step)
300 1332 y(to)28 b(understanding)e(the)i(o)o(v)o(erall)f(structure)h
(of)g(the)g(VM)f(system)g(is)h(to)f(e)o(xamine)h(the)f(role)i(of)f(the)
g(VM)300 1481 y(system)20 b(through)g(the)h(life)g(c)o(ycle)g(of)g(a)h
(process.)29 b(A)21 b(good)g(process)g(to)g(start)g(with)f(is)h(the)g
(\223init\224)f(process.)300 1810 y Ff(2.2.1)119 b(Pr)n(ocess)28
b(Start-up)300 2027 y Fs(The)20 b(init)f(process)h(is)g(the)g(\002rst)h
(user)n(-le)n(v)o(el)e(process)h(created)h(by)f(the)g(k)o(ernel)g
(after)h(being)e(bootstrapped.)300 2176 y(When)25 b(starting)f(init,)g
(the)g(k)o(ernel)h(creates)h(a)f(ne)n(w)f(user)h(virtual)g(address)f
(space)i(for)f(init)f(that)g(contains)300 2326 y(no)32
b(mappings)f(\(i.e.)53 b(it)32 b(is)f(completely)g(unmapped\).)53
b(Before)33 b(the)f(k)o(ernel)h(can)f(let)g(init)f(run)i(it)e(must)300
2475 y(map)26 b(data)h(into)f(the)h(address)g(space.)37
b(Data)27 b(is)f(mapped)g(from)h(the)g(\002le)g Fm(/sbin/init)p
Fs(.)34 b(The)27 b(rest)g(of)300 2625 y(the)g(init)e(process')i(memory)
f(is)h(left)f(unmapped)g(or)h(zeroed.)38 b(The)26 b(\002le)i
Fm(/sbin/init)c Fs(contains)i(the)300 2774 y(follo)n(wing)d(items:)300
2997 y Fo(text:)49 b Fs(the)37 b(compiled)g(code)g(for)g(the)h(init)e
(program.)67 b(The)38 b(te)o(xt)e(starts)g(of)n(f)h(with)g(a)h(special)
e(header)544 3146 y(data)23 b(structure)1082 3110 y Fj(1)1142
3146 y Fs(that)f(indicates)g(the)h(size)g(of)g(each)g(se)o(gment)f(of)g
(the)h(program)g(and)f(the)h(starting)544 3296 y(address)i(of)f(the)h
(\002rst)g(machine)f(instruction)g(of)g(the)h(program.)300
3525 y Fo(data:)49 b Fs(the)38 b(pre-initialized)f(v)n(ariable)g(data)h
(for)g(the)g(program.)70 b(F)o(or)37 b(e)o(xample,)k(if)c(init)g
(declared)i(a)544 3674 y(global)22 b(v)n(ariable)g(\223)p
Fm(x)p Fs(\224)h(lik)o(e)g(this:)28 b(\223)p Fm(int)59
b(x)h(=)f(55;)p Fs(\224)24 b(then)e(the)h(v)n(alue)f(55)g(w)o(ould)g
(be)h(stored)f(in)544 3824 y(the)j(data)f(area)i(of)f(the)g
Fm(/sbin/init)d Fs(\002le.)300 4053 y Fo(symbols:)48
b Fs(the)24 b(symbols)e(stored)h(in)h(the)f(program)h(are)g(used)g(for)
g(deb)n(ugging)e(and)i(are)g(often)g(stripped)544 4202
y(out)g(of)h(system)f(programs)g(such)g(as)h(init.)30
b(The)o(y)24 b(are)i(ignored)e(by)g(the)h(k)o(ernel.)583
4425 y(Zeroed)38 b(memory)e(is)h(a)g(form)g(of)g(\223anon)o(ymous)e
(memory\224)i(that)f(is)h(initialized)f(or)h(\223\002lled\224)300
4575 y(with)30 b(zeros)h(when)f(it)g(is)g(\002rst)h(referenced.)49
b(Anon)o(ymous)29 b(memory)g(is)h(memory)g(that)g(is)g(not)g(part)h(of)
300 4724 y(a)d(\002le,)g(and)g(thus)e(has)h(no)h(\002lename)f
(associated)g(with)g(it.)38 b(The)27 b(modi\002ed)g(pages)g(of)h(a)g
(cop)o(y-on-write)300 4874 y(mapped)23 b(re)o(gion)f(are)i(also)f(anon)
o(ymous.)28 b(The)c(init)e(program')-5 b(s)22 b(zeroed)i(memory)f(is)f
(di)n(vided)g(into)h(tw)o(o)300 5023 y(parts:)49 b(the)34
b(uninitialized)e(data)i(\(\223bss\224)1708 4987 y Fj(2)1745
5023 y Fs(\))h(and)f(the)f(stack.)59 b(The)34 b(uninitialized)e(data)i
(area)h(is)f(where)p 300 5109 1440 4 v 416 5171 a Fi(1)449
5201 y Fh(The)d(format)f(of)h(the)g(header)f(data)h(structure)g(v)n
(aries)f(depending)f(on)i(what)g(system)g(you)f(are)i(on.)57
b(T)-7 b(w)o(o)31 b(popular)300 5300 y(formats)19 b(for)h(this)h
(header)e(are)h(the)g(\223a.out\224)f(format)g(and)h(the)g(ELF)g
(format.)416 5370 y Fi(2)449 5400 y Fh(\223bss\224)h(is)g(short)f(for)g
(\223block)f(started)h(by)f(symbol\224)h(\227)g(a)h(term)f(no)g(longer)
f(commonly)e(used.)p eop
%%Page: 11 31
11 30 bop 3800 100 a Fs(11)891 300 y(T)-8 b(able)25 b(2.1:)30
b(The)25 b(init)f(program')-5 b(s)24 b(virtual)g(address)h(space)g
(attrib)n(utes)p 875 432 2425 4 v 873 553 4 121 v 947
517 a Fo(Region)p 1316 553 V 122 w(Pr)n(otection)p 1857
553 V 100 w(Copy-on-write)p 2576 553 V 101 w(backing)g(object)p
3298 553 V 875 556 2425 4 v 873 676 4 121 v 1022 640
a Fs(te)o(xt)p 1316 676 V 362 w(r/o)p 1857 676 V 508
w(yes)p 2576 676 V 355 w Fm(/sbin/init)p 3298 676 V 875
680 2425 4 v 873 800 4 121 v 1013 764 a Fs(data)p 1316
800 V 343 w(r/w)p 1857 800 V 497 w(yes)p 2576 800 V 355
w Fm(/sbin/init)p 3298 800 V 875 804 2425 4 v 873 924
4 121 v 925 888 a Fs(bss/heap)p 1316 924 V 253 w(r/w)p
1857 924 V 513 w(\227)p 2576 924 V 437 w Fn(<)p Fs(zero-\002ll)p
Fn(>)p 3298 924 V 875 927 2425 4 v 873 1048 4 121 v 994
1011 a Fs(stack)p 1316 1048 V 323 w(r/w)p 1857 1048 V
513 w(\227)p 2576 1048 V 437 w Fn(<)p Fs(zero-\002ll)p
Fn(>)p 3298 1048 V 875 1051 2425 4 v 300 1425 a Fs(global)j(data)i(v)n
(ariables)e(that)h(ha)n(v)o(e)f(not)h(been)g(assigned)g(a)g(v)n(alue)g
(are)h(stored.)43 b(Also,)29 b(if)g(the)g(program)300
1574 y(does)f(dynamic)f(memory)g(allocation)h(with)f
Fm(malloc)g Fs(the)h(bss)f(area)i(is)f(often)g(e)o(xpanded)f(to)h(pro)o
(vide)300 1723 y(memory)d(for)h Fm(malloc)e Fs(to)h(manage)1597
1687 y Fj(3)1634 1723 y Fs(.)33 b(This)25 b(e)o(xpanded)g(area)h(is)g
(called)f(the)h(\223heap.)-7 b(\224)33 b(The)26 b(stack)f(area)300
1873 y(is)f(where)i(the)e(program')-5 b(s)24 b(stack,)h(including)e
(local)i(v)n(ariables,)f(is)g(stored.)583 2022 y(When)j(the)g(k)o
(ernel)g(prepares)g(the)g(init)f(process)g(for)h(e)o(x)o(ecution)f(it)g
(must)g(use)g(the)h(VM)f(system)300 2171 y(to)c(establish)g(the)h
(virtual)f(memory)g(mappings)f(of)i(the)g(te)o(xt,)f(data,)h(bss,)f
(and)h(stack)g(areas.)31 b(This)22 b(is)g(part)300 2321
y(of)27 b(the)g(\223e)o(x)o(ec\224)h(process)f(of)g(a)h(process')f
(life)g(c)o(ycle.)38 b(In)28 b(an)f(e)o(x)o(ec)g(system)f(call,)i(the)f
(k)o(ernel)g(opens)g(the)300 2470 y(\002le)h(to)g(be)g(run)f(and)h
(reads)g(the)g(header)g(to)g(determine)f(the)h(size)g(of)g(the)f(te)o
(xt,)h(data,)h(and)e(bss)h(areas.)40 b(It)300 2620 y(then)21
b(uses)g(the)g(VM)g(system)g(to)g(establish)f(virtual)h(memory)f
(mappings)g(for)i(these)f(areas,)i(as)e(sho)n(wn)f(in)300
2769 y(Figure)26 b(2.2.)32 b(Each)25 b(of)h(the)f(four)h(mappings)e
(has)h(three)h(main)e(attrib)n(utes)h(as)g(sho)n(wn)f(in)i(T)-8
b(able)25 b(2.1:)31 b(the)300 2918 y(backing)c(object,)h(the)f(cop)o
(y-on-write)g(status,)g(and)h(the)f(protection.)38 b(The)28
b(backing)f(object)g(indicates)300 3068 y(what)k(object)g(is)g(mapped)g
(into)g(the)g(space.)51 b(This)31 b(is)g(usually)f(a)i(\002le)g(or)f
(\223zero-\002ll\224)i(memory)e(which)300 3217 y(means)38
b(that)g(the)g(area)h(should)f(be)g(\002lled)g(with)g(zeroed)h(memory)f
(as)g(it)g(is)g(accessed.)72 b(The)38 b(cop)o(y-)300
3367 y(on-write)30 b(status)f(indicates)g(whether)h(changes)g(made)f
(to)h(the)g(memory)f(should)g(be)h(re\003ected)h(to)e(the)300
3516 y(backing)35 b(object)h(\(if)g(it)f(is)h(not)f(zero-\002ll\).)65
b(If)36 b(part)g(of)g(a)g(\002le)h(is)e(memory)g(mapped)h(without)e
(cop)o(y-)300 3665 y(on-write)d(\(\223shared)h(mappings\224\))f(then)g
(changes)h(to)f(that)g(portion)g(of)h(memory)e(will)h(cause)h(the)g
(\002le)300 3815 y(itself)c(to)g(be)g(changed.)42 b(F)o(or)28
b(zero-\002ll)h(memory)-6 b(,)28 b(the)g(cop)o(y-on-write)g(\003ag)h
(doesn')n(t)f(matter)-5 b(.)40 b(Finally)-6 b(,)300 3964
y(the)33 b(protection)f(is)h(usually)f(one)h(of)g(read-only)g(or)g
(read-write,)i(b)n(ut)e(it)f(can)i(also)e(be)h(set)g(to)g(\223none.)-7
b(\224)300 4114 y(The)33 b(MMU)f(is)h(used)f(to)h(map)f(pages)h(in)g
(the)g(allocated)f(ranges)h(of)g(virtual)g(address)g(space)g(to)f
(their)300 4263 y(corresponding)24 b(physical)f(address.)583
4412 y(When)f(the)g(k)o(ernel)g(does)f(an)h(e)o(x)o(ec)g(call)g(on)f
Fm(/sbin/init)f Fs(the)i(follo)n(wing)d(mappings)i(are)h(set)300
4562 y(up:)300 4794 y Fo(text:)49 b Fs(The)29 b(te)o(xt)f(memory)g
(area)i(is)e(a)i(read-only)e(mapping)g(of)h(the)g(te)o(xt)f(part)h(of)g
(the)f Fm(/sbin/init)544 4944 y Fs(\002le.)i(The)22 b(mapping)f(is)h
(mark)o(ed)g(cop)o(y-on-write)g(in)f(case)i(the)f(program)g(is)g(run)g
(under)g(a)g(deb)n(ug-)544 5093 y(ger)28 b(\(in)g(which)g(case)g(the)g
(deb)n(ugger)g(may)g(change)g(the)g(protection)f(of)h(the)g(te)o(xt)f
(to)h(read-write)p 300 5183 1440 4 v 416 5244 a Fi(3)449
5274 y Fh(Some)20 b(ne)n(wer)g(v)o(ersions)f(of)h Fe(malloc)g
Fh(allocate)g(memory)e(using)i Fe(mmap)g Fh(rather)f(than)h(e)o
(xpanding)d(the)j(bss)h(area.)p eop
%%Page: 12 32
12 31 bop 3800 100 a Fs(12)426 4168 y @beginspecial 0
@llx 0 @lly 574 @urx 576 @ury 4018 @rwi @setspecial
%%BeginDocument: ../figures/init.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 583.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 9754 m 0 0 l 9878 0 l 9878 9754 l cp clip
 0.06000 0.06000 sc
% Polyline
7.500 slw
n 4800 1950 m 5400 1950 l 5400 6000 l 4800 6000 l cp gs col7 0.95 shd ef gr gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
5175 600 m
gs 1 -1 sc (address space) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 9596 7500 m 9604 7500 l gs col0 s gr
% Polyline
30.000 slw
n 8400 6150 m 9600 6150 l 9600 9525 l 8400 9525 l cp gs col0 s gr 
% Polyline
7.500 slw
n 8400 6900 m 9600 6900 l gs col0 s gr 
% Polyline
n 8400 7500 m 9600 7500 l gs col0 s gr 
/Helvetica ff 300.00 scf sf
9000 8625 m
gs 1 -1 sc (text) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
9000 7275 m
gs 1 -1 sc (data) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
9000 6600 m
gs 1 -1 sc (sym) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
9000 6000 m
gs 1 -1 sc (/sbin/init file) dup sw pop 2 div neg 0 rm  col0 sh gr
30.000 slw
% Ellipse
n 3300 5250 503 503 0 360 DrawEllipse gs col0 s gr

/Helvetica-Bold ff 300.00 scf sf
3300 5325 m
gs 1 -1 sc (mmu) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
 [15 45] 45 sd
gs  clippath
1916 4445 m 1823 4362 l 1944 4392 l 1801 4316 l 1773 4370 l cp
clip
n 2912 4932 m 1800 4350 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 1916 4445 m 1823 4362 l 1944 4392 l 1930 4418 l 1916 4445 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
1950 5558 m 1826 5545 l 1941 5498 l 1781 5523 l 1790 5582 l cp
clip
n 2807 5397 m 1800 5550 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 1950 5558 m 1826 5545 l 1941 5498 l 1945 5528 l 1950 5558 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
1940 6396 m 1822 6435 l 1908 6345 l 1771 6433 l 1804 6483 l cp
clip
n 3022 5667 m 1800 6450 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 1940 6396 m 1822 6435 l 1908 6345 l 1924 6371 l 1940 6396 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 4800 900 m 5400 900 l 5400 9600 l 4800 9600 l cp gs col0 s gr 
% Polyline
7.500 slw
n 4800 7500 m 5400 7500 l gs col0 s gr 
% Polyline
n 4800 6900 m 5400 6900 l gs col0 s gr 
% Polyline
gs  clippath
5070 5697 m 5100 5577 l 5130 5697 l 5130 5535 l 5070 5535 l cp
clip
n 5100 5550 m 5100 6000 l gs col0 s gr gr

% arrowhead
n 5070 5697 m 5100 5577 l 5130 5697 l 5100 5697 l 5070 5697 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5130 2253 m 5100 2373 l 5070 2253 l 5070 2415 l 5130 2415 l cp
clip
n 5100 1950 m 5100 2400 l gs col0 s gr gr

% arrowhead
n 5130 2253 m 5100 2373 l 5070 2253 l 5100 2253 l 5130 2253 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4530 9153 m 4500 9273 l 4470 9153 l 4470 9315 l 4530 9315 l cp
4470 1647 m 4500 1527 l 4530 1647 l 4530 1485 l 4470 1485 l cp
clip
n 4500 1500 m 4500 9300 l gs col0 s gr gr

% arrowhead
n 4470 1647 m 4500 1527 l 4530 1647 l 4500 1647 l 4470 1647 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 4530 9153 m 4500 9273 l 4470 9153 l 4500 9153 l 4530 9153 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5847 1530 m 5727 1500 l 5847 1470 l 5685 1470 l 5685 1530 l cp
clip
n 6300 1500 m 5700 1500 l gs col0 s gr gr

% arrowhead
n 5847 1530 m 5727 1500 l 5847 1470 l 5847 1500 l 5847 1530 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5847 6480 m 5727 6450 l 5847 6420 l 5685 6420 l 5685 6480 l cp
clip
n 6300 6450 m 5700 6450 l gs col0 s gr gr

% arrowhead
n 5847 6480 m 5727 6450 l 5847 6420 l 5847 6450 l 5847 6480 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4800 9525 m 5400 9525 l gs col0 s gr 
% Polyline
gs  clippath
5847 4005 m 5727 3975 l 5847 3945 l 5685 3945 l 5685 4005 l cp
clip
n 6300 3975 m 5700 3975 l gs col0 s gr gr

% arrowhead
n 5847 4005 m 5727 3975 l 5847 3945 l 5847 3975 l 5847 4005 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5847 7230 m 5727 7200 l 5847 7170 l 5685 7170 l 5685 7230 l cp
clip
n 8400 7200 m 5700 7200 l gs col0 s gr gr

% arrowhead
n 5847 7230 m 5727 7200 l 5847 7170 l 5847 7200 l 5847 7230 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5847 8580 m 5727 8550 l 5847 8520 l 5685 8520 l 5685 8580 l cp
clip
n 8400 8550 m 5700 8550 l gs col0 s gr gr

% arrowhead
n 5847 8580 m 5727 8550 l 5847 8520 l 5847 8550 l 5847 8580 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5772 9555 m 5652 9525 l 5772 9495 l 5610 9495 l 5610 9555 l cp
clip
n 6225 9525 m 5625 9525 l gs col0 s gr gr

% arrowhead
n 5772 9555 m 5652 9525 l 5772 9495 l 5772 9525 l 5772 9555 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
3837 5597 m 3769 5493 l 3878 5553 l 3759 5443 l 3719 5487 l cp
clip
n 4800 6450 m 3750 5475 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 3837 5597 m 3769 5493 l 3878 5553 l 3858 5575 l 3837 5597 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
3687 5772 m 3638 5658 l 3734 5736 l 3637 5607 l 3589 5643 l cp
clip
n 4800 7200 m 3622 5637 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 3687 5772 m 3638 5658 l 3734 5736 l 3710 5754 l 3687 5772 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
3473 5876 m 3461 5752 l 3529 5855 l 3475 5703 l 3419 5723 l cp
clip
n 4800 9525 m 3452 5727 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 3473 5876 m 3461 5752 l 3529 5855 l 3501 5866 l 3473 5876 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 68] 68 sd
gs  clippath
1947 5280 m 1827 5250 l 1947 5220 l 1785 5220 l 1785 5280 l cp
clip
n 2802 5250 m 1800 5250 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 1947 5280 m 1827 5250 l 1947 5220 l 1947 5250 l 1947 5280 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
3728 4760 m 3664 4866 l 3670 4743 l 3624 4898 l 3681 4915 l cp
clip
n 4800 1050 m 3657 4892 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 3728 4760 m 3664 4866 l 3670 4743 l 3699 4751 l 3728 4760 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 1200 4200 m 1800 4200 l gs col0 s gr 
% Polyline
n 1200 4500 m 1800 4500 l gs col0 s gr 
% Polyline
n 1200 4800 m 1800 4800 l gs col0 s gr 
% Polyline
n 1200 5100 m 1800 5100 l gs col0 s gr 
% Polyline
n 1200 5400 m 1800 5400 l gs col0 s gr 
% Polyline
n 1200 6000 m 1800 6000 l gs col0 s gr 
% Polyline
n 1200 6300 m 1800 6300 l gs col0 s gr 
% Polyline
n 1200 5700 m 1800 5700 l gs col0 s gr 
% Polyline
n 1200 6600 m 1800 6600 l gs col0 s gr 
% Polyline
30.000 slw
n 1200 3900 m 1800 3900 l 1800 6900 l 1200 6900 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4425 9675 m
gs 1 -1 sc (0) col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1050 m
gs 1 -1 sc (max user) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1380 m
gs 1 -1 sc (address) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6450 4050 m
gs 1 -1 sc (unallocated) col0 sh gr
/Helvetica ff 300.00 scf sf
6450 9600 m
gs 1 -1 sc (first page) col0 sh gr
/Helvetica ff 300.00 scf sf
6450 1575 m
gs 1 -1 sc (stack \(zero-fill mapping\)) col0 sh gr
/Helvetica ff 300.00 scf sf
6450 6525 m
gs 1 -1 sc (bss/heap) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 3300 m
gs 1 -1 sc (pages of) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5175 300 m
gs 1 -1 sc (process) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 3645 m
gs 1 -1 sc (physical memory) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 300 4371 a(Figure)31 b(2.2:)41 b(The)31
b(init)e(program')-5 b(s)30 b(virtual)f(memory)h(layout.)47
b(The)30 b(stack)g(and)h(bss/heap)f(mappings)300 4492
y(are)e(zero-\002ll,)g(while)f(the)g(te)o(xt)f(and)h(data)g(mappings)f
(are)i(tak)o(en)f(from)g(the)g Fm(/sbin/init)e Fs(\002le.)38
b(The)300 4612 y(MMU)24 b(maps)f(addresses)i(in)f(the)g(virtual)g
(address)g(space)h(to)f(their)g(corresponding)f(physical)g(address.)p
eop
%%Page: 13 33
13 32 bop 3800 100 a Fs(13)544 249 y(to)30 b(insert)f(and)i(remo)o(v)o
(e)e(break-points\).)46 b(Under)30 b(normal)g(operation)f(a)i(process)f
(ne)n(v)o(er)g(writes)544 398 y(to)24 b(the)h(te)o(xt)f(area)i(of)e
(memory)-6 b(.)300 631 y Fo(data:)49 b Fs(The)25 b(data)g(memory)f
(area)i(is)e(a)h(read-write)g(cop)o(y-on-write)g(mapping)e(of)i(the)g
(data)g(part)f(of)h(the)544 780 y Fm(/sbin/init)19 b
Fs(program.)29 b(This)20 b(means)h(that)g(the)g(initial)f(v)n(alues)g
(of)h(the)g(data)g(area)i(are)e(loaded)544 930 y(from)k(the)g(\002le,)g
(b)n(ut)g(as)g(the)g(data)g(is)g(changed)g(the)g(changes)h(are)f(pri)n
(v)n(ate)f(to)h(the)g(process.)32 b(Thus,)544 1079 y(if)i(other)g
(users)f(run)h(the)g(program,)i(the)o(y)d(will)g(get)h(the)g(correct)g
(initial)f(v)n(alues)g(in)g(their)h(data)544 1228 y(se)o(gment.)300
1461 y Fo(bss:)49 b Fs(The)25 b(bss)f(memory)g(area)i(is)e(mapped)g(as)
h(a)g(zero-\002ll)h(area)f(after)h(the)f(data)f(memory)g(area.)300
1693 y Fo(stack:)49 b Fs(The)24 b(stack)f(memory)f(area)j(is)e(mapped)f
(as)i(a)g(zero-\002ll)f(area)i(at)e(the)g(end)h(of)f(the)g(user')-5
b(s)23 b(address)544 1843 y(space.)300 2075 y(Note)k(that)f(there)h(is)
f(a)h(v)o(ery)g(lar)n(ge)g(gap)f(of)h(free)g(virtual)f(address)h(space)
g(between)g(the)g(end)f(of)h(the)g(bss)300 2224 y(area)f(and)e(the)h
(be)o(ginning)d(of)j(the)f(stack)h(that)f(can)h(be)g(used)f(by)g(the)h
(process)f(or)h(the)f(operating)g(system)300 2374 y(to)h(map)g(in)h
(other)f(\002les)h(and)f(data)h(as)g(needed.)33 b(F)o(or)26
b(programs)f(that)g(use)g(shared)h(libraries)f(this)g(area)i(is)300
2523 y(used)h(by)g(the)h(dynamic)e(link)o(er)h(\(\223)p
Fm(ld.so)p Fs(\224\))h(at)f(run)h(time)e(to)h Fm(mmap)g
Fs(in)g(the)g(shared)h(library)f(\002les.)42 b(In)300
2673 y(the)24 b(case)g(of)g(init)e(we)i(assume)f(it)h(is)f(statically)f
(link)o(ed,)h(and)h(thus)f(does)g(not)g(need)h(to)g(map)f(in)g(an)o(y)g
(e)o(xtra)300 2822 y(\002les.)300 3153 y Ff(2.2.2)119
b(Running)32 b(Pr)n(ocesses)c(and)j(P)o(age)e(F)m(aults)300
3370 y Fs(Once)e(the)f(k)o(ernel)g(has)h(established)e(the)h(mappings)f
(for)h(init,)g(it)g(be)o(gins)f(the)h(init)g(program)g(e)o(x)o(ecution)
300 3519 y(at)31 b(the)h(starting)e(address)h(speci\002ed)h(in)f(the)g
(\002le')-5 b(s)32 b(header)-5 b(.)50 b(The)32 b(processor)f(hardw)o
(are)h(will)f(try)g(and)300 3669 y(e)o(x)o(ecute)k(the)h(\002rst)g
(instruction)e(of)i(init)f(only)g(to)h(disco)o(v)o(er)f(that)g(no)h
(physical)e(page)i(of)g(memory)g(is)300 3818 y(mapped)f(in)g(at)h(the)f
(starting)g(virtual)g(address.)63 b(This)35 b(will)f(cause)i(a)g(page)g
(f)o(ault)f(to)h(occur)g(and)f(the)300 3967 y(VM)29 b(system')-5
b(s)28 b(page)i(f)o(ault)f(handler)g(will)g(be)h(called.)44
b(The)30 b(steps)f(in)g(the)g(page)h(f)o(ault)f(process)h(are)g(as)300
4117 y(follo)n(ws:)420 4349 y(1.)49 b(The)27 b(process)g(accesses)g(a)g
(memory)f(address)h(that)f(is)h(not)f(mapped)h(\(or)g(improperly)e
(mapped\))544 4499 y(in)h(to)g(its)f(virtual)h(address)g(space.)35
b(The)26 b(processor')-5 b(s)26 b(memory)f(management)h(until)f
(generates)544 4648 y(a)g(page)g(f)o(ault)g(trap.)30
b(At)25 b(this)f(point)f(the)i(process)g(is)f(frozen)h(unit)f(the)h
(page)g(f)o(ault)g(is)f(resolv)o(ed.)420 4880 y(2.)49
b(The)31 b(processor)n(-speci\002c)g(part)h(of)f(the)g(k)o(ernel)g
(catches)g(the)g(page)g(f)o(ault)g(and)g(uses)g(the)g(MMU)544
5030 y(to)e(determine)f(the)h(virtual)f(address)h(that)g(triggered)g
(the)g(page)g(f)o(ault.)43 b(It)29 b(also)g(determines)f(the)544
5179 y(access)j(type)e(of)i(the)f(f)o(ault)g(by)g(checking)g(the)g
(hardw)o(are)g(to)g(see)h(if)f(the)g(process)g(w)o(as)g(reading)544
5329 y(from)24 b(or)h(writing)f(to)g(the)h(f)o(aulting)f(address.)p
eop
%%Page: 14 34
14 33 bop 3800 100 a Fs(14)420 249 y(3.)49 b(The)20 b(VM)g(system')-5
b(s)19 b(page)h(f)o(ault)g(routine)g(is)f(called)i(with)e(information)g
(on)h(the)g(f)o(aulting)f(process)544 398 y(and)25 b(the)f(address)h
(and)g(access)g(type)g(of)f(the)h(f)o(ault.)420 621 y(4.)49
b(The)28 b(VM)f(system)g(looks)f(in)i(the)f(process')h(mappings)e(to)i
(see)g(what)f(data)h(should)f(be)h(mapped)544 771 y(at)k(the)h(f)o
(aulting)e(address)h(\(for)h(e)o(xample,)h(the)e(f)o(ault)g(address)g
(could)g(be)h(mapped)f(to)g(the)g(\002rst)544 920 y(page)25
b(of)g(te)o(xt)f(of)h(the)f Fm(/sbin/init)f Fs(program\).)420
1143 y(5.)49 b(If)30 b(the)g(f)o(ault)g(routine)g(\002nds)g(that)f(the)
h(process')h(address)f(space)g(doesn')n(t)g(allo)n(w)f(access)i(to)e
(the)544 1293 y(f)o(aulting)d(address,)i(then)f(it)g(returns)g(an)h
(error)g(code,)g(which)f(under)g(Unix-lik)o(e)g(operating)g(sys-)544
1442 y(tems)d(causes)h(the)g(process)f(to)h(get)f(a)h(\223se)o
(gmentation)e(violation\224)h(error)-5 b(.)420 1665 y(6.)49
b(On)21 b(the)h(other)g(hand,)g(if)f(the)h(f)o(ault)f(routine)g
(\002nds)h(that)f(the)h(memory)e(access)j(w)o(as)e(v)n(alid,)g(it)h
(loads)544 1815 y(the)d(data)h(needed)f(by)h(the)f(process)g(into)g(a)h
(page)f(of)h(physical)e(memory)h(and)g(then)g(has)h(the)f(MMU)544
1964 y(map)31 b(that)h(page)g(of)g(memory)f(into)g(the)h(process')g
(address)g(space,)i(as)e(sho)n(wn)f(in)g(Figure)i(2.2.)544
2113 y(This)21 b(is)h(referred)h(to)f(as)g(f)o(aulting)f(in)g(data.)30
b(The)22 b(f)o(ault)g(routine)f(then)h(returns)g(\223success\224)g(and)
g(the)544 2263 y(process)31 b(is)f(unfrozen)i(and)f(can)g(resume)g
(running)f(with)g(the)h(needed)g(memory)f(mapped)h(into)544
2412 y(its)24 b(address)h(space.)583 2616 y(The)j(init)e(program)h
(starts)g(by)h(f)o(aulting)e(in)h(the)g(\002rst)h(page)g(of)f(te)o(xt)g
(from)g(the)g Fm(/sbin/init)300 2766 y Fs(\002le.)63
b(It)35 b(then)g(continues)g(running,)i(f)o(aulting)d(in)h(more)g
(pages)h(of)f(te)o(xt,)i(data,)h(bss,)g(and)d(stack.)62
b(As)300 2915 y(sho)n(wn)30 b(in)g(Figure)h(2.3,)h(re)o(gions)e(mapped)
h(cop)o(y-on-write)f(require)h(special)g(handling)f(by)h(the)f(f)o
(ault)300 3065 y(routine)g(to)g(ensure)h(that)g(the)f(underlying)g(e)o
(x)o(ecutable)g(\002le')-5 b(s)30 b(memory)g(is)g(not)h(modi\002ed)f
(by)g(a)h(write)300 3214 y(to)i(cop)o(y-on-write)f(mapping)g(of)h(it.)
55 b(Cop)o(y-on-write)33 b(pages)g(start)f(of)n(f)h(in)g(the)g
(\223pages)g(un-written\224)300 3363 y(state.)j(If)27
b(a)g(process)f(has)h(a)g(read-f)o(ault)g(on)f(a)h(cop)o(y-on-write)f
(page,)h(then)f(that)g(page)h(is)f(fetched)h(from)300
3513 y(the)f(backing)g(\002le)h(and)f(mapped)g(in)g(read-only)g(\(thus)
g(protecting)f(the)h(object)g(from)g(being)g(changed\).)300
3662 y(If)36 b(the)e(process)h(has)g(a)h(write-f)o(ault)e(on)h(the)g
(page)g(\(either)h(because)f(it)g(w)o(as)g(not)f(mapped)h(at)g(all,)i
(or)300 3812 y(because)27 b(it)f(w)o(as)g(mapped)g(read-only)h(due)f
(to)g(a)h(pre)n(vious)e(read-f)o(ault\),)j(then)e(a)g(cop)o(y)h(of)f
(the)h(backing)300 3961 y(object')-5 b(s)28 b(page)i(is)e(made.)44
b(The)29 b(ne)n(w)g(cop)o(y)g(of)g(the)g(page)h(is)e(then)h(mapped)g
(in)g(read-write,)h(replacing)300 4110 y(an)o(y)k(pre)n(vious)g
(read-only)h(mappings)e(of)i(the)g(data.)61 b(At)35 b(that)g(point)e
(the)i(page)g(is)g(in)g(the)f(\223written\224)300 4260
y(state.)c(Once)23 b(the)g(page)h(is)e(written,)h(all)g(future)g(read)h
(and)f(write)g(f)o(aults)g(cause)g(the)g(page)h(to)e(be)i(mapped)300
4409 y(in)f(read-write.)31 b(Such)24 b(f)o(aults)e(can)i(be)g(caused)f
(by)h(the)f(pagedaemon)g(paging)g(out)f(the)i(\223written\224)f(page.)
300 4558 y(P)o(ages)g(in)g(the)g(written)f(state)h(stay)g(in)f(that)h
(state)g(until)f(the)o(y)g(are)i(freed)f(or)h(the)o(y)e(are)i(part)f
(of)g(a)g(cop)o(y-on-)300 4708 y(write)i(fork)g(operation)f
(\(described)h(belo)n(w\).)300 5034 y Ff(2.2.3)119 b(F)m(orking)30
b(and)h(Exiting)300 5251 y Fs(When)20 b(the)g(system)e(is)i(booted,)g
(init)f(is)g(the)h(only)f(process)h(on)g(the)f(system.)28
b(In)20 b(order)h(to)e(allo)n(w)g(others)g(to)300 5400
y(use)h(the)h(system,)f(init)f(needs)i(to)f(create)h(more)g(processes)f
(by)g(using)g(the)g Fm(fork)g Fs(system)f(call.)29 b(The)21
b(fork)p eop
%%Page: 15 35
15 34 bop 3800 100 a Fs(15)805 2629 y @beginspecial 0
@llx 0 @lly 444 @urx 425 @ury 3108 @rwi @setspecial
%%BeginDocument: ../figures/cowstate.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-66.0 460.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7702 m 0 0 l 8527 0 l 8527 7702 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
6300 5625 m
gs 1 -1 sc (read-fault) col0 sh gr
/Helvetica ff 300.00 scf sf
7350 3270 m
gs 1 -1 sc (page read-only) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 2955 m
gs 1 -1 sc (make copy of) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 3285 m
gs 1 -1 sc (backing page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 4440 m
gs 1 -1 sc (map in copy) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 4770 m
gs 1 -1 sc (read/write) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
n 1125 4125 m 3375 4125 l 3375 4875 l 1125 4875 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 7215 m
gs 1 -1 sc (map page in) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 7545 m
gs 1 -1 sc (read/write) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 3675 6900 m 5925 6900 l 5925 7650 l 3675 7650 l cp gs col0 s gr 
% Polyline
30.000 slw
n 3630 1425 m 3525 1425 3525 1920 105 arcto 4 {pop} repeat
  3525 2025 5970 2025 105 arcto 4 {pop} repeat
  6075 2025 6075 1530 105 arcto 4 {pop} repeat
  6075 1425 3630 1425 105 arcto 4 {pop} repeat
 cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
4830 1278 m 4800 1398 l 4770 1278 l 4770 1440 l 4830 1440 l cp
clip
n 4800 825 m 4800 1425 l gs col0 s gr gr

% arrowhead
n 4830 1278 m 4800 1398 l 4770 1278 l 4800 1278 l 4830 1278 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 6225 2625 m 8475 2625 l 8475 3375 l 6225 3375 l cp gs col0 s gr 
% Polyline
gs  clippath
7380 2478 m 7350 2598 l 7320 2478 l 7320 2640 l 7380 2640 l cp
clip
n 6075 1800 m 7350 1800 l 7350 2625 l gs col0 s gr gr

% arrowhead
n 7380 2478 m 7350 2598 l 7320 2478 l 7350 2478 l 7380 2478 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4770 2172 m 4800 2052 l 4830 2172 l 4830 2010 l 4770 2010 l cp
clip
n 6225 3000 m 4800 3000 l 4800 2025 l gs col0 s gr gr

% arrowhead
n 4770 2172 m 4800 2052 l 4830 2172 l 4800 2172 l 4770 2172 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 1125 2625 m 3375 2625 l 3375 3375 l 1125 3375 l cp gs col0 s gr 
% Polyline
gs  clippath
2280 2478 m 2250 2598 l 2220 2478 l 2220 2640 l 2280 2640 l cp
clip
n 3525 1800 m 2250 1800 l 2250 2625 l gs col0 s gr gr

% arrowhead
n 2280 2478 m 2250 2598 l 2220 2478 l 2250 2478 l 2280 2478 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2280 3978 m 2250 4098 l 2220 3978 l 2220 4140 l 2280 4140 l cp
clip
n 2250 3375 m 2250 4125 l gs col0 s gr gr

% arrowhead
n 2280 3978 m 2250 4098 l 2220 3978 l 2250 3978 l 2280 3978 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 3630 5325 m 3525 5325 3525 5820 105 arcto 4 {pop} repeat
  3525 5925 5970 5925 105 arcto 4 {pop} repeat
  6075 5925 6075 5430 105 arcto 4 {pop} repeat
  6075 5325 3630 5325 105 arcto 4 {pop} repeat
 cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
3528 7245 m 3648 7275 l 3528 7305 l 3690 7305 l 3690 7245 l cp
clip
n 3525 5700 m 2250 5700 l 2250 7275 l 3675 7275 l gs col0 s gr gr

% arrowhead
n 3528 7245 m 3648 7275 l 3528 7305 l 3528 7275 l 3528 7245 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6072 7305 m 5952 7275 l 6072 7245 l 5910 7245 l 5910 7305 l cp
clip
n 6075 5700 m 7350 5700 l 7350 7275 l 5925 7275 l gs col0 s gr gr

% arrowhead
n 6072 7305 m 5952 7275 l 6072 7245 l 6072 7275 l 6072 7305 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4770 6072 m 4800 5952 l 4830 6072 l 4830 5910 l 4770 5910 l cp
clip
n 4800 6900 m 4800 5925 l gs col0 s gr gr

% arrowhead
n 4770 6072 m 4800 5952 l 4830 6072 l 4800 6072 l 4770 6072 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4830 5178 m 4800 5298 l 4770 5178 l 4770 5340 l 4830 5340 l cp
clip
n 3375 4500 m 4800 4500 l 4800 5325 l gs col0 s gr gr

% arrowhead
n 4830 5178 m 4800 5298 l 4770 5178 l 4800 5178 l 4830 5178 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica ff 300.00 scf sf
4800 1800 m
gs 1 -1 sc (page un-written) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 750 m
gs 1 -1 sc (start) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
3300 1725 m
gs 1 -1 sc (write-fault) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 5700 m
gs 1 -1 sc (page written) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6300 1725 m
gs 1 -1 sc (read-fault) col0 sh gr
/Helvetica ff 300.00 scf sf
3300 5625 m
gs 1 -1 sc (write-fault) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7350 2940 m
gs 1 -1 sc (map in backing) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 597 2832 a(Figure)25 b(2.3:)30 b(Handling)24
b(cop)o(y-on-write)g(pages)h(when)g(read)g(and)g(write)f(f)o(aults)h
(occur)300 3227 y(system)20 b(call)i(tak)o(es)f(a)h(process)f(and)g
(creates)h(a)g(child)f(process)g(that)g(has)g(a)h(cop)o(y)f(of)g(the)h
(parent)f(process')300 3377 y(virtual)e(address)g(space.)29
b(The)20 b(VM)f(system)f(handles)h(the)g(duplication)f(of)h(the)h
(parent')-5 b(s)19 b(address)g(space.)300 3526 y(If)j(the)f(VM)g
(system)f(actually)h(copied)g(e)n(v)o(ery)g(page)g(in)g(the)g(parent')
-5 b(s)21 b(address)g(space)h(to)f(a)g(ne)n(w)g(page)h(for)300
3675 y(the)30 b(child)f(process,)i(a)f(fork)g(operation)g(w)o(ould)f
(be)h(v)o(ery)g(e)o(xpensi)n(v)o(e)e(\(because)i(it)g(tak)o(es)f(a)i
(long)e(time)300 3825 y(to)h(mo)o(v)o(e)e(that)i(much)g(data\).)47
b(The)30 b(VM)f(system)g(a)n(v)n(oids)h(this)f(by)h(using)f(the)h(cop)o
(y-on-write)f(feature)300 3974 y(again.)36 b(F)o(or)27
b(e)o(xample,)f(when)h(the)f(init)g(program)h(forks,)g(all)f(the)h
(pages)f(that)h(are)g(copied)g(to)f(the)h(child)300 4124
y(process)e(are)g(put)f(into)g(the)h(\223pages)g(un-written\224)f
(state,)h(as)g(sho)n(wn)e(in)h(Figure)h(2.3.)583 4273
y(T)-8 b(ypically)i(,)25 b(after)i(doing)e(a)i(fork)f(operation,)g(the)
g(child)g(process)g(will)f(do)h(another)g(e)o(x)o(ec)g(oper)n(-)300
4422 y(ation)h(on)g(a)h(dif)n(ferent)f(\002le)g(\(for)h(e)o(xample,)f
Fm(/bin/sh)p Fs(\).)37 b(In)28 b(preparing)f(for)h(the)f(e)o(x)o(ec)g
(operation,)g(the)300 4572 y(k)o(ernel)33 b(will)f(\002rst)h(ask)g(the)
g(VM)g(system)e(to)i(unmap)f(all)h(acti)n(v)o(e)f(re)o(gions)g(in)h
(the)f(process)h(doing)f(the)300 4721 y(e)o(x)o(ec.)d(This)21
b(will)g(cause)h(the)g(process)g(to)f(return)h(to)g(a)g(completely)e
(unmapped)h(state.)30 b(Then)21 b(the)h(k)o(ernel)300
4870 y(will)i(map)g(the)h(program)f(into)g(the)h(address)g(space,)g(as)
g(pre)n(viously)e(described)h(abo)o(v)o(e.)583 5020 y(Finally)-6
b(,)41 b(when)e(the)f(process)h(e)o(xits,)i(the)d(VM)g(system)g(remo)o
(v)o(es)f(all)i(mappings)e(from)h(the)300 5169 y(process')20
b(address)f(space.)30 b(Handling)18 b(all)i(the)f(cases)i(that)e(can)h
(occur)g(with)f(cop)o(y-on-write)g(and)h(shared)300 5319
y(memory)-6 b(,)23 b(and)i(reco)o(v)o(ering)f(from)h(error)g
(conditions)e(add)i(to)f(the)h(comple)o(xity)e(of)i(the)f(VM)h(system.)
p eop
%%Page: 16 36
16 35 bop 3800 100 a Fs(16)300 249 y Ff(2.2.4)119 b(VM)30
b(Operations)300 466 y Fs(Other)k(VM)f(operations)f(that)h(the)h
(process)f(may)h(perform)f(while)g(running)g(include)g(the)g(follo)n
(wing)300 615 y(system)24 b(calls:)300 799 y Fd(break)p
Fo(:)48 b Fs(changes)25 b(the)f(size)h(of)g(a)g(process')g(heap)g
(area.)300 1015 y Fd(mmap)p Fo(:)48 b Fs(memory)24 b(maps)g(a)h(\002le)
h(or)e(anon)o(ymous)f(memory)-6 b(.)300 1231 y Fd(munmap)p
Fo(:)48 b Fs(remo)o(v)o(es)23 b(the)i(mapping)e(of)i(a)g(\002le)h(or)e
(anon)o(ymous)f(memory)-6 b(.)300 1447 y Fd(mprotect)p
Fo(:)47 b Fs(changes)39 b(the)g(current)g(protection)g(of)g(a)g
(mapping.)73 b(Each)39 b(mapped)g(re)o(gion)f(has)h(a)544
1596 y(\223maximum)29 b(allo)n(wed)h(protection\224)h(v)n(alue)f
(controlled)g(by)h(the)f(k)o(ernel)h(that)g(k)o(eeps)g(a)g(process)544
1746 y(from)24 b(gaining)g(unauthorized)g(access)h(to)g(a)g(block)f(of)
h(memory)-6 b(.)300 1962 y Fd(minherit)p Fo(:)47 b Fs(changes)23
b(the)f(inheritance)h(of)f(a)h(mapped)f(re)o(gion.)29
b(The)23 b(inheritance)f(attrib)n(ute)g(is)g(used)544
2111 y(during)30 b(a)i(fork)f(to)g(control)f(the)h(child)g(process')g
(access)h(to)f(the)g(parents)g(memory)-6 b(.)48 b(It)31
b(can)h(be)544 2261 y(either)25 b(\223cop)o(y)-6 b(,)f(\224)24
b(\223share,)-7 b(\224)26 b(or)f(\223none.)-7 b(\224)300
2477 y Fd(msync)p Fo(:)48 b Fs(\003ushes)41 b(modi\002ed)g(memory)f
(back)h(to)g(backing)g(store.)80 b(This)40 b(is)h(used)g(when)g(a)h
(\002le)g(is)544 2626 y(mapped)30 b(directly)h(into)f(a)h(process')g
(address)f(space)i(and)e(the)h(process)g(w)o(ants)f(to)h(ensure)g(that)
544 2775 y(the)25 b(changes)f(it)h(has)f(made)h(to)f(the)h(\002le')-5
b(s)25 b(memory)f(are)h(sa)n(v)o(ed)g(to)f(disk.)300
2992 y Fd(madvise)p Fo(:)47 b Fs(changes)28 b(the)g(current)g(usage)g
(pattern)g(of)g(the)f(memory)g(re)o(gion.)39 b(The)28
b(advice)g(is)g(a)g(hint)544 3141 y(from)i(a)h(process)f(to)h(the)f(VM)
g(system)f(as)i(what)f(access)h(pattern)g(will)e(be)i(used)f(to)g
(access)h(the)544 3290 y(memory)-6 b(.)58 b(Access)35
b(patterns)f(include:)49 b(normal)34 b(\(the)g(def)o(ault\),)j(random,)
f(sequential,)g(\223will)544 3440 y(need,)-7 b(\224)25
b(and)g(\223w)o(on')n(t)g(need.)-7 b(\224)300 3656 y
Fd(mlock)p Fo(:)48 b Fs(locks)25 b(data)h(into)f(physical)f(memory)-6
b(.)32 b(This)25 b(ensures)h(timely)e(access)j(to)e(memory)g(by)g
(forc-)544 3805 y(ing)f(the)h(data)g(to)f(stay)g(resident.)300
4021 y Fd(swapctl)p Fo(:)47 b Fs(con\002gures)27 b(the)e(sw)o(ap)h
(area.)36 b(The)26 b(system)f(manager)h(of)g(a)g(system)f(uses)h
Fm(swapctl)e Fs(to)544 4171 y(add)h(and)f(remo)o(v)o(e)g(sw)o(ap)h
(space)g(from)f(the)h(system.)583 4354 y(In)31 b(normal)e(operation)h
(the)g(majority)f(of)h(the)g(VM)g(system')-5 b(s)29 b(time)g(is)h
(spent)g(resolving)f(page)300 4504 y(f)o(aults)f(and)g(adding,)h(remo)o
(ving,)f(and)g(cop)o(ying)g(mappings)f(in)h(process')g(virtual)g
(address)g(space.)42 b(As)300 4653 y(the)32 b(system)f(runs)h(it)g(is)g
(lik)o(ely)g(that)g(more)g(and)g(more)g(of)h(the)f(pages)g(of)h
(physical)e(memory)g(will)h(be)300 4802 y(allocated)i(for)g(use)g(by)f
(the)h(operating)g(system.)57 b(When)34 b(the)f(number)h(of)g(free)h
(pages)f(drops)f(belo)n(w)300 4952 y(a)e(threshold,)g(then)g(the)f(VM)h
(system)e(causes)i(the)g(\223pagedaemon\224)f(to)h(run.)48
b(The)31 b(pagedaemon)f(is)h(a)300 5101 y(special)c(system)g(process)g
(that)g(looks)g(for)g(pages)h(of)g(memory)e(that)h(are)i(allocated)e(b)
n(ut)g(ha)n(v)o(en')n(t)g(been)300 5251 y(used)c(for)h(a)g(while)f(and)
h(adds)f(them)g(back)h(to)f(the)g(free)i(list.)k(If)24
b(a)g(page)g(contains)e(modi\002ed)h(data,)h(it)f(has)300
5400 y(to)h(be)h(\003ushed)g(out)f(before)i(it)e(can)h(be)g(freed.)32
b(The)24 b(pagedaemon)h(manages)f(this)g(\003ushing)g(process.)p
eop
%%Page: 17 37
17 36 bop 3800 100 a Fs(17)300 249 y Fg(2.3)143 b(The)35
b(Ev)o(olution)e(of)j(the)f(VM)h(System)e(In)h(BSD)300
502 y Fs(The)g(VM)f(system)g(has)h(changed)f(quite)h(a)g(bit)f
(throughout)f(the)i(e)n(v)n(olution)d(of)j(the)g(BSD)h(operating)300
651 y(system.)51 b(This)31 b(e)n(v)n(olution)e(is)j(sho)n(wn)e(in)i
(Figure)g(2.4.)51 b(Early)32 b(BSD)g(VM)g(started)f(with)g(a)h(V)-13
b(AX)32 b(VM)300 800 y(system)38 b([36)o(].)73 b(This)38
b(VM)g(system)g(w)o(as)g(tightly)f(bound)h(to)g(the)h(memory)f
(management)g(features)300 950 y(pro)o(vided)30 b(by)h(the)f(DEC)i(V)
-13 b(AX)30 b(processor)-5 b(.)49 b(Thus,)32 b(when)f(porting)f(BSD)i
(to)e(non-V)-13 b(AX)31 b(processors,)300 1099 y(it)37
b(w)o(as)g(important)f(to)h(mak)o(e)g(the)g(processor')-5
b(s)37 b(VM)f(hardw)o(are)i(emulate)f(the)g(V)-13 b(AX)37
b(as)g(closely)g(as)300 1249 y(possible.)46 b(F)o(or)30
b(e)o(xample,)h(SunOS)g(3.x)f(which)g(ran)h(on)f(Motorola)f(processors)
h(did)g(this.)46 b(Making)30 b(a)300 1398 y(non-V)-13
b(AX)23 b(system)g(emulate)h(a)h(V)-13 b(AX)23 b(is)h(quite)g
(cumbersome)f(and)h(inef)n(\002cient.)31 b(In)24 b(addition)f(to)h
(being)300 1547 y(non-portable,)h(the)g(BSD)i(V)-13 b(AX)25
b(VM)g(did)g(not)g(support)g(memory)g(mapped)g(\002les,)h(thus)f
(complicating)300 1697 y(the)g(implementation)f(of)h(shared)h
(libraries.)33 b(So,)26 b(Sun)f(thre)n(w)g(out)g(the)h(early)g(BSD)g(V)
-13 b(AX)25 b(VM)g(system)300 1846 y(and)39 b(designed)g(a)h(ne)n(w)f
(one)g(from)g(scratch.)75 b(This)39 b(VM)g(system)f(appeared)i(in)f
(SunOS)h(4)f(and)h(its)300 1996 y(descendant)27 b(is)g(currently)g
(used)g(in)f(Solaris)i([28)o(,)g(46)o(].)38 b(In)28 b(the)f(mean)g
(time)f(a)i(ne)n(w)f(operating)f(system)300 2145 y(project)34
b(called)g(Mach)h(w)o(as)f(started)g(at)h(Carne)o(gie-Mellon)e(Uni)n(v)
o(ersity)f(\(CMU\))j([72,)f(57,)g(71,)g(64].)300 2294
y(The)21 b(virtual)f(memory)g(system)g(of)h(Mach)g(had)g(a)g(clean)g
(separation)g(between)g(its)f(machine-dependent)300 2444
y(and)25 b(machine-independent)f(features.)32 b(This)25
b(separation)g(is)f(important)g(because)i(it)e(allo)n(ws)g(a)i(virtual)
300 2593 y(memory)e(system)g(to)h(easily)f(support)g(ne)n(w)h
(architectures.)31 b(The)25 b(Mach)g(2.5)g(VM)g(system)e(w)o(as)i
(ported)300 2742 y(to)h(BSD)h(thus)e(creating)i(the)f(BSD)h(VM)f
(system)f([39)o(,)i(69)o(].)36 b(This)25 b(VM)h(system)f(appeared)i(in)
f(4.3BSD)300 2892 y(Net2.)50 b(Ev)o(entually)29 b(the)i(CMU)h(Mach)f
(project)g(came)g(to)g(a)h(close)f(and)g(4.4BSD-Lite)g(w)o(as)h
(released)300 3041 y(in)i(source)g(code)h(form.)59 b(A)34
b(number)g(of)g(operating)g(system)f(projects)h(are)h(based)f(on)g(the)
h(4.4BSD-)300 3191 y(Lite)30 b(code,)i(and)f(thus)e(use)i(the)f(BSD)i
(VM)e(system.)46 b(As)31 b(time)e(has)i(gone)f(on)g(the)h(BSD)g(VM)f
(system)300 3340 y(has)35 b(di)n(v)o(er)n(ged)f(into)g(three)i
(branches:)51 b(the)35 b(BSDI)h(branch)f([33],)j(the)d(FreeBSD)i
(branch)e([25],)j(and)300 3489 y(the)29 b(NetBSD/OpenBSD)i(branch)f
([54,)f(55].)45 b(The)30 b(BSDI)g(branch)g(and)g(the)f(FreeBSD)j
(branch)d(ha)n(v)o(e)300 3639 y(stuck)22 b(with)f(the)h(basic)g(BSD)h
(VM)f(concepts)g(imported)f(from)h(Mach,)g(ho)n(we)n(v)o(er)f(the)o(y)h
(ha)n(v)o(e)f(w)o(ork)o(ed)h(to)300 3788 y(impro)o(v)o(e)h(the)h
(performance)h(of)f(the)h(BSD)g(VM)f(in)g(se)n(v)o(eral)g(areas.)31
b(The)24 b(NetBSD/OpenBSD)i(branch)300 3938 y(of)f(the)g(VM)f(system)g
(is)h(not)f(as)h(much)g(changed)g(from)f(the)h(original)f(4.4BSD)i(VM)e
(code)h(as)g(the)g(other)300 4087 y(branches.)583 4236
y(UVM')-5 b(s)22 b(roots)h(lie)f(partly)h(in)g(the)f(BSD)i(VM)f(system)
f(from)g(the)h(NetBSD/OpenBSD)h(and)f(the)300 4386 y(FreeBSD)i
(branches,)e(and)g(also)g(with)f(the)h(SunOS4)g(VM)f(system.)29
b(UVM')-5 b(s)22 b(basic)h(structure)g(is)f(based)300
4535 y(on)36 b(the)g(NetBSD/OpenBSD)h(branch)f(of)g(the)g(BSD)h(VM)e
(system.)63 b(UVM')-5 b(s)35 b(ne)n(w)h(i386)f(machine-)300
4685 y(dependent)22 b(layer)h(includes)f(se)n(v)o(eral)f(ideas)i(from)f
(the)h(FreeBSD)h(branch)f(of)f(BSD)i(VM.)e(UVM')-5 b(s)22
b(ne)n(w)300 4834 y(anon)o(ymous)g(memory)g(system)h(is)g(based)h(on)f
(the)h(anon)o(ymous)d(memory)i(system)g(found)g(in)g(SunOS4.)300
4983 y(UVM)h(has)g(recently)g(been)h(added)f(to)g(NetBSD)h(and)g(will)e
(e)n(v)o(entually)f(replace)j(the)g(BSD)g(VM.)f(There)300
5133 y(are)i(also)e(plans)g(to)h(add)f(UVM)h(to)f(OpenBSD)i(as)e(well.)
p eop
%%Page: 18 38
18 37 bop 3800 100 a Fs(18)545 4317 y @beginspecial 0
@llx 0 @lly 533 @urx 586 @ury 3731 @rwi @setspecial
%%BeginDocument: ../figures/eve.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-8.0 631.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 10552 m 0 0 l 9047 0 l 9047 10552 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
4500 8475 m
gs 1 -1 sc (NetBSD/OpenBSD) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
750 1200 m
gs 1 -1 sc (1985) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
750 7200 m
gs 1 -1 sc (1995) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
750 9900 m
gs 1 -1 sc (1998) dup sw pop neg 0 rm  col0 sh gr
% Polyline
7.500 slw
n 6000 1050 m 2400 1500 l gs col0 s gr 
% Polyline
n 2400 3675 m 2400 5700 l gs col0 s gr 
% Polyline
gs  clippath
2430 10353 m 2400 10473 l 2370 10353 l 2370 10515 l 2430 10515 l cp
clip
n 2400 6075 m 2400 10500 l gs col0 s gr gr

% arrowhead
n 2430 10353 m 2400 10473 l 2370 10353 l 2400 10353 l 2430 10353 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 6000 1050 m 6000 1575 l gs col0 s gr 
% Polyline
n 8400 1950 m 8400 2775 l gs col0 s gr 
% Polyline
n 8400 4950 m 8400 6675 l gs col0 s gr 
% Polyline
n 8100 6675 m 8700 6675 l gs col0 s gr 
% Polyline
n 8400 3150 m 8400 4575 l gs col0 s gr 
% Polyline
n 5996 4575 m 6004 4575 l gs col0 s gr
% Polyline
n 8400 3150 m 6000 4575 l gs col0 s gr 
% Polyline
n 6000 4950 m 6000 6375 l gs col0 s gr 
% Polyline
gs  clippath
4530 10353 m 4500 10473 l 4470 10353 l 4470 10515 l 4530 10515 l cp
clip
n 4500 8550 m 4500 10500 l gs col0 s gr gr

% arrowhead
n 4530 10353 m 4500 10473 l 4470 10353 l 4500 10353 l 4530 10353 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 6000 6750 m 4500 8175 l gs col0 s gr 
% Polyline
n 6000 6750 m 6900 8175 l gs col0 s gr 
% Polyline
n 6000 6750 m 8400 8175 l gs col0 s gr 
% Polyline
gs  clippath
6930 10353 m 6900 10473 l 6870 10353 l 6870 10515 l 6930 10515 l cp
clip
n 6900 8550 m 6900 10500 l gs col0 s gr gr

% arrowhead
n 6930 10353 m 6900 10473 l 6870 10353 l 6900 10353 l 6930 10353 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
8430 10353 m 8400 10473 l 8370 10353 l 8370 10515 l 8430 10515 l cp
clip
n 8400 8550 m 8400 10500 l gs col0 s gr gr

% arrowhead
n 8430 10353 m 8400 10473 l 8370 10353 l 8400 10353 l 8430 10353 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3630 10353 m 3600 10473 l 3570 10353 l 3570 10515 l 3630 10515 l cp
clip
n 3600 10050 m 3600 10500 l gs col0 s gr gr

% arrowhead
n 3630 10353 m 3600 10473 l 3570 10353 l 3600 10353 l 3630 10353 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4500 8550 m 3600 9600 l gs col0 s gr 
% Polyline
n 6900 8550 m 3600 9600 l gs col0 s gr 
% Polyline
n 900 900 m 900 10500 l gs col0 s gr 
% Polyline
n 825 1050 m 975 1050 l gs col0 s gr 
% Polyline
n 825 1050 m 975 1050 l gs col0 s gr 
% Polyline
n 825 4050 m 975 4050 l gs col0 s gr 
% Polyline
n 825 7050 m 975 7050 l gs col0 s gr 
% Polyline
n 825 9750 m 975 9750 l gs col0 s gr 
% Polyline
n 2250 3675 m 2250 3676 l 2248 3678 l 2246 3682 l 2243 3689 l 2239 3698 l
 2233 3710 l 2225 3727 l 2215 3746 l 2203 3770 l 2189 3798 l
 2174 3831 l 2156 3867 l 2136 3908 l 2115 3952 l 2091 4000 l
 2066 4052 l 2040 4107 l 2013 4164 l 1984 4224 l 1955 4286 l
 1925 4349 l 1895 4414 l 1865 4479 l 1834 4545 l 1804 4611 l
 1775 4677 l 1746 4742 l 1718 4806 l 1691 4869 l 1664 4931 l
 1639 4992 l 1615 5051 l 1593 5109 l 1571 5165 l 1551 5220 l
 1533 5273 l 1515 5325 l 1499 5375 l 1485 5424 l 1472 5472 l
 1460 5519 l 1449 5565 l 1440 5610 l 1432 5655 l 1425 5700 l
 1419 5747 l 1413 5794 l 1409 5841 l 1405 5888 l 1402 5936 l
 1400 5983 l 1398 6031 l 1396 6079 l 1395 6127 l 1395 6175 l
 1394 6223 l 1394 6272 l 1394 6320 l 1395 6369 l 1396 6417 l
 1397 6466 l 1398 6515 l 1399 6564 l 1401 6613 l 1403 6662 l
 1405 6711 l 1407 6761 l 1410 6810 l 1414 6859 l 1417 6908 l
 1422 6956 l 1426 7005 l 1432 7054 l 1438 7102 l 1444 7150 l
 1452 7198 l 1460 7246 l 1469 7294 l 1479 7341 l 1491 7389 l
 1503 7435 l 1516 7482 l 1531 7528 l 1547 7574 l 1565 7620 l
 1584 7666 l 1604 7711 l 1626 7756 l 1650 7800 l 1672 7839 l
 1696 7878 l 1722 7917 l 1750 7956 l 1779 7995 l 1811 8036 l
 1845 8076 l 1881 8118 l 1919 8160 l 1960 8203 l 2003 8248 l
 2048 8293 l 2095 8339 l 2145 8386 l 2197 8435 l 2251 8484 l
 2306 8534 l 2364 8585 l 2423 8637 l 2484 8690 l 2546 8743 l
 2608 8796 l 2672 8849 l 2735 8902 l 2799 8955 l 2862 9007 l
 2924 9058 l 2986 9108 l 3045 9157 l 3103 9204 l 3159 9249 l
 3212 9292 l 3262 9332 l 3310 9370 l 3353 9405 l 3393 9437 l
 3430 9466 l 3462 9491 l 3491 9514 l 3516 9534 l 3537 9551 l
 3555 9565 l 3569 9576 l 3580 9584 l 3588 9591 l 3594 9595 l
 3597 9598 l 3599 9599 l 3600 9600 l gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
2400 1800 m
gs 1 -1 sc (SunOS3) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2400 3600 m
gs 1 -1 sc (SunOS4) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2400 6000 m
gs 1 -1 sc (Solaris2) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 975 m
gs 1 -1 sc (early VAX BSD) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8400 1875 m
gs 1 -1 sc (Mach) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8400 3075 m
gs 1 -1 sc (Mach 2.5) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8400 4875 m
gs 1 -1 sc (Mach 3.0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 4875 m
gs 1 -1 sc (4.3BSD Net/2) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 6675 m
gs 1 -1 sc (4.4BSD family) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 1875 m
gs 1 -1 sc (4.3BSD) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8400 8475 m
gs 1 -1 sc (BSDI) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6900 8475 m
gs 1 -1 sc (FreeBSD) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3600 9900 m
gs 1 -1 sc (UVM) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
750 4200 m
gs 1 -1 sc (1990) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1447 4521 a(Figure)25 b(2.4:)30 b(BSD)c(VM)e(f)o(amily)g
(tree)p eop
%%Page: 19 39
19 38 bop 3800 100 a Fs(19)p 500 153 3200 4 v 498 273
4 121 v 550 237 a Fo(Machine-Dependent)28 b(Lay)o(er)p
2098 273 V 459 w(Machine-Independent)h(Lay)o(er)p 3698
273 V 500 276 3200 4 v 498 397 4 121 v 550 361 a Fs(processor)c
(speci\002c)p 2098 397 V 889 w(used)f(on)h(all)f(supported)g
(processors)p 3698 397 V 500 400 3200 4 v 498 882 4 482
v 550 484 a(maps)34 b(pages:)49 b(\223map)34 b(page)g
Fn(A)g Fs(to)g(virtual)550 605 y(address)25 b Fn(B)5
b Fs(\224)p 2098 882 V 2150 484 a(maps)70 b(chunks)g(of)g(memory)g
(objects:)2150 605 y(\223map)19 b(object)h Fn(X)27 b
Fs(at)20 b(of)n(fset)f Fn(Y)42 b Fs(into)18 b(the)i(vir)n(-)2150
725 y(tual)31 b(address)h(space)h(starting)e(at)h(address)2150
846 y Fn(Z)7 b Fs(\224)p 3698 882 V 500 885 3200 4 v
498 1005 4 121 v 550 969 a(programs)24 b(MMU)p 2098 1005
V 949 w(programs)g(pmap)g(layer)p 3698 1005 V 500 1009
3200 4 v 1463 1168 a(T)-8 b(able)25 b(2.2:)30 b(VM)24
b(MD/MI)g(layering)300 1563 y Fg(2.4)143 b(Design)34
b(Ov)o(er)o(view)f(of)i(the)g(BSD)g(VM)h(System)300 1816
y Fs(This)31 b(section)g(contains)g(a)h(design)f(o)o(v)o(ervie)n(w)f
(of)i(the)g(BSD)h(VM)e(system)g(that)g(w)o(as)h(imported)e(from)300
1965 y(the)h(Mach)f(operating)g(system)g(for)h(the)g(Net/2)f(release)h
(of)g(BSD.)h(Understanding)d(the)i(BSD)g(VM)g(is)300
2114 y(critical)f(to)g(understanding)e(the)i(design)g(of)g(UVM.)f(It)i
(is)e(also)h(useful)g(for)g(understanding)f(ne)n(w)h(VM)300
2264 y(features)25 b(introduced)f(in)h(UVM.)300 2595
y Ff(2.4.1)119 b(Lay)o(ering)29 b(in)i(the)f(BSD)h(VM)f(System)300
2812 y Fs(The)21 b(BSD)i(VM)d(system)h(is)g(di)n(vided)e(into)i(tw)o(o)
g(layers:)28 b(a)22 b(lar)n(ge)g(machine-independent)e(\(\223MI\224\))i
(layer)l(,)300 2961 y(and)27 b(a)g(smaller)f(machine-dependent)g
(\(\223MD\224\))h(layer)-5 b(.)36 b(The)26 b(machine-independent)g
(code)h(is)f(shared)300 3110 y(by)i(all)g(BSD-supported)g(processors)f
(and)i(contains)e(the)h(code)g(that)g(performs)g(the)g(high)f(le)n(v)o
(el)g(func-)300 3260 y(tions)h(of)i(the)f(VM)g(system.)44
b(The)29 b(machine-dependent)g(code)g(is)g(called)h(the)f(\223pmap\224)
h(\(for)f(physical)300 3409 y(map\))37 b(layer)l(,)j(and)d(it)f
(handles)g(the)h(lo)n(wer)f(le)n(v)o(el)g(details)g(of)h(programming)f
(a)h(processor')-5 b(s)36 b(MMU.)300 3559 y(Each)k(architecture)g
(supported)e(by)i(the)f(operating)g(system)g(must)f(ha)n(v)o(e)i(its)e
(o)n(wn)h(pmap)g(module.)300 3708 y(Each)33 b(layer)h(of)f(the)g(VM)g
(system)f(does)h(its)f(o)n(wn)g(le)n(v)o(el)g(of)i(mapping.)54
b(The)33 b(machine-independent)300 3857 y(layer)d(maps)e(\223memory)h
(objects\224)g(into)f(the)h(virtual)g(address)g(space)g(of)h(a)f
(process)g(or)h(the)f(k)o(ernel.)44 b(A)300 4007 y(memory)28
b(object)h(is)f(an)o(y)h(k)o(ernel)g(data)g(structure)g(that)g
(represents)g(data)g(that)f(can)i(be)f(mapped)g(into)f(a)300
4156 y(virtual)22 b(address)h(space.)30 b(F)o(or)23 b(e)o(xample,)f(a)i
(\002le)f(can)g(be)g(a)g(memory)f(object.)30 b(The)23
b(machine-dependent)300 4306 y(layer)33 b(does)f(not)g(kno)n(w)f(about)
h(higher)g(le)n(v)o(el)g(concepts)g(such)g(as)h(memory)e(objects;)36
b(it)c(only)f(kno)n(ws)300 4455 y(ho)n(w)26 b(to)g(map)g(physical)g
(pages)g(of)h(memory)f(into)g(a)h(virtual)f(address)g(space.)37
b(T)-8 b(able)27 b(2.2)f(summarizes)300 4604 y(the)f(dif)n(ference)g
(between)g(the)f(machine-independent)g(and)h(machine-dependent)f
(layers.)300 4936 y Ff(2.4.2)119 b(The)30 b(Machine-Dependent)j(Lay)o
(er)300 5152 y Fs(The)h(pmap)f(layer')-5 b(s)34 b(job)f(is)g(to)h(be)g
(the)g(machine-independent)e(code')-5 b(s)34 b(interf)o(ace)g(to)g(a)g
(processor')-5 b(s)300 5302 y(MMU.)22 b(At)h(an)g(abstract)g(le)n(v)o
(el,)f(the)g(pmap)h(layer)g(can)g(be)g(vie)n(wed)f(as)h(a)h(big)e
(array)i(of)f(mapping)e(entries)p eop
%%Page: 20 40
20 39 bop 3800 100 a Fs(20)300 249 y(that)36 b(are)i(inde)o(x)o(ed)d
(by)i(virtual)f(address)g(to)h(produce)g(a)g(physical)e(address)i(and)g
(attrib)n(utes.)65 b(These)300 398 y(attrib)n(utes)28
b(describe)i(the)f(page')-5 b(s)30 b(current)f(protection,)h(whether)g
(the)f(page)h(has)f(been)h(referenced)h(or)300 548 y(modi\002ed,)f(and)
g(other)f(characteristics.)45 b(Since)30 b(each)h(process)e(has)h(its)f
(o)n(wn)f(virtual)h(address)h(space,)300 697 y(each)d(process)f(must)f
(ha)n(v)o(e)h(its)g(o)n(wn)f(pmap)h(data)h(structure)f(to)f(describe)i
(the)f(lo)n(w-le)n(v)o(el)e(mappings)h(of)300 847 y(that)32
b(virtual)g(address)h(space.)55 b(Mapping)31 b(entries)i(contained)f
(in)g(the)h(pmap)f(layer)h(are)h(often)e(called)300 996
y(\223page)e(table)e(entries\224)i(\(PTEs\))f(due)g(to)g(the)g(w)o(ay)g
(man)o(y)f(MMUs)g(w)o(ork.)44 b(The)29 b(actual)g(w)o(ay)g(the)g(array)
300 1145 y(of)35 b(PTEs)g(is)f(stored)g(v)n(aries)h(from)f(system)g(to)
g(system)g(depending)g(on)g(the)h(MMU)f(hardw)o(are.)61
b(F)o(or)300 1295 y(e)o(xample,)33 b(on)e(an)h(i386)g(PC)h(the)e(array)
i(is)e(brok)o(en)h(up)g(into)f(tw)o(o)g(le)n(v)o(els.)51
b(One)32 b(le)n(v)o(el)f(contains)g(1024)300 1444 y(\002x)o(ed-sized)37
b(chunks)f(of)h(PTEs)g(called)f(\223page)i(tables,)-7
b(\224)39 b(the)e(other)g(le)n(v)o(el)e(contains)h(a)h(directory)g(of)
300 1594 y(page)26 b(tables)f(called)h(the)f(\223page)h(directory)-6
b(.)f(\224)33 b(Other)26 b(processors)f(ha)n(v)o(e)h(a)g(similar)e
(structure,)i(b)n(ut)f(with)300 1743 y(three)g(le)n(v)o(els)f(of)h
(tables)g(rather)g(than)g(tw)o(o.)31 b(Re)o(gardless)24
b(of)h(ho)n(w)f(the)h(page)g(mappings)f(are)i(stored,)e(the)300
1892 y(interf)o(ace)h(pro)o(vided)f(by)h(the)f(pmap)g(layer)i(to)e(the)
h(machine-independent)e(code)i(is)g(consistent)e(across)300
2042 y(all)i(platforms.)583 2191 y(The)k(most)e(common)g(pmap)h
(operations)f(and)i(e)o(xamples)e(of)h(their)g(usage)h(are)g(described)
f(be-)300 2341 y(lo)n(w:)300 2525 y Fd(pmap)p 546 2525
30 4 v 35 w(enter)p Fo(:)48 b Fs(adds)36 b(a)h(virtual-to-physical)d
(address)i(mapping)g(to)g(the)g(speci\002ed)h(pmap)f(at)g(the)544
2674 y(speci\002ed)i(protection.)68 b(The)37 b Fm(pmap)p
1872 2674 V 35 w(enter)g Fs(function)f(is)h(called)h(by)f(the)g(f)o
(ault)h(routine)e(to)544 2824 y(establish)23 b(a)j(mapping)d(for)i(the)
g(page)g(being)f(f)o(aulted)h(in.)300 3040 y Fd(pmap)p
546 3040 V 35 w(remove)p Fo(:)48 b Fs(remo)o(v)o(es)31
b(a)i(range)g(of)g(virtual-to-physical)d(address)j(mappings)e(from)i(a)
g(pmap.)544 3190 y(The)h Fm(pmap)p 979 3190 V 35 w(remove)f
Fs(function)g(is)h(called)g(during)f(an)h(unmap)g(operation)f(to)h
(remo)o(v)o(e)f(lo)n(w-)544 3339 y(le)n(v)o(el)23 b(machine-dependent)i
(mappings.)300 3556 y Fd(pmap)p 546 3556 V 35 w(protect)p
Fo(:)47 b Fs(changes)28 b(the)g(protection)f(of)h(all)g(mappings)f(in)g
(a)i(speci\002ed)f(range)g(of)g(a)h(pmap.)544 3705 y(The)34
b Fm(pmap)p 979 3705 V 35 w(protect)f Fs(function)h(is)g(called)g
(during)g(a)h(cop)o(y-on-write)e(operation)h(to)g(write)544
3854 y(protect)24 b(cop)o(y-on-write)h(memory)-6 b(.)300
4071 y Fd(pmap)p 546 4071 V 35 w(page)p 821 4071 V 35
w(protect)p Fo(:)47 b Fs(changes)35 b(the)f(protection)f(of)h(all)g
(mappings)f(of)h(a)h(single)e(page)h(in)g(e)n(v-)544
4220 y(ery)27 b(pmap)g(that)g(references)h(it.)37 b(The)27
b Fm(pmap)p 2106 4220 V 35 w(page)p 2381 4220 V 35 w(protect)f
Fs(function)g(is)h(called)g(before)h(a)544 4370 y(pageout)c(operation)g
(to)h(ensure)g(that)f(all)h(pmap)f(references)i(to)e(a)i(page)f(are)g
(remo)o(v)o(ed.)300 4586 y Fd(pmap)p 546 4586 V 35 w(is)p
701 4586 V 35 w(referenced)p Fo(,)e Fd(pmap)p 1624 4586
V 35 w(is)p 1779 4586 V 35 w(modified)p Fo(:)48 b Fs(tests)40
b(the)i(referenced)h(and)f(modi\002ed)f(at-)544 4735
y(trib)n(utes)27 b(for)i(a)g(page.)42 b(This)28 b(is)g(calculated)h(o)o
(v)o(er)e(all)i(mappings)e(of)i(a)f(page.)43 b(These)28
b(functions)544 4885 y(are)d(called)g(by)g(the)f(pagedaemon)h(when)g
(looking)e(for)i(pages)g(to)f(free.)300 5101 y Fd(pmap)p
546 5101 V 35 w(clear)p 881 5101 V 35 w(reference)p Fo(,)f
Fd(pmap)p 1744 5101 V 34 w(clear)p 2078 5101 V 35 w(modify)p
Fo(:)48 b Fs(clears)19 b(the)g(reference)h(and)f(modify)f(at-)544
5251 y(trib)n(utes)24 b(on)h(all)g(mappings)f(of)h(a)h(page.)32
b(These)25 b(functions)f(are)i(called)g(by)f(the)g(pagedaemon)f(to)544
5400 y(help)g(it)h(identify)e(pages)i(that)g(are)g(no)g(longer)f(in)h
(demand.)p eop
%%Page: 21 41
21 40 bop 3800 100 a Fs(21)300 249 y Fd(pmap)p 546 249
30 4 v 35 w(copy)p Fo(:)48 b Fs(copies)32 b(mappings)e(from)i(one)f
(pmap)h(to)f(another)-5 b(.)52 b(The)31 b Fm(pmap)p 3169
249 V 35 w(copy)h Fs(function)f(is)544 398 y(called)g(during)g(a)h
Fm(fork)f Fs(operation)g(to)g(gi)n(v)o(e)f(the)i(child)f(process)g(an)h
(initial)e(set)i(of)f(lo)n(w-le)n(v)o(el)544 548 y(mappings.)300
780 y(Note)26 b(that)g(pmap)g(operations)f(such)h(as)h
Fm(pmap)p 1950 780 V 35 w(page)p 2225 780 V 35 w(protect)e
Fs(may)h(require)g(the)g(pmap)g(module)300 930 y(to)e(k)o(eep)h(a)h
(list)d(of)i(all)g(pmaps)f(that)g(reference)j(a)e(page.)300
1261 y Ff(2.4.3)119 b(The)30 b(Machine-Independent)j(Lay)o(er)300
1477 y Fs(The)26 b(high-le)n(v)o(el)f(functions)g(of)h(the)h(VM)e
(system)h(are)h(handled)f(by)g(the)g(machine-independent)f(layer)300
1627 y(of)33 b(the)g(BSD)h(VM)f(system.)54 b(Such)34
b(functions)e(include)g(managing)h(a)g(process')g(\002le)h(mappings,)f
(re-)300 1776 y(questing)28 b(data)h(from)g(backing)f(store,)i(paging)e
(out)h(memory)f(when)h(it)f(becomes)h(scarce,)i(managing)300
1926 y(the)24 b(allocation)f(of)i(physical)e(memory)-6
b(,)23 b(and)h(managing)f(cop)o(y-on-write)h(memory)-6
b(.)29 b(The)24 b(acti)n(vities)f(of)300 2075 y(the)i
(machine-independent)e(layer)i(are)h(centered)f(around)g(\002)n(v)o(e)f
(main)g(data)h(structures:)300 2307 y Fd(vmspace)p Fo(:)47
b Fs(describes)31 b(a)g(virtual)e(address)i(space)g(of)f(a)h(process.)
48 b(The)31 b Fm(vmspace)e Fs(structure)h(con-)544 2457
y(tains)24 b(pointers)g(a)h(process')g Fm(vm)p 1655 2457
V 36 w(map)f Fs(and)h Fm(pmap)f Fs(structures,)g(and)h(contains)f
(statistics)g(on)g(the)544 2606 y(process')h(memory)f(usage.)300
2839 y Fd(vm)p 426 2839 V 35 w(map)p Fo(:)49 b Fs(describes)23
b(the)h(virtual)f(address)h(space)g(of)g(a)g(process)f(or)h(the)g(k)o
(ernel.)30 b(It)24 b(contains)f(a)h(list)f(of)544 2988
y(v)n(alid)h(mappings)f(in)h(the)h(virtual)f(address)h(space)g(and)g
(those)f(mapping')-5 b(s)23 b(attrib)n(utes.)300 3220
y Fd(vm)p 426 3220 V 35 w(object)p Fo(:)48 b Fs(describes)22
b(a)h(\002le,)g(a)g(zero-\002ll)g(memory)f(area,)i(or)e(a)h(de)n(vice)f
(that)g(can)h(be)g(mapped)f(into)544 3370 y(a)k(virtual)g(address)g
(space.)36 b(The)26 b Fm(vm)p 1815 3370 V 35 w(object)f
Fs(contains)h(a)g(list)g(of)g Fm(vm)p 3042 3370 V 35
w(page)g Fs(structures)g(that)544 3519 y(contain)e(data)h(from)g(that)f
(object.)300 3752 y Fd(vm)p 426 3752 V 35 w(pager)p Fo(:)48
b Fs(describes)27 b(ho)n(w)g(backing)g(store)g(can)h(be)g(accessed.)39
b(Each)27 b Fm(vm)p 3047 3752 V 36 w(object)f Fs(on)h(the)h(sys-)544
3901 y(tem)k(has)h(a)g Fm(vm)p 1095 3901 V 35 w(pager)f
Fs(structure.)54 b(This)32 b(structure)g(contains)g(a)h(pointer)f(to)g
(a)h(list)f(of)h(func-)544 4050 y(tions)26 b(used)h(by)g(the)h(object)e
(to)h(fetch)h(and)f(store)h(pages)f(between)g(the)h(memory)e(pointed)g
(to)h(by)544 4200 y Fm(vm)p 670 4200 V 35 w(page)d Fs(structures)h(and)
f(backing)h(store.)300 4432 y Fd(vm)p 426 4432 V 35 w(page)p
Fo(:)48 b Fs(describes)25 b(a)f(page)h(of)f(physical)f(memory)2249
4396 y Fj(4)2285 4432 y Fs(.)31 b(When)24 b(the)g(system)f(is)h(booted)
g(a)g Fm(vm)p 3631 4432 V 36 w(page)544 4582 y Fs(structure)i(is)g
(allocated)h(for)g(each)g(page)g(of)g(physical)e(memory)h(that)g(can)h
(be)g(used)g(by)f(the)h(VM)544 4731 y(system.)p 300 4821
1440 4 v 416 4882 a Fi(4)449 4912 y Fh(On)19 b(a)g(fe)n(w)g(systems,)g
(that)g(ha)n(v)o(e)f(small)h(hardw)o(are)e(page)h(sizes,)i(such)e(as)i
(the)e(V)-11 b(AX,)19 b(the)g(VM)f(system)h(has)g(a)g(VM)g(page)300
5012 y(structure)j(manage)f(tw)o(o)i(or)f(more)g(hardw)o(are)f(pages.)
32 b(This)23 b(is)g(all)g(handled)e(at)j(the)e(pmap)g(layer)g(and)g
(thus)h(is)g(transparent)300 5111 y(to)d(the)h(machine-independent)15
b(VM)21 b(code.)p eop
%%Page: 22 42
22 41 bop 3800 100 a Fs(22)300 3063 y @beginspecial 0
@llx 0 @lly 455 @urx 367 @ury 4322 @rwi @setspecial
%%BeginDocument: ../figures/mi.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-33.0 448.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7495 m 0 0 l 8170 0 l 8170 7495 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 180.00 scf sf
6075 4800 m
gs 1 -1 sc (stack) col0 sh gr
/Helvetica ff 180.00 scf sf
6300 3600 m
gs 1 -1 sc (\(points to process 4's) col0 sh gr
7.500 slw
% Ellipse
n 3000 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 3225 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 3450 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
n 2775 5700 m 3675 5700 l 3225 4950 l cp gs col0 s gr 
% Polyline
n 2925 6975 m 3525 6975 l 3525 7200 l 2925 7200 l cp gs col0 s gr 
% Polyline
gs  clippath
3240 6888 m 3225 6948 l 3210 6888 l 3210 6990 l 3240 6990 l cp
clip
n 3225 6000 m 3225 6975 l gs col0 s gr gr

% arrowhead
n 3240 6888 m 3225 6948 l 3210 6888 l 3225 6888 l 3240 6888 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4350 6975 m 4950 6975 l 4950 7200 l 4350 7200 l cp gs col0 s gr 
% Polyline
gs  clippath
4665 6888 m 4650 6948 l 4635 6888 l 4635 6990 l 4665 6990 l cp
clip
n 4650 6000 m 4650 6975 l gs col0 s gr gr

% arrowhead
n 4665 6888 m 4650 6948 l 4635 6888 l 4650 6888 l 4665 6888 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 5775 6975 m 6375 6975 l 6375 7200 l 5775 7200 l cp gs col0 s gr 
% Polyline
gs  clippath
6090 6888 m 6075 6948 l 6060 6888 l 6060 6990 l 6090 6990 l cp
clip
n 6075 6000 m 6075 6975 l gs col0 s gr gr

% arrowhead
n 6090 6888 m 6075 6948 l 6060 6888 l 6075 6888 l 6090 6888 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 7200 6975 m 7800 6975 l 7800 7200 l 7200 7200 l cp gs col0 s gr 
% Polyline
gs  clippath
7515 6888 m 7500 6948 l 7485 6888 l 7485 6990 l 7515 6990 l cp
clip
n 7500 6000 m 7500 6975 l gs col0 s gr gr

% arrowhead
n 7515 6888 m 7500 6948 l 7485 6888 l 7500 6888 l 7515 6888 l  cp gs 0.00 setgray ef gr  col0 s
% Ellipse
n 4650 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 5850 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6300 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 7275 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 7725 5550 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
n 3146 2550 m 3154 2550 l gs col0 s gr
% Polyline
gs  clippath
3143 2462 m 3143 2523 l 3114 2469 l 3139 2568 l 3168 2561 l cp
clip
n 3000 1950 m 3150 2550 l gs col0 s gr gr

% arrowhead
n 3143 2462 m 3143 2523 l 3114 2469 l 3129 2466 l 3143 2462 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3900 2100 m 4350 2100 l 4350 2325 l 3900 2325 l cp gs col0 s gr 
% Polyline
n 2775 1725 m 3525 1725 l 3525 1950 l 2775 1950 l cp gs col0 s gr 
% Polyline
n 6071 2550 m 6079 2550 l gs col0 s gr
% Polyline
n 6825 2100 m 7275 2100 l 7275 2325 l 6825 2325 l cp gs col0 s gr 
% Polyline
n 5700 1725 m 6450 1725 l 6450 1950 l 5700 1950 l cp gs col0 s gr 
% Polyline
gs  clippath
6746 2138 m 6796 2173 l 6735 2166 l 6831 2202 l 6841 2174 l cp
clip
n 6222 1958 m 6822 2183 l gs col0 s gr gr

% arrowhead
n 6746 2138 m 6796 2173 l 6735 2166 l 6741 2152 l 6746 2138 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3821 2138 m 3871 2173 l 3810 2166 l 3906 2202 l 3916 2174 l cp
clip
n 3297 1958 m 3897 2183 l gs col0 s gr gr

% arrowhead
n 3821 2138 m 3871 2173 l 3810 2166 l 3816 2152 l 3821 2138 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6068 2462 m 6068 2523 l 6039 2469 l 6064 2568 l 6093 2561 l cp
clip
n 5925 1950 m 6075 2550 l gs col0 s gr gr

% arrowhead
n 6068 2462 m 6068 2523 l 6039 2469 l 6054 2466 l 6068 2462 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 2850 2550 m 3450 2550 l 3450 2775 l 2850 2775 l cp gs col0 s gr 
% Polyline
gs  clippath
3768 3068 m 3798 3075 l 3768 3083 l 3840 3083 l 3840 3068 l cp
3657 3083 m 3627 3075 l 3657 3068 l 3585 3068 l 3585 3083 l cp
clip
n 3600 3075 m 3825 3075 l gs col0 s gr gr

% arrowhead
n 3657 3083 m 3627 3075 l 3657 3068 l 3657 3075 l 3657 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 3768 3068 m 3798 3075 l 3768 3083 l 3768 3075 l 3768 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3300 3000 m 3600 3000 l 3600 3150 l 3300 3150 l cp gs col0 s gr 
% Polyline
n 3825 3000 m 4125 3000 l 4125 3150 l 3825 3150 l cp gs col0 s gr 
% Polyline
n 4350 3000 m 4650 3000 l 4650 3150 l 4350 3150 l cp gs col0 s gr 
% Polyline
n 4875 3000 m 5175 3000 l 5175 3150 l 4875 3150 l cp gs col0 s gr 
% Polyline
n 5775 2550 m 6375 2550 l 6375 2775 l 5775 2775 l cp gs col0 s gr 
% Polyline
n 6225 3000 m 6525 3000 l 6525 3150 l 6225 3150 l cp gs col0 s gr 
% Polyline
n 6750 3000 m 7050 3000 l 7050 3150 l 6750 3150 l cp gs col0 s gr 
% Polyline
n 7275 3000 m 7575 3000 l 7575 3150 l 7275 3150 l cp gs col0 s gr 
% Polyline
n 7800 3000 m 8100 3000 l 8100 3150 l 7800 3150 l cp gs col0 s gr 
% Polyline
gs  clippath
3243 3068 m 3273 3075 l 3243 3083 l 3315 3083 l 3315 3068 l cp
3143 2832 m 3150 2802 l 3158 2832 l 3158 2760 l 3143 2760 l cp
clip
n 3150 2775 m 3150 3075 l 3300 3075 l gs col0 s gr gr

% arrowhead
n 3143 2832 m 3150 2802 l 3158 2832 l 3150 2832 l 3143 2832 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 3243 3068 m 3273 3075 l 3243 3083 l 3243 3075 l 3243 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4293 3068 m 4323 3075 l 4293 3083 l 4365 3083 l 4365 3068 l cp
4182 3083 m 4152 3075 l 4182 3068 l 4110 3068 l 4110 3083 l cp
clip
n 4125 3075 m 4350 3075 l gs col0 s gr gr

% arrowhead
n 4182 3083 m 4152 3075 l 4182 3068 l 4182 3075 l 4182 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 4293 3068 m 4323 3075 l 4293 3083 l 4293 3075 l 4293 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4818 3068 m 4848 3075 l 4818 3083 l 4890 3083 l 4890 3068 l cp
4707 3083 m 4677 3075 l 4707 3068 l 4635 3068 l 4635 3083 l cp
clip
n 4650 3075 m 4875 3075 l gs col0 s gr gr

% arrowhead
n 4707 3083 m 4677 3075 l 4707 3068 l 4707 3075 l 4707 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 4818 3068 m 4848 3075 l 4818 3083 l 4818 3075 l 4818 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6693 3068 m 6723 3075 l 6693 3083 l 6765 3083 l 6765 3068 l cp
6582 3083 m 6552 3075 l 6582 3068 l 6510 3068 l 6510 3083 l cp
clip
n 6525 3075 m 6750 3075 l gs col0 s gr gr

% arrowhead
n 6582 3083 m 6552 3075 l 6582 3068 l 6582 3075 l 6582 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 6693 3068 m 6723 3075 l 6693 3083 l 6693 3075 l 6693 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6168 3068 m 6198 3075 l 6168 3083 l 6240 3083 l 6240 3068 l cp
6068 2832 m 6075 2802 l 6083 2832 l 6083 2760 l 6068 2760 l cp
clip
n 6075 2775 m 6075 3075 l 6225 3075 l gs col0 s gr gr

% arrowhead
n 6068 2832 m 6075 2802 l 6083 2832 l 6075 2832 l 6068 2832 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 6168 3068 m 6198 3075 l 6168 3083 l 6168 3075 l 6168 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7218 3068 m 7248 3075 l 7218 3083 l 7290 3083 l 7290 3068 l cp
7107 3083 m 7077 3075 l 7107 3068 l 7035 3068 l 7035 3083 l cp
clip
n 7050 3075 m 7275 3075 l gs col0 s gr gr

% arrowhead
n 7107 3083 m 7077 3075 l 7107 3068 l 7107 3075 l 7107 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 7218 3068 m 7248 3075 l 7218 3083 l 7218 3075 l 7218 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7743 3068 m 7773 3075 l 7743 3083 l 7815 3083 l 7815 3068 l cp
7632 3083 m 7602 3075 l 7632 3068 l 7560 3068 l 7560 3083 l cp
clip
n 7575 3075 m 7800 3075 l gs col0 s gr gr

% arrowhead
n 7632 3083 m 7602 3075 l 7632 3068 l 7632 3075 l 7632 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 7743 3068 m 7773 3075 l 7743 3083 l 7743 3075 l 7743 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6390 3288 m 6375 3348 l 6360 3288 l 6360 3390 l 6390 3390 l cp
clip
n 6375 3150 m 6375 3375 l gs col0 s gr gr

% arrowhead
n 6390 3288 m 6375 3348 l 6360 3288 l 6375 3288 l 6390 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6915 3288 m 6900 3348 l 6885 3288 l 6885 3390 l 6915 3390 l cp
clip
n 6900 3150 m 6900 3375 l gs col0 s gr gr

% arrowhead
n 6915 3288 m 6900 3348 l 6885 3288 l 6900 3288 l 6915 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7965 3288 m 7950 3348 l 7935 3288 l 7935 3390 l 7965 3390 l cp
clip
n 7950 3150 m 7950 3375 l gs col0 s gr gr

% arrowhead
n 7965 3288 m 7950 3348 l 7935 3288 l 7950 3288 l 7965 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7440 3288 m 7425 3348 l 7410 3288 l 7410 3390 l 7440 3390 l cp
clip
n 7425 3150 m 7425 3375 l gs col0 s gr gr

% arrowhead
n 7440 3288 m 7425 3348 l 7410 3288 l 7425 3288 l 7440 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3251 4866 m 3228 4923 l 3222 4862 l 3208 4963 l 3238 4967 l cp
clip
n 3468 3146 m 3225 4950 l gs col0 s gr gr

% arrowhead
n 3251 4866 m 3228 4923 l 3222 4862 l 3237 4864 l 3251 4866 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6044 4867 m 6061 4926 l 6018 4882 l 6070 4971 l 6096 4955 l cp
clip
n 5025 3150 m 6075 4950 l gs col0 s gr gr

% arrowhead
n 6044 4867 m 6061 4926 l 6018 4882 l 6031 4875 l 6044 4867 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3415 5096 m 3382 5149 l 3386 5087 l 3356 5185 l 3385 5194 l cp
clip
n 3993 3146 m 3375 5175 l gs col0 s gr gr

% arrowhead
n 3415 5096 m 3382 5149 l 3386 5087 l 3400 5092 l 3415 5096 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4200 5700 m 5100 5700 l 4650 4950 l cp gs col0 s gr 
% Polyline
n 5625 5700 m 6525 5700 l 6075 4950 l cp gs col0 s gr 
% Polyline
gs  clippath
4658 4862 m 4647 4923 l 4628 4865 l 4636 4966 l 4666 4964 l cp
clip
n 4500 3150 m 4650 4950 l gs col0 s gr gr

% arrowhead
n 4658 4862 m 4647 4923 l 4628 4865 l 4643 4863 l 4658 4862 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 7050 5700 m 7950 5700 l 7500 4950 l cp gs col0 s gr 
/Helvetica-Bold ff 180.00 scf sf
2400 2700 m
gs 1 -1 sc (vm_map) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
3150 1500 m
gs 1 -1 sc (process 1 \(init\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
6075 1500 m
gs 1 -1 sc (process 4 \(sh\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 1875 m
gs 1 -1 sc (vmspace) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 2250 m
gs 1 -1 sc (pmap) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
3225 5925 m
gs 1 -1 sc (/sbin/init) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
7500 5925 m
gs 1 -1 sc (/bin/sh) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
4650 5925 m
gs 1 -1 sc (zero-fill) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
6075 5925 m
gs 1 -1 sc (zero-fill) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 5325 m
gs 1 -1 sc (vm_object) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 5550 m
gs 1 -1 sc (vm_page \(in object\)) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 7125 m
gs 1 -1 sc (vm_pager) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
7500 7425 m
gs 1 -1 sc (vnode) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
3225 7425 m
gs 1 -1 sc (vnode) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
6075 7425 m
gs 1 -1 sc (swap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
4650 7425 m
gs 1 -1 sc (swap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
3150 4800 m
gs 1 -1 sc (text) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 3150 m
gs 1 -1 sc (map entry) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
3600 4800 m
gs 1 -1 sc (data) col0 sh gr
/Helvetica ff 180.00 scf sf
4725 4800 m
gs 1 -1 sc (bss) col0 sh gr
/Helvetica ff 180.00 scf sf
6300 3825 m
gs 1 -1 sc (  memory objects\)) col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 204 x(Figure)44 b(2.5:)67 b(The)44 b(\002)n(v)o(e)f(main)g
(machine-independent)f(data)h(structures:)68 b Fm(vmspace)p
Fs(,)46 b Fm(vm)p 3666 3267 30 4 v 36 w(map)p Fs(,)300
3387 y Fm(vm)p 426 3387 V 35 w(page)p Fs(,)28 b Fm(vm)p
874 3387 V 36 w(object)p Fs(,)f Fm(vm)p 1442 3387 V 36
w(pager)p Fs(.)39 b(The)29 b(triangles)e(represent)h
Fm(vm)p 2910 3387 V 36 w(objects)p Fs(,)f(and)h(the)g(dots)300
3507 y(within)23 b(them)h(represent)h Fm(vm)p 1319 3507
V 36 w(pages)p Fs(.)k(A)c Fm(vm)p 1926 3507 V 35 w(object)f
Fs(can)h(contain)f(an)o(y)g(number)g(of)h(pages.)30 b(Note)300
3628 y(that)24 b(the)h(te)o(xt)f(and)h(data)f(areas)i(of)f(a)g(\002le)g
(are)h(dif)n(ferent)e(parts)h(of)g(a)g(single)f(object.)300
4023 y(As)29 b(sho)n(wn)f(in)h(Figure)g(2.5,)h(VM)f(map)g(structures)g
(map)g(VM)g(objects)f(into)h(an)g(address)g(space.)45
b(VM)300 4172 y(objects)33 b(store)h(their)g(data)g(in)g(VM)f(pages.)58
b(Data)35 b(in)e(VM)h(pages)g(is)f(copied)h(to)g(and)g(from)g(backing)
300 4322 y(store)25 b(by)h(VM)f(pagers.)34 b(Note)25
b(that)g(each)h Fm(vm)p 1878 4322 V 36 w(map)f Fs(structure)g(has)h(an)
g(associated)f(pmap)g(structure)g(to)300 4471 y(contain)30
b(the)g(lo)n(wer)g(le)n(v)o(el)f(mapping)g(information)g(for)i(the)f
(virtual)g(address)g(space)h(mapped)f(by)g(the)300 4620
y Fm(vm)p 426 4620 V 35 w(map)p Fs(.)g(The)25 b Fm(vm)p
996 4620 V 35 w(map)f Fs(and)h(the)f(pmap)g(together)h(are)g(referred)h
(to)e(by)g(a)h Fm(vmspace)e Fs(structure)i(\(not)300
4770 y(sho)n(wn\).)583 4919 y(In)30 b(order)h(to)e(\002nd)h(which)g
Fm(vm)p 1629 4919 V 35 w(page)f Fs(should)g(be)h(mapped)f(in)h(at)g(a)g
(virtual)f(address)h(\(for)g(e)o(x-)300 5069 y(ample,)f(during)g(a)g
(page)g(f)o(ault\),)h(the)e(VM)h(system)f(must)f(look)h(in)h(the)g
Fm(vm)p 2906 5069 V 35 w(map)f Fs(for)i(the)e(mapping)g(of)300
5218 y(the)23 b(virtual)f(address.)30 b(It)24 b(then)f(must)f(check)h
(the)g(backing)g Fm(vm)p 2444 5218 V 35 w(object)f Fs(for)i(the)f
(needed)g(page.)31 b(If)23 b(the)300 5367 y(page)29 b(is)f(resident)g
(\(often)g(due)h(to)f(ha)n(ving)f(been)i(recently)g(accessed)g(by)f
(some)g(other)g(process\),)h(then)p eop
%%Page: 23 43
23 42 bop 3800 100 a Fs(23)624 1065 y @beginspecial 0
@llx 0 @lly 506 @urx 157 @ury 3542 @rwi @setspecial
%%BeginDocument: ../figures/vm_map.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-26.0 209.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3523 m 0 0 l 8902 0 l 8902 3523 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
6750 1875 m
gs 1 -1 sc (vm_map_entry) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1500 m
gs 1 -1 sc (pointer to pmap) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1875 m
gs 1 -1 sc (pointer to map entries) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 2250 m
gs 1 -1 sc (size) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 2625 m
gs 1 -1 sc (reference count) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 3375 m
gs 1 -1 sc (ending virtual address) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 5400 1425 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6441 1388 m 6575 1425 l 6441 1463 l 6615 1463 l 6615 1388 l cp
clip
n 5400 1425 m 6600 1425 l gs col-1 s gr gr

% arrowhead
n 6441 1388 m 6575 1425 l 6441 1463 l 6441 1425 l 6441 1388 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 5400 1800 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6441 1763 m 6575 1800 l 6441 1838 l 6615 1838 l 6615 1763 l cp
clip
n 5400 1800 m 6600 1800 l gs col-1 s gr gr

% arrowhead
n 6441 1763 m 6575 1800 l 6441 1838 l 6441 1800 l 6441 1763 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 6450 2625 m 6750 2625 l 6750 2400 l 6450 2400 l cp gs col0 s gr 
% Polyline
n 7046 2550 m 7054 2550 l gs col0 s gr
% Polyline
gs  clippath
6903 2520 m 7023 2550 l 6903 2580 l 7065 2580 l 7065 2520 l cp
clip
n 6750 2550 m 7050 2550 l gs col0 s gr gr

% arrowhead
n 6903 2520 m 7023 2550 l 6903 2580 l 6903 2550 l 6903 2520 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6897 2505 m 6777 2475 l 6897 2445 l 6735 2445 l 6735 2505 l cp
clip
n 6750 2475 m 7050 2475 l gs col0 s gr gr

% arrowhead
n 6897 2505 m 6777 2475 l 6897 2445 l 6897 2475 l 6897 2505 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 7050 2625 m 7350 2625 l 7350 2400 l 7050 2400 l cp gs col0 s gr 
% Polyline
n 7646 2550 m 7654 2550 l gs col0 s gr
% Polyline
gs  clippath
7503 2520 m 7623 2550 l 7503 2580 l 7665 2580 l 7665 2520 l cp
clip
n 7350 2550 m 7650 2550 l gs col0 s gr gr

% arrowhead
n 7503 2520 m 7623 2550 l 7503 2580 l 7503 2550 l 7503 2520 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7497 2505 m 7377 2475 l 7497 2445 l 7335 2445 l 7335 2505 l cp
clip
n 7350 2475 m 7650 2475 l gs col0 s gr gr

% arrowhead
n 7497 2505 m 7377 2475 l 7497 2445 l 7497 2475 l 7497 2505 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 7650 2625 m 7950 2625 l 7950 2400 l 7650 2400 l cp gs col0 s gr 
% Polyline
n 8246 2550 m 8254 2550 l gs col0 s gr
% Polyline
gs  clippath
8103 2520 m 8223 2550 l 8103 2580 l 8265 2580 l 8265 2520 l cp
clip
n 7950 2550 m 8250 2550 l gs col0 s gr gr

% arrowhead
n 8103 2520 m 8223 2550 l 8103 2580 l 8103 2550 l 8103 2520 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
8097 2505 m 7977 2475 l 8097 2445 l 7935 2445 l 7935 2505 l cp
clip
n 7950 2475 m 8250 2475 l gs col0 s gr gr

% arrowhead
n 8097 2505 m 7977 2475 l 8097 2445 l 8097 2475 l 8097 2505 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 8250 2625 m 8550 2625 l 8550 2400 l 8250 2400 l cp gs col0 s gr 
% Polyline
n 8846 2550 m 8854 2550 l gs col0 s gr
% Polyline
gs  clippath
8703 2520 m 8823 2550 l 8703 2580 l 8865 2580 l 8865 2520 l cp
clip
n 8550 2550 m 8850 2550 l gs col0 s gr gr

% arrowhead
n 8703 2520 m 8823 2550 l 8703 2580 l 8703 2550 l 8703 2520 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
8697 2505 m 8577 2475 l 8697 2445 l 8535 2445 l 8535 2505 l cp
clip
n 8550 2475 m 8850 2475 l gs col0 s gr gr

% arrowhead
n 8697 2505 m 8577 2475 l 8697 2445 l 8697 2475 l 8697 2505 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 6825 1950 m 6675 2400 l gs col0 s gr 
% Polyline
n 7275 1950 m 7200 2400 l gs col0 s gr 
% Polyline
n 7800 1950 m 7800 2400 l gs col0 s gr 
% Polyline
n 8175 1950 m 8400 2400 l gs col0 s gr 
% Polyline
n 3600 1575 m 5400 1575 l gs col0 s gr 
% Polyline
n 3600 1950 m 5400 1950 l gs col0 s gr 
% Polyline
n 3600 2325 m 5400 2325 l gs col0 s gr 
% Polyline
n 3600 2700 m 5400 2700 l gs col0 s gr 
% Polyline
n 3600 3075 m 5400 3075 l gs col0 s gr 
% Polyline
30.000 slw
n 3600 1200 m 5400 1200 l 5400 3450 l 3600 3450 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4500 2250 m
gs 1 -1 sc (size) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1500 m
gs 1 -1 sc (pmap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1875 m
gs 1 -1 sc (header) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4500 1050 m
gs 1 -1 sc (vm_map) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3000 m
gs 1 -1 sc (min) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3375 m
gs 1 -1 sc (max) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 2625 m
gs 1 -1 sc (refcnt) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6750 1500 m
gs 1 -1 sc (pmap) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 3000 m
gs 1 -1 sc (starting virtual address) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1315 1269 a(Figure)25 b(2.6:)30 b(The)25
b(VM)g(map)f(data)h(structure)300 1664 y(the)g(search)g(is)g
(\002nished.)31 b(Ho)n(we)n(v)o(er)l(,)24 b(if)h(the)g(page)g(is)g(not)
f(resident,)h(then)f(the)h(VM)g(system)f(must)g(issue)300
1813 y(a)h(request)g(to)f(the)h Fm(vm)p 1057 1813 30
4 v 35 w(object)p Fs(')-5 b(s)23 b Fm(vm)p 1662 1813
V 36 w(pager)g Fs(to)i(fetch)g(the)g(data)f(from)h(backing)f(store.)583
1963 y(W)-8 b(e)27 b(will)f(no)n(w)f(e)o(xamine)h(each)h(of)g(the)f
(machine-independent)f(data)i(structures)e(in)i(more)f(de-)300
2112 y(tail.)300 2407 y Fo(VM)f(Maps)300 2624 y Fs(A)38
b(VM)f(map)g(\()p Fm(vm)p 976 2624 V 35 w(map)p Fs(\))g(structure)h
(maps)f(memory)f(objects)h(into)g(re)o(gions)f(of)i(a)g(virtual)e
(address)300 2773 y(space.)f(Each)27 b(VM)f(map)g(structure)f(on)h(the)
h(system)e(contains)g(a)i(sorted)e(doubly-link)o(ed)g(list)g(of)h
(\223map)300 2923 y(entry\224)20 b(structures.)29 b(Each)20
b(map)f(entry)h(structure)g(contains)f(a)h(record)h(of)f(a)g(mapping)f
(in)h(the)f(VM)h(map')-5 b(s)300 3072 y(virtual)27 b(address)i(space.)
41 b(F)o(or)28 b(e)o(xample,)h(in)e(Figure)i(2.5)f(the)g(map)g(for)g
(the)h(init)e(process)h(w)o(ould)f(ha)n(v)o(e)300 3221
y(four)k(map)g(entry)g(structures:)42 b(te)o(xt,)32 b(data,)h(bss,)f
(and)f(stack.)49 b(The)31 b(k)o(ernel)h(and)f(each)g(process)g(on)g
(the)300 3371 y(system)24 b(ha)n(v)o(e)g(their)g(o)n(wn)g(VM)g(map)h
(structures)f(to)g(handle)g(the)h(allocations)e(of)i(their)f(virtual)g
(address)300 3520 y(space.)583 3670 y(The)g Fm(vm)p 888
3670 V 36 w(map)f Fs(data)h(structure)f(is)g(sho)n(wn)g(in)g(Figure)h
(2.6.)30 b(This)23 b(structure)h(contains)f(the)g(start-)300
3819 y(ing)37 b(and)g(ending)g(virtual)f(addresses)h(of)h(the)f
(managed)g(re)o(gion)g(of)g(virtual)g(memory)-6 b(,)39
b(a)e(reference)300 3968 y(count,)27 b(and)g(the)g(size)g(of)h(the)f
(re)o(gion.)36 b(It)28 b(also)e(contains)h(tw)o(o)f(pointers:)34
b(one)28 b(to)e(a)i(link)o(ed)e(list)g(of)h(map)300 4118
y(entries)e(that)f(describe)h(the)g(v)n(alid)f(areas)i(of)f(virtual)f
(memory)g(in)h(the)f(map,)h(and)g(one)g(to)f(the)h(machine-)300
4267 y(dependent)k(pmap)f(data)h(structure)g(that)g(contains)f(the)h
(lo)n(wer)n(-le)n(v)o(el)f(mapping)g(information)f(for)j(that)300
4416 y(map.)46 b(The)30 b(map)g(entry)g(structure)g(is)g(sho)n(wn)e(in)
i(Figure)h(2.7.)46 b(This)29 b(structure)h(contains)f(pointers)g(to)300
4566 y(the)24 b(ne)o(xt)f(and)g(pre)n(vious)g(map)h(entry)f(in)h(the)f
(map)h(entry)f(list.)30 b(It)24 b(also)f(contains)g(a)h(starting)f(and)
h(ending)300 4715 y(virtual)30 b(address,)h(a)g(pointer)f(to)g(the)g
(backing)g(object)g(\(if)g(an)o(y\),)i(and)e(attrib)n(utes)f(such)i(as)
f(protection,)300 4865 y(and)25 b(inheritance)f(code.)583
5014 y(A)35 b(map)f(entry)g(usually)f(points)g(to)h(the)h(VM)f(object)g
(it)f(is)h(mapping.)59 b(Ho)n(we)n(v)o(er)l(,)35 b(in)f(certain)300
5163 y(cases)28 b(a)f(map)g(entry)h(can)f(also)g(point)f(to)h(another)h
(map.)38 b(There)27 b(are)h(tw)o(o)f(types)g(of)h(maps)e(that)h(can)h
(be)300 5313 y(pointed)c(to)g(by)h(a)g(map)f(entry:)31
b(submaps)23 b(and)i(share)g(maps.)p eop
%%Page: 24 44
24 43 bop 3800 100 a Fs(24)420 1211 y @beginspecial 0
@llx 0 @lly 576 @urx 182 @ury 4032 @rwi @setspecial
%%BeginDocument: ../figures/vm_mape.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-21.0 232.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3898 m 0 0 l 9989 0 l 9989 3898 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
7350 2625 m
gs 1 -1 sc (vm_object/vm_map) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 1875 m
gs 1 -1 sc (starting virtual address) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 2250 m
gs 1 -1 sc (end virtual address) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 2625 m
gs 1 -1 sc (backing object pointer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 3000 m
gs 1 -1 sc (is backing object a map?) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 3375 m
gs 1 -1 sc (is backing object a submap?) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 3750 m
gs 1 -1 sc (protection, inheritance, etc.) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6000 1425 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7041 1388 m 7175 1425 l 7041 1463 l 7215 1463 l 7215 1388 l cp
clip
n 6000 1425 m 7200 1425 l gs col-1 s gr gr

% arrowhead
n 7041 1388 m 7175 1425 l 7041 1463 l 7041 1425 l 7041 1388 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6000 2550 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7041 2513 m 7175 2550 l 7041 2588 l 7215 2588 l 7215 2513 l cp
clip
n 6000 2550 m 7200 2550 l gs col-1 s gr gr

% arrowhead
n 7041 2513 m 7175 2550 l 7041 2588 l 7041 2550 l 7041 2513 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 4200 1575 m 6000 1575 l gs col0 s gr 
% Polyline
n 4200 1950 m 6000 1950 l gs col0 s gr 
% Polyline
n 4200 2325 m 6000 2325 l gs col0 s gr 
% Polyline
n 4200 2700 m 6000 2700 l gs col0 s gr 
% Polyline
n 4200 3075 m 6000 3075 l gs col0 s gr 
% Polyline
n 4200 3450 m 6000 3450 l gs col0 s gr 
% Polyline
30.000 slw
n 4200 1200 m 6000 1200 l 6000 3825 l 4200 3825 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
5100 2250 m
gs 1 -1 sc (end) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 1500 m
gs 1 -1 sc (prev/next) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 1875 m
gs 1 -1 sc (start) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5100 1050 m
gs 1 -1 sc (vm_map_entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 3000 m
gs 1 -1 sc (map) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 3375 m
gs 1 -1 sc (submap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 3750 m
gs 1 -1 sc (attributes) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 2625 m
gs 1 -1 sc (object) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7350 1500 m
gs 1 -1 sc (vm_map_entry) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 1500 m
gs 1 -1 sc (previous and next pointers) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1296 1415 a(Figure)25 b(2.7:)30 b(The)25
b(VM)f(map)h(entry)f(structure)445 1810 y Fr(\017)49
b Fs(Submaps)28 b(can)g(only)g(be)g(used)g(by)g(the)g(k)o(ernel.)41
b(The)28 b(main)g(purpose)g(of)g(submaps)f(is)h(to)g(break)544
1959 y(up)20 b(the)h(the)g(k)o(ernel)g(virtual)f(address)h(space)g
(into)f(smaller)g(units.)28 b(The)21 b(lock)g(on)f(the)h(main)f(k)o
(ernel)544 2108 y(map)26 b(locks)g(the)g(entire)g(k)o(ernel)h(virtual)e
(address)i(space)f(e)o(xcept)h(for)f(re)o(gions)f(that)h(are)i(mapped)
544 2258 y(by)c(submaps.)30 b(Those)24 b(re)o(gions)g(\(and)h(their)f
(maps\))h(are)g(lock)o(ed)g(by)f(the)h(lock)g(on)f(the)h(submap.)445
2490 y Fr(\017)49 b Fs(A)27 b(share)h(map)f(allo)n(ws)f(tw)o(o)g(or)i
(more)f(processes)g(to)g(share)h(a)f(range)h(of)f(virtual)g(address)g
(space)544 2640 y(and)32 b(thus)f(all)h(the)g(mappings)e(within)h(it.)
52 b(When)32 b(one)g(process)g(changes)g(the)g(mappings)e(in)i(a)544
2789 y(share)25 b(map,)f(all)h(other)g(processes)f(accessing)h(the)g
(share)g(map)f(see)h(the)g(change.)583 3021 y(A)30 b(whole)f(set)h(of)g
(functions)e(perform)i(operations)f(on)g(VM)h(maps.)44
b(There)30 b(are)h(functions)d(to)300 3171 y(create,)g(free,)f(add)g(a)
g(reference)h(from,)e(and)h(drop)f(a)h(reference)h(to)e(a)h(VM)f(map.)
35 b(There)27 b(are)g(functions)300 3320 y(to)i(\002nd)h(free)h(space)f
(in)f(a)i(map,)f(to)g(allocate)f(and)h(free)h(ranges)f(of)f(virtual)g
(addresses)h(in)f(a)i(map,)f(and)300 3470 y(to)f(cop)o(y)h(a)g(map)f
(for)i(a)f(fork)f(operation.)45 b(There)31 b(are)f(also)g(functions)e
(to)i(change)g(the)f(attrib)n(utes)g(of)h(a)300 3619
y(mapping.)f(Attrib)n(utes)24 b(include)g(protection,)f(memory)h(usage)
h(pattern)f(\(advice\),)h(and)g(wire-count.)30 b(It)300
3768 y(should)g(be)g(noted)h(that)f(an)h(attrib)n(ute)f(applies)g(to)g
(the)h(whole)f(mapping)f(de\002ned)i(by)g(the)f(map)h(entry)-6
b(.)300 3918 y(If)37 b(the)f(k)o(ernel)h(w)o(ants)f(to)g(change)h(the)f
(attrib)n(utes)g(of)g(part)h(of)f(a)h(map)f(entry)-6
b(,)39 b(then)d(that)g(map)g(entry)300 4067 y(must)28
b(be)i(brok)o(en)f(into)f(tw)o(o)h(or)h(three)f(parts.)44
b(F)o(or)30 b(e)o(xample,)f(if)h(there)f(is)g(a)h(map)f(entry)g
(mapping)f(the)300 4217 y(virtual)f(address)g(range)h(0x2000)e(to)h
(0x5000)g(read/write)g(and)h(the)f(VM)g(system)f(is)h(ask)o(ed)h(to)f
(change)300 4366 y(the)j(protection)g(of)h(0x3000)e(to)h(0x4000)g(to)g
(read-only)-6 b(,)31 b(then)g(the)f(map)g(entry)h(will)e(get)i(brok)o
(en)f(into)300 4515 y(three)23 b(parts:)30 b(0x2000)21
b(to)i(0x3000)f(at)h(read-write,)h(0x3000)e(to)g(0x4000)g(at)h
(read-only)-6 b(,)23 b(and)g(0x4000)e(to)300 4665 y(0x5000)j(at)h
(read/write.)583 4814 y(The)38 b(k)o(ernel)f(uses)f(a)i(VM)e(map)h
(data)g(structure)g(to)f(describe)i(its)e(o)n(wn)g(address)h(space,)j
(in-)300 4964 y(cluding)25 b(the)h(area)h(used)f(by)g(the)g(k)o(ernel)h
(dynamic)e(memory)h(allocator)f(\()p Fm(malloc)p Fs(\).)35
b(VM)25 b(map)h(entry)300 5113 y(structures)f(are)i(normally)e
(allocated)h(with)f(the)h(k)o(ernel)g Fm(malloc)p Fs(.)32
b(Ho)n(we)n(v)o(er)l(,)25 b(the)h(k)o(ernel)g(cannot)g(al-)300
5262 y(locate)e(its)f(o)n(wn)f(VM)i(map')-5 b(s)22 b(entries)i(with)f
Fm(malloc)f Fs(because)i(it)f(might)g(loop)g(while)g(allocating)f(map)p
eop
%%Page: 25 45
25 44 bop 3800 100 a Fs(25)630 1339 y @beginspecial 0
@llx 0 @lly 504 @urx 204 @ury 3528 @rwi @setspecial
%%BeginDocument: ../figures/vm_obj.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-38.0 236.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3973 m 0 0 l 9059 0 l 9059 3973 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
5400 1575 m
gs 1 -1 sc (object_list) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 1575 m
gs 1 -1 sc (linked list of all active objects) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 1950 m
gs 1 -1 sc (paging in progress?) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 2325 m
gs 1 -1 sc (reference count) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 2700 m
gs 1 -1 sc (pointer to copy object) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 3075 m
gs 1 -1 sc (pointer to shadow object) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 3450 m
gs 1 -1 sc (pointer to pager) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 3825 m
gs 1 -1 sc (object cache pointer) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6300 1125 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 1088 m 7475 1125 l 7341 1163 l 7515 1163 l 7515 1088 l cp
clip
n 6300 1125 m 7500 1125 l gs col-1 s gr gr

% arrowhead
n 7341 1088 m 7475 1125 l 7341 1163 l 7341 1125 l 7341 1088 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6300 1500 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 1463 m 7475 1500 l 7341 1538 l 7515 1538 l 7515 1463 l cp
clip
n 6300 1500 m 7500 1500 l gs col-1 s gr gr

% arrowhead
n 7341 1463 m 7475 1500 l 7341 1538 l 7341 1500 l 7341 1463 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6300 2625 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 2588 m 7475 2625 l 7341 2663 l 7515 2663 l 7515 2588 l cp
clip
n 6300 2625 m 7500 2625 l gs col-1 s gr gr

% arrowhead
n 7341 2588 m 7475 2625 l 7341 2663 l 7341 2625 l 7341 2588 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6300 3000 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 2963 m 7475 3000 l 7341 3038 l 7515 3038 l 7515 2963 l cp
clip
n 6300 3000 m 7500 3000 l gs col-1 s gr gr

% arrowhead
n 7341 2963 m 7475 3000 l 7341 3038 l 7341 3000 l 7341 2963 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6300 3375 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 3338 m 7475 3375 l 7341 3413 l 7515 3413 l 7515 3338 l cp
clip
n 6300 3375 m 7500 3375 l gs col-1 s gr gr

% arrowhead
n 7341 3338 m 7475 3375 l 7341 3413 l 7341 3375 l 7341 3338 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6300 3750 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 3713 m 7475 3750 l 7341 3788 l 7515 3788 l 7515 3713 l cp
clip
n 6300 3750 m 7500 3750 l gs col-1 s gr gr

% arrowhead
n 7341 3713 m 7475 3750 l 7341 3788 l 7341 3750 l 7341 3713 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 4500 1275 m 6300 1275 l gs col0 s gr 
% Polyline
n 4500 1650 m 6300 1650 l gs col0 s gr 
% Polyline
n 4500 2025 m 6300 2025 l gs col0 s gr 
% Polyline
n 4500 2400 m 6300 2400 l gs col0 s gr 
% Polyline
n 4500 2775 m 6300 2775 l gs col0 s gr 
% Polyline
n 4500 3150 m 6300 3150 l gs col0 s gr 
% Polyline
n 4500 3525 m 6300 3525 l gs col0 s gr 
% Polyline
30.000 slw
n 4500 900 m 6300 900 l 6300 3900 l 4500 3900 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
5400 1950 m
gs 1 -1 sc (pip) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5400 750 m
gs 1 -1 sc (vm_object) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 2700 m
gs 1 -1 sc (copy) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 3075 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 3450 m
gs 1 -1 sc (pager) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 3825 m
gs 1 -1 sc (cached_list) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 2325 m
gs 1 -1 sc (ref_count) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 1200 m
gs 1 -1 sc (memq) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7650 1200 m
gs 1 -1 sc (vm_page) col0 sh gr
/Helvetica ff 300.00 scf sf
7650 1575 m
gs 1 -1 sc (vm_object) col0 sh gr
/Helvetica ff 300.00 scf sf
7650 2700 m
gs 1 -1 sc (vm_object) col0 sh gr
/Helvetica ff 300.00 scf sf
7650 3075 m
gs 1 -1 sc (vm_object) col0 sh gr
/Helvetica ff 300.00 scf sf
7650 3450 m
gs 1 -1 sc (vm_pager) col0 sh gr
/Helvetica ff 300.00 scf sf
7650 3825 m
gs 1 -1 sc (vm_object) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 1200 m
gs 1 -1 sc (pointer to resident pages) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1375 1543 a(Figure)25 b(2.8:)30 b(The)25
b(VM)f(object)h(structure)300 1938 y(entries.)56 b(Thus,)35
b(the)f(k)o(ernel)f(allocates)g(its)g(VM)g(map)g(entries)h(from)f(a)h
(pri)n(v)n(ate)e(pool)h(of)g(map)g(entry)300 2087 y(structures)24
b(rather)h(than)g(with)f Fm(malloc)p Fs(.)300 2382 y
Fo(VM)h(Objects)300 2599 y Fs(A)30 b(VM)f(map)g(contains)g(a)h(list)e
(of)i(map)f(entries)g(that)g(de\002ne)i(allocated)e(re)o(gions)f(in)i
(a)g(map')-5 b(s)28 b(address)300 2749 y(space.)36 b(Each)27
b(map)g(entry)f(points)f(to)h(a)h(memory)f(object)g(that)g(is)h(mapped)
f(into)f(that)h(re)o(gion.)36 b(Objects)300 2898 y(may)26
b(ha)n(v)o(e)h(more)g(than)f(one)h(map)f(entry)h(pointing)e(to)i(them.)
36 b(In)26 b(the)h(BSD)h(VM)e(all)h(memory)f(objects)300
3047 y(are)f(de\002ned)f(by)f(the)h(VM)f(object)h(structure.)30
b(The)24 b(VM)f(object)g(structure)h(is)f(sho)n(wn)g(in)g(Figure)h
(2.8.)30 b(A)300 3197 y(VM)24 b(object)g(contains)g(a)h(list)f(of)h
(all)f(pages)g(of)h(memory)f(that)g(contain)g(data)h(belonging)e(to)h
(that)h(object)300 3346 y(\(resident)e(pages\).)30 b(P)o(ages)23
b(in)g(a)g(VM)g(object)f(are)i(identi\002ed)f(by)g(their)f(of)n(fset)h
(in)g(the)g(object.)29 b(P)o(ages)23 b(are)300 3495 y(often)j(added)h
(to)f(VM)g(objects)g(in)g(response)h(to)f(a)h(page)f(f)o(ault.)36
b(There)27 b(is)f(also)g(a)h(global)f(link)o(ed)g(list)f(of)300
3645 y(all)i(VM)g(object)g(allocated)g(by)g(the)g(system.)37
b(The)27 b(VM)g(object)g(contains)f(a)i(reference)g(counter)g(and)f(a)
300 3794 y(\003ag)h(to)e(indicate)h(if)g(data)g(is)g(currently)f(being)
h(transfered)g(between)g(one)g(of)h(the)e(VM)h(object')-5
b(s)26 b(pages)300 3944 y(and)j(backing)g(store)g(\(this)f(is)h(called)
g(\223paging\224\).)43 b(The)29 b(VM)g(object)g(contains)f(a)h(shado)n
(w)f(object)h(and)300 4093 y(a)h(cop)o(y)g(object)f(pointer)-5
b(.)45 b(These)29 b(pointers)g(are)i(used)e(for)h(cop)o(y-on-write)g
(operations,)g(described)f(in)300 4242 y(detail)j(in)g(Section)g
(2.4.4.)53 b(The)32 b(VM)g(object)g(contains)f(a)i(pointer)f(to)g(a)g
(VM)g(pager)h(structure.)53 b(The)300 4392 y(pager)32
b(is)g(used)f(to)g(read)i(and)f(write)f(data)h(from)g(backing)f(store.)
51 b(Finally)32 b(the)f(VM)h(object)f(contains)300 4541
y(pointers)24 b(for)h(the)g(object)f(cache.)583 4691
y(The)k(object)e(cache)i(is)f(a)g(list)f(of)h(VM)g(objects)f(that)h
(are)g(currently)g(not)f(referenced)j(\(i.e.)37 b(their)300
4840 y(reference)27 b(count)e(is)g(zero\).)34 b(Objects)25
b(can)g(be)h(remo)o(v)o(ed)e(from)i(the)f(cache)h(by)f(ha)n(ving)g
(their)g(reference)300 4989 y(count)f(increased.)30 b(Objects)24
b(in)g(the)g(object)g(cache)h(are)g(said)f(to)f(be)i(\223persisting.)-7
b(\224)29 b(The)c(goal)f(of)g(ha)n(ving)300 5139 y(persisting)k
(objects)i(is)f(to)h(allo)n(w)f(memory)g(objects)g(that)h(are)g(often)g
(reused)g(to)g(be)g(reclaimed)g(rather)300 5288 y(than)h(reallocated)g
(and)h(read)g(in)e(from)i(backing)e(store.)50 b(F)o(or)32
b(e)o(xample,)g(the)f(program)g Fm(/bin/ls)f Fs(is)p
eop
%%Page: 26 46
26 45 bop 3800 100 a Fs(26)642 937 y @beginspecial 0
@llx 0 @lly 500 @urx 135 @ury 3500 @rwi @setspecial
%%BeginDocument: ../figures/vm_pager.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-21.0 187.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3148 m 0 0 l 8713 0 l 8713 3148 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
7350 1500 m
gs 1 -1 sc (vm_pager) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 1875 m
gs 1 -1 sc (external handle) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 2250 m
gs 1 -1 sc (pager type) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 2625 m
gs 1 -1 sc (pager operations) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 3000 m
gs 1 -1 sc (pointer to private pager data) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6000 2550 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7041 2513 m 7175 2550 l 7041 2588 l 7215 2588 l 7215 2513 l cp
clip
n 6000 2550 m 7200 2550 l gs col-1 s gr gr

% arrowhead
n 7041 2513 m 7175 2550 l 7041 2588 l 7041 2550 l 7041 2513 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6000 2925 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7041 2888 m 7175 2925 l 7041 2963 l 7215 2963 l 7215 2888 l cp
clip
n 6000 2925 m 7200 2925 l gs col-1 s gr gr

% arrowhead
n 7041 2888 m 7175 2925 l 7041 2963 l 7041 2925 l 7041 2888 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6000 1425 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7041 1388 m 7175 1425 l 7041 1463 l 7215 1463 l 7215 1388 l cp
clip
n 6000 1425 m 7200 1425 l gs col-1 s gr gr

% arrowhead
n 7041 1388 m 7175 1425 l 7041 1463 l 7041 1425 l 7041 1388 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 4200 1575 m 6000 1575 l gs col0 s gr 
% Polyline
n 4200 1950 m 6000 1950 l gs col0 s gr 
% Polyline
n 4200 2325 m 6000 2325 l gs col0 s gr 
% Polyline
n 4200 2700 m 6000 2700 l gs col0 s gr 
% Polyline
n 4350 3075 m 6150 3075 l gs col0 s gr 
% Polyline
30.000 slw
n 4200 1200 m 6000 1200 l 6000 3075 l 4200 3075 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
5100 2250 m
gs 1 -1 sc (type) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 1500 m
gs 1 -1 sc (list) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 1875 m
gs 1 -1 sc (handle) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5100 1050 m
gs 1 -1 sc (vm_pager) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 3000 m
gs 1 -1 sc (data) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5100 2625 m
gs 1 -1 sc (ops) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7350 2625 m
gs 1 -1 sc (pagerops) col0 sh gr
/Helvetica ff 300.00 scf sf
7350 3000 m
gs 1 -1 sc (void) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3900 1500 m
gs 1 -1 sc (list of all pagers on system) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1290 1140 a(Figure)26 b(2.9:)k(The)24 b(VM)h(pager)g(data)
g(structure)300 1536 y(run)k(frequently)-6 b(,)29 b(b)n(ut)f(only)g
(for)i(a)f(short)f(time.)42 b(Allo)n(wing)27 b(the)i(VM)g(object)f
(that)h(represents)g(this)f(\002le)300 1685 y(to)d(persist)g(in)g
(memory)f(sa)n(v)o(es)h(the)h(VM)f(system)f(the)h(trouble)g(of)h(ha)n
(ving)e(to)h(read)h(the)g Fm(/bin/ls)e Fs(\002le)300
1834 y(from)h(disk)f(e)n(v)o(ery)g(time)g(someone)g(runs)g(it.)300
2129 y Fo(VM)h(P)o(agers)300 2346 y Fs(VM)31 b(objects)g(read)g(and)h
(write)f(data)g(from)g(backing)g(store)g(into)g(a)g(page)h(of)f(memory)
g(with)f(a)i(pager)l(,)300 2495 y(which)23 b(is)h(de\002ned)g(by)g(a)g
(VM)f(pager)h(structure.)31 b(Each)24 b(VM)f(object)g(that)h(accesses)g
(backing)g(store)f(has)300 2645 y(its)28 b(o)n(wn)h(VM)f(pager)i(data)f
(structure.)44 b(There)29 b(are)h(three)g(types)e(of)h(VM)g(pagers:)39
b(de)n(vice,)30 b(sw)o(ap,)g(and)300 2794 y(vnode.)37
b(A)27 b(de)n(vice)f(pager)i(is)e(used)h(for)g(de)n(vice)g(\002les)g
(that)f(allo)n(w)g(their)h(memory)f(to)h(be)g Fm(mmap)p
Fs(')-5 b(d)26 b(\(e.g.)300 2944 y(\002les)f(in)g Fm(/dev)p
Fs(\).)31 b(A)26 b(sw)o(ap)f(pager)g(is)g(used)g(for)g(anon)o(ymous)e
(memory)i(objects)f(that)h(are)h(paged)f(out)f(to)300
3093 y(the)g(sw)o(ap)g(area)h(of)f(the)h(disk.)k(A)24
b(vnode)g(pager)h(is)e(used)h(for)h(normal)e(\002les)i(that)e(are)i
(memory)f(mapped.)300 3242 y(The)h(k)o(ernel)g(maintains)e(a)i(link)o
(ed)f(list)g(of)h(all)f(the)h(VM)f(pager)i(structures)e(on)g(the)h
(system.)583 3392 y(The)k(VM)f(pager)h(structure)f(is)g(sho)n(wn)g(in)g
(Figure)h(2.9.)41 b(The)29 b(structure)f(contains)g(pointers)f(to)300
3541 y(maintain)32 b(the)h(global)f(link)o(ed)h(list)f(of)h(pager)g
(structures.)56 b(It)33 b(contains)f(a)h(\223handle\224)h(that)e(is)h
(used)g(as)300 3691 y(an)27 b(identi\002cation)f(tag)h(for)g(the)g
(pager)-5 b(.)37 b(It)27 b(contains)f(a)h(type)g(\002eld)g(that)f
(indicates)g(which)h(of)g(the)g(three)300 3840 y(types)g(of)h(pagers)g
(the)g(pager)g(is.)39 b(The)28 b(pager)g(also)g(has)f(a)i(pri)n(v)n
(ate)d(data)i(pointer)f(that)h(can)g(be)g(used)f(by)300
3989 y(pager)n(-speci\002c)d(code)f(to)g(store)f(pager)n(-speci\002c)i
(data.)30 b(Finally)-6 b(,)22 b(the)h(pager)g(structure)g(has)g(a)g
(pointer)f(to)300 4139 y(a)28 b(set)g(of)g(pager)h(operations.)40
b(Supported)27 b(operations)g(include:)37 b(allocating)27
b(a)h(ne)n(w)g(pager)h(structure,)300 4288 y(freeing)j(a)h(pager)f
(structure,)i(reading)d(pages)h(in)g(from)g(backing)f(store,)j(and)e
(sa)n(ving)f(pages)h(back)g(to)300 4438 y(backing)24
b(store.)300 4733 y Fo(VM)h(P)o(ages)300 4949 y Fs(The)i(physical)f
(memory)g(of)h(a)g(system)f(is)g(di)n(vided)g(into)g(pages.)37
b(The)27 b(size)g(of)g(a)g(page)g(is)g(\002x)o(ed)g(by)f(the)300
5099 y(memory)d(management)h(hardw)o(are)h(of)f(the)g(computer)-5
b(.)29 b(The)c(VM)e(system)g(manages)h(these)g(hardw)o(are)300
5248 y(pages)f(with)g(the)g(VM)g(page)g(structure.)30
b(On)23 b(most)f(systems)g(there)i(is)e(a)i(VM)f(page)g(structure)g
(for)h(e)n(v)o(ery)300 5397 y(page)h(of)g(memory)f(that)g(is)h(a)n(v)n
(ailable)f(for)h(the)f(VM)h(system)e(to)i(use.)p eop
%%Page: 27 47
27 46 bop 3800 100 a Fs(27)753 1199 y @beginspecial 0
@llx 0 @lly 462 @urx 180 @ury 3234 @rwi @setspecial
%%BeginDocument: ../figures/vm_page.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-44.0 232.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3898 m 0 0 l 8459 0 l 8459 3898 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
4800 3000 m
gs 1 -1 sc (offset) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3600 1500 m
gs 1 -1 sc (page list pointers) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3600 1875 m
gs 1 -1 sc (hash table pointers) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3600 2250 m
gs 1 -1 sc (object list pointers) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3600 2625 m
gs 1 -1 sc (pointer to object) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3600 3000 m
gs 1 -1 sc (offset in object) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3600 3750 m
gs 1 -1 sc (physical address) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 5700 2550 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6741 2513 m 6875 2550 l 6741 2588 l 6915 2588 l 6915 2513 l cp
clip
n 5700 2550 m 6900 2550 l gs col-1 s gr gr

% arrowhead
n 6741 2513 m 6875 2550 l 6741 2588 l 6741 2550 l 6741 2513 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
7050 2625 m
gs 1 -1 sc (vm_object) col0 sh gr
% Ellipse
n 5700 2175 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6741 2138 m 6875 2175 l 6741 2213 l 6915 2213 l 6915 2138 l cp
clip
n 5700 2175 m 6900 2175 l gs col-1 s gr gr

% arrowhead
n 6741 2138 m 6875 2175 l 6741 2213 l 6741 2175 l 6741 2138 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
7050 2250 m
gs 1 -1 sc (vm_page) col0 sh gr
% Ellipse
n 5700 1800 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6741 1763 m 6875 1800 l 6741 1838 l 6915 1838 l 6915 1763 l cp
clip
n 5700 1800 m 6900 1800 l gs col-1 s gr gr

% arrowhead
n 6741 1763 m 6875 1800 l 6741 1838 l 6741 1800 l 6741 1763 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
7050 1875 m
gs 1 -1 sc (vm_page) col0 sh gr
% Ellipse
n 5700 1425 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6741 1388 m 6875 1425 l 6741 1463 l 6915 1463 l 6915 1388 l cp
clip
n 5700 1425 m 6900 1425 l gs col-1 s gr gr

% arrowhead
n 6741 1388 m 6875 1425 l 6741 1463 l 6741 1425 l 6741 1388 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
7050 1500 m
gs 1 -1 sc (vm_page) col0 sh gr
% Polyline
n 3900 1575 m 5700 1575 l gs col0 s gr 
% Polyline
n 3900 1950 m 5700 1950 l gs col0 s gr 
% Polyline
n 3900 2325 m 5700 2325 l gs col0 s gr 
% Polyline
n 3900 2700 m 5700 2700 l gs col0 s gr 
% Polyline
n 3900 3075 m 5700 3075 l gs col0 s gr 
% Polyline
n 3900 3450 m 5700 3450 l gs col0 s gr 
% Polyline
30.000 slw
n 3900 1200 m 5700 1200 l 5700 3825 l 3900 3825 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 2250 m
gs 1 -1 sc (listq) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 1500 m
gs 1 -1 sc (pageq) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 1875 m
gs 1 -1 sc (hashq) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 1050 m
gs 1 -1 sc (vm_page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 3375 m
gs 1 -1 sc (flags) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 3750 m
gs 1 -1 sc (phys_addr) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4800 2625 m
gs 1 -1 sc (object) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3600 3375 m
gs 1 -1 sc (flags \(busy, clean, etc.\)) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1378 1403 a(Figure)25 b(2.10:)30 b(The)24
b(VM)h(page)g(structure)583 1798 y(The)d(VM)g(page)g(structure)f(is)g
(sho)n(wn)g(in)g(Figure)h(2.10.)29 b(A)22 b(page)g(structure)f(can)i
(independently)300 1947 y(appear)i(on)g(three)g(dif)n(ferent)f(list)g
(of)h(pages.)31 b(These)25 b(lists)e(are:)300 2180 y
Fo(pageq:)50 b Fs(acti)n(v)o(e,)28 b(inacti)n(v)o(e,)f(and)i(free)g
(pages.)41 b(Acti)n(v)o(e)27 b(pages)i(are)g(currently)f(in)g(use.)41
b(Inacti)n(v)o(e)27 b(pages)544 2329 y(are)h(allocated)g(and)g(contain)
f(v)n(alid)g(data)h(b)n(ut)f(are)h(currently)g(not)f(being)g(used)h
(\(the)o(y)f(are)i(being)544 2479 y(sa)n(v)o(ed)g(for)h(possible)e
(reuse\).)45 b(Free)31 b(pages)e(are)i(not)e(being)g(used)g(at)g(all)h
(and)f(contain)g(no)g(v)n(alid)544 2628 y(data.)300 2860
y Fo(hashq:)50 b Fs(used)24 b(to)f(attach)i(a)f(page)h(to)f(a)g(global)
g(hash)g(table)g(that)f(maps)h(a)h(VM)e(object)h(and)g(an)h(of)n(fset)e
(to)544 3010 y(a)30 b(VM)g(page)h(structure.)46 b(This)30
b(allo)n(ws)e(a)j(page)f(to)g(be)g(quickly)g(look)o(ed)f(up)h(by)g(its)
f(object)h(and)544 3159 y(of)n(fset.)300 3392 y Fo(listq:)49
b Fs(a)33 b(list)f(of)h(pages)g(that)f(belong)h(to)f(a)i(VM)e(object.)
55 b(This)32 b(allo)n(ws)g(an)h(object)f(to)h(easily)g(access)544
3541 y(pages)25 b(that)f(it)g(o)n(wns.)300 3773 y(Each)e(page)f
(structure)h(contains)e(a)i(pointer)f(to)g(the)g(object)g(that)g(o)n
(wns)g(it,)g(and)h(its)f(of)n(fset)f(in)i(that)f(object.)300
3923 y(Each)e(page)h(structure)e(also)h(contains)f(the)h(physical)f
(address)h(of)g(the)g(page)h(to)e(which)h(it)g(refers.)29
b(Finally)-6 b(,)300 4072 y(there)29 b(are)h(a)f(number)g(of)g(\003ags)
g(that)g(are)h(used)f(by)f(the)h(VM)g(system)f(to)g(store)h(the)g
(state)g(of)g(the)g(page.)300 4222 y(Such)c(\003ags)g(include)f(\223b)n
(usy)-6 b(,)f(\224)24 b(\223clean,)-7 b(\224)26 b(and)f(\223w)o(anted.)
-7 b(\224)583 4371 y(The)32 b(VM)f(system)g(pro)o(vides)f(functions)g
(to)h(allocate)h(and)f(free)i(pages,)g(to)e(add)h(and)f(remo)o(v)o(e)
300 4520 y(pages)25 b(from)f(the)h(hash)g(table,)f(and)h(to)f(zero)i
(or)e(cop)o(y)h(pages.)300 4852 y Ff(2.4.4)119 b(Copy-on-write)30
b(and)h(Object)f(Chaining)300 5068 y Fs(One)24 b(important)e(aspect)i
(of)g(the)g(VM)f(system)g(is)h(ho)n(w)f(it)g(handles)g(memory)g
(objects)h(that)f(are)i(mapped)300 5218 y(cop)o(y-on-write.)k(In)21
b(a)h(cop)o(y-on-write)f(mapping,)f(changes)i(made)f(to)g(an)g(object')
-5 b(s)20 b(mapped)h(pages)g(are)300 5367 y(not)26 b(shared)g(\227)g
(the)o(y)g(are)h(pri)n(v)n(ate)e(to)h(the)g(process)h(that)f(made)g
(the)g(changes.)36 b(The)26 b(BSD)h(VM)f(system)p eop
%%Page: 28 48
28 47 bop 3800 100 a Fs(28)300 249 y(manages)33 b(cop)o(y-on-write)g
(mappings)g(of)g(VM)h(objects)f(by)g(using)g(\223shado)n(w)g(objects.)
-7 b(\224)56 b(A)34 b(shado)n(w)300 398 y(object)22 b(is)f(an)h(anon)o
(ymous)e(memory)i(object)f(that)h(contains)f(the)h(modi\002ed)f(pages)h
(of)g(a)h(cop)o(y-on-write)300 548 y(mapped)32 b(VM)g(object.)52
b(When)32 b(searching)g(for)h(pages)f(in)g(a)h(cop)o(y-on-write)e
(mapping,)i(the)f(shado)n(w)300 697 y(object)24 b(is)h(searched)g
(before)g(the)g(underlying)f(object)g(is)g(searched.)583
847 y(There)29 b(are)g(tw)o(o)f(forms)f(of)h(cop)o(y-on-write)g
(mappings:)36 b(pri)n(v)n(ate)27 b(mappings)f(and)i(cop)o(y)g(map-)300
996 y(pings.)445 1223 y Fr(\017)49 b Fs(In)24 b(a)g Fo(pri)o(v)o(ate)g
Fs(cop)o(y-on-write)f(mapping,)f(changes)i(made)g(by)f(the)g(process)h
(with)f(the)g(mapping)544 1372 y(are)34 b(pri)n(v)n(ate)f(to)h(that)f
(process,)j(b)n(ut)d(changes)h(made)g(to)f(the)h(underlying)e(object)i
(that)f(are)i(not)544 1522 y(shado)n(wed)28 b(by)g(a)h(page)g(in)g(the)
f(shado)n(w)g(object)h(are)g(seen)g(by)g(the)f(mapping)g(process.)43
b(This)28 b(is)544 1671 y(the)23 b(standard)g(form)h(of)f(cop)o
(y-on-write)g(that)g(most)g(Unix-lik)o(e)f(operating)h(systems)g(use,)g
(and)h(it)544 1820 y(is)g(the)h(beha)n(vior)f(speci\002ed)h(for)h(the)e
Fm(mmap)g Fs(system)g(call)h(by)f(the)h(Unix)f(standards)g([30].)445
2051 y Fr(\017)49 b Fs(In)29 b(a)g Fo(copy)g Fs(cop)o(y-on-write)f
(mapping)g(the)h(mapping)e(process)i(gets)f(a)h(complete)f(snapshot)g
(of)544 2200 y(the)h(object)f(being)g(mapped)h(at)g(the)g(time)f(of)h
(the)f(mapping.)42 b(The)29 b(mapping)f(process)h(will)f
Fq(not)544 2350 y Fs(see)d(changes)g(other)g(processes)g(mak)o(e)g(to)g
(the)g(unshado)n(wed)f(areas)i(of)f(the)g(underlying)f(object.)544
2499 y(This)h(form)h(of)h(cop)o(y-on-write)e(requires)i(the)f(use)g(of)
g(cop)o(y)g(objects)g(\227)g(anon)o(ymous)e(memory)544
2648 y(objects)h(that)g(contain)h(the)f(unmodi\002ed)g(cop)o(y)h(of)g
(a)g(modi\002ed)f(page)h(\227)g(and)f(is)h(not)f(supported)544
2798 y(on)f(most)g(Unix-lik)o(e)g(platforms.)300 3092
y Fo(Pri)o(v)o(ate)h(Copy-on-write)300 3308 y Fs(Consider)31
b(a)g(\002le)g(\223)p Fm(test)p Fs(\224)g(that)f(has)h(just)f(been)h
(mapped)f(pri)n(v)n(ate)g(cop)o(y-on-write.)48 b(The)31
b(map)f(entry)300 3458 y(in)e(the)f(VM)h(map)g(structure)f(that)h(maps)
f Fm(test)h Fs(will)f(point)g(to)g(the)h(VM)g(object)f(that)h
(corresponds)f(to)300 3607 y Fm(test)p Fs(,)e(b)n(ut)g(it)g(will)g(ha)n
(v)o(e)g(both)g(the)g(\223cop)o(y-on-write\224)g(and)h(\223needs)g(cop)
o(y\224)f(attrib)n(ute)g(set.)33 b(The)25 b(cop)o(y-)300
3757 y(on-write)c(attrib)n(ute)g(in)g(a)g(map)h(entry)f(indicates)g
(that)g(the)g(mapped)g(object)g(is)g(mapped)g(cop)o(y-on-write.)300
3906 y(The)j(needs)h(cop)o(y)f(attrib)n(ute)g(indicates)f(that)h(a)h
(shado)n(w)f(object)g(to)g(hold)f(changed)i(pages)f(will)g(need)g(to)
300 4055 y(be)e(allocated.)29 b(When)21 b(the)h(process)f(\002rsts)g
(writes)g(to)g(the)g(mapped)g(area,)i(a)f(shado)n(w)e(object)h
(containing)300 4205 y(the)26 b(changed)g(page)g(will)f(be)g(allocated)
h(and)g(inserted)f(between)h(the)g(map)f(entry)h(and)g(the)f
(underlying)300 4354 y Fm(test)f Fs(object.)30 b(This)24
b(is)h(sho)n(wn)e(in)i(Figure)g(2.11.)583 4504 y(No)n(w)f(consider)f
(what)h(happens)g(if)g(the)f(process)h(mapping)f Fm(test)g
Fs(forks)h(of)n(f)g(a)g(child)f(process.)300 4653 y(In)k(that)f(case)h
(the)g(child)f(will)g(w)o(ant)h(its)f(o)n(wn)g(cop)o(y)g(of)h(the)f
(cop)o(y-on-write)h(re)o(gion.)35 b(In)27 b(the)g(BSD)h(VM)300
4802 y(this)h(causes)h(another)g(layer)g(of)g(cop)o(ying)f(to)h(be)g
(in)l(v)n(ok)o(ed.)45 b(The)30 b(original)f(shado)n(w)g(object)g(is)h
(treated)300 4952 y(lik)o(e)e(a)h(backing)e(object,)i(and)f(thus)g
(both)f(the)i(parent')-5 b(s)27 b(and)i(the)f(child')-5
b(s)27 b(mapping)g(enter)i(the)f(\223needs)300 5101 y(cop)o(y\224)g
(state)f(again,)g(as)h(sho)n(wn)e(in)i(Figure)f(2.12\(a\).)39
b(No)n(w)27 b(when)h(either)f(process)h(attempts)e(to)h(write)300
5251 y(to)37 b(the)g(memory)f(mapped)h(by)g(the)g(shado)n(w)f(object)h
(the)g(VM)g(system)f(will)h(catch)g(it)g(and)g(insert)g(a)300
5400 y(ne)n(w)23 b(shado)n(w)g(object)g(between)h(the)f(map)g(entry)h
(and)f(the)h(original)e(shado)n(w)h(object)g(and)h(clear)g(\223needs)p
eop
%%Page: 29 49
29 48 bop 3800 100 a Fs(29)671 2413 y @beginspecial 0
@llx 0 @lly 490 @urx 388 @ury 3430 @rwi @setspecial
%%BeginDocument: ../figures/cow1.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-16.0 467.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7807 m 0 0 l 8459 0 l 8459 7807 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
7350 1500 m
gs 1 -1 sc (After write fault) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 2700 4950 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 3000 4950 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 2100 5100 m 3300 5100 l 2700 4050 l 2100 5100 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
2700 5400 m
gs 1 -1 sc (./test) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2550 3450 m
gs 1 -1 sc (needs_copy=T) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2550 3750 m
gs 1 -1 sc (copy_on_write=T) dup sw pop neg 0 rm  col0 sh gr
% Polyline
n 2100 2400 m 3300 2400 l 3300 3000 l 2100 3000 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
2730 3903 m 2700 4023 l 2670 3903 l 2670 4065 l 2730 4065 l cp
clip
n 2700 3000 m 2700 4050 l gs col0 s gr gr

% arrowhead
n 2730 3903 m 2700 4023 l 2670 3903 l 2700 3903 l 2730 3903 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
2700 2250 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 1500 m
gs 1 -1 sc (Before write fault) dup sw pop 2 div neg 0 rm  col0 sh gr
% Ellipse
n 7350 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 7650 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 7950 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 7050 7425 m 8250 7425 l 7650 6375 l 7050 7425 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
7650 7725 m
gs 1 -1 sc (./test) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 7650 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 7650 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
gs  clippath
7680 3828 m 7650 3948 l 7620 3828 l 7620 3990 l 7680 3990 l cp
clip
n 7650 3000 m 7650 3975 l gs col0 s gr gr

% arrowhead
n 7680 3828 m 7650 3948 l 7620 3828 l 7650 3828 l 7680 3828 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 7050 2400 m 8250 2400 l 8250 3000 l 7050 3000 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
7680 6228 m 7650 6348 l 7620 6228 l 7620 6390 l 7680 6390 l cp
clip
n 7650 5475 m 7650 6375 l gs col0 s gr gr

% arrowhead
n 7680 6228 m 7650 6348 l 7620 6228 l 7650 6228 l 7680 6228 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7368 4729 m 7474 4792 l 7351 4786 l 7506 4833 l 7523 4776 l cp
clip
n 6750 4575 m 7500 4800 l gs col0 s gr gr

% arrowhead
n 7368 4729 m 7474 4792 l 7351 4786 l 7359 4758 l 7368 4729 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 7050 5025 m 8250 5025 l 7650 3975 l 7050 5025 l  cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
7650 2250 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6900 4500 m
gs 1 -1 sc (changed page) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 3450 m
gs 1 -1 sc (needs_copy=F) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 3750 m
gs 1 -1 sc (copy_on_write=T) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7650 5325 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 2400 4950 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

$F2psEnd
rs
%%EndDocument
 @endspecial 300 2616 a(Figure)34 b(2.11:)49 b(The)34
b(cop)o(y-on-write)g(mapping)e(of)j(a)f(\002le.)59 b(Note)34
b(the)g(pages)g(in)g(an)g(object)g(mapped)300 2737 y(cop)o(y-on-write)
24 b(can)h(not)g(be)g(changed.)300 3132 y(cop)o(y)-6
b(.)f(\224)29 b(This)19 b(is)g(referred)j(to)d(as)h(\223shado)n(w)f
(object)h(chaining.)-7 b(\224)28 b(After)21 b(both)e(processes)h
(perform)g(writes,)300 3281 y(the)25 b(objects)f(will)g(be)h(as)g(sho)n
(wn)e(in)i(Figure)g(2.12\(b\).)583 3431 y(Note)31 b(that)g(in)g(Figure)
g(2.12\(b\))g(the)f(parent)i(process)e(has)h(modi\002ed)g(the)g(center)
g(page)h(in)e(the)300 3580 y(\002rst)f(shado)n(w)f(object)g(and)h(thus)
f(it)g(has)h(its)f(o)n(wn)g(cop)o(y)g(of)h(it)g(in)f(its)g(most)g
(recent)h(shado)n(w)f(object)g(\(on)300 3729 y(the)34
b(left\).)60 b(The)34 b(child)g(process)g(has)g(not)g(modi\002ed)f(the)
i(center)f(page,)j(and)e(thus)e(if)h(it)g(w)o(as)h(to)f(read)300
3879 y(that)29 b(page)g(it)g(w)o(ould)f(read)h(the)g(v)o(ersion)f
(stored)h(in)g(the)g(original)f(shado)n(w)g(object)h(\(that)f(is)h
(shared)g(by)300 4028 y(both)f(the)g(parent)h(and)f(child)g(process\).)
42 b(No)n(w)27 b(consider)h(what)h(w)o(ould)e(happen)i(if)f(the)g
(child)g(process)300 4177 y(w)o(as)39 b(to)g(e)o(xit.)74
b(This)39 b(is)g(sho)n(wn)f(in)h(Figure)g(2.13.)74 b(Note)39
b(that)g(the)h(center)f(page)h(appears)g(in)f(both)300
4327 y(remaining)30 b(shado)n(w)g(objects.)50 b(Ho)n(we)n(v)o(er)30
b(the)h(parent)g(process)g(only)f(needs)h(access)h(to)f(the)g(cop)o(y)g
(of)300 4476 y(the)e(page)g(in)g(the)g(most)f(recent)h(shado)n(w)f
(object.)43 b(The)30 b(center)f(page)g(in)g(the)g(other)g(shado)n(w)f
(object)h(is)300 4626 y(inaccessible)22 b(and)g(not)f(needed.)30
b(There)23 b(is)f(no)g(longer)g(a)g(need)h(for)f(tw)o(o)g(shado)n(w)f
(objects;)h(the)o(y)f(should)300 4775 y(be)30 b(collapsed)f(together)h
(and)f(the)h(inaccessible)f(memory)g(freed.)47 b(Ho)n(we)n(v)o(er)l(,)
30 b(the)f(BSD)i(VM)f(has)f(no)300 4924 y(w)o(ay)c(to)g(realize)h
(this,)e(and)h(thus)f(the)h(inaccessible)f(memory)h(resources)g(in)g
(the)g(other)f(shado)n(w)h(object)300 5074 y(remain)g(allocated)f(e)n
(v)o(en)g(though)g(the)o(y)g(are)h(not)g(in)f(use.)583
5223 y(This)29 b(is)g(referred)h(to)f(as)g(the)g(\223object)h(collapse)
e(problem.)-7 b(\224)44 b(4.4BSD)29 b(VM)g(did)g(not)f(properly)300
5373 y(collapse)e(all)g(objects,)g(and)h(thus)e(inaccessible)h(memory)g
(could)g(get)g(stranded)g(in)g(chains)h(of)f(shado)n(w)p
eop
%%Page: 30 50
30 49 bop 3800 100 a Fs(30)1162 2180 y @beginspecial
0 @llx 0 @lly 350 @urx 363 @ury 2250 @rwi @setspecial
%%BeginDocument: ../figures/cow2.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-113.0 467.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7807 m 0 0 l 7753 0 l 7753 7807 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
6000 1950 m
gs 1 -1 sc (child process) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 4800 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 4200 5025 m 5400 5025 l 4800 3975 l 4200 5025 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 5325 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 4500 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 4800 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 5100 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 4200 7425 m 5400 7425 l 4800 6375 l 4200 7425 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 7725 m
gs 1 -1 sc (./test) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
4930 3976 m 4820 4032 l 4891 3931 l 4769 4037 l 4808 4082 l cp
clip
n 6000 3000 m 4800 4050 l gs col0 s gr gr

% arrowhead
n 4930 3976 m 4820 4032 l 4891 3931 l 4911 3953 l 4930 3976 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4830 6228 m 4800 6348 l 4770 6228 l 4770 6390 l 4830 6390 l cp
clip
n 4800 5475 m 4800 6375 l gs col0 s gr gr

% arrowhead
n 4830 6228 m 4800 6348 l 4770 6228 l 4800 6228 l 4830 6228 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 3000 2400 m 4200 2400 l 4200 3000 l 3000 3000 l cp gs col0 s gr 
% Polyline
n 5400 2400 m 6600 2400 l 6600 3000 l 5400 3000 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
4709 3926 m 4779 4027 l 4670 3971 l 4792 4077 l 4831 4032 l cp
clip
n 3600 2995 m 4800 4045 l gs col0 s gr gr

% arrowhead
n 4709 3926 m 4779 4027 l 4670 3971 l 4689 3948 l 4709 3926 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
3600 2250 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 2250 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
3825 3600 m
gs 1 -1 sc (needs_copy=T) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 3600 m
gs 1 -1 sc (needs_copy=T) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3600 1950 m
gs 1 -1 sc (parent process) dup sw pop 2 div neg 0 rm  col0 sh gr
% Ellipse
n 4800 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

$F2psEnd
rs
%%EndDocument
 @endspecial 1733 2384 a Fh(\(a\))20 b(Before)f(write)i(f)o(aults)1018
4807 y @beginspecial 0 @llx 0 @lly 404 @urx 417 @ury
2597 @rwi @setspecial
%%BeginDocument: ../figures/cow3.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-86.0 467.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7807 m 0 0 l 8203 0 l 8203 7807 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
6225 2700 m
gs 1 -1 sc (needs_copy=F) col0 sh gr
7.500 slw
% Ellipse
n 4800 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 4200 5025 m 5400 5025 l 4800 3975 l 4200 5025 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 5325 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 4500 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 4800 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 5100 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 4200 7425 m 5400 7425 l 4800 6375 l 4200 7425 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 7725 m
gs 1 -1 sc (./test) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 3000 1500 m 4200 1500 l 4200 2100 l 3000 2100 l cp gs col0 s gr 
% Polyline
n 5400 1500 m 6600 1500 l 6600 2100 l 5400 2100 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
3600 1350 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 1350 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3600 1050 m
gs 1 -1 sc (parent process) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 1050 m
gs 1 -1 sc (child process) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 3600 3750 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 3000 3900 m 4200 3900 l 3600 2850 l 3000 3900 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
3600 4200 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 5700 3750 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 5400 3900 m 6600 3900 l 6000 2850 l 5400 3900 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
6000 4200 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
4830 6228 m 4800 6348 l 4770 6228 l 4770 6390 l 4830 6390 l cp
clip
n 4800 5475 m 4800 6375 l gs col0 s gr gr

% arrowhead
n 4830 6228 m 4800 6348 l 4770 6228 l 4800 6228 l 4830 6228 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3630 2703 m 3600 2823 l 3570 2703 l 3570 2865 l 3630 2865 l cp
clip
n 3600 2100 m 3600 2850 l gs col0 s gr gr

% arrowhead
n 3630 2703 m 3600 2823 l 3570 2703 l 3600 2703 l 3630 2703 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6030 2703 m 6000 2823 l 5970 2703 l 5970 2865 l 6030 2865 l cp
clip
n 6000 2100 m 6000 2850 l gs col0 s gr gr

% arrowhead
n 6030 2703 m 6000 2823 l 5970 2703 l 6000 2703 l 6030 2703 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4109 4681 m 4179 4782 l 4070 4726 l 4192 4832 l 4231 4787 l cp
clip
n 3600 4275 m 4200 4800 l gs col0 s gr gr

% arrowhead
n 4109 4681 m 4179 4782 l 4070 4726 l 4089 4703 l 4109 4681 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5542 4742 m 5432 4798 l 5503 4697 l 5381 4803 l 5420 4848 l cp
clip
n 6012 4291 m 5412 4816 l gs col0 s gr gr

% arrowhead
n 5542 4742 m 5432 4798 l 5503 4697 l 5523 4719 l 5542 4742 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica ff 300.00 scf sf
3375 2700 m
gs 1 -1 sc (needs_copy=F) dup sw pop neg 0 rm  col0 sh gr
% Ellipse
n 4800 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

$F2psEnd
rs
%%EndDocument
 @endspecial 1756 5011 a(\(b\))e(After)h(write)h(f)o(aults)1049
5268 y Fs(Figure)k(2.12:)30 b(The)25 b(cop)o(y-on-write)f(mapping)g
(after)h(a)g(fork)p eop
%%Page: 31 51
31 50 bop 3800 100 a Fs(31)948 2582 y @beginspecial 0
@llx 0 @lly 395 @urx 417 @ury 2765 @rwi @setspecial
%%BeginDocument: ../figures/cow4.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-86.0 467.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7807 m 0 0 l 8047 0 l 8047 7807 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
5700 4500 m
gs 1 -1 sc (inaccessible page) col0 sh gr
7.500 slw
% Ellipse
n 4800 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 4200 5025 m 5400 5025 l 4800 3975 l 4200 5025 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 5325 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 4500 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 4800 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 5100 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 4200 7425 m 5400 7425 l 4800 6375 l 4200 7425 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4800 7725 m
gs 1 -1 sc (./test) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 3600 3750 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 3000 3900 m 4200 3900 l 3600 2850 l 3000 3900 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
3600 4200 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
4830 6228 m 4800 6348 l 4770 6228 l 4770 6390 l 4830 6390 l cp
clip
n 4800 5475 m 4800 6375 l gs col0 s gr gr

% arrowhead
n 4830 6228 m 4800 6348 l 4770 6228 l 4800 6228 l 4830 6228 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3630 2703 m 3600 2823 l 3570 2703 l 3570 2865 l 3630 2865 l cp
clip
n 3600 2100 m 3600 2850 l gs col0 s gr gr

% arrowhead
n 3630 2703 m 3600 2823 l 3570 2703 l 3600 2703 l 3630 2703 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4109 4681 m 4179 4782 l 4070 4726 l 4192 4832 l 4231 4787 l cp
clip
n 3600 4275 m 4200 4800 l gs col0 s gr gr

% arrowhead
n 4109 4681 m 4179 4782 l 4070 4726 l 4089 4703 l 4109 4681 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 3000 1500 m 4200 1500 l 4200 2100 l 3000 2100 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
5097 4768 m 4974 4789 l 5072 4713 l 4924 4779 l 4948 4834 l cp
clip
n 5625 4500 m 4950 4800 l gs col0 s gr gr

% arrowhead
n 5097 4768 m 4974 4789 l 5072 4713 l 5084 4740 l 5097 4768 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica ff 300.00 scf sf
3375 2700 m
gs 1 -1 sc (needs_copy=F) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3600 1350 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3600 1050 m
gs 1 -1 sc (parent process) dup sw pop 2 div neg 0 rm  col0 sh gr
% Ellipse
n 4800 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

$F2psEnd
rs
%%EndDocument
 @endspecial 888 2785 a(Figure)25 b(2.13:)30 b(The)24
b(cop)o(y-on-write)h(mapping)e(after)j(the)e(child)h(e)o(xits)300
3181 y(objects.)41 b(Ev)o(entually)27 b(the)h(inaccessible)g(memory)g
(w)o(ould)f(get)i(paged)f(out)g(to)g(the)g(sw)o(ap)h(area)g(so)f(the)
300 3330 y(physical)22 b(page)i(could)e(be)i(reused.)30
b(Ho)n(we)n(v)o(er)l(,)22 b(the)i(VM)f(system)f(w)o(ould)g(e)n(v)o
(entually)g(run)h(out)g(of)g(sw)o(ap)300 3479 y(space)h(and)g(the)g
(system)f(w)o(ould)g(deadlock.)31 b(Thus)23 b(this)g(problem)g(w)o(as)h
(also)g(referred)h(to)f(as)g(the)g(\223sw)o(ap)300 3629
y(memory)37 b(leak\224)i(b)n(ug)f(because)h(the)f(only)f(w)o(ay)i(to)f
(free)h(this)e(memory)h(is)g(to)g(cause)g(all)g(processes)300
3778 y(referencing)26 b(the)e(shado)n(w)g(object)g(chain)h(to)f(e)o
(xit.)583 3927 y(The)35 b(object)e(collapse)h(problem)f(has)h(been)g
(partly)g(addressed)g(in)g(most)e(v)o(ersions)h(of)h(BSD.)300
4077 y(Ho)n(we)n(v)o(er)19 b(the)h(object)g(collapse)g(code)h(used)f
(to)g(address)g(the)g(problem)g(is)g(rather)g(complicated)g(and)g(has)
300 4226 y(triggered)j(man)o(y)g(hours)g(of)h(deb)n(ugging.)29
b(UVM)23 b(handles)g(cop)o(y-on-write)g(in)g(a)h(completely)e(dif)n
(ferent)300 4376 y(w)o(ay)j(that)f(a)n(v)n(oids)g(the)h(object)f
(collapse)h(problem.)300 4671 y Fo(Copy)g(Copy-on-write)300
4887 y Fs(Consider)i(tw)o(o)g(processes)g(mapping)f(the)g(\002le)i
Fm(test)p Fs(,)f(as)g(sho)n(wn)f(in)h(Figure)g(2.14.)37
b(Process)28 b(\223)-8 b(A)d(\224)27 b(has)300 5037 y(a)f(shared)h
(mapping)d(of)i Fm(test)p Fs(,)g(and)g(thus)f(when)h(process)g(A)g
(changes)g(its)f(memory)g(the)h(changes)g(get)300 5186
y(re\003ected)36 b(back)g(to)f(the)g(backing)g(\002le.)63
b(Process)36 b(\223B\224)g(has)g(a)f Fq(private)g Fs(cop)o(y-on-write)g
(mapping)f(of)300 5336 y Fm(test)p Fs(.)d(Note)25 b(that)g(process)g(B)
h(has)f(only)g(written)f(to)h(the)g(the)g(center)h(page)f(of)h(the)f
(object.)32 b(If)25 b(process)p eop
%%Page: 32 52
32 51 bop 3800 100 a Fs(32)1108 2267 y @beginspecial
0 @llx 0 @lly 340 @urx 363 @ury 2380 @rwi @setspecial
%%BeginDocument: ../figures/copy1.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-118.0 467.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7807 m 0 0 l 7663 0 l 7663 7807 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
4875 6600 m
gs 1 -1 sc (shared mapping) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6900 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 6300 5025 m 7500 5025 l 6900 3975 l 6300 5025 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
6900 5325 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6600 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6900 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 7200 7275 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 6300 7425 m 7500 7425 l 6900 6375 l 6300 7425 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
6900 7725 m
gs 1 -1 sc (./test) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
6930 3828 m 6900 3948 l 6870 3828 l 6870 3990 l 6930 3990 l cp
clip
n 6900 3000 m 6900 3975 l gs col0 s gr gr

% arrowhead
n 6930 3828 m 6900 3948 l 6870 3828 l 6900 3828 l 6930 3828 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 6300 2400 m 7500 2400 l 7500 3000 l 6300 3000 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
6930 6228 m 6900 6348 l 6870 6228 l 6870 6390 l 6930 6390 l cp
clip
n 6900 5475 m 6900 6375 l gs col0 s gr gr

% arrowhead
n 6930 6228 m 6900 6348 l 6870 6228 l 6900 6228 l 6930 6228 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6618 4729 m 6724 4792 l 6601 4786 l 6756 4833 l 6773 4776 l cp
clip
n 6000 4575 m 6750 4800 l gs col0 s gr gr

% arrowhead
n 6618 4729 m 6724 4792 l 6601 4786 l 6609 4758 l 6618 4729 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 2100 4425 m 3300 4425 l 3300 5025 l 2100 5025 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
6338 7100 m 6426 7186 l 6308 7152 l 6448 7233 l 6478 7182 l cp
clip
n 2700 5025 m 6450 7200 l gs col0 s gr gr

% arrowhead
n 6338 7100 m 6426 7186 l 6308 7152 l 6323 7126 l 6338 7100 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
6900 2250 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6750 3600 m
gs 1 -1 sc (needs_copy=F) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6150 4500 m
gs 1 -1 sc (changed page) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 4275 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 3975 m
gs 1 -1 sc (process A) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6900 1950 m
gs 1 -1 sc (process B) dup sw pop 2 div neg 0 rm  col0 sh gr
% Ellipse
n 6900 4875 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

$F2psEnd
rs
%%EndDocument
 @endspecial 1221 2470 a(Figure)25 b(2.14:)30 b(Pri)n(v)n(ate)25
b(cop)o(y-on-write)f(mapping)300 2866 y(A)i(writes)g(to)g(the)g
(left-hand)g(page)g(of)h Fm(test)e Fs(before)i(process)f(B)h(does,)f
(then)g(process)g(B)g(will)g(see)g(the)300 3015 y(changes)e(made)f(to)g
(that)h(page)f(by)h(A)f(up)h(to)f(that)g(point.)29 b(Ho)n(we)n(v)o(er)l
(,)23 b(once)h(the)f(page)h(gets)f(added)h(to)f(B')-5
b(s)300 3164 y(shado)n(w)24 b(object)g(then)h(B)g(will)f(no)g(longer)h
(see)g(changes)g(made)g(by)f(A.)583 3314 y(No)n(w)19
b(consider)g(a)h(setup)e(in)h(which)g(process)g(A)h(has)f(a)h(shared)f
(mapping)f(of)h Fm(test)g Fs(and)g(process)300 3463 y(B)29
b(has)g(a)g Fq(copy)g Fs(cop)o(y-on-write)f(mapping)f(as)i(sho)n(wn)e
(in)i(Figure)f(2.15.)42 b(Before)30 b(process)e(A)h(changes)300
3612 y(the)d(left)g(page,)g(it)g(must)f(create)i(a)f(cop)o(y)g(object)g
(so)g(that)f(process)h(B)h(can)f(access)h(the)f(original)f(v)o(ersion)
300 3762 y(of)h(the)g(left)g(page.)34 b(When)26 b(B)h(changes)f(the)g
(middle)f(page)h(it)f(creates)i(a)f(shado)n(w)f(object.)34
b(The)26 b(shado)n(w)300 3911 y(object)d(no)n(w)g(shado)n(ws)g(the)g
(cop)o(y)h(object)f(rather)i(than)e Fm(test)p Fs(')-5
b(s)22 b(object.)30 b(A)24 b(list)f(of)h(objects)f(formed)g(by)300
4061 y(the)i(cop)o(y)f(object)h(pointer)f(is)g(called)h(a)g(\223cop)o
(y)g(object)f(chain.)-7 b(\224)583 4210 y(Cop)o(y)23
b(objects)e(are)i(needed)g(to)f(support)f(the)h(non-standard)f(cop)o(y)
h(cop)o(y-on-write)g(semantics.)300 4359 y(Cop)o(y)g(objects)g(add)g
(another)g(layer)g(of)g(comple)o(xity)e(to)i(the)g(VM)g(code)g(and)g
(mak)o(e)g(the)g(object)g(collapse)300 4509 y(problem)i(more)h(dif)n
(\002cult)f(to)g(address.)31 b(Maintaining)23 b(cop)o(y)i(cop)o
(y-on-write)f(semantics)g(is)h(more)g(also)300 4658 y(e)o(xpensi)n(v)o
(e)31 b(than)h(pri)n(v)n(ate)g(cop)o(y-on-write)g(semantics.)54
b(There)33 b(are)h(more)e(k)o(ernel)h(data)g(structure)f(to)300
4808 y(allocate)23 b(and)f(track.)31 b(There)23 b(is)f(an)h(e)o(xtra)g
(data)g(cop)o(y)f(of)h(a)g(page)g(that)f(the)h(pri)n(v)n(ate)f(mapping)
f(semantics)300 4957 y(doesn')n(t)g(ha)n(v)o(e)g(to)g(do.)29
b(Processes)22 b(with)e(shared)i(mappings)d(of)j(\002les)f(must)f(ha)n
(v)o(e)h(their)g(mappings)f(write)300 5106 y(protected)i(whene)n(v)o
(er)g(a)h(cop)o(y)g(object)f(is)g(made)g(so)g(that)h(write)f(accesses)h
(to)f(the)h(object)f(can)h(be)f(caught)p eop
%%Page: 33 53
33 52 bop 3800 100 a Fs(33)796 2687 y @beginspecial 0
@llx 0 @lly 447 @urx 435 @ury 3129 @rwi @setspecial
%%BeginDocument: ../figures/copy2.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-37.0 471.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7882 m 0 0 l 8099 0 l 8099 7882 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
6000 825 m
gs 1 -1 sc (process B) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 4200 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 4500 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 3600 7500 m 4800 7500 l 4200 6450 l 3600 7500 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4200 7800 m
gs 1 -1 sc (./test) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6000 3750 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6000 3750 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 5400 3900 m 6600 3900 l 6000 2850 l 5400 3900 l  cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
6000 4200 m
gs 1 -1 sc (shadow) dup sw pop 2 div neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 5700 6075 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Polyline
30.000 slw
n 750 4500 m 1950 4500 l 1950 5100 l 750 5100 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
3659 7081 m 3729 7182 l 3620 7126 l 3742 7232 l 3781 7187 l cp
clip
n 1350 5100 m 3750 7200 l gs col0 s gr gr

% arrowhead
n 3659 7081 m 3729 7182 l 3620 7126 l 3639 7103 l 3659 7081 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 5400 6225 m 6600 6225 l 6000 5175 l 5400 6225 l  cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
6030 5028 m 6000 5148 l 5970 5028 l 5970 5190 l 6030 5190 l cp
clip
n 6000 4275 m 6000 5175 l gs col0 s gr gr

% arrowhead
n 6030 5028 m 6000 5148 l 5970 5028 l 6000 5028 l 6030 5028 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5856 6642 m 5976 6612 l 5884 6695 l 6027 6619 l 5999 6566 l cp
clip
n 6000 6600 m 4725 7275 l gs col0 s gr gr

% arrowhead
n 5856 6642 m 5976 6612 l 5884 6695 l 5870 6669 l 5856 6642 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4569 6707 m 4448 6737 l 4540 6654 l 4398 6731 l 4426 6784 l cp
clip
n 4425 6750 m 5400 6225 l gs col0 s gr gr

% arrowhead
n 4569 6707 m 4448 6737 l 4540 6654 l 4554 6680 l 4569 6707 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 5400 1275 m 6600 1275 l 6600 1875 l 5400 1875 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
5718 3604 m 5824 3667 l 5701 3661 l 5856 3708 l 5873 3651 l cp
clip
n 5100 3450 m 5850 3675 l gs col0 s gr gr

% arrowhead
n 5718 3604 m 5824 3667 l 5701 3661 l 5709 3633 l 5718 3604 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6030 2703 m 6000 2823 l 5970 2703 l 5970 2865 l 6030 2865 l cp
clip
n 6000 1800 m 6000 2850 l gs col0 s gr gr

% arrowhead
n 6030 2703 m 6000 2823 l 5970 2703 l 6000 2703 l 6030 2703 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
1350 4350 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1350 4050 m
gs 1 -1 sc (process A) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2925 6750 m
gs 1 -1 sc (shared mapping) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6000 6525 m
gs 1 -1 sc (copy) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4950 7350 m
gs 1 -1 sc (copy pointer) col0 sh gr
/Helvetica ff 300.00 scf sf
6075 4575 m
gs 1 -1 sc (shadow pointer) col0 sh gr
/Helvetica ff 300.00 scf sf
5400 6180 m
gs 1 -1 sc (pointer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 5850 m
gs 1 -1 sc (shadow) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 1125 m
gs 1 -1 sc (map entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 2475 m
gs 1 -1 sc (needs_copy=F) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5250 3375 m
gs 1 -1 sc (changed page) dup sw pop neg 0 rm  col0 sh gr
% Ellipse
n 3900 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

$F2psEnd
rs
%%EndDocument
 @endspecial 1253 2890 a(Figure)25 b(2.15:)30 b(Cop)o(y)24
b(cop)o(y-on-write)h(mapping)300 3285 y(by)k(a)i(page)f(f)o(ault.)45
b(Because)31 b(of)e(this,)h(se)n(v)o(eral)f(branches)h(of)g(the)g(BSD)g
(f)o(amily)f(ha)n(v)o(e)h(remo)o(v)o(ed)e(cop)o(y)300
3435 y(objects)c(and)h(cop)o(y)f(cop)o(y-on-write)h(mappings)e(from)i
(the)f(k)o(ernel.)300 3766 y Ff(2.4.5)119 b(P)o(age)29
b(F)m(ault)h(Handling)300 3983 y Fs(No)n(w)23 b(that)h(the)g(VM)g
(object)g(structure)f(has)h(been)h(e)o(xplained)e(the)h(general)g
(procedure)h(used)f(to)f(handle)300 4132 y(page)28 b(f)o(aults)f(can)h
(be)g(e)o(xplained.)39 b(When)28 b(memory)f(is)g(referenced)i(by)f(a)g
(process)f(one)h(of)g(tw)o(o)f(things)300 4281 y(can)e(happen:)445
4514 y Fr(\017)49 b Fs(The)43 b(referenced)h(address)e(has)h(a)g
Fo(v)o(alid)g(mapping)g Fs(and)g(the)f(data)h(is)f(accessed)i(from)e
(the)544 4663 y(mapped)24 b(physical)g(page.)445 4896
y Fr(\017)49 b Fs(The)31 b(referenced)h(address)f(has)f(an)h
Fo(in)l(v)o(alid)g(mapping)g Fs(and)g(the)f(MMU)g(causes)h(a)g(page)g
(f)o(ault)544 5045 y(to)25 b(occur)-5 b(.)34 b(The)26
b(lo)n(w)f(le)n(v)o(el)f(machine-dependent)h(code)i(catches)f(the)f
(page)h(f)o(ault)g(and)g(calls)f(the)544 5194 y(VM)d(page)g(f)o(ault)g
(routine.)29 b(If)22 b(the)g(page)g(f)o(ault)g(routine)g(cannot)g
(handle)f(the)h(f)o(ault)g(then)g(it)f(returns)544 5344
y(a)k(f)o(ailure)g(code)g(that)f(causes)h(the)g(program)f(to)h(recei)n
(v)o(e)f(a)h(\223se)o(gmentation)e(violation.)-7 b(\224)p
eop
%%Page: 34 54
34 53 bop 3800 100 a Fs(34)583 249 y(The)19 b(page)h(f)o(ault)e
(handler)h(is)g(called)g(with)f(the)h(VM)f(map)h(of)g(the)g(process)g
(that)f(caused)i(the)e(f)o(ault,)300 398 y(the)35 b(virtual)f(address)g
(of)h(the)g(f)o(ault,)h(and)f(whether)g(the)g(f)o(aulting)e(process)i
(w)o(as)g(reading)f(or)h(writing)300 548 y(memory)24
b(when)g(the)h(f)o(ault)f(occurred.)31 b(A)25 b(simpli\002ed)e(v)o
(ersion)h(of)h(the)f(f)o(ault)g(routine')-5 b(s)24 b(operation)g(is)g
(as)300 697 y(follo)n(ws:)420 930 y(1.)49 b(The)22 b(list)f(of)i
(entries)e(in)h(the)g(VM)g(map)g(is)g(searched)h(for)f(the)g(map)g
(entry)g(whose)g(virtual)f(address)544 1079 y(range)i(the)f(f)o
(aulting)f(address)h(f)o(alls)g(in.)30 b(If)22 b(there)h(is)f(no)g
(such)g(map)g(entry)-6 b(,)22 b(then)g(the)g(f)o(ault)g(routine)544
1228 y(returns)i(an)h(error)h(code)f(and)g(the)f(process)h(gets)f(a)i
(se)o(gmentation)c(violation.)420 1461 y(2.)49 b(Once)28
b(the)f(proper)h(map)f(entry)h(is)f(found,)g(then)h(the)f(f)o(ault)g
(routine)g(starts)g(at)h(the)f(VM)g(object)h(it)544 1610
y(points)21 b(to)i(and)f(searches)i(for)f(the)f(needed)h(page.)30
b(If)24 b(the)e(page)h(is)f(not)h(found)f(in)g(the)h(\002rst)g(object,)
544 1760 y(the)33 b(f)o(ault)g(routine)g(tra)n(v)o(erses)g(the)g(shado)
n(w)g(object)g(chain)g(pointers)g(until)f(it)h(either)g(\002nds)g(the)
544 1909 y(page)25 b(or)g(runs)g(out)f(of)h(objects)g(to)f(try)-6
b(.)31 b(If)25 b(the)g(f)o(ault)g(routine)f(runs)h(out)f(of)h(objects)g
(to)f(try)h(it)f(may)544 2058 y(either)j(cause)h(the)f(f)o(ault)g(to)g
(f)o(ail)g(or)h(allocate)f(a)h(zero)g(\002ll)f(page)g(\(depending)g(on)
g(the)g(mapping\).)544 2208 y(The)c(f)o(ault)h(routine)f(lea)n(v)o(es)g
(a)h(b)n(usy)e(page)i(in)f(the)h(top)f(le)n(v)o(el)f(object)h(to)g(pre)
n(v)o(ent)g(other)g(processes)544 2357 y(from)h(changing)h(its)f
(object)g(while)g(it)h(is)f(processing)g(the)h(f)o(ault.)420
2590 y(3.)49 b(Once)36 b(the)f(proper)g(page)h(is)f(found)f(the)i
(object')-5 b(s)34 b(VM)h(pager)h(must)e(retrie)n(v)o(e)g(from)i
(backing)544 2739 y(store)29 b(if)g(it)f(is)h(not)g(resident.)43
b(Then)29 b(the)g(f)o(ault)f(routine)h(checks)g(to)g(see)g(if)g(this)f
(is)h(a)g(write-f)o(ault)544 2888 y(and)d(if)g(the)h(object)e(that)h(o)
n(wns)f(that)h(page)h(has)f(a)h(cop)o(y)f(object.)34
b(If)27 b(it)f(does,)g(then)g(a)h(cop)o(y)f(of)g(the)544
3038 y(page)e(is)g(made)h(and)f(the)g(old)g(v)o(ersion)g(of)g(the)g
(page)h(is)f(placed)g(in)g(the)h(object)f(pointed)f(to)h(by)g(the)544
3187 y(cop)o(y)g(object)h(chain)g(pointer)-5 b(.)420
3420 y(4.)49 b(If)34 b(the)f(f)o(ault)g(routine)g(had)g(a)h(VM)f(pager)
g(do)h(I/O)f(to)g(get)g(the)g(needed)h(page,)h(then)f(the)f(pager)544
3569 y(unlock)o(ed)28 b(all)g(the)g(data)h(structures)f(before)h
(starting)e(the)i(I/O.)f(In)h(this)e(case)i(the)g(f)o(ault)f(routine)
544 3718 y(must)g(re)n(v)o(erify)g(the)h(lookup)f(in)h(the)g(VM)f(map)h
(to)g(ensure)g(that)g(the)g(process')g(mappings)e(ha)n(v)o(e)544
3868 y(not)d(been)h(changed)g(since)g(the)f(start)h(of)g(the)f(f)o
(ault)h(operation.)420 4100 y(5.)49 b(Ne)o(xt)28 b(the)h(f)o(ault)f
(routine)g(asks)h(the)f(pmap)g(layer)i(to)e(map)g(the)h(page)g(being)f
(f)o(aulted.)43 b(The)28 b(f)o(ault)544 4250 y(routine)e(must)g
(determine)g(the)h(appropriate)g(protection)f(to)g(use)h(depending)f
(on)h(the)f(cop)o(y-on-)544 4399 y(write)f(status)e(and)i(the)g
(protection)f(of)h(the)f(map)h(entry)-6 b(.)420 4631
y(6.)49 b(Finally)-6 b(,)29 b(the)g(f)o(ault)g(routine)g(returns)g(a)g
(success)g(code)h(so)e(that)h(the)g(process)g(can)h(resume)f(run-)544
4781 y(ning.)p eop
%%Page: 35 55
35 54 bop 3800 100 a Fs(35)300 249 y Ff(2.4.6)119 b(Memory)29
b(Sharing)300 466 y Fs(W)-8 b(e)19 b(ha)n(v)o(e)g(discussed)f(the)h(v)n
(arious)f(w)o(ay)h(memory)g(can)g(be)g(copied)g(in)g(the)g(BSD)h(VM)e
(system.)28 b(Memory)300 615 y(sharing)21 b(is)h(much)f(simpler)g(than)
h(memory)f(cop)o(ying)g(and)h(does)f(not)h(require)g(object)g(chains.)
29 b(Memory)300 764 y(can)c(also)g(be)g(shared)f(in)h(a)g(number)f(of)h
(w)o(ays)g(in)f(the)h(BSD)h(VM)e(system)g(including:)445
997 y Fr(\017)49 b Fs(In)29 b(a)g(multithreaded)f(en)l(vironment,)h
(the)g(VM)f(map)h(and)g(pmap)g(structures)f(of)h(a)h(process)f(can)544
1146 y(be)c(shared)g(by)f(its)g(threads.)445 1379 y Fr(\017)49
b Fs(V)-6 b(irtual)24 b(memory)g(space)h(can)g(be)g(shared)g(using)f
(share)h(maps.)445 1611 y Fr(\017)49 b Fs(Memory)29 b(objects)f(such)i
(a)f(\002les)h(can)g(be)f(mapped)g(into)g(multiple)f(virtual)g(address)
i(spaces)f(by)544 1761 y(being)h(referenced)i(by)f(multiple)e(VM)h(map)
g(entry)h(structures.)47 b(This)30 b(allo)n(ws)g(those)g(memory)544
1910 y(objects)35 b(to)g(be)h(shared)g(among)f(processes.)64
b(F)o(or)36 b(e)o(xample,)h(there)f(is)g(only)f(one)h
Fm(/bin/ls)544 2059 y Fs(memory)24 b(object)g(and)h(its)f(te)o(xt)f
(and)i(data)g(pages)g(are)g(shared)g(by)f(all)h(processes)f(on)h(the)f
(system.)445 2292 y Fr(\017)49 b Fs(Objects)30 b(that)g(are)i(copied)e
(with)g(cop)o(y-on-write)g(use)h(shared)f(read-only)h(pages)g(to)f
(defer)h(the)544 2441 y(cop)o(y)24 b(until)g(the)h(pages)f(are)i
(actually)e(written.)300 2825 y Fg(2.5)143 b(Summary)300
3077 y Fs(In)34 b(this)f(chapter)h(we)g(ha)n(v)o(e)f(re)n(vie)n(wed)g
(the)h(o)o(v)o(erall)e(architecture)j(and)e(operation)g(of)h(the)g(BSD)
h(VM)300 3227 y(system.)d(W)-8 b(e)27 b(introduced)e(the)g(major)h
(data)f(structures)h(and)f(functions,)g(and)h(e)o(xplained)f(in)g
(detail)g(the)300 3376 y(cop)o(y-on-write)f(operation.)31
b(In)25 b(the)f(ne)o(xt)g(chapter)h(we)h(will)d(gi)n(v)o(e)h(an)h(o)o
(v)o(ervie)n(w)e(of)i(the)g(UVM)f(system)300 3525 y(and)h(e)o(xplain)e
(ho)n(w)h(it)h(dif)n(fers)f(from)h(the)f(BSD)i(VM)e(system.)p
eop
%%Page: 36 56
36 55 bop 3800 100 a Fs(36)300 973 y Fp(Chapter)51 b(3)300
1448 y(UVM)h(Ov)n(er)n(view)f(and)h(Related)f(W)-15 b(ork)300
1930 y Fs(A)35 b(computer')-5 b(s)33 b(virtual)h(memory)g(management)g
(hardw)o(are)i(pro)o(vides)d(an)i(operating)f(system)g(with)300
2079 y(a)d(po)n(werful)f(tool)g(for)h(mo)o(ving)e(and)h(sharing)h(data)
f(among)g(processes.)49 b(Ho)n(we)n(v)o(er)l(,)31 b(most)e(Unix-lik)o
(e)300 2229 y(operating)f(systems)f(do)h(not)f(tak)o(e)i(full)e(adv)n
(antage)h(of)h(this)e(tool.)40 b(This)28 b(is)g(due)g(to)g(the)g(e)n(v)
n(olution)e(and)300 2378 y(comple)o(xity)e(of)i(memory)g(management)f
(in)h(Unix-lik)o(e)f(operating)g(system)g([39].)35 b(Early)26
b(v)o(ersions)f(of)300 2527 y(Unix)c(ran)h(on)f(computers)f(that)h(did)
g(not)g(ha)n(v)o(e)g(hardw)o(are)h(support)f(for)h(virtual)e(memory)-6
b(.)28 b(Thus)21 b(Unix')-5 b(s)300 2677 y(I/O)22 b(application)g
(programmer)g(interf)o(ace)h(\(API\))g(w)o(as)g(not)e(designed)h(with)g
(virtual)g(memory)f(in)h(mind)300 2826 y(and)37 b(did)f(not)g(include)g
(features)h(lik)o(e)f(memory)g(mapped)h(\002les)f(and)h(page)g
(remapping.)66 b(Although)300 2976 y(Unix)39 b(w)o(as)h(ported)f(to)h
(computers)f(with)g(hardw)o(are)h(support)f(for)h(virtual)f(memory)g
(in)g(1979,)k(the)300 3125 y Fm(mmap)37 b Fs(system)g(call)h(w)o(as)g
(not)f(commonly)g(a)n(v)n(ailable)g(until)g(the)g(late)h(1980s)f(with)h
(the)f(release)i(of)300 3274 y(SunOS)d(4.)62 b(In)36
b(BSD,)g Fm(mmap)f Fs(w)o(as)g(\002rst)h(scheduled)f(to)g(appear)h(in)f
(4.2BSD)h(b)n(ut)f(did)g(not)g(actually)300 3424 y(appear)26
b(until)e(the)g(1993)h(4.4BSD)g(release)h(when)f(the)g(aging)f(BSD)i(V)
-13 b(AX)25 b(VM)g(system)e(w)o(as)j(replaced)300 3573
y(with)21 b(the)h(system)f(from)g(Mach)h([39,)g(69)o(].)30
b(While)22 b(the)f(ne)n(w)h(Mach-based)g(VM)f(system)g(brought)g(some)
300 3723 y(memory)j(features)h(such)f(as)h Fm(mmap)f
Fs(to)g(BSD,)i(it)e(still)f(did)h(not)h(tak)o(e)f(full)g(adv)n(antage)h
(of)f(the)h(\003e)o(xibility)300 3872 y(that)f(a)h(modern)g(MMU)f(can)h
(of)n(fer)-5 b(.)583 4021 y(W)d(e)34 b(introduce)e(UVM,)h(a)g(ne)n(w)g
(virtual)f(memory)g(subsystem)g(for)h(BSD)h(that)e(mak)o(es)h(better)
300 4171 y(use)g(of)g(e)o(xisting)f(hardw)o(are)i(memory)e(management)g
(features)i(to)f(reduce)g(o)o(v)o(erhead)g(and)g(impro)o(v)o(e)300
4320 y(performance.)52 b(UVM)32 b(pro)o(vides)e(ne)n(w)i(features)g
(that)f(are)i(either)f(not)f(possible,)h(or)g(dif)n(\002cult)f(or)h(e)o
(x-)300 4470 y(pensi)n(v)o(e)j(to)g(achie)n(v)o(e)h(with)f(the)h(old)g
(BSD)h(system.)64 b(UVM)35 b(is)h(implemented)f(entirely)g(within)g
(the)300 4619 y(frame)n(w)o(ork)26 b(of)g(BSD)h(and)f(thus)f(maintains)
g(all)g(the)h(features)h(and)f(standard)g(parts)f(of)i(the)e
(traditional)300 4768 y(Unix)34 b(en)l(vironment)g(that)g(programmers)g
(ha)n(v)o(e)h(come)f(to)h(e)o(xpect.)60 b(The)35 b(\002rst)g(release)g
(of)g(UVM)f(in)300 4918 y(NetBSD)e(runs)f(on)g(se)n(v)o(eral)f
(platforms)g(including)g(I386-PC,)i(DEC)f(Alpha,)h(Sun)g(Sparc,)h
(Motorola)300 5067 y(m68k,)24 b(and)h(DEC)g(V)-13 b(AX)24
b(systems.)29 b(It)c(is)f(already)h(being)g(used)f(on)h(systems)e
(around)i(the)f(w)o(orld.)583 5217 y(In)29 b(this)f(chapter)h(we)g
(present)g(a)g(high-le)n(v)o(el)e(o)o(v)o(ervie)n(w)g(of)i(UVM)f(and)h
(discuss)f(UVM)g(in)g(the)300 5366 y(conte)o(xt)34 b(of)i(related)f(w)o
(ork.)62 b(W)-8 b(e)36 b(be)o(gin)e(by)h(presenting)f(UVM)h(design)f
(goals)h(in)g(Section)g(3.1.)62 b(In)p eop
%%Page: 37 57
37 56 bop 3800 100 a Fs(37)300 249 y(Section)23 b(3.2)g(we)h(e)o
(xamine)e(the)h(ne)n(w)g(and)g(impro)o(v)o(ed)f(features)h(of)h(UVM.)e
(In)i(Section)f(3.3)g(we)g(present)300 398 y(a)28 b(design)f(o)o(v)o
(ervie)n(w)f(that)h(parallels)h(the)f(o)o(v)o(ervie)n(w)f(of)i(BSD)h
(VM)e(from)g(Chapter)i(2.)39 b(In)28 b(Section)f(3.4)300
548 y(we)20 b(discuss)f(related)i(w)o(ork.)29 b(W)-8
b(e)20 b(conclude)g(the)g(chapter)h(with)e(tw)o(o)h(tables)f(that)h
(summarize)g(the)g(UVM)300 697 y(w)o(ork.)30 b(T)-8 b(able)23
b(3.1)g(contains)f(a)i(complete)e(list)g(of)h(functional)g(components)e
(of)i(UVM,)g(corresponding)300 847 y(to)34 b(UVM')-5
b(s)33 b(major)h(source)g(\002les.)59 b(T)-8 b(able)34
b(3.2)g(summarizes)f(the)h(main)f(design)h(points)f(and)h(\223issues)
300 996 y(f)o(aced\224)26 b(while)e(designing)f(and)i(implementing)e
(UVM.)300 1380 y Fg(3.1)143 b(Goals)300 1632 y Fs(Our)19
b(primary)g(objecti)n(v)o(e)e(in)i(creating)g(UVM)f(is)h(to)g(produce)g
(a)g(virtual)g(memory)f(system)g(that)g(pro)o(vides)300
1782 y(a)i(Unix-lik)o(e)e(operating)h(system)f(k)o(ernel')-5
b(s)19 b(I/O)g(and)h(IPC)g(subsystems)e(with)g(ef)n(\002cient)i
(VM-based)f(data)300 1931 y(mo)o(v)o(ement)25 b(f)o(acilities)h(that)h
(ha)n(v)o(e)g(less)g(o)o(v)o(erhead)g(than)f(a)i(traditional)e(data)h
(cop)o(y)-6 b(.)38 b(While)26 b(traditional)300 2080
y(VM)20 b(research)i(often)e(focuses)h(on)f(w)o(orking)g(set)h(size)f
(and)h(page)g(replacement)g(polic)o(y)-6 b(,)19 b(our)i(research)h(is)
300 2230 y(focused)27 b(on)g(ef)n(\002cient)g(VM-based)g(data)g(mo)o(v)
o(ement.)35 b(Unlik)o(e)27 b(man)o(y)f(other)h(VM)g(research)h
(projects,)300 2379 y(our)g(w)o(ork)f(has)h(been)f(implemented)f(as)i
(part)g(of)g(an)f(operating)g(system)g(that)g(is)g(in)h(wide-spread)f
(use.)300 2528 y(Thus,)42 b(we)d(ha)n(v)o(e)f(designed)g(our)h(ne)n(w)g
(virtual)f(memory)g(features)h(so)f(that)h(their)f(presence)i(in)e(the)
300 2678 y(k)o(ernel)31 b(does)f(not)g(disrupt)g(other)h(k)o(ernel)f
(subsystems.)47 b(This)30 b(allo)n(ws)f(e)o(xperimental)h(changes)h(to)
f(be)300 2827 y(introduced)36 b(into)f(the)h(I/O)g(and)h(IPC)g
(subsystem)e(gradually)-6 b(,)38 b(thus)d(easing)h(the)h(adoption)e(of)
h(these)300 2977 y(features.)31 b(Our)25 b(w)o(ork)g(centers)g(around)f
(\002)n(v)o(e)h(major)f(goals:)583 3126 y Fo(Allo)o(w)e(a)h(pr)n(ocess)
g(to)f(safely)g(let)h(a)f(shar)n(ed)i(copy-on-write)g(copy)f(of)f(its)g
(memory)h(be)g(used)300 3275 y(either)37 b(by)g(other)g(pr)n(ocesses,)i
(the)e(I/O)f(system,)i(or)f(the)g(IPC)f(system.)64 b
Fs(The)36 b(mechanism)f(used)300 3425 y(to)29 b(do)f(this)g(should)g
(allo)n(w)g(copied)h(memory)f(to)g(come)h(from)g(a)g(memory)f(mapped)h
(\002le,)h(anon)o(ymous)300 3574 y(memory)-6 b(,)33 b(or)g(a)g
(combination)e(of)i(the)f(tw)o(o.)54 b(It)33 b(should)e(pro)o(vide)h
(copied)g(memory)g(either)g(as)h(wired)300 3724 y(pages)23
b(for)f(the)h(k)o(ernel')-5 b(s)22 b(I/O)g(or)h(IPC)h(subsystems,)d(or)
i(as)f(pageable)h(anon)o(ymous)e(memory)g(for)i(trans-)300
3873 y(fer)j(to)f(another)h(process.)33 b(It)25 b(should)f(gracefully)i
(preserv)o(e)g(cop)o(y-on-write)f(in)g(the)g(presence)h(of)g(page)300
4022 y(f)o(aults,)j(pageouts,)f(and)g(memory)g(\003ushes.)41
b(Finally)-6 b(,)28 b(it)g(should)f(operate)i(in)f(such)g(a)h(w)o(ay)f
(that)g(it)g(pro-)300 4172 y(vides)20 b(access)h(to)e(memory)h(at)g
(page-le)n(v)o(el)g(granularity)f(without)g(fragmenting)g(or)i
(disrupting)d(the)j(VM)300 4321 y(system')-5 b(s)29 b(higher)n(-le)n(v)
o(el)g(memory)h(mapping)g(data)h(structures.)48 b(Section)31
b(7.1)f(describes)h(ho)n(w)f(UVM)300 4471 y(meets)24
b(this)g(goal)h(through)e(the)i(page)g(loanout)f(mechanism.)583
4620 y Fo(Allo)o(w)34 b(pages)g(of)g(memory)g(fr)n(om)h(the)g(I/O)e
(system,)j(the)f(IPC)f(system,)i(or)f(fr)n(om)f(other)300
4769 y(pr)n(ocesses)h(to)f(be)h(inserted)g(easily)e(into)i(a)f(pr)n
(ocess')h(addr)n(ess)g(space.)59 b Fs(Once)34 b(the)g(pages)g(are)h
(in-)300 4919 y(serted)30 b(into)e(the)i(process)f(the)o(y)g(should)g
(become)g(anon)o(ymous)f(memory)-6 b(.)44 b(Such)30 b(anon)o(ymous)e
(mem-)300 5068 y(ory)h(should)f(be)i(indistinguishable)c(from)j(anon)o
(ymous)f(memory)g(allocated)h(by)h(traditional)e(means.)300
5218 y(The)e(mechanism)e(used)h(to)g(do)h(this)e(should)h(be)g(able)h
(to)f(handle)g(pages)h(that)f(ha)n(v)o(e)g(been)h(copied)f(from)300
5367 y(another)i(process')h(address)f(space)h(using)f(the)g(pre)n
(vious)f(mechanism)h(\(page)g(loanout\).)38 b(Also,)28
b(if)f(the)p eop
%%Page: 38 58
38 57 bop 3800 100 a Fs(38)300 249 y(operating)38 b(system)g(is)g(allo)
n(wed)f(to)i(choose)f(the)h(virtual)e(address)i(where)g(the)g(inserted)
f(pages)g(are)300 398 y(placed,)g(then)e(it)f(should)f(be)i(able)g(to)f
(insert)g(them)g(without)g(fragmenting)f(or)i(disrupting)e(the)i(VM)300
548 y(system')-5 b(s)29 b(higher)n(-le)n(v)o(el)g(memory)h(mapping)g
(data)h(structures.)48 b(Section)31 b(7.2)f(describes)h(ho)n(w)f(UVM)
300 697 y(meets)24 b(this)g(goal)h(through)e(the)i(page)g(transfer)g
(mechanism.)583 847 y Fo(Allo)o(w)33 b(pr)n(ocesses)h(and)g(the)g(k)o
(er)o(nel)g(to)g(exchange)g(lar)o(ge)f(chunks)i(of)e(their)h(virtual)g
(ad-)300 996 y(dr)n(ess)i(spaces)g(using)g(the)g(VM)g(system')l(s)f
(higher)l(-le)o(v)o(el)i(memory)e(mapping)h(data)g(structur)n(es.)300
1145 y Fs(Such)31 b(a)h(mechanism)e(should)g(be)h(able)g(to)g(cop)o(y)
-6 b(,)32 b(mo)o(v)o(e,)f(or)g(share)g(an)o(y)g(range)g(of)g(a)h
(virtual)e(address)300 1295 y(space.)48 b(This)29 b(can)i(be)f(a)h
(problem)e(for)i(some)f(VM)g(systems)f(because)h(it)g(introduces)g(the)
g(possibility)300 1444 y(of)e(allo)n(wing)f(a)h(cop)o(y-on-write)g
(area)h(of)f(memory)g(to)f(become)i(shared)f(with)f(another)h(process.)
41 b(The)300 1594 y(per)n(-page)30 b(cost)f(for)h(this)f(mechanism)g
(should)f(be)i(minimized.)43 b(Section)30 b(7.3)f(describes)h(ho)n(w)f
(UVM)300 1743 y(meets)24 b(this)g(goals)g(through)g(the)h(map)f(entry)h
(passing)f(mechanism.)583 1892 y Fo(Optimize)f(the)g(parts)g(of)g(the)g
(VM)f(system)h(that)g(effect)g(the)h(perf)n(ormance)g(and)f(complex-)
300 2042 y(ity)33 b(of)g(our)g(new)h(VM)f(operations.)56
b Fs(W)-8 b(e)33 b(wish)g(to)f(tak)o(e)h(adv)n(antage)g(of)g(lessons)f
(we)h(ha)n(v)o(e)g(learned)300 2191 y(from)i(observing)f(the)i(Mach)f
(based)g(BSD)h(VM)f(system)f(\(and)i(other)f(VM)g(systems\);)k(we)c
(hope)g(to)300 2341 y(mak)o(e)30 b(use)g(of)g(BSD)h(VM')-5
b(s)29 b(positi)n(v)o(e)f(aspects)i(while)f(a)n(v)n(oiding)g(its)g
(pitf)o(alls.)46 b(UVM)29 b(addresses)h(four)300 2490
y(major)24 b(pitf)o(alls)g(of)h(the)g(BSD)g(VM)g(as)g(follo)n(ws:)445
2707 y Fr(\017)49 b Fs(UVM)37 b(eliminates)f(object)h(chaining)f(and)h
(replaces)h(it)f(with)f(a)i(simple)e(tw)o(o-le)n(v)o(el)g(memory)544
2857 y(scheme,)24 b(thus)e(remo)o(ving)g(the)i(inef)n(\002ciencies)f
(and)h(code)g(comple)o(xity)d(associated)j(with)f(main-)544
3006 y(taining)h(and)g(tra)n(v)o(ersing)g(shado)n(w)g(object)g(chains)h
(of)g(arbitrary)g(length.)445 3234 y Fr(\017)49 b Fs(UVM)36
b(eliminates)g(sw)o(ap)g(memory)g(leaks)h(associated)f(with)g
(partially)g(unmapping)f(anon)o(y-)544 3383 y(mous)j(memory)g(objects)g
(by)h(pro)o(viding)e(ef)n(\002cient)i(per)n(-page)h(reference)g
(counters)f(that)f(are)544 3532 y(in)l(v)n(ok)o(ed)24
b(when)h(memory)e(is)i(partially)f(unmapped.)445 3760
y Fr(\017)49 b Fs(UVM)35 b(eliminates)g(unnecessary)h(map)f(entry)h
(fragmentation)f(associated)g(with)g(the)h(wiring)544
3909 y(and)25 b(unwiring)e(of)i(memory)-6 b(.)445 4137
y Fr(\017)49 b Fs(UVM)26 b(introduces)g(a)h(ne)n(w)f(i386)g(pmap)g
(module)f(that)i(tak)o(es)f(adv)n(antage)g(of)h(all)f(the)h(VM)f(hard-)
544 4286 y(w)o(are)32 b(features)g(of)g(the)g(i386)e(\(e.g.)52
b(single)31 b(page)g(TLB)h(\003ush,)i(global)c(TLB)i(entries\))g(and)f
(re-)544 4436 y(duces)25 b(the)f(probability)f(of)i(deadlock)g(and)g
(system)e(crashes.)583 4653 y Fo(Impr)n(o)o(v)o(e)30
b(the)f(secondary)h(elements)f(of)g(the)h(VM)f(system)f(based)i(on)f
(our)g(obser)o(v)o(ations)300 4802 y(of)23 b(UVM)f(and)h(other)h(VM)e
(systems.)30 b Fs(W)-8 b(e)22 b(hope)h(to)f(reduce)h(unnecessary)f
(comple)o(xity)f(and)h(impro)o(v)o(e)300 4952 y(the)30
b(k)o(ernel')-5 b(s)29 b(o)o(v)o(erall)g(performance)i(and)f(design.)45
b(UVM)29 b(features)i(a)f(lar)n(ge)h(number)e(of)h(secondary)300
5101 y(design)23 b(impro)o(v)o(ements)e(that)j(meet)f(this)g(goal.)30
b(F)o(or)24 b(e)o(xample,)f(aggressi)n(v)o(ely)f(clustering)h(anon)o
(ymous)300 5251 y(memory)32 b(for)h(pageout)g(allo)n(ws)f(UVM)g(to)h
(al)o(w)o(ays)f(form)h(the)g(lar)n(gest)g(possible)e(cluster)i(when)g
(pag-)300 5400 y(ing)i(out)g(to)g(sw)o(ap,)j(and)d(clustered)g(pagein)g
(of)h(resident)f(pages)g(reduces)h(application)e(page)i(f)o(aults.)p
eop
%%Page: 39 59
39 58 bop 3800 100 a Fs(39)300 249 y(In)34 b(addition)f(UVM)g
(uni\002es)h(the)f(handling)g(of)h(contiguous)e(and)i(non-contiguous)e
(physical)h(mem-)300 398 y(ory)-6 b(.)44 b(It)29 b(also)g(impro)o(v)o
(es)e(memory)i(object)g(handling)f(by)h(reducing)g(the)g(number)g(of)h
(softw)o(are)f(layers)300 548 y(associated)k(with)g(object)g
(management.)56 b(Chapter)34 b(8)f(details)g(these)h(and)f(other)g
(secondary)h(design)300 697 y(impro)o(v)o(ements.)300
1081 y Fg(3.2)143 b(UVM)35 b(F)l(eatur)m(es)300 1333
y Fs(In)21 b(this)f(section)h(we)g(describe)g(the)g(ne)n(w)g(features)g
(introduced)g(in)f(UVM)h(as)g(well)g(as)g(the)g(e)o(xisting)e(BSD)300
1483 y(features)25 b(that)g(ha)n(v)o(e)f(been)h(signi\002cantly)f
(impro)o(v)o(ed)e(in)j(UVM.)300 1814 y Ff(3.2.1)119 b(New)30
b(F)m(eatur)n(es)300 2031 y Fs(UVM)f(introduces)g(four)g(signi\002cant)
g(ne)n(w)g(features)h(not)f(pro)o(vided)f(by)h(the)g(BSD)i(VM)e
(system.)43 b(T)-8 b(o-)300 2180 y(gether)38 b(these)g(features)g
(reduce)h(the)e(o)o(v)o(erhead)g(associated)h(with)f(mo)o(ving)f(data,)
41 b(thus)c(impro)o(ving)300 2329 y(system)24 b(performance.)32
b(The)25 b(implementation)e(of)i(these)g(features)g(w)o(as)g(made)g
(possible)f(through)g(the)300 2479 y(impro)o(v)o(ed)f(design)h(and)h
(or)n(ganization)e(of)i(UVM.)583 2628 y Fo(P)o(age)f(Loanout.)31
b Fs(UVM)23 b(allo)n(ws)f(pages)i(that)f(are)h(managed)f(by)h(the)f
(virtual)g(memory)f(system)300 2777 y(to)32 b(be)h(used)g(by)g(other)f
(k)o(ernel)h(subsystems)e(as)i(well)f(as)h(other)g(processes.)55
b(Loaned)32 b(out)h(pages)f(are)300 2927 y(shared)37
b(read-only)-6 b(.)68 b(Should)37 b(a)g(process)h(attempt)e(to)h
(change)g(data)h(in)f(a)g(loaned)g(out)g(page)h(UVM)300
3076 y(copies)27 b(the)f(data)h(to)g(a)g(ne)n(w)g(non-loaned)f(page)h
(before)h(allo)n(wing)d(the)i(change.)37 b(An)o(y)26
b(managed)h(page)300 3226 y(in)e(the)g(VM)g(system)g(can)g(be)h(loaned)
f(out,)g(whether)g(it)g(is)g(part)h(of)f(a)h(memory)f(mapped)g(vnode)g
(or)g(part)300 3375 y(of)e(a)h(block)f(of)g(anon)o(ymous)f(memory)g
(allocated)h(with)g Fm(malloc)p Fs(.)29 b(P)o(agers)24
b(need)f(only)g(ha)n(v)o(e)g(minimal)300 3524 y(kno)n(wledge)j(of)i(a)g
(page')-5 b(s)28 b(loanout)e(status)h(to)g(operate.)40
b(The)28 b(BSD)g(VM)g(system)e(has)i(no)f(support)g(for)300
3674 y(page)e(loanout.)583 3823 y(As)j(an)g(e)o(xample)e(of)i(page)g
(loanout')-5 b(s)26 b(usefulness,)h(consider)g(the)g(process)h(of)g
(transmitting)d(a)300 3973 y(disk)i(\002le)h(o)o(v)o(er)e(the)h(netw)o
(ork.)39 b(Before)28 b Fm(mmap)f Fs(w)o(as)h(a)n(v)n(ailable,)f(a)h
(user)f(process)h(w)o(ould)e(ha)n(v)o(e)h(to)h(read)300
4122 y(the)21 b(\002le)h(into)f(its)f(anon)o(ymous)g(memory)g(and)i
(then)f(write)g(it)g(to)g(a)h(sock)o(et.)29 b(This)21
b(process)g(results)g(in)g(tw)o(o)300 4271 y(data)g(copies:)28
b(one)21 b(into)g(the)f(user')-5 b(s)21 b(address)g(space)g(and)g(one)g
(from)g(the)g(user')-5 b(s)21 b(address)g(space)g(into)f(the)300
4421 y(k)o(ernel)27 b(netw)o(orking)f(subsystem')-5 b(s)25
b(mb)n(uf)i(data)g(area.)39 b(W)l(ith)26 b(the)h(adv)o(ent)f(of)i
Fm(mmap)p Fs(,)f(BSD)h(VM)e(users)300 4570 y(could)31
b(reduce)h(the)f(o)o(v)o(erhead)g(of)g(this)f(operation)h(by)g(one)g
(cop)o(y)h(if)f(the)o(y)f(simply)g(memory)h(mapped)300
4720 y(the)37 b(\002le)h(into)f(their)g(address)h(space)g(rather)g
(than)f(read)h(it)f(into)g(anon)o(ymous)e(memory)-6 b(.)68
b(In)38 b(UVM,)300 4869 y(page)24 b(loanout)f(allo)n(ws)f(for)j
(further)f(impro)o(v)o(ements:)j(the)d(process)f(can)i(no)n(w)e
Fm(mmap)g Fs(the)g(\002le)i(and)e(then)300 5018 y(cause)33
b(its)f(pages)h(to)f(be)h(loaned)f(to)h(the)f(netw)o(orking)g
(subsystem,)h(there)g(by)f(eliminating)f(the)h(cop)o(y)300
5168 y(from)c(the)h(memory)e(mapped)h(area)h(to)g(the)f(mb)n(uf)g(data)
g(area.)43 b(When)28 b(the)h(netw)o(orking)e(subsystem)g(is)300
5317 y(\002nished)d(with)f(the)h(pages)g(it)g(will)f(terminate)h(the)g
(loan.)30 b(The)24 b(same)h(loanout)e(scheme)h(can)g(be)h(applied)p
eop
%%Page: 40 60
40 59 bop 3800 100 a Fs(40)300 249 y(to)27 b(de)n(vices)f(as)h(well.)37
b(F)o(or)27 b(e)o(xample,)f(when)h(writing)f(to)h(an)g(audio)f(de)n
(vice,)h(the)g(user')-5 b(s)27 b(b)n(uf)n(fer)g(can)g(be)300
398 y(loaned)e(out)h(to)f(the)g(audio)h(hardw)o(are)g(rather)g(than)g
(copied)f(into)g(an)h(internal)f(k)o(ernel)h(b)n(uf)n(fer)l(,)f(there)h
(by)300 548 y(eliminating)d(one)i(data)f(cop)o(y)-6 b(.)583
697 y Fo(P)o(age)28 b(T)-7 b(ransfer)d(.)39 b Fs(UVM)27
b(allo)n(ws)g(other)g(k)o(ernel)g(subsystems)f(to)h(transfer)h(pages)f
(under)g(their)300 847 y(control)d(to)g(a)i(process')e(normal)g
(virtual)g(memory)-6 b(.)30 b(P)o(age)25 b(transfer)g(is)f(the)h
(opposite)e(of)i(page)g(loanout.)300 996 y(In)36 b(page)g(loanout)f(a)h
(process)g(loans)f(its)h(pages)f(out)h(to)f(the)h(k)o(ernel)g(or)g
(another)g(process.)64 b(In)36 b(page)300 1145 y(transfer)l(,)28
b(a)f(process)f(recei)n(v)o(es)h(pages)f(from)h(the)f(k)o(ernel)h(or)g
(another)g(process.)36 b(P)o(age)27 b(transfer)g(allo)n(ws)300
1295 y(k)o(ernel)21 b(subsystems)d(to)j(read)g(data)g(into)e(pages)i
(and)f(then)h(donate)f(those)g(pages)h(to)f(UVM.)g(This)g(causes)300
1444 y(them)35 b(to)h(become)g(anon)o(ymous)e(memory)h(pages)h(that)g
(can)g(be)g(inserted)g(into)f(a)h(process')g(address)300
1594 y(space)25 b(or)h(into)e(the)h(k)o(ernel')-5 b(s)24
b(address)h(space.)32 b(Thus,)25 b(the)g(netw)o(orking)f(subsystem)f
(could)h(use)h(a)h(page)300 1743 y(for)f(a)f(lar)n(ge)h(mb)n(uf)f(and)g
(then)g(pass)g(that)g(mb)n(uf)g(data)g(area)h(to)f(a)h(process.)30
b(Or)25 b(the)f(audio)g(system,)f(when)300 1892 y(recording,)35
b(could)d(store)h(the)g(recorded)h(data)f(in)g(pages)g(that)f(can)i(be)
f(directly)g(passed)f(to)h(the)g(user)l(,)300 2042 y(without)23
b(a)j(data)e(cop)o(y)-6 b(.)583 2191 y(The)24 b(BSD)g(VM)g(system)e
(has)h(no)h(interf)o(ace)g(for)g(page)f(transfers.)31
b(In)23 b(order)h(to)f(implement)f(this)300 2341 y(in)34
b(the)h(BSD)g(VM)f(one)h(w)o(ould)e(ha)n(v)o(e)i(to)f(write)g(code)h
(to)f(ne)o(gotiate)g(the)g(shado)n(w)g(and)g(cop)o(y)h(object)300
2490 y(chains)26 b(associated)g(with)g(anon)o(ymous)f(memory)h(and)g
(determine)h(the)f(correct)h(object)g(to)f(put)g(the)g(in-)300
2639 y(bound)c(page)h(into)f(while)g(being)h(careful)g(to)g(a)n(v)n
(oid)f(interfering)h(with)f(objects)g(that)g(are)i(in)f(the)f(process)
300 2789 y(of)j(being)f(collapsed)g(or)h(are)h(currently)e(lock)o(ed.)
583 2938 y Fo(Map)38 b(Entry)h(P)o(assing)o(.)67 b Fs(UVM)37
b(allo)n(ws)f(processes)h(and)h(the)f(k)o(ernel)g(to)g(dynamically)f(e)
o(x-)300 3088 y(change)26 b(virtual)e(memory)h(address)g(space.)33
b(The)26 b(address)f(space)h(can)g(contain)f(an)o(y)g(number)g(of)g
(map-)300 3237 y(pings)j(and)h(can)g(be)g(dynamically)f(shared)h(with,)
g(or)h(copied)e(or)h(donated)g(to)f(other)h(processes)g(or)g(the)300
3386 y(k)o(ernel.)49 b(This)30 b(allo)n(ws)g(processes)h(to)f(easily)h
(pass)f(virtual)g(memory)g(between)h(themselv)o(es)f(without)300
3536 y(cop)o(ying)23 b(data.)30 b(This)23 b(can)i(be)e(a)i(useful)e
(substitute)f(for)i(a)g(Unix)f(pipe)h(when)f(lar)n(ge)h(chunks)g(of)f
(data)h(are)300 3685 y(being)g(e)o(xchanged.)583 3835
y(The)30 b(BSD)h(VM)f(system)f(does)g(not)h(support)e(map)i(entry)g
(passing.)45 b(Memory)29 b(e)o(xchange)h(be-)300 3984
y(tween)f(processes)g(is)g(limited)f(to)h(the)g(cop)o(ying)f(and)h
(sharing)g(that)g(happens)g(when)g(a)g(process)g(forks.)300
4133 y(Some)d(v)o(ersions)e(of)h(BSD)i(do,)e(ho)n(we)n(v)o(er)l(,)g
(support)f(the)i(Unix)f(System)g(V)g(shared)h(memory)f(interf)o(ace.)
300 4283 y(This)32 b(interf)o(ace)h(can)g(be)g(used)g(by)f(a)h(process)
g(to)f(preallocate)h(a)g(contiguous)e(block)h(of)h(anon)o(ymous)300
4432 y(memory)27 b(and)i(then)e(allo)n(w)h(other)g(processes)g(to)f
(attach)i(to)e(it.)41 b(While)28 b(useful,)g(this)f(interf)o(ace)i(is)f
(lim-)300 4581 y(ited)f(when)h(compared)f(to)h(UVM')-5
b(s)26 b(map)i(entry)f(passing.)39 b(System)27 b(V)h(shared)g(memory)e
(only)h(allo)n(ws)300 4731 y(processes)33 b(access)g(to)g(one)g
(contiguous)f(block)g(of)h(memory)-6 b(,)34 b(and)f(processes)g
(attaching)f(to)h(it)f(must)300 4880 y(share)25 b(it)f(\(e.g.)31
b(the)o(y)24 b(can')n(t)i(get)e(a)h(cop)o(y-on-write)g(cop)o(y)f(of)h
(it\).)583 5030 y(Map)30 b(entry)h(passing)e(also)h(allo)n(ws)f(a)h
(process)g(to)g(grant)g(another)g(unrelated)g(process)h(access)300
5179 y(to)g(only)g(part)g(of)h(a)f(\002le.)51 b(In)32
b(traditional)e(Unix,)i(if)f(a)h(\002le)g(descriptor)f(is)g(passed)g
(to)g(another)g(process)300 5328 y(using)22 b(\002le)h(descriptor)f
(passing,)f(then)i(the)f(recei)n(ving)g(process)g(gets)h(access)g(to)f
(the)g(entire)h(\002le)g(at)f(what)p eop
%%Page: 41 61
41 60 bop 3800 100 a Fs(41)300 249 y(e)n(v)o(er)28 b(permission)g(the)g
(\002le)i(descriptor)e(allo)n(ws.)42 b(The)29 b(only)f(w)o(ay)h(to)f
(pass)h(partial)g(access)g(of)g(a)g(\002le)g(to)300 398
y(another)23 b(process)g(is)g(to)f(open)h(the)g(\002le,)h
Fm(mmap)e Fs(in)h(the)g(part)g(of)g(the)g(\002le)h(to)f(be)g(accessed,)
h(close)f(the)g(\002le,)300 548 y(and)30 b(then)g(fork)g(a)g(child)f
(process)h(that)f(only)h(has)f(access)i(to)f(the)f(part)h(of)g(the)g
(\002le)g(that)g(w)o(as)g(memory)300 697 y(mapped.)583
847 y(Using)38 b(UVM')-5 b(s)37 b(map)h(entry)h(passing,)h(an)o(y)e
(process)h(can)g(memory)e(map)h(a)h(part)f(of)h(a)g(\002le)300
996 y(and)31 b(then)g(of)n(fer)g(to)g(send)g(that)f(mapping)g(to)h
(other)g(processes.)49 b(This)31 b(could)f(be)h(useful)g(in)g(allo)n
(wing)300 1145 y(processes)25 b(access)g(to)f(only)g(a)i(page-sized)f
(section)f(of)h(a)g(database,)g(for)g(e)o(xample.)583
1295 y Fo(P)o(artial)38 b(Deallocation.)69 b Fs(In)38
b(the)g(BSD)h(VM)e(when)h(a)g(block)g(of)g(anon)o(ymous)d(memory)j(is)
300 1444 y(mapped)c(the)g(VM)h(map)f(gets)g(a)h(reference)h(to)e(an)h
(anon)o(ymous)d(VM)i(object)g(that)g(backs)h(the)f(map-)300
1594 y(ping.)44 b(If)30 b(the)g(process)f(deallocates)h(\(i.e.)45
b(unmaps\))29 b(a)g(part)h(of)g(the)f(mapping)g(then)g(the)g(reference)
i(to)300 1743 y(the)g(backing)g(object)g(is)g(brok)o(en)g(up)g(into)f
(multiple)f(references,)35 b(and)c(the)g(reference)i(to)e(the)g(area)h
(of)300 1892 y(memory)26 b(being)h(released)g(is)g(dropped.)37
b(Unfortunately)-6 b(,)26 b(the)h(BSD)h(VM)f(has)g(no)g(w)o(ay)g(of)g
(telling)f(the)300 2042 y(backing)f(object)g(that)f(part)h(of)h(its)e
(memory)h(is)f(no)h(longer)g(in)g(use)g(and)g(should)f(be)i(freed.)32
b(As)25 b(a)h(result,)300 2191 y(the)j(memory)f(remains)g(in)g(the)h
(object)f(although)g(it)g(is)g(no)h(longer)f(accessible.)43
b(This)28 b(can)h(result)f(in)h(a)300 2341 y(sw)o(ap)f(memory)g(leak)h
(condition.)41 b(This)28 b(is)g(currently)g(not)g(a)h(problem)f(in)g
(BSD)i(because)f(most)e(BSD)300 2490 y(programs)d(use)h(the)g
(traditional)f Fm(malloc)g Fs(that)h(allocates)f(memory)h(of)n(f)g(the)
g(heap)g(rather)g(than)g(using)300 2639 y(anon)o(ymous)20
b(memory)i(mapping)f(for)h(memory)g(allocation.)29 b(Ho)n(we)n(v)o(er)l
(,)21 b(due)h(to)g(increased)h(\003e)o(xibility)300 2789
y(memory-mapped)34 b(user)n(-memory)h(allocators)f(are)i(becoming)f
(more)g(common)f(so)h(this)f(could)h(be-)300 2938 y(come)25
b(a)g(problem.)30 b(UVM)25 b(can)g(handle)f(the)h(partial)g
(deallocation)f(of)h(anon)o(ymous)d(memory)j(without)300
3088 y(an)o(y)f(sw)o(ap)h(space)g(leaks.)300 3419 y Ff(3.2.2)119
b(Impr)n(o)o(v)o(ed)29 b(F)m(eatur)n(es)300 3635 y Fs(There)h(are)g(a)g
(number)g(of)f(BSD)i(VM)e(features)h(that)f(ha)n(v)o(e)h(been)f
(signi\002cantly)g(impro)o(v)o(ed)e(in)j(UVM.)300 3785
y(Some)25 b(of)g(the)f(more)h(interesting)f(impro)o(v)o(ements)e(are)j
(listed)f(belo)n(w)-6 b(.)583 3934 y Fo(Simpli\002ed)37
b(Copy-on-write.)65 b Fs(In)36 b(UVM)f(the)h(management)f(of)h(cop)o
(y-on-write)f(memory)300 4084 y(has)h(been)g(greatly)f(simpli\002ed.)62
b(The)36 b(BSD)h(VM')-5 b(s)35 b(shado)n(w)f(and)i(cop)o(y)g(object)f
(chains)g(ha)n(v)o(e)h(been)300 4233 y(replaced)27 b(with)f(a)h(simple)
e(tw)o(o-le)n(v)o(el)g(scheme)h(based)h(on)f(page)h(reference)h
(counters.)35 b(As)27 b(a)f(result)g(all)300 4382 y(the)31
b(BSD)h(VM)e(code)h(needed)h(to)e(manage)h(and)g(collapse)f(shado)n(w)g
(and)h(cop)o(y)g(object)g(chains)f(is)h(not)300 4532
y(necessary)f(in)f(UVM.)h(This)f(simpli\002es)f(the)i(page)g(f)o(ault)f
(routine)g(and)h(eliminates)e(a)i(lar)n(ge)h(chunk)e(of)300
4681 y(the)c(object)f(management)g(code.)583 4830 y Fo(Cluster)n(ed)33
b(anonymous)e(memory)g(pageout.)49 b Fs(UVM)30 b(supports)g(the)h
(clustering)e(of)i(I/O)g(at)300 4980 y(all)26 b(le)n(v)o(els.)35
b(By)28 b(storing)d(data)i(in)f(a)h(lar)n(ge)g(contiguous)f(area)h(of)g
(backing)f(store,)h(multiple)e(I/O)i(paging)300 5129
y(operations)j(can)h(be)f(\223clustered\224)h(into)f(a)h(single)e
(lager)i(I/O)f(operation.)48 b(One)30 b(place)h(where)g(UVM')-5
b(s)300 5279 y(I/O)24 b(clustering)f(really)h(pays)g(of)n(f)f(is)h(in)g
(the)g(pageout)f(of)h(anon)o(ymous)e(memory)h(to)h(sw)o(ap.)30
b(In)24 b(the)g(BSD)p eop
%%Page: 42 62
42 61 bop 3800 100 a Fs(42)300 249 y(VM,)30 b(anon)o(ymous)f(memory)h
(is)g(statically)g(assigned)f(to)i(an)g(area)g(of)g(sw)o(ap)g(based)f
(on)h(the)f(object)g(in)300 398 y(which)23 b(it)g(li)n(v)o(es.)29
b(Once)24 b(a)g(section)e(of)i(an)g(anon)o(ymous)d(object)j(is)f
(assigned)f(to)i(an)f(area)i(of)f(sw)o(ap)f(it)g(will)300
548 y(al)o(w)o(ays)j(be)g(sw)o(apped)g(out)f(to)h(that)g(location)f
(\(as)h(long)g(as)g(the)g(object)f(is)h(still)f(acti)n(v)o(e\).)34
b(Thus)25 b(memory)300 697 y(assigned)37 b(to)h(dif)n(ferent)g(objects)
g(will)f(not)h(be)g(contiguous)f(and)h(must)f(be)h(paged)g(out)g(in)g
(multiple)300 847 y(operations.)583 996 y(UVM)31 b(tak)o(es)f(adv)n
(antage)h(of)f(the)h(f)o(act)g(that)f(anon)o(ymous)f(memory)h(that)g
(needs)h(to)f(be)h(paged)300 1145 y(out)g(can)h(be)f(paged)h(to)f(an)o
(y)g(part)g(of)h(the)f(sw)o(ap)h(area)g(and)g(collects)e(anon)o(ymous)g
(pages)h(together)g(so)300 1295 y(that)j(it)h(can)g(perform)g(one)g
(big)f(pageout)h(I/O)f(operation.)61 b(As)34 b(a)i(result)e(when)h
(memory)f(is)g(scarce,)300 1444 y(anon)o(ymous)c(memory)h(can)h(be)f
(paged)h(out)f(much)g(f)o(aster)i(in)e(UVM)g(than)g(BSD)i(VM,)e(thus)g
(making)300 1594 y(the)25 b(reco)o(v)o(ery)f(time)g(for)h(scarce)h
(memory)e(much)g(shorter)-5 b(.)583 1743 y Fo(Impr)n(o)o(v)o(ed)33
b(page)f(wiring)o(.)50 b Fs(Data)32 b(is)f(said)g(to)g(be)h(wired)f(if)
h(it)f(resides)g(in)h(a)f(page)h(that)f(is)g(set)300
1892 y(to)26 b(al)o(w)o(ays)f(be)i(resident)e(in)h(memory)-6
b(.)33 b(Thus,)26 b(the)f(access)i(time)e(for)i(wired)f(memory)f(is)g
(al)o(w)o(ays)h(small)300 2042 y(because)h(the)f(VM)g(system)f(ne)n(v)o
(er)h(has)h(to)f(w)o(ait)g(for)g(the)h(pager)f(to)g(do)h(I/O)f(from)g
(backing)g(store)g(since)300 2191 y(the)35 b(data)f(is)h(al)o(w)o(ays)f
(resident.)60 b(In)35 b(both)f(BSD)i(VM)e(and)h(UVM)f(the)g(wired)h
(status)f(of)h(memory)f(is)300 2341 y(stored)g(in)f(tw)o(o)g(places.)59
b(Each)34 b(map)f(entry)h(has)g(a)g(wiring)f(attrib)n(ute)g(that)h
(indicates)f(that)h(all)f(pages)300 2490 y(mapped)25
b(by)g(that)g(entry)g(should)f(be)h(wired.)32 b(Also,)25
b(each)g(page)h(of)f(memory)g(has)g(a)g(wiring)g(count)g(that)300
2639 y(if)h(non-zero)f(indicates)g(that)h(some)f(process)g(or)h(the)f
(k)o(ernel)h(needs)g(that)f(page)h(of)f(memory)g(to)g(remain)300
2789 y(resident)f(at)h(all)g(times.)583 2938 y(Since)g(the)f(attrib)n
(utes)g(\227)g(including)e(the)i(wired)h(status)e(\227)h(contained)g
(in)g(a)g(map)g(entry)g(struc-)300 3088 y(ture)e(apply)g(to)g(all)g
(pages)h(mapped)f(by)g(the)g(entry)-6 b(,)22 b(changing)g(the)g(wiring)
g(of)g(a)h(single)f(page)g(will)g(cause)300 3237 y(the)30
b(map)f(entry)h(to)f(be)h(brok)o(en)g(up)g(into)f(tw)o(o)g(or)h(three)g
(map)g(entry)f(structures,)i(each)f(with)f(dif)n(ferent)300
3386 y(wiring)c(counts.)31 b(This)25 b(can)g(lead)h(to)f(map)g(entry)g
(fragmentation,)f(which)h(is)g(inef)n(\002cient)g(because)g(map)300
3536 y(entries)i(are)h(stored)g(on)f(a)h(link)o(ed)e(list)h(and)g(each)
h(time)f(a)h(map)f(entry)g(is)g(fragmented)h(it)f(increases)g(the)300
3685 y(time)e(it)g(tak)o(es)h(to)f(search)i(the)e(list)g(for)h(a)g
(mapping.)33 b(UVM)25 b(includes)g(impro)o(v)o(ements)e(that)j(attempt)
e(to)300 3835 y(a)n(v)n(oid)g(fragmenting)g(map)h(structures)f(in)g(se)
n(v)o(eral)g(common)g(wiring)g(cases,)h(thus)f(reducing)g(mapping)300
3984 y(fragmentation)g(and)h(the)f(o)o(v)o(erhead)g(associated)h(with)f
(it.)583 4133 y Fo(Ef\002cient)35 b(tra)n(v)o(ersal.)53
b Fs(Both)33 b(the)f(BSD)h(VM)g(system)e(and)i(UVM)f(ha)n(v)o(e)g(se)n
(v)o(eral)g(structures)300 4283 y(that)26 b(can)g(be)h(tra)n(v)o(ersed)
f(in)f(more)h(than)g(one)g(w)o(ay)-6 b(.)35 b(F)o(or)26
b(e)o(xample,)f(the)h(pages)h(in)e(a)i(VM)f(object)f(are)i(on)300
4432 y(both)22 b(a)g(link)o(ed)g(list)f(and)h(in)g(a)h(hash)f(table.)30
b(BSD)23 b(VM)f(only)f(tra)n(v)o(erses)h(data)h(structures)e(in)h(one)h
(w)o(ay)-6 b(.)29 b(In)300 4581 y(UVM)23 b(the)g(code)h(dynamically)e
(chooses)h(which)h(style)e(of)i(tra)n(v)o(ersal)f(w)o(ould)g(ha)n(v)o
(e)g(less)g(o)o(v)o(erhead)g(and)300 4731 y(uses)e(that)f(style)g(of)i
(tra)n(v)o(ersal.)29 b(F)o(or)21 b(e)o(xample,)f(when)h(remo)o(ving)f
(a)h(single)f(page)h(from)g(a)g(one-hundred-)300 4880
y(page)g(object,)h(it)e(mak)o(es)h(sense)g(to)g(use)g(the)g(hash)g
(table.)29 b(But)21 b(when)g(remo)o(ving)f(all)g(one)h(hundred)g(pages)
300 5030 y(from)27 b(the)f(object)h(it)f(mak)o(es)g(better)h(sense)g
(to)f(use)h(the)f(link)o(ed)g(list.)36 b(UVM)26 b(compares)h(the)g
(size)f(of)h(the)300 5179 y(area)g(being)f(tra)n(v)o(ersed)g(with)g
(the)g(total)f(number)h(of)g(pages)h(in)e(the)i(object)f(to)f(decide)i
(ho)n(w)e(to)h(tra)n(v)o(erse)300 5328 y(it.)p eop
%%Page: 43 63
43 62 bop 3800 100 a Fs(43)583 249 y Fo(Reduced)29 b(lock)e(time)g
(during)g(unmap.)38 b Fs(T)-8 b(w)o(o)26 b(operations)g(must)f(be)i
(performed)g(to)f(remo)o(v)o(e)300 398 y(mappings)19
b(from)i(an)g(address)g(space.)30 b(First,)21 b(one)g(or)g(more)g(map)f
(entries)h(are)h(remo)o(v)o(ed)d(from)i(the)g(map,)300
548 y(and)32 b(second,)h(the)f(memory)f(objects)g(referenced)i(by)e
(the)h(map)f(entries)h(are)g(dropped.)52 b(In)32 b(the)f(BSD)300
697 y(VM,)23 b(the)h(VM)f(system)f(locks)h(the)h(map)f(for)h(both)f(of)
h(these)f(operations.)30 b(Ho)n(we)n(v)o(er)l(,)22 b(this)h(is)g(not)g
(really)300 847 y(necessary)-6 b(.)37 b(The)27 b(map)g(only)f(needs)h
(to)g(be)g(lock)o(ed)g(when)g(the)g(map)f(entry)h(data)g(structures)g
(are)h(being)300 996 y(changed,)d(not)f(when)h(memory)f(object)g
(references)i(are)g(being)e(dropped.)583 1145 y(UVM)k(restructures)g
(the)f(unmapping)g(functions)f(in)i(such)f(a)i(w)o(ay)f(that)f(these)h
(tw)o(o)f(functions)300 1295 y(are)20 b(separated)g(and)g(the)g(map)f
(can)h(be)g(unlock)o(ed)f(during)g(the)g(reference)j(drop.)28
b(This)19 b(is)g(useful)h(because)300 1444 y(if)31 b(the)g(unmap)f
(drops)g(the)h(last)f(reference)j(to)d(a)h(memory)f(object)h(it)f(may)h
(cause)g(the)g(object')-5 b(s)30 b(pager)300 1594 y(to)g(perform)h(I/O)
g(\(possibly)e(synchronous\))g(as)i(part)g(of)f(a)h(cleanup)g
(operation.)48 b(Since)31 b(that)f(I/O)h(can)300 1743
y(tak)o(e)25 b(a)g(while,)g(in)f(the)h(BSD)h(VM)f(the)f(map)h(that)g
(is)f(being)h(unmapped)f(w)o(ould)g(be)h(lock)o(ed)g(throughout)300
1892 y(the)32 b(I/O)g(operation.)51 b(Ho)n(we)n(v)o(er)l(,)32
b(in)g(UVM)f(the)h(map)f(is)h(unlock)o(ed)f(and)h(can)g(be)g(accessed)h
(by)e(other)300 2042 y(processes)25 b(or)g(the)f(k)o(ernel)h(as)g
(needed.)31 b(The)25 b(I/O)f(will)g(not)h(block)f(access)h(to)g(the)f
(map.)300 2422 y Fg(3.3)143 b(High-Le)n(v)o(el)33 b(Design)h(Ov)o(er)o
(view)300 2674 y Fs(This)f(section)g(contains)g(a)h(high-le)n(v)o(el)e
(design)h(o)o(v)o(ervie)n(w)f(of)h(UVM.)h(Lik)o(e)f(the)g(BSD)i(VM)e
(system,)300 2824 y(UVM)26 b(is)f(di)n(vided)g(into)g(tw)o(o)h(layers:)
33 b(the)26 b(machine-dependent)f(and)h(machine-independent)f(layers.)
300 2973 y(The)i(machine-dependent)f(layer)h(of)g(UVM)f(is)h(almost)e
(identical)i(to)f(the)h(machine-dependent)f(layer)300
3123 y(of)32 b(BSD)h(VM.)e(This)g(allo)n(ws)g(BSD)h(VM)g(pmap)f
(modules)g(to)g(be)h(used)g(by)f(UVM)h(with)f(only)g(minor)300
3272 y(changes.)300 3600 y Ff(3.3.1)119 b(UVM')l(s)29
b(Machine-Independent)k(Lay)o(er)300 3816 y Fs(The)26
b(high-le)n(v)o(el)f(functions)g(of)h(the)h(VM)e(system)h(are)h
(handled)f(by)g(the)g(machine-independent)f(layer)300
3966 y(of)i(UVM.)e(The)i(acti)n(vities)e(of)h(the)g
(machine-independent)g(layer)g(are)i(centered)f(around)f(eight)g(major)
300 4115 y(machine-independent)32 b(data)h(structures)1778
4079 y Fj(1)1815 4115 y Fs(.)56 b(While)33 b(UVM)g(has)g(more)g(major)f
(data)i(structures)e(than)300 4265 y(BSD)e(VM,)f(UVM')-5
b(s)29 b(data)h(structures)f(are)h(generally)f(smaller)g(and)h(used)f
(in)g(a)h(less)f(comple)o(x)f(w)o(ays.)300 4414 y(The)d(UVM)f(data)h
(structures)f(are:)300 4628 y Fd(vmspace)p Fo(:)47 b
Fs(describes)31 b(a)g(virtual)e(address)i(space)g(of)f(a)h(process.)48
b(The)31 b Fm(vmspace)e Fs(structure)h(con-)544 4777
y(tains)e(pointers)f(to)h(a)h(process')g Fm(vm)p 1776
4777 30 4 v 35 w(map)f Fs(and)h Fm(pmap)f Fs(structures,)g(and)h
(contains)f(statistics)e(on)544 4926 y(the)f(process')f(memory)g
(usage.)p 300 5010 1440 4 v 416 5071 a Fi(1)449 5101
y Fh(UVM)g(data)g(structures)f(are)g(called)h(\223)p
Fe(vm)p 1667 5101 25 4 v 29 w Fh(\224)g(if)g(the)o(y)f(are)g(either)g
(ne)n(w)h(or)f(if)h(the)o(y)f(are)g(minor)g(modi\002cations)f(to)i(BSD)
300 5201 y(VM)e(data)f(structures.)28 b(UVM)22 b(data)g(structures)f
(are)g(called)g(\223)p Fe(uvm)p 2246 5201 V 30 w Fh(\224)g(if)h(there)f
(is)i(a)f(corresponding)c(\223)p Fe(vm)p 3366 5201 V
29 w Fh(\224)k(data)g(structure)300 5300 y(in)28 b(BSD)h(VM)f(that)g
(is)g(completely)e(dif)n(ferent)h(from)f(the)i Fe(uvm)p
2165 5300 V 58 w Fh(one.)47 b(Once)27 b(UVM)h(no)f(longer)g(has)h(to)g
(co-e)o(xist)f(in)h(the)300 5400 y(source)19 b(tree)i(with)f(BSD)h(VM)g
(then)e(the)i(data)f(structures)f(will)i(be)f(renamed)f(so)h(that)h
(the)o(y)e(are)h(more)g(uniform.)p eop
%%Page: 44 64
44 63 bop 3800 100 a Fs(44)300 249 y Fd(vm)p 426 249
30 4 v 35 w(map)p Fo(:)49 b Fs(describes)30 b(the)h(virtual)e(address)i
(space)g(of)g(a)g(process)f(or)h(the)f(k)o(ernel.)49
b(It)30 b(contains)g(a)h(list)544 398 y(of)26 b Fm(vm)p
779 398 V 36 w(map)p 995 398 V 35 w(entry)g Fs(structures)g(that)g
(describe)g(v)n(alid)g(mappings)f(and)h(their)g(attrib)n(utes.)35
b(The)544 548 y Fm(vm)p 670 548 V 35 w(map)25 b Fs(plays)f(the)g(same)h
(role)g(in)f(both)g(BSD)i(VM)e(and)h(UVM.)300 780 y Fd(uvm)p
486 780 V 35 w(object)p Fo(:)48 b Fs(forms)38 b(the)h(lo)n(wer)g(layer)
g(of)h(UVM')-5 b(s)38 b(tw)o(o-layer)h(mapping)f(scheme.)73
b(A)40 b(UVM)544 930 y(object)23 b(describes)h(a)g(\002le,)g(a)g
(zero-\002ll)g(memory)f(area,)i(or)f(a)g(de)n(vice)f(that)h(can)g(be)g
(mapped)f(into)g(a)544 1079 y(virtual)j(address)h(space.)38
b(The)27 b Fm(uvm)p 1809 1079 V 35 w(object)f Fs(contains)h(a)g(list)f
(of)h Fm(vm)p 3040 1079 V 36 w(page)f Fs(structures)h(that)544
1228 y(contain)f(data)h(from)f(that)g(object.)36 b(Unlik)o(e)26
b(VM)g(objects,)h(UVM)f(objects)g(are)h(not)f(chained)h(for)544
1378 y(cop)o(y-on-write.)300 1610 y Fd(vm)p 426 1610
V 35 w(amap)p Fo(:)48 b Fs(forms)27 b(the)h(upper)f(layer)h(of)g(UVM')
-5 b(s)26 b(tw)o(o-layer)h(mapping)g(scheme.)38 b(A)28
b Fm(vm)p 3477 1610 V 35 w(amap)f Fs(de-)544 1760 y(scribes)j(an)h
(area)h(of)f(anon)o(ymous)e(memory)-6 b(.)48 b(The)30
b(area)i(may)f(ha)n(v)o(e)f(\223holes\224)h(in)f(it)h(that)f(allo)n(w)
544 1909 y(references)c(to)e(the)h(lo)n(wer)f(underlying)g(object)g
(layer)-5 b(.)300 2141 y Fd(vm)p 426 2141 V 35 w(anon)p
Fo(:)48 b Fs(describes)33 b(a)g(single)f(virtual)g(page)h(of)g(anon)o
(ymous)e(memory)-6 b(.)53 b(The)33 b(page')-5 b(s)33
b(data)f(may)544 2291 y(reside)24 b(in)f(a)i Fm(vm)p
1102 2291 V 35 w(page)e Fs(structure,)h(or)g(it)g(may)f(be)i(paged)f
(out)f(to)h(backing)f(store)h(\(i.e.)30 b(the)24 b(sw)o(ap)544
2440 y(area\).)300 2673 y Fd(vm)p 426 2673 V 35 w(aref)p
Fo(:)48 b Fs(a)33 b(small)f(data)g(structure)g(that)g(points)g(to)g(a)g
Fm(vm)p 2452 2673 V 36 w(amap)g Fs(and)g(an)h(of)n(fset)e(in)i(it.)53
b(The)32 b(aref)544 2822 y(structure)24 b(is)h(part)g(of)f(the)h(map)g
(entry)f(structure)h(that)f(is)g(link)o(ed)g(to)h(the)f
Fm(vm)p 3156 2822 V 36 w(map)g Fs(structure.)300 3054
y Fd(uvm)p 486 3054 V 35 w(pagerops)p Fo(:)47 b Fs(a)33
b(set)g(of)g(functions)e(pointed)h(to)g(by)h(a)g Fm(uvm)p
2653 3054 V 35 w(object)f Fs(that)g(describe)h(ho)n(w)e(to)544
3204 y(access)26 b(backing)f(store.)31 b(In)26 b(the)f(BSD)h(VM)f
(there)h(is)e(one)i Fm(vm)p 2688 3204 V 35 w(pager)e
Fs(structure)h(per)h(memory)544 3353 y(object)k(that)h(accesses)g
(backing)f(store,)i(and)f(each)h Fm(vm)p 2479 3353 V
35 w(pager)e Fs(structure)g(points)g(to)g(a)h(set)g(of)544
3503 y(pager)19 b(operations.)28 b(In)19 b(UVM)g(the)g
Fm(vm)p 1874 3503 V 35 w(pager)f Fs(layer)h(has)g(been)g(remo)o(v)o(ed)
f(and)h Fm(uvm)p 3512 3503 V 35 w(object)544 3652 y Fs(structures)24
b(no)n(w)g(point)g(directly)g(to)h(a)g Fm(uvm)p 2067
3652 V 35 w(pagerops)e Fs(structure.)300 3884 y Fd(vm)p
426 3884 V 35 w(page)p Fo(:)48 b Fs(describes)28 b(a)g(page)f(of)h
(physical)e(memory)-6 b(.)38 b(When)27 b(the)g(system)g(is)g(booted)g
(a)g Fm(vm)p 3631 3884 V 36 w(page)544 4034 y Fs(structure)f(is)g
(allocated)h(for)g(each)g(page)g(of)g(physical)e(memory)h(that)g(can)h
(be)g(used)g(by)f(the)h(VM)544 4183 y(system.)583 4416
y(Figure)37 b(3.1)e(illustrates)g(the)h(general)g(layout)f(of)i(the)e
(UVM)h(data)g(structures.)64 b(The)36 b(k)o(ernel)300
4565 y(and)29 b(each)g(process)g(on)f(the)h(system)e(ha)n(v)o(e)i(a)g
Fm(vm)p 2009 4565 V 35 w(map)f Fs(structure)h(and)g(a)g
(machine-dependent)f(pmap)300 4714 y(structure)d(that)g(de\002ne)h(a)g
Fm(vmspace)p Fs(.)31 b(The)26 b Fm(vm)p 1971 4714 V 35
w(map)f Fs(structure)g(contains)g(a)g(list)g(of)g(map)g(entries)h(that)
300 4864 y(de\002ne)35 b(mapped)f(areas)i(in)e(the)h(virtual)e(address)
i(space.)61 b(Each)34 b(map)h(entry)f(structure)h(de\002nes)g(tw)o(o)
300 5013 y(le)n(v)o(els)d(of)i(memory)-6 b(.)57 b(The)34
b(map)f(entry)h(has)g(a)g Fm(vm)p 2092 5013 V 36 w(aref)f
Fs(structure)g(that)h(points)e(to)i(the)f Fm(vm)p 3631
5013 V 36 w(amap)300 5163 y Fs(structure)24 b(that)f(de\002nes)i(the)f
(top-le)n(v)o(el)e(memory)h(for)i(that)e(entry)-6 b(.)30
b(The)24 b Fm(vm)p 2902 5163 V 36 w(amap)f Fs(structure)h(contains)300
5312 y(a)38 b(list)f(of)h Fm(vm)p 789 5312 V 36 w(anon)f
Fs(structures)g(that)g(de\002ne)i(the)f(anon)o(ymous)e(memory)h(in)g
(the)h(top)f(layer)-5 b(.)70 b(The)p eop
%%Page: 45 65
45 64 bop 3800 100 a Fs(45)300 249 y Fm(vm)p 426 249
30 4 v 35 w(anon)26 b Fs(structure)h(identi\002es)f(the)h(location)e
(of)i(its)f(memory)g(with)g(a)h(pointer)f(to)h(a)g Fm(vm)p
3461 249 V 35 w(page)f Fs(and)300 398 y(a)k(location)g(on)f(the)h(sw)o
(ap)g(area)h(where)g(paged)f(out)g(data)g(may)f(reside.)47
b(The)30 b(map)g(entry)g(de\002nes)g(the)300 548 y(lo)n(wer)n(-le)n(v)o
(el)20 b(memory)g(with)h(a)h(pointer)e(to)h(a)h Fm(uvm)p
2039 548 V 35 w(object)e Fs(pointer)-5 b(.)29 b(The)21
b Fm(uvm)p 3142 548 V 35 w(object)f Fs(structure)300
697 y(contains)k(a)h(list)f(of)h Fm(vm)p 1107 697 V 35
w(page)f Fs(structures)g(that)h(belong)f(to)g(it,)g(and)h(a)g(pointer)f
(to)g(a)i Fm(uvm)p 3393 697 V 35 w(pagerops)300 847 y
Fs(structure)e(that)h(describes)f(ho)n(w)g(the)h(object)f(can)i
(communicate)d(with)h(backing)h(store.)583 996 y(The)h
Fm(vm)p 890 996 V 35 w(page)f Fs(structures)g(are)h(k)o(ept)g(in)f(tw)o
(o)g(additional)f(sets)h(of)h(data)f(structures:)32 b(the)25
b(page)300 1145 y(queues)f(and)h(the)f(object-of)n(fset)g(hash)h
(table.)30 b(UVM)24 b(has)h(three)g(page)f(queues:)31
b(the)24 b(acti)n(v)o(e)g(queue,)g(the)300 1295 y(inacti)n(v)o(e)g
(queue,)g(and)h(the)g(free)h(queue.)31 b(P)o(ages)25
b(that)g(contain)f(v)n(alid)g(data)h(and)g(are)h(lik)o(ely)e(to)g(be)i
(in)e(use)300 1444 y(by)30 b(a)h(process)f(or)g(the)g(k)o(ernel)g(are)h
(k)o(ept)f(on)g(the)g(acti)n(v)o(e)g(queue.)47 b(P)o(ages)30
b(that)g(contain)f(v)n(alid)g(data)i(b)n(ut)300 1594
y(are)g(currently)g(not)f(being)g(used)g(are)h(k)o(ept)f(on)h(the)f
(inacti)n(v)o(e)f(queue.)48 b(Since)31 b(inacti)n(v)o(e)e(pages)i
(contain)300 1743 y(v)n(alid)22 b(data,)h(it)g(is)g(possible)f(to)g
(\223reclaim\224)i(them)e(from)h(the)g(inacti)n(v)o(e)f(queue)h
(without)f(the)g(need)i(to)f(read)300 1892 y(them)f(from)h(backing)f
(store)g(if)h(the)g(data)f(is)h(needed)g(again.)29 b(P)o(ages)23
b(on)f(the)h(free)g(queue)g(do)g(not)f(contain)300 2042
y(v)n(alid)31 b(data)i(and)g(are)g(a)n(v)n(ailable)f(for)h(allocation.)
53 b(If)33 b(physical)e(memory)g(becomes)i(scarce,)i(the)e(VM)300
2191 y(system)g(will)f(w)o(ak)o(e)i(the)g(pagedaemon)f(and)h(it)f(will)
f(force)j(acti)n(v)o(e)e(pages)g(to)g(become)h(inacti)n(v)o(e)e(and)300
2341 y(free)26 b(inacti)n(v)o(e)d(pages.)583 2490 y(The)32
b(object-of)n(fset)f(hash)g(table)g(maps)g(a)h(page')-5
b(s)31 b Fm(uvm)p 2532 2490 V 35 w(object)f Fs(pointer)h(and)h(its)f
(of)n(fset)f(in)300 2639 y(that)25 b(object)h(to)f(a)h(pointer)f(to)h
(the)f(page')-5 b(s)26 b Fm(vm)p 1884 2639 V 35 w(page)f
Fs(structure.)33 b(This)25 b(hash)h(table)f(allo)n(ws)g(pages)g(in)h(a)
300 2789 y Fm(uvm)p 486 2789 V 35 w(object)e Fs(to)g(be)h(look)o(ed)f
(up)h(quickly)-6 b(.)583 2938 y(UVM')h(s)25 b(simpli\002ed)f
(machine-independent)g(layering)h(mak)o(es)g(supporting)f(ne)n(w)h(UVM)
g(fea-)300 3088 y(tures)h(such)g(as)g(page)g(loanout)f(and)h(page)g
(transfer)h(easier)-5 b(.)34 b(F)o(or)26 b(e)o(xample,)g(UVM')-5
b(s)25 b(tw)o(o-le)n(v)o(el)f(amap-)300 3237 y(object)37
b(mapping)e(scheme)i(simpli\002es)f(the)h(process)f(of)h(locating)f(a)i
(page)f(of)g(memory)f(o)o(v)o(er)g(BSD)300 3386 y(VM')-5
b(s)32 b(object)g(chaining)g(mechanism.)53 b(And)33 b(UVM')-5
b(s)31 b(anon-based)i(anon)o(ymous)d(memory)i(system)300
3536 y(allo)n(ws)26 b(virtual)h(pages)g(to)g(be)g(e)o(xchanged)g
(between)g(processes)g(without)f(the)h(need)h(for)f(object)g(chain)300
3685 y(manipulations.)300 4016 y Ff(3.3.2)119 b(Data)29
b(Structur)n(e)i(Locking)300 4233 y Fs(Data)c(structure)g(locking)f(is)
h(an)g(important)f(aspect)h(of)g(a)g(virtual)g(memory)f(system)g(since)
h(man)o(y)f(pro-)300 4382 y(cesses)h(can)g(be)g(accessing)f(VM)h(data)f
(concurrently)-6 b(.)36 b(Locking)26 b(can)h(either)g(be)g(done)f(with)
g(one)h(lar)n(ge)300 4532 y(lock)36 b(that)g(locks)g(all)h(acti)n(v)o
(e)e(VM)h(data)h(structures,)i(or)d(with)g(multiple)f(small)h(locks.)65
b(The)37 b(use)f(of)300 4681 y(multiple)27 b(small)h(locks)h(is)f(kno)n
(wn)g(as)h(\223\002ne-grain)h(locking.)-7 b(\224)42 b(Fine-grain)29
b(locking)f(is)h(important)e(on)300 4830 y(multiprocessor)j(systems)g
(where)i(each)g(processor)g(is)f(running)f(its)h(o)n(wn)g(process;)j
(if)e(one)f(big)g(lock)300 4980 y(w)o(as)e(used)f(on)h(such)f(a)h
(system)f(only)g(one)g(processor)h(w)o(ould)f(be)h(allo)n(wed)f(to)g
(access)h(the)g(VM)f(struc-)300 5129 y(tures)36 b(at)g(a)g(time.)64
b(There)36 b(are)h(tw)o(o)f(types)f(of)h(locks)g(commonly)e(used:)53
b(\223sleep)36 b(locks\224)g(and)g(\223spin)300 5279
y(locks.)-7 b(\224)61 b(W)l(ith)34 b(a)h(sleep)g(lock,)i(if)d(a)i
(process)e(is)h(unable)f(to)h(acquire)g(the)g(lock)f(then)h(it)f
(releases)h(the)p eop
%%Page: 46 66
46 65 bop 3800 100 a Fs(46)375 4459 y @beginspecial 0
@llx 0 @lly 460 @urx 523 @ury 4140 @rwi @setspecial
%%BeginDocument: ../figures/vmglance.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-46.0 604.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 10098 m 0 0 l 8461 0 l 8461 10098 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 180.00 scf sf
6750 9900 m
gs 1 -1 sc (swap space) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
6300 3600 m
gs 1 -1 sc (\(points to process 4's) col0 sh gr
% Polyline
7.500 slw
n 6225 5100 m 6375 5100 l 6375 5250 l 6225 5250 l cp gs col0 s gr 
% Polyline
n 6450 5100 m 6600 5100 l 6600 5250 l 6450 5250 l cp gs col0 s gr 
% Polyline
n 6675 5100 m 6825 5100 l 6825 5250 l 6675 5250 l cp gs col0 s gr 
% Polyline
n 6900 5100 m 7050 5100 l 7050 5250 l 6900 5250 l cp gs col0 s gr 
% Ellipse
n 4350 5625 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 5250 5625 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6300 5625 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6750 5625 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6975 5625 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 4275 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 4500 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 4725 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6525 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6975 7350 75 75 0 360 DrawEllipse gs 0.00 setgray ef gr gs col0 s gr

% Ellipse
n 6750 9825 675 225 0 360 DrawEllipse gs col0 s gr

% Polyline
n 3146 2550 m 3154 2550 l gs col0 s gr
% Polyline
gs  clippath
3143 2462 m 3143 2523 l 3114 2469 l 3139 2568 l 3168 2561 l cp
clip
n 3000 1950 m 3150 2550 l gs col0 s gr gr

% arrowhead
n 3143 2462 m 3143 2523 l 3114 2469 l 3129 2466 l 3143 2462 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3900 2100 m 4350 2100 l 4350 2325 l 3900 2325 l cp gs col0 s gr 
% Polyline
n 2775 1725 m 3525 1725 l 3525 1950 l 2775 1950 l cp gs col0 s gr 
% Polyline
n 6071 2550 m 6079 2550 l gs col0 s gr
% Polyline
n 6825 2100 m 7275 2100 l 7275 2325 l 6825 2325 l cp gs col0 s gr 
% Polyline
n 5700 1725 m 6450 1725 l 6450 1950 l 5700 1950 l cp gs col0 s gr 
% Polyline
gs  clippath
6746 2138 m 6796 2173 l 6735 2166 l 6831 2202 l 6841 2174 l cp
clip
n 6222 1958 m 6822 2183 l gs col0 s gr gr

% arrowhead
n 6746 2138 m 6796 2173 l 6735 2166 l 6741 2152 l 6746 2138 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3821 2138 m 3871 2173 l 3810 2166 l 3906 2202 l 3916 2174 l cp
clip
n 3297 1958 m 3897 2183 l gs col0 s gr gr

% arrowhead
n 3821 2138 m 3871 2173 l 3810 2166 l 3816 2152 l 3821 2138 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6068 2462 m 6068 2523 l 6039 2469 l 6064 2568 l 6093 2561 l cp
clip
n 5925 1950 m 6075 2550 l gs col0 s gr gr

% arrowhead
n 6068 2462 m 6068 2523 l 6039 2469 l 6054 2466 l 6068 2462 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 2850 2550 m 3450 2550 l 3450 2775 l 2850 2775 l cp gs col0 s gr 
% Polyline
gs  clippath
3768 3068 m 3798 3075 l 3768 3083 l 3840 3083 l 3840 3068 l cp
3657 3083 m 3627 3075 l 3657 3068 l 3585 3068 l 3585 3083 l cp
clip
n 3600 3075 m 3825 3075 l gs col0 s gr gr

% arrowhead
n 3657 3083 m 3627 3075 l 3657 3068 l 3657 3075 l 3657 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 3768 3068 m 3798 3075 l 3768 3083 l 3768 3075 l 3768 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3300 3000 m 3600 3000 l 3600 3150 l 3300 3150 l cp gs col0 s gr 
% Polyline
n 3825 3000 m 4125 3000 l 4125 3150 l 3825 3150 l cp gs col0 s gr 
% Polyline
n 4350 3000 m 4650 3000 l 4650 3150 l 4350 3150 l cp gs col0 s gr 
% Polyline
n 4875 3000 m 5175 3000 l 5175 3150 l 4875 3150 l cp gs col0 s gr 
% Polyline
n 5775 2550 m 6375 2550 l 6375 2775 l 5775 2775 l cp gs col0 s gr 
% Polyline
n 6225 3000 m 6525 3000 l 6525 3150 l 6225 3150 l cp gs col0 s gr 
% Polyline
n 6750 3000 m 7050 3000 l 7050 3150 l 6750 3150 l cp gs col0 s gr 
% Polyline
n 7275 3000 m 7575 3000 l 7575 3150 l 7275 3150 l cp gs col0 s gr 
% Polyline
n 7800 3000 m 8100 3000 l 8100 3150 l 7800 3150 l cp gs col0 s gr 
% Polyline
gs  clippath
3243 3068 m 3273 3075 l 3243 3083 l 3315 3083 l 3315 3068 l cp
3143 2832 m 3150 2802 l 3158 2832 l 3158 2760 l 3143 2760 l cp
clip
n 3150 2775 m 3150 3075 l 3300 3075 l gs col0 s gr gr

% arrowhead
n 3143 2832 m 3150 2802 l 3158 2832 l 3150 2832 l 3143 2832 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 3243 3068 m 3273 3075 l 3243 3083 l 3243 3075 l 3243 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4293 3068 m 4323 3075 l 4293 3083 l 4365 3083 l 4365 3068 l cp
4182 3083 m 4152 3075 l 4182 3068 l 4110 3068 l 4110 3083 l cp
clip
n 4125 3075 m 4350 3075 l gs col0 s gr gr

% arrowhead
n 4182 3083 m 4152 3075 l 4182 3068 l 4182 3075 l 4182 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 4293 3068 m 4323 3075 l 4293 3083 l 4293 3075 l 4293 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4818 3068 m 4848 3075 l 4818 3083 l 4890 3083 l 4890 3068 l cp
4707 3083 m 4677 3075 l 4707 3068 l 4635 3068 l 4635 3083 l cp
clip
n 4650 3075 m 4875 3075 l gs col0 s gr gr

% arrowhead
n 4707 3083 m 4677 3075 l 4707 3068 l 4707 3075 l 4707 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 4818 3068 m 4848 3075 l 4818 3083 l 4818 3075 l 4818 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6693 3068 m 6723 3075 l 6693 3083 l 6765 3083 l 6765 3068 l cp
6582 3083 m 6552 3075 l 6582 3068 l 6510 3068 l 6510 3083 l cp
clip
n 6525 3075 m 6750 3075 l gs col0 s gr gr

% arrowhead
n 6582 3083 m 6552 3075 l 6582 3068 l 6582 3075 l 6582 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 6693 3068 m 6723 3075 l 6693 3083 l 6693 3075 l 6693 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6168 3068 m 6198 3075 l 6168 3083 l 6240 3083 l 6240 3068 l cp
6068 2832 m 6075 2802 l 6083 2832 l 6083 2760 l 6068 2760 l cp
clip
n 6075 2775 m 6075 3075 l 6225 3075 l gs col0 s gr gr

% arrowhead
n 6068 2832 m 6075 2802 l 6083 2832 l 6075 2832 l 6068 2832 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 6168 3068 m 6198 3075 l 6168 3083 l 6168 3075 l 6168 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7218 3068 m 7248 3075 l 7218 3083 l 7290 3083 l 7290 3068 l cp
7107 3083 m 7077 3075 l 7107 3068 l 7035 3068 l 7035 3083 l cp
clip
n 7050 3075 m 7275 3075 l gs col0 s gr gr

% arrowhead
n 7107 3083 m 7077 3075 l 7107 3068 l 7107 3075 l 7107 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 7218 3068 m 7248 3075 l 7218 3083 l 7218 3075 l 7218 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7743 3068 m 7773 3075 l 7743 3083 l 7815 3083 l 7815 3068 l cp
7632 3083 m 7602 3075 l 7632 3068 l 7560 3068 l 7560 3083 l cp
clip
n 7575 3075 m 7800 3075 l gs col0 s gr gr

% arrowhead
n 7632 3083 m 7602 3075 l 7632 3068 l 7632 3075 l 7632 3083 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 7743 3068 m 7773 3075 l 7743 3083 l 7743 3075 l 7743 3068 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6390 3288 m 6375 3348 l 6360 3288 l 6360 3390 l 6390 3390 l cp
clip
n 6375 3150 m 6375 3375 l gs col0 s gr gr

% arrowhead
n 6390 3288 m 6375 3348 l 6360 3288 l 6375 3288 l 6390 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6915 3288 m 6900 3348 l 6885 3288 l 6885 3390 l 6915 3390 l cp
clip
n 6900 3150 m 6900 3375 l gs col0 s gr gr

% arrowhead
n 6915 3288 m 6900 3348 l 6885 3288 l 6900 3288 l 6915 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7965 3288 m 7950 3348 l 7935 3288 l 7935 3390 l 7965 3390 l cp
clip
n 7950 3150 m 7950 3375 l gs col0 s gr gr

% arrowhead
n 7965 3288 m 7950 3348 l 7935 3288 l 7950 3288 l 7965 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7440 3288 m 7425 3348 l 7410 3288 l 7410 3390 l 7440 3390 l cp
clip
n 7425 3150 m 7425 3375 l gs col0 s gr gr

% arrowhead
n 7440 3288 m 7425 3348 l 7410 3288 l 7425 3288 l 7440 3288 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3900 4575 m 4500 4575 l 4500 4800 l 3900 4800 l cp gs col0 s gr 
% Polyline
n 5100 4575 m 5700 4575 l 5700 4800 l 5100 4800 l cp gs col0 s gr 
% Polyline
n 6300 4575 m 6900 4575 l 6900 4800 l 6300 4800 l cp gs col0 s gr 
% Polyline
n 5175 5100 m 5325 5100 l 5325 5250 l 5175 5250 l cp gs col0 s gr 
% Polyline
n 5475 5100 m 5625 5100 l 5625 5250 l 5475 5250 l cp gs col0 s gr 
% Polyline
n 4275 5100 m 4425 5100 l 4425 5250 l 4275 5250 l cp gs col0 s gr 
% Polyline
gs  clippath
4358 5043 m 4350 5073 l 4343 5043 l 4343 5115 l 4358 5115 l cp
clip
n 4350 4800 m 4350 5100 l gs col0 s gr gr

% arrowhead
n 4358 5043 m 4350 5073 l 4343 5043 l 4350 5043 l 4358 5043 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5258 5043 m 5250 5073 l 5243 5043 l 5243 5115 l 5258 5115 l cp
clip
n 5250 4800 m 5250 5100 l gs col0 s gr gr

% arrowhead
n 5258 5043 m 5250 5073 l 5243 5043 l 5250 5043 l 5258 5043 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5558 5043 m 5550 5073 l 5543 5043 l 5543 5115 l 5558 5115 l cp
clip
n 5550 4800 m 5550 5100 l gs col0 s gr gr

% arrowhead
n 5558 5043 m 5550 5073 l 5543 5043 l 5550 5043 l 5558 5043 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6321 5047 m 6306 5073 l 6307 5043 l 6289 5113 l 6304 5116 l cp
clip
n 6375 4800 m 6300 5100 l gs col0 s gr gr

% arrowhead
n 6321 5047 m 6306 5073 l 6307 5043 l 6314 5045 l 6321 5047 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6533 5043 m 6525 5073 l 6518 5043 l 6518 5115 l 6533 5115 l cp
clip
n 6525 4800 m 6525 5100 l gs col0 s gr gr

% arrowhead
n 6533 5043 m 6525 5073 l 6518 5043 l 6525 5043 l 6533 5043 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6743 5043 m 6743 5073 l 6729 5047 l 6746 5116 l 6761 5113 l cp
clip
n 6675 4800 m 6750 5100 l gs col0 s gr gr

% arrowhead
n 6743 5043 m 6743 5073 l 6729 5047 l 6736 5045 l 6743 5043 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6956 5046 m 6962 5075 l 6943 5052 l 6975 5117 l 6988 5110 l cp
clip
n 6825 4800 m 6975 5100 l gs col0 s gr gr

% arrowhead
n 6956 5046 m 6962 5075 l 6943 5052 l 6950 5049 l 6956 5046 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5013 4635 m 5073 4650 l 5013 4665 l 5115 4665 l 5115 4635 l cp
clip
n 4500 3150 m 4875 4650 l 5100 4650 l gs col0 s gr gr

% arrowhead
n 5013 4635 m 5073 4650 l 5013 4665 l 5013 4650 l 5013 4635 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6213 4635 m 6273 4650 l 6213 4665 l 6315 4665 l 6315 4635 l cp
clip
n 5025 3150 m 6075 4650 l 6300 4650 l gs col0 s gr gr

% arrowhead
n 6213 4635 m 6273 4650 l 6213 4665 l 6213 4650 l 6213 4635 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4875 4650 m 4875 5850 l gs col0 s gr 
% Polyline
n 6075 4650 m 6075 5850 l gs col0 s gr 
% Polyline
gs  clippath
3813 4635 m 3873 4650 l 3813 4665 l 3915 4665 l 3915 4635 l cp
clip
n 3993 3146 m 3675 4650 l 3900 4650 l gs col0 s gr gr

% arrowhead
n 3813 4635 m 3873 4650 l 3813 4665 l 3813 4650 l 3813 4635 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3468 3146 m 2475 4650 l 2700 4650 l gs col0 s gr 
% Polyline
n 2700 4725 m 2700 4575 l gs col0 s gr 
% Polyline
gs  clippath
4358 5493 m 4350 5523 l 4343 5493 l 4343 5565 l 4358 5565 l cp
clip
n 4350 5250 m 4350 5550 l gs col0 s gr gr

% arrowhead
n 4358 5493 m 4350 5523 l 4343 5493 l 4350 5493 l 4358 5493 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5258 5493 m 5250 5523 l 5243 5493 l 5243 5565 l 5258 5565 l cp
clip
n 5250 5250 m 5250 5550 l gs col0 s gr gr

% arrowhead
n 5258 5493 m 5250 5523 l 5243 5493 l 5250 5493 l 5258 5493 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5558 5493 m 5550 5523 l 5543 5493 l 5543 5565 l 5558 5565 l cp
clip
n 5550 5250 m 5550 5550 l gs col0 s gr gr

% arrowhead
n 5558 5493 m 5550 5523 l 5543 5493 l 5550 5493 l 5558 5493 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4800 5850 m 4950 5850 l gs col0 s gr 
% Polyline
n 6000 5850 m 6150 5850 l gs col0 s gr 
% Polyline
gs  clippath
6308 5493 m 6300 5523 l 6293 5493 l 6293 5565 l 6308 5565 l cp
clip
n 6300 5250 m 6300 5550 l gs col0 s gr gr

% arrowhead
n 6308 5493 m 6300 5523 l 6293 5493 l 6300 5493 l 6308 5493 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6533 5493 m 6525 5523 l 6518 5493 l 6518 5565 l 6533 5565 l cp
clip
n 6525 5250 m 6525 5550 l gs col0 s gr gr

% arrowhead
n 6533 5493 m 6525 5523 l 6518 5493 l 6525 5493 l 6533 5493 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6758 5493 m 6750 5523 l 6743 5493 l 6743 5565 l 6758 5565 l cp
clip
n 6750 5250 m 6750 5550 l gs col0 s gr gr

% arrowhead
n 6758 5493 m 6750 5523 l 6743 5493 l 6750 5493 l 6758 5493 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6983 5493 m 6975 5523 l 6968 5493 l 6968 5565 l 6983 5565 l cp
clip
n 6975 5250 m 6975 5550 l gs col0 s gr gr

% arrowhead
n 6983 5493 m 6975 5523 l 6968 5493 l 6975 5493 l 6983 5493 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4188 7110 m 4248 7125 l 4188 7140 l 4290 7140 l 4290 7110 l cp
clip
n 2475 4650 m 2475 7125 l 4275 7125 l gs col0 s gr gr

% arrowhead
n 4188 7110 m 4248 7125 l 4188 7140 l 4188 7125 l 4188 7110 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4050 7500 m 4950 7500 l 4500 6750 l cp gs col0 s gr 
% Polyline
gs  clippath
4263 7035 m 4323 7050 l 4263 7065 l 4365 7065 l 4365 7035 l cp
clip
n 3675 4650 m 3675 7050 l 4350 7050 l gs col0 s gr gr

% arrowhead
n 4263 7035 m 4323 7050 l 4263 7065 l 4263 7050 l 4263 7035 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 6300 7500 m 7200 7500 l 6750 6750 l cp gs col0 s gr 
% Polyline
gs  clippath
6987 7065 m 6927 7050 l 6987 7035 l 6885 7035 l 6885 7065 l cp
clip
n 6900 7050 m 7500 7050 l gs col0 s gr gr

% arrowhead
n 6987 7065 m 6927 7050 l 6987 7035 l 6987 7050 l 6987 7065 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7062 7140 m 7002 7125 l 7062 7110 l 6960 7110 l 6960 7140 l cp
clip
n 6975 7125 m 7500 7125 l gs col0 s gr gr

% arrowhead
n 7062 7140 m 7002 7125 l 7062 7110 l 7062 7125 l 7062 7140 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4983 8097 m 5008 8153 l 4960 8116 l 5022 8196 l 5046 8178 l cp
clip
n 4500 7500 m 5025 8175 l gs col0 s gr gr

% arrowhead
n 4983 8097 m 5008 8153 l 4960 8116 l 4972 8106 l 4983 8097 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4800 8175 m 5400 8175 l 5400 8400 l 4800 8400 l cp gs col0 s gr 
% Polyline
gs  clippath
5261 8155 m 5199 8164 l 5249 8127 l 5155 8167 l 5167 8195 l cp
clip
n 6750 7500 m 5175 8175 l gs col0 s gr gr

% arrowhead
n 5261 8155 m 5199 8164 l 5249 8127 l 5255 8141 l 5261 8155 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3600 8175 m 4200 8175 l 4200 8400 l 3600 8400 l cp gs col0 s gr 
% Polyline
n 6000 8175 m 6600 8175 l 6600 8400 l 6000 8400 l cp gs col0 s gr 
% Polyline
n 6450 9150 m 7050 9150 l 7050 9300 l 6450 9300 l cp gs col0 s gr 
% Polyline
gs  clippath
6739 9062 m 6742 9124 l 6711 9071 l 6740 9169 l 6769 9160 l cp
clip
n 6525 8400 m 6750 9150 l gs col0 s gr gr

% arrowhead
n 6739 9062 m 6742 9124 l 6711 9071 l 6725 9067 l 6739 9062 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6765 9513 m 6750 9573 l 6735 9513 l 6735 9615 l 6765 9615 l cp
6735 9387 m 6750 9327 l 6765 9387 l 6765 9285 l 6735 9285 l cp
clip
n 6750 9300 m 6750 9600 l gs col0 s gr gr

% arrowhead
n 6735 9387 m 6750 9327 l 6765 9387 l 6750 9387 l 6735 9387 l  cp gs 0.00 setgray ef gr  col0 s
% arrowhead
n 6765 9513 m 6750 9573 l 6735 9513 l 6750 9513 l 6765 9513 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
6259 9597 m 6283 9653 l 6235 9615 l 6297 9696 l 6321 9678 l cp
clip
n 5550 5625 m 5550 8700 l 6300 9675 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 6259 9597 m 6283 9653 l 6235 9615 l 6247 9606 l 6259 9597 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
n 6525 5625 m 5550 6900 l gs col0 s gr  [] 0 sd
/Helvetica-Bold ff 180.00 scf sf
2400 2700 m
gs 1 -1 sc (vm_map) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 3150 m
gs 1 -1 sc (map entry) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
3150 1500 m
gs 1 -1 sc (process 1 \(init\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
6075 1500 m
gs 1 -1 sc (process 4 \(sh\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 1875 m
gs 1 -1 sc (vmspace) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 2250 m
gs 1 -1 sc (pmap) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 4725 m
gs 1 -1 sc (vm_amap) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 5175 m
gs 1 -1 sc (vm_anon) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 5700 m
gs 1 -1 sc (vm_page \(anon\)) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 7200 m
gs 1 -1 sc (uvm_object) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
4500 6675 m
gs 1 -1 sc (/sbin/init) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
6750 6675 m
gs 1 -1 sc (/bin/sh) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 7425 m
gs 1 -1 sc (vm_page \(object\)) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
7575 7275 m
gs 1 -1 sc (process 4) col0 sh gr
/Helvetica ff 180.00 scf sf
7575 7050 m
gs 1 -1 sc (from) col0 sh gr
/Helvetica-Bold ff 180.00 scf sf
2400 8400 m
gs 1 -1 sc (uvm_pagerops) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
3900 8700 m
gs 1 -1 sc (device) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
5100 8700 m
gs 1 -1 sc (vnode) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
6300 8700 m
gs 1 -1 sc (aobj) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 180.00 scf sf
7200 9300 m
gs 1 -1 sc (swap i/o fns) col0 sh gr
/Helvetica ff 180.00 scf sf
6300 3825 m
gs 1 -1 sc (  amaps and objects\)) col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 300 4663 a(Figure)22 b(3.1:)28 b(UVM)21
b(data)h(structures)f(at)g(a)h(glance.)29 b(Note)22 b(that)f(there)g
(is)g(one)h Fm(vm)p 3074 4663 30 4 v 35 w(aref)f Fs(data)g(structure)
300 4783 y(within)36 b(each)j(map)e(entry)h(structure.)69
b(The)37 b(page)h(queues)g(and)g(object-of)n(fset)e(hash)i(table)f(are)
i(not)300 4903 y(sho)n(wn.)p eop
%%Page: 47 67
47 66 bop 3800 100 a Fs(47)300 249 y(processor)23 b(until)g(the)g(lock)
g(can)h(be)g(acquired)f(\(thus)g(allo)n(wing)f(other)h(processes)h(to)f
(run\).)30 b(W)l(ith)23 b(a)h(spin)300 398 y(lock,)g(the)h(process)g
(continues)e(to)i(attempt)f(to)g(acquire)h(the)g(lock)f(until)g(it)g
(gets)h(it.)583 548 y(The)j(BSD)g(VM)f(system)f(is)h(based)h(on)f(the)g
(Mach)h(VM)f(system,)f(which)i(supports)e(\002ne-grain)300
697 y(locking)j(of)h(its)g(data)g(structures)g(for)g(multiprocessor)f
(systems.)45 b(When)30 b(Mach)h(VM)e(w)o(as)i(ported)e(to)300
847 y(BSD,)j(the)g(\002ne-grain)g(locking)e(support)h(w)o(as)g(ignored)
g(because)h(BSD)h(w)o(as)e(being)g(used)h(on)f(single)300
996 y(processor)22 b(systems.)28 b(Ov)o(er)22 b(time,)g(as)h(changes)f
(were)h(made)f(to)f(BSD,)i(the)f(locking)g(support)f(decayed.)300
1145 y(While)e(UVM)h(currently)f(is)g(only)g(being)h(used)f(on)h
(single)e(processor)i(systems,)f(BSD)i(is)e(in)h(the)f(process)300
1295 y(of)35 b(being)g(ported)g(to)g(multiprocessor)e(systems.)60
b(Thus,)37 b(as)f(part)f(of)g(the)g(UVM)g(project,)i(the)e(\002ne-)300
1444 y(grain)j(locking)f(code)h(w)o(as)g(restored)g(for)g(future)g
(use.)70 b(Ho)n(we)n(v)o(er)l(,)40 b(adding)d(amaps)h(and)g(remo)o
(ving)300 1594 y(shado)n(w/cop)o(y)c(object)h(chaining)f(from)h(the)g
(VM)g(system)f(fundamentally)g(changes)i(the)f(w)o(ay)g(data)300
1743 y(structures)26 b(are)h(used,)f(and)h(thus)e(the)i(\002ne-grain)f
(locking)g(scheme)g(for)h(UVM)f(had)g(to)g(be)g(redesigned)300
1892 y(to)e(tak)o(e)h(these)g(changes)g(into)f(account.)583
2042 y(The)36 b(main)f(challenge)g(with)g(data)g(structure)g(locking)g
(is)g(to)g(choose)g(a)h(set)f(of)h(locks)e(and)i(a)300
2191 y(locking)28 b(scheme)h(that)f(a)n(v)n(oid)g(both)h(data)g
(corruption)f(and)h(deadlock.)42 b(The)29 b(f)o(act)h(that)e(the)h(BSD)
h(VM)300 2341 y(system')-5 b(s)36 b(locking)h(is)g(not)h(used,)i
(incomplete,)g(and)e(not)f(well)h(documented)f(made)h(repairing)f(the)
300 2490 y(damage)32 b(and)f(addressing)g(the)g(ne)n(w)g(data)h
(structures)f(in)g(UVM)g(dif)n(\002cult.)50 b(In)32 b(addition)e(to)h
(\002guring)300 2639 y(out)19 b(what)g(locking)g(scheme)g(to)g(use,)i
(the)e(locking)g(semantics)f(of)i(all)f(the)h(functions)e(of)i(the)f
(VM)g(system)300 2789 y(had)25 b(to)f(be)i(de\002ned,)f(and)g(used)f
(consistently)g(within)f(all)i(VM)f(code.)32 b(F)o(or)25
b(e)o(xample,)f(some)g(functions)300 2938 y(are)32 b(designed)f(to)g
(be)h(called)f(with)g(unlock)o(ed)g(maps)g(while)g(other)g(are)i
(designed)d(to)i(be)f(called)h(with)300 3088 y(lock)o(ed)g(maps.)52
b(Calling)32 b(the)g(function)f(with)h(the)g(lock)g(set)g(the)g
(incorrect)g(w)o(ay)h(will)e(either)h(lead)g(to)300 3237
y(k)o(ernel)25 b(data)g(structure)f(corruption)g(or)h(system)f
(deadlock.)583 3386 y(A)40 b(deadlock)f(occurs)h(when)g(a)f(process)h
(is)f(w)o(aiting)g(to)g(obtain)f(a)i(lock)g(that)f(it)g(is)g(already)
300 3536 y(holding)e(\(thus)h(it)g(can)h(ne)n(v)o(er)f(acquire)g(it\),)
k(or)c(when)h(tw)o(o)f(or)g(more)h(processes)f(are)h(w)o(aiting)f(in)g
(a)300 3685 y(circular)28 b(pattern)g(for)h(locks)e(that)h(the)g(other)
g(processes)g(are)g(holding)f(\(e.g.)41 b(A)28 b(is)g(w)o(aiting)f(for)
h(a)g(lock)300 3835 y(that)35 b(B)i(is)e(holding,)i(and)f(B)h(is)e(w)o
(aiting)g(for)h(a)g(lock)g(that)f(A)h(is)f(holding\).)63
b(It)36 b(is)f(well)h(kno)n(wn)f(that)300 3984 y(deadlock)h(can)g(be)g
(a)n(v)n(oided)f(if)h(all)f(processes)h(allocate)g(their)f(locks)g(in)h
(the)f(same)h(order)g(\(thus)f(no)300 4133 y(loops)26
b(can)h(form\).)36 b(UVM)26 b(uses)h(this)e(scheme)i(to)f(a)n(v)n(oid)g
(deadlock.)36 b(UVM)27 b(also)f(attempts)f(to)h(reduce)300
4283 y(contention)19 b(for)i(data)g(structure)f(locks)g(by)h
(minimizing)d(the)i(amount)g(of)h(time)f(locks)g(are)h(held.)29
b(Before)300 4432 y(starting)e(an)i(I/O)f(operation,)h(UVM)f(will)f
(drop)h(all)h(locks)e(being)h(held.)41 b(Also,)29 b(UVM)f(does)g(not)g
(hold)300 4581 y(an)o(y)36 b(locks)f(during)g(the)h(normal)g(running)f
(of)h(a)h(process.)64 b(So,)39 b(when)d(a)h(VM)e(request)h(comes)g
(into)300 4731 y(UVM,)24 b(it)h(is)f(safe)h(to)g(assume)f(that)g(the)h
(requesting)f(process)g(is)h(not)f(holding)f(an)o(y)i(locks.)583
4880 y(The)f(follo)n(wing)d(data)j(structures)f(ha)n(v)o(e)g(locks)g
(in)g(UVM.)f(The)i(data)f(structures)g(are)h(presented)300
5030 y(in)g(the)h(order)g(in)g(that)f(the)o(y)g(must)g(be)h(lock)o(ed.)
300 5251 y Fo(map:)49 b Fs(the)36 b(lock)g(on)g(a)g(map)g(data)g
(structure)g(pre)n(v)o(ents)f(an)o(y)h(process)g(other)g(than)g(the)g
(lock)f(holder)544 5400 y(from)c(changing)f(the)h(sorted)g(list)f(of)h
(map)g(entries)g(chained)g(of)n(f)g(the)g(map)g(structure.)49
b(A)31 b(map)p eop
%%Page: 48 68
48 67 bop 3800 100 a Fs(48)544 249 y(can)30 b(be)h(read)g(or)f(write)g
(lock)o(ed.)47 b(Read)31 b(locking)e(indicates)g(that)h(the)g(map)g(is)
g(just)f(being)h(read)544 398 y(and)i(no)g(mappings)f(will)g(be)i
(changed.)53 b(Write)32 b(locking)f(the)h(map)g(indicates)g(that)g
(mappings)544 548 y(will)22 b(be)h(changed)g(and)f(that)h(the)f(v)o
(ersion)g(number)g(of)h(the)g(map)f(should)g(be)h(incremented.)29
b(Map)544 697 y(v)o(ersion)23 b(numbers)g(are)h(used)g(to)g(tell)f(if)h
(a)g(map)g(has)g(been)g(changed)g(while)f(it)g(w)o(as)h(unlock)o(ed.)30
b(A)544 847 y(write-lock)o(ed)23 b(map)g(can)g(only)g(be)g(accessed)h
(by)f(the)g(holder)g(of)h(the)f(lock.)30 b(A)23 b(read-lock)o(ed)g(map)
544 996 y(can)h(be)g(accessed)g(by)f(multiple)f(readers.)31
b(Attempting)22 b(to)h(lock)g(a)h(map)f(that)g(is)g(already)h(lock)o
(ed)544 1145 y(will)g(cause)h(the)g(locking)e(process)i(to)f(be)h(put)g
(to)f(sleep)h(until)e(the)i(lock)f(is)h(a)n(v)n(ailable.)300
1378 y Fo(amap:)49 b Fs(the)24 b(amap)g(lock)g(pre)n(v)o(ents)f(an)o(y)
h(process)g(from)h(adding)e(or)i(remo)o(ving)d(anon)j(structures)e
(from)544 1527 y(the)37 b(lock)o(ed)g(amap.)69 b(Note)37
b(that)g(this)g(does)g(not)g(pre)n(v)o(ent)f(the)h(anon)h(structures)e
(from)i(being)544 1677 y(added)25 b(or)g(remo)o(v)o(ed)e(from)i(other)f
(amaps.)300 1909 y Fo(object:)50 b Fs(the)37 b(object)g(lock)g
(protects)g(the)g(list)f(of)h(pages)g(associated)g(with)g(the)g(object)
g(from)g(being)544 2058 y(changed.)43 b(It)29 b(also)f(protects)g(the)h
(\223\003ags\224)h(\002eld)f(of)g(the)f(page)h(data)g(structure)g(of)g
(all)f(the)h(pages)544 2208 y(in)24 b(that)h(object)f(from)h(being)f
(changed.)300 2440 y Fo(anon:)49 b Fs(the)21 b(anon)g(lock)g(protects)f
(the)h(page)g(or)g(disk)f(block)h(the)g(anon)g(points)e(to)i(from)g
(being)f(changed.)544 2590 y(It)25 b(also)f(protects)g(the)h
(\223\003ags\224)h(\002eld)f(of)g(the)f(page)h(data)g(structure)g(from)
f(being)g(changed.)300 2822 y Fo(page)h(queues:)51 b
Fs(the)28 b(page)g(queue)h(lock)f(protects)g(pages)g(from)g(being)g
(added)g(or)h(remo)o(v)o(ed)e(from)h(the)544 2971 y(acti)n(v)o(e)c(and)
g(inacti)n(v)o(e)g(page)h(queues.)30 b(It)25 b(also)f(blocks)g(the)h
(page)g(daemon)f(from)h(running.)583 3204 y(F)o(or)g(most)e(of)h(the)g
(UVM)f(system)g(this)h(locking)f(order)h(is)g(easy)g(to)g(maintain.)29
b(Ho)n(we)n(v)o(er)l(,)23 b(there)300 3353 y(is)33 b(a)g(problem)f
(with)h(the)g(page)g(daemon.)55 b(The)33 b(page)g(daemon)g(runs)g(when)
g(there)g(is)g(a)g(shortage)g(of)300 3503 y(physical)e(memory)-6
b(.)50 b(The)32 b(page)g(daemon)f(operates)h(by)g(locking)f(the)h(page)
g(queues)f(and)h(tra)n(v)o(ersing)300 3652 y(them)25
b(looking)f(for)j(pages)e(to)h(page)g(out.)33 b(If)26
b(it)f(\002nds)h(a)g(tar)n(get)g(page)g(it)f(must)g(lock)g(the)h
(object)f(or)h(anon)300 3801 y(that)f(the)h(page)g(belongs)f(to)g(in)g
(order)h(to)g(remo)o(v)o(e)f(it)g(from)g(that)h(object.)33
b(This)25 b(is)g(a)h(direct)g(violation)e(of)300 3951
y(the)30 b(locking)g(order)h(described)f(abo)o(v)o(e.)47
b(Ho)n(we)n(v)o(er)l(,)30 b(this)g(problem)g(can)h(be)f(w)o(ork)o(ed)h
(around.)47 b(When)300 4100 y(the)27 b(page)h(daemon)f(attempts)f(to)i
(lock)f(the)g(memory)g(object)g(o)n(wning)f(the)i(page)f(it)g(is)g
(interested)g(in)h(it)300 4250 y(should)22 b(only)h(\223try\224)h(to)f
(lock)h(the)f(object,)h(as)f(sho)n(wn)g(in)g(Figure)h(3.2.)30
b(If)24 b(the)f(object)g(is)h(already)f(lock)o(ed,)300
4399 y(then)g(the)g(page)h(daemon)f(should)f(skip)h(the)g(current)h
(page)g(and)f(mo)o(v)o(e)f(on)h(to)g(the)h(ne)o(xt)e(one)i(rather)f
(than)300 4548 y(w)o(ait)i(for)h(the)f(memory)g(object)g(to)g(be)g
(unlock)o(ed.)32 b(Ha)n(ving)25 b(the)g(page)h(daemon)e(skip)h(to)g
(the)g(ne)o(xt)g(page)300 4698 y(does)g(not)f(violate)g(UVM')-5
b(s)24 b(locking)f(protocol)h(and)h(thus)f(has)h(no)f(dire)h
(consequences.)300 5029 y Ff(3.3.3)119 b(VM)30 b(Maps)300
5246 y Fs(In)d(UVM,)e(the)i Fm(vm)p 968 5246 30 4 v 35
w(map)f Fs(structure)g(and)h(its)e(corresponding)h(list)f(of)i
Fm(vm)p 2850 5246 V 35 w(map)p 3065 5246 V 35 w(entry)f
Fs(structures)g(is)300 5395 y(handled)31 b(in)g(much)g(the)h(same)f(w)o
(ay)h(as)f(in)g(BSD)i(VM.)e(Ho)n(we)n(v)o(er)l(,)h(there)g(are)g(some)f
(dif)n(ferences.)51 b(In)p eop
%%Page: 49 69
49 68 bop 3800 100 a Fs(49)1208 1491 y @beginspecial
0 @llx 0 @lly 306 @urx 230 @ury 2142 @rwi @setspecial
%%BeginDocument: ../figures/locks.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-233.0 291.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4882 m 0 0 l 9009 0 l 9009 4882 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
6000 4425 m
gs 1 -1 sc (pagedaemon: "try" lock) col-1 sh gr
% Polyline
7.500 slw
gs  clippath
4830 2553 m 4800 2673 l 4770 2553 l 4770 2715 l 4830 2715 l cp
clip
n 4800 2175 m 4800 2700 l gs col-1 s gr gr

% arrowhead
n 4830 2553 m 4800 2673 l 4770 2553 l 4800 2553 l 4830 2553 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4830 3453 m 4800 3573 l 4770 3453 l 4770 3615 l 4830 3615 l cp
clip
n 4800 3075 m 4800 3600 l gs col-1 s gr gr

% arrowhead
n 4830 3453 m 4800 3573 l 4770 3453 l 4800 3453 l 4830 3453 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4530 4353 m 4500 4473 l 4470 4353 l 4470 4515 l 4530 4515 l cp
clip
n 4500 3975 m 4500 4500 l gs col-1 s gr gr

% arrowhead
n 4530 4353 m 4500 4473 l 4470 4353 l 4500 4353 l 4530 4353 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
 [60] 0 sd
gs  clippath
5070 4122 m 5100 4002 l 5130 4122 l 5130 3960 l 5070 3960 l cp
clip
n 5100 3975 m 5100 4500 l gs col-1 s gr gr
 [] 0 sd
% arrowhead
n 5070 4122 m 5100 4002 l 5130 4122 l 5100 4122 l 5070 4122 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5322 4380 m 5202 4350 l 5322 4320 l 5160 4320 l 5160 4380 l cp
clip
n 5925 4350 m 5175 4350 l gs col-1 s gr gr

% arrowhead
n 5322 4380 m 5202 4350 l 5322 4320 l 5322 4350 l 5322 4380 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica-Bold ff 300.00 scf sf
4800 1200 m
gs 1 -1 sc (map) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 2100 m
gs 1 -1 sc (amap) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 3000 m
gs 1 -1 sc (object) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 3900 m
gs 1 -1 sc (anon) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 4800 m
gs 1 -1 sc (page queues) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
gs  clippath
4830 1653 m 4800 1773 l 4770 1653 l 4770 1815 l 4830 1815 l cp
clip
n 4800 1275 m 4800 1800 l gs col-1 s gr gr

% arrowhead
n 4830 1653 m 4800 1773 l 4770 1653 l 4800 1653 l 4830 1653 l  cp gs 0.00 setgray ef gr  col-1 s
$F2psEnd
rs
%%EndDocument
 @endspecial 1032 1695 a(Figure)25 b(3.2:)30 b(The)25
b(UVM)f(pagedaemon)g(and)h(lock)g(ordering)300 2090 y(UVM,)k(the)g(map)
g(entry)g(structure)g(has)g(been)h(modi\002ed)e(for)i(UVM')-5
b(s)28 b(tw)o(o-layer)h(mapping)f(scheme.)300 2239 y(Not)g(only)g(does)
h(it)f(contain)h(a)g(pointer)f(to)h(the)f(backing)h Fm(uvm)p
2475 2239 30 4 v 35 w(object)e Fs(structure,)j(b)n(ut)e(it)h(also)f
(con-)300 2388 y(tains)21 b(a)g Fm(vm)p 701 2388 V 36
w(aref)f Fs(structure.)30 b(The)21 b(aref)h(points)e(to)h(an)o(y)g
(amap)g(associated)g(with)g(the)g(mapped)g(re)o(gion.)583
2538 y(Some)28 b(of)g(the)g(functions)e(that)i(operate)g(on)f(maps)g
(ha)n(v)o(e)h(also)f(been)h(changed.)39 b(F)o(or)28 b(e)o(xample,)300
2687 y(UVM)e(pro)o(vides)f(a)h(ne)n(w)g(function)g(called)g
Fm(uvm)p 1996 2687 V 35 w(map)g Fs(that)g(establishes)f(a)h(mapping)f
(with)h(the)g(speci-)300 2837 y(\002ed)i(attrib)n(utes.)38
b(The)27 b(BSD)h(VM)g(system)e(does)h(not)g(ha)n(v)o(e)g(such)g(a)h
(function:)35 b(mappings)26 b(are)i(al)o(w)o(ays)300
2986 y(established)c(with)g(def)o(ault)h(attrib)n(utes.)31
b(Thus)24 b(in)h(the)g(BSD)h(VM,)e(after)i(establishing)d(a)j(mapping)e
(fur)n(-)300 3135 y(ther)d(function)f(calls)h(are)h(often)f(required)g
(to)g(change)g(the)g(attrib)n(utes)g(from)f(their)h(def)o(ault)g(v)n
(alues)g(to)f(the)300 3285 y(desired)j(v)n(alues.)29
b(On)22 b(a)h(multi-threaded)f(system)g(this)f(can)i(be)g(a)g(problem)f
(because)i(the)e(def)o(ault)h(v)n(alue)300 3434 y(for)32
b(protection)f(is)g(read-write.)52 b(Thus,)32 b(when)g(establishing)e
(a)i(read-only)f(mapping)g(of)h(a)g(\002le)g(there)300
3584 y(is)25 b(a)h(brief)f(windo)n(w)f(\227)i(between)f(the)g(time)g
(the)g(mapping)f(is)h(established)g(\(with)f(the)i(def)o(ault)f
(protec-)300 3733 y(tion\))d(and)g(the)g(time)g(the)g(system)f
(write-protects)h(the)g(mapping)f(\227)h(where)h(the)f(map)g(is)g
(unlock)o(ed)f(and)300 3882 y(could)j(be)h(accessed)h(by)e(another)h
(thread,)g(thus)f(allo)n(wing)f(it)h(to)g(by-pass)h(system)e(security)
-6 b(.)583 4032 y(UVM)34 b(also)f(pro)o(vides)f(a)i(corresponding)f
Fm(uvm)p 2287 4032 V 35 w(unmap)f Fs(call.)57 b(The)34
b(unmap)f(call)g(has)h(been)300 4181 y(restructured)26
b(so)h(that)f(it)g(holds)f(the)i(lock)f(on)g(a)h(map)f(for)h(a)g
(shorter)f(amount)f(of)i(time)f(than)g(the)g(corre-)300
4331 y(sponding)d(BSD)j(VM)e(unmap)g(call.)583 4480 y(F)o(or)f
(features)f(such)g(as)h(page)f(loanout)f(and)h(map)g(entry)g(passing,)g
(ne)n(w)g(map)g(related)g(functions)300 4629 y(had)j(to)f(be)h
(written.)30 b(These)25 b(functions)f(perform)g(a)i(v)n(ariety)e(of)h
(tasks)f(including:)445 4862 y Fr(\017)49 b Fs(reserving)24
b(a)i(block)e(of)h(virtual)f(memory)g(in)g(a)h(map)g(for)g(later)g
(use.)445 5094 y Fr(\017)49 b Fs(e)o(xtracting)23 b(a)i(list)e(of)h
(map)g(entries)g(from)g(a)g(map.)30 b(The)24 b(e)o(xtracted)g(list)g
(can)g(either)g(be)h(a)f(cop)o(y)g(of)544 5244 y(the)i(map)h(entries)f
(in)h(the)f(source)h(map)f(or)h(the)g(actual)f(map)h(entries)f(from)h
(the)f(source)h(map)f(\(in)544 5393 y(which)e(case)i(the)e(mappings)g
(are)h(being)f(remo)o(v)o(ed)g(from)h(the)f(source)h(map\).)p
eop
%%Page: 50 70
50 69 bop 3800 100 a Fs(50)445 249 y Fr(\017)49 b Fs(replacing)31
b(a)g(map)f(entry)h(that)f(is)h(reserving)g(a)g(block)f(of)h(virtual)f
(address)h(space)g(with)f(a)i(ne)n(w)544 398 y(set)24
b(of)h(map)g(entries.)445 631 y Fr(\017)49 b Fs(e)o(xtracting)22
b(pages)i(for)f(loanout.)29 b(The)24 b(tw)o(o-le)n(v)o(el)e(structure)h
(of)g(the)g(amap)g(layer)h(mak)o(es)f(it)g(easy)544 780
y(to)h(do)g(this.)30 b(T)-8 b(o)24 b(e)o(xtract)h(the)f(pages,)g(the)h
(loan)f(out)g(routine)g(only)g(needs)g(to)g(look)g(in)g(one)h(of)g(tw)o
(o)544 930 y(places)e(for)g(each)h(page)g(being)e(loaned,)h(as)g
(compared)g(to)g(the)g(BSD)h(VM)f(where)h(loan)e(out)h(code)544
1079 y(w)o(ould)h(ha)n(v)o(e)g(to)h(w)o(alk)f(the)h(object)f(chains)h
(for)g(each)g(page)g(it)g(wished)f(to)g(loan.)300 1410
y Ff(3.3.4)119 b(UVM)30 b(Objects)300 1627 y Fs(The)25
b(role)h(of)f(a)h Fm(uvm)p 1025 1627 30 4 v 35 w(object)e
Fs(in)h(UVM)g(is)g(some)n(what)e(dif)n(ferent)i(than)g(the)h(role)f(of)
g(a)h Fm(vm)p 3512 1627 V 35 w(object)300 1776 y Fs(in)34
b(BSD)h(VM.)f(In)h(BSD)g(VM,)f(the)h(object)f(structure)g(is)g
(considered)g(a)h(stand-alone)f(structure)g(un-)300 1926
y(der)g(the)f(complete)f(control)h(of)g(the)g(VM)g(system.)55
b(The)33 b(BSD)h(VM)f(system)f(has)i(full)e(control)h(o)o(v)o(er)300
2075 y(when)i Fm(vm)p 677 2075 V 36 w(object)f Fs(structures)g(are)i
(allocated,)i(when)d(the)o(y)g(can)g(be)h(referenced,)j(and)c(ho)n(w)g
(the)o(y)300 2224 y(can)e(be)g(used.)55 b(In)33 b(UVM,)f(the)h
Fm(uvm)p 1608 2224 V 35 w(object)f Fs(is)g(considered)h(a)g(secondary)g
(structure.)54 b(It)33 b(is)f(usu-)300 2374 y(ally)26
b(embedded)g(within)f(some)h(lar)n(ger)h(structure)f(in)g(order)h(to)f
(pro)o(vide)g(the)g(VM)g(system)f(a)i(\223handle\224)300
2523 y(for)f(memory-mapping)e(the)i(structure.)34 b(All)25
b(operations)h(performed)g(on)f(a)i(UVM)e(object)h(are)g(routed)300
2673 y(through)f(the)i(object')-5 b(s)25 b(pager)i(operations.)35
b(The)26 b(BSD)i(VM)e(system)f(has)h(functions)g(that)g(operate)g(di-)
300 2822 y(rectly)g(on)g(VM)g(objects.)34 b(F)o(or)26
b(e)o(xample,)g(in)g(BSD)h(VM)f(there)g(are)h(functions)e(to)h(create)h
(ne)n(w)f(shado)n(w)300 2971 y(objects,)36 b(collapse)f(object)f
(chains,)j(adjust)c(the)i(object)f(cache,)k(and)d(change)g(the)f
(protection)g(of)h(an)300 3121 y(object')-5 b(s)29 b(pages.)47
b(In)31 b(UVM)f(there)g(are)h(no)f(such)g(functions:)41
b(the)o(y)29 b(ha)n(v)o(e)h(either)g(been)h(mo)o(v)o(ed)d(to)i(the)300
3270 y(pager)l(,)23 b(or)g(in)g(the)f(case)i(of)e(functions)g(relating)
g(to)h(object)f(chaining)g(and)h(the)f(object)h(cache,)g(the)o(y)f(ha)n
(v)o(e)300 3420 y(been)j(remo)o(v)o(ed)f(all)g(together)-5
b(.)583 3569 y(Thus,)41 b(UVM')-5 b(s)37 b Fm(uvm)p 1372
3569 V 35 w(object)f Fs(structure)i(sho)n(wn)f(in)g(Figure)h(3.3)g(is)f
(simpler)g(than)g(BSD)300 3718 y(VM')-5 b(s)30 b Fm(vm)p
684 3718 V 35 w(object)g Fs(structure.)49 b(It)31 b(contains)f(a)h
(spin)f(lock,)j(a)e(pointer)f(to)h(its)f Fm(uvm)p 3291
3718 V 35 w(pagerops)p Fs(,)h(a)300 3868 y(list)26 b(of)i(pages)f
(belonging)g(to)g(it,)g(the)h(number)f(of)g(pages)h(belonging)e(to)h
(it,)g(and)h(a)g(reference)h(counter)-5 b(.)300 4017
y(There)40 b(are)g(no)f(shado)n(w)g(object)g(pointers,)j(cop)o(y)d
(object)g(pointers,)j(or)e(object)f(cache)h(pointers)e(in)300
4167 y(UVM.)300 4498 y Ff(3.3.5)119 b(Anonymous)30 b(Memory)f(Structur)
n(es)300 4714 y Fs(UVM)41 b(has)h(three)h(anon)o(ymous)d(memory)h
(related)h(data)g(structures:)64 b(arefs,)47 b(amaps,)f(and)c(anons.)
300 4864 y(UVM')-5 b(s)37 b(anon)o(ymous)e(memory)i(handling)g(will)g
(be)h(e)o(xamined)e(in)i(detail)f(in)g(Chapter)i(4,)h(so)e(only)300
5013 y(a)25 b(brief)g(discussion)e(of)i(it)f(will)g(be)h(included)f
(here.)p eop
%%Page: 51 71
51 70 bop 3800 100 a Fs(51)557 949 y @beginspecial 0
@llx 0 @lly 529 @urx 137 @ury 3703 @rwi @setspecial
%%BeginDocument: ../figures/uvm_object.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-48.0 187.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3148 m 0 0 l 9643 0 l 9643 3148 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
5400 2625 m
gs 1 -1 sc (npages) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 2250 m
gs 1 -1 sc (list of object's pages) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 2625 m
gs 1 -1 sc (number of object's pages) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 3000 m
gs 1 -1 sc (object's reference count) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 1500 m
gs 1 -1 sc (object lock) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6300 1800 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 1763 m 7475 1800 l 7341 1838 l 7515 1838 l 7515 1763 l cp
clip
n 6300 1800 m 7500 1800 l gs col-1 s gr gr

% arrowhead
n 7341 1763 m 7475 1800 l 7341 1838 l 7341 1800 l 7341 1763 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
7650 1875 m
gs 1 -1 sc (uvm_pagerops) col0 sh gr
% Ellipse
n 6300 2175 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7341 2138 m 7475 2175 l 7341 2213 l 7515 2213 l 7515 2138 l cp
clip
n 6300 2175 m 7500 2175 l gs col-1 s gr gr

% arrowhead
n 7341 2138 m 7475 2175 l 7341 2213 l 7341 2175 l 7341 2138 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
7650 2250 m
gs 1 -1 sc (vm_page) col0 sh gr
% Polyline
n 4500 1575 m 6300 1575 l gs col0 s gr 
% Polyline
n 4500 1950 m 6300 1950 l gs col0 s gr 
% Polyline
n 4500 2325 m 6300 2325 l gs col0 s gr 
% Polyline
n 4500 2700 m 6300 2700 l gs col0 s gr 
% Polyline
30.000 slw
n 4500 1200 m 6300 1200 l 6300 3075 l 4500 3075 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
5400 2250 m
gs 1 -1 sc (memq) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 1500 m
gs 1 -1 sc (objlock) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 1875 m
gs 1 -1 sc (pgops) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5400 1050 m
gs 1 -1 sc (uvm_object) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5400 3000 m
gs 1 -1 sc (refs) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4200 1875 m
gs 1 -1 sc (pointer to pager operations) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1339 1152 a(Figure)25 b(3.3:)30 b(The)25
b(UVM)f(object)h(structure)583 1547 y(Map)j(entry)f(structures)g
(contain)g(aref)h(structures.)39 b(Each)27 b(aref)i(can)f(point)e(to)h
(an)h(amap)f(struc-)300 1697 y(ture.)38 b(The)27 b(amap)h(structure)e
(forms)h(the)g(top)g(layer)h(of)f(UVM')-5 b(s)26 b(tw)o(o-layered)h
(virtual)g(memory)f(map-)300 1846 y(ping)h(scheme,)i(and)f(the)g
Fm(uvm)p 1366 1846 30 4 v 36 w(object)f Fs(forms)g(the)h(backing)g
(layer)-5 b(.)41 b(Each)28 b(amap)g(can)h(contain)e(one)300
1995 y(or)i(more)g(anon)f(structures.)42 b(Each)29 b(anon)g(represents)
g(a)g(page)g(of)g(anon)o(ymous)e(virtual)h(memory)-6
b(.)41 b(An)300 2145 y(anon')-5 b(s)30 b(data)i(can)f(either)h(be)f
(resident)g(in)g(a)g(page)h(of)f(physical)f(memory)g(\(in)i(which)e
(case)i(the)f(anon)300 2294 y(has)c(a)g(pointer)f(to)h(the)f
(corresponding)g Fm(vm)p 1816 2294 V 35 w(page)h Fs(structure\),)g(or)g
(it)f(can)h(be)g(paged)g(out)f(to)h(the)f(sw)o(ap)300
2444 y(area)32 b(of)g(the)f(disk)g(\(in)g(which)g(case)h(the)g(anon)f
(contains)g(the)g(inde)o(x)g(into)f(the)h(sw)o(ap)h(area)g(where)g(the)
300 2593 y(data)25 b(is)f(located\).)583 2742 y(Cop)o(y-on-write)35
b(is)g(achie)n(v)o(ed)f(in)h(UVM)g(using)f(the)h(amap)g(layer)-5
b(.)61 b(Cop)o(y-on-write)35 b(data)h(is)300 2892 y(originally)29
b(mapped)g(in)h(read-only)g(from)g(a)g(backing)g Fm(uvm)p
2413 2892 V 35 w(object)p Fs(.)45 b(When)30 b(cop)o(y-on-write)g(data)
300 3041 y(is)23 b(\002rst)h(written,)g(the)f(page)h(f)o(ault)g
(routine)f(allocates)h(a)g(ne)n(w)f(anon)h(with)f(a)h(ne)n(w)g(page,)g
(copies)f(the)h(data)300 3191 y(from)31 b(the)g Fm(uvm)p
864 3191 V 36 w(object)p Fs(')-5 b(s)29 b(page)j(into)f(the)g(ne)n(w)g
(page,)i(and)e(then)h(installs)d(the)j(anon)f(in)g(the)g(amap)300
3340 y(for)23 b(that)g(mapping.)29 b(When)22 b(UVM')-5
b(s)22 b(f)o(ault)h(routine)f(copies)h(cop)o(y-on-write)f(data)h(from)g
(a)g(lo)n(wer)n(-layer)300 3489 y Fm(uvm)p 486 3489 V
35 w(object)35 b Fs(into)g(an)i(upper)n(-layer)f(anon)g(it)g(is)f
(called)h(a)h(\223promotion.)-7 b(\224)63 b(Once)37 b(cop)o(y-on-write)
300 3639 y(data)31 b(has)h(been)f(promoted)g(to)g(the)g(amap)g(layer)l
(,)i(it)e(becomes)g(anon)o(ymous)e(memory)-6 b(.)49 b(Anon)o(ymous)300
3788 y(memory)23 b(also)g(can)i(be)f(subject)f(to)g(the)h(cop)o
(y-on-write)f(operation.)30 b(An)24 b(anon)f(can)i(be)f(cop)o
(y-on-write)300 3937 y(copied)f(by)g(write-protecting)f(its)g(data)h
(and)h(adding)e(a)h(reference)i(to)e(the)g(anon.)30 b(When)23
b(the)g(page)g(f)o(ault)300 4087 y(routine)j(detects)g(a)h(write)g(to)f
(an)h(anon)f(with)g(a)h(reference)h(count)e(greater)h(than)g(one,)g(it)
f(will)f(cop)o(y-on-)300 4236 y(write)g(the)f(anon.)583
4386 y(The)h(introduction)e(of)i(the)g(amap)g(layer)g(and)f(the)h(remo)
o(v)n(al)f(of)g(object)h(chaining)f(had)h(a)g(signif-)300
4535 y(icant)f(ef)n(fect)h(on)f(the)g(handling)f(of)h(page)h(f)o(ault)f
(routines,)f(and)h(thus)g(the)g(page)g(f)o(ault)g(routine)g(had)g(to)g
(be)300 4684 y(re)n(written)e(from)h(scratch.)30 b(This)22
b(is)h(because)g(in)f(the)h(BSD)h(VM)e(when)h(a)g(page)g(f)o(ault)g
(occurs)g(the)g(object)300 4834 y(chains)h(must)g(be)h(tra)n(v)o
(ersed.)30 b(But)25 b(in)f(UVM,)g(rather)h(than)f(start)h(looking)e
(directly)h(at)h(VM)f(objects)g(\(or)300 4983 y(object)k(chains\))g
(the)h(f)o(ault)f(routine)g(\002rst)g(looks)g(at)g(the)h(amap)f(layer)h
(to)f(see)g(if)h(the)f(needed)h(pages)f(are)300 5133
y(there.)49 b(If)32 b(there)f(is)g(no)f(page)i(in)e(the)h(amap)g(layer)
l(,)h(then)f(the)g(underlying)f(object)g(is)h(ask)o(ed)g(for)g(it.)49
b(If)300 5282 y(the)32 b(underlying)f(object)h(doesn')n(t)g(ha)n(v)o(e)
g(the)g(needed)h(data,)h(then)e(the)g(f)o(ault)g(routine)f(f)o(ails.)53
b(Thus,)33 b(in)p eop
%%Page: 52 72
52 71 bop 3800 100 a Fs(52)300 249 y(UVM')-5 b(s)22 b(f)o(ault)h
(routine,)f(there)i(are)g(only)e(tw)o(o)h(places)g(to)f(check)i(for)f
(data)g(and)g(no)g(shado)n(w)f(link)o(ed)g(lists)300
398 y(ha)n(v)o(e)j(to)f(be)h(tra)n(v)o(ersed)f(or)h(managed.)583
548 y(The)39 b(amap)f(concept)h(w)o(as)f(\002rst)h(introduced)e(in)h
(the)g(SunOS4)h(VM)f(system)f([28,)i(46)o(].)72 b(In)300
697 y(UVM,)29 b(the)g(SunOS)g(amap)g(concept)g(w)o(as)h(enhanced,)g
(and)f(then)g(adapted)g(for)h(the)f(more)g(Mach-lik)o(e)300
847 y(en)l(vironment)d(pro)o(vided)f(by)i(UVM.)f(Amaps)g(and)h(anons)f
(may)g(also)h(be)g(used)f(for)h(page)g(loanout)f(and)300
996 y(page)f(transfer)-5 b(.)300 1327 y Ff(3.3.6)119
b(P)o(ager)29 b(Operations)300 1544 y Fs(The)35 b Fm(uvm)p
676 1544 30 4 v 35 w(pagerops)e Fs(structure)h(de\002nes)h(the)f(set)g
(of)h(operations)e(that)h(can)h(be)g(performed)g(on)f(a)300
1693 y Fm(uvm)p 486 1693 V 35 w(object)26 b Fs(structure.)36
b(Each)28 b Fm(uvm)p 1724 1693 V 35 w(object)d Fs(has)i(a)g(pointer)g
(to)f(its)g(pager)h(operations.)36 b(This)27 b(is)300
1843 y(dif)n(ferent)32 b(from)h(the)f(BSD)i(VM)e(system)g(in)g(which)h
(the)f Fm(vm)p 2451 1843 V 36 w(object)f Fs(structure)i(had)f(a)h
(pointer)f(to)300 1992 y(a)d Fm(vm)p 499 1992 V 36 w(pager)p
Fs(,)f(and)h(that)g Fm(vm)p 1360 1992 V 35 w(pager)f
Fs(structure)h(had)g(a)g(pointer)f(to)h(a)g(set)g(of)g(pager)g
(operations.)42 b(In)300 2141 y(UVM)33 b(the)h(e)o(xtra)f
Fm(vm)p 1079 2141 V 35 w(pager)g Fs(layer)h(has)f(been)h(eliminated)e
(and)i(a)g(ne)n(w)f(set)g(of)h(pager)g(operations)300
2291 y(ha)n(v)o(e)d(been)h(created.)51 b(UVM')-5 b(s)31
b(pager)h(operations)e(include)h(functions)g(such)g(as)g(ones)h(that)f
(add)g(and)300 2440 y(drop)21 b(references)i(to)e(a)h
Fm(uvm)p 1286 2440 V 35 w(object)e Fs(and)h(functions)g(that)g(get)g
(and)g(put)g(pages)g(from)h(backing)e(store.)300 2590
y(Details)k(on)h(UVM')-5 b(s)23 b(pager)j(operations)e(can)h(be)g
(found)f(in)g(Chapter)i(6.)300 2921 y Ff(3.3.7)119 b(P)o(ages)300
3137 y Fs(In)19 b(UVM,)g(the)g Fm(vm)p 946 3137 V 36
w(page)f Fs(structure)h(has)g(been)h(updated)f(for)g(amap-based)g(anon)
o(ymous)f(memory)g(and)300 3287 y(for)27 b(page)g(loanout.)35
b(In)27 b(the)g(BSD)g(VM)g(system,)f(an)g(allocated)h(page)g(of)g
(memory)f(can)h(be)g(associated)300 3436 y(with)d(a)h
Fm(vm)p 697 3436 V 35 w(object)p Fs(.)30 b(That)24 b(object)h(could)f
(be)h(a)g(normal)f(object,)g(or)h(it)f(could)g(be)h(a)g(shado)n(w)f(or)
g(cop)o(y)300 3586 y(object)30 b(that)f(w)o(as)h(created)h(as)f(part)g
(of)h(a)f(cop)o(y-on-write)f(operation.)46 b(In)30 b(contrast,)h(in)f
(UVM)g(a)g(page)300 3735 y(can)25 b(be)g(associated)g(with)f(either)g
(a)h Fm(uvm)p 1725 3735 V 36 w(object)e Fs(or)i(an)g(anon)g(structure.)
583 3884 y(F)o(or)k(page)g(loanout,)g(a)g(loan)f(counter)g(has)h(been)g
(added)g(to)f(each)h(page)g(structure.)42 b(A)29 b(page)g(is)300
4034 y(loaned)c(out)f(if)i(it)e(has)h(a)h(non-zero)f(loan)g(count.)31
b(One)25 b(of)h(the)f(challenges)g(f)o(aced)g(when)h(designing)d(the)
300 4183 y(page)i(loanout)f(system)f(w)o(as)i(to)f(determine)h(ho)n(w)f
(to)g(handle)g(cases)h(where)h(the)e(VM)h(system)e(w)o(ants)h(to)300
4333 y(do)31 b(something)f(to)h(a)h(page)g(that)f(is)h(currently)f(on)g
(loan.)51 b(Often)32 b(this)e(will)h(require)h(that)f(the)h(loan)f(be)
300 4482 y(\223brok)o(en.)-7 b(\224)49 b(If)31 b(a)g(process)g(or)f
(the)h(k)o(ernel)g(tries)f(to)h(modify)e(a)i(loaned)g(page,)h(then)e
(the)h(loan)f(must)g(be)300 4631 y(brok)o(en.)49 b(If)31
b(memory)g(becomes)f(scarce)i(and)f(the)g(VM)g(system)e(w)o(ants)i(to)f
(pageout)h(a)g(loaned)g(page,)300 4781 y(then)23 b(the)f(loan)h(must)f
(be)h(brok)o(en.)29 b(If)24 b(the)e(VM)h(system)f(tries)g(to)h(free)h
(or)e(\003ush)h(out)g(a)g(loaned)f(page)h(then)300 4930
y(the)33 b(loan)g(must)g(be)g(brok)o(en.)57 b(All)33
b(these)g(cases)h(must)e(be)i(handled)f(properly)g(by)g(the)g(page)h
(loanout)300 5080 y(code,)c(or)g(data)f(corruption)g(will)f(result.)44
b(Thus,)29 b(the)g(addition)f(of)i(the)f(loan)g(count)f(to)h(the)g
Fm(vm)p 3631 5080 V 36 w(page)300 5229 y Fs(structure)24
b(w)o(as)h(critical)g(in)f(getting)g(loanout)g(to)g(w)o(ork)h(properly)
-6 b(.)p eop
%%Page: 53 73
53 72 bop 3800 100 a Fs(53)300 535 y(T)-8 b(able)31 b(3.1:)42
b(Changes)32 b(from)e(BSD)i(VM.)f(The)g(\223e)o(xtent)f(of)h
(change\224)g(v)n(alues)f(are:)44 b Fq(ne)o(w)31 b Fs(\(ne)n(w)g
(code\),)300 656 y Fq(r)l(eplaced)f Fs(\(totally)c(re)n(written)h
(code\),)h Fq(r)l(e)o(vised)i Fs(\(same)d(basic)g(design)f(as)i(BSD)g
(VM,)f(b)n(ut)g(re)n(vised)f(and)300 776 y(impro)o(v)o(ed)j(for)h
(UVM\),)g Fq(adjusted)i Fs(\(same)f(basic)f(design)g(as)h(BSD)g(VM)f
(with)g(minor)g(cleanups\),)i Fq(r)l(e-)300 896 y(mo)o(ved)22
b Fs(\(BSD)f(layer)e(remo)o(v)o(ed)g(from)g(UVM\).)g(Each)g(function)g
(corresponds)g(to)g(a)h(UVM)f(source-code)300 1017 y(\002le.)p
476 1149 3223 4 v 474 1269 4 121 v 526 1233 a Fo(Function)p
956 1269 V 101 w(Extent)26 b(of)f(Change)p 1797 1269
V 100 w(Description)p 3697 1269 V 476 1272 3223 4 v 474
1393 4 121 v 526 1357 a Fs(amap)p 956 1393 V 266 w(ne)n(w)p
1797 1393 V 677 w(anon)o(ymous)e(memory)h(map)g(management)p
3697 1393 V 476 1396 3223 4 v 474 1637 4 241 v 526 1480
a(aobj)p 956 1637 V 310 w(replaced)p 1797 1637 V 504
w(anon)o(ymous)46 b(memory)h(object)h(pager)l(,)54 b(replaces)1849
1601 y(the)25 b(def)o(ault)f(pager)h(of)g(BSD)h(VM.)p
3697 1637 V 476 1640 3223 4 v 474 1881 4 241 v 526 1724
a(de)n(vice)p 956 1881 V 224 w(replaced)p 1797 1881 V
504 w(de)n(vice)i(pager)h(that)f(conforms)g(to)g(the)g(ne)n(w)h(UVM)
1849 1845 y(pager)c(interf)o(ace)p 3697 1881 V 476 1884
3223 4 v 474 2125 4 241 v 526 1969 a(f)o(ault)p 956 2125
V 300 w(replaced)p 1797 2125 V 504 w(page)65 b(f)o(ault)h(handler)f
(that)g(handles)f(the)h(ne)n(w)1849 2089 y(anon)o(ymous)23
b(memory)h(layer)p 3697 2125 V 476 2128 3223 4 v 474
2249 4 121 v 526 2213 a(init)p 956 2249 V 348 w(adjusted)p
1797 2249 V 508 w(VM)g(startup)g(routine)p 3697 2249
V 476 2252 3223 4 v 474 2493 4 241 v 526 2336 a(km)p
956 2493 V 354 w(re)n(vised)p 1797 2493 V 555 w(k)o(ernel)g(memory)f
(management,)h(re)n(vised)f(for)h(ne)n(w)1849 2457 y(UVM)g(pager)h(and)
g(memory)f(mapping)g(interf)o(aces)p 3697 2493 V 476
2496 3223 4 v 474 2616 4 121 v 526 2580 a(loan)p 956
2616 V 310 w(ne)n(w)p 1797 2616 V 677 w(page)h(loaning)f(\227)g(ne)n(w)
h(UVM)f(feature)p 3697 2616 V 476 2620 3223 4 v 474 2981
4 362 v 526 2704 a(map)p 956 2981 V 310 w(ne)n(w/adjusted)p
1797 2981 V 316 w(memory)43 b(mapping)g(routines)g(\227)g(ne)n(w)h
(features)1849 2824 y(include)19 b(map)g(entry)g(passing)g(and)g
(related)h(support)1849 2945 y(functions)p 3697 2981
V 476 2984 3223 4 v 474 3225 4 241 v 526 3069 a(map)25
b(i/o)p 956 3225 V 179 w(ne)n(w)p 1797 3225 V 677 w(map)j(I/O)g
(function)f(\(allo)n(ws)g(reads)i(and)f(writes)f(to)1849
3189 y(a)e(map\))p 3697 3225 V 476 3228 3223 4 v 474
3469 4 241 v 526 3313 a(mmap)p 956 3469 V 232 w(replaced/adjusted)p
1797 3469 V 143 w Fm(mmap)e Fs(system)f(call)h(replaced,)i(other)e
(related)g(sys-)1849 3433 y(tem)h(calls)h(adjusted)p
3697 3469 V 476 3472 3223 4 v 474 3834 4 362 v 526 3557
a(object)p 956 3834 V 238 w(remo)o(v)o(ed)p 1797 3834
V 494 w(object)19 b(management)f(code,)j(obsolete)d(due)i(to)e(ne)n(w)
1849 3677 y(UVM)46 b(pager)i(and)f(anon)o(ymous)e(memory)h(han-)1849
3797 y(dling)p 3697 3834 V 476 3837 3223 4 v 474 4078
4 241 v 526 3921 a(page)p 956 4078 V 294 w(re)n(vised)p
1797 4078 V 555 w(page)64 b(management,)73 b(re)n(vised)63
b(for)i(ne)n(w)e(non-)1849 4042 y(contiguous)23 b(physical)h(memory)g
(handling)p 3697 4078 V 476 4081 3223 4 v 474 4442 4
362 v 526 4165 a(pager)p 956 4442 V 261 w(replaced/re)n(vised)p
1797 4442 V 190 w(pager)g(interf)o(ace)g(\227)f(BSD)h(VM')-5
b(s)23 b(pager)g(structure)1849 4286 y(has)38 b(been)h(remo)o(v)o(ed)e
(and)i(the)f(pager)h(operations)1849 4406 y(re)n(vised)p
3697 4442 V 476 4445 3223 4 v 474 4686 4 241 v 526 4530
a(pdaemon)p 956 4686 V 116 w(re)n(vised)p 1797 4686 V
555 w(the)30 b(pageout)g(daemon,)g(re)n(vised)g(for)g(ne)n(w)g(anon)o
(y-)1849 4650 y(mous)24 b(memory)g(handling)p 3697 4686
V 476 4690 3223 4 v 474 4810 4 121 v 526 4774 a(sw)o(ap)p
956 4810 V 278 w(adjusted)p 1797 4810 V 508 w(NetBSD)h(speci\002c)h(sw)
o(ap-space)f(management)p 3697 4810 V 476 4813 3223 4
v 474 5054 4 241 v 526 4898 a(vnode)p 956 5054 V 238
w(re)n(vised)p 1797 5054 V 555 w(vnode)40 b(pager)l(,)k(re)n(vised)c
(for)g(UVM)g(pager)g(inter)n(-)1849 5018 y(f)o(ace)p
3697 5054 V 476 5057 3223 4 v eop
%%Page: 54 74
54 73 bop 3800 100 a Fs(54)300 234 y(T)-8 b(able)22 b(3.2:)29
b(Issues)21 b(addressed)h(by)f(UVM)h(and)g(the)f(sections)g(of)h(this)f
(dissertation)g(that)g(address)h(them.)300 354 y(The)39
b(issues)f(are)h(grouped)f(into)g(eight)g(cate)o(gories:)58
b(general,)42 b(anon)o(ymous)37 b(memory)-6 b(,)41 b(page)d(f)o(ault,)
300 474 y(pager)l(,)25 b(page,)g(map,)f(pmap,)h(and)f(tools)g(and)h
(implementation)d(methods.)p 341 620 3519 4 v 341 620
V 339 740 4 121 v 391 704 a Fo(Category)p 1099 740 V
366 w(Issue)p 1648 740 V 334 w(Section)p 2108 740 V 150
w(Description)p 3858 740 V 341 743 3519 4 v 341 743 V
339 1225 4 482 v 391 828 a Fs(general)p 1099 1225 V 466
w(locking)p 1648 1225 V 250 w(3.3.2)p 2108 1225 V 259
w(design)f(of)g(a)g(ne)n(w)g(locking)f(scheme)h(that)g(tak)o(es)2159
948 y(into)i(account)g(UVM)g(data)h(structure)f(changes)2159
1068 y(and)f(restores)f(\002ne-grain)g(locking)f(dropped)h(in)2159
1189 y(BSD)26 b(VM)p 3858 1225 V 341 1228 3519 4 v 341
1228 V 339 1589 4 362 v 391 1313 a(anon)o(ymous)391 1433
y(memory)p 1099 1589 V 1150 1313 a(amap)p 1648 1589 V
334 w(4)p 2108 1589 V 409 w(design)e(of)h(a)g(ne)n(w)f(anon)o(ymous)f
(memory)h(sys-)2159 1433 y(tem)k(based)f(on)h(the)f(amap)h(idea)g(from)
f(SunOS)2159 1553 y(4)e(with)f(UVM)h(impro)o(v)o(ements)p
3858 1589 V 1100 1593 2759 4 v 339 2071 4 482 v 1099
2071 V 1150 1674 a(inheritance)p 1648 2071 V 107 w(4.7)p
2108 2071 V 334 w(a)45 b(problem)f(f)o(aced)h(when)f(trying)g(to)g(get)
g(an)2159 1794 y(amap-based)36 b(anon)o(ymous)e(memory)h(system)2159
1914 y(to)57 b(support)f(Mach-style)g(memory)g(inheri-)2159
2035 y(tance)26 b(during)e(a)h Fm(fork)f Fs(operation)p
3858 2071 V 1100 2074 2759 4 v 339 2552 4 482 v 1099
2552 V 1150 2155 a(stack)63 b(allo-)1150 2276 y(cation)p
1648 2552 V 1700 2155 a(8.1)p 2108 2552 V 334 w(a)22
b(memory-usage)f(problem)f(f)o(aced)i(when)g(try-)2159
2276 y(ing)e(to)g(use)g(BSD-style)h(stack)f(allocation)f(with)2159
2396 y(an)33 b(amap-based)f(anon)o(ymous)e(memory)i(sys-)2159
2516 y(tem)p 3858 2552 V 1100 2556 2759 4 v 339 3034
4 482 v 1099 3034 V 1150 2637 a(partial)62 b(un-)1150
2757 y(map)46 b(mem-)1150 2878 y(ory)25 b(leak)p 1648
3034 V 1700 2637 a(4.3.2)p 2108 3034 V 259 w(design)54
b(of)g(a)g(ne)n(w)g(scheme)g(for)g(releasing)2159 2757
y(anon)o(ymous)i(memory)g(associated)h(with)f(a)2159
2878 y(map)41 b(entry)g(when)g(that)g(map)g(entry)g(is)f(only)2159
2998 y(partially)24 b(unmapped.)p 3858 3034 V 341 3037
3519 4 v 341 3037 V 339 3760 4 723 v 391 3122 a(page)h(f)o(ault)p
1099 3760 V 364 w(f)o(ault)p 1648 3760 V 368 w(5)p 2108
3760 V 409 w(design)40 b(of)g(a)g(ne)n(w)g(page)g(f)o(ault)g(handler)g
(that)2159 3242 y(uses)24 b(amap-based)g(anon)o(ymous)e(memory)h(for)
2159 3362 y(cop)o(y-on-write)53 b(rather)g(than)g(Mach)g(object)2159
3483 y(chains)29 b(and)f(also)h(attempts)e(to)h(reduce)i(future)2159
3603 y(f)o(aults)d(by)g(taking)f(into)g(account)h(the)f(memory)2159
3724 y(usage)f(of)g(the)g(f)o(aulting)f(process)p 3858
3760 V 341 3763 3519 4 v 341 3763 V 339 4606 4 843 v
391 3847 a(pager)p 1099 4606 V 538 w(pager)p 1648 4606
V 329 w(6)p 2108 4606 V 409 w(design)38 b(of)h(a)g(ne)n(w)f(pager)h
(interf)o(ace)g(that)f(re-)2159 3968 y(mo)o(v)o(es)45
b(an)h(unnecessary)g(layer)g(\(the)h(Mach)2159 4088 y(VM)39
b(pager)h(layer\))f(and)g(changes)h(the)f(inter)n(-)2159
4208 y(f)o(ace)k(to)e(backing)h(store)f(to)g(match)g(the)h(ne)n(w)2159
4329 y(amap-based)36 b(anon)o(ymous)e(memory)h(system)2159
4449 y(and)25 b(to)f(gi)n(v)o(e)g(the)g(pager)i(more)e(po)n(wer)g(o)o
(v)o(er)g(its)2159 4570 y(pages)p 3858 4606 V 1100 4609
2759 4 v 339 5087 4 482 v 1099 5087 V 1150 4690 a(clustered)1150
4810 y(pageout)p 1648 5087 V 1700 4690 a(8.2)p 2108 5087
V 334 w(a)e(ne)n(w)f(design)g(that)f(allo)n(ws)g(the)i(page)f(daemon)
2159 4810 y(to)31 b(dynamically)f(cluster)g(anon)o(ymous)f(mem-)2159
4931 y(ory)45 b(being)g(paged)g(out)g(into)f(lar)n(ge)h(chunks,)2159
5051 y(thus)24 b(reducing)h(pageout)f(o)o(v)o(erhead)p
3858 5087 V 1100 5090 2759 4 v 341 5093 3519 4 v 341
5093 V eop
%%Page: 55 75
55 74 bop 3800 100 a Fs(55)1644 234 y(T)-8 b(able)25
b(3.2:)30 b(\(continued\))p 341 375 3519 4 v 341 375
V 339 495 4 121 v 391 459 a Fo(Category)p 1099 495 V
366 w(Issue)p 1648 495 V 334 w(Section)p 2108 495 V 150
w(Description)p 3858 495 V 341 499 3519 4 v 341 499 V
339 1097 4 602 v 1099 1097 V 1150 580 a Fs(\002ctitious)1150
700 y(de)n(vice)1150 821 y(pages)p 1648 1097 V 1700 580
a(8.4)p 2108 1097 V 334 w(redesign)42 b(of)h(the)f(de)n(vice)g(pager)h
(to)e(use)i(the)2159 700 y(ne)n(w)49 b(pager)g(f)o(ault)g(interf)o(ace)
g(so)g(that)f(it)h(no)2159 821 y(longer)i(needs)g(to)f(create)i(and)f
(pass)f(\223\002cti-)2159 941 y(tious\224)31 b Fm(vm)p
2555 941 30 4 v 35 w(page)f Fs(structures)h(up)g(to)g(the)g(rest)2159
1061 y(of)25 b(the)g(VM)p 3858 1097 4 602 v 1100 1101
2759 4 v 339 1699 4 602 v 1099 1699 V 1150 1182 a(aobj)g(pager)p
1648 1699 V 132 w(8.3)p 2108 1699 V 334 w(design)d(of)h(a)g(ne)n(w)f
(pager)h(that)f(supports)f(UVM)2159 1302 y(objects)51
b(that)g(are)i(back)o(ed)e(by)h(anon)o(ymous)2159 1422
y(memory;)24 b(this)g(pager)h(is)f(used)h(to)f(pro)o(vide)g(the)2159
1543 y(System)35 b(V)f(shared)h(memory)f(interf)o(ace,)k(and)2159
1663 y(also)25 b(to)f(support)g(pageable)h(k)o(ernel)g(memory)p
3858 1699 V 1100 1703 2759 4 v 339 2301 4 602 v 1099
2301 V 1150 1784 a(vnode)1150 1904 y(pager)p 1648 2301
V 1700 1784 a(8.5)p 2108 2301 V 334 w(redesign)32 b(of)g(the)g(vnode)g
(pager)g(to)g(allo)n(w)f(the)2159 1904 y(k)o(ernel')-5
b(s)29 b(vnode)g(system)f(to)h(control)f(the)h(per)n(-)2159
2024 y(sistence)46 b(of)g(vnode)g(VM)g(data)g(rather)h(than)2159
2145 y(ha)n(v)o(e)29 b(it)f(done)g(both)g(by)h(the)f(VM)h(and)f(the)h
(vn-)2159 2265 y(ode)c(systems)p 3858 2301 V 1100 2305
2759 4 v 339 2783 4 482 v 1099 2783 V 1150 2385 a(vnode)f(sync)p
1648 2783 V 99 w(8.5.3)p 2108 2783 V 259 w(impro)o(v)o(ed)j(the)h
(design)f(of)h(the)g(memory)g(sync)2159 2506 y(code)43
b(to)f(only)f(consider)h(vnodes)f(that)h(ha)n(v)o(e)2159
2626 y(writable)35 b(pages)g(rather)h(than)f(all)f(vnodes)h(on)2159
2747 y(the)25 b(system)p 3858 2783 V 1100 2786 2759 4
v 339 3023 4 241 v 1099 3023 V 1150 2867 a(async)g(I/O)p
1648 3023 V 165 w(6.3.3)p 2108 3023 V 259 w(redesign)43
b(of)f(the)h(asynchronous)e(I/O)i(inter)n(-)2159 2987
y(f)o(ace)26 b(to)f(clean)g(up)f(its)g(handling)p 3858
3023 V 341 3027 3519 4 v 341 3027 V 339 3629 4 602 v
391 3111 a(page)p 1099 3629 V 571 w(loanout)p 1648 3629
V 250 w(7.1)p 2108 3629 V 334 w(a)51 b(ne)n(w)f(design)f(that)h(lets)g
(virtual)f(memory)2159 3231 y(pages)40 b(be)f(read-only)g
(\223loaned\224)h(to)f(the)g(k)o(er)n(-)2159 3352 y(nel)34
b(or)g(to)g(other)g(processes)f(\(in)h(the)g(form)f(of)2159
3472 y(anon)o(ymous)38 b(memory\))g(without)g(disrupting)2159
3593 y(the)25 b(normal)f(operation)g(of)h(the)g(VM)f(system)p
3858 3629 V 1100 3632 2759 4 v 339 4231 4 602 v 1099
4231 V 1150 3713 a(transfer)p 1648 4231 V 246 w(7.2)p
2108 4231 V 334 w(a)e(ne)n(w)f(design)g(that)g(allo)n(ws)f(other)h(k)o
(ernel)h(sub-)2159 3833 y(systems)31 b(to)g(donate)g(their)h(pages)f
(to)g(the)h(VM)2159 3954 y(system;)39 b(these)c(pages)g(become)h(anon)o
(ymous)2159 4074 y(memory)50 b(and)h(can)g(be)g(mapped)g(into)e(pro-)
2159 4195 y(cesses)p 3858 4231 V 1100 4234 2759 4 v 339
4833 4 602 v 1099 4833 V 1150 4315 a(VM)1150 4435 y(startup)p
1648 4833 V 1700 4315 a(8.12)p 2108 4833 V 284 w(design)68
b(of)h(a)g(ne)n(w)g(VM)f(startup)g(proce-)2159 4435 y(dure)39
b(that)g(has)g(a)g(uni\002ed)g(w)o(ay)g(of)g(handling)2159
4556 y(contiguous)f(and)h(non-contiguous)e(physical)2159
4676 y(memory)25 b(and)g(reduces)g(the)g(number)f(of)h(boot-)2159
4796 y(time)f(statically-allocated)g(data)h(structures)p
3858 4833 V 1100 4836 2759 4 v 339 5194 4 362 v 1099
5194 V 1150 4917 a(ne)n(w)98 b(page)1150 5037 y(\003ags)p
1648 5194 V 1700 4917 a(8.11)p 2108 5194 V 284 w(a)34
b(design)e(cleanup)i(of)f(the)g(page)g(\003ags)h(to)f(re-)2159
5037 y(duce)21 b(the)g(number)f(of)g(\003ags)h(and)g(more)f(clearly)
2159 5158 y(de\002ne)26 b(their)e(locking)p 3858 5194
V 341 5197 3519 4 v 341 5200 V 341 5200 V eop
%%Page: 56 76
56 75 bop 3800 100 a Fs(56)1644 234 y(T)-8 b(able)25
b(3.2:)30 b(\(continued\))p 341 375 3519 4 v 341 375
V 339 495 4 121 v 391 459 a Fo(Category)p 1099 495 V
366 w(Issue)p 1648 495 V 334 w(Section)p 2108 495 V 150
w(Description)p 3858 495 V 341 499 3519 4 v 341 499 V
341 499 V 339 860 4 362 v 391 583 a Fs(map)p 1099 860
V 587 w(map)73 b(entry)1150 703 y(passing)p 1648 860
V 1700 583 a(7.3)p 2108 860 V 334 w(design)23 b(of)g(a)g(map)g(entry)f
(passing)g(system)g(that)2159 703 y(allo)n(ws)f(virtual)g(memory)g(to)g
(easily)g(be)h(passed)2159 824 y(between)j(processes)g(in)f(a)i(number)
e(of)h(w)o(ays)p 3858 860 V 1100 863 2759 4 v 339 1462
4 602 v 1099 1462 V 1150 944 a(map)152 b(e)o(x-)1150
1065 y(traction)p 1648 1462 V 1700 944 a(7.3.2)p 2108
1462 V 259 w(design)26 b(of)g(a)g(map)g(entry)g(e)o(xtraction)f
(function)2159 1065 y(that)i(allo)n(ws)f(map)h(entry)g(passing)f(and)i
(I/O)f(on)2159 1185 y(a)32 b(map;)j(this)30 b(is)h(used)g(for)h(the)g
Fm(ptrace)e Fs(sys-)2159 1305 y(tem)45 b(call)g(and)h(for)f(the)g
(process)g(\002lesystem)2159 1426 y(\(procfs\))p 3858
1462 V 1100 1465 2759 4 v 339 1943 4 482 v 1099 1943
V 1150 1546 a(mapping)p 1648 1943 V 200 w(8.6)p 2108
1943 V 334 w(redesign)34 b(of)f(the)g(mapping)g(interf)o(ace)h(to)f
(use)2159 1666 y(a)46 b(single)f(function)g(that)g(pro)o(vides)f(all)h
(nec-)2159 1787 y(essary)36 b(features)f(and)g(reduces)h(the)f(need)g
(for)2159 1907 y(later)25 b(VM)g(calls)p 3858 1943 V
1100 1947 2759 4 v 339 2425 4 482 v 1099 2425 V 1150
2028 a(unmap)p 1648 2425 V 278 w(8.7)p 2108 2425 V 334
w(redesign)e(of)h(the)f(memory)f(unmapping)g(func-)2159
2148 y(tions)28 b(so)g(that)g(the)o(y)g(only)g(hold)f(the)i(map)f(lock)
2159 2268 y(during)f(address)g(space)g(changes,)h(not)e(during)2159
2389 y(reference)h(drops)p 3858 2425 V 1100 2428 2759
4 v 339 2906 4 482 v 1099 2906 V 1150 2509 a(k)o(ernel)1150
2630 y(memory)1150 2750 y(manage-)1150 2870 y(ment)p
1648 2906 V 1700 2509 a(8.8)p 2108 2906 V 334 w(adjusted)50
b(k)o(ernel)g(memory)f(allocation)h(and)2159 2630 y(management)31
b(functions)f(to)i(tak)o(e)f(adv)n(antage)2159 2750 y(of)i(the)e
(features)i(of)f(the)g(ne)n(w)g(memory)f(map-)2159 2870
y(ping)24 b(function)p 3858 2906 V 1100 2910 2759 4 v
339 3268 4 362 v 1099 3268 V 1150 2991 a(wired)1150 3111
y(memory)p 1648 3268 V 1700 2991 a(8.9)p 2108 3268 V
334 w(re)n(vised)29 b(the)g(handling)f(of)h(wired)g(memory)f(to)2159
3111 y(reduce)40 b(map)e(entry)h(fragmentation)f(both)g(in)2159
3231 y(the)25 b(k)o(ernel)g(and)g(in)f(user)h(processes)p
3858 3268 V 1100 3271 2759 4 v 339 3869 4 602 v 1099
3869 V 1150 3352 a(b)n(uf)n(fer)g(map)p 1648 3869 V 114
w(8.10.1)p 2108 3869 V 209 w(redesigned)33 b(the)h(memory)e(allocation)
g(of)i(the)2159 3472 y(BSD)40 b(b)n(uf)n(fer)f(cache)g(to)f(eliminate)g
(the)g(need)2159 3593 y(for)31 b Fm(buffer)p 2672 3593
30 4 v 34 w(map)p Fs(;)g(this)e(reduces)h(the)g(num-)2159
3713 y(ber)20 b(of)g(statically)e(allocated)h(map)g(entry)h(struc-)2159
3833 y(tures)p 3858 3869 4 602 v 341 3873 3519 4 v 341
3873 V 339 4354 4 482 v 391 3957 a(pmap)p 1099 4354 V
537 w(ne)n(w)109 b(i386)1150 4077 y(pmap)p 1648 4354
V 1700 3957 a(8.14)p 2108 4354 V 284 w(re)n(write)33
b(of)g(the)f(i386)h(MD)f(pmap)g(module)g(to)2159 4077
y(better)46 b(manage)g(memory)f(and)h(incorporate)2159
4198 y(impro)o(v)o(ements)34 b(from)j(other)g(operating)f(sys-)2159
4318 y(tems)25 b(such)f(as)h(FreeBSD)p 3858 4354 V 1100
4358 2759 4 v 339 4715 4 362 v 1099 4715 V 1150 4439
a(ne)n(w)65 b(pmap)1150 4559 y(interf)o(ace)p 1648 4715
V 1700 4439 a(8.13)p 2108 4715 V 284 w(minor)37 b(design)g
(modi\002cations)f(to)i(the)f(pmap)2159 4559 y(interf)o(ace)43
b(to)f(better)h(support)e(page)i(loaning)2159 4679 y(and)25
b(clean)g(up)g(the)g(interf)o(ace)g(\(PMAP)p 3517 4679
30 4 v 36 w(NEW\))p 3858 4715 4 362 v 341 4719 3519 4
v 341 4719 V 339 5080 4 362 v 391 4803 a(tools)k(and)i(imple-)391
4923 y(mentation)c(meth-)391 5044 y(ods)p 1099 5080 V
1150 4803 a(UVM)68 b(his-)1150 4923 y(tory)p 1648 5080
V 1700 4803 a(9.2)p 2108 5080 V 334 w(a)38 b(tool)f(that)g(k)o(eeps)g
(a)h(running)f(log)g(of)g(func-)2159 4923 y(tions)42
b(called)g(during)g(the)g(operation)g(of)h(the)2159 5044
y(VM)25 b(system)p 3858 5080 V 1100 5083 2759 4 v 341
5086 3519 4 v 341 5086 V eop
%%Page: 57 77
57 76 bop 3800 100 a Fs(57)1644 234 y(T)-8 b(able)25
b(3.2:)30 b(\(continued\))p 341 375 3519 4 v 341 375
V 339 495 4 121 v 391 459 a Fo(Category)p 1099 495 V
366 w(Issue)p 1648 495 V 334 w(Section)p 2108 495 V 150
w(Description)p 3858 495 V 341 499 3519 4 v 341 499 V
339 1097 4 602 v 1099 1097 V 1150 580 a Fs(VM)62 b(status)1150
700 y(system)1150 821 y(calls)p 1648 1097 V 1700 580
a(9.4)p 2108 1097 V 334 w(a)f(system)e(call)i(that)f(allo)n(ws)f(an)i
(applica-)2159 700 y(tion)38 b(to)f(get)h(the)g(status)f(of)h(the)g(VM)
g(system)2159 821 y(without)32 b(needing)h(access)g(to)g
Fm(/dev/kmem)p Fs(;)2159 941 y(tw)o(o)19 b(sample)g(applications)e(are)
j(included)e(with)2159 1061 y(UVM:)k(one)h(te)o(xt)f(based,)h(and)g
(one)f(X11)h(based)p 3858 1097 V 1100 1101 2759 4 v 339
1579 4 482 v 1099 1579 V 1150 1182 a(redundant)1150 1302
y(calls)p 1648 1579 V 1700 1182 a(9.2.2)p 2108 1579 V
259 w(discussion)50 b(of)h(the)g(use)g(of)g(UVM)g(deb)n(ug-)2159
1302 y(ging)d(tools)f(used)h(in)g(the)g(detection)g(of)g(re-)2159
1422 y(dundant)e(VM)g(calls)g(in)g(the)g(BSD)h(k)o(ernel')-5
b(s)2159 1543 y(fork/e)o(x)o(ec/e)o(xit)23 b(path)p 3858
1579 V 1100 1582 2759 4 v 339 1940 4 362 v 1099 1940
V 1150 1663 a(amap)29 b(o)o(v)o(er)n(-)1150 1784 y(allocate)p
1648 1940 V 1700 1663 a(9.2.3)p 2108 1940 V 259 w(discussion)48
b(the)h(use)g(of)g(UVM)g(deb)n(ugging)2159 1784 y(tools)37
b(in)h(the)f(detection)h(of)g(the)f(amap)h(o)o(v)o(er)n(-)2159
1904 y(allocation)24 b(problem)g(and)h(the)g(solution)e(to)h(it)p
3858 1940 V 1100 1943 2759 4 v 339 2542 4 602 v 1099
2542 V 1150 2024 a(UVM)68 b(ddb)1150 2145 y(commands)p
1648 2542 V 1700 2024 a(9.3)p 2108 2542 V 334 w(discussion)33
b(of)g(the)h(impro)o(v)o(ements)d(made)j(to)2159 2145
y(ddb,)23 b(the)f(BSD)h(k)o(ernel)f(deb)n(ugger)l(,)h(in)e(order)i(to)
2159 2265 y(help)d(deb)n(ug)g(virtual)f(memory)g(problems;)h(this)2159
2385 y(includes)33 b(ne)n(w)f(features)i(such)f(as)g(b)n(usy-page)2159
2506 y(o)n(wnership)24 b(tracking)p 3858 2542 V 1100
2545 2759 4 v 339 2783 4 241 v 1099 2783 V 1150 2626
a(old)73 b(mmap)1150 2747 y(calls)p 1648 2783 V 1700
2626 a(8.10.2)p 2108 2783 V 209 w(discussion)37 b(of)i(the)g(need)g(to)
f(detect)h(and)g(re-)2159 2747 y(mo)o(v)o(e)24 b(old)g(MAP)p
2777 2747 30 4 v 36 w(FILE)h Fm(mmap)f Fs(system)g(calls)p
3858 2783 4 241 v 341 2786 3519 4 v 341 2786 V 300 3368
a Fg(3.4)143 b(Related)34 b(W)-11 b(ork)300 3621 y Fs(In)28
b(this)f(section)h(we)g(present)g(an)g(o)o(v)o(ervie)n(w)e(of)i
(research)h(that)f(is)f(related)h(to)g(UVM.)g(Such)g(w)o(ork)g(can)300
3770 y(be)d(di)n(vided)e(into)h(tw)o(o)h(cate)o(gories:)420
3977 y(1.)49 b(research)26 b(on)e(the)h(design)f(and)h(implementation)d
(of)j(other)f(virtual)h(memory)e(systems.)420 4201 y(2.)49
b(research)28 b(on)f(I/O)g(and)g(IPC)h(subsystems)e(that)g(tak)o(e)h
(adv)n(antage)g(of)g(virtual)g(memory)f(services)544
4351 y(to)e(impro)o(v)o(e)f(performance.)300 4558 y(W)-8
b(e)25 b(will)f(e)o(xamine)g(related)h(w)o(ork)g(in)f(both)g(cate)o
(gories.)300 4885 y Ff(3.4.1)119 b(Other)30 b(V)l(irtual)g(Memory)f
(Systems)300 5101 y Fs(In)e(this)e(section)h(we)g(e)o(xamine)g(the)g
(structure)g(of)h(other)f(virtual)g(memory)f(systems)g(and)i(e)o
(xamine)e(the)300 5251 y(set)h(of)h(features)g(that)f(the)o(y)g(pro)o
(vide.)35 b(Note)26 b(that)g(the)g(BSD)i(VM)e(system)f(w)o(as)i
(described)f(in)g(detail)g(in)300 5400 y(Chapter)f(2.)p
eop
%%Page: 58 78
58 77 bop 3800 100 a Fs(58)300 249 y Fo(The)26 b(Mach)f(V)l(irtual)h
(Memory)f(System)300 466 y Fs(The)30 b(Mach)f(virtual)g(memory)g
(system)g(is)g(used)h(for)g(memory)f(management)g(and)g(IPC)i(in)f(the)
f(Mach)300 615 y(micro)g(k)o(ernel)h(de)n(v)o(eloped)e(at)i(Carne)o
(gie)f(Mellon)g(Uni)n(v)o(ersity)e([4,)j(57)o(,)g(64,)f(71,)g(72].)45
b(The)30 b(BSD)h(VM)300 764 y(system)19 b(is)g(a)i(simpli\002ed)e(v)o
(ersion)g(of)h(the)g(Mach)g(virtual)f(memory)g(system.)28
b(BSD)21 b(VM)f(and)g(Mach)g(VM)300 914 y(both)i(use)g(the)h(same)g
(mapping)e(structure)h(to)h(map)f(processes)h(address)f(space,)h(shado)
n(w)f(and)h(cop)o(y)f(ob-)300 1063 y(ject)28 b(chains)f(for)h(cop)o
(y-on-write)f(memory)-6 b(,)27 b(and)h(a)g(map-based)g
(machine-dependent)f(virtual)g(mem-)300 1213 y(ory)22
b(layer)-5 b(.)30 b(Ho)n(we)n(v)o(er)l(,)22 b(Mach)g(VM)g(dif)n(fers)h
(from)f(BSD)h(VM)g(in)f(the)g(areas)h(of)g(pager)g(support)e(and)i(IPC)
300 1362 y(data)30 b(mo)o(v)o(ement.)46 b(These)30 b(dif)n(ferences)h
(mak)o(e)f(virtual)g(memory)f(management)h(under)g(Mach)h(much)300
1511 y(more)25 b(comple)o(x)e(than)i(managing)e(memory)h(under)h(BSD.)
583 1661 y(Mach)j(is)e(a)i(microk)o(ernel.)37 b(This)27
b(means)g(that)f(only)h(the)g(core)h(aspects)f(of)g(the)g(operating)g
(sys-)300 1810 y(tem)k(are)i(actually)e(part)h(of)g(the)g(k)o(ernel.)51
b(These)32 b(services)g(include)f(virtual)g(memory)g(management,)300
1960 y(interprocess)f(communication,)f(and)h(task)g(scheduling.)46
b(All)29 b(other)i(aspects)f(of)g(the)g(operating)g(sys-)300
2109 y(tem)f(such)h(as)g(protocol)f(processing,)h(\002lesystems,)g
(pagers,)h(and)f(system)f(call)h(handling)e(ha)n(v)o(e)i(been)300
2258 y(pushed)g(out)g(into)g(separate)h(\223serv)o(er\224)h(processes.)
48 b(Processes)31 b(communicate)f(with)g(the)g(k)o(ernel)h(and)300
2408 y(each)c(other)g(by)g(sending)e(messages)i(to)f(each)h(other)g
(using)f(Mach)h(message)f(passing)g(IPC.)i(The)e(goal)300
2557 y(behind)19 b(this)f(structure)h(is)f(to)h(enforce)h(modularity)e
(on)h(the)g(operating)f(system)h(and)g(to)g(ease)g(deb)n(ugging)300
2707 y(by)25 b(allo)n(wing)e(the)h(Mach)h(serv)o(ers)g(to)f(be)h(deb)n
(ugged)f(without)g(the)g(need)h(to)g(reboot)f(the)h(microk)o(ernel.)583
2856 y Fo(Message)k(passing)o(.)43 b Fs(Because)30 b(of)f(the)g(number)
f(of)h(serv)o(er)g(processes)g(needed)g(to)g(pro)o(vide)f(a)300
3005 y(useful)c(operating)f(system)g(the)h(performance)h(of)f(Mach)g
(is)g(greatly)g(dependent)g(on)g(the)g(performance)300
3155 y(of)32 b(its)e(message)i(passing)e(mechanism.)50
b(Mach)32 b(message)f(passing)f(operates)i(in)f(one)h(of)f(tw)o(o)g(w)o
(ays.)300 3304 y(If)j(the)g(message)g(is)f(small,)i(then)f(the)g(data)g
(is)f(copied)h(into)f(a)h(k)o(ernel)h(b)n(uf)n(fer)e(and)h(then)g
(copied)g(out)300 3454 y(to)29 b(the)g(recipient.)43
b(Ho)n(we)n(v)o(er)l(,)28 b(if)h(the)g(message)g(is)f(lar)n(ge)i(then)f
(the)f(virtual)h(memory)f(system)g(is)g(used)300 3603
y(to)j(transfer)h(the)g(message')-5 b(s)30 b(data.)51
b(Since)32 b(the)g(data)g(tra)n(v)o(els)e(separately)i(from)f(the)h
(message)f(this)g(is)300 3752 y(called)25 b(an)g(\223out-of-line\224)f
(message.)583 3902 y(Out-of-line)19 b(messages)g(are)h(transferred)g
(between)g(address)f(spaces)h(using)e(a)i(virtual)f(memory)300
4051 y(data)j(structure)g(called)g(a)h Fq(copy)f(map)p
Fs(.)30 b(In)22 b(this)g(conte)o(xt)f(a)h(cop)o(y)g(map)g(can)h(be)f
(thought)f(of)h(as)h(a)f Fm(vm)p 3691 4051 30 4 v 36
w(map)300 4201 y Fs(that)j(is)f(not)h(associated)f(with)g(an)o(y)h
(process.)31 b(T)-8 b(o)25 b(send)g(a)g(Mach)g(message,)g(the)g
(virtual)f(address)h(space)300 4350 y(containing)30 b(the)g(message)h
(is)g(cop)o(y-on-write)f(copied)h(into)f(the)h(cop)o(y)f(map)h(using)f
(Mach')-5 b(s)30 b(shado)n(w)300 4499 y(and)39 b(cop)o(y)h(objects.)74
b(The)39 b(cop)o(y)g(map)g(is)g(then)g(passed)h(to)f(the)g(recipient)g
(of)h(the)f(message.)74 b(The)300 4649 y(recipient)26
b(then)g(copies)h(the)f(message)g(to)g(its)g(address)g(space.)36
b(This)26 b(mechanism)g(is)g(similar)f(to)h(using)300
4798 y(the)f(cop)o(y-on-write)f(feature)h(of)g(UVM')-5
b(s)24 b(map)h(entry)f(passing)g(mechanism.)583 4948
y(The)36 b(out-of-line)f(message)g(passing)f(f)o(acility)h(w)o(as)h
(found)f(to)g(be)h(too)f(e)o(xpensi)n(v)o(e)e(in)i(a)h(net-)300
5097 y(w)o(orking)26 b(en)l(vironment)g(due)h(to)g(the)g(high)f(o)o(v)o
(erhead)g(of)i(Mach)f(virtual)f(memory)g(object)h(operations)300
5246 y([4].)33 b(T)-8 b(o)25 b(solv)o(e)f(this)g(problem,)h(the)g(cop)o
(y)g(map)g(w)o(as)g(modi\002ed.)32 b(Instead)25 b(of)h(just)e(being)h
(able)g(to)g(trans-)300 5396 y(fer)i(a)f(list)f(of)h(map)g(entries,)g
(the)g(cop)o(y)g(object)g(w)o(as)g(o)o(v)o(erloaded)f(to)g(also)h(be)g
(able)g(to)g(transfer)h(a)f(list)f(of)p eop
%%Page: 59 79
59 78 bop 3800 100 a Fs(59)300 249 y Fm(vm)p 426 249
30 4 v 35 w(page)29 b Fs(structures.)44 b(This)29 b(reduces)h(the)f(o)o
(v)o(erhead)g(of)g(sending)g(data)g(o)o(v)o(er)g(a)h(netw)o(ork.)44
b(T)-8 b(o)29 b(send)300 398 y(a)g(message)f(with)f(this)g(mechanism)h
(the)g(data)g(pages)g(are)h(f)o(aulted)g(in,)f(mark)o(ed)g(b)n(usy)-6
b(,)28 b(and)h(put)e(in)h(the)300 548 y(page)i(list)f(of)i(the)f(cop)o
(y)g(map.)46 b(The)30 b(cop)o(y)g(map)g(is)g(then)g(passed)g(to)f(the)h
(netw)o(orking)f(system)h(which)300 697 y(transmits)i(the)h(pages)g
(and)g(then)g(clears)g(the)g(b)n(usy)g(bit.)55 b(The)33
b(pages)g(are)h(mark)o(ed)f(b)n(usy)f(while)h(the)o(y)300
847 y(are)28 b(in)f(transit,)h(so)f(the)o(y)f(cannot)i(be)f(modi\002ed)
g(until)f(the)i(netw)o(ork)f(operation)g(is)g(complete.)38
b(Further)300 996 y(optimizations)26 b(to)i(this)f(approach)h(allo)n(w)
g(pages)g(to)g(be)g(\223pinned\224)g(in)g(memory)f(for)i(some)e(cases,)
j(b)n(ut)300 1145 y(for)j(other)g(cases)h(the)f(data)g(has)g(to)f(be)i
(\223stolen\224)e(\(i.e.)56 b(copied)33 b(into)f(a)h(freshly)g
(allocated)g(page\).)56 b(A)300 1295 y(cop)o(y)22 b(map)f(may)h
(contain)f(only)h(a)g(limited)e(number)i(of)g(pages.)29
b(If)23 b(the)f(message)f(contains)g(more)h(pages)300
1444 y(than)i(will)f(\002t)h(in)g(a)g(cop)o(y)g(map,)g(then)f(a)i
(\223continuation\224)d(is)i(used.)30 b(A)24 b(continuation)e(is)i(a)g
(call)g(back)h(that)300 1594 y(allo)n(ws)f(the)g(ne)o(xt)g(set)h(of)g
(pages)f(to)h(be)g(loaded)f(into)g(a)h(cop)o(y)g(map.)583
1743 y Fo(Exter)o(nal)39 b(pagers.)70 b Fs(Another)37
b(feature)i(of)f(Mach)g(is)f(e)o(xternal)g(pagers.)70
b(In)38 b(BSD)h(VM)e(all)300 1892 y(pagers)28 b(are)g(compiled)f(into)g
(the)h(k)o(ernel)g(and)f(are)i(trusted.)39 b(Mach)27
b(allo)n(ws)g(a)h(user)g(process)g(\(possibly)300 2042
y(a)d(Mach)g(\223serv)o(er\224\))g(to)g(act)g(as)g(a)g(pager)g(for)g(a)
h Fm(vm)p 2013 2042 V 35 w(object)p Fs(.)k(When)24 b(Mach')-5
b(s)25 b(pagedaemon)f(w)o(ants)g(to)300 2191 y(pageout)h(a)h(page)g
(that)f(is)h(managed)f(by)g(an)h(e)o(xternal)f(pager)h(it)g(has)f(to)g
(send)h(that)f(pager)h(a)g(message)f(to)300 2341 y(pageout)i(the)g
(page.)38 b(Since)28 b(the)f(pager)h(is)e(an)i(untrusted)e(user)h
(process)g(it)g(may)g(decide)g(to)g(ignore)g(the)300
2490 y(pagedaemon')-5 b(s)26 b(pageout)h(request,)h(thus)e(creating)i
(an)f(unf)o(air)h(situation.)36 b(T)-8 b(o)27 b(address)h(this)e
(problem,)300 2639 y(the)d(cop)o(y)f(map)h(structure)g(w)o(as)f
(modi\002ed)h(to)f(contain)g(a)i(pointer)e(to)g(a)i(cop)o(y)e(map)h
(cop)o(y)f(object.)30 b(When)300 2789 y(the)j(pagedaemon)f(w)o(ants)g
(to)g(page)h(out)g(a)g(page)g(of)f(memory)g(managed)h(by)f(an)h
(untrusted)f(e)o(xternal)300 2938 y(pager)d(it)f(allocates)g(a)h(ne)n
(w)f(cop)o(y)h(map)f(and)h(a)f(ne)n(w)h Fm(vm)p 2262
2938 V 35 w(object)e Fs(to)i(act)f(as)h(that)f(cop)o(y)h(map')-5
b(s)27 b(cop)o(y)300 3088 y(object.)49 b(The)31 b(pages)g(to)g(be)g
(paged)g(out)g(are)g(then)g(inserted)g(into)f(the)h(cop)o(y)g(map')-5
b(s)30 b(cop)o(y)h(object)f(and)300 3237 y(the)f(cop)o(y)f(map)g(is)h
(passed)f(to)h(the)f(e)o(xternal)g(pager)-5 b(.)43 b(The)28
b(cop)o(y)h(map')-5 b(s)28 b(cop)o(y)g(object)h(is)f(managed)g(by)300
3386 y(the)h(def)o(ault)g(pager)-5 b(.)44 b(The)29 b(def)o(ault)g
(pager)g(is)g(a)h(trusted)e(pager)i(that)e(is)h(part)g(of)h(the)f(k)o
(ernel)g(and)g(pages)300 3536 y(anon)o(ymous)20 b(memory)h(out)g(to)h
(the)g(sw)o(ap)g(area)g(of)h(disk.)28 b(So,)23 b(if)f(an)g(e)o(xternal)
g(pager)g(ignores)f(a)i(pageout)300 3685 y(request)i(from)g(the)g
(pagedaemon)g(its)g(pages)g(will)f(get)h(paged)h(out)e(by)h(the)g(def)o
(ault)g(pager)h(through)e(the)300 3835 y(cop)o(y)k(map')-5
b(s)27 b(cop)o(y)h(object.)39 b(Note)28 b(that)g(this)f(creates)h(a)h
(problem:)36 b(the)27 b(pages)h(to)g(be)g(paged)g(out)f(ha)n(v)o(e)300
3984 y(to)d(belong)f(to)h(both)f(the)h Fm(vm)p 1272 3984
V 36 w(object)f Fs(that)g(belongs)g(to)h(the)g(e)o(xternal)g(pager)g
(and)g(to)g(the)g(cop)o(y)g(map')-5 b(s)300 4133 y(cop)o(y)20
b(object.)29 b(Mach)21 b(solv)o(es)e(this)h(problem)g(by)g(allo)n(wing)
f(pages)i(to)f(be)h(\223double)f(mapped.)-7 b(\224)29
b(A)21 b(double)300 4283 y(mapped)26 b(page)h(is)f(a)h(page)g(of)g
(physical)e(memory)h(that)g(has)h(tw)o(o)f(or)h(more)f
Fm(vm)p 3041 4283 V 36 w(page)f Fs(structures)i(that)300
4432 y(refer)40 b(to)e(it.)72 b(In)39 b(our)f(e)o(xample,)j(the)e(main)
f Fm(vm)p 2017 4432 V 35 w(page)g Fs(will)g(belong)g(to)g(the)h(e)o
(xternally)e(managed)300 4581 y(object)27 b(and)h(the)f(second)g
Fm(vm)p 1322 4581 V 36 w(page)g Fs(belongs)f(to)h(the)h(cop)o(y)f(map')
-5 b(s)27 b(cop)o(y)g(object.)39 b(Note)27 b(that)g(neither)300
4731 y(BSD)d(VM)e(nor)h(UVM)f(need)h(or)g(allo)n(w)f(double)g(mapped)g
(pages.)30 b(In)23 b(BSD)h(VM)e(there)h(is)f(a)h(one-to-one)300
4880 y(correspondence)i(between)g(a)g Fm(vm)p 1502 4880
V 35 w(page)f Fs(and)h(a)g(page)g(of)g(physical)f(memory)-6
b(.)583 5030 y(In)25 b(current)g(v)o(ersions)f(of)h(Mach)g(a)g(cop)o(y)
f(map)h(can)g(contain)f(one)h(of)g(four)g(possible)e(items:)445
5262 y Fr(\017)49 b Fs(a)25 b(list)f(of)h(map)f(entries)h(\(lik)o(e)f
(a)h(normal)f(map\))p eop
%%Page: 60 80
60 79 bop 3800 100 a Fs(60)445 249 y Fr(\017)49 b Fs(a)25
b(cop)o(y)g(object)445 481 y Fr(\017)49 b Fs(a)25 b(list)f(of)h(pages)
445 714 y Fr(\017)49 b Fs(a)25 b(pointer)f(to)h(an)g(area)g(of)g(k)o
(ernel)g(memory)300 946 y(There)31 b(are)h(a)f(number)f(of)h(functions)
f(that)g(con)l(v)o(ert)g(cop)o(y)h(maps)f(between)h(these)f(four)h
(formats)f(\(b)n(ut)300 1096 y(not)24 b(all)h(con)l(v)o(ersions)e(are)j
(supported\).)583 1245 y Fo(Fictitious)i(pages.)38 b
Fs(Mach)28 b(also)f(mak)o(es)g(hea)n(vy)g(use)h(of)f(\002ctitious)g
(pages.)38 b(A)28 b(\002ctitious)e(page)300 1394 y(is)f(a)h
Fm(vm)p 588 1394 30 4 v 35 w(page)f Fs(structure)g(that)g(has)h(no)f
(physical)f(memory)h(allocated)g(to)h(it.)32 b(These)25
b(pages)h(are)g(often)300 1544 y(used)39 b(as)h(b)n(usy-page)g(place)g
(holders)f(to)g(temporarily)g(block)g(access)i(to)e(certain)h(data)g
(structures.)300 1693 y(Mach)22 b(freely)g(mo)o(v)o(es)e(physical)h
(memory)g(between)g(normal)h(pages)f(and)h(\002ctitious)f(pages,)h(so)g
(normal)300 1843 y(pages)j(can)g(easily)f(become)h(\002ctitious)f(and)g
(vice-v)o(ersa.)583 1992 y(Mach)g(VM)f(suf)n(fers)g(from)g(the)g(same)h
(sort)f(of)g(problems)g(that)g(BSD)h(VM)f(does.)30 b(It)23
b(has)h(a)f(com-)300 2141 y(ple)o(x)g(multi-le)n(v)o(el)e
(object-chaining)h(based)i(cop)o(y-on-write)f(and)h(mapping)e
(mechanism.)30 b(It)23 b(does)h(not)300 2291 y(allo)n(w)i(pages)g(to)g
(be)h(shared)g(cop)o(y-on-write)f(without)f(using)h(this)f(mechanism.)
35 b(Thus,)27 b(it)f(is)g(dif)n(\002cult)300 2440 y(to)j(ha)n(v)o(e)h
(page-le)n(v)o(el)e(granularity)h(without)g(the)g(e)o(xtra)h(o)o(v)o
(erhead)f(of)g(allocating)g(numerous)g(objects.)300 2590
y(This)j(combined)g(with)h(its)f(page)h(wiring)g(mechanism)f(can)h
(lead)g(to)g(map)g(entry)g(fragmentation.)54 b(It)300
2739 y(also)24 b(suf)n(fers)h(from)f(the)h(same)g(partial)f(unmap)g(sw)
o(ap-memory)g(leak)h(problem)f(that)g(BSD)i(VM)e(does.)300
3034 y Fo(The)i(Fr)n(eeBSD)g(V)l(irtual)g(Memory)f(System)300
3251 y Fs(The)g(FreeBSD)h(virtual)e(memory)g(system)g(is)g(an)h(impro)o
(v)o(ed)e(v)o(ersion)g(of)i(the)g(BSD)g(VM)g(system)e([25].)300
3400 y(One)j(of)h(the)f(main)g(emphases)g(of)g(w)o(ork)g(on)g(the)g
(FreeBSD)j(VM)d(system)f(is)h(ensuring)f(that)h(FreeBSD)300
3550 y(performs)j(well)g(under)g(load.)44 b(Thus,)29
b(FreeBSD)i(is)e(a)h(popular)e(operating)h(system)f(for)h(netw)o(ork)g
(and)300 3699 y(\002le)c(serv)o(ers.)583 3848 y(W)-8
b(ork)38 b(on)f(FreeBSD)j(VM)d(has)h(focused)f(on)g(a)h(number)f(of)h
(areas)g(including)f(simplifying)300 3998 y(data)26 b(structure)f
(management,)f(data)i(caching,)f(and)h(ef)n(\002cient)f(paging)g
(algorithms.)31 b(FreeBSD)c(VM')-5 b(s)300 4147 y(data)36
b(structures)g(are)h(similar)f(to)g(BSD)h(VM')-5 b(s)35
b(data)i(structures,)i(although)c(some)h(structures)f(ha)n(v)o(e)300
4297 y(been)i(eliminated.)65 b(F)o(or)36 b(e)o(xample,)j(FreeBSD)g(VM)d
(no)g(longer)h(has)f(share)h(maps)f(or)h(cop)o(y)g(object)300
4446 y(chains.)71 b(Since)39 b(neither)f(of)g(these)g(are)h(needed)g
(to)f(pro)o(vide)f(a)i(Unix-lik)o(e)e(virtual)h(memory)f(en)l(vi-)300
4595 y(ronment)e(their)g(elimination)f(reduces)i(the)g(comple)o(xity)e
(of)h(FreeBSD)j(VM.)d(While)h(FreeBSD)h(re-)300 4745
y(tains)27 b(Mach-style)g(shado)n(w)f(object)h(chaining)g(for)g(cop)o
(y-on-write,)h(the)f(sw)o(ap)g(memory)g(leaks)g(asso-)300
4894 y(ciated)f(with)f(BSD)h(VM')-5 b(s)25 b(poor)h(handling)e(of)i
(the)f(object)h(collapse)f(problem)g(ha)n(v)o(e)g(been)h(addressed.)300
5043 y(FreeBSD)e(has)e(successfully)f(mer)n(ged)h(the)f(VM)h(data)g
(cache)h(with)e(the)h(Unix-style)e(b)n(uf)n(fer)i(cache)h(thus)300
5193 y(allo)n(wing)33 b(VM)i(and)g(I/O)g(to)g(tak)o(e)g(better)g(adv)n
(antage)g(of)g(a)n(v)n(ailable)f(memory)-6 b(.)60 b(FreeBSD')-5
b(s)37 b(paging)p eop
%%Page: 61 81
61 80 bop 3800 100 a Fs(61)300 249 y(algorithms)34 b(use)i(clustered)f
(I/O)h(when)f(possible)f(and)i(attempt)f(to)g(optimize)f(read-ahead)j
(and)f(pa-)300 398 y(geout)f(operations)f(to)h(minimize)e(VM)i(I/O)g(o)
o(v)o(erhead.)61 b(These)35 b(paging)g(algorithms)e(contrib)n(ute)h(to)
300 548 y(FreeBSD')-5 b(s)26 b(good)e(performance)i(under)e(load.)583
697 y(FreeBSD')-5 b(s)25 b(impro)o(v)o(ements)20 b(to)j(object)f
(chaining)g(produce)h(similar)f(performance)i(impro)o(v)o(e-)300
847 y(ments)f(as)h(UVM')-5 b(s)23 b(elimination)f(of)j(object)e
(chaining,)h(ho)n(we)n(v)o(er)e(the)i(comple)o(xities)e(of)i(object)g
(chain-)300 996 y(ing)33 b(remain)h(in)f(FreeBSD.)j(Man)o(y)d(of)h
(FreeBSD')-5 b(s)35 b(impro)o(v)o(ements)c(in)j(the)g(areas)g(of)g
(data)g(caching)300 1145 y(and)27 b(paging)f(algorithms)f(are)j
(applicable)e(to)g(UVM,)h(thus)f(FreeBSD)i(will)e(be)h(a)g(good)f
(reference)j(for)300 1295 y(future)g(w)o(ork)f(on)g(UVM)g(in)g(these)h
(areas.)42 b(FreeBSD)31 b(does)d(not)g(ha)n(v)o(e)g(UVM-style)g
(features)h(such)f(as)300 1444 y(page)e(loanout)f(and)h(page)g
(transfer)-5 b(.)33 b(These)26 b(features)g(could)g(be)g(added)g(to)f
(FreeBSD)j(with)d(some)g(dif-)300 1594 y(\002culty)-6
b(,)23 b(alternati)n(v)o(ely)e(object)h(chaining)g(could)h(be)g
(eliminated)f(from)g(FreeBSD)j(and)e(UVM)g(features)300
1743 y(added.)300 2038 y Fo(The)j(SunOS/Solaris)f(V)l(irtual)g(Memory)g
(System)300 2255 y Fs(The)h(SunOS4)h(virtual)e(memory)h(system)f(is)h
(a)g(modern)g(VM)g(system)f(that)h(w)o(as)g(designed)g(to)f(replace)300
2404 y(the)h(4.3BSD)h(VM)e(system)g(that)h(appeared)h(in)f(SunOS3)g
([28,)g(46].)34 b(This)26 b(virtual)f(memory)h(system)f(is)300
2554 y(also)f(used)h(by)f(Sun')-5 b(s)25 b(Solaris)f(operating)h
(system.)583 2703 y(The)j(basic)g(structure)f(of)h(the)f(SunOS)i
(virtual)d(memory)h(system)g(is)g(similar)g(to)g(the)g(structure)300
2852 y(of)h(BSD)g(VM.)f(The)h(k)o(ernel)f(and)h(each)g(process)f(on)h
(the)f(system)f(ha)n(v)o(e)i(an)f(address)h(space)g(that)f(is)g(de-)300
3002 y(scribed)k(by)g(an)g Fm(as)g Fs(structure.)49 b(The)31
b Fm(as)f Fs(structure)h(contains)f(a)i(list)e(of)h(currently)g(mapped)
f(re)o(gions)300 3151 y(called)h(se)o(gments.)46 b(Each)31
b(se)o(gment)e(is)h(described)g(by)h(a)g Fm(seg)f Fs(structure.)47
b(The)31 b Fm(seg)f Fs(structure)g(con-)300 3300 y(tains)h(its)g
(starting)g(virtual)f(address,)k(its)d(size,)i(a)f(pointer)f(to)g(a)h
(\223se)o(gment)f(dri)n(v)o(er\224)g(and)g(a)h(pointer)f(to)300
3450 y(the)e(object)h(mapped)f(into)f(that)i(se)o(gment.)43
b(A)30 b(se)o(gment)e(dri)n(v)o(er)h(is)g(a)h(standard)f(set)g(of)h
(functions)f(that)300 3599 y(perform)k(operations)g(on)g(a)h(memory)f
(mapped)g(object.)56 b(SunOS')-5 b(s)34 b Fm(as)f Fs(and)g
Fm(seg)g Fs(structure)g(corre-)300 3749 y(spond)26 b(to)g(BSD)h(VM')-5
b(s)26 b Fm(vm)p 1269 3749 30 4 v 35 w(map)g Fs(and)g
Fm(vm)p 1800 3749 V 36 w(map)p 2016 3749 V 35 w(entry)f
Fs(structures.)36 b(The)26 b(SunOS)h(se)o(gment)e(dri)n(v)o(er)300
3898 y(corresponds)39 b(to)g(BSD)h(VM)f(pager)h(operations.)74
b(The)40 b(SunOS)f(mapped)g(object)h(corresponds)e(to)300
4047 y(BSD)28 b(VM')-5 b(s)27 b Fm(vm)p 902 4047 V 35
w(object)f Fs(structure.)38 b(Once)28 b(dif)n(ference)g(between)f
(SunOS)h(VM)f(and)g(BSD)i(VM)e(is)300 4197 y(that)f(in)g(SunOS)h(the)f
(format)g(of)g(the)g(memory)g(object)g(structure)g(is)g(pri)n(v)n(ate)f
(to)h(the)g(object')-5 b(s)25 b(se)o(gment)300 4346 y(dri)n(v)o(er)-5
b(.)35 b(Thus,)27 b(the)g(pointer)f(to)g(the)h(memory)f(object)g(in)h
(the)g Fm(seg)f Fs(structure)g(is)h(a)g(v)n(oid)f(pointer)-5
b(.)36 b(This)300 4496 y(forces)h(the)f(pointer)g(to)g(the)h(se)o
(gment)e(dri)n(v)o(er)h(function)f(to)h(be)h(in)f(the)h
Fm(seg)f Fs(structure.)65 b(BSD)38 b(VM)300 4645 y(stores)26
b(the)h(pointer)f(to)g(its)g(pager)i(operation)e(structure)g(of)n(f)h
(of)f(its)h Fm(vm)p 2767 4645 V 35 w(object)e Fs(structure)i(\(through)
300 4794 y(the)f Fm(vm)p 574 4794 V 36 w(pager)p Fs(\).)34
b(Both)26 b(SunOS)h(VM)f(and)g(BSD)h(VM)f(ha)n(v)o(e)g(\223page\224)h
(structures)f(that)f(are)i(allocated)300 4944 y(for)e(each)g(page)g(of)
g(physical)f(memory)g(at)h(VM)f(startup)g(time.)583 5093
y(The)e(di)n(vision)d(of)i(labor)h(between)f(the)g(pager)h(operations)f
(and)g(the)g(high-le)n(v)o(el)f(VM)h(in)g(SunOS)300 5243
y(VM)28 b(is)f(dif)n(ferent)h(from)g(BSD)h(VM.)e(In)h(SunOS)h(almost)e
(all)h(high-le)n(v)o(el)e(decisions)h(are)i(deligated)d(to)300
5392 y(the)33 b(se)o(gment)g(dri)n(v)o(er)l(,)h(while)f(in)g(BSD)i(VM)e
(the)g(high-le)n(v)o(el)f(VM)h(handles)g(most)g(of)g(the)h(w)o(ork)f
(and)p eop
%%Page: 62 82
62 81 bop 3800 100 a Fs(62)300 249 y(only)25 b(references)i(the)f
(pager)g(if)g(data)f(transfer)h(is)g(needed)g(between)g(physical)e
(memory)h(and)h(backing)300 398 y(store.)35 b(F)o(or)26
b(e)o(xample,)g(in)g(BSD)h(VM)f(the)g(high-le)n(v)o(el)e(f)o(ault)i
(routine)g(calls)g(the)g(pager)h(to)f(fetch)g(a)h(page)300
548 y(from)21 b(backing)g(store.)29 b(It)22 b(then)f(goes)g(on)g(to)g
(handle)g(cop)o(y-on-write)g(and)g(mapping)f(the)h(ne)n(w)g(page)h
(into)300 697 y(the)27 b(f)o(aulting)f(address)h(space.)37
b(In)27 b(contrast,)g(the)g(high-le)n(v)o(el)e(SunOS)i(VM)g(f)o(ault)g
(routine)f(determines)300 847 y(which)32 b(se)o(gment)g(the)g(page)h(f)
o(ault)g(occurred)g(in)g(and)f(calls)h(that)f(se)o(gment)g(dri)n(v)o
(er')-5 b(s)31 b(f)o(ault)h(routine)g(to)300 996 y(resolv)o(e)c(the)h
(f)o(ault.)43 b(Issues)29 b(such)f(as)h(cop)o(y-on-write)g(and)g
(memory)f(mapping)g(in)g(the)h(f)o(aulting)f(page)300
1145 y(must)c(are)h(handled)g(by)f(the)h(se)o(gment)e(dri)n(v)o(er)l(,)
h(not)g(the)h(high-le)n(v)o(el)e(f)o(ault)h(routine.)583
1295 y(Both)33 b(BSD)h(VM)f(and)g(SunOS)g(VM)g(tak)o(e)g(a)h(similar)e
(approach)h(to)g(di)n(viding)d(the)j(machine-)300 1444
y(dependent)c(and)h(machine-independent)e(aspects)i(of)g(the)f(virtual)
g(memory)g(system.)44 b(SunOS)30 b(has)g(a)300 1594 y
(machine-dependent)24 b(layer)h(called)g(the)g(hardw)o(are)h(address)e
(translation)g(\(HA)-11 b(T\))25 b(layer)-5 b(.)31 b(The)25
b(SunOS)300 1743 y(HA)-11 b(T)25 b(layer)g(corresponds)f(to)g(the)h
(BSD)h(VM)e(pmap)g(layer)-5 b(.)583 1892 y(SunOS)39 b(VM)e(manages)h
(cop)o(y-on-write)f(and)h(anon)o(ymous)e(memory)h(through)g(the)h(use)g
(of)300 2042 y(amaps)26 b(and)g(anons.)35 b(In)26 b(UVM,)g(the)g(SunOS)
g(amap)g(concept)h(w)o(as)f(enhanced,)h(and)f(then)g(adapted)g(for)300
2191 y(the)34 b(more)h(Mach-lik)o(e)f(en)l(vironment)f(pro)o(vided)g
(by)h(UVM.)g(In)h(SunOS)g(amaps)f(are)h(not)f(a)h(general)300
2341 y(purpose)27 b(VM)h(abstraction)f(as)h(the)o(y)f(are)h(in)f(UVM.)h
(SunOS)g(amaps)f(can)h(only)g(be)f(used)h(by)f(se)o(gment)300
2490 y(dri)n(v)o(ers)37 b(that)g(e)o(xplicitly)f(allo)n(w)g(amaps)i(to)
f(be)h(used.)69 b(Once)38 b(such)g(se)o(gment)e(dri)n(v)o(er)h(is)g
(the)h(vnode)300 2639 y(se)o(gment)31 b(dri)n(v)o(er)-5
b(.)51 b(In)32 b(SunOS)h(areas)g(of)f(memory)f(that)h(are)h(mapped)e
(shared)h(must)f(al)o(w)o(ays)h(remain)300 2789 y(shared)27
b(and)g(areas)g(of)g(memory)f(that)g(are)i(mapped)e(cop)o(y-on-write)h
(must)e(al)o(w)o(ays)i(remain)f(cop)o(y-on-)300 2938
y(write.)64 b(Thus,)38 b(SunOS)f(cannot)f(support)f(Mach-style)g
(memory)g(inheritance)h(or)g(certain)h(types)e(of)300
3088 y(map)25 b(entry)h(passing.)32 b(UVM)25 b(has)g(no)h(such)f
(restriction.)32 b(SunOS')-5 b(s)26 b(amap)f(implementation)e(does)j
(not)300 3237 y(appear)f(to)g(support)f(UVM-style)f(quick)i(tra)n(v)o
(ersal)f(or)h(deferred)h(amap)e(allocation)g(during)g(a)h(fork.)583
3386 y(One)37 b(impro)o(v)o(ement)d(introduced)i(to)h(SunOS)g(VM)f(in)g
(Solaris)h(is)f(the)h(introduction)d(of)j(the)300 3536
y(\223virtual)e(sw)o(ap)h(\002le)h(system\224)e([13].)64
b(In)36 b(SunOS4)g(each)h(anon)f(on)f(the)h(system)f(w)o(as)h
(statically)f(as-)300 3685 y(signed)26 b(a)h(pageout)f(location)g(in)h
(the)f(system')-5 b(s)25 b(sw)o(ap)i(area.)37 b(This)26
b(forced)i(the)e(size)h(of)g(the)g(sw)o(ap)f(area)300
3835 y(to)d(be)i(greater)f(than)g(or)g(equal)f(to)h(the)g(size)f(of)h
(main)g(memory)-6 b(.)29 b(The)24 b(virtual)f(sw)o(ap)g(\002le)i
(system)d(allo)n(ws)300 3984 y(the)27 b(backing)g(store)g(of)g(an)g
(anon)g(to)g(be)g(dynamically)f(assigned.)37 b(UVM)27
b(has)g(dynamically)f(assigned)300 4133 y(backing)c(store)g(for)h(anon)
o(ymous)e(memory)h(as)g(well,)h(b)n(ut)f(a)h(\002lesystem)e
(abstraction)h(is)g(not)g(necessary)-6 b(,)300 4283 y(and)25
b(thus)f(is)g(not)g(used.)31 b(Furthermore,)24 b(UVM)h(e)o(xtends)e
(this)h(idea)h(to)f(implement)f(aggressi)n(v)o(ely)g(clus-)300
4432 y(tered)d(anon)o(ymous)e(memory)h(pageout.)29 b(In)19
b(this)g(form)h(of)g(pageout)f(a)i(cluster)e(of)h(anon)o(ymous)e
(memory)300 4581 y(is)27 b(dynamically)e(assigned)i(a)g(contiguous)e
(block)i(of)g(backing)g(store)f(so)h(that)g(it)f(can)i(be)f(paged)g
(out)f(in)300 4731 y(a)f(single)f(I/O)h(operation.)583
4880 y(SunOS)37 b(VM)e(currently)h(does)f(not)g(pro)o(vide)g(UVM-lik)o
(e)g(features)h(such)f(as)h(page)g(loanout,)300 5030
y(page)25 b(transfer)l(,)g(and)g(map)g(entry)f(passing.)30
b(Thus,)24 b(for)i(b)n(ulk)e(data)h(transfer)g(under)g(SunOS)g(one)g(w)
o(ould)300 5179 y(ha)n(v)o(e)32 b(to)g(use)h(traditional)e(mechanisms)g
(such)i(as)f(data)h(cop)o(ying.)53 b(Ho)n(we)n(v)o(er)l(,)33
b(SunOS')-5 b(s)33 b(anon-style)p eop
%%Page: 63 83
63 82 bop 3800 100 a Fs(63)300 249 y(anon)o(ymous)24
b(memory)g(system)h(and)g(modular)g(design)g(w)o(ould)f(ease)i(the)g
(implementation)d(of)i(UVM-)300 398 y(style)f(features.)300
694 y Fo(The)i(Linux)g(V)l(irtual)f(Memory)g(System)300
910 y Fs(Linux)34 b(is)h(a)g(popular)g(free)h(Unix-lik)o(e)e(operating)
h(system)f(written)g(by)h(Linus)f(T)-8 b(orv)n(alds)34
b([66].)62 b(W)-8 b(e)300 1060 y(e)o(xamined)38 b(the)i(virtual)e
(memory)h(system)f(that)h(appears)h(in)f(what)g(is)g(currently)g(the)g
(most)g(recent)300 1209 y(v)o(ersion)24 b(of)h(Linux)f(\(v)o(ersion)f
(2.1.106\).)583 1358 y(In)33 b(Linux,)g(the)f(k)o(ernel)g(and)h(each)g
(process)f(has)g(an)g(address)g(space)h(that)f(is)g(described)g(by)g(a)
300 1508 y Fm(mm)p 426 1508 30 4 v 35 w(struct)24 b Fs(structure.)30
b(The)24 b Fm(mm)p 1548 1508 V 36 w(struct)f Fs(structure)h(contains)g
(a)h(pointer)f(to)g(a)g(sorted)h(link)o(ed)e(list)300
1657 y(of)k Fm(vm)p 536 1657 V 36 w(area)p 812 1657 V
34 w(struct)f Fs(structures)h(that)f(describe)h(mapped)g(re)o(gions)f
(in)g(the)h(address)g(space.)38 b(Each)300 1807 y(mapped)23
b(area)h(of)g(memory)f(has)g(a)h(set)f(of)h(\003ags,)g(an)f(of)n(fset,)
g(and)h(a)f(pointer)g(to)g(the)h(\002le)g(that)f(is)g(mapped)300
1956 y(into)h(that)g(area.)32 b(Each)25 b(page)g(of)g(physical)e
(memory)h(has)h(a)g(corresponding)f Fm(page)g Fs(structure.)583
2105 y Fo(VM)33 b(Lay)o(ering)o(.)54 b Fs(Linux)32 b(VM')-5
b(s)31 b(machine-dependent/machine-independent)f(layering)j(is)300
2255 y(quite)d(dif)n(ferent)g(from)g(either)g(SunOS)h(VM)f(or)g(BSD)h
(VM.)f(In)h(BSD)g(VM)f(the)g(machine-dependent)300 2404
y(pmap)23 b(module)f(pro)o(vides)g(the)i(machine-independent)e(VM)h
(code)h(with)e(a)i(set)f(of)h(functions)e(that)h(add,)300
2554 y(remo)o(v)o(e,)42 b(and)d(change)g(lo)n(w-le)n(v)o(el)f(mappings)
f(of)j(pages.)74 b(In)39 b(Linux,)j(the)d(machine-independent)300
2703 y(code)29 b(e)o(xpects)f(the)h(machine-dependent)f(code)g(to)h
(pro)o(vide)e(a)j(set)e(of)h(page)g(tables)f(for)h(a)g(three-le)n(v)o
(el)300 2852 y(forw)o(ard)j(mapped)f(MMU.)g(The)h(machine-independent)e
(code)i(reads)g(and)g(writes)f(entries)h(to)f(these)300
3002 y(page)h(tables)e(using)h(machine-dependent)f(functions)h(\(or)g
(macros\).)51 b(F)o(or)31 b(machines)g(whose)g(MMU)300
3151 y(matches)g(the)f(Linux)h(machine-independent)e(model)i(the)f
(machine-dependent)h(code)g(can)g(arrange)300 3300 y(for)37
b(the)h(machine-independent)e(code)h(to)g(write)g(directly)g(into)f
(the)h(real)h(page)f(tables.)67 b(Ho)n(we)n(v)o(er)l(,)300
3450 y(machines)27 b(whose)g(MMU)g(does)h(not)f(match)g(the)h(Linux)f
(three-le)n(v)o(el)f(MMU)h(machine-independent)300 3599
y(model)22 b(must)g(both)f(emulate)i(this)f(style)g(MMU)f(for)i(the)g
(machine-independent)f(code)g(and)h(internally)300 3749
y(translate)j(MMU)f(requests)g(to)h(the)g(nati)n(v)o(e)e(MMU)h(format.)
34 b(An)26 b(unfortunate)g(result)f(of)h(this)f(arrange-)300
3898 y(ment)d(is)g(that)h(hooks)f(for)h(machine-dependent)f(cache)h
(and)g(TLB)g(\003ushing)f(must)f(appear)j(throughout)300
4047 y(the)30 b(machine-independent)f(code.)48 b(In)30
b(SunOS)h(and)f(BSD)h(VM)f(such)g(machine-dependent)g(details)300
4197 y(can)c(safely)g(be)g(hidden)f(behind)g(the)g(HA)-11
b(T/pmap)25 b(layer)-5 b(.)33 b(Another)25 b(unfortunate)g(result)h(of)
f(this)g(struc-)300 4346 y(ture)38 b(is)g(that)f(all)h
(machine-independent)e(virtual)i(memory)f(operations)g(that)g(operate)i
(on)e(a)i(range)300 4496 y(of)32 b(virtual)g(addresses)g(must)f(be)h
(prepared)h(to)f(w)o(alk)g(all)g(three)g(page)g(table)g(le)n(v)o(els)f
(of)h(the)g(machine-)300 4645 y(independent)24 b(MMU)g(model.)583
4794 y(Linux)f(requires)g(that)g(the)g(entire)g(contents)f(of)i
(physical)e(memory)g(be)h(contiguously)f(mapped)300 4944
y(into)32 b(the)g(k)o(ernel')-5 b(s)32 b(address)h(space.)54
b(Thus,)34 b(the)e(k)o(ernel')-5 b(s)32 b(virtual)g(address)h(space)g
(must)e(be)i(at)f(least)300 5093 y(as)g(lar)n(ge)g(as)g(physical)f
(memory)-6 b(.)51 b(By)32 b(mapping)f(all)g(physical)g(memory)g(into)g
(the)h(k)o(ernel')-5 b(s)31 b(address)300 5243 y(space)25
b(Linux)f(can)h(access)h(an)o(y)e(page)h(of)g(memory)f(without)f(ha)n
(ving)h(to)h(map)f(it)h(in.)30 b(It)25 b(can)g(also)g(easily)300
5392 y(translate)f(between)h Fm(page)f Fs(structure)h(pointers)f(and)g
(physical)g(addresses.)p eop
%%Page: 64 84
64 83 bop 3800 100 a Fs(64)583 249 y Fo(Copy-on-write.)34
b Fs(Linux)24 b(handles)h(cop)o(y-on-write)g(as)g(follo)n(ws.)31
b(First,)25 b(each)h(page)f(of)h(mem-)300 398 y(ory)h(has)h(a)g
(reference)h(counter)-5 b(.)38 b(Each)28 b(mapping)e(of)i(the)f(page)h
(counts)f(as)g(a)h(reference.)41 b(Also,)27 b(pages)300
548 y(appearing)36 b(in)f(the)h(b)n(uf)n(fer)g(cache)h(also)f(ha)n(v)o
(e)f(an)h(reference.)66 b(Thus)35 b(an)o(y)h(page)g(that)g(is)f(mapped)
g(in)300 697 y(directly)27 b(from)h(a)g(\002le)h(will)e(ha)n(v)o(e)g(a)
i(reference)g(count)f(of)g(at)f(least)h(tw)o(o.)40 b(An)o(y)27
b(page)h(whose)f(reference)300 847 y(count)35 b(is)g(greater)h(than)f
(or)h(equal)g(to)f(tw)o(o)g(is)g(considered)g(\223shared.)-7
b(\224)64 b(Cop)o(y-on-write)35 b(memory)g(is)300 996
y(identi\002ed)22 b(by)g(a)h(cop)o(y-on-write)f(\003ag)h(in)f(the)g
Fm(vm)p 2016 996 30 4 v 36 w(area)p 2292 996 V 35 w(struct)f
Fs(structure)h(that)g(maps)g(the)g(re)o(gion.)300 1145
y(The)28 b(\002rst)g(read-f)o(ault)g(that)g(occurs)g(on)g(a)g(cop)o
(y-on-write)f(area)i(of)f(memory)f(will)g(cause)i(the)f(backing)300
1295 y(\002le')-5 b(s)29 b(page)g(to)f(be)h(mapped)f(in)h(read-only)-6
b(.)42 b(When)29 b(a)g(write-f)o(ault)f(occurs)h(on)g(a)g(cop)o
(y-on-write)f(area)300 1444 y(of)g(re)o(gion)f(the)h(f)o(aulting)f
(page')-5 b(s)27 b(reference)j(count)d(is)h(check)o(ed)g(to)g(see)g(if)
g(the)f(page)i(is)e(shared.)40 b(If)29 b(so,)300 1594
y(then)e(a)g(ne)n(w)g(page)g(is)g(allocated)g(\(with)f(a)i(reference)g
(count)f(of)g(one\),)h(the)f(data)g(from)g(the)g(old)f(page)i(is)300
1743 y(copied)e(to)g(the)h(ne)n(w)f(page,)h(and)g(the)f(ne)n(w)g(page)h
(is)f(mapped)g(in.)36 b(If)27 b(a)g(process)f(with)g(a)h(cop)o
(y-on-write)300 1892 y(re)o(gion)22 b(forks,)i(the)f(cop)o(y-on-write)f
(re)o(gion)h(is)g(write)g(protected)g(and)g(the)g(reference)i(counter)e
(for)g(each)300 2042 y(mapped)h(page)h(is)g(incremented.)30
b(This)24 b(causes)h(future)g(write-f)o(aults)f(to)g(perform)h(a)g(cop)
o(y-on-write.)583 2191 y(Cop)o(y-on-write)33 b(memory)f(can)i(be)f
(paged)g(out)f(to)h(sw)o(ap.)55 b(The)33 b(sw)o(ap)g(area)h(is)e(di)n
(vided)g(into)300 2341 y(page-sized)26 b(blocks.)33 b(Each)26
b(block)f(has)h(a)g(reference)h(counter)f(that)f(says)g(ho)n(w)g(man)o
(y)g(page)h(tables)f(are)300 2490 y(referencing)30 b(it)f(so)g(the)g
(sw)o(ap)g(subsystem)f(kno)n(ws)g(when)h(it)g(is)g(no)g(longer)g(in)g
(use.)45 b(T)-8 b(o)29 b(page)g(a)h(cop)o(y-)300 2639
y(on-write)f(page)h(out)f(to)h(sw)o(ap)f(the)h(page')-5
b(s)29 b(PTE)h(is)g(replaced)g(with)f(an)h(in)l(v)n(alid)e(PTE)i
(containing)e(the)300 2789 y(address)e(on)g(sw)o(ap)g(where)g(the)g
(data)g(is)g(located)g(and)g(the)g(page)g(is)g(placed)g(in)g(the)g
(\223sw)o(ap\224)g(\002le)h(object.)300 2938 y(The)e(page')-5
b(s)25 b(of)n(fset)f(is)g(set)h(to)g(the)g(address)f(of)h(its)g
(location)f(on)g(sw)o(ap.)31 b(When)25 b(all)g(PTEs)g(pointing)e(to)i
(a)300 3088 y(cop)o(y-on-write)i(page)h(are)h(in)l(v)n(alidated)d(the)i
(page)g(is)f(remo)o(v)o(ed)g(from)g(the)h(sw)o(ap)g(\002le)g(and)g
(object)f(and)300 3237 y(freed)f(for)g(reuse.)33 b(Note)25
b(that)g(Linux)g(attempts)f(to)h(place)h(successi)n(v)o(e)e(sw)o(ap)h
(block)g(allocations)f(in)h(the)300 3386 y(same)g(area)g(of)g(sw)o(ap)g
(to)f(reduce)i(I/O)e(o)o(v)o(erhead)h(\(b)n(ut)f(it)g(appears)h(to)g
(write)f(to)h(sw)o(ap)g(page-at-a-time\).)583 3536 y(When)h(a)g
(process)f(references)i(a)f(page)g(who')-5 b(s)24 b(PTE)i(has)f(been)h
(modi\002ed)f(to)g(point)f(to)h(an)h(area)300 3685 y(of)j(sw)o(ap)f(a)h
(page)f(f)o(ault)g(is)g(generated.)42 b(The)29 b(page)f(f)o(ault)h
(routine)e(e)o(xtracts)h(the)h(location)e(of)i(the)f(page)300
3835 y(on)22 b(sw)o(ap)g(from)f(the)h(PTE)h(and)f(searches)g(the)g(sw)o
(ap)g(\002le)g(object)g(to)g(see)g(if)g(the)g(page)g(is)g(still)e
(resident.)30 b(If)300 3984 y(so,)24 b(the)g(page)g(is)g(mapped)f(in.)
30 b(If)25 b(the)f(f)o(ault)g(is)f(a)i(write)f(f)o(ault,)f(the)h(sw)o
(ap)g(block)g(is)f(freed)i(since)f(the)g(data)300 4133
y(will)g(be)i(modi\002ed.)32 b(If)26 b(the)f(page)g(is)g(not)g
(resident)g(in)g(the)g(sw)o(ap)g(\002le)h(object)f(a)h(ne)n(w)f(page)h
(is)e(allocated,)300 4283 y(added)33 b(to)f(the)h(sw)o(ap)f(\002le)i
(object)e(at)h(the)f(appropriate)h(of)n(fset,)h(and)f(read)g(in)g(from)
f(sw)o(ap.)55 b(Then)32 b(the)300 4432 y(page)25 b(can)g(be)g(mapped)f
(as)h(before.)583 4581 y Fo(P)o(age)g(tables.)31 b Fs(Note)24
b(that)g(in)g(a)h(HA)-11 b(T)24 b(or)h(pmap)f(based)h(VM)f(system,)f
(the)h(information)g(stored)300 4731 y(in)37 b(the)g(hardw)o(are)h
(page)g(tables)f(can)h(safely)f(be)h(thro)n(wn)e(a)o(w)o(ay)h(because)h
(it)f(can)h(be)g(easily)f(recon-)300 4880 y(structed)26
b(based)g(on)h(information)e(in)h(the)g(address)h(space)g(or)f(map)g
(structure.)36 b(Systems)26 b(that)g(use)g(this)300 5030
y(approach)33 b(will)f(often)h(call)g(on)g(the)f(HA)-11
b(T)33 b(or)g(pmap)g(layer)g(to)g(free)g(memory)g(when)f(a)i(process)f
(gets)300 5179 y(sw)o(apped)22 b(out)g(or)h(memory)e(becomes)i(scarce.)
31 b(Ho)n(we)n(v)o(er)l(,)21 b(in)h(Linux)g(the)g(page)h(tables)f(are)h
(being)f(used)300 5328 y(to)i(store)h(sw)o(ap)g(location)f
(information,)f(and)i(thus)f(the)h(information)e(contained)i(within)e
(them)h(cannot)p eop
%%Page: 65 85
65 84 bop 3800 100 a Fs(65)300 249 y(be)29 b(freed.)43
b(One)29 b(w)o(ay)g(to)f(allo)n(w)g(such)g(memory)g(to)g(be)h(freed)g
(is)g(to)f(allo)n(w)g(certain)h(page)f(tables)h(to)f(be)300
398 y(paged)c(out)f(themselv)o(es)g(as)h(in)g(W)l(indo)n(ws-NT)e([62],)
i(ho)n(we)n(v)o(er)f(Linux)g(currently)h(does)f(not)h(appear)g(to)300
548 y(support)g(this.)583 697 y(Linux,)f(lik)o(e)g(SunOS,)g(does)g(not)
g(support)f(the)h(sharing)g(of)g(cop)o(y-on-write)g(memory)f(or)i(mem-)
300 847 y(ory)37 b(inheritance.)66 b(Additionally)-6
b(,)37 b(since)g(Linux)f(stores)g(cop)o(y-on-write)h(state)f(in)h(its)f
(page)h(tables,)300 996 y(operations)26 b(such)i(as)f(map)g(entry)g
(passing)f(could)h(be)h(e)o(xpensi)n(v)o(e)d(since)i(the)o(y)g(could)g
(require)g(tra)n(v)o(ers-)300 1145 y(ing)37 b(all)h(the)g(page)g(table)
f(entries)h(for)g(a)g(mapped)f(re)o(gion)g(as)h(well)g(as)g(the)f
(high-le)n(v)o(el)f(map)i(in)f(the)300 1295 y Fm(mm)p
426 1295 30 4 v 35 w(struct)p Fs(.)29 b(Linux)23 b(does)g(ha)n(v)o(e)g
(some)g(support)f(for)h(remapping)g(memory)f(within)g(a)i(process.)30
b(The)300 1444 y(non-standard)d Fm(mremap)f Fs(system)h(call)g(is)h
(used)f(by)g(some)g(v)o(ersions)g(of)g(Linux')-5 b(s)27
b Fm(malloc)f Fs(memory)300 1594 y(allocator)d(to)g(resize)g(its)g
(heap.)30 b(The)23 b Fm(mremap)f Fs(system)g(call)i(tak)o(es)f(a)g
(range)h(of)f(mapped)g(memory)f(and)300 1743 y(changes)30
b(its)g(size.)46 b(If)31 b(the)f(ne)n(w)g(size)g(is)g(smaller)f(than)h
(the)g(old,)h(then)f(the)g(e)o(xtra)g(memory)f(is)h(simply)300
1892 y(unmapped.)g(If)24 b(the)g(ne)n(w)g(size)g(is)g(lar)n(ger)h(than)
f(the)g(old)g(and)g(there)g(is)g(room)g(to)g(gro)n(w)f(the)h
(allocation)f(in)300 2042 y(place,)28 b(then)e Fm(mremap)g
Fs(does)g(so.)37 b(Ho)n(we)n(v)o(er)l(,)26 b(if)h(there)g(is)f(not)h
(enough)f(room,)h(then)f Fm(mremap)g Fs(mo)o(v)o(es)300
2191 y(the)k(mapped)g(memory)f(to)h(a)g(ne)n(w)g(location)f(that)g(is)h
(lar)n(ge)h(enough)e(for)i(the)e(ne)n(w)h(size.)47 b(The)30
b(current)300 2341 y(v)o(ersion)f(of)h Fm(mremap)f Fs(has)h(tw)o(o)g
(limitations:)38 b(it)29 b(will)h(not)f(w)o(ork)h(across)g(VM)g(area)h
(boundaries)e(and)300 2490 y(it)d(does)g(not)g(handled)g(wired)g
(memory)g(properly)-6 b(.)34 b(Additionally)-6 b(,)25
b(the)h Fm(mremap)f Fs(system)g(call)i(has)f(an)300 2639
y(interesting)f(side)h(ef)n(fect.)35 b(If)26 b(the)g(re)o(gion)g(of)g
(memory)f(being)h(remapped)g(points)f(to)h(a)g(\002le)h(rather)f(than)
300 2789 y(a)e(zero-\002ll)g(area)h(memory)d(and)i(the)f(size)h(of)g
(the)f(re)o(gion)g(is)g(being)g(increased)h(then)f(the)h(amount)f(of)g
(the)300 2938 y(\002le)j(mapped)g(is)f(increased.)34
b(This)25 b(may)h(ha)n(v)o(e)f(security)h(implications)d(because)j(it)g
(is)f(gi)n(ving)f(the)i(user)300 3088 y(the)k(ability)f(to)h(change)h
(a)f(\002le')-5 b(s)31 b(mapping)e(without)g(the)h(need)g(for)h(a)g(v)n
(alid)e(open)h(\002le)h(descriptor)e(on)300 3237 y(that)d(\002le.)34
b(Since)27 b(such)f(a)g(feature)h(is)e(not)h(necessary)g(for)g
Fm(malloc)f Fs(it)h(could)f(easily)h(be)g(remo)o(v)o(ed)f(if)h(it)300
3386 y(is)e(determined)g(to)h(be)g(a)g(problem.)300 3681
y Fo(The)h(W)n(indo)o(ws-NT)f(V)l(irtual)g(Memory)g(System)300
3898 y Fs(W)l(indo)n(ws-NT)36 b(is)h(the)g(most)g(adv)n(anced)g(of)h(W)
l(indo)n(ws)e(operating)h(system)f(from)i(Microsoft)e([62].)300
4047 y(Although)g(not)h(a)h(Unix-style)e(operating)h(system,)i(NT')-5
b(s)37 b(virtual)g(memory)f(system)h(shares)g(man)o(y)300
4197 y(aspects)26 b(of)g(such)g(systems.)34 b(Under)26
b(NT)-7 b(,)26 b(each)h(process)f(has)g(its)g(o)n(wn)f(pri)n(v)n(ate)g
(virtual)h(address)g(space)300 4346 y(that)i(is)g(described)g(by)h(a)f
(list)g(of)g(virtual)g(address)g(space)h(descriptors)f(\(V)-13
b(ADs\).)41 b(Unlik)o(e)28 b(BSD)h(VM')-5 b(s)300 4496
y(map)30 b(entry)g(structures,)h(which)f(are)h(or)n(ganized)e(as)i(a)f
(sorted)g(link)o(ed)f(list,)i(V)-13 b(ADs)29 b(are)i(arranged)g(in)f(a)
300 4645 y(self)22 b(balancing)g(binary)f(tree)i(data)f(structure.)29
b(Each)23 b(V)-13 b(AD)21 b(contains)h(a)g(protection)f(and)h(pointer)g
(to)f(the)300 4794 y Fq(section)i(object)i Fs(that)e(it)g(maps.)30
b(A)23 b(section)g(object)g(is)g(the)h(NT)-9 b(-internal)23
b(name)g(for)h(a)g(memory)f(mapped)300 4944 y(\002le.)583
5093 y Fo(Memory)37 b(allocation.)65 b Fs(NT)36 b(allo)n(ws)f
(processes)i(to)f(allocate)g(and)g(deallocate)h(memory)e(in)300
5243 y(their)28 b(address)g(spaces)g(in)g(tw)o(o)f(phases.)41
b(V)-6 b(irtual)27 b(memory)g(can)i(be)f(\223reserv)o(ed\224)h(by)f
(adding)f(an)h(entry)300 5392 y(to)37 b(the)g(V)-13 b(AD)37
b(list.)67 b(Reserv)o(ed)38 b(virtual)f(memory)f(must)g(remain)i
(unused)e(until)h(it)f(is)h(\223committed\224)p eop
%%Page: 66 86
66 85 bop 3800 100 a Fs(66)300 249 y(by)36 b(associating)f(it)h(with)f
(a)i(mapped)f(memory)f(object.)65 b(Processes)37 b(can)f
(\223decommit\224)f(and)i(\223free\224)300 398 y(memory)g(when)h(it)g
(is)f(no)h(longer)g(needed.)70 b(This)37 b(tw)o(o-phase)h(system)f(is)h
(used)f(by)h(NT)g(for)g(stack)300 548 y(allocation.)g(NT)27
b(also)g(allo)n(ws)f(processes)i(to)f(reserv)o(e)g(and)h(commit)e
(memory)g(with)h(a)h(single)e(system)300 697 y(call.)583
847 y Fo(P)o(age)33 b(table)f(and)h(page)g(management.)53
b Fs(NT')-5 b(s)32 b(management)f(of)i(pages)f(tables)f(is)h(similar)
300 996 y(to)j(the)h(w)o(ay)g(Linux')-5 b(s)35 b(VM)g(manages)h(them.)
63 b(But)36 b(unlik)o(e)f(Linux,)i(which)f(assumes)f(a)h(three)g(le)n
(v)o(el)300 1145 y(MMU)22 b(structure,)g(NT)h(assumes)e(a)i(tw)o(o-le)n
(v)o(el)e(MMU)h(structure.)30 b(If)23 b(the)f(hardw)o(are)h(does)g(not)
f(directly)300 1295 y(support)27 b(such)g(a)h(page)g(table)f
(structure,)h(then)g(the)f(machine-dependent)g(NT)g(hardw)o(are)i
(abstraction)300 1444 y(layer)c(\(HAL\))g(must)f(translate)g(between)h
(tw)o(o-le)n(v)o(el)e(page)i(tables)g(and)f(the)h(nati)n(v)o(e)e(MMU)h
(format.)583 1594 y(NT)f(also)e(maintains)g(a)i(page)f(frame)h
(database)f(\(PFN)h(database\))g(that)e(contains)h(one)g(database)300
1743 y(entry)37 b(for)g(each)h(page)f(of)g(physical)f(memory)g(on)h
(the)g(system.)66 b(An)37 b(entry)g(in)f(the)h(PFN)h(database)300
1892 y(contains)d(a)h(share)h(\(reference\))h(count,)g(the)d(physical)g
(address)h(of)g(the)g(page,)j(and)d(the)f(rest)h(of)g(the)300
2042 y(page')-5 b(s)24 b(current)h(state.)583 2191 y
Fo(Pr)n(ototype)39 b(PTEs.)70 b Fs(NT)38 b(manages)g(pages)f(that)h
(may)f(be)h(shared)g(through)f(a)h(mechanism)300 2341
y(called)26 b(\223prototype)f(PTEs.)-7 b(\224)35 b(Under)26
b(NT)g(memory)g(can)g(be)g(shared)h(either)f(through)f(shared)h(memory)
300 2490 y(mappings)34 b(or)i(cop)o(y-on-write)f(memory)f(mappings)g
(\(before)i(the)g(write)f(occurs\).)63 b(Each)36 b(memory)300
2639 y(mapped)26 b(section)g(object)h(has)g(an)g(array)g(of)g
(prototype)f(PTEs)h(associated)f(with)g(it.)36 b(These)27
b(prototype)300 2789 y(PTEs)c(are)h(used)f(to)f(determine)h(the)g
(location)f(of)h(each)h(page)f(that)g(the)f(section)h(object)f
(contains.)30 b(Such)300 2938 y(pages)23 b(could)f(be)g(resident,)h
(zero-\002ll,)g(or)g(on)f(disk.)29 b(While)23 b(the)f(format)g(of)h
(prototype)f(PTEs)g(is)g(similar)300 3088 y(to)f(the)g(format)f(used)h
(in)g(real)g(PTEs,)h(prototype)e(PTEs)h(are)h(only)e(used)h(to)f(k)o
(eep)h(track)h(current)f(location)300 3237 y(of)30 b(a)g(page)g(of)g
(memory)f(and)h(ne)n(v)o(er)g(actually)f(appear)h(in)g(real)g(page)g
(tables.)46 b(F)o(or)30 b(e)o(xample,)g(when)g(a)300
3386 y(memory)k(mapped)h(page)g(is)f(\002rst)h(f)o(aulted)g(on,)i(NT)e
(\002rst)g(checks)g(the)g(page)g(tables)f(of)h(the)g(f)o(aulting)300
3536 y(process)28 b(to)g(determine)g(the)h(PTE)f(of)h(the)f(page)h
(that)f(caused)h(the)f(f)o(ault.)41 b(Since)29 b(this)f(is)g(the)g
(\002rst)h(time)300 3685 y(the)e(page)h(is)f(being)g(f)o(aulted,)h(the)
f(PTE)h(contains)f(no)g(useful)g(information,)g(so)g(NT)h(checks)f(the)
h(V)-13 b(AD)300 3835 y(list)33 b(to)h(determine)g(which)g(section)f
(object)h(is)g(mapped)g(into)f(the)h(f)o(aulting)f(virtual)h(address.)
59 b(Once)300 3984 y(the)27 b(section)f(object)g(is)h(found,)f(the)h
(prototype)f(PTE)h(entry)f(for)i(the)e(f)o(aulting)g(page)h(is)f
(located.)37 b(If)27 b(the)300 4133 y(prototype)j(PTE)i(indicates)f
(that)g(the)g(page)g(is)g(resident)g(in)g(physical)f(memory)-6
b(,)32 b(then)f(the)g(prototype)300 4283 y(entry)g(is)f(copied)g(into)g
(the)h(f)o(aulting)e(process')i(page)g(table)g(with)f(the)g(protection)
g(set)g(appropriately)-6 b(.)300 4432 y(The)20 b(reference)i(counter)d
(for)i(the)f(page)g(in)f(the)h(PFN)h(database)f(is)g(also)f
(incremented.)29 b(If)20 b(the)g(prototype)300 4581 y(PTE)27
b(does)g(not)f(point)f(to)i(physical)e(memory)h(then)h(it)f(will)g
(either)h(point)e(to)i(a)g(page-sized)g(block)f(of)h(a)300
4731 y(sw)o(ap)e(\002le)g(or)g(normal)f(\002le,)h(or)g(it)f(will)g
(indicate)g(that)h(the)f(page)h(should)f(be)h(zero-\002lled.)583
4880 y(When)i(a)g(page)g(of)g(physical)f(memory)g(is)g(remo)o(v)o(ed)f
(from)i(a)g(process')g(address)g(space)g(by)f(the)300
5030 y(NT)34 b(pagedaemon)f(the)h(PFN)h(database')-5
b(s)33 b(reference)i(counter)f(for)g(that)g(page)g(is)f(decremented)h
(and)300 5179 y(the)h(process')g(PTE)h(mapping)e(the)h(page)g(is)g
(replaced)g(with)g(a)g(pointer)g(to)f(the)h(prototype)f(PTE)i(for)300
5328 y(that)28 b(page.)42 b(This)28 b(pointer)g(is)g(treated)h(as)g(an)
g(in)l(v)n(alid)e(PTE)h(by)h(the)f(hardw)o(are.)43 b(If)29
b(the)g(PFN)g(database)p eop
%%Page: 67 87
67 86 bop 3800 100 a Fs(67)300 249 y(reference)30 b(counter)e(reaches)i
(zero,)f(then)g(page)f(of)h(physical)e(memory)g(is)h(no)h(longer)f
(being)g(mapped)300 398 y(and)f(it)g(can)h(be)g(rec)o(ycled.)39
b(This)26 b(reference)j(counter)f(is)f(also)g(used)g(during)g(a)g(cop)o
(y-on-write)g(f)o(ault)g(to)300 548 y(determine)d(if)h(a)g(cop)o(y)g
(needs)g(to)f(occur)-5 b(.)583 697 y(NT)27 b(does)g(not)g(support)f
(the)h(sharing)f(of)h(cop)o(y-on-write)g(memory)f(or)h(memory)f
(inheritance.)300 847 y(Additionally)-6 b(,)22 b(since)j(NT)-7
b(,)24 b(lik)o(e)h(Linux,)f(stores)g(cop)o(y-on-write)h(state)g(in)f
(its)g(page)i(tables,)e(operations)300 996 y(such)31
b(as)g(map)g(entry)h(passing)e(could)h(be)g(e)o(xpensi)n(v)o(e)e(since)
j(the)o(y)e(may)h(require)h(tra)n(v)o(ersing)e(all)h(page)300
1145 y(table)26 b(entries)f(for)h(a)g(mapped)g(re)o(gion)f(as)h(well)f
(as)h(the)g(V)-13 b(ADs.)33 b(NT)25 b(does)h(ha)n(v)o(e)f(an)h
(internal-only)f(IPC)300 1295 y(f)o(acility)g(called)g(local)g
(procedure)h(calls)f(\(LPC\))h(that)f(uses)g(virtual)g(memory)f
(features)i(in)f(some)g(cases)300 1444 y(to)j(transfer)h(data.)43
b(F)o(or)28 b(LPC)i(messages)e(of)h(less)f(than)g(256)h(bytes)f(data)h
(cop)o(ying)e(is)i(used.)42 b(F)o(or)28 b(LPC)300 1594
y(messages)i(lar)n(ger)i(than)f(that,)h(a)f(shared)h(section)e(object)h
(is)f(allocated)h(and)g(used)g(to)g(pass)g(data.)49 b(F)o(or)300
1743 y(v)o(ery)25 b(lar)n(ge)g(data)g(that)f(will)g(not)h(\002t)g(in)f
(a)i(shared)f(section,)f(NT')-5 b(s)24 b(LPC)i(mechanism)e(allo)n(ws)f
(the)i(serv)o(er)300 1892 y(to)f(directly)h(read)g(or)g(write)g(data)f
(from)h(the)g(clients)f(address)g(space.)300 2187 y Fo(Other)h(V)l
(irtual)h(Memory)f(Systems)300 2404 y Fs(Sprite)d(w)o(as)f(an)g(e)o
(xperimental)g(operating)f(system)h(that)g(w)o(as)g(de)n(v)o(eloped)f
(at)h(Uni)n(v)o(ersity)f(of)h(California)300 2554 y(at)32
b(Berk)o(ele)o(y)h(in)f(the)g(late)g(1980s)f([51].)53
b(Sprite')-5 b(s)32 b(original)f(virtual)h(memory)f(system)g(pro)o
(vided)g(the)300 2703 y(basic)f(functionality)e(of)h(the)h(4.2BSD)g
(virtual)f(memory)g(system)g([48)o(].)46 b(Thus,)30 b(it)g(w)o(as)f
(lacking)g(sup-)300 2852 y(port)f(for)i(cop)o(y-on-write,)f
Fm(mmap)p Fs(,)g(and)g(shared)g(libraries.)42 b(This)28
b(allo)n(wed)g(page)h(table)g(management)300 3002 y(to)35
b(be)g(simpli\002ed)f(by)h(associating)g(page)g(tables)g(with)f
(\002les)i(rather)g(than)f(processes.)62 b(These)35 b(page)300
3151 y(tables)23 b(could)g(be)g(shared)h(among)f(all)g(processes.)30
b(Sprite)23 b(did)g(support)g(a)g(primiti)n(v)o(e)e(form)i(of)h(memory)
300 3300 y(inheritance.)30 b(When)23 b(a)g(process)g(fork)o(ed,)h(it)e
(had)h(the)g(option)f(of)h(sharing)f(its)g(data)h(and)g(heap)h(se)o
(gments)300 3450 y(with)g(its)g(child)f(process.)31 b(Sprite)24
b(w)o(as)h(later)g(modi\002ed)f(to)g(support)f(cop)o(y-on-write)h([49])
h(for)g(data)f(and)300 3599 y(stack)g(pages.)31 b(This)24
b(w)o(as)g(done)g(through)g(a)h(se)o(gment)e(list)g(structure.)30
b(Each)25 b(cop)o(y-on-write)f(cop)o(y)g(of)h(a)300 3749
y(se)o(gment)c(adds)i(a)g(se)o(gment)e(to)i(the)f(se)o(gment)g(list.)29
b(Only)22 b(one)h(of)f(the)h(se)o(gments,)e(the)i(master)g(se)o(gment,)
300 3898 y(on)32 b(the)h(se)o(gment)e(list)h(can)h(ha)n(v)o(e)g(a)g(v)n
(alid)e(mapping)h(of)g(the)h(page)g(at)g(an)o(y)f(one)g(time.)54
b(The)33 b(PTEs)f(in)300 4047 y(the)d(rest)g(of)g(the)f(se)o(gments)g
(contain)g(pointers)g(to)g(the)h(master)g(se)o(gment)e(\(the)i(hardw)o
(are)h(treats)e(these)300 4197 y(pointers)g(as)i(in)l(v)n(alid)e
(entries\).)44 b(If)29 b(a)h(cop)o(y-on-write)f(f)o(ault)g(occurs)g(on)
h(the)f(master)g(se)o(gment,)g(then)g(a)300 4346 y(cop)o(y)k(is)g(made)
g(and)h(another)f(se)o(gment)f(is)h(made)g(master)-5
b(.)56 b(If)34 b(a)f(cop)o(y-on-write)g(f)o(ault)g(occurs)h(on)f(a)300
4496 y(non-master)24 b(se)o(gment,)f(then)i(the)g(data)f(is)h(just)f
(copied)g(to)h(a)g(pri)n(v)n(ate)e(page.)583 4645 y(Chorus)43
b(is)e(a)i(microk)o(ernel)f(based)g(operating)f(system)h(with)f(an)h
(object-oriented)g(virtual)300 4794 y(memory)c(interf)o(ace)i(de)n(v)o
(eloped)e(in)g(the)h(early)h(1990s)e(at)h(Chorus)g(Systems)f(and)h
(INRIA,)h(France)300 4944 y([1,)23 b(2,)f(17].)30 b(The)23
b(interf)o(ace)g(for)g(the)g(virtual)f(memory)g(system)f(is)i(called)f
(the)h(\223generic)g(memory)f(man-)300 5093 y(agement)30
b(interf)o(ace\224)h(or)f(GMI.)f(The)h(GMI)g(de\002nes)h(a)f(set)g(of)g
(virtual)f(memory)g(operations)h(that)f(the)300 5243
y(Chorus)k(microk)o(ernel)f(supports.)54 b(Each)33 b(process)f(under)h
(Chorus)g(has)g(virtual)f(memory)g(\223conte)o(xt\224)p
eop
%%Page: 68 88
68 87 bop 3800 100 a Fs(68)300 249 y(that)27 b(consists)e(of)i(a)h(set)
f(of)g(mapped)g(\223re)o(gions.)-7 b(\224)36 b(This)27
b(corresponds)f(to)h(Mach')-5 b(s)27 b(maps)f(and)h(map)g(en-)300
398 y(tries.)48 b(Each)31 b(re)o(gion)f(points)g(to)g(a)h(local)f
(\223cache\224)j(that)d(maps)g(a)h(\223se)o(gment.)-7
b(\224)48 b(Data)31 b(in)f(a)h(se)o(gment)f(is)300 548
y(accessed)e(through)f(its)g(\223se)o(gment)f(manager)-5
b(.)e(\224)39 b(A)28 b(cache)g(corresponds)f(to)g(a)h(Mach)g(memory)f
(object,)300 697 y(a)34 b(se)o(gment)e(corresponds)h(to)h(backing)f
(store,)i(and)f(a)g(se)o(gment)e(manager)i(corresponds)f(to)g(a)h(Mach)
300 847 y(pager)-5 b(.)67 b(The)37 b(operations)f(that)g(the)h(GMI)g
(de\002nes)g(that)f(can)i(be)f(performed)g(on)f(these)h(objects)f(in-)
300 996 y(clude)23 b(adding)g(and)g(remo)o(ving)f(a)h(mapped)g(re)o
(gion)f(from)h(a)h(conte)o(xt,)e(splitting)f(a)j(mapped)f(re)o(gion)f
(into)300 1145 y(smaller)33 b(parts,)j(changing)e(the)f(protection)g
(of)h(a)h(mapped)e(re)o(gion,)i(and)f(locking)f(and)h(unlocking)f(a)300
1295 y(mapped)24 b(re)o(gion)g(in)h(memory)-6 b(.)29
b(The)c(\223paged)g(virtual)f(memory)g(manager\224)h(\(PVM\))g(is)f(a)h
(portable)g(im-)300 1444 y(plementation)20 b(of)h(the)h(GMI)f(interf)o
(ace)h(for)g(paged)f(memory)g(architectures.)29 b(PVM)22
b(includes)f(both)f(the)300 1594 y(hardw)o(are-independent)26
b(and)g(hardw)o(are-dependent)h(parts)f(of)g(the)g(virtual)g(memory)f
(system.)34 b(PVM)300 1743 y(supports)25 b(cop)o(y-on-write)h(through)g
(the)g(use)h(of)f(\223history)g(objects.)-7 b(\224)35
b(History)26 b(objects)g(are)h(similar)e(to)300 1892
y(Mach')-5 b(s)28 b(shado)n(w)f(object)i(chains.)41 b(The)o(y)28
b(form)g(a)h(binary)f(tree)h(that)f(must)g(be)h(searched)g(to)f(resolv)
o(e)g(a)300 2042 y(cop)o(y-on-write)i(page)h(f)o(ault.)47
b(Chorus)31 b(supports)e(a)i(per)n(-page)g(form)f(of)h(cop)o
(y-on-write)f(through)f(the)300 2191 y(use)35 b(of)f(\223cop)o
(y-on-write)h(page)f(stubs\224)g(which)g(are)i(similar)d(to)i
(\002ctitious)e(pages)i(in)f(Mach.)60 b(These)300 2341
y(stubs)24 b(are)h(k)o(ept)g(on)f(a)h(link)o(ed)f(list)g(that)g(is)h
(rooted)f(of)n(f)h(the)g(real)g(page')-5 b(s)24 b(descriptor)-5
b(.)583 2490 y(Spring)29 b(is)f(an)h(e)o(xperimental)e(object-oriented)
h(microk)o(ernel)g(operating)g(system)g(de)n(v)o(eloped)300
2639 y(at)k(Sun)h([35,)f(31,)g(44].)53 b(Each)33 b(process)f(under)h
(Spring)f(has)g(an)h(address)f(space)h(called)f(a)h(\223domain.)-7
b(\224)300 2789 y(Each)30 b(domain)f(contains)g(a)h(sorted)f(link)o(ed)
g(list)g(of)g(re)o(gions)g(that)g(are)i(mapped)e(into)g(it.)45
b(Each)30 b(re)o(gion)300 2938 y(points)21 b(to)g(the)h(memory)g
(objects)f(that)h(it)f(maps.)29 b(Mapped)22 b(memory)f(object)h(re)o
(gions)f(can)h(be)g(cop)o(y-on-)300 3088 y(write)j(copied)g(into)g
(other)g(address)g(spaces.)33 b(A)26 b(cache)g(object)f(is)g(a)h
(container)f(for)g(physical)g(memory)-6 b(.)300 3237
y(A)21 b(pager)g(object)g(is)f(used)h(to)f(transfer)h(data)g(between)g
(physical)f(memory)g(and)h(backing)f(store.)29 b(Spring,)300
3386 y(lik)o(e)35 b(Mach,)j(supports)c(e)o(xternal)h(pagers.)63
b(Spring)36 b(also)f(pro)o(vide)f(coherent)i(\002le)g(mappings)e
(across)300 3536 y(a)h(netw)o(ork.)60 b(Spring)34 b(supports)g(cop)o
(y-on-write)g(through)f(a)i(cop)o(y-on-write)g(map)f(structure.)60
b(This)300 3685 y(structure)35 b(contains)g(pointers)g(to)g(re)o(gions)
f(of)i(the)g(source)f(and)h(destination)e(cache,)39 b(and)c(a)h(bitmap)
300 3835 y(indicating)29 b(which)h(pages)g(ha)n(v)o(e)g(be)g(copied)g
(from)g(the)h(source)f(cache.)48 b(The)30 b(caches)h(that)f(the)g(cop)o
(y-)300 3984 y(on-write)37 b(map)h(structures)f(point)g(to)g(can)h
(chain)g(to)f(arbitrary)h(le)n(v)o(els,)h(much)e(lik)o(e)g(Mach)h
(shado)n(w)300 4133 y(object.)30 b(Spring)25 b(has)f(a)h(b)n(ulk)f
(data)g(mo)o(v)o(ement)e(f)o(acility)i(for)h(IPC)h(that)e(mo)o(v)o(es)f
(data)h(either)h(by)f(mo)o(ving)300 4283 y(it)i(or)h(by)f(cop)o
(y-on-write)h(cop)o(ying)e(it)i(\(using)e(the)i(cop)o(y-on-write)f(map)
h(mechanism\).)35 b(If)27 b(the)g(data)g(is)300 4432
y(being)h(mo)o(v)o(ed)e(rather)j(than)e(copied)h(and)g(the)g(data)h(is)
e(resident)h(in)g(memory)-6 b(,)27 b(then)h(Spring)g(will)f(steal)300
4581 y(the)j(pages)g(from)g(the)g(source)g(object)g(and)g(place)h(them)
e(in)h(the)g(destination.)45 b(This)29 b(is)h(important)f(for)300
4731 y(e)o(xternal)d(\002lesystem)f(pagers)i(since)f(\002lesystems)f
(often)h(ha)n(v)o(e)g(to)g(mo)o(v)o(e)e(lots)i(of)g(data.)35
b(Spring)26 b(reuses)300 4880 y(the)f(SunOS)g(machine-dependent)f(HA)
-11 b(T)25 b(layer)g(to)f(a)n(v)n(oid)g(duplicate)g(w)o(ork.)p
eop
%%Page: 69 89
69 88 bop 3800 100 a Fs(69)300 249 y Ff(3.4.2)119 b(I/O)29
b(and)i(IPC)f(Subsystems)f(That)g(Use)h(VM)g(F)m(eatur)n(es)300
466 y Fs(In)j(this)g(section)f(we)i(e)o(xamine)e(research)j(on)e(I/O)g
(and)g(IPC)h(subsystems)e(that)h(can)g(tak)o(e)h(adv)n(antage)300
615 y(of)25 b(services)g(of)n(fered)g(by)g(virtual)f(memory)g(systems)g
(to)h(reduce)g(data)g(mo)o(v)o(ement)e(o)o(v)o(erheads.)31
b(While)300 764 y(this)e(research)h(shares)g(some)f(of)g(the)g(same)h
(goals)f(as)g(UVM,)g(our)h(approach)f(is)h(dif)n(ferent.)44
b(In)30 b(UVM)300 914 y(we)35 b(are)g(interested)f(in)g(creating)g(a)h
(virtual)f(memory)f(system)g(whose)h(internal)g(structure)g(pro)o
(vides)300 1063 y(ef)n(\002cient)28 b(and)g(\003e)o(xible)g(support)f
(for)h(data)g(mo)o(v)o(ement.)39 b(In)28 b(I/O)g(and)g(IPC)h(research,)
h(the)e(focus)g(is)f(on)300 1213 y(using)i(features)i(that)e(the)h
(virtual)g(memory)f(is)h(assumed)f(to)h(already)g(pro)o(vide.)46
b(Thus,)31 b(I/O)f(and)g(IPC)300 1362 y(research)g(addresses)e(some)g
(problems)g(that)g(UVM)g(does)h(not)f(address)g(such)h(as)f(b)n(uf)n
(fering)g(schemes)300 1511 y(and)d(API)g(design.)300
1807 y Fo(The)h(Genie)f(I/O)f(Framew)o(ork)300 2023 y
Fs(Recent)29 b(research)h(by)e(Brustoloni)f(and)i(Steenkiste)f
(analyzed)h(the)f(ef)n(fects)h(of)f(data)h(passing)e(seman-)300
2173 y(tics)f(on)g(k)o(ernel)h(I/O)f(and)h(IPC)g([10,)g(11)o(].)37
b(Since)27 b(the)f(traditional)f(Unix)h(API)h(uses)f(\223cop)o(y\224)h
(semantics)300 2322 y(to)37 b(mo)o(v)o(e)f(data)h(this)g(research)h
(focuses)g(on)f(pro)o(viding)e(optimizations)g(that)i(reduce)h(data)g
(transfer)300 2471 y(o)o(v)o(erhead)31 b(while)g(maintaining)f(the)h
(illusion)f(of)i(the)f(cop)o(y)h(semantic.)50 b(These)32
b(optimizations)d(were)300 2621 y(implemented)24 b(under)i(Genie,)h(a)f
(prototype)f(I/O)h(system)f(that)h(runs)f(under)h(NetBSD)h(1.1.)34
b(Since)27 b(Ge-)300 2770 y(nie)k(w)o(as)h(intended)f(as)h(an)f(e)o
(xperimental)g(testbed)g(to)g(compare)g(v)n(arious)g(IPC)i(schemes)e
(it)g(contains)300 2920 y(features)f(that)f(may)g(not)g(be)g(suitable)g
(for)g(production)g(use.)44 b(Se)n(v)o(eral)29 b(techniques)g(that)g
(preserv)o(e)g(the)300 3069 y(cop)o(y)24 b(semantic)f(are)h(presented)g
(including)e(temporary)h(cop)o(y-on-write)g(\(TCO)m(W\),)h(and)g(input)
f(align-)300 3218 y(ment.)30 b(W)-8 b(e)25 b(brie\003y)g(describe)g
(each)h(of)e(these)h(belo)n(w)-6 b(.)583 3368 y(Genie')h(s)28
b(TCO)m(W)g(mechanism)f(is)g(similar)g(to)h(UVM')-5 b(s)27
b(page)h(loanout)f(mechanism.)39 b(TCO)m(W)300 3517 y(allo)n(ws)20
b(a)i(process)g(to)f(loan)h(its)f(pages)g(out)g(to)h(the)f(Genie)h(I/O)
g(system)e(for)i(processing)f(without)f(fear)j(of)300
3667 y(interference)f(from)g(the)f(pagedaemon)g(or)h(page)g(f)o(aults)f
(from)g(other)g(processes.)30 b(TCO)m(W)21 b(dif)n(fers)g(from)300
3816 y(page)f(loanout)f(in)h(three)g(w)o(ays.)29 b(First,)21
b(TCO)m(W)f(only)f(allo)n(ws)g(pages)h(to)f(be)h(loaned)g(out)f(to)h
(wired)g(k)o(ernel)300 3965 y(pages,)32 b(while)d(UVM')-5
b(s)30 b(page)g(loanout)g(allo)n(ws)f(both)g(object)h(and)g(anon)o
(ymous)f(pages)h(to)g(be)g(loaned)300 4115 y(out)e(to)h(pageable)g
(anon)o(ymous)e(memory)-6 b(.)41 b(Second,)30 b(TCO)m(W)f(w)o(as)g
(implemented)e(on)i(top)f(of)h(the)g(old)300 4264 y(BSD)23
b(VM)g(object)f(chaining)g(model,)g(while)g(page)g(loanout)g(is)g
(implemented)f(on)h(top)g(of)h(UVM')-5 b(s)22 b(ne)n(w)300
4413 y(anon)o(ymous)30 b(memory)h(layer)-5 b(.)51 b(Third,)33
b(in)e(UVM)g(we)h(ha)n(v)o(e)g(demonstrated)e(ho)n(w)h(page)h(loanout)f
(can)300 4563 y(easily)23 b(be)h(inte)o(grated)e(with)h(BSD')-5
b(s)24 b(mb)n(uf-based)f(netw)o(orking)g(subsystem)f(while)h(TCO)m(W)g
(w)o(as)h(only)300 4712 y(demonstrated)35 b(with)h(the)g(Genie)h(I/O)f
(frame)n(w)o(ork,)j(completely)d(bypassing)f(the)h(traditional)f(BSD)
300 4862 y(IPC)26 b(system.)583 5011 y(Input)33 b(alignment)e(is)h(a)h
(technique)f(that)g(can)h(be)g(used)f(to)h(preserv)o(e)f(an)h(API)h
(with)d(cop)o(y)i(se-)300 5160 y(mantics)22 b(on)g(data)h(input)f
(while)g(using)g(page)h(remapping)f(to)h(actually)f(mo)o(v)o(e)f(the)i
(data.)30 b(In)23 b(order)g(to)f(do)300 5310 y(input)28
b(alignment)f(one)h(of)h(tw)o(o)f(conditions)f(must)h(hold.)41
b(Either)28 b(the)h(input)e(request)i(must)e(be)i(issued)p
eop
%%Page: 70 90
70 89 bop 3800 100 a Fs(70)300 249 y Fq(befor)l(e)24
b Fs(the)g(data)g(arri)n(v)o(es)f(so)g(Genie)h(can)h(analyze)f(the)g
(alignment)e(requirements)h(of)h(the)g(input)f(b)n(uf)n(fer)300
398 y(and)i(con\002gure)h(its)f(b)n(uf)n(fers)g(appropriately)-6
b(,)24 b(or)i(the)f(client)g(must)f(query)i(Genie)f(about)g(the)g
(alignment)300 548 y(of)30 b(b)n(uf)n(fers)g(that)g(are)h(currently)f
(w)o(aiting)f(to)g(be)i(transfered)f(so)g(that)g(it)f(can)i
(con\002gure)f(its)g(b)n(uf)n(fers)f(to)300 697 y(match.)g(When)22
b(remapping)e(pages)i(that)f(are)h(not)f(completely)f(\002lled)i(with)e
(data,)j(Genie)e(uses)g(\223re)n(v)o(erse)300 847 y(cop)o(yout\224)29
b(to)g(\002ll)g(the)g(remaining)g(areas)h(with)e(the)h(appropriate)h
(data)f(from)g(the)g(recei)n(ving)g(process')300 996
y(address)24 b(space.)31 b(Genie)24 b(also)f(has)h(se)n(v)o(eral)g
(techniques)f(for)h(a)n(v)n(oiding)f(data)h(fragmentation)f(when)h(the)
300 1145 y(input)g(data)h(contains)f(pack)o(et)h(headers)g(from)f(netw)
o(ork)h(interf)o(aces.)300 1441 y Fo(The)h(Fb)n(uf)g(IPC)e(F)n(acility)
300 1657 y Fs(The)c(f)o(ast)g(b)n(uf)n(fers)g(\(fb)n(ufs\))g(k)o(ernel)
g(subsystem)f(is)g(an)i(operating)e(system)g(f)o(acility)h(for)g(IPC)h
(b)n(uf)n(fer)f(man-)300 1807 y(agement)28 b(de)n(v)o(eloped)f(at)h
(Uni)n(v)o(ersity)f(of)h(Arizona)g([23,)h(24)o(,)g(65)o(].)42
b(Fb)n(ufs)29 b(pro)o(vide)e(f)o(ast)h(data)h(transfer)300
1956 y(across)24 b(protection)f(domain)g(boundaries.)29
b(The)24 b(fb)n(uf)g(system)f(is)g(based)h(on)f(the)h(assumption)e
(that)h(IPC)300 2105 y(b)n(uf)n(fers)31 b(are)i(immutable.)49
b(An)32 b(immutable)e(b)n(uf)n(fer)i(is)f(one)g(that)h(is)f(not)g
(modi\002ed)g(after)h(it)f(has)h(been)300 2255 y(initialized.)37
b(An)28 b(e)o(xample)f(of)g(an)h(immutable)e(b)n(uf)n(fer)h(is)g(a)h(b)
n(uf)n(fer)g(that)f(has)g(been)h(queued)f(for)h(trans-)300
2404 y(mission)22 b(on)i(a)g(netw)o(ork)g(interf)o(ace.)31
b(Once)24 b(the)g(data)g(has)g(been)g(loaded)g(into)f(the)h(b)n(uf)n
(fer)g(it)f(will)h(not)f(be)300 2554 y(changed)i(until)e(the)i(b)n(uf)n
(fer)g(is)f(freed)i(and)f(reused.)583 2703 y(Fb)n(ufs)35
b(were)h(implemented)d(as)i(an)g(add-on)g(to)f(the)h(Mach)g(microk)o
(ernel.)60 b(The)35 b(k)o(ernel)g(and)300 2852 y(each)24
b(process)f(on)f(the)h(system)f(share)i(a)f(\002x)o(ed)g(sized)g(area)h
(of)f(virtual)g(memory)f(set)h(aside)g(as)g(the)g(\223fb)n(uf)300
3002 y(re)o(gion.)-7 b(\224)53 b(All)32 b(fb)n(uf)g(data)h(pages)f
(must)g(be)g(mapped)g(into)g(this)f(shared)i(re)o(gion.)53
b(Although)31 b(the)h(fb)n(uf)300 3151 y(re)o(gion)e(of)g(virtual)g
(memory)f(is)h(shared)h(among)e(all)h(processes)h(the)f(indi)n(vidual)e
(fb)n(ufs)i(mapped)g(into)300 3300 y(the)25 b(re)o(gion)g(are)h
(protected)f(so)g(that)g(only)g(authorized)g(processes)g(ha)n(v)o(e)g
(access)h(to)f(the)h(fb)n(ufs)f(the)o(y)f(are)300 3450
y(using.)29 b(The)23 b(fb)n(uf)g(re)o(gion)g(can)g(be)g(thought)f(of)h
(as)g(a)h(lar)n(ge)f Fm(vm)p 2445 3450 30 4 v 36 w(object)e
Fs(that)i(is)g(completely)f(mapped)300 3599 y(into)j(all)h(address)g
(spaces.)36 b(The)26 b(fb)n(uf)g(code)h(acts)f(as)g(a)h(pager)g(for)f
(this)f(object.)35 b(This)25 b(structure)h(allo)n(ws)300
3749 y(the)e(fb)n(uf)g(system)f(to)h(operate)g(under)g(Mach)g(without)e
(the)i(need)g(to)g(mak)o(e)g(changes)g(to)g(the)g(core)g(of)g(the)300
3898 y(Mach)h(virtual)f(memory)g(system.)583 4047 y(T)-8
b(o)36 b(send)g(a)g(message)g(using)f(an)h(fb)n(uf,)j(a)d(process)g
(\002rst)g(allocates)g(an)g(fb)n(uf)g(using)f(the)h(fb)n(uf)300
4197 y(system')-5 b(s)22 b(API.)i(The)f(fb)n(uf)g(allocator)g(will)g
(allocate)g(an)h(unused)f(chunk)g(of)g(virtual)g(memory)f(from)h(the)
300 4346 y(fb)n(uf)29 b(re)o(gion)g(and)g(mark)g(it)g(for)g(use)h(by)f
(the)g(process)g(requesting)f(the)i(allocation.)43 b(At)29
b(this)f(point)g(the)300 4496 y(fb)n(uf)k(system)e(will)h(allo)n(w)g
(the)g(process)h(read)g(and)f(write)h(access)g(to)f(the)h(allocated)f
(part)h(of)g(the)f(fb)n(uf)300 4645 y(re)o(gion.)f(The)25
b(application)f(can)i(then)e(place)i(its)e(data)h(in)f(the)h(fb)n(uf)g
(and)g(request)g(that)g(the)f(data)h(be)h(sent.)300 4794
y(Since)j(fb)n(ufs)f(are)h(immutable,)e(the)h(application)f(should)g
(not)g(attempt)g(to)h(access)h(the)f(fb)n(uf)g(after)h(it)f(is)300
4944 y(sent.)i(The)25 b(fb)n(uf)g(system)e(gi)n(v)o(es)g(the)i
(recipient)f(of)h(the)f(fb)n(uf)h(read)g(access)g(to)f(it)g(so)h(that)f
(it)g(may)g(process)300 5093 y(the)32 b(data.)51 b(Data)32
b(stored)f(in)g(the)h(fb)n(uf)g(object)f(is)g(pageable)h(unless)f(it)g
(has)h(been)g(wired)f(for)h(I/O.)g(If)g(a)300 5243 y(process)22
b(attempts)e(to)i(read)g(or)g(write)f(an)h(area)h(of)f(the)g(fb)n(uf)g
(re)o(gion)f(that)g(it)g(is)h(not)f(authorized)g(to)h(access)300
5392 y(then)i(it)h(recei)n(v)o(es)f(a)h(memory)f(access)h(violation.)p
eop
%%Page: 71 91
71 90 bop 3800 100 a Fs(71)583 249 y(The)31 b(fb)n(uf)g(f)o(acility)e
(has)i(tw)o(o)f(useful)g(optimizations:)39 b(fb)n(uf)31
b(caching)f(and)h(v)n(olatile)e(fb)n(ufs.)48 b(In)300
398 y(fb)n(uf)30 b(caching,)h(the)f(sending)e(process)i(speci\002es)g
(the)g(path)f(the)h(fb)n(uf)g(will)f(tak)o(e)h(through)f(the)g(system)
300 548 y(at)35 b(fb)n(uf)f(allocation)g(time.)59 b(This)34
b(allo)n(ws)f(the)h(fb)n(uf)h(system)f(to)g(reuse)h(the)f(same)g(fb)n
(uf)h(for)g(multiple)300 697 y(IPC)f(operations.)56 b(Once)33
b(an)g(fb)n(uf)h(has)f(been)g(sent,)i(it)e(is)g(returned)g(to)g(the)g
(originating)f(process)h(for)300 847 y(reuse.)41 b(This)28
b(sa)n(v)o(es)g(the)g(fb)n(uf)g(system)f(from)h(ha)n(ving)g(to)g
(allocate)g(and)g(zero-\002ll)h(ne)n(w)f(fb)n(ufs)g(for)g(each)300
996 y(transaction.)h(V)-13 b(olatile)21 b(fb)n(ufs)g(are)h(fb)n(ufs)g
(that)f(are)h(not)f(write)g(protected)g(in)h(the)f(sending)f(process.)
30 b(This)300 1145 y(sa)n(v)o(es)g(memory)g(management)g(operations)g
(at)h(the)g(cost)f(allo)n(wing)f(a)i(sending)f(process)h(to)f(write)h
(an)300 1295 y(immutable)23 b(b)n(uf)n(fer)i(after)g(it)g(has)f(been)h
(sent.)583 1444 y(While)e(note)n(w)o(orthy)-6 b(,)20
b(the)j(fb)n(uf)g(f)o(acility)f(has)g(se)n(v)o(eral)g(limitations.)28
b(First,)23 b(the)f(only)g(w)o(ay)h(to)f(get)300 1594
y(data)j(from)h(the)f(\002lesystem)f(into)h(an)g(fb)n(uf)h(is)e(to)h
(cop)o(y)h(it.)31 b(Second,)26 b(if)f(an)h(application)e(has)h(data)h
(that)f(it)300 1743 y(w)o(ants)c(to)f(send)h(using)f(an)h(fb)n(uf)g(b)n
(ut)g(that)f(data)h(is)g(not)f(in)h(the)g(fb)n(uf)g(re)o(gion,)g(then)g
(it)f(must)g(\002rst)h(be)g(copied)300 1892 y(there.)44
b(Third,)29 b(it)f(is)h(not)f(possible)g(to)h(use)g(cop)o(y-on-write)f
(with)g(an)i(fb)n(uf.)43 b(It)29 b(should)f(be)h(possible)e(to)300
2042 y(combine)c(UVM)g(features)h(such)f(as)g(page)h(loanout)f(and)g
(page)h(transfer)g(with)e(the)i(fb)n(uf)f(concept)h(to)f(lift)300
2191 y(these)i(limitations.)300 2486 y Fo(Container)h(Shipping)300
2703 y Fs(The)g(Container)f(Shipping)g(I/O)g(system)g(allo)n(ws)f(a)i
(process)f(to)h(transfer)f(data)h(without)e(ha)n(ving)h(direct)300
2852 y(access)34 b(to)e(it)h([53].)55 b(De)n(v)o(eloped)32
b(at)h(Uni)n(v)o(ersity)e(of)i(California)g(\(San)h(Die)o(go\),)g
(container)f(shipping)300 3002 y(is)g(based)g(on)f(the)h(container)n
(-shipping)e(mechanism)h(used)h(by)g(the)g(car)n(go-transportation)f
(industry)-6 b(.)300 3151 y(In)36 b(container)n(-shipping)f(goods)g
(are)i(placed)f(on)g(protecti)n(v)o(e)f(pallots)g(which)g(are)i(then)f
(loaded)g(into)300 3300 y(containers.)k(Because)28 b(the)g(containers)g
(are)g(uniform)f(in)h(size)g(the)o(y)f(can)h(easily)f(be)h(mo)o(v)o
(ed,)f(stack)o(ed,)300 3450 y(and)e(transported.)583
3599 y(The)31 b(container)g(shipping)e(I/O)h(system)g(operates)h(in)f
(a)h(similar)e(w)o(ay)-6 b(.)48 b(Using)30 b(a)h(ne)n(w)g(API,)g(a)300
3749 y(process)20 b(can)g(allocate)h(a)f(container)-5
b(.)28 b(It)20 b(then)g(can)h(\223\002ll\224)f(the)g(container)g(with)f
(pointers)h(to)f(data)h(b)n(uf)n(fers.)300 3898 y(Once)27
b(a)g(container)g(has)f(been)h(\002lled)g(with)f(the)h(necessary)g
(data)f(a)h(process)g(can)g(\223ship\224)g(it)f(to)g(another)300
4047 y(process)j(or)g(the)f(k)o(ernel.)43 b(Rather)29
b(than)g(recei)n(ving)f(the)h(data)g(directly)-6 b(,)28
b(the)h(recei)n(ving)f(party)h(recei)n(v)o(es)300 4197
y(a)h(handle)f(to)g(the)g(container)-5 b(.)44 b(The)30
b(recei)n(v)o(er)f(then)g(has)g(four)h(options.)43 b(First,)30
b(it)f(could)g(\223unload\224)g(the)300 4346 y(container)l(,)j(thus)e
(causing)g(the)h(data)g(in)f(the)h(container)g(to)f(be)h(mapped)f(into)
g(the)h(recei)n(v)o(er')-5 b(s)30 b(address)300 4496
y(space.)g(Second,)23 b(it)e(could)g(\223free\224)j(the)d(container)h
(\(and)g(the)g(data)g(within\).)28 b(Third,)22 b(it)f(could)h
(\223ship\224)f(the)300 4645 y(container)28 b(of)n(f)g(to)g(another)g
(process.)42 b(F)o(ourth,)28 b(it)g(could)g(\223empty\224)g(the)g
(container)l(,)h(thus)e(freeing)i(data)300 4794 y(from)e(it.)38
b(There)27 b(is)g(also)g(an)g(operation)g(that)g(allo)n(ws)f(a)h
(process)g(to)g(query)h(the)f(status)f(of)h(a)h(container)-5
b(.)300 4944 y(By)33 b(using)f(these)h(operations)f(processes)h(can)h
(pass)e(data)h(between)g(themselv)o(es)f(without)f(mapping)300
5093 y(it)h(into)g(their)g(address)h(space.)54 b(A)33
b(container)f(shipping)f(I/O)h(system)g(could)g(easily)g(tak)o(e)h(adv)
n(antage)300 5243 y(of)40 b(UVM)f(services)h(such)f(as)h(page)g
(loanout)f(and)g(page)h(transfer)g(when)g(loading)f(and)g(unloading)300
5392 y(containers.)p eop
%%Page: 72 92
72 91 bop 3800 100 a Fs(72)300 249 y Fo(The)26 b(P)n(eer)l(-to-P)n(eer)
h(I/O)d(System)300 466 y Fs(Another)33 b(I/O)h(system)f(de)n(v)o
(eloped)f(at)i(Uni)n(v)o(ersity)e(of)i(California)g(San)g(Die)o(go)f
(is)g(the)h(Peer)n(-to-Peer)300 615 y(I/O)24 b(system.)30
b(The)24 b(Peer)n(-to-Peer)i(I/O)e(system)f(w)o(as)i(designed)e(to)h
(ef)n(\002ciently)g(support)f(I/O)i(endpoints)300 764
y(without)k(direct)h(user)h(process)f(interv)o(ention)f([26,)h(27].)48
b(This)30 b(is)g(achie)n(v)o(ed)f(through)h(the)g(use)h(of)f(the)300
914 y Fq(splice)24 b Fs(mechanism.)29 b(The)24 b(splice)g(mechanism)f
(allo)n(ws)g(a)h(data)h(source)f(to)g(directly)f(transfer)i(data)f(to)g
(a)300 1063 y(data)h(sink)f(without)f(going)h(through)g(a)h(process')g
(address)g(space.)583 1213 y(T)-8 b(o)33 b(use)g(a)g(splice)f(a)h
(process)f(must)g(\002rst)h(open)f(the)h(data)g(source)f(for)h(reading)
g(and)f(the)h(data)300 1362 y(sink)d(for)h(writing.)49
b(The)31 b(endpoints)e(can)j(either)f(be)g(\002les)g(or)g(de)n(vices.)
49 b(The)31 b(process)g(then)g(calls)f(the)300 1511 y
Fm(splice)g Fs(system)g(call)i(with)f(the)g(source)g(and)h(sink)e
(\002le)i(descriptors)f(as)g(ar)n(guments.)50 b(This)31
b(causes)300 1661 y(the)39 b(k)o(ernel)g(to)g(create)i(a)e(splice)g
(that)g(associates)g(the)g(source)g(\002le)h(descriptor)f(with)f(the)h
(sink)g(\002le)300 1810 y(descriptor)-5 b(.)30 b(The)25
b Fm(splice)e Fs(system)h(call)h(returns)g(a)g(reference)h(to)f(the)f
(splice)h(to)f(the)h(calling)f(process)300 1960 y(in)j(the)g(form)h(of)
f(a)h(a)g(ne)n(w)f(third)g(\002le)h(descriptor)-5 b(.)38
b(Once)28 b(the)f(splice)g(is)g(established,)g(the)g(process)h(can)300
2109 y(transfer)23 b(a)g(chunk)g(of)g(data)g(from)f(the)h(source)g(to)g
(sink)f(by)g(writing)g(a)h(control)f(message)h(to)f(the)h(splice')-5
b(s)300 2258 y(\002le)26 b(descriptor)-5 b(.)31 b(The)25
b(control)f(message)h(contains)g(the)g(size)g(of)g(the)g(chunk.)32
b(Such)26 b(data)f(is)g(transfered)300 2408 y(through)c(k)o(ernel)i(b)n
(uf)n(fers)f(rather)h(than)f(through)f(the)h(process')h(address)f
(space.)30 b(The)23 b(process)f(can)h(also)300 2557 y(dele)o(gate)h
(control)g(of)h(data)g(transfer)g(to)f(the)h(operating)f(system.)29
b(In)c(that)f(case,)i(the)e(operating)g(system)300 2707
y(will)i(continue)f(to)h(transfer)h(chunks)f(of)h(data)f(until)g(the)g
(end-of-\002le)h(for)g(the)f(data)h(source)f(is)g(reached.)300
2856 y(The)d(process)g(can)g(query)g(the)f(status)g(of)h(a)h(splice)e
(by)h(reading)f(a)h(status)f(message)h(from)g(the)f(splice)h(\002le)300
3005 y(descriptor)-5 b(.)30 b(The)25 b(splice)f(is)g(terminated)g
(simply)f(by)i(closing)f(the)g(splice)h(\002le)g(descriptor)-5
b(.)583 3155 y(The)39 b(splice)f(mechanism)f(also)i(allo)n(ws)e(for)i
(some)f(data)g(processing)g(to)g(occur)h(within)e(the)300
3304 y(k)o(ernel.)43 b(This)28 b(is)g(done)h(by)g(allo)n(wing)e(softw)o
(are)i(data)g(processing)f(modules)g(to)g(be)h(put)f(between)h(the)300
3454 y(data)d(source)g(and)g(sink.)33 b(Such)26 b(modules)f(can)h
(either)g(be)g(compiled)f(into)g(the)h(k)o(ernel)f(or)h(dynamically)300
3603 y(loaded)c(\(if)g(the)g(process)g(has)g(suitable)g(pri)n(vile)o
(ges\).)28 b(This)21 b(mechanism)g(is)h(similar)f(to)h(the)g(STREAMS)
300 3752 y(mechanism)i(that)g(is)g(part)h(of)g(System)f(V)h(Unix)f
([56,)h(58,)f(68].)300 4047 y Fo(Uni\002ed)i(Buffering)g(I/O)e(Systems)
300 4264 y Fs(Rice)31 b(Uni)n(v)o(ersity')-5 b(s)28 b(I/O)j(Lite)f
(uni\002ed)h(b)n(uf)n(fering)f(and)h(caching)f(system)g(uni\002es)g
(the)h(b)n(uf)n(fering)f(and)300 4413 y(caching)i(of)f(all)h(I/O)g
(subsystems)d(in)j(the)f(k)o(ernel)h([52].)52 b(I/O)31
b(Lite)g(e)o(xtends)g(Fb)n(uf)5 b(')-5 b(s)32 b(concept)g(of)g(im-)300
4563 y(mutable)37 b(b)n(uf)n(fers)h(to)g(the)g(entire)g(operating)f
(system.)69 b(These)38 b(immutable)f(b)n(uf)n(fers)g(are)i(read-only)
300 4712 y(mapped)28 b(into)f(the)h(address)h(space)f(of)h(processes)f
(that)g(are)h(accessing)f(them.)41 b(Processes)28 b(access)h(the)300
4862 y(immutable)c(b)n(uf)n(fers)h(through)g(lists)f(of)i(pointers)f
(to)g(the)g(immutable)f(b)n(uf)n(fers)i(called)f(mutable)g(b)n(uf)n
(fer)300 5011 y(aggre)o(gates.)54 b(A)33 b(ne)n(w)f(API)h(is)g(used)f
(to)g(pass)h(a)g(mutable)f(list)g(of)g(b)n(uf)n(fer)h(aggre)o(gates)f
(between)h(end-)300 5160 y(points.)54 b(When)33 b(a)h(process)f(w)o
(ants)f(to)h(modify)f(data)h(stored)g(in)g(an)g(immutable)e(b)n(uf)n
(fer)i(it)g(has)g(three)300 5310 y(options.)67 b(First,)41
b(if)c(the)g(entire)h(b)n(uf)n(fer)f(is)g(being)g(changed)h(it)f(can)h
(be)g(completely)e(replaced)i(with)p eop
%%Page: 73 93
73 92 bop 3800 100 a Fs(73)300 249 y(a)36 b(ne)n(w)g(immutable)e(b)n
(uf)n(fer)-5 b(.)63 b(Second,)39 b(if)d(only)f(part)h(of)g(an)g
(immutable)e(b)n(uf)n(fer)i(is)g(being)f(changed)300
398 y(then)27 b(a)g(ne)n(w)g(b)n(uf)n(fer)g(aggre)o(gate)f(can)h(be)g
(created)h(that)f(directs)f(references)j(to)d(the)h(changed)g(area)h
(to)f(a)300 548 y(ne)n(w)g(immutable)e(b)n(uf)n(fer)-5
b(.)37 b(Finally)-6 b(,)27 b(for)g(applications)f(that)g(require)i
(write)f(access)g(to)g(the)g(immutable)300 697 y(b)n(uf)n(fer)i(I/O)f
(Lite)g(has)h(a)g(special)f(\223mmap\224)g(mode)g(that)g(pro)o(vides)f
(shared)i(access)g(to)f(the)h(\(no)f(longer\))300 847
y(immutable)23 b(b)n(uf)n(fer)-5 b(.)583 996 y(Uni)n(v)o(ersity)22
b(of)i(Maryland')-5 b(s)22 b(Roadrunner)i(I/O)g(system)e(also)h
(uni\002es)h(b)n(uf)n(fering)f(and)g(caching)300 1145
y(of)31 b(all)f(I/O)h(systems)f(in)g(the)h(k)o(ernel)g([41)o(,)g(42].)
49 b(All)30 b(I/O)h(systems)e(in)i(Roadrunner)g(use)g(a)g(\223common)
300 1295 y(b)n(uf)n(fer\224)25 b(to)f(pass)g(data.)30
b(Roadrunner)25 b(supports)e(a)i(more)g(generalized)f(v)o(ersion)g(of)g
(the)g(splice)g(called)h(a)300 1444 y(\223stream\224)i(that)f(uses)g(a)
h(k)o(ernel)g(thread)g(to)f(pro)o(vide)g(autonomous)f(I/O)h(between)h
(an)o(y)f(tw)o(o)h(endpoints.)300 1594 y(Roadrunner')-5
b(s)32 b(caching)g(layer)g(is)g(global.)51 b(Unlik)o(e)32
b(Unix,)h(Roadrunner)f(uses)g(the)g(same)g(layer)g(and)300
1743 y(interf)o(aces)25 b(for)g(all)g(de)n(vices.)583
1892 y(W)-8 b(ashington)34 b(Uni)n(v)o(ersity')-5 b(s)32
b(UCM)j(I/O)f(system)g(is)g(an)h(I/O)g(system)e(that)i(w)o(as)f
(designed)g(to)300 2042 y(unify)28 b(the)g(b)n(uf)n(fering)f(of)h(all)g
(I/O)g(subsystems)e(of)j(the)f(k)o(ernel)g([15,)g(16)o(].)41
b(UCM)29 b(I/O)f(includes)f(a)i(ne)n(w)300 2191 y(API)f(that)f
(supports)f(both)h(netw)o(ork)g(and)g(\002le)h(I/O)g(in)f(a)h(general)f
(w)o(ay)-6 b(.)39 b(It)27 b(w)o(as)h(designed)e(to)i(use)f(page)300
2341 y(remapping)j(to)h(mo)o(v)o(e)e(data)i(between)g(users)g(and)g
(the)f(k)o(ernel.)50 b(The)31 b(design)f(also)g(includes)g(a)i(splice)
300 2490 y(lik)o(e)21 b(f)o(acility)g(for)h(mo)o(ving)e(multimedia)g
(data)h(and)h(a)g(mechanism)f(to)g(combine)g(separate)h(system)e(calls)
300 2639 y(into)k(a)h(single)f(system)g(call.)300 2934
y Fo(Other)h(W)-7 b(ork)300 3151 y Fs(Research)36 b(in)f(the)f(area)i
(of)f(remote)g(procedure)g(call)g(has)g(used)g(virtual)f(memory)g
(services)h(to)f(help)300 3300 y(mo)o(v)o(e)e(data.)58
b(The)33 b(DEC)h(Fire\003y)h(RPC)g(system)e(used)g(a)h(permanently)f
(mapped)g(unprotected)g(area)300 3450 y(of)38 b(memory)e(shared)i
(across)g(all)f(processes)g(to)g(pass)h(RPC)h(data)e([61])h(and)f(pro)o
(vide)g(lo)n(w)f(latenc)o(y)-6 b(.)300 3599 y(The)26
b(LRPC)h(and)e(URPC)i(systems)e(cop)o(y)g(data)h(into)f(memory)g
(statically)f(shared)i(between)g(the)g(client)300 3749
y(and)j(the)f(serv)o(er)h([5,)g(6].)42 b(The)29 b(D)l(ASH)g(IPC)h
(mechanism)e(used)g(a)h(reserv)o(ed)g(area)h(of)e(virtual)g(space)h(in)
300 3898 y(processes)g(to)f(e)o(xchange)h(IPC)h(data)f(through)f(page)h
(remapping)g([67)o(].)44 b(The)29 b(Pere)o(grine)g(IPC)h(system)300
4047 y(used)e(cop)o(y-on-write)f(for)i(output,)e(cop)o(y)h(for)g
(input,)g(and)g(page)g(remapping)g(to)f(mo)o(v)o(e)g(data)h(between)300
4197 y(IPC)22 b(endpoints)e([73].)29 b(Finally)-6 b(,)21
b(the)g(Mach)g(IPC)h(system)e(uses)g(cop)o(y)h(maps,)g(as)h(described)e
(pre)n(viously)-6 b(.)583 4346 y(Some)26 b(research)g(has)g(produced)f
(special)g(purpose)h(I/O)f(systems)f(to)h(w)o(ork)h(around)f(a)h
(speci\002c)300 4496 y(problem.)42 b(F)o(or)29 b(e)o(xample)f(the)h
(MMB)o(UF)g(system)e(is)i(a)g(system)f(that)g(a)n(v)n(oids)g(data)h
(cop)o(ying)f(between)300 4645 y(the)g(\002lesystem)g(and)g(netw)o
(orking)f(layer)h(by)g(using)g(a)g(special)g(b)n(uf)n(fer)g(called)h
(an)f(MMB)o(UF)g(that)g(acts)300 4794 y(as)h(both)e(a)i(netw)o(ork)g
(mb)n(uf)f(or)g(a)h(\002lesystem)f(b)n(uf)n(fer)g([12].)43
b(This)27 b(system)h(is)g(used)g(to)g(transmit)g(video)300
4944 y(data)i(from)g(a)h(disk)e(\002le)i(o)o(v)o(er)e(an)i(A)-11
b(TM)29 b(netw)o(ork)h(using)f(real-time)h(upcalls)g(to)g(maintain)f
(quality)g(of)300 5093 y(service)f([29].)40 b(This)28
b(system)e(could)i(be)g(adapted)g(to)f(use)h(a)h(mechanism)e(lik)o(e)g
(UVM')-5 b(s)27 b(page)h(loanout)300 5243 y(to)c(mo)o(v)o(e)g(data)h
(without)e(cop)o(ying)h(it)g(\(or)h(mapping)f(it\))g(through)g(a)h
(user)g(address)g(space.)p eop
%%Page: 74 94
74 93 bop 3800 100 a Fs(74)583 249 y(Ne)n(w)20 b(designs)g(in)f
(host-netw)o(ork)h(interf)o(aces)g(also)g(look)f(to)h(tak)o(e)h(adv)n
(antage)e(of)i(services)f(that)g(a)300 398 y(VM)g(system)f(such)h(as)h
(UVM)f(can)h(of)n(fer)-5 b(.)29 b(F)o(or)20 b(e)o(xample,)h(the)f(APIC)
h(A)-11 b(TM)20 b(host-netw)o(ork)f(adaptor)i(can)300
548 y(separate)g(protocol)f(headers)h(from)g(data)f(and)h(store)f
(inbound)g(data)h(into)e(pages)i(that)f(can)h(be)g(remapped)300
697 y(into)j(a)h(user')-5 b(s)24 b(address)h(space)g(using)f(a)h
(mechanism)f(such)g(as)h(UVM')-5 b(s)24 b(page)h(transfer)g([20,)g(21)o
(,)g(22].)583 847 y(Researchers)k(are)e(often)g(reluctant)f(to)h
(change)g(traditional)f(APIs)h(for)g(fear)h(of)e(breaking)h(user)300
996 y(programs.)33 b(Ho)n(we)n(v)o(er)l(,)25 b(ne)n(w)g(applications)g
(are)h(often)g(taking)f(adv)n(antage)g(of)h(communications)e(mid-)300
1145 y(dle)n(w)o(are)34 b(such)g(as)g(A)l(CE)h(wrappers)f([60].)59
b(A)l(CE)34 b(wrappers)h(abstract)f(around)g(the)g(dif)n(ferences)g
(be-)300 1295 y(tween)28 b(operating)g(systems)f(to)h(pro)o(vide)f
(applications)g(with)g(a)i(uniform)e(interf)o(ace)i(to)f(IPC)h
(services.)300 1444 y(Such)22 b(techniques)g(could)f(be)h(applied)g(in)
f(the)h(I/O)g(and)g(IPC)i(area)f(to)e(hide)h(dif)n(ferences)g(between)g
(tradi-)300 1594 y(tional)27 b(APIs)h(and)g(ne)n(wer)g(e)o(xperimental)
f(ones.)39 b(Applications)27 b(that)g(use)h(such)f(wrappers)i(w)o(ould)
e(not)300 1743 y(ha)n(v)o(e)d(to)h(be)g(recompiled)f(to)g(tak)o(e)h
(adv)n(antage)f(of)h(ne)n(w)g(APIs.)31 b(Instead)24 b(the)o(y)g(could)h
(dynamically)e(link)300 1892 y(with)e(a)i(ne)n(w)e(middle)n(w)o(are)g
(layer)h(that)g(pro)o(vides)f(the)g(appropriate)h(abstractions)f(and)h
(understands)f(the)300 2042 y(ne)n(w)j(API.)583 2191
y(Recent)41 b(operating)d(systems)g(research)i(has)g(focused)f(on)g(e)o
(xtensible)f(operating)h(systems.)300 2341 y(F)o(or)23
b(e)o(xample,)g(the)h(SPIN)g(k)o(ernel)g(allo)n(ws)e(programs)h
(written)f(in)i(a)f(type-safe)h(language)f(to)g(be)h(do)n(wn-)300
2490 y(loaded)32 b(into)f(the)g(k)o(ernel)h(and)g(e)o(x)o(ecuted)f([7,)
h(8].)52 b(The)32 b(Exok)o(ernel)f(attempts)g(to)g(pro)o(vide)g
(processes)300 2639 y(with)23 b(as)g(much)g(access)h(to)f(the)h(hardw)o
(are)g(of)f(the)h(system)e(as)h(safely)h(possible)e(so)h(that)g
(alternate)h(oper)n(-)300 2789 y(ating)h(system)f(abstractions)g(can)i
(easily)f(be)g(e)n(v)n(aluated)g(without)f(the)h(Exok)o(ernel)g
(getting)f(in)h(the)g(w)o(ay)300 2938 y([34].)57 b(The)33
b(Scout)h(operating)f(system)f(is)h(intended)g(for)g(small)g
(information)f(appliances)h([45,)g(47].)300 3088 y(Scout)27
b(allo)n(ws)f(you)h(to)g(b)n(uild)f(optimized)g(\223paths\224)h
(through)g(the)g(operating)f(system)h(for)g(speci\002c)h(ap-)300
3237 y(plications.)i(Such)c(w)o(ork)f(on)f(e)o(xtensible)g(systems)g
(can)h(pro)o(vide)f(us)h(with)g(insight)e(into)h(serv)o(ers)h(that)g(a)
300 3386 y(VM)f(system)f(should)g(pro)o(vide,)g(and)i(in)f(some)f
(cases)i(allo)n(w)e(applications)g(more)h(direct)h(access)f(to)g(the)
300 3536 y(services)h(that)f(a)h(VM)g(system)e(pro)o(vides)h(the)h(k)o
(ernel.)583 3685 y(Research)e(using)d(the)i(L3)f(and)g(L4)g(microk)o
(ernels)g(has)g(been)h(used)f(to)g(determine)g(the)g(maximal)300
3835 y(achie)n(v)n(able)29 b(le)n(v)o(el)h(of)g(IPC)h(performance)g
(the)f(hardw)o(are)h(will)f(allo)n(w)f([37,)h(38].)47
b(This)30 b(w)o(as)g(done)g(by)300 3984 y(hand)i(coding)g(the)h(IPC)g
(mechanism)f(in)g(assembly)g(language,)i(ensuring)e(that)g(code)h(and)f
(data)h(w)o(as)300 4133 y(positioned)24 b(in)h(memory)f(in)h(such)h(a)f
(w)o(ay)h(that)f(the)o(y)f(all)i(could)f(be)g(co-resident)g(in)g(the)h
(cache,)g(and)f(by)300 4283 y(minimizing)f(the)j(number)f(of)h(TLB)h
(\003ushes)e(used)h(for)g(an)g(IPC)h(operation.)36 b(The)27
b(result)f(of)h(this)f(e)o(x)o(er)n(-)300 4432 y(cise)k(sho)n(ws)f
(that)h(softw)o(are)h(adds)f(a)g(substantial)f(amount)g(to)h(IPC)i(o)o
(v)o(erhead)d(and)i(pro)o(vides)e(a)h(\223best)300 4581
y(case\224)c(tar)n(get)f(for)g(softw)o(are)g(de)n(v)o(elopers)e(to)h
(shoot)g(for)h(when)g(de)n(v)o(eloping)e(ne)n(w)h(IPC)i(mechanisms.)300
4965 y Fg(3.5)143 b(Summary)300 5218 y Fs(In)36 b(this)f(chapter)h(we)g
(ha)n(v)o(e)f(presented)h(an)g(o)o(v)o(ervie)n(w)e(of)i(UVM.)f(The)h(o)
o(v)o(ervie)n(w)e(consisted)g(of)i(the)300 5367 y(goals)23
b(of)h(the)f(UVM)g(project,)g(a)h(description)f(of)g(ne)n(w)g(and)h
(impro)o(v)o(ed)d(features)j(that)f(UVM)g(pro)o(vides,)p
eop
%%Page: 75 95
75 94 bop 3800 100 a Fs(75)300 249 y(and)32 b(a)g(description)e(of)i
(UVM')-5 b(s)31 b(main)g(data)g(structures)g(and)h(functions.)50
b(T)-8 b(able)32 b(3.1)f(and)h(T)-8 b(able)31 b(3.2)300
398 y(summarize)i(the)h(changes)f(introduced)g(to)h(BSD)g(by)g(UVM)f
(and)h(list)f(the)g(design)g(issues)g(we)h(f)o(aced)300
548 y(during)27 b(the)g(implementation)e(of)j(UVM.)f(W)-8
b(e)28 b(also)f(discussed)f(related)i(research)h(in)e(the)g(area)i(of)e
(vir)n(-)300 697 y(tual)h(memory)f(systems,)h(I/O,)g(and)g(IPC.)i(In)e
(the)g(remaining)g(chapters)g(of)g(this)g(dissertation)e(we)j(will)300
847 y(e)o(xamine)24 b(the)h(design)f(and)g(implementation)f(of)i(UVM)f
(in)g(greater)i(detail.)p eop
%%Page: 76 96
76 95 bop 3800 100 a Fs(76)300 973 y Fp(Chapter)51 b(4)300
1448 y(Anonymous)i(Memory)e(Handling)300 1930 y Fs(This)27
b(chapter)g(describes)g(the)h(data)f(structures,)g(functions,)g(and)h
(operation)e(of)i(UVM')-5 b(s)26 b(anon)o(ymous)300 2079
y(memory)31 b(system.)51 b(Anon)o(ymous)29 b(memory)i(is)h(memory)f
(that)g(is)g(freed)i(as)f(soon)f(as)h(it)f(is)h(no)f(longer)300
2229 y(referenced.)50 b(This)30 b(memory)g(is)g(referred)i(to)f(as)g
(anon)o(ymous)d(because)k(it)e(is)g(not)g(associated)h(with)f(a)300
2378 y(\002le)h(and)g(thus)f(does)h(not)f(ha)n(v)o(e)h(a)g(\002le)h
(name.)49 b(Anon)o(ymous)28 b(memory)j(is)f(paged)h(out)f(to)h(the)g
(\223sw)o(ap\224)300 2527 y(area)26 b(when)e(memory)g(is)h(scarce.)300
2911 y Fg(4.1)143 b(Anonymous)33 b(Memory)i(Ov)o(er)o(view)300
3164 y Fs(Anon)o(ymous)f(memory)i(is)g(used)g(for)h(a)g(number)f(of)g
(purposes)g(in)g(a)h(Unix-lik)o(e)e(operating)h(system)300
3313 y(including:)445 3545 y Fr(\017)49 b Fs(for)25 b(zero-\002ll)g
(mappings)f(\(e.g.)31 b(bss)24 b(and)h(stack\).)445 3778
y Fr(\017)49 b Fs(to)24 b(store)h(changed)g(pages)f(in)h(a)g(cop)o
(y-on-write)f(mapping.)445 4010 y Fr(\017)49 b Fs(for)21
b(shared)f(re)o(gions)f(of)i(memory)e(that)h(can)h(be)f(accessed)h
(with)f(the)g(System)g(V)g(shared)h(memory)544 4160 y(system)j(calls.)
445 4392 y Fr(\017)49 b Fs(for)25 b(pageable)g(areas)g(of)g(k)o(ernel)g
(memory)-6 b(.)300 4624 y(In)29 b(the)g(BSD)h(VM)f(system)f(all)h(anon)
o(ymous)e(memory)i(is)f(managed)h(through)f(objects)h(whose)g(pager)300
4774 y(is)34 b(the)g(\223sw)o(ap\224)h(pager)-5 b(.)60
b(Such)35 b(objects)f(are)h(allocated)f(either)h(for)g(zero-\002ll)g
(memory)-6 b(,)35 b(or)g(to)f(act)h(as)300 4923 y(shado)n(w)24
b(or)h(cop)o(y)f(objects)g(for)h(a)h(re)o(gion)e(of)g(cop)o(y-on-write)
h(memory)-6 b(.)583 5073 y(UVM)37 b(uses)f(a)h(tw)o(o-le)n(v)o(el)f
(amap-object)g(memory)g(mapping)f(scheme,)40 b(as)d(pre)n(viously)e
(de-)300 5222 y(scribed)k(in)g(Chapter)h(3.)75 b(In)39
b(UVM')-5 b(s)39 b(tw)o(o-le)n(v)o(el)e(scheme,)43 b(anon)o(ymous)38
b(memory)g(can)i(be)g(found)300 5371 y(at)f(either)g(le)n(v)o(el.)72
b(At)39 b(the)g(lo)n(wer)f(backing)h(object)f(le)n(v)o(el,)k(UVM)c
(supports)g(anon)o(ymous)f(memory)p eop
%%Page: 77 97
77 96 bop 3800 100 a Fs(77)300 249 y Fm(uvm)p 486 249
30 4 v 35 w(object)28 b Fs(structures)h(\(\223aobj\224)g(objects\).)44
b(These)29 b(objects)f(use)i(the)f(anon)o(ymous)e(memory)h(ob-)300
398 y(ject)37 b(pager)g(\(\223aobj\224)h(pager\))f(to)g(access)h
(backing)e(store)h(\(i.e.)68 b(the)37 b(system)f(\223sw)o(ap\224)h
(area\).)69 b(UVM)300 548 y(aobj-objects)36 b(are)i(used)e(to)h
(support)f(the)h(System)f(V)h(shared)g(memory)f(interf)o(ace)i(and)f
(to)f(pro)o(vide)300 697 y(pageable)25 b(k)o(ernel)g(memory)-6
b(.)583 847 y(UVM')h(s)22 b(upper)h(le)n(v)o(el)f(of)h(memory)f
(consists)f(entirely)h(of)h(anon)o(ymous)e(memory)-6
b(.)29 b(Memory)22 b(at)300 996 y(this)f(le)n(v)o(el)g(is)h(referenced)
h(through)e(data)h(structures)g(called)g(anon)o(ymous)e(memory)h(maps)h
(\(\223amaps\224\).)300 1145 y(Thus,)32 b(the)f(upper)g(layer)h(can)f
(be)h(referred)g(to)f(as)g(the)g(\223amap)h(layer)-5
b(.)e(\224)50 b(The)31 b(amap)g(layer)h(sits)e(on)h(top)300
1295 y(of)26 b(the)f(backing)h(layer)-5 b(.)33 b(When)25
b(resolving)g(a)h(page)g(f)o(ault,)g(UVM)f(must)f(\002rst)i(check)g(to)
g(see)g(if)f(the)h(data)300 1444 y(being)k(f)o(aulted)h(is)f(in)h(the)g
(amap)g(layer)g(or)g(not.)48 b(If)31 b(it)g(is)f(not,)i(then)f(the)f
(backing)h(object)f(is)h(check)o(ed.)300 1594 y(Note)e(that)h(unlik)o
(e)e(the)i(BSD)g(VM,)f(there)h(is)f(only)g(one)h(backing)f(object)g
(\227)g(there)h(are)g(no)g(chains)f(of)300 1743 y(objects)35
b(to)g(tra)n(v)o(erse.)62 b(The)35 b(UVM)g(amap)g(layer)h(serv)o(es)e
(the)i(same)f(function)f(as)i(a)f(shado)n(w)g(object)300
1892 y(chain)25 b(in)f(BSD)i(VM;)e(the)h(amap)f(layer)h(is)g(used)f
(for)h(zero-\002ll)h(mappings)d(and)i(for)g(cop)o(y-on-write.)583
2042 y(In)36 b(a)g(typical)f(k)o(ernel)g(running)g(UVM,)g(most)f(anon)o
(ymous)g(memory)g(resides)i(in)f(the)g(amap)300 2191
y(layer)28 b(rather)g(than)g(in)g(\223aobj\224)g(objects.)39
b(The)28 b(amap)f(layer)i(can)f(also)f(be)h(used)g(for)g(page)g
(loanout)f(and)300 2341 y(transfer)38 b(\(see)h(Chapter)f(7\).)70
b(Thus)38 b(amap-based)g(anon)o(ymous)e(memory)h(plays)g(a)h(central)h
(role)e(in)300 2490 y(UVM.)22 b(The)h(remainder)g(of)g(this)f(chapter)h
(will)f(focus)h(on)g(issues)f(relating)g(to)h(amaps.)30
b(More)22 b(informa-)300 2639 y(tion)i(on)g(aobj-based)h(anon)o(ymous)e
(memory)h(can)h(be)g(found)f(in)h(Section)f(8.3)h(on)f(the)h(aobj)f
(pager)-5 b(.)300 3023 y Fg(4.2)143 b(Amap)34 b(Interface)300
3275 y Fs(The)k(\002rst)g(time)g(data)g(is)g(written)f(to)h(memory)f
(mapped)h(by)f(an)i(anon)o(ymous)d(mapping,)k(an)e(amap)300
3425 y(structure)33 b(is)g(created.)58 b(The)33 b(amap)h(contains)f(a)g
(\223slot\224)h(for)f(each)i(page)e(in)g(the)h(mapping.)55
b(Initially)300 3574 y(all)34 b(the)g(slots)e(are)j(empty)-6
b(.)57 b(Ho)n(we)n(v)o(er)l(,)35 b(when)f(data)g(is)g(written)f(to)h(a)
g(page)g(a)h(pointer)e(to)h(an)g(\223anon\224)300 3724
y(structure)24 b(is)h(placed)g(in)f(the)h(corresponding)f(amap)g(slot.)
583 3873 y(Amaps)j(are)g(referenced)h(from)f(map)f(entry)h(data)g
(structures.)36 b(If)27 b(a)g(map)f(entry)h(structure)g(that)300
4022 y(points)j(to)i(an)g(amap)f(is)h(split)e(\(e.g.)52
b(during)31 b(an)h(unmap)f(operation\),)i(the)e(tw)o(o)g(resulting)g
(map)g(entry)300 4172 y(structures)26 b(must)e(each)j(point)e(to)h
(part)g(of)g(the)g(amap.)34 b(The)26 b(original)g(amap)g(could)f(be)h
(brok)o(en)g(up)g(into)300 4321 y(tw)o(o)j(separate)g(amaps,)h(ho)n(we)
n(v)o(er)e(this)h(w)o(ould)f(in)l(v)n(olv)o(e)g(e)o(xpensi)n(v)o(e)f
(data)i(cop)o(ying)g(of)g(the)g(amap)g(and)300 4471 y(also)c(cause)i
(problems)d(in)i(some)f(cases.)34 b(F)o(or)26 b(e)o(xample,)f(consider)
h(an)g(amap)f(that)h(is)f(shared)h(between)300 4620 y(tw)o(o)36
b(distinct)f(processes.)64 b(If)37 b(one)f(of)h(the)f(processes)g
(needs)g(to)g(split)f(its)g(reference)j(to)e(the)g(amap,)300
4769 y(making)e(a)h(cop)o(y)g(of)g(part)g(of)g(the)g(amap)g(w)o(ould)f
(break)i(the)f(sharing)f(of)h(the)g(amap)g(with)f(the)h(other)300
4919 y(process.)d(One)25 b(could)g(k)o(eep)g(track)g(of)h(all)e
(processes)h(sharing)g(an)g(amap,)g(ho)n(we)n(v)o(er)f(that)h(w)o(ould)
f(mean)300 5068 y(chaining)j(a)i(link)o(ed)e(list)g(of)n(f)g(the)h
(amap.)40 b(T)-8 b(o)28 b(a)n(v)n(oid)g(the)g(o)o(v)o(erhead)f
(associated)g(with)h(breaking)f(up)h(an)300 5218 y(amap,)22
b(UVM)f(uses)g(an)g(\223aref)5 b(\224)24 b(\(a)e(map)f(reference\))i
(data)e(structure)g(to)g(point)g(to)g(an)g(amap)g(and)h(the)f(slot)300
5367 y(of)n(fset)28 b(in)f(which)h(the)g(map)g(entry')-5
b(s)27 b(mapping)g(starts.)41 b(The)28 b(aref)h(structure)f(is)f(sho)n
(wn)g(in)h(Figure)h(4.1.)p eop
%%Page: 78 98
78 97 bop 3800 100 a Fs(78)919 552 y @beginspecial 0
@llx 0 @lly 405 @urx 69 @ury 2835 @rwi @setspecial
%%BeginDocument: ../figures/vm_aref.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-80.0 119.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 2023 m 0 0 l 8113 0 l 8113 2023 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
6750 1875 m
gs 1 -1 sc (vm_amap) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1875 m
gs 1 -1 sc (pointer to amap) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 5400 1800 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6441 1763 m 6575 1800 l 6441 1838 l 6615 1838 l 6615 1763 l cp
clip
n 5400 1800 m 6600 1800 l gs col-1 s gr gr

% arrowhead
n 6441 1763 m 6575 1800 l 6441 1838 l 6441 1800 l 6441 1763 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 3600 1575 m 5400 1575 l gs col0 s gr 
% Polyline
30.000 slw
n 3600 1200 m 5400 1200 l 5400 1950 l 3600 1950 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4500 1500 m
gs 1 -1 sc (slotoff) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1875 m
gs 1 -1 sc (amap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4500 1050 m
gs 1 -1 sc (vm_aref) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1500 m
gs 1 -1 sc (slot offset) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1512 755 a(Figure)25 b(4.1:)30 b(The)25
b(aref)h(structure)1003 2489 y @beginspecial 0 @llx 0
@lly 376 @urx 258 @ury 2632 @rwi @setspecial
%%BeginDocument: ../figures/split.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-96.0 362.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 6073 m 0 0 l 7901 0 l 7901 6073 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
4800 2350 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
6600 2475 m
gs 1 -1 sc (amap) col-1 sh gr
/Helvetica ff 300.00 scf sf
6600 2805 m
gs 1 -1 sc (offset=0) col-1 sh gr
% Polyline
30.000 slw
n 4500 2100 m 5100 2100 l 5100 6000 l 4500 6000 l cp gs col-1 s gr 
% Polyline
n 6525 3600 m 7800 3600 l 7800 4350 l 6525 4350 l cp gs col-1 s gr 
% Polyline
7.500 slw
gs  clippath
4368 2172 m 4479 2117 l 4407 2218 l 4531 2113 l 4492 2067 l cp
clip
n 3075 3300 m 4500 2100 l gs col-1 s gr gr

% arrowhead
n 4368 2172 m 4479 2117 l 4407 2218 l 4388 2195 l 4368 2172 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4437 5864 m 4484 5978 l 4389 5899 l 4485 6030 l 4533 5994 l cp
clip
n 3075 4050 m 4500 6000 l gs col-1 s gr gr

% arrowhead
n 4437 5864 m 4484 5978 l 4389 5899 l 4413 5881 l 4437 5864 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5245 2138 m 5126 2101 l 5248 2078 l 5087 2069 l 5083 2129 l cp
clip
n 6525 2175 m 5100 2100 l gs col-1 s gr gr

% arrowhead
n 5245 2138 m 5126 2101 l 5248 2078 l 5247 2108 l 5245 2138 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5248 3022 m 5126 2998 l 5245 2962 l 5083 2971 l 5087 3031 l cp
clip
n 6525 2925 m 5100 3000 l gs col-1 s gr gr

% arrowhead
n 5248 3022 m 5126 2998 l 5245 2962 l 5247 2992 l 5248 3022 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5224 3085 m 5124 3010 l 5247 3029 l 5098 2967 l 5075 3022 l cp
clip
n 6525 3600 m 5100 3000 l gs col-1 s gr gr

% arrowhead
n 5224 3085 m 5124 3010 l 5247 3029 l 5235 3057 l 5224 3085 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5219 5908 m 5117 5979 l 5173 5869 l 5067 5992 l 5113 6031 l cp
clip
n 6525 4350 m 5100 6000 l gs col-1 s gr gr

% arrowhead
n 5219 5908 m 5117 5979 l 5173 5869 l 5196 5889 l 5219 5908 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 4500 2400 m 5100 2400 l gs col-1 s gr 
% Polyline
n 4500 2700 m 5100 2700 l gs col-1 s gr 
% Polyline
n 4500 3000 m 5100 3000 l gs col-1 s gr 
% Polyline
n 4500 3300 m 5100 3300 l gs col-1 s gr 
% Polyline
n 4500 3600 m 5100 3600 l gs col-1 s gr 
% Polyline
n 4500 3900 m 5100 3900 l gs col-1 s gr 
% Polyline
n 4500 4200 m 5100 4200 l gs col-1 s gr 
% Polyline
n 4500 4500 m 5100 4500 l gs col-1 s gr 
% Polyline
n 4500 4800 m 5100 4800 l gs col-1 s gr 
% Polyline
n 4500 5100 m 5100 5100 l gs col-1 s gr 
% Polyline
n 4500 5400 m 5100 5400 l gs col-1 s gr 
% Polyline
n 4500 5700 m 5100 5700 l gs col-1 s gr 
% Polyline
30.000 slw
n 1800 3300 m 3075 3300 l 3075 4050 l 1800 4050 l cp gs col-1 s gr 
/Helvetica-Bold ff 300.00 scf sf
4800 1950 m
gs 1 -1 sc (amap) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4800 3250 m
gs 1 -1 sc (3) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
2400 3000 m
gs 1 -1 sc (before split) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
6600 3900 m
gs 1 -1 sc (amap) col-1 sh gr
/Helvetica ff 300.00 scf sf
6600 4230 m
gs 1 -1 sc (offset=3) col-1 sh gr
/Helvetica ff 300.00 scf sf
1875 3600 m
gs 1 -1 sc (amap) col-1 sh gr
/Helvetica ff 300.00 scf sf
1875 3930 m
gs 1 -1 sc (offset=0) col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
7200 1950 m
gs 1 -1 sc (after split) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
n 6525 2175 m 7800 2175 l 7800 2925 l 6525 2925 l cp gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 1545 2693 a(Figure)f(4.2:)30 b(Splitting)23
b(an)i(aref)300 3088 y(When)k(a)f(map)h(entry)f(is)g(split,)g(one)g(of)
h(the)f(entries)h(can)f(k)o(eep)h(the)f(old)g(slot)g(of)n(fset,)h(b)n
(ut)f(one)g(of)h(them)300 3237 y(will)23 b(need)h(a)g(ne)n(w)f(slot)g
(of)n(fset)g(that)g(has)g(been)h(adjusted)f(by)g(the)h(size)g(of)f(the)
h(other)f(entry)-6 b(,)23 b(as)h(sho)n(wn)e(in)300 3387
y(Figure)j(4.2.)583 3536 y(The)i(format)f(of)g(an)h(anon)f(structure)g
(is)g(sho)n(wn)f(in)h(Figure)h(4.3.)35 b(An)26 b(anon)g(contains)g(a)g
(lock,)h(a)300 3686 y(reference)k(counter)e(indicating)f(ho)n(w)h(man)o
(y)f(amaps)h(ha)n(v)o(e)g(references)i(to)e(the)g(anon,)i(a)e(pointer)l
(,)h(and)300 3835 y(an)g(address)f(in)h(the)f(sw)o(ap)h(area)h(\(the)e
(sw)o(ap)h(slot)f(number\).)45 b(The)29 b(anon')-5 b(s)29
b(pointer)g(is)h(a)g(C)g(union)f(that)300 3984 y(can)e(be)h(used)f(in)f
(one)h(of)g(tw)o(o)g(w)o(ays.)37 b(Unused)27 b(anon)g(structures)f(use)
h(their)g(pointer)g(to)f(form)h(the)g(free)300 4134 y(list.)42
b(In-use)29 b(anon)g(structures)f(use)h(their)f(pointer)h(to)f(point)g
(to)h(the)f Fm(vm)p 2815 4134 30 4 v 36 w(page)g Fs(structure)h
(associated)300 4283 y(with)h(the)h(anon')-5 b(s)30 b(data.)50
b(The)31 b(sw)o(ap)f(slot)h(number)f(is)h(non-zero)g(only)f(if)h(the)g
(anon')-5 b(s)30 b(data)h(has)g(been)300 4433 y(paged)c(out.)37
b(In)28 b(that)e(case,)j(the)e(location)f(of)h(the)g(data)g(on)g
(backing)g(store)g(is)g(stored)f(in)h(the)g(sw)o(ap)g(slot)300
4582 y(number)-5 b(.)33 b(Note)25 b(that)g(amaps)h(track)g(anons)f
(rather)h(than)g(pages)g(because)g(the)o(y)f(need)h(to)f(k)o(eep)h
(track)g(of)300 4731 y(the)21 b(e)o(xtra)g(information)e(stored)i(in)g
(the)f(anon)h(structure)g(\(which)g(is)f(not)h(stored)g(in)f(the)h
(page)g(structure\).)300 4881 y(Anons)26 b(that)f(ha)n(v)o(e)h(been)h
(paged)f(out)g(may)g(not)g(e)n(v)o(en)f(ha)n(v)o(e)h(a)h(page)g(of)f
(physical)f(memory)h(associated)300 5030 y(with)f(them.)34
b(When)26 b(UVM)f(needs)h(to)g(access)g(data)g(contained)f(in)h(an)g
(anon,)g(it)f(\002rst)h(looks)f(for)i(a)f(page)300 5180
y(structure.)43 b(If)30 b(there)f(is)g(none,)h(then)f(it)f(allocates)h
(one)g(and)g(arranges)h(for)f(the)g(data)g(to)g(be)g(brought)f(in)300
5329 y(from)d(backing)f(store.)p eop
%%Page: 79 99
79 98 bop 3800 100 a Fs(79)382 803 y @beginspecial 0
@llx 0 @lly 589 @urx 112 @ury 4123 @rwi @setspecial
%%BeginDocument: ../figures/vm_anon.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 164.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 2773 m 0 0 l 10137 0 l 10137 2773 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
5325 2625 m
gs 1 -1 sc (swslot) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4125 1875 m
gs 1 -1 sc (reference count) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4125 2250 m
gs 1 -1 sc (page or free list pointer \(union\)) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4125 2625 m
gs 1 -1 sc (swap slot number) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6225 2175 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7266 2138 m 7400 2175 l 7266 2213 l 7440 2213 l 7440 2138 l cp
clip
n 6225 2175 m 7425 2175 l gs col-1 s gr gr

% arrowhead
n 7266 2138 m 7400 2175 l 7266 2213 l 7266 2175 l 7266 2138 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
7575 2250 m
gs 1 -1 sc (vm_anon/vm_page) col0 sh gr
% Polyline
n 4425 1575 m 6225 1575 l gs col0 s gr 
% Polyline
n 4425 1950 m 6225 1950 l gs col0 s gr 
% Polyline
n 4425 2325 m 6225 2325 l gs col0 s gr 
% Polyline
30.000 slw
n 4425 1200 m 6225 1200 l 6225 2700 l 4425 2700 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
5325 2250 m
gs 1 -1 sc (nxt/page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5325 1500 m
gs 1 -1 sc (lock) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5325 1875 m
gs 1 -1 sc (ref) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5325 1050 m
gs 1 -1 sc (vm_anon) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4125 1500 m
gs 1 -1 sc (spin lock) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1492 1006 a(Figure)25 b(4.3:)31 b(The)24
b(anon)h(structure)1686 1386 y(T)-8 b(able)25 b(4.1:)30
b(amap)25 b(API)p 424 1518 3328 4 v 422 1639 4 121 v
474 1603 a Fo(Function)p 1550 1639 V 746 w(Description)p
3750 1639 V 424 1642 3328 4 v 422 1883 4 241 v 474 1726
a Fm(amap)p 720 1726 30 4 v 35 w(alloc)p 1550 1883 4
241 v 552 w Fs(allocate)i(a)g(ne)n(w)f(amap)h(of)g(the)f(speci\002ed)h
(size)g(\227)f(the)h(ne)n(w)1601 1847 y(amap)e(does)g(not)f(contain)g
(an)o(y)g(anons)p 3750 1883 V 424 1886 3328 4 v 422 2006
4 121 v 474 1970 a Fm(amap)p 720 1970 30 4 v 35 w(free)p
1550 2006 4 121 v 612 w Fs(free)i(an)f(amap)g(that)f(is)h(no)f(longer)g
(in)h(use)p 3750 2006 V 424 2010 3328 4 v 422 2130 4
121 v 474 2094 a Fm(amap)p 720 2094 30 4 v 35 w(ref)p
1550 2130 4 121 v 672 w Fs(add)g(a)g(reference)i(to)d(an)h(amap)p
3750 2130 V 424 2133 3328 4 v 422 2254 4 121 v 474 2218
a Fm(amap)p 720 2218 30 4 v 35 w(unref)p 1550 2254 4
121 v 552 w Fs(drop)g(a)g(reference)i(from)d(an)h(amap)p
3750 2254 V 424 2257 3328 4 v 422 2378 4 121 v 474 2341
a Fm(amap)p 720 2341 30 4 v 35 w(splitref)p 1550 2378
4 121 v 372 w Fs(split)f(a)h(single)f(reference)i(into)e(tw)o(o)h
(separate)g(references)p 3750 2378 V 424 2381 3328 4
v 422 2501 4 121 v 474 2465 a Fm(amap)p 720 2465 30 4
v 35 w(extend)p 1550 2501 4 121 v 492 w Fs(increase)h(the)e(size)h(of)g
(an)g(amap)p 3750 2501 V 424 2505 3328 4 v 422 2625 4
121 v 474 2589 a Fm(amap)p 720 2589 30 4 v 35 w(add)p
1550 2625 4 121 v 672 w Fs(add)g(an)g(anon)g(to)f(an)h(amap)p
3750 2625 V 424 2628 3328 4 v 422 2749 4 121 v 474 2713
a Fm(amap)p 720 2713 30 4 v 35 w(unadd)p 1550 2749 4
121 v 552 w Fs(remo)o(v)o(e)f(an)h(anon)g(from)f(an)h(amap)p
3750 2749 V 424 2752 3328 4 v 422 2872 4 121 v 474 2836
a Fm(amap)p 720 2836 30 4 v 35 w(lookup)p 1550 2872 4
121 v 492 w Fs(look)f(in)h(a)g(slot)f(in)g(an)h(amap)g(for)g(an)g(anon)
p 3750 2872 V 424 2876 3328 4 v 422 2996 4 121 v 474
2960 a Fm(amap)p 720 2960 30 4 v 35 w(lookups)p 1550
2996 4 121 v 432 w Fs(lookup)f(a)h(range)g(of)g(slots)p
3750 2996 V 424 2999 3328 4 v 422 3120 4 121 v 474 3084
a Fm(amap)p 720 3084 30 4 v 35 w(copy)p 1550 3120 4 121
v 612 w Fs(mak)o(e)g(a)g(cop)o(y-on-write)g(cop)o(y)f(of)h(an)g(amap)p
3750 3120 V 424 3123 3328 4 v 422 3364 4 241 v 474 3207
a Fm(amap)p 720 3207 30 4 v 35 w(cow)p 935 3207 V 35
w(now)p 1550 3364 4 241 v 457 w Fs(resolv)o(e)19 b(all)h(cop)o
(y-on-write)f(f)o(aults)g(in)g(an)h(amap)g(no)n(w)f(\(used)1601
3328 y(for)26 b(wired)e(memory\))p 3750 3364 V 424 3367
3328 4 v 422 3488 4 121 v 474 3451 a Fm(amap)p 720 3451
30 4 v 35 w(share)p 1055 3451 V 34 w(protect)p 1550 3488
4 121 v 98 w Fs(protect)h(pages)g(in)f(an)h(amap)g(that)f(resides)h(in)
f(a)h(share)g(map)p 3750 3488 V 424 3491 3328 4 v 583
3864 a(UVM)j(de\002nes)h(a)f(set)g(of)g(functions)f(that)h(mak)o(e)g
(up)g(the)g(operations)f(that)h(can)h(be)f(performed)300
4014 y(on)d(an)f(amap.)31 b(The)25 b(amap)g(API)g(is)f(sho)n(wn)g(in)g
(T)-8 b(able)25 b(4.1.)300 4397 y Fg(4.3)143 b(Amap)34
b(Implementation)e(Options)300 4650 y Fs(In)d(UVM,)f(the)h(internal)f
(structure)g(of)h(an)g(amap)g(is)f(considered)g(pri)n(v)n(ate)g(to)g
(the)h(amap)f(implementa-)300 4799 y(tion.)42 b(All)29
b(amap)g(accesses)g(are)h(done)f(through)f(the)h(amap)g(API.)g(This)f
(allo)n(ws)g(multiple)f(implemen-)300 4949 y(tations)d(of)h(amaps)g(to)
g(e)o(xist)f(in)h(the)g(source)g(tree)h(at)f(the)h(same)f(time,)f(and)h
(a)h(speci\002c)g(implementation)300 5098 y(can)j(be)g(chosen)f(at)h(k)
o(ernel)g(compile)f(time.)41 b(This)28 b(softw)o(are)h(structure)f(is)g
(useful)h(because)g(there)g(is)f(a)300 5248 y(time)i(vs.)47
b(memory)30 b(space)g(trade-of)n(f)h(to)f(be)h(considered)f(when)g
(implementing)e(amaps.)48 b(Machines)300 5397 y(that)29
b(typically)e(do)i(not)g(ha)n(v)o(e)f(v)o(ery)h(much)g(physical)e
(memory)h(might)g(be)h(better)g(of)n(f)g(using)f(an)h(amap)p
eop
%%Page: 80 100
80 99 bop 3800 100 a Fs(80)1377 937 y @beginspecial 0
@llx 0 @lly 248 @urx 135 @ury 1736 @rwi @setspecial
%%BeginDocument: ../figures/aopt1a.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-96.0 399.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 6682 m 0 0 l 5773 0 l 5773 6682 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
4350 4575 m
gs 1 -1 sc (slot number) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
30.000 slw
n 3300 5100 m 3300 5400 l gs col-1 s gr 
% Polyline
n 3600 5100 m 3600 5400 l gs col-1 s gr 
% Polyline
n 3900 5100 m 3900 5400 l gs col-1 s gr 
% Polyline
n 4200 5100 m 4200 5400 l gs col-1 s gr 
% Polyline
n 4500 5100 m 4500 5400 l gs col-1 s gr 
% Polyline
n 4800 5100 m 4800 5400 l gs col-1 s gr 
% Polyline
n 5100 5100 m 5100 5400 l gs col-1 s gr 
% Polyline
n 5400 5100 m 5400 5400 l gs col-1 s gr 
% Polyline
7.500 slw
n 3000 5400 m 3300 5100 l gs col-1 s gr 
% Polyline
n 3600 5400 m 3900 5100 l gs col-1 s gr 
% Polyline
n 3900 5400 m 4200 5100 l gs col-1 s gr 
% Polyline
n 4500 5400 m 4800 5100 l gs col-1 s gr 
% Polyline
n 4800 5400 m 5100 5100 l gs col-1 s gr 
% Polyline
n 5400 5400 m 5700 5100 l gs col-1 s gr 
% Polyline
gs  clippath
3480 6153 m 3450 6273 l 3420 6153 l 3420 6315 l 3480 6315 l cp
clip
n 3450 5250 m 3450 6300 l gs col-1 s gr gr

% arrowhead
n 3480 6153 m 3450 6273 l 3420 6153 l 3450 6153 l 3480 6153 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4380 6153 m 4350 6273 l 4320 6153 l 4320 6315 l 4380 6315 l cp
clip
n 4350 5250 m 4350 6300 l gs col-1 s gr gr

% arrowhead
n 4380 6153 m 4350 6273 l 4320 6153 l 4350 6153 l 4380 6153 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5280 6153 m 5250 6273 l 5220 6153 l 5220 6315 l 5280 6315 l cp
clip
n 5250 5250 m 5250 6300 l gs col-1 s gr gr

% arrowhead
n 5280 6153 m 5250 6273 l 5220 6153 l 5250 6153 l 5280 6153 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
3750 5025 m
gs 1 -1 sc (2) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4050 5025 m
gs 1 -1 sc (3) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 5025 m
gs 1 -1 sc (4) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4650 5025 m
gs 1 -1 sc (5) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4950 5025 m
gs 1 -1 sc (6) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5250 5025 m
gs 1 -1 sc (7) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5550 5025 m
gs 1 -1 sc (8) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3150 5025 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3450 5025 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3450 6600 m
gs 1 -1 sc (a) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 6600 m
gs 1 -1 sc (b) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5250 6600 m
gs 1 -1 sc (c) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
2400 5400 m
gs 1 -1 sc (amap) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2400 6600 m
gs 1 -1 sc (anon) dup sw pop neg 0 rm  col0 sh gr
% Polyline
30.000 slw
n 3000 5100 m 5700 5100 l 5700 5400 l 3000 5400 l cp gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 994 1140 a(Figure)25 b(4.4:)30 b(A)25 b(simple)f
(array-based)i(amap)e(implementation)1254 2029 y @beginspecial
0 @llx 0 @lly 290 @urx 113 @ury 2030 @rwi @setspecial
%%BeginDocument: ../figures/aopt1b.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-114.0 219.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3682 m 0 0 l 6763 0 l 6763 3682 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
3450 2065 m
gs 1 -1 sc (4) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
30.000 slw
n 3600 1800 m 3600 2400 l gs col0 s gr 
% Polyline
n 3900 1800 m 3900 2400 l gs col0 s gr 
% Polyline
n 4200 1800 m 4200 2400 l gs col0 s gr 
% Polyline
7.500 slw
 [15 45] 45 sd
n 3300 2100 m 4500 2100 l gs col0 s gr  [] 0 sd
% Polyline
n 4200 2400 m 4500 2100 l gs col-1 s gr 
% Polyline
gs  clippath
3780 3153 m 3750 3273 l 3720 3153 l 3720 3315 l 3780 3315 l cp
clip
n 3750 2250 m 3750 3300 l gs col-1 s gr gr

% arrowhead
n 3780 3153 m 3750 3273 l 3720 3153 l 3750 3153 l 3780 3153 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3480 3153 m 3450 3273 l 3420 3153 l 3420 3315 l 3480 3315 l cp
clip
n 3450 2250 m 3450 3300 l gs col-1 s gr gr

% arrowhead
n 3480 3153 m 3450 3273 l 3420 3153 l 3450 3153 l 3480 3153 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4080 3153 m 4050 3273 l 4020 3153 l 4020 3315 l 4080 3315 l cp
clip
n 4050 2250 m 4050 3300 l gs col-1 s gr gr

% arrowhead
n 4080 3153 m 4050 3273 l 4020 3153 l 4050 3153 l 4080 3153 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 4200 2100 m 4500 1800 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
3750 2065 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4050 2065 m
gs 1 -1 sc (7) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 2100 m
gs 1 -1 sc (slot #) col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 2400 m
gs 1 -1 sc (anon pointers) col-1 sh gr
/Helvetica ff 300.00 scf sf
3450 3600 m
gs 1 -1 sc (b) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3750 3600 m
gs 1 -1 sc (a) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4050 3600 m
gs 1 -1 sc (c) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 2250 m
gs 1 -1 sc (amap) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 3600 m
gs 1 -1 sc (anon) dup sw pop neg 0 rm  col0 sh gr
% Polyline
30.000 slw
n 3300 1800 m 4500 1800 l 4500 2400 l 3300 2400 l cp gs col0 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 1036 2232 a(Figure)h(4.5:)30 b(A)25 b(simple)e(list-based)
h(amap)h(implementation)300 2627 y(implementation)c(that)h(is)h
(conserv)n(ati)n(v)o(e)e(on)i(its)f(RAM)i(usage,)f(where)h(as)f
(machines)f(that)h(ha)n(v)o(e)g(lots)f(of)300 2777 y(RAM)j(may)f(wish)g
(to)h(de)n(v)n(ote)f(part)h(of)g(it)f(to)g(speeding)g(up)h(amap)g
(operations.)583 2926 y(There)36 b(are)g(man)o(y)e(w)o(ays)h(that)g(an)
h(amap)f(can)g(be)h(implemented.)60 b(F)o(or)35 b(e)o(xample,)i(one)e
(pos-)300 3075 y(sible)f(implementation)e(of)j(an)f(amap)h(is)f(an)h
(array)g(of)g(pointers)f(to)g(anon)g(structures,)i(as)f(sho)n(wn)e(in)
300 3225 y(Figure)d(4.4.)46 b(The)30 b(pointer)g(array)g(is)g(inde)o(x)
o(ed)f(by)g(the)h(slot)f(number)-5 b(.)46 b(This)29 b(implementation)e
(mak)o(es)300 3374 y(amap)i(lookup)f(operations)h(f)o(ast,)h(ho)n(we)n
(v)o(er)e(operations)g(that)h(require)g(tra)n(v)o(ersing)f(all)h(acti)n
(v)o(e)f(slots)g(in)300 3524 y(the)c(amap)g(w)o(ould)f(ha)n(v)o(e)h(to)
g(e)o(xamine)f(e)n(v)o(ery)g(slot)g(in)h(the)g(array)h(to)f(determine)f
(if)h(it)g(w)o(as)g(in)g(use)g(or)g(not.)300 3673 y(This)g(is)g(ho)n(w)
g(amaps)h(are)g(implemented)f(in)g(SunOS4)h(VM.)583 3822
y(Another)30 b(possible)f(amap)i(implementation)d(is)i(sho)n(wn)f(in)h
(Figure)g(4.5.)47 b(In)31 b(this)e(implemen-)300 3972
y(tation,)g(a)h(dynamically)e(sized)h(array)g(contains)g(a)g(list)f(of)
i(anons)e(and)i(their)e(slot)h(number)-5 b(.)43 b(If)29
b(the)g(list)300 4121 y(array)j(\002lls,)g(a)f(ne)n(w)g(lar)n(ger)h
(one)f(can)g(be)g(allocated)g(to)g(replace)g(it.)49 b(This)30
b(implementation)f(can)i(sa)n(v)o(e)300 4271 y(physical)g(memory)-6
b(,)33 b(especially)f(when)g(an)h(amap)f(is)g(mapping)f(a)i(sparsely)f
(populated)f(area)j(of)e(vir)n(-)300 4420 y(tual)f(memory)-6
b(.)48 b(This)31 b(implementation)e(slo)n(ws)h(do)n(wn)g(amap)h
(lookups)f(\(because)i(the)f(list)f(has)h(to)g(be)300
4569 y(searched)c(for)g(the)f(correct)h(anon)f(for)h(each)g(lookup\),)f
(ho)n(we)n(v)o(er)f(it)h(handles)g(a)g(tra)n(v)o(ersal)g(of)h(the)f
(entire)300 4719 y(amap)f(ef)n(\002ciently)-6 b(.)583
4868 y(UVM)28 b(includes)g(a)h(no)o(v)o(el)e(amap)h(implementation)e
(that)i(combines)g(the)g(ideas)g(behind)g(these)300 5017
y(tw)o(o)c(simple)g(implementations.)p eop
%%Page: 81 101
81 100 bop 3800 100 a Fs(81)610 1590 y @beginspecial
0 @llx 0 @lly 511 @urx 247 @ury 3577 @rwi @setspecial
%%BeginDocument: ../figures/vm_amap.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-39.0 299.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 5023 m 0 0 l 9205 0 l 9205 5023 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
7950 4875 m
gs 1 -1 sc (int) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 4125 m
gs 1 -1 sc (back pointer to am_slots) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 4500 m
gs 1 -1 sc (array of anon pointers) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 4875 m
gs 1 -1 sc (per-page reference count) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 1500 m
gs 1 -1 sc (spin lock) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 1875 m
gs 1 -1 sc (reference count) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 2625 m
gs 1 -1 sc (number of slots allocated) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 3375 m
gs 1 -1 sc (number of slots in use) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 3000 m
gs 1 -1 sc (number of active slots) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 2250 m
gs 1 -1 sc ("shared" flag) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 6600 3675 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7641 3638 m 7775 3675 l 7641 3713 l 7815 3713 l 7815 3638 l cp
clip
n 6600 3675 m 7800 3675 l gs col-1 s gr gr

% arrowhead
n 7641 3638 m 7775 3675 l 7641 3713 l 7641 3675 l 7641 3638 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6600 4050 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7641 4013 m 7775 4050 l 7641 4088 l 7815 4088 l 7815 4013 l cp
clip
n 6600 4050 m 7800 4050 l gs col-1 s gr gr

% arrowhead
n 7641 4013 m 7775 4050 l 7641 4088 l 7641 4050 l 7641 4013 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6600 4425 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7641 4388 m 7775 4425 l 7641 4463 l 7815 4463 l 7815 4388 l cp
clip
n 6600 4425 m 7800 4425 l gs col-1 s gr gr

% arrowhead
n 7641 4388 m 7775 4425 l 7641 4463 l 7641 4425 l 7641 4388 l  cp gs 0.00 setgray ef gr  col-1 s
% Ellipse
n 6600 4800 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
7641 4763 m 7775 4800 l 7641 4838 l 7815 4838 l 7815 4763 l cp
clip
n 6600 4800 m 7800 4800 l gs col-1 s gr gr

% arrowhead
n 7641 4763 m 7775 4800 l 7641 4838 l 7641 4800 l 7641 4763 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 4800 1575 m 6600 1575 l gs col0 s gr 
% Polyline
n 4800 1950 m 6600 1950 l gs col0 s gr 
% Polyline
n 4800 2325 m 6600 2325 l gs col0 s gr 
% Polyline
n 4800 2700 m 6600 2700 l gs col0 s gr 
% Polyline
n 4800 3075 m 6600 3075 l gs col0 s gr 
% Polyline
n 4800 3450 m 6600 3450 l gs col0 s gr 
% Polyline
n 4800 3825 m 6600 3825 l gs col0 s gr 
% Polyline
n 4800 4575 m 6600 4575 l gs col0 s gr 
% Polyline
n 4800 4200 m 6600 4200 l gs col0 s gr 
% Polyline
30.000 slw
n 4800 1200 m 6600 1200 l 6600 4950 l 4800 4950 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
5700 2250 m
gs 1 -1 sc (flags) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 1500 m
gs 1 -1 sc (l) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 1875 m
gs 1 -1 sc (ref) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 4875 m
gs 1 -1 sc (ppref) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5700 1050 m
gs 1 -1 sc (vm_amap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 4500 m
gs 1 -1 sc (anon) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 3000 m
gs 1 -1 sc (nslot) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 3375 m
gs 1 -1 sc (nused) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 3750 m
gs 1 -1 sc (slots) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 4125 m
gs 1 -1 sc (bckptr) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5700 2625 m
gs 1 -1 sc (maxslot) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7950 3750 m
gs 1 -1 sc (int) col0 sh gr
/Helvetica ff 300.00 scf sf
7950 4125 m
gs 1 -1 sc (int) col0 sh gr
/Helvetica ff 300.00 scf sf
7950 4500 m
gs 1 -1 sc (vm_anon) col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
4500 3750 m
gs 1 -1 sc (contiguous array of active slots) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1245 1794 a(Figure)25 b(4.6:)30 b(UVM)24
b(reference)j(amap)d(structure)965 3003 y @beginspecial
0 @llx 0 @lly 389 @urx 168 @ury 2723 @rwi @setspecial
%%BeginDocument: ../figures/aopt2.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-37.0 238.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3994 m 0 0 l 7124 0 l 7124 3994 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
2100 3300 m
gs 1 -1 sc (am_bckptr) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
3750 1725 m
gs 1 -1 sc (3) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4050 1725 m
gs 1 -1 sc (4) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 1725 m
gs 1 -1 sc (5) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4650 1725 m
gs 1 -1 sc (6) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4950 1725 m
gs 1 -1 sc (7) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5250 1725 m
gs 1 -1 sc (8) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2850 1725 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3150 1725 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
30.000 slw
n 2700 1800 m 5400 1800 l 5400 2100 l 2700 2100 l cp gs col-1 s gr 
% Polyline
n 3000 1800 m 3000 2100 l gs col-1 s gr 
% Polyline
n 3300 1800 m 3300 2100 l gs col-1 s gr 
% Polyline
n 3600 1800 m 3600 2100 l gs col-1 s gr 
% Polyline
n 3900 1800 m 3900 2100 l gs col-1 s gr 
% Polyline
n 4200 1800 m 4200 2100 l gs col-1 s gr 
% Polyline
n 4500 1800 m 4500 2100 l gs col-1 s gr 
% Polyline
n 4800 1800 m 4800 2100 l gs col-1 s gr 
% Polyline
n 5100 1800 m 5100 2100 l gs col-1 s gr 
% Polyline
7.500 slw
n 2700 2100 m 3000 1800 l gs col-1 s gr 
% Polyline
n 3300 2100 m 3600 1800 l gs col-1 s gr 
% Polyline
n 3600 2100 m 3900 1800 l gs col-1 s gr 
% Polyline
n 4200 2100 m 4500 1800 l gs col-1 s gr 
% Polyline
n 4500 2100 m 4800 1800 l gs col-1 s gr 
% Polyline
n 5100 2100 m 5400 1800 l gs col-1 s gr 
% Polyline
gs  clippath
3180 2253 m 3150 2373 l 3120 2253 l 3120 2415 l 3180 2415 l cp
clip
n 3150 1950 m 3150 2400 l gs col-1 s gr gr

% arrowhead
n 3180 2253 m 3150 2373 l 3120 2253 l 3150 2253 l 3180 2253 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4080 2253 m 4050 2373 l 4020 2253 l 4020 2415 l 4080 2415 l cp
clip
n 4050 1950 m 4050 2400 l gs col-1 s gr gr

% arrowhead
n 4080 2253 m 4050 2373 l 4020 2253 l 4050 2253 l 4080 2253 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4980 2253 m 4950 2373 l 4920 2253 l 4920 2415 l 4980 2415 l cp
clip
n 4950 1950 m 4950 2400 l gs col-1 s gr gr

% arrowhead
n 4980 2253 m 4950 2373 l 4920 2253 l 4950 2253 l 4980 2253 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 2700 3000 m 5400 3000 l 5400 3300 l 2700 3300 l cp gs col-1 s gr 
% Polyline
n 2700 3600 m 5400 3600 l 5400 3900 l 2700 3900 l cp gs col-1 s gr 
% Polyline
7.500 slw
 [15 45] 45 sd
n 3150 3300 m 3150 3600 l gs col-1 s gr  [] 0 sd
% Polyline
 [15 45] 45 sd
n 4050 3300 m 2850 3600 l gs col-1 s gr  [] 0 sd
% Polyline
 [15 45] 45 sd
n 4959 3300 m 3450 3600 l gs col-1 s gr  [] 0 sd
% Polyline
30.000 slw
n 3000 3000 m 3000 3300 l gs col-1 s gr 
% Polyline
n 3000 3600 m 3000 3900 l gs col-1 s gr 
% Polyline
n 3300 3600 m 3300 3900 l gs col-1 s gr 
% Polyline
n 3600 3600 m 3600 3900 l gs col-1 s gr 
% Polyline
n 3900 3600 m 3900 3900 l gs col-1 s gr 
% Polyline
n 4200 3600 m 4200 3900 l gs col-1 s gr 
% Polyline
n 4500 3600 m 4500 3900 l gs col-1 s gr 
% Polyline
n 4800 3600 m 4800 3900 l gs col-1 s gr 
% Polyline
n 5100 3600 m 5100 3900 l gs col-1 s gr 
% Polyline
n 5100 3000 m 5100 3300 l gs col-1 s gr 
% Polyline
n 4800 3000 m 4800 3300 l gs col-1 s gr 
% Polyline
n 4500 3000 m 4500 3300 l gs col-1 s gr 
% Polyline
n 4200 3000 m 4200 3300 l gs col-1 s gr 
% Polyline
n 3900 3000 m 3900 3300 l gs col-1 s gr 
% Polyline
n 3600 3000 m 3600 3300 l gs col-1 s gr 
% Polyline
n 3300 3000 m 3300 3300 l gs col-1 s gr 
% Polyline
7.500 slw
n 2700 3300 m 3000 3000 l gs col-1 s gr 
% Polyline
n 3300 3300 m 3600 3000 l gs col-1 s gr 
% Polyline
n 3600 3300 m 3900 3000 l gs col-1 s gr 
% Polyline
n 4200 3300 m 4500 3000 l gs col-1 s gr 
% Polyline
n 4500 3300 m 4800 3000 l gs col-1 s gr 
% Polyline
n 5100 3300 m 5400 3000 l gs col-1 s gr 
% Polyline
n 5100 3900 m 5400 3600 l gs col-1 s gr 
% Polyline
n 4800 3900 m 5100 3600 l gs col-1 s gr 
% Polyline
n 4500 3900 m 4800 3600 l gs col-1 s gr 
% Polyline
n 4200 3900 m 4500 3600 l gs col-1 s gr 
% Polyline
n 3900 3900 m 4200 3600 l gs col-1 s gr 
% Polyline
n 3600 3900 m 3900 3600 l gs col-1 s gr 
% Polyline
gs  clippath
5772 2655 m 5652 2625 l 5772 2595 l 5610 2595 l 5610 2655 l cp
clip
n 6150 2625 m 5625 2625 l gs col0 s gr gr

% arrowhead
n 5772 2655 m 5652 2625 l 5772 2595 l 5772 2625 l 5772 2655 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
2100 2100 m
gs 1 -1 sc (am_anon) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4050 1350 m
gs 1 -1 sc (slot #) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3150 2700 m
gs 1 -1 sc (a) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4050 2700 m
gs 1 -1 sc (b) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4950 2700 m
gs 1 -1 sc (c) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2850 3850 m
gs 1 -1 sc (4) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3150 3850 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3450 3850 m
gs 1 -1 sc (7) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4050 3250 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4950 3250 m
gs 1 -1 sc (2) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
6300 2700 m
gs 1 -1 sc (anons) col-1 sh gr
/Helvetica ff 300.00 scf sf
3150 3250 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 3900 m
gs 1 -1 sc (am_slots) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
3450 1725 m
gs 1 -1 sc (2) dup sw pop 2 div neg 0 rm  col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 853 3206 a(Figure)h(4.7:)31 b(UVM)24 b(reference)i(amap)f
(structure')-5 b(s)24 b(three)h(main)f(arrays)300 3601
y Ff(4.3.1)119 b(UVM)30 b(Refer)n(ence)h(Amap)f(Implementation)300
3818 y Fs(UVM)37 b(comes)f(with)h(a)g(reference)i(amap)e
(implementation)e(that)h(w)o(as)i(designed)e(to)h(minimize)e(the)300
3967 y(o)o(v)o(erhead)d(of)i(all)e(amap)h(operations)g(at)g(the)g(cost)
f(of)i(some)e(e)o(xtra)h(memory)-6 b(.)54 b(The)33 b(structure)g(of)g
(the)300 4117 y(reference)f(UVM)f(amap)g(structure)f(is)h(sho)n(wn)e
(in)i(Figure)g(4.6.)49 b(The)30 b(amap)h(structure)g(has)g(a)g(lock,)h
(a)300 4266 y(reference)21 b(counter)f(that)f(indicates)g(ho)n(w)g(man)
o(y)g(maps)g(are)i(referencing)f(it,)g(a)g(\003ag)h(indicating)d
(whether)300 4416 y(the)34 b(data)g(in)g(the)g(amap)g(is)g(being)f
(shared)h(or)h(not,)g(the)f(number)g(of)g(slots)f(allocated)h(for)g
(the)g(amap,)300 4565 y(the)j(number)g(of)h(those)e(slots)h(currently)g
(acti)n(v)o(e,)i(and)f(the)f(number)g(of)g(the)h(acti)n(v)o(e)e(slots)g
(currently)300 4714 y(being)30 b(used.)47 b(The)30 b(amap)g(structure)g
(also)g(contains)g(four)g(arrays)h(that)f(describe)g(the)h(anons)e
(that)h(the)300 4864 y(amap)d(maps.)37 b(These)27 b(arrays)h(are:)35
b Fm(am)p 1662 4864 30 4 v 36 w(slots)p Fs(,)26 b Fm(am)p
2169 4864 V 36 w(bckptr)p Fs(,)g Fm(am)p 2736 4864 V
35 w(anon)p Fs(,)h(and)g Fm(am)p 3354 4864 V 36 w(ppref)p
Fs(.)36 b(The)300 5013 y Fm(am)p 426 5013 V 35 w(ppref)25
b Fs(array)i(is)e(optional)g(and)h(will)f(be)h(described)g(in)f
(Section)h(4.3.2.)34 b(Figure)26 b(4.7)f(sho)n(ws)g(ho)n(w)300
5163 y(the)g(other)f(three)h(arrays)h(are)f(used.)p eop
%%Page: 82 102
82 101 bop 3800 100 a Fs(82)473 1380 y @beginspecial
0 @llx 0 @lly 558 @urx 211 @ury 3906 @rwi @setspecial
%%BeginDocument: ../figures/amap_pp.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-27.0 290.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4873 m 0 0 l 9786 0 l 9786 4873 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
5100 3850 m
gs 1 -1 sc (6) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1875 3225 m
gs 1 -1 sc (amap) col-1 sh gr
/Helvetica ff 300.00 scf sf
1875 3555 m
gs 1 -1 sc (offset=0) col-1 sh gr
% Polyline
30.000 slw
n 7125 1800 m 8400 1800 l 8400 2550 l 7125 2550 l cp gs col-1 s gr 
/Helvetica ff 300.00 scf sf
7200 2100 m
gs 1 -1 sc (amap) col-1 sh gr
/Helvetica ff 300.00 scf sf
7200 2430 m
gs 1 -1 sc (offset=0) col-1 sh gr
% Polyline
 [15 90] 90 sd
n 7125 2925 m 8400 2925 l 8400 3675 l 7125 3675 l cp gs col-1 s gr  [] 0 sd
/Helvetica ff 300.00 scf sf
7200 3225 m
gs 1 -1 sc (amap) col-1 sh gr
/Helvetica ff 300.00 scf sf
7200 3555 m
gs 1 -1 sc (offset=1) col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
8700 3225 m
gs 1 -1 sc (deleted) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8700 3570 m
gs 1 -1 sc (aref) col0 sh gr
% Polyline
n 7125 4050 m 8400 4050 l 8400 4800 l 7125 4800 l cp gs col-1 s gr 
% Polyline
7.500 slw
gs  clippath
5550 4492 m 5426 4493 l 5535 4434 l 5378 4475 l 5393 4533 l cp
clip
n 7125 4050 m 5400 4500 l gs col0 s gr gr

% arrowhead
n 5550 4492 m 5426 4493 l 5535 4434 l 5542 4463 l 5550 4492 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5547 4830 m 5427 4800 l 5547 4770 l 5385 4770 l 5385 4830 l cp
clip
n 7125 4800 m 5400 4800 l gs col0 s gr gr

% arrowhead
n 5547 4830 m 5427 4800 l 5547 4770 l 5547 4800 l 5547 4830 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica ff 300.00 scf sf
7200 4350 m
gs 1 -1 sc (amap) col-1 sh gr
/Helvetica ff 300.00 scf sf
7200 4680 m
gs 1 -1 sc (offset=9) col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
8700 4350 m
gs 1 -1 sc (new) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8700 4695 m
gs 1 -1 sc (aref) col0 sh gr
% Polyline
gs  clippath
4660 1855 m 4777 1814 l 4693 1905 l 4829 1817 l 4796 1767 l cp
clip
n 3075 2925 m 4800 1800 l gs col0 s gr gr

% arrowhead
n 4660 1855 m 4777 1814 l 4693 1905 l 4677 1880 l 4660 1855 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5547 1830 m 5427 1800 l 5547 1770 l 5385 1770 l 5385 1830 l cp
clip
n 7125 1800 m 5400 1800 l gs col0 s gr gr

% arrowhead
n 5547 1830 m 5427 1800 l 5547 1770 l 5547 1800 l 5547 1830 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5535 2166 m 5426 2106 l 5550 2108 l 5393 2067 l 5378 2125 l cp
clip
n 7125 2550 m 5400 2100 l gs col0 s gr gr

% arrowhead
n 5535 2166 m 5426 2106 l 5550 2108 l 5542 2137 l 5535 2166 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
5520 2190 m 5424 2111 l 5546 2136 l 5399 2066 l 5374 2121 l cp
clip
n 7125 2925 m 5400 2100 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 5520 2190 m 5424 2111 l 5546 2136 l 5533 2163 l 5520 2190 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 4800 2100 m 5400 2100 l gs col-1 s gr 
% Polyline
n 4800 2400 m 5400 2400 l gs col-1 s gr 
% Polyline
n 4800 2700 m 5400 2700 l gs col-1 s gr 
% Polyline
n 4800 3000 m 5400 3000 l gs col-1 s gr 
% Polyline
n 4800 3300 m 5400 3300 l gs col-1 s gr 
% Polyline
n 4800 3600 m 5400 3600 l gs col-1 s gr 
% Polyline
n 4800 3900 m 5400 3900 l gs col-1 s gr 
% Polyline
n 4800 4200 m 5400 4200 l gs col-1 s gr 
% Polyline
n 4800 4500 m 5400 4500 l gs col-1 s gr 
% Polyline
gs  clippath
4693 4695 m 4777 4785 l 4660 4745 l 4796 4833 l 4829 4783 l cp
clip
n 3075 3675 m 4800 4800 l gs col0 s gr gr

% arrowhead
n 4693 4695 m 4777 4785 l 4660 4745 l 4677 4720 l 4693 4695 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
5546 4464 m 5424 4488 l 5520 4410 l 5374 4479 l 5399 4534 l cp
clip
n 7125 3675 m 5400 4500 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 5546 4464 m 5424 4488 l 5520 4410 l 5533 4437 l 5546 4464 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 4800 1800 m 5400 1800 l 5400 4800 l 4800 4800 l cp gs col-1 s gr 
/Helvetica-Bold ff 300.00 scf sf
2400 1500 m
gs 1 -1 sc (BEFORE) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 3300 m
gs 1 -1 sc (original) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 3645 m
gs 1 -1 sc (aref) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
7800 1500 m
gs 1 -1 sc (AFTER) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8700 2100 m
gs 1 -1 sc (new) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
8700 2445 m
gs 1 -1 sc (aref) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5100 1650 m
gs 1 -1 sc (amap) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 2650 m
gs 1 -1 sc (2) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 2350 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 2950 m
gs 1 -1 sc (3) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 3250 m
gs 1 -1 sc (4) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 3550 m
gs 1 -1 sc (5) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 4150 m
gs 1 -1 sc (7) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 4450 m
gs 1 -1 sc (8) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 4750 m
gs 1 -1 sc (9) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 2050 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
n 1800 2925 m 3075 2925 l 3075 3675 l 1800 3675 l cp gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 1308 1584 a(Figure)25 b(4.8:)31 b(A)24 b(partial)h(unmap)f
(of)h(an)g(amap)445 1979 y Fr(\017)49 b Fs(The)29 b Fm(am)p
854 1979 30 4 v 36 w(anon)f Fs(array)i(consists)e(of)i(a)g(set)f(of)g
(pointers)g(to)g(an)g(anon)h(structure.)44 b(This)28
b(array)j(is)544 2128 y(inde)o(x)o(ed)23 b(by)i(slot)f(number)-5
b(.)29 b(The)c Fm(am)p 1835 2128 V 36 w(anon)f Fs(array)h(allo)n(ws)f
(quick)g(amap)h(lookup)e(operations.)445 2361 y Fr(\017)49
b Fs(The)32 b Fm(am)p 857 2361 V 36 w(slots)f Fs(array)i(contains)e(a)i
(contiguous)e(list)g(of)h(the)g(slots)f(in)h(the)g Fm(am)p
3394 2361 V 36 w(anon)f Fs(array)544 2510 y(that)d(are)h(currently)g
(in)f(use.)42 b(This)28 b(list)f(is)h(not)g(in)h(an)o(y)f(special)g
(order)-5 b(.)42 b(The)28 b Fm(am)p 3338 2510 V 36 w(slots)f
Fs(array)544 2659 y(can)e(be)g(used)g(to)f(quickly)g(tra)n(v)o(erse)g
(all)h(anons)f(that)h(are)g(currently)g(pointed)f(to)g(by)h(the)f
(amap.)445 2892 y Fr(\017)49 b Fs(The)37 b Fm(am)p 862
2892 V 35 w(bckptr)f Fs(array)i(is)e(used)h(to)g(k)o(eep)g(the)g
Fm(am)p 2476 2892 V 35 w(anon)f Fs(array)i(and)f Fm(am)p
3330 2892 V 35 w(slots)f Fs(array)544 3041 y(in)j(sync.)75
b(The)40 b Fm(am)p 1265 3041 V 35 w(bckptr)f Fs(array)h(maps)f(an)h
(acti)n(v)o(e)f(slot)f(number)i(to)f(the)g(inde)o(x)g(in)g(the)544
3191 y Fm(am)p 670 3191 V 35 w(slots)g Fs(array)h(in)g(which)f(its)g
(contiguous)f(entry)h(lies.)75 b(F)o(or)40 b(e)o(xample,)i(in)e(Figure)
f(4.7)544 3340 y Fm(amap)p 790 3340 V 35 w(anon[7])21
b Fs(points)h(to)h(anon)f(\223c\224)i(and)f(its)f(entry)h(in)g(the)g
(contiguous)e Fm(am)p 3344 3340 V 35 w(slots)h Fs(array)544
3489 y(is)i(at)h Fm(am)p 858 3489 V 35 w(slots[2])p Fs(.)300
3821 y Ff(4.3.2)119 b(P)o(artial)29 b(Unmap)i(of)e(an)h(Amap)300
4037 y Fs(When)37 b(the)g(\002nal)h(reference)h(to)d(memory)h(mapped)f
(by)h(an)h(amap)f(is)g(remo)o(v)o(ed)e(due)j(to)e(an)i(unmap)300
4187 y(operation,)28 b(the)g(physical)f(memory)g(and)h(backing)f(store)
h(associated)g(with)f(it)g(can)i(be)f(freed)h(because)300
4336 y(that)24 b(memory)f(can)h(ne)n(v)o(er)g(be)g(referenced)i(again.)
j(Ho)n(we)n(v)o(er)l(,)23 b(a)i(problem)e(can)h(occur)h(when)f(only)f
(part)300 4485 y(of)33 b(an)g(amap)f(is)h(unmapped.)54
b(Consider)32 b(a)h(process)g(with)f(a)h(map)g(entry)f(that)h(maps)f
(ten)g(pages)h(and)300 4635 y(whose)22 b(aref)h(structure)f(points)f
(to)g(a)i(ten-slot)e(amap)h(that)g(is)g(not)f(referenced)j(by)e(an)o(y)
f(other)h(map.)30 b(No)n(w)300 4784 y(suppose)e(the)i(process)f(unmaps)
f(the)h(middle)f(eight)h(pages)g(of)h(the)f(map)g(entry)-6
b(.)43 b(In)30 b(order)f(to)g(do)g(this,)300 4934 y(UVM)21
b(will)g(break)i(the)e(map)h(entry)g(up)f(into)g(three)h(separate)h
(map)e(entries)h(and)g(dispose)f(of)h(the)f(middle)300
5083 y(one.)32 b(This)24 b(process)h(is)g(sho)n(wn)f(in)h(Figure)g
(4.8.)32 b(Before)26 b(the)f(unmap,)g(the)g(amap')-5
b(s)24 b(reference)j(count)e(is)300 5232 y(one.)k(After)21
b(the)g(unmap)e(the)i(amap')-5 b(s)20 b(reference)i(count)e(is)g(tw)o
(o.)29 b(Note)20 b(that)h(pages)f(in)g(slots)g(one)g(to)g(nine)300
5382 y(are)j(no)f(longer)g(accessible)g(after)g(the)g(unmap)g
(operation,)g(and)g(in)g(f)o(act)g(the)o(y)f(can)i(ne)n(v)o(er)e(be)i
(referenced)p eop
%%Page: 83 103
83 102 bop 3800 100 a Fs(83)300 249 y(again.)51 b(Whether)31
b(the)h(unmapped)f(memory)g(is)g(freed)h(immediately)e(or)i(whether)f
(is)h(it)f(freed)h(when)300 398 y(the)25 b(amap')-5 b(s)24
b(reference)i(count)e(drops)h(to)f(zero)i(is)e(a)h(decision)f(left)h
(up)f(to)h(the)f(amap)h(implementation.)583 548 y(The)39
b(tradeof)n(fs)g(to)f(this)g(decision)g(are)i(as)f(follo)n(ws:)57
b(if)39 b(the)g(amap)f(module)g(does)h(not)f(free)300
697 y(partially)19 b(unmapped)g(sections)f(of)i(an)g(amap)g(until)e
(the)i(entire)f(amap')-5 b(s)19 b(reference)j(count)d(goes)g(to)h
(zero,)300 847 y(then)h(its)f(code)h(will)f(be)i(less)e(comple)o(x)g
(since)h(it)f(has)h(less)g(to)f(manage.)30 b(Also,)21
b(traditional)e(processes)i(on)300 996 y(a)i(Unix-lik)o(e)e(operating)h
(system)g(seldom)f(if)i(e)n(v)o(er)f(perform)g(a)h(partial)f(unmap)g
(of)h(memory)-6 b(.)28 b(Ho)n(we)n(v)o(er)l(,)300 1145
y(ne)n(wer)21 b(memory)f(allocators)g(often)h(mak)o(e)g(use)g(of)g(the)
g Fm(mmap)f Fs(and)h Fm(munmap)e Fs(system)h(calls)h(to)f(allocate)300
1295 y(and)33 b(free)i(memory)-6 b(,)34 b(and)g(these)f(allocations)f
(tak)o(e)i(place)f(from)h(amaps.)56 b(Also)33 b(ne)n(wer)g(VM-related)
300 1444 y(IPC)27 b(systems)d(can)i(also)g(tak)o(e)f(adv)n(antage)h(of)
f(the)h(amap)g(layer)g(to)f(mo)o(v)o(e)f(data,)i(thus)f(using)g(it)g
(in)g(w)o(ays)300 1594 y(that)34 b(traditional)g(processes)g(do)h(not.)
59 b(If)35 b(partial)g(amap)f(memory)g(unmaps)g(become)g(frequent)h
(and)300 1743 y(the)29 b(amap)f(layer)h(does)g(not)f(immediately)f
(free)i(resources)g(\227)g(as)g(in)f(the)g(BSD)i(VM)e(system)g(\227)g
(it)h(is)300 1892 y(possible)23 b(for)j(a)f(\223sw)o(ap)g(memory)f
(leak\224)h(situation)e(to)h(de)n(v)o(elop.)583 2042
y(UVM')-5 b(s)40 b(reference)j(amap)e(implementation)d(handles)j
(partial)f(unmaps)g(without)g(causing)300 2191 y(sw)o(ap)35
b(memory)g(leaks.)62 b(This)34 b(requires)h(a)h(fe)n(w)f(e)o(xtra)g
(internal)g(functions)f(in)h(the)g(reference)i(amap)300
2341 y(module,)32 b(and)g(an)g Fm(am)p 1085 2341 30 4
v 35 w(ppref)f Fs(array)i(in)e(the)h(amap)f(structure.)52
b(The)31 b Fm(am)p 2930 2341 V 36 w(ppref)g Fs(is)g(a)h(\223per)n
(-page\224)300 2490 y(array)25 b(of)g(reference)h(counters)1370
2454 y Fj(1)1407 2490 y Fs(.)31 b(This)24 b(array)h(is)f(only)g
(allocated)h(and)f(acti)n(v)o(e)g(when)g(a)h(reference)i(to)d(an)300
2639 y(anon)o(ymous)d(map)h(has)h(been)g(split)e(the)i(w)o(ay)g(it)f(w)
o(as)h(in)g(Figure)g(4.8.)29 b(When)23 b(the)g(array)g(is)g(\002rst)f
(created,)300 2789 y(each)k(page)g(gets)f(a)g(reference)j(count)c
(equal)i(to)f(the)g(reference)i(count)e(of)h(the)f(amap)g(itself.)32
b(From)26 b(that)300 2938 y(point)21 b(onw)o(ard,)h(as)g(parts)g(of)g
(the)f(amap)h(are)h(referenced)g(and)f(freed)h(the)e(per)n(-page)i
(reference)g(counters)300 3088 y(are)g(adjusted)f(to)g(k)o(eep)h(track)
g(of)f(each)h(page')-5 b(s)23 b(current)f(number)g(of)h(references.)31
b(If)23 b(a)g(page')-5 b(s)23 b(per)n(-page)300 3237
y(reference)j(count)f(drops)f(to)g(zero,)i(then)e(an)o(y)g(allocated)h
(memory)f(or)h(sw)o(ap)f(is)h(immediately)e(freed.)583
3386 y(K)n(eeping)h(a)h(reference)h(counter)e(for)h(each)g(page)f(in)g
(a)h(lar)n(ge)g(amap)f(w)o(ould)g(be)h(e)o(xpensi)n(v)o(e.)j(F)o(or)300
3536 y(e)o(xample,)35 b(if)f(the)g(reference)h(to)f(an)g
Fn(N)10 b Fs(-page)35 b(re)o(gion)e(of)h(an)g(amap)f(is)h(changed)g
(due)g(to)f(a)h(mapping)300 3685 y(operation,)g(then)f(all)f
Fn(N)43 b Fs(per)n(-page)34 b(reference)g(counters)f(will)f(ha)n(v)o(e)
g(to)h(be)f(updated.)55 b(Consider)32 b(the)300 3835
y(e)o(xample)g(sho)n(wn)g(in)h(Figure)g(4.8.)55 b(If)33
b(the)g(amap)g(starts)g(of)n(f)g(with)f(a)h(reference)i(count)d(of)h
(one,)i(then)300 3984 y(the)26 b(per)n(-page)h(reference)h(counters)d
(w)o(ould)h(ha)n(v)o(e)g(to)f(be)i(adjusted)e(for)h(the)h(unmap)e(as)h
(sho)n(wn)f(in)h(Fig-)300 4133 y(ure)j(4.9.)40 b(Each)29
b(reference)h(counter)e(in)g(the)g(unmapped)f(range)i(will)e(ha)n(v)o
(e)h(to)g(be)h(changed)f(from)g(one)300 4283 y(to)c(zero.)583
4432 y(W)-8 b(e)28 b(can)g(reduce)g(the)g(o)o(v)o(erhead)e(of)i(per)n
(-page)g(reference)h(counters)e(by)h(using)e(one)h(reference)300
4581 y(counter)37 b(for)g(each)g(contiguous)f(block)g(of)h(memory)-6
b(.)65 b(UVM')-5 b(s)36 b(reference)j(amap)e(implementation)300
4731 y(attempts)27 b(to)g(reduce)h(this)f(o)o(v)o(erhead)g(of)h(per)n
(-page)h(reference)g(counters.)39 b(In)28 b(the)g(e)o(xample)f(sho)n
(wn)f(in)300 4880 y(Figure)h(4.9,)g(there)g(is)g(a)g(lar)n(ge)h
(contiguous)d(block)h(of)h(eight)g(pages)g(whose)f(reference)j(count)d
(is)h(zero.)300 5030 y(Rather)f(than)g(ha)n(ving)f(indi)n(vidual)e
(counters)j(for)g(this)e(re)o(gion)h(that)h(each)g(need)g(updating)e
(in)i(the)f(e)n(v)o(ent)300 5179 y(of)30 b(a)g(reference)h(count)e
(change,)i(it)f(w)o(ould)e(be)i(more)g(ef)n(\002cient)g(to)f(ha)n(v)o
(e)g(one)h(counter)g(for)g(the)f(entire)p 300 5269 1440
4 v 416 5330 a Fi(1)449 5360 y Fh(In)20 b(this)h(case)g(\223page\224)e
(means)h(anon)o(ymous)d(memory)i(page,)g(not)h(physical)f(memory)f
(page.)p eop
%%Page: 84 104
84 103 bop 3800 100 a Fs(84)770 1404 y @beginspecial
0 @llx 0 @lly 456 @urx 215 @ury 3192 @rwi @setspecial
%%BeginDocument: ../figures/amap_pp2.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-27.0 256.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4294 m 0 0 l 8074 0 l 8074 4294 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
2400 900 m
gs 1 -1 sc (arefs after unmap) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
n 4800 1800 m 5400 1800 l gs col-1 s gr 
% Polyline
n 4800 2100 m 5400 2100 l gs col-1 s gr 
% Polyline
n 4800 2400 m 5400 2400 l gs col-1 s gr 
% Polyline
n 4800 2700 m 5400 2700 l gs col-1 s gr 
% Polyline
n 4800 3000 m 5400 3000 l gs col-1 s gr 
% Polyline
n 4800 3300 m 5400 3300 l gs col-1 s gr 
% Polyline
n 4800 3600 m 5400 3600 l gs col-1 s gr 
% Polyline
n 4800 3900 m 5400 3900 l gs col-1 s gr 
% Polyline
30.000 slw
n 4800 1200 m 5400 1200 l 5400 4200 l 4800 4200 l cp gs col-1 s gr 
/Helvetica ff 300.00 scf sf
5100 2050 m
gs 1 -1 sc (2) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 1750 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 2350 m
gs 1 -1 sc (3) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 2650 m
gs 1 -1 sc (4) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 2950 m
gs 1 -1 sc (5) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 3550 m
gs 1 -1 sc (7) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 3850 m
gs 1 -1 sc (8) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 4150 m
gs 1 -1 sc (9) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 1450 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 3250 m
gs 1 -1 sc (6) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
7.500 slw
gs  clippath
4653 1170 m 4773 1200 l 4653 1230 l 4815 1230 l 4815 1170 l cp
clip
n 3075 1200 m 4800 1200 l gs col0 s gr gr

% arrowhead
n 4653 1170 m 4773 1200 l 4653 1230 l 4653 1200 l 4653 1170 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4650 1508 m 4773 1506 l 4665 1566 l 4822 1525 l 4807 1467 l cp
clip
n 3075 1950 m 4800 1500 l gs col0 s gr gr

% arrowhead
n 4650 1508 m 4773 1506 l 4665 1566 l 4658 1537 l 4650 1508 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
4654 1536 m 4775 1511 l 4680 1590 l 4826 1521 l 4801 1466 l cp
clip
n 3075 2325 m 4800 1500 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 4654 1536 m 4775 1511 l 4680 1590 l 4667 1563 l 4654 1536 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
4680 3810 m 4775 3888 l 4654 3864 l 4801 3934 l 4826 3879 l cp
clip
n 3075 3075 m 4800 3900 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 4680 3810 m 4775 3888 l 4654 3864 l 4667 3837 l 4680 3810 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
 [15 90] 90 sd
n 3075 2325 m 1800 2325 l 1800 3075 l 3075 3075 l cp gs col-1 s gr  [] 0 sd
% Polyline
n 3075 3450 m 1800 3450 l 1800 4200 l 3075 4200 l cp gs col-1 s gr 
% Polyline
7.500 slw
gs  clippath
4665 3834 m 4773 3893 l 4650 3892 l 4807 3933 l 4822 3875 l cp
clip
n 3075 3450 m 4800 3900 l gs col0 s gr gr

% arrowhead
n 4665 3834 m 4773 3893 l 4650 3892 l 4658 3863 l 4665 3834 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4653 4170 m 4773 4200 l 4653 4230 l 4815 4230 l 4815 4170 l cp
clip
n 3075 4200 m 4800 4200 l gs col0 s gr gr

% arrowhead
n 4653 4170 m 4773 4200 l 4653 4230 l 4653 4200 l 4653 4170 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 3075 1200 m 1800 1200 l 1800 1950 l 3075 1950 l cp gs col-1 s gr 
/Helvetica-Bold ff 300.00 scf sf
1500 1500 m
gs 1 -1 sc (new) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 1845 m
gs 1 -1 sc (aref) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
3000 2625 m
gs 1 -1 sc (amap) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3000 2955 m
gs 1 -1 sc (offset=1) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 2625 m
gs 1 -1 sc (deleted) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 2970 m
gs 1 -1 sc (aref) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
3000 3750 m
gs 1 -1 sc (amap) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3000 4080 m
gs 1 -1 sc (offset=9) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 3750 m
gs 1 -1 sc (new) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1500 4095 m
gs 1 -1 sc (aref) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
3000 1500 m
gs 1 -1 sc (amap) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3000 1830 m
gs 1 -1 sc (offset=0) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
6600 1575 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 1905 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 2235 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 2565 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 2895 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 3225 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 3555 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 3885 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 4215 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 1575 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 1905 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 2235 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 2565 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 2895 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 3225 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 3555 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 3885 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 4215 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
7050 975 m
gs 1 -1 sc (per-page refs) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6600 1275 m
gs 1 -1 sc (before) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7500 1275 m
gs 1 -1 sc (after) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5100 1050 m
gs 1 -1 sc (amap) dup sw pop 2 div neg 0 rm  col-1 sh gr
% Polyline
7.500 slw
n 4800 1500 m 5400 1500 l gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1607 a(Figure)23 b(4.9:)29 b(Per)n(-page)24
b(reference)h(counters)e(before)g(and)g(after)g(an)h(unmapping.)k
(Before)c(the)f(unmap,)300 1727 y(the)g(amap')-5 b(s)23
b(o)o(v)o(erall)f(reference)i(count)f(is)g(one,)g(and)g(after)h(the)f
(unmap)g(its)f(o)o(v)o(erall)g(reference)j(count)e(is)300
1848 y(tw)o(o)h(\(one)h(for)g(each)h(aref\).)300 2239
y(contiguous)34 b(chunk,)k(and)e(then)f(ha)n(v)o(e)h(another)f(array)i
(to)e(indicate)g(the)h(length)f(of)h(the)f(chunk.)63
b(An)300 2388 y(e)o(xample)24 b(of)h(this)f(encoding)g(is)g(sho)n(wn)g
(in)g(Figure)h(4.10.)583 2538 y(Adding)36 b(a)g(second)g(array)h(to)e
(k)o(eep)i(track)f(of)g(the)g(length)g(of)g(a)g(mapping)f(w)o(ould)g
(allo)n(w)g(us)300 2687 y(to)d(change)g(the)g(reference)i(count)e(on)g
(a)g(block)g(of)g(pages)g(quickly)-6 b(.)52 b(Ho)n(we)n(v)o(er)l(,)33
b(it)e(also)h(doubles)f(the)300 2837 y(memory)20 b(needed)i(by)f(the)g
(per)n(-page)g(reference)i(count)e(system.)28 b(UVM)21
b(tak)o(es)g(adv)n(antage)f(of)i(the)f(lar)n(ge)300 2986
y(number)26 b(of)g(\223don')n(t)g(care\224)i(v)n(alues)d(in)h(the)g
(array)h(to)f(compact)g(the)g(reference)i(and)e(length)f(arrays)i(into)
300 3135 y(one)h(single)f(array)-6 b(.)40 b(This)27 b(is)h(done)g(by)f
(di)n(viding)f(the)i(blocks)f(of)h(references)h(into)e(tw)o(o)h
(groups:)36 b(those)300 3285 y(of)23 b(one)g(page)h(in)f(length)f(and)h
(those)g(of)g(more)g(than)g(one)g(page)g(in)g(length.)30
b(Single)23 b(page)g(blocks)f(can)i(be)300 3434 y(distinguished)h(from)
h(multi-page)g(blocks)g(by)h(the)g(sign)f(bit)g(on)h(their)g(reference)
i(count.)36 b(If)28 b(the)f(v)n(alue)300 3584 y(is)d(positi)n(v)o(e,)e
(then)i(it)g(is)h(a)f(single)g(page)h(block.)30 b(If)25
b(the)f(v)n(alue)g(is)g(ne)o(gati)n(v)o(e,)e(then)j(there)f(is)g(a)h
(multi-page)300 3733 y(block,)g(and)h(the)f(length)g(of)h(the)f(block)g
(is)g(the)h(follo)n(wing)d(v)n(alue.)33 b(There)26 b(is)f(one)g(more)h
(problem:)31 b(ho)n(w)300 3882 y(to)e(handle)g(blocks)f(whose)h
(reference)i(count)e(is)f(zero.)45 b(Since)30 b(zero)f(is)g(neither)g
(ne)o(gati)n(v)o(e)e(or)i(positi)n(v)o(e)300 4032 y(it)35
b(is)h(impossible)e(to)h(tell)h(the)g(length)f(of)h(the)g(block.)63
b(This)35 b(issue)h(is)f(addressed)h(by)g(of)n(fsetting)e(all)300
4181 y(reference)25 b(counts)d(by)h(one.)30 b(Thus,)23
b(the)g(reference)i(count)d(and)i(length)e(of)h(a)h(block)e(can)i(be)f
(found)g(with)300 4331 y(the)i(code)g(sho)n(wn)e(in)i(Figure)g(4.11.)30
b(An)24 b(e)o(xample)g(of)h(this)f(encoding)g(is)h(sho)n(wn)e(in)i
(Figure)g(4.12.)583 4480 y(An)38 b(attracti)n(v)o(e)f(feature)i(of)f
(this)f(original)g(scheme)h(is)f(that)h(its)f(processing)g(cost)h
(starts)f(of)n(f)300 4629 y(small)29 b(and)h(only)f(rises)h(as)g(the)g
(amap)g(is)g(brok)o(en)g(into)f(smaller)g(chunks.)46
b(Processes)31 b(that)e(do)h(not)f(do)300 4779 y(an)o(y)22
b(partial)h(unmaps)f(will)g(not)g(ha)n(v)o(e)h(an)o(y)f(per)n(-page)i
(reference)g(count)f(arrays)g(acti)n(v)o(e.)29 b(Processes)24
b(that)300 4928 y(only)f(do)g(a)h(fe)n(w)g(partial)f(unmaps)f(will)h
(ha)n(v)o(e)g(only)g(a)h(fe)n(w)g(chunks)f(in)g(their)g(per)n(-page)h
(reference)i(count)300 5078 y(array)-6 b(.)p eop
%%Page: 85 105
85 104 bop 3800 100 a Fs(85)1129 1596 y @beginspecial
0 @llx 0 @lly 333 @urx 248 @ury 2331 @rwi @setspecial
%%BeginDocument: ../figures/amap_pp3.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-48.0 271.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4552 m 0 0 l 6374 0 l 6374 4552 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
5100 600 m
gs 1 -1 sc (per-page refs) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 1830 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 2160 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 2490 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 2820 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 3150 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 3480 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 3810 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 4140 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 4470 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 1500 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 1830 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 2160 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 2490 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 2820 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 3150 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 3480 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 3810 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 4140 m
gs 1 -1 sc (0) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 4470 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1800 900 m
gs 1 -1 sc (per-page refs) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 1200 m
gs 1 -1 sc (before) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2250 1200 m
gs 1 -1 sc (after) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 1500 m
gs 1 -1 sc (1/10) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 1830 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 2160 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 900 m
gs 1 -1 sc (before) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 1200 m
gs 1 -1 sc (\(ref/len\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 2490 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 2820 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 3150 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 3480 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 3810 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 4140 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4350 4470 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 900 m
gs 1 -1 sc (after) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 1200 m
gs 1 -1 sc (\(ref/len\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 1500 m
gs 1 -1 sc (1/1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 1830 m
gs 1 -1 sc (0/8) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 2160 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 2490 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 2820 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 3150 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 3480 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 4140 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 3810 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5850 4470 m
gs 1 -1 sc (1/1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1350 1500 m
gs 1 -1 sc (1) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1800 a(Figure)20 b(4.10:)28 b(Per)n(-page)21
b(reference)h(counters)d(with)g(length.)29 b(The)20 b(symbol)e
(\223x\224)i(means)g(that)g(this)f(v)n(alue)300 1920
y(does)25 b(not)f(matter)-5 b(.)300 2195 y Fm(if)59 b(\(am_ppref[x])e
(>)j(0\))f({)539 2315 y(reference_count)e(=)i(am_ppref[x])e(-)j(1;)539
2435 y(length)f(=)g(1;)300 2556 y(})h(else)e({)539 2676
y(reference_count)f(=)i(-am_ppref[x])e(-)j(1;)539 2797
y(length)f(=)g(am_ppref[x)f(+)h(1];)300 2917 y(})793
3120 y Fs(Figure)25 b(4.11:)30 b(Code)c(to)e(\002nd)h(the)g(per)n
(-page)g(reference)h(count)f(and)f(length)300 3516 y
Fg(4.4)143 b(Accessing)33 b(Anonymous)h(Backing)g(Stor)m(e)300
3768 y Fs(In)39 b(the)f(BSD)i(VM)e(system)g(a)h Fm(vm)p
1539 3768 30 4 v 35 w(pager)f Fs(data)h(structure)f(is)g(allocated)h
(and)f(assigned)g(to)h(e)n(v)o(ery)300 3917 y Fm(vm)p
426 3917 V 35 w(object)c Fs(that)f(accesses)i(backing)f(store.)62
b(Anon)o(ymous)33 b(memory)i(in)g(the)g(BSD)h(VM)f(system)300
4067 y(li)n(v)o(es)20 b(in)h Fm(vm)p 731 4067 V 35 w(object)f
Fs(structures)h(whose)g(pager)h(is)f(associated)g(with)g(the)g(system)f
(sw)o(ap)i(area.)30 b(Often)300 4216 y(these)25 b Fm(vm)p
656 4216 V 36 w(object)f Fs(structures)h(are)i(shado)n(w)d(or)i(cop)o
(y)f(objects.)33 b(The)26 b(location)e(of)i(backing)f(store)g(to)300
4366 y(which)k(anon)o(ymous)f(memory)h(can)h(be)g(paged)g(out)f(is)g
(accessed)i(through)d(the)i(object')-5 b(s)29 b Fm(vm)p
3572 4366 V 35 w(pager)300 4515 y Fs(structure.)39 b(The)28
b Fm(vm)p 1022 4515 V 35 w(pager)f Fs(structure)h(points)e(of)n(f)i(to)
f(another)h(structure)f(for)h(the)g(sw)o(ap)f(pager)i(that)300
4664 y(translates)35 b(object)g(of)n(fsets)g(into)g(a)h(location)f(on)h
(sw)o(ap.)63 b(Because)37 b(each)f(page)g(in)f(the)h(VM)f(system)300
4814 y(can)26 b(only)f(belong)g(to)h(one)g Fm(vm)p 1364
4814 V 35 w(object)f Fs(it)g(is)g(easy)h(to)g(access)g(backing)f(store)
h(for)g(that)f(page)h(by)g(just)300 4963 y(follo)n(wing)d(the)i
Fm(vm)p 983 4963 V 35 w(object)p Fs(')-5 b(s)23 b(pager)i(pointer)-5
b(.)583 5113 y(W)l(ith)25 b(UVM')-5 b(s)25 b(amap-based)g(anon)o(ymous)
f(memory)h(things)f(change.)33 b(An)25 b(anon)o(ymous)f(page)300
5262 y(of)30 b(memory)f(can)h(belong)f(either)h(to)f(an)h(aobj)f
Fm(uvm)p 2119 5262 V 35 w(object)g Fs(or)h(to)f(an)h(anon.)45
b(Accessing)30 b(backing)p eop
%%Page: 86 106
86 105 bop 3800 100 a Fs(86)1132 1596 y @beginspecial
0 @llx 0 @lly 332 @urx 248 @ury 2324 @rwi @setspecial
%%BeginDocument: ../figures/amap_pp5.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-47.0 271.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4552 m 0 0 l 6349 0 l 6349 4552 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
2025 600 m
gs 1 -1 sc (per-page refs) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 1830 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 2160 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 900 m
gs 1 -1 sc (before) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 1200 m
gs 1 -1 sc (\(ref/len\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 2490 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 2820 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 3150 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 3480 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 3810 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 4140 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 4470 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 1200 m
gs 1 -1 sc (\(ref/len\)) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 900 m
gs 1 -1 sc (after) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 1500 m
gs 1 -1 sc (1/1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 1830 m
gs 1 -1 sc (0/8) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 2160 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 2490 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 2820 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 3150 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 3480 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 4140 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 3810 m
gs 1 -1 sc (x/x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2775 4470 m
gs 1 -1 sc (1/1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5325 900 m
gs 1 -1 sc (per-page refs) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 1200 m
gs 1 -1 sc (before) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 1200 m
gs 1 -1 sc (after) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
5325 600 m
gs 1 -1 sc (encoded) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 1500 m
gs 1 -1 sc (-2) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 1830 m
gs 1 -1 sc (10) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 2160 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 2490 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 2820 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 3150 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 3480 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 3810 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 4140 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 4470 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 1500 m
gs 1 -1 sc (2) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 1830 m
gs 1 -1 sc (-1) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 2160 m
gs 1 -1 sc (8) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 2490 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 2820 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 3150 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 3480 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 3810 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 4140 m
gs 1 -1 sc (x) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
5775 4470 m
gs 1 -1 sc (2) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1275 1500 m
gs 1 -1 sc (1/10) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1045 1800 a(Figure)25 b(4.12:)30 b(Encoded)25
b(per)n(-page)g(reference)i(count)d(array)300 2195 y(store)31
b(for)g(an)g(aobj-based)f(anon)o(ymous)f(page)i(of)g(memory)f(is)g
(done)h(through)f(the)h Fm(uvm)p 3446 2195 30 4 v 35
w(object)p Fs(')-5 b(s)300 2344 y(pager)27 b(operations)f(pointer)-5
b(.)35 b(This)26 b(will)g(not)g(w)o(ork)h(for)g(an)g(anon)f(because)h
(it)g(is)f(not)g(a)h Fm(uvm)p 3512 2344 V 35 w(object)300
2493 y Fs(and)g(thus)f(does)h(not)f(ha)n(v)o(e)h(a)g(pager)g
(operations)f(pointer)-5 b(.)36 b(Since)28 b(each)f(anon)g(is)g(back)o
(ed)g(by)f(the)h(sw)o(ap)300 2643 y(area,)32 b(there)e(is)f(no)g(need)h
(for)g(such)f(a)h(pointer)-5 b(.)44 b(Ho)n(we)n(v)o(er)l(,)29
b(there)h(still)e(needs)i(to)f(be)h(a)g(w)o(ay)f(to)h(map)f(a)300
2792 y(paged-out)e(anon)g(to)g(its)g(data)g(on)g(backing)g(store.)38
b(In)28 b(the)f(SunOS4)h(VM,)f(this)f(is)h(done)g(by)g(statically)300
2942 y(assigning)i(a)h(page-sized)h(block)f(of)g(sw)o(ap)g(to)g(each)h
(anon.)47 b(There)31 b(are)g(se)n(v)o(eral)e(problems)h(with)f(this)300
3091 y(scheme.)50 b(First,)32 b(it)f(forces)g(the)g(system')-5
b(s)30 b(sw)o(ap)h(size)g(to)g(be)g(greater)h(than)f(or)g(equal)g(to)g
(the)g(the)g(size)300 3240 y(of)36 b(physical)f(memory)h(so)g(that)g
(each)g(anon)g(allocated)h(at)f(boot-time)f(has)h(a)g(location)g(to)g
(which)g(it)300 3390 y(can)30 b(be)g(sw)o(apped)f(out)g(\(this)f
(problem)h(w)o(as)h(later)f(addressed)h(in)f(Solaris)g([13]\).)45
b(Second,)31 b(the)f(static)300 3539 y(allocation)25
b(of)h(anon)g(to)g(sw)o(ap)g(area)h(mak)o(es)e(it)h(hard)g(to)g
(cluster)g(anon)o(ymous)e(memory)h(pageouts)g(and)300
3689 y(thus)f(anon)o(ymous)f(memory)h(pageout)g(tak)o(es)h(longer)-5
b(.)583 3838 y(Rather)25 b(than)f(statically)f(assigning)g(a)h(sw)o(ap)
g(block)g(to)g(each)g(anon,)g(in)g(UVM)g(the)g(assignment)300
3987 y(of)d(a)h(sw)o(ap)f(block)g(to)g(an)h(anon)f(is)g(done)g(by)g
(the)g(pagedaemon)g(at)g(pageout)g(time.)29 b(The)22
b(sw)o(apping)e(layer)300 4137 y(of)k(the)g(VM)f(system)g(presents)g
(sw)o(ap)h(to)g(the)f(rest)h(of)g(the)g(k)o(ernel)g(as)g(a)g(big)f
(\223\002le.)-7 b(\224)32 b(This)23 b(\002le,)h(kno)n(wn)f(as)300
4286 y(the)29 b(\223drum,)-7 b(\224)30 b(can)g(be)f(accessed)h(by)e
(the)h(root)g(user)g(via)g(the)g(de)n(vice)g(\002le)h
Fm(/dev/drum)p Fs(.)41 b(Internal)29 b(to)300 4436 y(the)h(sw)o(ap)g
(layer)g(of)h(the)f(VM,)f(the)h(drum)g(might)f(be)h(interlea)n(v)o(ed)f
(across)i(se)n(v)o(eral)e(dif)n(ferent)h(de)n(vices)300
4585 y(or)f(netw)o(ork)g(\002les.)44 b(T)-8 b(o)28 b(most)g(of)i(UVM)e
(the)h(drum)g(is)f(simply)g(a)h(lar)n(ge)h(array)f(of)h(page-sized)f
(chunks)300 4734 y(of)i(disk.)48 b(Each)32 b(page-sized)f(chunk)f(of)h
(sw)o(ap)g(is)f(assigned)h(a)g(\223slot\224)f(number)-5
b(.)48 b(When)31 b(an)g(anon)g(has)300 4884 y(backing)g(store)h
(assigned)f(to)g(it,)i(it)f(sa)n(v)o(es)f(the)g(slot)g(number)g(in)h
(its)f Fm(an)p 2830 4884 V 35 w(swslot)g Fs(\002eld.)52
b(Sw)o(ap)32 b(slot)300 5033 y(number)24 b(zero)i(is)e(reserv)o(ed:)30
b(it)25 b(means)f(that)h(a)g(backing)f(store)h(has)f(not)h(been)g
(assigned)f(to)g(an)h(anon.)p eop
%%Page: 87 107
87 106 bop 3800 100 a Fs(87)583 249 y(The)25 b(data)g(in)g(an)g(anon)f
(can)h(be)g(in)g(one)f(of)h(three)g(possible)f(states:)300
481 y Fo(r)n(esident)i(with)f(no)g(backing)h(stor)n(e)f(slot)g
(assigned:)49 b Fs(In)36 b(this)g(case)i(the)e(anon')-5
b(s)36 b Fm(an)p 3312 481 30 4 v 36 w(page)g Fs(pointer)544
631 y(points)25 b(to)h(the)h(page)f(in)g(which)h(the)f(anon')-5
b(s)26 b(data)g(resides.)36 b(The)26 b(anon')-5 b(s)26
b Fm(an)p 3215 631 V 36 w(swslot)f Fs(\002eld)i(is)544
780 y(zero)h(indicating)f(that)g(no)h(sw)o(ap)g(slot)f(has)g(yet)h
(been)g(assigned)f(to)h(this)f(anon.)40 b(All)27 b(anons)g(start)544
930 y(in)d(this)g(state.)300 1162 y Fo(non-r)n(esident:)51
b Fs(An)25 b(anon)g(can)h(be)f(in)g(this)g(state)g(if)g(a)h(sw)o(ap)f
(slot)f(w)o(as)i(allocated)f(for)g(it,)g(its)g(page)g(w)o(as)544
1311 y(paged)j(out)f(to)g(its)g(area)i(of)e(the)h(drum,)g(and)f(then)h
(its)f(page)h(w)o(as)f(freed.)40 b(In)28 b(this)f(state)g(the)h(page)
544 1461 y(pointer)h(will)h(be)g(null)f(and)i(the)f(sw)o(ap)g(slot)f
(number)h(will)f(be)h(non-zero.)47 b(An)30 b(anon)g(can)h(enter)544
1610 y(this)24 b(state)g(from)h(either)g(of)f(the)h(other)g(tw)o(o)f
(states.)300 1843 y Fo(r)n(esident)i(with)f(backing)h(stor)n(e)f(slot)g
(assigned:)48 b Fs(An)30 b(anon)g(enters)g(this)f(state)h(if)f(it)h(w)o
(as)g(pre)n(viously)544 1992 y(non-resident)h(and)g(its)g(data)g(w)o
(as)h(paged)f(in)g(from)h(backing)f(store.)50 b(In)32
b(this)e(case)i(it)f(has)h(both)544 2141 y(a)j(page)f(pointer)g(and)g
(a)h(sw)o(ap)f(slot)f(assigned.)59 b(As)34 b(long)g(as)g(the)g(data)h
(in)f(the)g(resident)g(page)544 2291 y(remains)24 b(unmodi\002ed)g(the)
h(data)g(on)f(backing)g(store)h(is)f(v)n(alid.)300 2523
y(Note)h(that)g(in)f(UVM)h(it)g(is)g(not)f(possible)g(to)h(ha)n(v)o(e)g
(an)g(anon)g(that)g(has)g(neither)g(a)g(page)g(nor)h(a)f(sw)o(ap)g
(slot)300 2672 y(assigned)f(to)g(it.)300 3056 y Fg(4.5)143
b(The)35 b(Effects)f(of)h(Amaps)f(on)i(P)o(ages)e(and)h(Objects)300
3308 y Fs(Con)l(v)o(erting)30 b(BSD)i(to)f(use)g(amap-based)g(anon)o
(ymous)e(memory)h(is)h(a)g(major)g(change)g(that)g(ef)n(fects)g(a)300
3458 y(number)23 b(of)g(other)h(parts)f(of)g(the)h(VM)f(system.)29
b(In)23 b(this)g(section)g(we)g(describe)h(the)f(ef)n(fect)h(of)f
(amaps)g(on)300 3607 y(pages)i(and)g(objects.)30 b(In)25
b(the)g(follo)n(wing)e(section)h(we)h(describe)g(the)g(ef)n(fect)h(of)f
(amaps)f(on)h(forking)f(and)300 3757 y(cop)o(y-on-write.)583
3906 y(In)39 b(the)f(BSD)h(VM)f(system,)j(each)e(allocated)f(page)g(of)
h(memory)e(can)i(belong)e(to)h(a)h(single)300 4055 y
Fm(vm)p 426 4055 V 35 w(object)26 b Fs(structure)g(at)g(a)h
(speci\002ed)g(of)n(fset.)35 b(If)27 b(the)g(k)o(ernel)f(w)o(ants)g(to)
g(perform)h(an)f(operation)g(on)300 4205 y(the)k(object)f(in)h(which)g
(a)g(page)g(belongs)f(then)h(it)g(uses)f(the)h(object)g(pointer)f(in)h
(the)g(page)g(structure)f(to)300 4354 y(lock)24 b(the)h(object,)f
(perform)h(the)g(operation,)f(and)h(then)f(unlock)g(the)h(object)f
(when)h(done.)583 4504 y(In)34 b(UVM)f(things)g(are)h(not)f(that)g
(simple.)56 b(In)34 b(addition)e(to)i(belonging)e(to)h(a)h
Fm(uvm)p 3487 4504 V 35 w(object)p Fs(,)300 4653 y(pages)d(can)g(also)g
(belong)f(to)g(an)h(anon)g(structure.)49 b(The)31 b(anon)f(structure)h
(is)f(lik)o(ely)g(to)h(be)g(referenced)300 4802 y(by)26
b(one)g(or)g(more)g(amaps.)35 b(This)25 b(means)h(that)g(if)g(the)g(k)o
(ernel)h(w)o(ants)e(to)h(perform)g(an)h(operation)e(on)h(the)300
4952 y(memory)g(object)h(that)f(a)i(page)f(belongs)f(to)h(it)f(must)g
(\002rst)h(decide)h(whether)f(that)f(memory)h(object)f(is)h(a)300
5101 y Fm(uvm)p 486 5101 V 35 w(object)j Fs(or)h(an)g(anon.)48
b(Making)30 b(this)g(decision)g(is)g(quite)g(easy)h(to)f(do:)43
b(there)31 b(is)f(a)h(\003ag)g(bit)f(in)300 5251 y(the)e(page)h
(structure)f(called)g Fm(PG)p 1436 5251 V 35 w(ANON)g
Fs(that)g(is)g(true)g(if)g(the)g(page)h(is)f(part)g(of)h(an)f(anon)g
(structure)g(and)300 5400 y(f)o(alse)e(otherwise.)31
b(The)25 b(issue)g(of)h(determining)d(the)j(o)n(wner)e(of)i(a)f(page)h
(is)f(of)g(importance)g(to)g(the)g(page)p eop
%%Page: 88 108
88 107 bop 3800 100 a Fs(88)300 249 y(daemon)26 b(since)h(it)f(starts)h
(at)g(the)f(page)h(queues,)h(\002nds)e(a)i Fm(vm)p 2404
249 30 4 v 35 w(page)e Fs(structure)h(that)f(it)g(w)o(ants)h(to)f(w)o
(ork)300 398 y(on)g(and)g(then)g(tries)f(to)h(lock)g(the)g(data)g
(structure)g(that)f(that)h(page)g(belongs)g(to.)34 b(The)26
b(daemon)f(needs)h(to)300 548 y(kno)n(w)e(if)h(it)f(is)g(locking)g(an)h
(anon)g(or)f(a)i Fm(uvm)p 1826 548 V 35 w(object)p Fs(.)583
697 y(In)g(UVM,)e(it)h(w)o(ould)g(be)g(possible)f(to)h(eliminate)f(the)
h(distinction)e(between)i(pages)g(belonging)300 847 y(to)d
Fm(uvm)p 586 847 V 35 w(object)p Fs(s)f(and)h(pages)h(belonging)e(to)h
(anons)f(by)i(simply)d(con)l(v)o(erting)h(each)i(anon)f(into)g(a)h
(sin-)300 996 y(gle)j(page)g Fm(uvm)p 848 996 V 35 w(object)f
Fs(structure.)33 b(Ho)n(we)n(v)o(er)l(,)25 b(this)g(has)g(a)i(major)e
(dra)o(wback:)32 b(the)26 b Fm(uvm)p 3512 996 V 35 w(object)300
1145 y Fs(structure)37 b(is)f(much)g(lar)n(ger)i(than)e(the)h(anon)g
(structure)f(and)h(has)g(\002elds)g(in)f(it)h(that)f(are)i(not)e
(needed)300 1295 y(by)31 b(anon)f(pages.)49 b(Since)31
b(the)g(system)e(typically)h(has)g(a)i(much)e(lar)n(ger)h(number)f(of)h
(anon')-5 b(s)30 b(allocated)300 1444 y(than)h Fm(uvm)p
689 1444 V 36 w(object)p Fs(s,)h(it)f(w)o(ould)g(be)h(a)g(great)g(w)o
(aste)g(of)g(k)o(ernel)g(memory)f(to)g(con)l(v)o(ert)h(all)f(anons)g
(to)300 1594 y Fm(uvm)p 486 1594 V 35 w(object)p Fs(s.)300
1977 y Fg(4.6)143 b(The)35 b(Effect)f(of)h(Amaps)g(on)g(F)l(orking)g
(and)g(Copy-on-write)300 2230 y Fs(This)29 b(section)h(describes)g(the)
g(ef)n(fects)g(of)h(amaps)e(on)h(BSD')-5 b(s)31 b(forking)e(and)i(cop)o
(y-on-write)e(process.)300 2379 y(First,)h(a)g(description)f(of)g(cop)o
(y-on-write)g(is)g(presented.)45 b(Then)29 b(the)h(ef)n(fect)g(of)f
(Mach-style)g(memory)300 2528 y(inheritance)c(on)f(amaps)h(is)f
(discussed.)300 2860 y Ff(4.6.1)119 b(Copy-on-write)300
3076 y Fs(As)20 b(pre)n(viously)e(described)i(in)f(Chapter)i(3,)g(a)f
(process')g(virtual)f(address)h(space)g(is)g(described)f(by)h(a)g(map)
300 3226 y(structure.)50 b(Each)32 b(mapped)f(re)o(gion)f(in)h(the)g
(address)g(space)h(is)f(described)g(by)g(map)g(entry)h(structures)300
3375 y(that)f(are)h(k)o(ept)f(in)g(a)g(sorted)g(link)o(ed)g(list)f(of)n
(f)h(the)g(map.)50 b(Each)31 b(map)g(entry)g(maps)g(tw)o(o)g(le)n(v)o
(els:)42 b(a)32 b(top-)300 3524 y(le)n(v)o(el)g(anon)o(ymous)f(amap)j
(layer)l(,)h(and)e(a)h(bottom-le)n(v)o(el)d(backing)h(object)h(layer)-5
b(.)56 b(Either)33 b(or)g(both)g(of)300 3674 y(these)d(layers)f(can)i
(be)e(null.)45 b(F)o(or)30 b(cop)o(y-on-write)f(mappings,)h(all)f(cop)o
(y-on-write)g(anon)o(ymous)f(data)300 3823 y(is)22 b(stored)h(in)g(the)
f(amap)h(layer)-5 b(.)30 b(Each)23 b(map)g(entry)f(describes)h(the)g
(attrib)n(utes)f(of)h(the)g(mapping)e(it)i(maps.)300
3973 y(W)l(ith)g(respect)h(to)g(cop)o(y-on-write,)g(there)g(are)g(tw)o
(o)g(important)e(boolean)i(attrib)n(utes)f(in)g(the)h(map)g(entry:)300
4205 y Fo(copy-on-write:)50 b Fs(If)23 b(cop)o(y-on-write)f(is)g(true,)
g(then)g(it)g(indicates)g(that)g(the)g(mapped)g(re)o(gion)g(is)f(a)i
(cop)o(y-)544 4354 y(on-write)28 b(mapping)f(and)h(that)f(all)h
(changes)g(made)g(to)g(data)g(in)g(the)g(mapping)f(should)g(be)h(done)
544 4504 y(in)21 b(anon)o(ymous)e(memory)-6 b(.)29 b(If)21
b(cop)o(y-on-write)g(is)g(f)o(alse,)h(then)f(that)g(indicates)g(that)g
(the)g(mapping)544 4653 y(is)i(a)i(shared)f(mapping)e(and)i(that)g(all)
f(changes)h(should)f(be)h(made)g(directly)f(to)h(the)g(object)f(that)h
(is)544 4803 y(mapped.)300 5035 y Fo(needs-copy:)50 b
Fs(If)33 b(needs-cop)o(y)f(is)f(true,)j(then)d(it)h(indicates)f(that)h
(this)f(re)o(gion)g(of)h(memory)f(needs)h(its)544 5184
y(o)n(wn)c(pri)n(v)n(ate)g(amap,)j(b)n(ut)d(it)h(has)g(not)g(been)g
(allocated)g(yet.)44 b(The)29 b(re)o(gion)g(either)g(has)g(no)g(amap)
544 5334 y(at)h(all,)h(or)f(it)g(has)g(a)g(reference)i(to)d(an)h(amap)g
(that)g(it)f(needs)h(to)g(cop)o(y)g(on)g(the)g(\002rst)g(write)g(to)f
(the)p eop
%%Page: 89 109
89 108 bop 3800 100 a Fs(89)544 249 y(re)o(gion.)40 b(The)28
b(needs-cop)o(y)g(\003ag)h(allo)n(ws)e(UVM)h(to)f(defer)i(the)f
(creation)h(of)f(an)g(amap)g(until)f(the)544 398 y(\002rst)22
b(memory)g(write)g(occurs.)30 b(The)22 b(needs-cop)o(y)g(\003ag)h(is)f
(used)g(for)g(cop)o(y-on-write)g(operations.)583 631
y(As)34 b(an)f(e)o(xample,)h(consider)f(the)g(data)h(area)g(of)f(a)h
(process')f(address)h(space.)56 b(As)33 b(e)o(xplained)300
780 y(earlier)23 b(in)f(Section)g(2.2,)h(the)f(data)g(area)i(of)e(a)h
(process)f(is)g(mapped)g(read-write)h(cop)o(y-on-write.)29
b(When)300 930 y(this)22 b(mapping)g(is)h(established)f(both)h(its)f
(cop)o(y-on-write)h(and)g(needs-cop)o(y)g(\003ags)h(are)g(set)f(to)g
(true.)30 b(The)300 1079 y(mapping')-5 b(s)20 b(amap)i(reference)i
(\(aref\))f(is)f(set)g(to)f(null)h(to)f(indicate)h(that)g(no)f(amap)h
(has)g(been)h(created)f(yet.)300 1228 y(The)g(cop)o(y-on-write)g
(\003ag)h(will)e(remain)h(true)h(for)f(the)g(lifetime)g(of)g(the)g
(mapping)f(\(it)h(is)g(not)g(possible)e(to)300 1378 y(change)26
b(the)g(cop)o(y-on-write)f(status)g(of)h(an)g(e)o(xisting)e(mapping\).)
33 b(The)25 b(needs-cop)o(y)h(\003ag)g(will)f(remain)300
1527 y(true)h(until)e(the)i(\002rst)f(write)h(to)f(the)h(mapped)f(area)
h(occurs.)34 b(At)25 b(that)g(point)g(the)g Fm(amap)p
3274 1527 30 4 v 35 w(copy)g Fs(function)300 1677 y(will)32
b(be)h(called)f(to)h(cop)o(y)f(the)g(amap.)55 b(The)32
b Fm(amap)p 2104 1677 V 35 w(copy)g Fs(function)g(allocates)g(a)h(ne)n
(w)g(amap)f(struc-)300 1826 y(ture,)h(attaches)e(it)g(to)g(the)g(map)h
(entry)-6 b(,)32 b(and)f(then)g(clears)h(the)f(needs-cop)o(y)g(\003ag.)
51 b(Note)32 b(that)f(zero-\002ll)300 1975 y(mappings)d(are)h(handled)g
(in)f(a)i(similar)e(w)o(ay:)38 b(the)o(y)29 b(are)g(established)f(with)
g(both)h(cop)o(y-on-write)f(and)300 2125 y(needs-cop)o(y)h(true.)44
b(The)29 b(dif)n(ference)h(between)f(a)h(zero-\002ll)f(mapping)f(and)i
(the)f(cop)o(y-on-write)f(map-)300 2274 y(ping)g(of)i(a)f(program')-5
b(s)28 b(data)i(area)g(is)f(that)f(the)h(zero-\002ll)h(area)g(has)f(a)h
(null)e(backing)h(object,)g(where)h(as)300 2424 y(the)25
b(data)g(area)g(has)g(a)g(\002le)g(as)g(a)g(backing)g(object.)583
2573 y(When)f(data)g(is)g(written)f(to)h(a)g(cop)o(y-on-write)f(area,)i
(an)f(anon)g(with)f(a)h(reference)i(count)d(of)h(one)300
2722 y(is)34 b(allocated)h(in)f(the)h(amap)f(to)h(contain)f(the)h
(data.)60 b(The)35 b(details)f(of)h(ho)n(w)f(anons)g(are)i(inserted)e
(into)300 2872 y(amaps)24 b(during)g(a)i(cop)o(y-on-write)e(operation)g
(are)i(presented)e(in)h(Chapter)g(5.)583 3021 y(The)e(reference)i
(count)d(of)i(an)f(anon)f(is)h(important)e(in)i(determining)e(its)i
(cop)o(y-on-write)f(status.)300 3171 y(If)j(the)g(reference)h(count)e
(is)g(one,)h(then)f(it)g(means)h(that)f(only)g(one)g(amap)h(is)f(using)
g(the)g(anon)h(and)f(that)h(it)300 3320 y(is)j(safe)h(to)e(write)i
(directly)e(to)h(the)g(anon')-5 b(s)28 b(data.)41 b(Ho)n(we)n(v)o(er)l
(,)28 b(if)g(the)g(reference)i(count)e(is)g(greater)g(than)300
3469 y(one)d(then)f(on)h(a)g(write)g(a)g(cop)o(y-on-write)f(operation)g
(must)g(be)h(performed.)31 b(This)24 b(is)g(done)g(as)h(follo)n(ws:)420
3702 y(1.)49 b(A)25 b(ne)n(w)f(anon)h(is)f(allocated,)g(the)h(ne)n(w)g
(anon')-5 b(s)24 b(reference)i(count)e(is)h(one.)420
3934 y(2.)49 b(A)29 b(ne)n(w)f(page)h(is)f(allocated)g(and)h(the)g
(data)f(is)g(copied)h(from)f(the)h(old)f(anon')-5 b(s)28
b(page)h(to)f(the)h(ne)n(w)544 4084 y(anon')-5 b(s)24
b(page)420 4316 y(3.)49 b(The)27 b(old)f(anon')-5 b(s)26
b(reference)i(counter)f(is)f(dropped)h(by)f(one)h(and)g(the)g(ne)n(w)f
(anon)h(is)f(installed)f(in)544 4465 y(the)g(current)g(amap.)420
4698 y(4.)49 b(The)25 b(cop)o(y-on-write)f(operation)g(is)h(complete)f
(and)g(the)h(write)g(can)g(proceed)g(as)g(normal.)300
4930 y(Thus,)h(data)h(in)f(an)h(anon)f(can)h(only)f(be)h(changed)f(if)h
(its)f(reference)i(count)e(is)g(one.)36 b(Note)26 b(that)h(the)f(pro-)
300 5080 y(cedure)i(described)g(abo)o(v)o(e)f(is)g(incomplete)f
(because)i(it)g(does)f(not)g(tak)o(e)h(into)f(account)g(the)h
(possibility)300 5229 y(that)22 b(the)g(system)f(is)g(out)h(of)g
(memory)-6 b(.)29 b(If)22 b(the)g(system)f(is)h(out)f(of)i(virtual)e
(memory)-6 b(,)21 b(then)h(the)g(allocation)300 5378
y(of)31 b(the)f(ne)n(w)g(anon)h(will)e(f)o(ail.)48 b(This)30
b(can)h(happen)f(if)h(all)f(of)h(the)f(system')-5 b(s)29
b(sw)o(ap)h(space)h(is)f(allocated.)p eop
%%Page: 90 110
90 109 bop 3800 100 a Fs(90)300 249 y(T)-8 b(o)25 b(reco)o(v)o(er)f
(from)h(this,)f(the)h(process)f(can)i(either)f(w)o(ait)f(in)h(hopes)f
(that)g(some)h(other)f(process)h(will)f(free)300 398
y(some)f(memory)-6 b(,)22 b(or)h(it)g(can)g(be)h(killed.)29
b(Currently)23 b(in)g(UVM)g(the)g(process)g(is)f(killed,)h(ho)n(we)n(v)
o(er)l(,)f(further)300 548 y(w)o(ork)31 b(to)f(\002nd)h(a)g(better)f
(solution)f(might)h(be)g(useful.)48 b(On)31 b(the)f(other)h(hand,)h(if)
f(the)f(system)g(is)g(out)g(of)300 697 y(physical)j(memory)g(then)g
(the)h(allocation)f(of)h(the)g(ne)n(w)g(page)g(will)f(f)o(ail.)58
b(In)35 b(this)e(case,)j(the)e(process)300 847 y(must)e(drop)h(all)g
(its)f(locks)h(and)g(w)o(ak)o(e)h(up)f(the)g(pagedaemon.)55
b(The)34 b(pagedaemon)e(will)h(\(hopefully\))300 996
y(free)26 b(some)e(pages)h(by)f(doing)g(some)g(pageouts)g(and)h(then)g
(w)o(ak)o(e)g(the)f(process)h(back)g(up.)583 1145 y(This)g(is)f(the)h
(basics)f(of)h(ho)n(w)f(cop)o(y-on-write)g(w)o(orks)h(in)f(UVM.)h(Note)
f(that)h(amaps)f(combined)300 1295 y(with)d(the)h(anon')-5
b(s)21 b(reference)j(counter)e(perform)f(the)h(same)g(role)g(in)g(cop)o
(y-on-write)f(that)h(object)f(chain-)300 1444 y(ing)32
b(does)g(in)g(BSD)h(VM.)e(Ho)n(we)n(v)o(er)l(,)i(UVM')-5
b(s)32 b(amap-based)g(scheme)g(is)g(simpler)f(than)h(BSD)h(VM')-5
b(s)300 1594 y(object)34 b(chaining)f(scheme)h(because)h(it)e(requires)
i(only)e(a)h(tw)o(o-le)n(v)o(el)f(lookup)g(rather)i(than)e(a)i(tra)n(v)
o(er)n(-)300 1743 y(sal)30 b(of)g(an)f(object)h(chain)g(of)g(arbitrary)
f(length,)i(and)e(it)h(does)f(not)h(require)g(comple)o(x)e(object)i
(collapse)300 1892 y(schemes)21 b(or)h(leak)g(sw)o(ap)g(memory)-6
b(.)28 b(In)22 b(the)g(ne)o(xt)f(section)g(the)h(details)f(of)h(cop)o
(y-on-write)f(with)g(respect)300 2042 y(to)j(forking)h(are)g
(described.)300 2373 y Ff(4.6.2)119 b(F)m(orking)300
2590 y Fs(When)39 b(a)g(process)f(forks)h(a)g(child)f(process)g(it)g
(must)g(create)i(a)e(ne)n(w)h(address)f(space)h(for)g(the)g(child)300
2739 y(process)32 b(based)f(on)h(the)f(parent)h(process')g(address)f
(space.)52 b(In)32 b(traditional)e(Unix,)j(re)o(gions)e(mapped)300
2888 y(cop)o(y-on-write)c(are)h(cop)o(y-on-write)e(copied)h(to)g(the)g
(child)f(process)i(while)e(re)o(gions)g(mapped)h(shared)300
3038 y(are)32 b(shared)f(with)f(the)h(child)f(process.)50
b(In)31 b(the)g(Mach)g(operating)f(system)g(the)h(forking)f(operation)h
(is)300 3187 y(more)j(comple)o(x)f(because)i(the)f(parent)h(process)f
(has)g(more)g(control)g(o)o(v)o(er)f(the)i(access)f(gi)n(v)o(en)f(to)h
(the)300 3337 y(child)e(process.)54 b(Both)32 b(the)h(BSD)g(VM)g(and)f
(UVM)g(include)g(this)g(feature)h(from)g(Mach.)54 b(Each)32
b(map)300 3486 y(entry)25 b(in)f(a)h(map)g(has)f(an)h(inheritance)g(v)n
(alue.)30 b(The)25 b(inheritance)f(v)n(alue)h(is)f(one)h(of)g(the)f
(follo)n(wing)3698 3450 y Fj(2)3733 3486 y Fs(:)300 3718
y Fo(none:)50 b Fs(An)23 b(inheritance)g(code)g(of)g(\223none\224)h
(indicates)e(that)h(the)g(child)g(process)g(should)f(not)h(get)g
(access)544 3868 y(to)j(the)h(area)h(of)f(memory)f(mapped)h(by)f(the)h
(map)g(entry)-6 b(.)36 b(The)27 b(fork)g(routine)g(processes)f(this)g
(by)544 4017 y(skipping)d(o)o(v)o(er)h(this)g(map)g(entry)h(and)g(mo)o
(ving)e(on)h(to)g(the)h(ne)o(xt)f(one)h(in)f(the)h(list.)300
4250 y Fo(shar)n(e:)50 b Fs(An)23 b(inheritance)h(code)g(of)g
(\223share\224)h(indicates)e(that)h(the)f(parent)h(and)g(child)g
(processes)f(should)544 4399 y(share)31 b(the)g(area)i(of)e(memory)f
(mapped)h(by)g(the)g(map)g(entry)-6 b(.)49 b(This)30
b(means)h(that)g(both)f(the)h(ref-)544 4548 y(erences)f(to)f(an)o(y)g
(amap)g(and)g(backing)g(object)g(mapped)f(should)g(be)i(shared)f
(between)g(the)h(tw)o(o)544 4698 y(processes.)44 b(Note)29
b(that)g(the)g(cop)o(y-on-write)g(\003ag)h(of)f(a)h(mapping)e(in)h(the)
g(child)g(process)g(is)g(al-)544 4847 y(w)o(ays)21 b(the)g(same)g(as)h
(in)f(the)g(parent)g(\(the)h(child)f(can')n(t)g(suddenly)g(get)g
(direct)g(access)h(to)f(a)h(backing)544 4997 y(memory)i(object\).)p
300 5086 1440 4 v 416 5147 a Fi(2)449 5178 y Fh(There)k(is)i(also)f(a)h
(\223donate)d(cop)o(y\224)h(inheritance)f(v)n(alue)h(that)h(does)g(not)
f(appear)g(in)h(Mach)f(b)n(ut)h(is)h(de\002ned)d(\(b)n(ut)i(not)300
5277 y(implemented\))18 b(in)i(BSD)i(VM.)p eop
%%Page: 91 111
91 110 bop 3800 100 a Fs(91)300 249 y Fo(copy:)49 b Fs(An)32
b(inheritance)g(code)h(of)f(\223cop)o(y\224)h(indicates)e(that)h(the)g
(child)g(process)g(should)f(get)i(a)f(cop)o(y-)544 398
y(on-write)e(cop)o(y)h(of)f(the)h(parent')-5 b(s)30 b(map)g(entry)-6
b(.)48 b(First,)32 b(in)e(order)h(to)g(achie)n(v)o(e)f(proper)g(cop)o
(y-on-)544 548 y(write)c(semantics,)g(all)g(resident)g(pages)h(in)f
(the)g(parent')-5 b(s)26 b(mapping)g(are)h(write)f(protected.)36
b(This)544 697 y(ensures)27 b(that)g(a)g(page)h(f)o(ault)f(will)f
(occur)h(the)g(ne)o(xt)g(time)f(the)h(parent)h(attempts)d(to)i(write)g
(to)g(one)544 847 y(of)36 b(the)f(pages.)64 b(As)36 b(part)g(of)g(the)f
(f)o(ault)h(reco)o(v)o(ery)f(procedure,)k(the)d(page)g(f)o(ault)f
(handler)h(will)544 996 y(do)28 b(the)g(cop)o(y-on-write)g(on)h(the)f
(f)o(aulting)f(page.)42 b(Second,)30 b(the)e(child)g(gets)g(a)h
(reference)h(to)e(the)544 1145 y(parent')-5 b(s)23 b(backing)g(object,)
h(if)f(an)o(y)-6 b(.)30 b(Third,)23 b(the)g(child)g(adds)h(a)g
(reference)h(to)e(the)h(parent')-5 b(s)23 b(amap)544
1295 y(\(if)h(an)o(y\))g(and)f(sets)h(the)g(cop)o(y-on-write)f(\003ag.)
31 b(F)o(ourth,)23 b(the)h(needs-cop)o(y)g(\003ag)g(is)g(set)g(in)f
(both)g(the)544 1444 y(parent)g(and)g(child.)30 b(In)23
b(some)g(cases)h(\(described)f(later\))h(the)f(needs-cop)o(y)g(\003ag)h
(must)e(be)h(cleared)544 1594 y(immediately)-6 b(.)300
1815 y(The)25 b(def)o(ault)g(inheritance)f(v)n(alue)g(for)i(a)f(re)o
(gion)f(mapped)g(cop)o(y-on-write)h(is)f(cop)o(y)-6 b(,)24
b(while)h(the)f(def)o(ault)300 1964 y(inheritance)h(v)n(alue)f(for)h(a)
g(re)o(gion)f(mapped)h(shared)g(is)f(share.)32 b(Thus,)24
b(the)h(def)o(ault)f(beha)n(vior)h(emulates)300 2113
y(traditional)e(Unix.)29 b(Ho)n(we)n(v)o(er)l(,)23 b(it)g(is)h
(possible)e(for)i(a)g(process)g(to)g(change)g(the)f(inheritance)h
(attrib)n(ute)f(of)300 2263 y(a)i(re)o(gion)f(of)h(memory)f(by)g(using)
g(the)h Fm(minherit)e Fs(system)h(call.)583 2412 y(Note)j(that)f(in)g
(share)h(inheritance)f(the)h(amap)f(structure)h(can)g(be)f(shared)h
(between)g(mappings.)300 2562 y(When)39 b(this)f(happens)h(a)h(special)
f(\223shared\224)h(\003ag)f(is)g(set)g(in)g(the)g(amap)g(structure)g
(to)g(indicate)g(that)300 2711 y(the)g(amap)g(is)f(being)g(shared.)73
b(When)39 b(the)g(shared)g(\003ag)h(is)e(set,)k(the)d(amap)g(module)e
(is)i(careful)g(to)300 2860 y(propagate)24 b(changes)h(in)g(the)f(amap)
h(to)f(all)h(processes)g(that)f(are)i(sharing)e(the)h(mapping.)k(F)o
(or)c(e)o(xample,)300 3010 y(when)i(an)h(anon)f(is)g(remo)o(v)o(ed)f
(from)h(an)g(amap)h(an)o(y)e(resident)h(page)h(associated)f(with)f
(that)h(anon)g(must)300 3159 y(be)34 b(unmapped)g(from)g(the)g(process)
g(using)g(the)g(amap.)59 b(If)35 b(the)f(amap)g(is)g(kno)n(wn)f(not)h
(to)g(be)g(shared,)300 3308 y(then)25 b(simply)f(remo)o(ving)g(the)h
(mapping)g(for)g(that)g(page)h(in)f(the)h(current)f(process')h(pmap)f
(is)g(suf)n(\002cient.)300 3458 y(Ho)n(we)n(v)o(er)l(,)30
b(if)h(the)f(amap)g(is)g(being)g(shared)h(\(and)f(thus)g(the)g(shared)h
(\003ag)f(is)g(set\))h(then)f(not)g(only)f(must)300 3607
y(the)38 b(mapping)f(be)h(remo)o(v)o(ed)f(from)h(the)g(current)h
(process')f(pmap,)j(b)n(ut)d(it)f(must)g(also)h(be)g(remo)o(v)o(ed)300
3757 y(from)24 b(an)o(y)g(other)h(process)f(that)g(is)h(sharing)f(the)g
(mapping.)29 b(Remo)o(ving)24 b(a)h(mapping)e(from)h(the)h(current)300
3906 y(process')c(pmap)g(can)h(be)g(accomplished)e(by)h(using)f(the)i
Fm(pmap)p 2489 3906 30 4 v 35 w(remove)e Fs(function,)h(while)g(remo)o
(ving)300 4055 y(all)k(mappings)e(of)i(a)g(page)g(can)g(be)g
(accomplished)f(with)g(the)g Fm(pmap)p 2676 4055 V 35
w(page)p 2951 4055 V 35 w(protect)g Fs(function.)583
4205 y(In)e(UVM,)f(the)h(function)e(that)i(copies)f(the)g(address)h
(space)g(of)g(a)g(process)f(during)g(a)h(fork)g(opera-)300
4354 y(tion)h(is)h Fm(uvmspace)p 1056 4354 V 34 w(fork)p
Fs(.)30 b(The)24 b(C)g(pseudo-code)g(for)g(this)f(function)h(is)f(sho)n
(wn)g(in)h(in)f(Figure)i(4.13.)300 4504 y(Note)g(that)g(each)h(map)f
(entry)g(in)g(the)g(parent')-5 b(s)25 b(address)g(space)h(is)f(copied)g
(to)g(the)g(child)g(process)g(based)300 4653 y(on)g(its)f(inheritance)g
(v)n(alue.)583 4802 y(It)e(is)g(often)f(easier)h(to)g(understand)f(the)
g(relationship)g(between)g(amaps)h(and)f(forking,)h(f)o(aulting,)300
4952 y(and)29 b(inheritance)h(changes)f(by)g(looking)f(at)i(a)f(memory)
g(diagram)g(that)g(sho)n(ws)f(the)h(state)g(of)h(the)f(data)300
5101 y(structure)c(through)g(these)g(critical)h(e)n(v)o(ents)e(in)h(a)h
(process')g(lifetime.)32 b(T)-8 b(able)25 b(4.2)g(de\002nes)h(the)g
(symbols)300 5251 y(used)k(in)g(a)g(memory)f(diagram.)47
b(Figure)30 b(4.14)g(sho)n(ws)f(the)h(arrangement)g(of)g(the)g(data)g
(structure)g(in)g(a)300 5400 y(memory)23 b(diagram.)30
b(Note)24 b(that)f(in)g(a)h(map)g(entry)g(the)f(upper)h(left)g(corner)g
(contains)f(the)h(mapping)e(type)p eop
%%Page: 92 112
92 111 bop 3800 100 a Fs(92)300 365 y Fm(uvmspace_fork\(\))56
b({)539 606 y(allocate)i(a)i(new)f(vmspace)f(structure)g(for)h(the)g
(child;)539 726 y(for)g(\(each)g(map)g(entry)g(in)g(the)g(parent's)f
(map\))h({)778 967 y(switch\(entry->inherit\))c({)1017
1087 y(case)k(VM_INHERIT_NONE:)1256 1207 y(/*)h(do)f(nothing)f(*/)1256
1328 y(break;)1017 1448 y(case)h(VM_INHERIT_SHARE:)1256
1569 y(/*)h(add)f(shared)f(mapping)g(to)i(child)e(*/)1256
1689 y(break;)1017 1809 y(case)h(VM_INHERIT_COPY:)1256
1930 y(/*)h(add)f(copy-on-write)e(mapping)h(to)h(child)g(*/)1256
2050 y(break;)1017 2170 y(default:)f(panic\("uvmspace_fork"\);)778
2291 y(})539 2411 y(})539 2532 y(return\(new)g(vmspace\);)300
2652 y(})1425 2855 y Fs(Figure)25 b(4.13:)30 b(Pseudo)24
b(code)h(for)g(fork)1087 3523 y(T)-8 b(able)25 b(4.2:)30
b(The)25 b(symbols)e(used)h(in)h(a)g(memory)f(diagram)p
951 3655 2273 4 v 949 3776 4 121 v 1031 3740 a Fo(Symbol)p
1430 3776 V 129 w(Meaning)p 3222 3776 V 951 3779 2273
4 v 949 3899 4 121 v 1136 3863 a Fn(A)1209 3878 y Fc(r)p
1430 3899 V 1481 3863 a Fs(an)h(anon)g(structure)f(with)g(reference)j
(count)d Fn(r)p 3222 3899 V 951 3903 2273 4 v 949 4023
4 121 v 1153 3987 a(C)p 1430 4023 V 258 w Fs(cop)o(y)p
3222 4023 V 951 4027 2273 4 v 949 4147 4 121 v 1136 4111
a Fn(F)1199 4126 y Fc(n)p 1430 4147 V 1481 4111 a Fs(process)h
Fn(n)g Fs(forks)p 3222 4147 V 951 4150 2273 4 v 949 4271
4 121 v 1102 4234 a Fn(I)8 b(H)1234 4249 y Fc(n)p 1430
4271 V 1481 4234 a Fs(process)25 b Fn(n)g Fs(changes)g(an)g
(inheritance)f(v)n(alue)p 3222 4271 V 951 4274 2273 4
v 949 4394 4 121 v 1125 4358 a Fn(M)1219 4373 y Fc(r)p
1430 4394 V 1481 4358 a Fs(an)h(amap)g(structure)f(with)g(a)i
(reference)g(count)e Fn(r)p 3222 4394 V 951 4398 2273
4 v 949 4518 4 121 v 1109 4482 a(N)10 b(C)p 1430 4518
V 214 w Fs(needs-cop)o(y)25 b(\003ag)g(is)g(true)p 3222
4518 V 951 4521 2273 4 v 949 4642 4 121 v 1099 4606 a
Fn(R)q(F)1237 4621 y Fc(n)p 1430 4642 V 1481 4606 a Fs(process)g
Fn(n)g Fs(triggers)f(a)i(read-f)o(ault)p 3222 4642 V
951 4645 2273 4 v 949 4765 4 121 v 1158 4729 a Fn(S)p
1430 4765 V 263 w Fs(share)p 3222 4765 V 951 4769 2273
4 v 949 4889 4 121 v 1001 4853 a Fn(S)6 b(H)i(AR)q(E)p
1430 4889 V 105 w Fs(\223shared\224)26 b(amap)e(\003ag)i(is)e(true)p
3222 4889 V 951 4892 2273 4 v 949 5013 4 121 v 1084 4977
a Fn(W)14 b(F)1253 4992 y Fc(n)p 1430 5013 V 1481 4977
a Fs(process)25 b Fn(n)g Fs(triggers)f(a)i(write-f)o(ault)p
3222 5013 V 951 5016 2273 4 v 949 5137 4 121 v 1164 5100
a Fn(x)p 1430 5137 V 262 w Fs(\223don')n(t)f(care\224)p
3222 5137 V 951 5140 2273 4 v eop
%%Page: 93 113
93 112 bop 3800 100 a Fs(93)1009 1339 y @beginspecial
0 @llx 0 @lly 374 @urx 204 @ury 2618 @rwi @setspecial
%%BeginDocument: ../figures/forkkey.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-46.0 276.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4627 m 0 0 l 7027 0 l 7027 4627 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
2700 1425 m
gs 1 -1 sc (process id) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 240.00 scf sf
5175 3450 m
gs 1 -1 sc (2) col-1 sh gr
% Polyline
30.000 slw
n 4800 3000 m 6600 3000 l 6600 3525 l 4800 3525 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 6225 3000 m 6225 3525 l gs col-1 s gr 
% Polyline
n 5850 3000 m 5850 3525 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
6600 2925 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
% Polyline
30.000 slw
n 4200 1800 m 5100 1800 l 5100 2400 l 4200 2400 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 5100 1800 m 4200 2400 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
4275 2100 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
5025 2325 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4200 1725 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 1725 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
6225 4275 m
gs 1 -1 sc (A) col-1 sh gr
/Helvetica ff 240.00 scf sf
6450 4425 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
gs  clippath
4973 2859 m 5010 2977 l 4922 2891 l 5008 3029 l 5058 2997 l cp
clip
n 4650 2400 m 5025 3000 l gs col-1 s gr gr

% arrowhead
n 4973 2859 m 5010 2977 l 4922 2891 l 4947 2875 l 4973 2859 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
6405 3828 m 6375 3948 l 6345 3828 l 6345 3990 l 6405 3990 l cp
clip
n 6375 3300 m 6375 3975 l gs col-1 s gr gr

% arrowhead
n 6405 3828 m 6375 3948 l 6345 3828 l 6375 3828 l 6405 3828 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
 [15 45] 45 sd
gs  clippath
4503 3270 m 4623 3300 l 4503 3330 l 4665 3330 l 4665 3270 l cp
clip
n 2775 3300 m 4650 3300 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 4503 3270 m 4623 3300 l 4503 3330 l 4503 3300 l 4503 3270 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
5928 4170 m 6048 4200 l 5928 4230 l 6090 4230 l 6090 4170 l cp
clip
n 2775 4200 m 6075 4200 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 5928 4170 m 6048 4200 l 5928 4230 l 5928 4200 l 5928 4170 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
3978 2070 m 4098 2100 l 3978 2130 l 4140 2130 l 4140 2070 l cp
clip
n 2775 2100 m 4125 2100 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 3978 2070 m 4098 2100 l 3978 2130 l 3978 2100 l 3978 2070 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3825 1350 m 6975 1350 l 6975 4575 l 3825 4575 l cp gs col-1 s gr 
% Polyline
 [15 45] 45 sd
gs  clippath
4134 1899 m 4248 1945 l 4125 1958 l 4285 1982 l 4294 1923 l cp
clip
n 2775 1725 m 4275 1950 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 4134 1899 m 4248 1945 l 4125 1958 l 4130 1928 l 4134 1899 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
4650 2167 m 4773 2178 l 4659 2226 l 4819 2202 l 4810 2143 l cp
clip
n 2775 2475 m 4800 2175 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 4650 2167 m 4773 2178 l 4659 2226 l 4655 2197 l 4650 2167 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
 [15 45] 45 sd
gs  clippath
4059 1522 m 4173 1570 l 4050 1582 l 4210 1607 l 4219 1548 l cp
clip
n 2775 1350 m 4200 1575 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 4059 1522 m 4173 1570 l 4050 1582 l 4055 1552 l 4059 1522 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
2700 3375 m
gs 1 -1 sc (amap) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 4275 m
gs 1 -1 sc (anon) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 2175 m
gs 1 -1 sc (map entry) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 1800 m
gs 1 -1 sc (mapping type) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2700 2550 m
gs 1 -1 sc (inheritance) dup sw pop neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4875 3300 m
gs 1 -1 sc (M) col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1297 1543 a(Figure)25 b(4.14:)30 b(A)25
b(sample)f(memory)g(diagram)788 2869 y @beginspecial
0 @llx 0 @lly 450 @urx 188 @ury 3150 @rwi @setspecial
%%BeginDocument: ../figures/sfork.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-56.0 246.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4126 m 0 0 l 8473 0 l 8473 4126 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
7650 2700 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 240.00 scf sf
2925 4050 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
30.000 slw
n 1275 2775 m 3075 2775 l 3075 3300 l 1275 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2700 2775 m 2700 3300 l gs col-1 s gr 
% Polyline
n 2325 2775 m 2325 3300 l gs col-1 s gr 
% Polyline
gs  clippath
2880 3453 m 2850 3573 l 2820 3453 l 2820 3615 l 2880 3615 l cp
clip
n 2850 3000 m 2850 3600 l gs col-1 s gr gr

% arrowhead
n 2880 3453 m 2850 3573 l 2820 3453 l 2850 3453 l 2880 3453 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1350 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
1650 3225 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
7275 3900 m
gs 1 -1 sc (A) col-1 sh gr
/Helvetica ff 240.00 scf sf
7500 4050 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
3600 2025 m
gs 1 -1 sc (F) col-1 sh gr
/Helvetica ff 240.00 scf sf
3750 2175 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
30.000 slw
n 975 1200 m 1875 1200 l 1875 1800 l 975 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 1875 1200 m 975 1800 l gs col-1 s gr 
% Polyline
gs  clippath
1519 2626 m 1497 2748 l 1459 2631 l 1471 2792 l 1531 2788 l cp
clip
n 1425 1800 m 1500 2775 l gs col-1 s gr gr

% arrowhead
n 1519 2626 m 1497 2748 l 1459 2631 l 1489 2628 l 1519 2626 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 5100 1200 m 6000 1200 l 6000 1800 l 5100 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 6000 1200 m 5100 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 7500 1200 m 8400 1200 l 8400 1800 l 7500 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 8400 1200 m 7500 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 5850 2775 m 7650 2775 l 7650 3300 l 5850 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 7275 2775 m 7275 3300 l gs col-1 s gr 
% Polyline
n 6900 2775 m 6900 3300 l gs col-1 s gr 
% Polyline
gs  clippath
7455 3453 m 7425 3573 l 7395 3453 l 7395 3615 l 7455 3615 l cp
clip
n 7425 3000 m 7425 3600 l gs col-1 s gr gr

% arrowhead
n 7455 3453 m 7425 3573 l 7395 3453 l 7425 3453 l 7455 3453 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
6032 2631 m 6062 2751 l 5979 2660 l 6056 2802 l 6109 2774 l cp
clip
n 5550 1800 m 6075 2775 l gs col-1 s gr gr

% arrowhead
n 6032 2631 m 6062 2751 l 5979 2660 l 6005 2646 l 6032 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
6219 2734 m 6098 2762 l 6192 2681 l 6048 2755 l 6076 2809 l cp
clip
n 7950 1800 m 6075 2775 l gs col-1 s gr gr

% arrowhead
n 6219 2734 m 6098 2762 l 6192 2681 l 6205 2707 l 6219 2734 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3903 1695 m 4023 1725 l 3903 1755 l 4065 1755 l 4065 1695 l cp
clip
n 3450 1725 m 4050 1725 l gs col-1 s gr gr

% arrowhead
n 3903 1695 m 4023 1725 l 3903 1755 l 3903 1725 l 3903 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3903 2220 m 4023 2250 l 3903 2280 l 4065 2280 l 4065 2220 l cp
clip
n 3450 2250 m 4050 2250 l gs col-1 s gr gr

% arrowhead
n 3903 2220 m 4023 2250 l 3903 2280 l 3903 2250 l 3903 2220 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1050 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
1800 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
975 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
5925 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
7575 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
8325 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
7500 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
5925 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
6225 3225 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
2700 3900 m
gs 1 -1 sc (A) col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1494 3072 a(Figure)h(4.15:)30 b(Share)c(inheritance)300
3467 y(and)f(the)g(lo)n(wer)f(right)g(corner)i(contains)e(the)h
(inheritance)f(v)n(alue.)31 b(Figure)25 b(4.15)f(sho)n(ws)g(what)h
(happens)300 3617 y(to)e(a)h(map)f(entry)h(during)e(a)i(fork)g(when)f
(its)g(inheritance)g(is)g(set)h(to)f(share.)30 b(Note)24
b(that)f(the)g(amap')-5 b(s)23 b(share)300 3766 y(\003ag)h(becomes)e
(true)h(after)h(the)f(fork)g(and)g(the)g(amap')-5 b(s)22
b(reference)j(count)d(goes)h(from)g(one)f(to)h(tw)o(o)g(while)300
3915 y(the)i(anon)f(\(that)h(is)f(shared\))h(remains)g(unchanged.)583
4065 y(Figure)k(4.16)e(sho)n(ws)g(what)h(happens)g(to)f(a)i(map)e
(entry)h(during)g(a)g(fork)g(when)g(its)f(inheritance)300
4214 y(is)j(set)g(to)f(cop)o(y)-6 b(.)47 b(Note)30 b(that)f(in)h(this)f
(case)i(the)f(amap)g(gets)g(an)g(additional)f(reference,)k(b)n(ut)d(it)
f(is)h(not)g(a)300 4364 y(shared)g(one.)46 b(Both)30
b(process)g(one)g(and)f(process)h(tw)o(o)g(ha)n(v)o(e)f(their)h
(needs-cop)o(y)g(\003ag)g(set.)46 b(Also,)30 b(note)300
4513 y(that)21 b(the)g(mappings)f(in)h(process)g(one)h(ha)n(v)o(e)f
(been)g(write)h(protected)f(to)g(ensure)g(that)g(the)h(cop)o
(y-on-write)300 4662 y(operation)f(will)g(happen.)30
b(The)22 b(needs-cop)o(y)g(\003ag)g(will)f(remain)h(set)g(on)f(the)h
(map)g(entries)f(until)g(the)h(\002rst)300 4812 y(write)f(f)o(ault)g
(either)g(in)g(process)g(one)h(or)f(process)g(tw)o(o.)29
b(If)22 b(process)f(one)h(had)f(a)g(write)h(f)o(ault)f(on)g(anon)g
(\223)-8 b(A)d(\224)300 4961 y(then)26 b(the)f(result)h(w)o(ould)f(be)h
(as)g(sho)n(wn)f(in)g(Figure)h(4.17.)34 b(When)26 b(that)f(write)h(f)o
(ault)g(occurs,)g(the)g(needs-)300 5111 y(cop)o(y)g(\003ag)i(will)d
(\002rst)i(need)g(to)f(be)h(cleared)h(with)d Fm(amap)p
2263 5111 30 4 v 35 w(copy)h Fs(before)i(the)e(f)o(ault)g(can)h(be)g
(processed.)300 5260 y(This)33 b(causes)g(process)g(one)g(to)g(get)g(a)
h(ne)n(w)f(amap)g(and)g(both)g(anons)g(\223)-8 b(A)d(\224)33
b(and)g(\223B\224)i(get)e(a)g(reference)p eop
%%Page: 94 114
94 113 bop 3800 100 a Fs(94)788 1252 y @beginspecial
0 @llx 0 @lly 450 @urx 189 @ury 3150 @rwi @setspecial
%%BeginDocument: ../figures/cfork.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-56.0 246.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4126 m 0 0 l 8473 0 l 8473 4126 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 240.00 scf sf
1650 3225 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 240.00 scf sf
3750 2175 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
6825 3900 m
gs 1 -1 sc (A) col-1 sh gr
/Helvetica ff 240.00 scf sf
7050 4050 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
7350 3900 m
gs 1 -1 sc (B) col-1 sh gr
/Helvetica ff 240.00 scf sf
7575 4050 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
2250 3900 m
gs 1 -1 sc (A) col-1 sh gr
/Helvetica ff 240.00 scf sf
2475 4050 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
2775 3900 m
gs 1 -1 sc (B) col-1 sh gr
/Helvetica ff 240.00 scf sf
3000 4050 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
30.000 slw
n 975 1200 m 1875 1200 l 1875 1800 l 975 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 1875 1200 m 975 1800 l gs col-1 s gr 
% Polyline
gs  clippath
1519 2626 m 1497 2748 l 1459 2631 l 1471 2792 l 1531 2788 l cp
clip
n 1425 1800 m 1500 2775 l gs col-1 s gr gr

% arrowhead
n 1519 2626 m 1497 2748 l 1459 2631 l 1489 2628 l 1519 2626 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 5100 1200 m 6000 1200 l 6000 1800 l 5100 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 6000 1200 m 5100 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 7500 1200 m 8400 1200 l 8400 1800 l 7500 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 8400 1200 m 7500 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 5850 2775 m 7650 2775 l 7650 3300 l 5850 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 7275 2775 m 7275 3300 l gs col-1 s gr 
% Polyline
n 6900 2775 m 6900 3300 l gs col-1 s gr 
% Polyline
gs  clippath
6032 2631 m 6062 2751 l 5979 2660 l 6056 2802 l 6109 2774 l cp
clip
n 5550 1800 m 6075 2775 l gs col-1 s gr gr

% arrowhead
n 6032 2631 m 6062 2751 l 5979 2660 l 6005 2646 l 6032 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
6219 2734 m 6098 2762 l 6192 2681 l 6048 2755 l 6076 2809 l cp
clip
n 7950 1800 m 6075 2775 l gs col-1 s gr gr

% arrowhead
n 6219 2734 m 6098 2762 l 6192 2681 l 6205 2707 l 6219 2734 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3903 1695 m 4023 1725 l 3903 1755 l 4065 1755 l 4065 1695 l cp
clip
n 3450 1725 m 4050 1725 l gs col-1 s gr gr

% arrowhead
n 3903 1695 m 4023 1725 l 3903 1755 l 3903 1725 l 3903 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3903 2220 m 4023 2250 l 3903 2280 l 4065 2280 l 4065 2220 l cp
clip
n 3450 2250 m 4050 2250 l gs col-1 s gr gr

% arrowhead
n 3903 2220 m 4023 2250 l 3903 2280 l 3903 2250 l 3903 2220 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 1275 2775 m 3075 2775 l 3075 3300 l 1275 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2700 2775 m 2700 3300 l gs col-1 s gr 
% Polyline
n 2325 2775 m 2325 3300 l gs col-1 s gr 
% Polyline
gs  clippath
2505 3453 m 2475 3573 l 2445 3453 l 2445 3615 l 2505 3615 l cp
clip
n 2475 3000 m 2475 3600 l gs col-1 s gr gr

% arrowhead
n 2505 3453 m 2475 3573 l 2445 3453 l 2475 3453 l 2505 3453 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2880 3453 m 2850 3573 l 2820 3453 l 2820 3615 l 2880 3615 l cp
clip
n 2850 3000 m 2850 3600 l gs col-1 s gr gr

% arrowhead
n 2880 3453 m 2850 3573 l 2820 3453 l 2850 3453 l 2880 3453 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
7080 3453 m 7050 3573 l 7020 3453 l 7020 3615 l 7080 3615 l cp
clip
n 7050 3000 m 7050 3600 l gs col-1 s gr gr

% arrowhead
n 7080 3453 m 7050 3573 l 7020 3453 l 7050 3453 l 7080 3453 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
7455 3453 m 7425 3573 l 7395 3453 l 7395 3615 l 7455 3615 l cp
clip
n 7425 3000 m 7425 3600 l gs col-1 s gr gr

% arrowhead
n 7455 3453 m 7425 3573 l 7395 3453 l 7425 3453 l 7455 3453 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1800 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
975 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
5925 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
5100 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
7575 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
8325 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
7500 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
5925 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
6225 3225 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
6000 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
8400 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1050 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
1350 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 300.00 scf sf
3600 2025 m
gs 1 -1 sc (F) col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1500 1455 a(Figure)25 b(4.16:)30 b(Cop)o(y)25
b(inheritance)1009 3102 y @beginspecial 0 @llx 0 @lly
374 @urx 243 @ury 2618 @rwi @setspecial
%%BeginDocument: ../figures/cforkw.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 300.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 5026 m 0 0 l 6553 0 l 6553 5026 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 240.00 scf sf
2625 3225 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 240.00 scf sf
750 2175 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
30.000 slw
n 4650 2775 m 6450 2775 l 6450 3300 l 4650 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 6075 2775 m 6075 3300 l gs col-1 s gr 
% Polyline
n 5700 2775 m 5700 3300 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
4725 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
5025 3225 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
3300 3900 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 240.00 scf sf
3525 4050 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
5700 3900 m
gs 1 -1 sc (A) col-1 sh gr
/Helvetica ff 240.00 scf sf
5925 4050 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
6150 4800 m
gs 1 -1 sc (B) col-1 sh gr
/Helvetica ff 240.00 scf sf
6375 4950 m
gs 1 -1 sc (2) col-1 sh gr
% Polyline
gs  clippath
753 1695 m 873 1725 l 753 1755 l 915 1755 l 915 1695 l cp
clip
n 300 1725 m 900 1725 l gs col-1 s gr gr

% arrowhead
n 753 1695 m 873 1725 l 753 1755 l 753 1725 l 753 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 2220 m 873 2250 l 753 2280 l 915 2280 l 915 2220 l cp
clip
n 300 2250 m 900 2250 l gs col-1 s gr gr

% arrowhead
n 753 2220 m 873 2250 l 753 2280 l 753 2250 l 753 2220 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 1500 1200 m 2400 1200 l 2400 1800 l 1500 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2400 1200 m 1500 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 3900 1200 m 4800 1200 l 4800 1800 l 3900 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 4800 1200 m 3900 1800 l gs col-1 s gr 
% Polyline
gs  clippath
5901 4537 m 5978 4633 l 5865 4585 l 5994 4683 l 6030 4635 l cp
clip
n 3825 3000 m 6000 4650 l gs col-1 s gr gr

% arrowhead
n 5901 4537 m 5978 4633 l 5865 4585 l 5883 4561 l 5901 4537 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2432 2631 m 2462 2751 l 2379 2660 l 2456 2802 l 2509 2774 l cp
clip
n 1950 1800 m 2475 2775 l gs col-1 s gr gr

% arrowhead
n 2432 2631 m 2462 2751 l 2379 2660 l 2405 2646 l 2432 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 2250 2775 m 4050 2775 l 4050 3300 l 2250 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3675 2775 m 3675 3300 l gs col-1 s gr 
% Polyline
n 3300 2775 m 3300 3300 l gs col-1 s gr 
% Polyline
gs  clippath
6255 4353 m 6225 4473 l 6195 4353 l 6195 4515 l 6255 4515 l cp
clip
n 6225 3000 m 6225 4500 l gs col-1 s gr gr

% arrowhead
n 6255 4353 m 6225 4473 l 6195 4353 l 6225 4353 l 6255 4353 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
4819 2631 m 4849 2751 l 4766 2660 l 4843 2802 l 4896 2774 l cp
clip
n 4337 1800 m 4862 2775 l gs col-1 s gr gr

% arrowhead
n 4819 2631 m 4849 2751 l 4766 2660 l 4792 2646 l 4819 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3480 3453 m 3450 3573 l 3420 3453 l 3420 3615 l 3480 3615 l cp
clip
n 3450 3000 m 3450 3600 l gs col-1 s gr gr

% arrowhead
n 3480 3453 m 3450 3573 l 3420 3453 l 3450 3453 l 3480 3453 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5880 3453 m 5850 3573 l 5820 3453 l 5820 3615 l 5880 3615 l cp
clip
n 5850 3000 m 5850 3600 l gs col-1 s gr gr

% arrowhead
n 5880 3453 m 5850 3573 l 5820 3453 l 5850 3453 l 5880 3453 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1575 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
2325 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1500 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
3975 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
4725 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3900 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
4800 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2325 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 300.00 scf sf
300 2025 m
gs 1 -1 sc (WF) col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 300 3305 a(Figure)31 b(4.17:)42 b(Clearing)31
b(needs-cop)o(y)g(after)g(a)g(cop)o(y-inheritance)g(fork.)49
b(Needs-cop)o(y)31 b(w)o(as)f(cleared)300 3426 y(because)h(process)f
(one)g(took)g(a)h(write)f(f)o(ault)g(on)g(anon)g(\223)-8
b(A)d(\224)31 b(causing)f(a)h(ne)n(w)f(anon)g(\(\223C\224\))i(to)e(be)g
(allo-)300 3546 y(cated.)300 3921 y(count)24 b(of)h(tw)o(o.)30
b(Once)25 b(the)f(ne)n(w)g(amap)g(has)h(been)g(created,)g(then)f(a)h
(ne)n(w)f(anon)g(\(\223C\224\))i(for)f(process)f(one)300
4070 y(can)j(be)g(allocated)f(and)h(inserted)f(into)g(it.)36
b(After)27 b(the)g(cop)o(y-on-write)f(f)o(ault)g(anon)h(\223B\224)g(is)
g(still)e(shared)300 4220 y(between)30 b(the)f(tw)o(o)h(processes.)45
b(Note)29 b(that)g(process)h(tw)o(o)f(still)g(has)g(its)g(needs-cop)o
(y)h(\003ag)g(set:)40 b(this)29 b(is)300 4369 y(harmless.)36
b(If)28 b(process)e(tw)o(o)h(has)f(a)i(write)e(f)o(ault)h(on)g(the)f
(mapped)h(area,)h Fm(amap)p 3064 4369 30 4 v 35 w(copy)e
Fs(will)g(be)h(called)300 4518 y(on)i(the)h(mapping)e(to)h(clear)h
(needs-cop)o(y)-6 b(.)45 b(The)29 b Fm(amap)p 2236 4518
V 35 w(copy)g Fs(function)g(will)g(notice)g(that)g(the)g(amap)300
4668 y(pointed)e(to)h(by)f(process)h(tw)o(o)g(has)g(a)g(reference)h
(count)f(of)g(one.)40 b(This)27 b(indicates)h(that)f(process)h(tw)o(o)g
(is)300 4817 y(the)i(only)f(process)g(referencing)i(the)f(amap,)g(and)g
(thus)f(the)h(amap)f(does)h(not)f(need)h(to)g(be)g(copied.)45
b(In)300 4967 y(this)24 b(case)h Fm(amap)p 911 4967 V
35 w(copy)f Fs(can)h(clear)h(the)f(needs-cop)o(y)f(\003ag)h(without)f
(actually)g(cop)o(ying)g(the)h(amap.)p eop
%%Page: 95 115
95 114 bop 3800 100 a Fs(95)1225 1252 y @beginspecial
0 @llx 0 @lly 300 @urx 189 @ury 2100 @rwi @setspecial
%%BeginDocument: ../figures/sforkp1.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 246.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4126 m 0 0 l 5323 0 l 5323 4126 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
5250 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
% Polyline
7.500 slw
n 3675 1200 m 2775 1800 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
2850 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
3600 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2775 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
3675 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 3900 m
gs 1 -1 sc (A) col-1 sh gr
/Helvetica ff 240.00 scf sf
4575 4050 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
30.000 slw
n 2925 2775 m 4725 2775 l 4725 3300 l 2925 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 4350 2775 m 4350 3300 l gs col-1 s gr 
% Polyline
n 3975 2775 m 3975 3300 l gs col-1 s gr 
% Polyline
gs  clippath
4530 3453 m 4500 3573 l 4470 3453 l 4470 3615 l 4530 3615 l cp
clip
n 4500 3000 m 4500 3600 l gs col-1 s gr gr

% arrowhead
n 4530 3453 m 4500 3573 l 4470 3453 l 4500 3453 l 4530 3453 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
3000 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
3300 3225 m
gs 1 -1 sc (3) col-1 sh gr
/Helvetica ff 300.00 scf sf
4725 2700 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
% Polyline
30.000 slw
n 1275 1200 m 2175 1200 l 2175 1800 l 1275 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2175 1200 m 1275 1800 l gs col-1 s gr 
% Polyline
gs  clippath
3046 2667 m 3127 2759 l 3012 2717 l 3145 2808 l 3179 2759 l cp
clip
n 1725 1800 m 3150 2775 l gs col-1 s gr gr

% arrowhead
n 3046 2667 m 3127 2759 l 3012 2717 l 3029 2692 l 3046 2667 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3191 2631 m 3152 2748 l 3131 2626 l 3119 2788 l 3179 2792 l cp
clip
n 3225 1800 m 3150 2775 l gs col-1 s gr gr

% arrowhead
n 3191 2631 m 3152 2748 l 3131 2626 l 3161 2628 l 3191 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 1695 m 873 1725 l 753 1755 l 915 1755 l 915 1695 l cp
clip
n 300 1725 m 900 1725 l gs col-1 s gr gr

% arrowhead
n 753 1695 m 873 1725 l 753 1755 l 753 1725 l 753 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 2220 m 873 2250 l 753 2280 l 915 2280 l 915 2220 l cp
clip
n 300 2250 m 900 2250 l gs col-1 s gr gr

% arrowhead
n 753 2220 m 873 2250 l 753 2280 l 753 2250 l 753 2220 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 4350 1200 m 5250 1200 l 5250 1800 l 4350 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 5250 1200 m 4350 1800 l gs col-1 s gr 
% Polyline
gs  clippath
3292 2726 m 3173 2761 l 3261 2674 l 3122 2757 l 3152 2808 l cp
clip
n 4800 1800 m 3150 2775 l gs col-1 s gr gr

% arrowhead
n 3292 2726 m 3173 2761 l 3261 2674 l 3277 2700 l 3292 2726 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1350 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 1725 m
gs 1 -1 sc (x) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1275 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
450 2025 m
gs 1 -1 sc (F) col-1 sh gr
/Helvetica ff 240.00 scf sf
600 2175 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
4425 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 1125 m
gs 1 -1 sc (3) col-1 sh gr
% Polyline
30.000 slw
n 2775 1200 m 3675 1200 l 3675 1800 l 2775 1800 l cp gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1455 a(Figure)27 b(4.18:)35 b(An)26
b(erroneous)h(fork.)38 b(Process)27 b(tw)o(o)g(is)f(the)h(parent)g
(process)g(that)g(has)g(needs-cop)o(y)f(set)300 1576
y(and)33 b(shared)f(inheritance.)54 b(Process)33 b(three)g(is)f(the)h
(child)f(process.)54 b(Process)33 b(one)f(is)g(also)h(using)e(the)300
1696 y(amap.)300 2091 y Fg(4.7)143 b(Inheritance)33 b(and)i(F)l(orking)
300 2344 y Fs(The)26 b(description)f(in)h(the)g(pre)n(vious)f(section)h
(of)g(the)g(ef)n(fect)h(of)f(shared)h(and)f(cop)o(y)g(inheritance)g
(during)300 2493 y(a)39 b(fork)f(co)o(v)o(ers)f(the)h(common)f(cases.)
72 b(Ho)n(we)n(v)o(er)l(,)40 b(there)f(are)g(a)f(fe)n(w)g(special)g
(cases)h(that)f(must)f(be)300 2643 y(correctly)29 b(handled)g(by)g(the)
g(fork)g(code)g(in)g(order)g(to)g(properly)g(preserv)o(e)g(the)g
(semantics)f(de\002ned)h(by)300 2792 y(the)c(memory)f(mapping)f(API.)j
(These)e(special)h(cases)g(are)h(described)e(in)h(this)f(section.)300
3123 y Ff(4.7.1)119 b(Shar)n(e)30 b(Inheritance)h(when)g(Needs-copy)g
(is)e(T)-9 b(rue)300 3340 y Fs(Consider)23 b(a)h(process)f(that)g(has)g
(a)g(map)g(entry)g(in)g(its)g(map)g(that)g(has)g(its)f(inheritance)h(v)
n(alue)g(set)g(to)g(share)300 3489 y(and)31 b(has)g(an)g(amap)g
(attached)h(to)e(it.)49 b(When)32 b(this)e(process)h(forks,)h(the)f
(data)g(in)g(the)g(amap)g(should)f(be)300 3639 y(shared)25
b(between)g(the)f(parent)h(and)g(the)g(child)f(process,)g(as)h(sho)n
(wn)f(earlier)h(in)g(Figure)g(4.15)583 3788 y(No)n(w)30
b(consider)f(what)h(w)o(ould)f(happen)g(if)h(the)g(parent)g(process')f
(needs-cop)o(y)h(\003ag)g(w)o(as)g(true.)300 3937 y(The)k(needs-cop)o
(y)g(\003ag)h(of)f(a)h(map)f(entry)g(is)g(true)g(only)g(if)g(the)g
(entry)g(is)g(pointing)e(to)i(an)g(amap)h(that)300 4087
y(the)29 b(entry)f(needs)h(a)g(cop)o(y)f(of,)i(b)n(ut)e(has)h(not)f
(yet)g(made)h(since)f(a)h(write)g(f)o(ault)f(has)h(not)f(occurred.)43
b(This)300 4236 y(amap)24 b(is)f(typically)g(also)g(referenced)i(by)f
(another)g(process.)30 b(If)24 b(the)g(pattern)f(sho)n(wn)g(in)g
(Figure)h(4.15)g(is)300 4386 y(follo)n(wed,)f(the)i(result)f(is)h(as)g
(sho)n(wn)e(in)i(Figure)g(4.18.)30 b(This)24 b(con\002guration)g(is)g
(wrong.)583 4535 y(The)g(problem)f(with)f(the)i(con\002guration)f(sho)n
(wn)f(in)h(Figure)h(4.18)e(is)h(that)g(both)g(processes)h(tw)o(o)300
4684 y(and)f(three)h(are)g(supposed)e(to)h(be)h(sharing)f(an)g(amap,)h
(b)n(ut)f(the)o(y)f(both)h(ha)n(v)o(e)g(needs-cop)o(y)g(set.)30
b(Consider)300 4834 y(what)25 b(w)o(ould)g(happen)g(if)h(process)f
(three)h(had)g(a)f(write)h(f)o(ault)f(on)g(the)h(mapped)f(area.)34
b(The)25 b(VM)g(system)300 4983 y(w)o(ould)d(detect)g(process)h(three')
-5 b(s)22 b(needs-cop)o(y)g(\003ag)i(and)e(clear)h(it)f(by)h(creating)f
(a)h(ne)n(w)f(amap)h(for)g(it.)29 b(But)300 5132 y(by)g(doing)f(this)f
(process)i(tw)o(o)g(and)f(process)h(three)g(are)h(no)e(longer)h
(sharing)f(the)h(same)g(amap)f(and)h(the)300 5282 y(semantics)f
(required)i(by)f(the)g(shared)h(inheritance)f(are)h(brok)o(en.)44
b(The)30 b(unfortunate)f(result)f(is)h(sho)n(wn)p eop
%%Page: 96 116
96 115 bop 3800 100 a Fs(96)936 1328 y @beginspecial
0 @llx 0 @lly 399 @urx 202 @ury 2793 @rwi @setspecial
%%BeginDocument: ../figures/sforkp11.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 259.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4351 m 0 0 l 6973 0 l 6973 4351 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 240.00 scf sf
5475 3225 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
7.500 slw
n 3675 1200 m 2775 1800 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
2850 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
3600 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2775 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
3675 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4500 4125 m
gs 1 -1 sc (A) col-1 sh gr
/Helvetica ff 240.00 scf sf
4725 4275 m
gs 1 -1 sc (2) col-1 sh gr
% Polyline
30.000 slw
n 1275 1200 m 2175 1200 l 2175 1800 l 1275 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2175 1200 m 1275 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 2025 2775 m 3825 2775 l 3825 3300 l 2025 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3450 2775 m 3450 3300 l gs col-1 s gr 
% Polyline
n 3075 2775 m 3075 3300 l gs col-1 s gr 
% Polyline
gs  clippath
4348 3771 m 4406 3880 l 4304 3812 l 4413 3931 l 4457 3891 l cp
clip
n 3600 3000 m 4425 3900 l gs col-1 s gr gr

% arrowhead
n 4348 3771 m 4406 3880 l 4304 3812 l 4326 3792 l 4348 3771 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2207 2631 m 2237 2751 l 2154 2660 l 2231 2802 l 2284 2774 l cp
clip
n 1725 1800 m 2250 2775 l gs col-1 s gr gr

% arrowhead
n 2207 2631 m 2237 2751 l 2154 2660 l 2180 2646 l 2207 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2375 2692 m 2269 2755 l 2333 2650 l 2218 2764 l 2261 2807 l cp
clip
n 3225 1800 m 2250 2775 l gs col-1 s gr gr

% arrowhead
n 2375 2692 m 2269 2755 l 2333 2650 l 2354 2671 l 2375 2692 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 1695 m 873 1725 l 753 1755 l 915 1755 l 915 1695 l cp
clip
n 300 1725 m 900 1725 l gs col-1 s gr gr

% arrowhead
n 753 1695 m 873 1725 l 753 1755 l 753 1725 l 753 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 2220 m 873 2250 l 753 2280 l 915 2280 l 915 2220 l cp
clip
n 300 2250 m 900 2250 l gs col-1 s gr gr

% arrowhead
n 753 2220 m 873 2250 l 753 2280 l 753 2250 l 753 2220 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 4350 1200 m 5250 1200 l 5250 1800 l 4350 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 5250 1200 m 4350 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 5100 2775 m 6900 2775 l 6900 3300 l 5100 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 6525 2775 m 6525 3300 l gs col-1 s gr 
% Polyline
n 6150 2775 m 6150 3300 l gs col-1 s gr 
% Polyline
gs  clippath
4946 3863 m 4824 3888 l 4920 3809 l 4773 3879 l 4799 3934 l cp
clip
n 6675 3000 m 4800 3900 l gs col-1 s gr gr

% arrowhead
n 4946 3863 m 4824 3888 l 4920 3809 l 4933 3836 l 4946 3863 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
5349 2634 m 5385 2752 l 5297 2666 l 5382 2803 l 5433 2772 l cp
clip
n 4800 1800 m 5400 2775 l gs col-1 s gr gr

% arrowhead
n 5349 2634 m 5385 2752 l 5297 2666 l 5323 2650 l 5349 2634 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1350 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 1725 m
gs 1 -1 sc (x) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1275 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
2400 3225 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
4425 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 1125 m
gs 1 -1 sc (3) col-1 sh gr
/Helvetica ff 300.00 scf sf
3825 2700 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
300 2025 m
gs 1 -1 sc (WF) col-1 sh gr
/Helvetica ff 240.00 scf sf
750 2175 m
gs 1 -1 sc (3) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 3075 m
gs 1 -1 sc (M) col-1 sh gr
% Polyline
30.000 slw
n 2775 1200 m 3675 1200 l 3675 1800 l 2775 1800 l cp gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1531 a(Figure)20 b(4.19:)27 b(Erroneous)19
b(fork)h(after)g(process)g(three)f(write-f)o(aults.)29
b(Processes)20 b(tw)o(o)f(and)g(three)h(should)300 1652
y(be)25 b(sharing)f(the)h(same)f(amap,)h(b)n(ut)f(the)o(y)g(are)i(not.)
936 3053 y @beginspecial 0 @llx 0 @lly 399 @urx 201 @ury
2793 @rwi @setspecial
%%BeginDocument: ../figures/sforkp12.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 259.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4351 m 0 0 l 6973 0 l 6973 4351 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
4425 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 240.00 scf sf
4725 4275 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
450 2025 m
gs 1 -1 sc (F) col-1 sh gr
/Helvetica ff 240.00 scf sf
600 2175 m
gs 1 -1 sc (2) col-1 sh gr
% Polyline
30.000 slw
n 1275 1200 m 2175 1200 l 2175 1800 l 1275 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2175 1200 m 1275 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 2025 2775 m 3825 2775 l 3825 3300 l 2025 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3450 2775 m 3450 3300 l gs col-1 s gr 
% Polyline
n 3075 2775 m 3075 3300 l gs col-1 s gr 
% Polyline
gs  clippath
4348 3771 m 4406 3880 l 4304 3812 l 4413 3931 l 4457 3891 l cp
clip
n 3600 3000 m 4425 3900 l gs col-1 s gr gr

% arrowhead
n 4348 3771 m 4406 3880 l 4304 3812 l 4326 3792 l 4348 3771 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2207 2631 m 2237 2751 l 2154 2660 l 2231 2802 l 2284 2774 l cp
clip
n 1725 1800 m 2250 2775 l gs col-1 s gr gr

% arrowhead
n 2207 2631 m 2237 2751 l 2154 2660 l 2180 2646 l 2207 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 1695 m 873 1725 l 753 1755 l 915 1755 l 915 1695 l cp
clip
n 300 1725 m 900 1725 l gs col-1 s gr gr

% arrowhead
n 753 1695 m 873 1725 l 753 1755 l 753 1725 l 753 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 2220 m 873 2250 l 753 2280 l 915 2280 l 915 2220 l cp
clip
n 300 2250 m 900 2250 l gs col-1 s gr gr

% arrowhead
n 753 2220 m 873 2250 l 753 2280 l 753 2250 l 753 2220 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 5100 2775 m 6900 2775 l 6900 3300 l 5100 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 6525 2775 m 6525 3300 l gs col-1 s gr 
% Polyline
n 6150 2775 m 6150 3300 l gs col-1 s gr 
% Polyline
gs  clippath
4946 3863 m 4824 3888 l 4920 3809 l 4773 3879 l 4799 3934 l cp
clip
n 6675 3000 m 4800 3900 l gs col-1 s gr gr

% arrowhead
n 4946 3863 m 4824 3888 l 4920 3809 l 4933 3836 l 4946 3863 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
n 6900 1200 m 6000 1800 l gs col-1 s gr 
% Polyline
gs  clippath
5349 2634 m 5385 2752 l 5297 2666 l 5382 2803 l 5433 2772 l cp
clip
n 4800 1800 m 5400 2775 l gs col-1 s gr gr

% arrowhead
n 5349 2634 m 5385 2752 l 5297 2666 l 5323 2650 l 5349 2634 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 4425 1200 m 5325 1200 l 5325 1800 l 4425 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 5325 1200 m 4425 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 6000 1200 m 6900 1200 l 6900 1800 l 6000 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
gs  clippath
5722 2687 m 5624 2762 l 5675 2650 l 5575 2777 l 5622 2814 l cp
clip
n 6375 1800 m 5608 2784 l gs col-1 s gr gr

% arrowhead
n 5722 2687 m 5624 2762 l 5675 2650 l 5698 2668 l 5722 2687 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1350 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 1725 m
gs 1 -1 sc (x) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1275 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
2400 3225 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
5475 3225 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
6900 2700 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
6075 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
6825 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
6000 1125 m
gs 1 -1 sc (3) col-1 sh gr
/Helvetica ff 300.00 scf sf
4500 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
5250 1725 m
gs 1 -1 sc (S) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4500 4125 m
gs 1 -1 sc (A) col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 994 3257 a(Figure)f(4.20:)30 b(The)25 b(correct)h
(handling)d(of)i(the)g(erroneous)g(fork)300 3652 y(in)d(Figure)h(4.19.)
29 b(Gi)n(v)o(en)21 b(the)h(data)g(structures)g(in)l(v)n(olv)o(ed)f
(there)h(is)g(no)g(w)o(ay)h(for)f(process)h(three)f(to)g(kno)n(w)300
3801 y(that)i(it)h(needs)f(to)h(update)f(process)h(tw)o(o')-5
b(s)24 b(amap)g(pointer)h(to)f(point)g(at)h(the)f(ne)n(w)h(amap)f(it)h
(just)f(created.)583 3951 y(UVM)33 b(a)n(v)n(oids)g(this)f(problem)g
(by)h(checking)g(the)g(needs-cop)o(y)g(\003ag)h(on)f(the)g(parent)g
(process)300 4100 y(during)19 b(a)g(shared-inheritance)h(fork.)29
b(If)19 b(the)h(\003ag)f(is)g(set,)h(then)f(UVM)g(goes)g(on)h(and)f
(calls)g Fm(amap)p 3632 4100 30 4 v 35 w(copy)300 4249
y Fs(immediately)26 b(so)g(that)h(the)g(amap)h(to)f(be)g(shared)g(is)g
(created)h(before)g(a)g(problem)e(lik)o(e)h(the)g(one)g(sho)n(wn)300
4399 y(in)g(Figure)g(4.19)g(can)h(occur)-5 b(.)37 b(The)28
b(correct)f(handling)f(of)i(the)f(erroneous)g(fork)g(situation)f(is)h
(sho)n(wn)e(in)300 4548 y(Figure)g(4.20.)300 4879 y Ff(4.7.2)119
b(Copy)30 b(Inheritance)h(when)g(the)f(Amap)g(is)g(Shar)n(ed)300
5096 y Fs(When)j(forking)g(a)g(map)g(re)o(gion)f(with)h(cop)o(y)g
(inheritance,)i(the)e(fork)g(routine)f(must)g(also)h(be)g(careful)300
5245 y(with)e(the)i(handling)e(of)h(the)g(needs-cop)o(y)g(\003ag.)53
b(Consider)33 b(an)f(amap)g(that)g(is)g(being)f(shared)i(by)f(tw)o(o)
300 5395 y(processes.)56 b(The)33 b(amap)g(will)f(ha)n(v)o(e)h(its)g
(share)g(\003ag)h(set)f(and)g(a)g(reference)i(count)e(of)g(tw)o(o.)55
b(Suppose)p eop
%%Page: 97 117
97 116 bop 3800 100 a Fs(97)1633 1246 y @beginspecial
0 @llx 0 @lly 160 @urx 188 @ury 1120 @rwi @setspecial
%%BeginDocument: ../figures/cforkp3a.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-74.0 246.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4126 m 0 0 l 3940 0 l 3940 4126 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
2100 1725 m
gs 1 -1 sc (x) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 240.00 scf sf
3675 4050 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
30.000 slw
n 1275 1200 m 2175 1200 l 2175 1800 l 1275 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2175 1200 m 1275 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 2025 2775 m 3825 2775 l 3825 3300 l 2025 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3450 2775 m 3450 3300 l gs col-1 s gr 
% Polyline
n 3075 2775 m 3075 3300 l gs col-1 s gr 
% Polyline
gs  clippath
3630 3453 m 3600 3573 l 3570 3453 l 3570 3615 l 3630 3615 l cp
clip
n 3600 3000 m 3600 3600 l gs col-1 s gr gr

% arrowhead
n 3630 3453 m 3600 3573 l 3570 3453 l 3600 3453 l 3630 3453 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2207 2631 m 2237 2751 l 2154 2660 l 2231 2802 l 2284 2774 l cp
clip
n 1725 1800 m 2250 2775 l gs col-1 s gr gr

% arrowhead
n 2207 2631 m 2237 2751 l 2154 2660 l 2180 2646 l 2207 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2375 2692 m 2269 2755 l 2333 2650 l 2218 2764 l 2261 2807 l cp
clip
n 3225 1800 m 2250 2775 l gs col-1 s gr gr

% arrowhead
n 2375 2692 m 2269 2755 l 2333 2650 l 2354 2671 l 2375 2692 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 2775 1200 m 3675 1200 l 3675 1800 l 2775 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3675 1200 m 2775 1800 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
1350 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
1275 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
2400 3225 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
2850 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
3600 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2775 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
3900 2625 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
3450 3900 m
gs 1 -1 sc (A) col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1212 1450 a(Figure)25 b(4.21:)30 b(T)-8
b(w)o(o)24 b(processes)h(sharing)f(an)h(amap)300 1845
y(that)38 b(one)h(of)g(the)g(processes)g(mapping)e(the)i(map)g(has)f
(its)h(inheritance)f(v)n(alue)g(set)h(to)g(cop)o(y)-6
b(.)72 b(This)300 1994 y(con\002guration)27 b(is)f(sho)n(wn)g(in)h
(Figure)h(4.21.)37 b(Note)27 b(that)g(processes)g(one)g(and)g(tw)o(o)g
(should)f(be)i(sharing)300 2143 y(the)d(amap.)583 2293
y(No)n(w)f(suppose)g(process)g(tw)o(o)g(forks.)31 b(If)25
b(the)f(scheme)g(sho)n(wn)f(in)i(Figure)f(4.16)g(were)h(follo)n(wed)300
2442 y(the)g(result)g(w)o(ould)f(be)i(as)f(sho)n(wn)f(in)h(Figure)g
(4.22.)32 b(That)25 b(con\002guration)g(is)f(wrong.)32
b(A)25 b(write)g(f)o(ault)g(by)300 2592 y(an)o(y)f(of)h(the)g(three)g
(processes)g(will)e(cause)j(problems:)445 2824 y Fr(\017)49
b Fs(If)27 b(process)g(one)g(writes)f(to)g(a)h(page)g(in)g(the)f(amap)h
(process)g(tw)o(o)f(will)g(see)h(the)g(change)g(because)544
2973 y(it)i(is)g(sharing)g(the)h(same)f(amap)h(with)f(process)g(one.)46
b(Ho)n(we)n(v)o(er)l(,)29 b(process)h(three)g(will)f(also)g(see)544
3123 y(the)c(change)g(and)f(it)h(should)e(not.)445 3355
y Fr(\017)49 b Fs(If)23 b(process)f(tw)o(o)g(writes)g(to)g(a)h(page)f
(in)g(the)g(amap)h(the)f(needs-cop)o(y)g(\003ag)h(on)f(its)g(mapping)f
(w)o(ould)544 3505 y(cause)28 b(a)g(ne)n(w)f(amap)h(to)f(be)h
(allocated)f(to)h(store)f(the)h(changed)g(page.)39 b(This)27
b(is)g(wrong)h(because)544 3654 y(process)d(one)f(and)h(tw)o(o)f(are)i
(supposed)e(to)g(be)h(sharing)f(the)h(same)g(amap.)445
3886 y Fr(\017)49 b Fs(If)29 b(process)g(three)h(writes)f(to)f(the)h
(mapping)f(then)h(it)g(will)f(get)h(a)g(ne)n(w)g(amap)g(as)g(e)o
(xpected,)h(and)544 4036 y(the)36 b(cop)o(y-on-write)g(will)g(proceed)h
(normally)-6 b(.)65 b(Ho)n(we)n(v)o(er)35 b(process)h(tw)o(o)h(will)e
(still)h(ha)n(v)o(e)g(its)544 4185 y(needs-cop)o(y)d(\003ag)h(set)f
(after)h(process)g(three')-5 b(s)33 b(write)g(is)g(\002nished,)i(and)e
(that)g(will)g(lead)g(to)g(the)544 4335 y(problem)24
b(described)h(abo)o(v)o(e.)583 4567 y(The)k(correct)h(w)o(ay)f(to)g
(handle)f(a)i(cop)o(y-inherit)e(fork)h(when)f(the)h(amap)g(is)g(being)f
(shared)h(is)f(to)300 4716 y(use)23 b Fm(amap)p 702 4716
30 4 v 35 w(copy)f Fs(during)g(the)h(fork)g(to)f(immediately)f(clear)j
(needs-cop)o(y)f(in)f(the)h(child)f(process.)30 b(The)300
4866 y(correct)k(result)f(of)h(the)g(fork)f(is)h(sho)n(wn)e(in)h
(Figure)h(4.23.)57 b(The)34 b(share)g(\003ag)g(has)f(been)h(added)g(to)
f(the)300 5015 y(amap)25 b(structure)f(in)h(UVM)f(to)g(detect)h(this)f
(situation.)p eop
%%Page: 98 118
98 117 bop 3800 100 a Fs(98)1225 1793 y @beginspecial
0 @llx 0 @lly 300 @urx 184 @ury 2100 @rwi @setspecial
%%BeginDocument: ../figures/cforkp3b.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 241.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4051 m 0 0 l 5323 0 l 5323 4051 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
3675 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 240.00 scf sf
4575 3975 m
gs 1 -1 sc (1) col-1 sh gr
% Polyline
30.000 slw
n 2925 2700 m 4725 2700 l 4725 3225 l 2925 3225 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 4350 2700 m 4350 3225 l gs col-1 s gr 
% Polyline
n 3975 2700 m 3975 3225 l gs col-1 s gr 
% Polyline
gs  clippath
4530 3378 m 4500 3498 l 4470 3378 l 4470 3540 l 4530 3540 l cp
clip
n 4500 2925 m 4500 3525 l gs col-1 s gr gr

% arrowhead
n 4530 3378 m 4500 3498 l 4470 3378 l 4500 3378 l 4530 3378 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
3000 3000 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
3300 3150 m
gs 1 -1 sc (3) col-1 sh gr
/Helvetica ff 300.00 scf sf
4725 2625 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
% Polyline
30.000 slw
n 1275 1200 m 2175 1200 l 2175 1800 l 1275 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2175 1200 m 1275 1800 l gs col-1 s gr 
% Polyline
gs  clippath
3042 2596 m 3127 2685 l 3010 2647 l 3147 2733 l 3179 2683 l cp
clip
n 1725 1800 m 3150 2700 l gs col-1 s gr gr

% arrowhead
n 3042 2596 m 3127 2685 l 3010 2647 l 3026 2622 l 3042 2596 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
3192 2556 m 3152 2673 l 3132 2551 l 3119 2712 l 3179 2717 l cp
clip
n 3225 1800 m 3150 2700 l gs col-1 s gr gr

% arrowhead
n 3192 2556 m 3152 2673 l 3132 2551 l 3162 2554 l 3192 2556 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 1695 m 873 1725 l 753 1755 l 915 1755 l 915 1695 l cp
clip
n 300 1725 m 900 1725 l gs col-1 s gr gr

% arrowhead
n 753 1695 m 873 1725 l 753 1755 l 753 1725 l 753 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 2220 m 873 2250 l 753 2280 l 915 2280 l 915 2220 l cp
clip
n 300 2250 m 900 2250 l gs col-1 s gr gr

% arrowhead
n 753 2220 m 873 2250 l 753 2280 l 753 2250 l 753 2220 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 4350 1200 m 5250 1200 l 5250 1800 l 4350 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 5250 1200 m 4350 1800 l gs col-1 s gr 
% Polyline
30.000 slw
n 2775 1200 m 3675 1200 l 3675 1800 l 2775 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3675 1200 m 2775 1800 l gs col-1 s gr 
% Polyline
gs  clippath
3293 2656 m 3173 2687 l 3265 2603 l 3122 2681 l 3151 2734 l cp
clip
n 4800 1800 m 3150 2700 l gs col-1 s gr gr

% arrowhead
n 3293 2656 m 3173 2687 l 3265 2603 l 3279 2630 l 3293 2656 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1350 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 1725 m
gs 1 -1 sc (x) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1275 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
450 2025 m
gs 1 -1 sc (F) col-1 sh gr
/Helvetica ff 240.00 scf sf
600 2175 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
4425 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 1125 m
gs 1 -1 sc (3) col-1 sh gr
/Helvetica ff 300.00 scf sf
5250 1125 m
gs 1 -1 sc (NC) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2850 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
3600 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2775 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 3825 m
gs 1 -1 sc (A) col-1 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1285 1996 a(Figure)25 b(4.22:)30 b(Erroneous)25
b(cop)o(y-inherit)f(fork)963 4497 y @beginspecial 0 @llx
0 @lly 390 @urx 197 @ury 2730 @rwi @setspecial
%%BeginDocument: ../figures/cforkp3c.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-17.0 255.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4276 m 0 0 l 6823 0 l 6823 4276 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 240.00 scf sf
4575 4200 m
gs 1 -1 sc (2) col-1 sh gr
% Polyline
7.500 slw
n 5250 1200 m 4350 1800 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
4425 1500 m
gs 1 -1 sc (C) col-1 sh gr
/Helvetica ff 300.00 scf sf
5175 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 1125 m
gs 1 -1 sc (3) col-1 sh gr
% Polyline
30.000 slw
n 2025 2775 m 3825 2775 l 3825 3300 l 2025 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3450 2775 m 3450 3300 l gs col-1 s gr 
% Polyline
n 3075 2775 m 3075 3300 l gs col-1 s gr 
/Helvetica ff 300.00 scf sf
2100 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
2400 3225 m
gs 1 -1 sc (2) col-1 sh gr
% Polyline
30.000 slw
n 1275 1200 m 2175 1200 l 2175 1800 l 1275 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 2175 1200 m 1275 1800 l gs col-1 s gr 
% Polyline
gs  clippath
4205 3692 m 4257 3804 l 4159 3730 l 4261 3856 l 4308 3818 l cp
clip
n 3600 3000 m 4275 3825 l gs col-1 s gr gr

% arrowhead
n 4205 3692 m 4257 3804 l 4159 3730 l 4182 3711 l 4205 3692 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2207 2631 m 2237 2751 l 2154 2660 l 2231 2802 l 2284 2774 l cp
clip
n 1725 1800 m 2250 2775 l gs col-1 s gr gr

% arrowhead
n 2207 2631 m 2237 2751 l 2154 2660 l 2180 2646 l 2207 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
2375 2692 m 2269 2755 l 2333 2650 l 2218 2764 l 2261 2807 l cp
clip
n 3225 1800 m 2250 2775 l gs col-1 s gr gr

% arrowhead
n 2375 2692 m 2269 2755 l 2333 2650 l 2354 2671 l 2375 2692 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 1695 m 873 1725 l 753 1755 l 915 1755 l 915 1695 l cp
clip
n 300 1725 m 900 1725 l gs col-1 s gr gr

% arrowhead
n 753 1695 m 873 1725 l 753 1755 l 753 1725 l 753 1695 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
gs  clippath
753 2220 m 873 2250 l 753 2280 l 915 2280 l 915 2220 l cp
clip
n 300 2250 m 900 2250 l gs col-1 s gr gr

% arrowhead
n 753 2220 m 873 2250 l 753 2280 l 753 2250 l 753 2220 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 2775 1200 m 3675 1200 l 3675 1800 l 2775 1800 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 3675 1200 m 2775 1800 l gs col-1 s gr 
% Polyline
gs  clippath
5269 2631 m 5299 2751 l 5216 2660 l 5293 2802 l 5346 2774 l cp
clip
n 4787 1800 m 5312 2775 l gs col-1 s gr gr

% arrowhead
n 5269 2631 m 5299 2751 l 5216 2660 l 5242 2646 l 5269 2631 l  cp gs 0.00 setgray ef gr  col-1 s
% Polyline
30.000 slw
n 4950 2775 m 6750 2775 l 6750 3300 l 4950 3300 l cp gs col-1 s gr 
% Polyline
7.500 slw
n 6375 2775 m 6375 3300 l gs col-1 s gr 
% Polyline
n 6000 2775 m 6000 3300 l gs col-1 s gr 
% Polyline
gs  clippath
4872 3794 m 4749 3814 l 4848 3739 l 4699 3803 l 4723 3858 l cp
clip
n 6567 3027 m 4725 3825 l gs col-1 s gr gr

% arrowhead
n 4872 3794 m 4749 3814 l 4848 3739 l 4860 3767 l 4872 3794 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
1350 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
2100 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
1275 1125 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
450 2025 m
gs 1 -1 sc (F) col-1 sh gr
/Helvetica ff 240.00 scf sf
600 2175 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
3825 2700 m
gs 1 -1 sc (SHARE) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2850 1500 m
gs 1 -1 sc (x) col-1 sh gr
/Helvetica ff 300.00 scf sf
3600 1725 m
gs 1 -1 sc (C) dup sw pop neg 0 rm  col-1 sh gr
/Helvetica ff 300.00 scf sf
2775 1125 m
gs 1 -1 sc (2) col-1 sh gr
/Helvetica ff 300.00 scf sf
5025 3075 m
gs 1 -1 sc (M) col-1 sh gr
/Helvetica ff 240.00 scf sf
5325 3225 m
gs 1 -1 sc (1) col-1 sh gr
/Helvetica ff 300.00 scf sf
4350 4050 m
gs 1 -1 sc (A) col-1 sh gr
% Polyline
30.000 slw
n 4350 1200 m 5250 1200 l 5250 1800 l 4350 1800 l cp gs col-1 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 1285 4701 a(Figure)h(4.23:)30 b(Erroneous)25
b(cop)o(y-inherit)f(fork)p eop
%%Page: 99 119
99 118 bop 3800 100 a Fs(99)300 249 y Ff(4.7.3)119 b(Copy)30
b(Inheritance)h(of)e(a)h(Shar)n(ed)h(Mapping)300 466
y Fs(By)f(def)o(ault)g(a)h(shared)f(mapping')-5 b(s)28
b(inheritance)i(is)g(share.)46 b(Ho)n(we)n(v)o(er)l(,)30
b(a)h(shared)f(mapping')-5 b(s)28 b(inheri-)300 615 y(tance)h(can)g(be)
g(changed)f(to)g(cop)o(y)h(by)f(the)g Fm(minherit)f Fs(system)h(call.)
42 b(Shared)29 b(mappings)e(normally)300 764 y(do)e(not)g(ha)n(v)o(e)h
(amaps)f(associated)g(with)g(them)g(\(because)h(there)g(is)f(no)g(need)
h(to)f(promote)g(their)g(data)g(to)300 914 y(an)31 b(amap)f(for)h(cop)o
(y-on-write\).)47 b(Ho)n(we)n(v)o(er)l(,)31 b(with)e(UVM)h(certain)h
(operations)f(can)h(cause)f(amaps)g(to)300 1063 y(be)f(allocated)g(for)
g(shared)h(re)o(gions.)42 b(In)29 b(the)g(unusual)f(case)i(of)f(a)h
(shared)f(mapping)f(ha)n(ving)g(an)h(amap)300 1213 y(and)c(cop)o(y)f
(inheritance,)h(the)f(mapping)g(is)g(handled)h(as)g(follo)n(ws)e(by)h
(fork:)445 1445 y Fr(\017)49 b Fs(The)32 b(data)g(in)g(the)g(amap)f
(layer)i(immediately)d(becomes)i(cop)o(y-on-write)f(in)h(both)f(the)h
(parent)544 1594 y(and)25 b(child)f(process.)445 1827
y Fr(\017)49 b Fs(The)25 b(data)f(in)g(the)h(object)f(layer)h(remains)f
(shared)h(in)f(the)h(parent)f(process,)h(b)n(ut)f(becomes)g(cop)o(y-)
544 1976 y(on-write)g(in)h(the)f(child)h(process.)300
2307 y Ff(4.7.4)119 b(Copy)30 b(Inheritance)h(when)g(the)f(Map)g(Entry)
g(is)g(W)n(ir)n(ed)300 2524 y Fs(Memory)f(is)h(said)f(to)h(be)g(wired)g
(if)f(it)h(is)f(al)o(w)o(ays)h(resident)f(and)h(thus)f(ne)n(v)o(er)h
(has)g(to)f(be)h(fetched)g(from)300 2673 y(backing)g(store)h(during)f
(a)h(page)g(f)o(ault.)49 b(W)l(ired)31 b(memory)f(is)g(used)h(to)f
(impro)o(v)o(e)f(the)i(performance)g(of)300 2823 y(time-critical)k
(processes)h(by)g(reducing)f(page)h(f)o(ault)g(o)o(v)o(erhead.)63
b(If)37 b(a)f(process)g(with)f(a)i(wired)e(map)300 2972
y(entry)d(whose)g(inheritance)g(v)n(alue)f(is)h(cop)o(y)g(forks,)i
(then)e(the)g(child)f(process)i(will)e(w)o(ant)h(a)g(cop)o(y-on-)300
3122 y(write)26 b(cop)o(y)g(of)g(the)g(re)o(gion.)34
b(Ho)n(we)n(v)o(er)l(,)26 b(in)f(order)i(to)f(do)g(that)f(the)h
(parent')-5 b(s)26 b(mapping)f(w)o(ould)h(ha)n(v)o(e)f(to)300
3271 y(be)g(protected.)30 b(In)25 b(order)g(to)g(k)o(eep)g(f)o(ault)f
(time)g(do)n(wn)g(this)g(is)g(to)h(be)g(a)n(v)n(oided.)583
3420 y(So,)36 b(in)c(the)h(case)g(of)g(wired)g(memory)-6
b(,)33 b(rather)g(than)g(follo)n(wing)e(the)h(normal)h(cop)o
(y-on-write)300 3570 y(pattern,)26 b(the)f(fork)h(routine)f(calls)h
(the)f Fm(amap)p 1877 3570 30 4 v 35 w(cow)p 2092 3570
V 35 w(now)h Fs(function.)32 b(This)25 b(function)g(ensures)h(that)f
(the)300 3719 y(child)i(process)h(has)g(an)g(amap)g(and)g(that)g(all)f
(cop)o(y-on-write)h(f)o(aults)f(ha)n(v)o(e)h(been)g(resolv)o(ed.)40
b(By)28 b(doing)300 3869 y(this,)e(the)g(parent)h(pays)f(the)h
(up-front)f(cost)g(of)h(resolving)e(all)i(cop)o(y-on-write)f(f)o(aults)
g(in)g(one)g(shot)g(and)300 4018 y(a)n(v)n(oids)e(ha)n(ving)g(its)g
(mappings)g(protected)g(for)h(deferred)h(cop)o(y-on-write)e(f)o(aults.)
300 4402 y Fg(4.8)143 b(Summary)300 4654 y Fs(In)37 b(this)f(chapter)h
(we)g(ha)n(v)o(e)f(re)n(vie)n(wed)g(the)h(function)f(of)h(anon)o(ymous)
e(memory)h(in)g(UVM.)g(W)-8 b(e)37 b(in-)300 4804 y(troduced)d(the)h
(amap)g(interf)o(ace)g(and)g(described)g(UVM')-5 b(s)33
b(reference)k(amap)d(implementation.)59 b(W)-8 b(e)300
4953 y(e)o(xplained)24 b(ho)n(w)g(UVM)h(handles)f(partial)h(unmaps)f
(of)h(re)o(gions)f(of)h(anon)o(ymous)e(memory)h(ef)n(\002ciently)-6
b(.)300 5102 y(W)e(e)26 b(then)e(e)o(xplained)g(the)h(role)h(of)f
(amaps)g(in)f(cop)o(y-on-write)h(and)g(ho)n(w)f(Mach-style)h(memory)f
(inher)n(-)300 5252 y(itance)h(interacts)f(with)g(the)h(amap)g(system.)
p eop
%%Page: 100 120
100 119 bop 3751 100 a Fs(100)300 973 y Fp(Chapter)51
b(5)300 1448 y(Handling)h(P)n(age)g(F)-5 b(aults)300
1930 y Fs(This)31 b(chapter)h(describes)g(the)f(operation)h(of)g
Fm(uvm)p 2100 1930 30 4 v 35 w(fault)p Fs(,)g(the)g(UVM)f(page)h(f)o
(ault)g(handler)-5 b(.)51 b(P)o(age)300 2079 y(f)o(aults)19
b(occur)h(when)g(a)g(process)g(or)f(the)h(k)o(ernel)g(attempts)e(to)i
(read)g(or)g(write)f(virtual)g(memory)g(that)g(is)h(not)300
2229 y(mapped)28 b(to)h(allo)n(w)f(such)g(an)h(access.)43
b(This)28 b(chapter)i(includes)e(an)g(o)o(v)o(ervie)n(w)g(of)h(UVM')-5
b(s)27 b(page)i(f)o(ault)300 2378 y(handling,)23 b(a)h(discussion)e(of)
j(error)f(reco)o(v)o(ery)g(in)f(the)h(f)o(ault)g(handler)l(,)g(and)g(a)
g(comparison)f(between)h(the)300 2527 y(BSD)k(VM')-5
b(s)27 b(f)o(ault)g(routine)g(and)g(UVM')-5 b(s)27 b(f)o(ault)g
(routine.)38 b(Note)27 b(that)g(the)h(ef)n(fect)g(of)f(page)h(loanout)e
(on)300 2677 y(the)f(f)o(ault)f(routine)g(is)h(described)f(in)h
(Chapter)g(7.)300 3056 y Fg(5.1)143 b(P)o(age)34 b(F)l(ault)h(Ov)o(er)o
(view)300 3308 y Fs(The)25 b(page)f(f)o(ault)h(handler)f(is)g(called)h
(by)f(lo)n(w-le)n(v)o(el)f(machine-dependent)g(code)i(when)g(the)f(MMU)
g(de-)300 3458 y(tects)h(a)g(memory)f(access)i(that)f(causes)g(a)g
(page)h(f)o(ault.)31 b(The)25 b(f)o(ault)g(handler)g(must)f(use)h(the)g
(information)300 3607 y(stored)i(in)g(the)h(machine-independent)e
(layer)i(of)g(the)f(virtual)g(memory)f(system)h(to)g(resolv)o(e)g(the)g
(f)o(ault)300 3757 y(so)33 b(that)h(the)f(f)o(aulting)g(process)h(can)g
(resume)f(e)o(x)o(ecution.)56 b(If)34 b(the)g(page)g(f)o(ault)f
(handler)h(is)f(unable)g(to)300 3906 y(resolv)o(e)i(the)g(f)o(ault,)j
(an)e(error)g(signal)e(is)h(sent)h(to)f(the)g(f)o(aulting)g(process.)62
b(There)36 b(are)g(tw)o(o)g(kinds)e(of)300 4055 y(page)29
b(f)o(aults:)37 b(read)29 b(f)o(aults)f(and)h(write)f(f)o(aults.)42
b(A)28 b(read)h(f)o(ault)g(occurs)f(when)h(a)g(process)f(or)h(the)f(k)o
(ernel)300 4205 y(attempts)g(to)i(read)g(from)g(unmapped)f(virtual)g
(memory)-6 b(.)44 b(A)30 b(write)f(f)o(ault)h(occurs)g(when)f(a)h
(process)g(or)300 4354 y(the)g(k)o(ernel)g(attempts)e(to)i(write)f(to)h
(unmapped)f(virtual)g(memory)g(or)h(write)f(to)h(a)g(read-only)g
(mapped)300 4504 y(page)25 b(of)g(virtual)f(memory)-6
b(.)583 4653 y(In)37 b(the)f(BSD)h(VM)f(system,)h(the)g(page)f(f)o
(ault)g(routine)f(handles)h(page)g(f)o(aults)g(by)g(tra)n(v)o(ersing)
300 4802 y(shado)n(w)25 b(and)h(cop)o(y)g(object)g(chains,)g(as)h
(described)f(earlier)g(in)g(Section)g(2.4.5.)35 b(Because)27
b(UVM)f(has)g(a)300 4952 y(ne)n(w)h(pager)h(interf)o(ace)f(and)h(no)f
(longer)g(has)g(shado)n(w)f(and)h(cop)o(y)g(object)g(chains,)h(the)f
(BSD)h(VM)f(page)300 5101 y(f)o(ault)e(routine)f(cannot)g(be)h(used)g
(in)f(UVM)g(\227)h(it)f(is)h(no)f(longer)h(applicable.)583
5251 y(UVM)33 b(includes)f(a)h(brand-ne)n(w)f(page)h(f)o(ault)g
(routine)f(that)h(is)f(simpler)l(,)i(more)e(ef)n(\002cient,)j(and)300
5400 y(easier)29 b(to)f(understand)f(than)i(the)f(BSD)h(VM')-5
b(s)27 b(f)o(ault)i(routine.)40 b(At)28 b(a)h(high-le)n(v)o(el,)e(UVM')
-5 b(s)28 b(page)g(f)o(ault)p eop
%%Page: 101 121
101 120 bop 3751 100 a Fs(101)300 213 y Fm(uvm_fault\(\))57
b({)420 333 y(look)h(up)i(faulting)e(address')g(map)h(entry;)420
453 y(if)g(\(data)g(is)g(in)g(amap)g(layer\))f({)i(/*)f(case)g(1)h(*/)
539 574 y(handle)f(any)g(copy-on-write)d(processing;)539
694 y(map)j(page)g(and)g(return)g(success;)420 814 y(})g(else)g(if)g
(\(data)g(is)g(in)h(uvm_object)d(layer\))i({)g(/*)g(case)g(2)h(*/)539
935 y(handle)f(any)g(copy-on-write)d(processing;)539
1055 y(map)j(page)g(and)g(return)g(success;)420 1176
y(})g(else)g({)119 b(/*)60 b(missing)e(data)h(*/)539
1296 y(return)g(error;)420 1416 y(})300 1537 y(})994
1740 y Fs(Figure)25 b(5.1:)30 b(High-le)n(v)o(el)23 b(pseudo)h(code)h
(for)g(the)g(f)o(ault)g(routine)300 2135 y(routine)j(operates)g(by)h
(\002rst)f(looking)f(up)i(the)f(f)o(aulting)f(address)i(in)f(the)g(f)o
(aulting)g(process')g(VM)h(map.)300 2285 y(Once)d(the)g(appropriate)g
(map)g(entry)g(is)f(found)h(the)g(f)o(ault)g(routine)f(must)g(check)i
(for)f(the)g(f)o(aulting)f(page)300 2434 y(in)j(each)h(of)g(UVM')-5
b(s)27 b(tw)o(o-le)n(v)o(els)g(of)h(mapping.)41 b(The)28
b(f)o(ault)h(routine)e(\002rst)i(checks)g(the)f(amap)g(le)n(v)o(el)f
(to)300 2583 y(see)c(if)g(the)g(f)o(aulting)f(page)i(is)e(part)h(of)h
(anon)o(ymous)d(memory)-6 b(.)28 b(If)c(not,)f(then)f(the)h(f)o(ault)g
(routine)g(requests)300 2733 y(the)34 b(f)o(aulting)g(page)h(from)f
(the)g(the)h Fm(uvm)p 1750 2733 30 4 v 35 w(object)e
Fs(associated)h(with)g(the)g(f)o(aulting)g(map)g(entry)-6
b(.)59 b(In)300 2882 y(either)32 b(case,)j(if)d(a)g(cop)o(y-on-write)g
(f)o(ault)g(is)g(detected)g(a)h(ne)n(w)e(anon)h(is)g(allocated)g(and)g
(inserted)g(into)300 3032 y(the)j(amap)f(at)h(the)f(appropriate)h
(position.)58 b(Finally)-6 b(,)36 b(the)f(f)o(ault)f(routine)g
(establishes)g(a)h(mapping)e(in)300 3181 y(the)d(f)o(aulting)f
(process')h(pmap)g(and)g(returns)f(successfully)-6 b(.)45
b(High-le)n(v)o(el)29 b(pseudo)g(code)h(for)h(the)e(f)o(ault)300
3330 y(routine)k(is)g(sho)n(wn)f(in)i(Figure)g(5.1.)56
b(The)34 b(remainder)g(of)f(Section)h(5.1)f(describes)h(the)f
(step-by-step)300 3480 y(operation)24 b(of)h(UVM')-5
b(s)24 b(page)h(f)o(ault)f(routine.)300 3811 y Ff(5.1.1)119
b(Calling)31 b Fb(uvm)p 1284 3811 36 4 v 42 w(fault)300
4028 y Fs(UVM')-5 b(s)27 b(f)o(ault)h(routine)g(is)g(called)g(from)g
(the)g(machine-dependent)g(code)g(with)g(the)g(follo)n(wing)e(infor)n
(-)300 4177 y(mation:)300 4409 y Fo(faulting)f(virtual)g(addr)n(ess:)50
b Fs(The)37 b(machine-dependent)f(code)i(obtains)e(from)h(the)g(MMU)g
(the)g(ad-)544 4559 y(dress)25 b(that)f(w)o(as)h(accessed)g(in)f
(virtual)h(memory)e(to)i(trigger)f(the)h(page)g(f)o(ault.)300
4791 y Fo(faulting)g Fd(vm)p 783 4791 30 4 v 35 w(map)p
Fo(:)49 b Fs(Based)37 b(on)g(the)f(f)o(aulting)g(virtual)g(address,)k
(hardw)o(are)d(information,)h(and)f(the)544 4941 y(pointer)22
b(to)f(the)i(currently)f(running)f(process)h(the)g(machine-dependent)g
(code)g(must)g(determine)544 5090 y(if)28 b(the)h(f)o(ault)f(occurred)h
(in)f(memory)f(managed)i(by)f(the)g(current)h(process')f
Fm(vm)p 3301 5090 V 36 w(map)g Fs(or)g(by)g(the)544 5239
y(k)o(ernel')-5 b(s)24 b Fm(vm)p 1009 5239 V 36 w(map)p
Fs(.)30 b(The)25 b(f)o(aulting)e(map)i(is)f(passed)h(to)f(the)h(f)o
(ault)f(routine.)p eop
%%Page: 102 122
102 121 bop 3751 100 a Fs(102)300 249 y Fo(fault)25 b(type:)50
b Fs(Based)34 b(on)f(information)f(from)h(the)g(hardw)o(are,)k(the)c
(machine-dependent)g(code)g(must)544 398 y(determine)38
b(the)g(type)g(of)h(page)f(f)o(ault)h(that)f(occurred.)72
b(The)38 b(f)o(ault)g(type)h(is)f(\223in)l(v)n(alid\224)f(if)h(the)544
548 y(virtual)c(address)h(being)g(accessed)g(w)o(as)g(not)g(mapped.)61
b(The)35 b(f)o(ault)g(type)f(is)h(\223protect\224)g(if)g(the)544
697 y(virtual)27 b(address)h(being)g(access)h(w)o(as)f(mapped,)h(b)n
(ut)e(the)h(access)h(violated)e(the)h(protections)f(on)544
847 y(the)34 b(mapping)f(\(e.g.)60 b(writing)34 b(to)g(a)h(read-only)f
(mapping\).)59 b(Finally)-6 b(,)36 b(there)e(is)g(an)h(internally)544
996 y(used)24 b(f)o(ault)h(type,)f(\223wire,)-7 b(\224)26
b(that)e(is)g(used)h(when)g(wiring)f(pages.)300 1228
y Fo(access)h(type:)49 b Fs(Based)28 b(on)f(information)e(from)i(the)f
(hardw)o(are,)i(the)f(machine-dependent)f(code)h(must)544
1378 y(determine)j(if)h(the)g(f)o(aulting)f(process)h(w)o(as)h(reading)
e(or)i(writing)e(memory)g(at)h(the)g(time)f(of)h(the)544
1527 y(f)o(ault.)f(This)24 b(is)h(the)f(f)o(ault)h(access)g(type.)300
1760 y(The)31 b(f)o(ault)g(routine)f(will)g(use)h(these)g(four)g
(pieces)g(of)g(information)e(to)i(process)f(the)h(f)o(ault.)49
b(Once)31 b(the)300 1909 y(f)o(ault)c(routine)f(has)h(resolv)o(ed)f
(the)h(f)o(ault)g(it)f(returns)h(a)h(status)e(v)n(alue)g(to)h(the)g
(machine-dependent)f(code)300 2058 y(that)34 b(called)f(it.)58
b(The)34 b(f)o(ault)g(routine)f(will)g(either)h(return)g
(\223success\224)g(indicating)f(that)h(the)f(f)o(ault)h(w)o(as)300
2208 y(resolv)o(ed)c(and)i(that)f(the)g(f)o(aulting)f(process)h(can)h
(resume)f(running,)h(or)g(it)f(will)f(return)h(an)h(error)g(code)300
2357 y(that)e(indicates)g(that)g(f)o(aulting)f(process)h(should)f(be)i
(sent)f(an)g(error)i(signal.)46 b(If)31 b(there)g(is)f(an)g(error)h
(and)300 2507 y(the)25 b(f)o(aulting)e(process)i(is)g(the)f(k)o(ernel)h
(the)g(system)e(will)h(usually)g(crash)h(\(\223panic\224\).)300
2838 y Ff(5.1.2)119 b(F)m(ault)30 b(Addr)n(ess)g(Lookup)300
3054 y Fs(The)24 b(\002rst)f(step)g(in)g(handling)g(a)h(page)f(f)o
(ault)h(is)f(to)g(determine)g(what)g(data)h(is)f(mapped)g(in)g(at)h
(the)f(f)o(aulting)300 3204 y(address.)31 b(This)23 b(information)h(is)
g(contained)g(in)g(the)h(f)o(aulting)f Fm(vm)p 2564 3204
30 4 v 35 w(map)g Fs(structure')-5 b(s)24 b(sorted)g(link)o(ed)g(list)
300 3353 y(of)i(map)f(entries.)32 b(Looking)24 b(up)h(the)h(f)o
(aulting)e(address)h(in)h(the)f(map)g(is)g(simply)f(a)i(matter)f(of)g
(searching)300 3503 y(the)j(link)o(ed)g(list)g(for)g(the)h(map)f(entry)
g(structure)h(that)f(maps)g(the)g(f)o(aulting)g(address)3188
3466 y Fj(1)3225 3503 y Fs(.)42 b(Ho)n(we)n(v)o(er)l(,)28
b(there)300 3652 y(are)c(tw)o(o)g(issues)f(that)g(complicate)g(the)g
(process:)30 b(map)23 b(locking)g(and)h(map)f(entries)h(that)f(point)f
(to)i(share)300 3801 y(maps)g(or)h(submaps.)583 3951
y(Ev)o(ery)c(map)f(structure)h(has)f(its)g(o)n(wn)g(lock.)29
b(Map)21 b(are)g(read)g(lock)o(ed)g(while)f(the)o(y)g(are)h(being)g
(read)300 4100 y(and)26 b(write)g(lock)o(ed)g(while)g(the)o(y)g(are)h
(being)f(modi\002ed.)34 b(A)27 b(read-lock)o(ed)f(map)g(and)g(its)g
(corresponding)300 4250 y(map)21 b(entry)h(structures)f(cannot)h(be)g
(modi\002ed.)29 b(Multiple)20 b(processes)i(can)g(ha)n(v)o(e)f(a)h(map)
g(read-lock)o(ed)g(at)300 4399 y(the)h(same)g(time.)29
b(If)24 b(a)f(process)g(or)g(the)g(k)o(ernel)g(w)o(ants)g(to)g(change)g
(the)g(mappings)e(in)i(a)g(map,)g(it)g(must)f(be)300
4548 y(write-lock)o(ed.)30 b(A)25 b(map)g(can)g(be)g(write-lock)o(ed)f
(only)g(if)h(it)f(is)h(not)f(already)h(read-lock)o(ed)g(and)g(only)f
(one)300 4698 y(process)f(can)g(write-lock)f(a)i(map)e(at)h(a)g(time.)
29 b(When)23 b(the)g(f)o(ault)g(routine)f(is)g(called,)h(the)g(f)o
(aulting)f(map)h(is)300 4847 y(unlock)o(ed.)33 b(The)25
b(f)o(ault)h(routine)f(read-locks)h(the)f(map)h(in)f(order)h(to)f
(lookup)g(the)g(f)o(aulting)g(address.)33 b(As)300 4997
y(long)24 b(as)g(the)h(f)o(ault)f(routine)g(holds)f(the)h(read-lock)h
(on)f(the)h(map)f(then)g(the)g(address)h(lookup)e(is)h(v)n(alid.)30
b(If)p 300 5086 1440 4 v 416 5147 a Fi(1)449 5178 y Fh(Since)19
b(a)f(linear)g(search)g(of)g(a)h(link)o(ed)f(list)h(can)f(get)g(e)o
(xpensi)n(v)o(e)f(if)h(the)h(list)g(is)g(long,)f(the)g(lookup)f(code)g
(caches)h(the)h(result)300 5277 y(of)i(the)h(last)g(lookup)e(in)i(a)g
(map)f(as)h(a)g(\223hint\224)f(as)h(to)g(where)f(to)h(start)g(the)f(ne)
o(xt)g(lookup.)27 b(This)22 b(reduces)f(the)g(o)o(v)o(erhead)e(of)j
(the)300 5377 y(search.)p eop
%%Page: 103 123
103 122 bop 3751 100 a Fs(103)624 1602 y @beginspecial
0 @llx 0 @lly 506 @urx 249 @ury 3542 @rwi @setspecial
%%BeginDocument: ../figures/ufi.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-18.0 299.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 5023 m 0 0 l 8759 0 l 8759 5023 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
4500 2625 m
gs 1 -1 sc (parent_map) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1875 m
gs 1 -1 sc (original faulting address) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 2250 m
gs 1 -1 sc (original fault size) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 4500 m
gs 1 -1 sc (address in current map) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 2625 m
gs 1 -1 sc (parent map) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 4125 m
gs 1 -1 sc (current map entry) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 3375 m
gs 1 -1 sc (current map) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 3750 m
gs 1 -1 sc (current map version) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 3000 m
gs 1 -1 sc (parent map version) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 4875 m
gs 1 -1 sc (size of current lookup) dup sw pop neg 0 rm  col0 sh gr
7.500 slw
% Ellipse
n 5400 1425 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6441 1388 m 6575 1425 l 6441 1463 l 6615 1463 l 6615 1388 l cp
clip
n 5400 1425 m 6600 1425 l gs col-1 s gr gr

% arrowhead
n 6441 1388 m 6575 1425 l 6441 1463 l 6441 1425 l 6441 1388 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
6750 1500 m
gs 1 -1 sc (vm_map) col0 sh gr
% Ellipse
n 5400 2550 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6441 2513 m 6575 2550 l 6441 2588 l 6615 2588 l 6615 2513 l cp
clip
n 5400 2550 m 6600 2550 l gs col-1 s gr gr

% arrowhead
n 6441 2513 m 6575 2550 l 6441 2588 l 6441 2550 l 6441 2513 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
6750 2625 m
gs 1 -1 sc (vm_map) col0 sh gr
% Ellipse
n 5400 3300 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6441 3263 m 6575 3300 l 6441 3338 l 6615 3338 l 6615 3263 l cp
clip
n 5400 3300 m 6600 3300 l gs col-1 s gr gr

% arrowhead
n 6441 3263 m 6575 3300 l 6441 3338 l 6441 3300 l 6441 3263 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
6750 3375 m
gs 1 -1 sc (vm_map) col0 sh gr
% Ellipse
n 5400 4050 45 45 0 360 DrawEllipse gs 0.00 setgray ef gr gs col-1 s gr

% Polyline
gs  clippath
6441 4013 m 6575 4050 l 6441 4088 l 6615 4088 l 6615 4013 l cp
clip
n 5400 4050 m 6600 4050 l gs col-1 s gr gr

% arrowhead
n 6441 4013 m 6575 4050 l 6441 4088 l 6441 4050 l 6441 4013 l  cp gs 0.00 setgray ef gr  col-1 s
/Helvetica ff 300.00 scf sf
6750 4125 m
gs 1 -1 sc (vm_map_entry) col0 sh gr
% Polyline
n 3600 1575 m 5400 1575 l gs col0 s gr 
% Polyline
n 3600 1950 m 5400 1950 l gs col0 s gr 
% Polyline
n 3600 2325 m 5400 2325 l gs col0 s gr 
% Polyline
n 3600 2700 m 5400 2700 l gs col0 s gr 
% Polyline
n 3600 3075 m 5400 3075 l gs col0 s gr 
% Polyline
n 3600 3450 m 5400 3450 l gs col0 s gr 
% Polyline
n 3600 3825 m 5400 3825 l gs col0 s gr 
% Polyline
n 3600 4575 m 5400 4575 l gs col0 s gr 
% Polyline
n 3600 4200 m 5400 4200 l gs col0 s gr 
% Polyline
30.000 slw
n 3600 1200 m 5400 1200 l 5400 4950 l 3600 4950 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4500 2250 m
gs 1 -1 sc (orig_size) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1500 m
gs 1 -1 sc (orig_map) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1875 m
gs 1 -1 sc (orig_rvaddr) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 4875 m
gs 1 -1 sc (size) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4500 1050 m
gs 1 -1 sc (uvm_faultinfo) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 4500 m
gs 1 -1 sc (rvaddr) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3000 m
gs 1 -1 sc (parentv) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3375 m
gs 1 -1 sc (map) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3750 m
gs 1 -1 sc (mapv) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 4125 m
gs 1 -1 sc (entry) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1500 m
gs 1 -1 sc (original faulting map) dup sw pop neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1805 a(Figure)31 b(5.2:)42 b(The)31
b(f)o(aultinfo)f(data)h(structure.)48 b(The)31 b(\002rst)g(three)g
(\002elds)g(are)g(\002lled)g(out)f(at)h(the)g(start)f(of)300
1926 y(the)f(f)o(ault)f(routine.)43 b(The)29 b(remaining)f(\002elds)h
(are)g(\002lled)g(up)g(by)f(the)h Fm(uvmfault)p 3152
1926 30 4 v 34 w(lookup)f Fs(function)300 2046 y(when)d(it)f(does)h
(the)f(map)h(lookup.)k(All)24 b(virtual)g(addresses)h(are)h(truncated)e
(to)h(a)g(page)g(boundary)-6 b(.)300 2441 y(the)30 b(f)o(ault)h
(routine)e(has)i(to)f(do)g(a)h(lengthy)e(I/O)h(operation)g(to)g(get)h
(the)f(needed)h(data,)h(then)e(it)g(unlocks)300 2591
y(the)k(f)o(aulting)e(map)i(so)f(that)g(other)h(processes)f(or)h
(threads)g(may)f(access)h(the)g(map)f(while)g(the)h(I/O)g(is)300
2740 y(in)29 b(progress.)45 b(Once)30 b(the)g(I/O)f(operation)g(is)g
(complete,)i(the)e(f)o(ault)g(routine)g(must)g(relock)h(the)f(map)g(to)
300 2889 y(check)c(that)g(its)f(mapping)f(is)i(still)e(v)n(alid.)583
3039 y(If)31 b(a)f(map)g(lookup)f(results)g(in)h(a)g(map)g(entry)g
(that)f(points)g(to)h(a)g(share)g(map)g(or)g(submap,)g(then)300
3188 y(the)i(lookup)f(must)g(be)h(repeated)h(in)f(that)f(map.)52
b(Since)33 b(map)f(entries)g(in)f(share)i(maps)e(and)h(submaps)300
3338 y(are)24 b(not)f(allo)n(wed)f(to)h(point)f(to)h(share)h(maps)e(or)
i(submaps)e(themselv)o(es,)g(only)g(tw)o(o)h(le)n(v)o(els)f(of)h(maps)g
(can)300 3487 y(be)i(encountered:)31 b(the)26 b(f)o(aulting)e(map)h
(\(called)g(the)g(\223parent)g(map\224\))h(and)f(the)g(share)g(or)h
(submap.)k(Note)300 3636 y(that)24 b(share)h(maps)g(and)f(submaps)g(ha)
n(v)o(e)h(their)f(o)n(wn)g(locks)g(that)h(must)e(be)i(held)g(during)f
(lookups.)583 3786 y(While)c(the)f(f)o(ault)g(routine)g(must)g(handle)g
(map)h(locking,)f(share)h(maps,)g(and)g(submaps)e(properly)-6
b(,)300 3935 y(the)32 b(details)g(can)g(be)h(isolated)e(in)h(a)g(data)h
(structure)f(and)g(a)g(fe)n(w)h(helper)f(functions)f(so)h(that)g(the)g
(b)n(ulk)300 4085 y(of)g(the)g(f)o(ault)g(routine)f(code)i(doesn')n(t)e
(ha)n(v)o(e)h(to)g(w)o(orry)g(about)f(ho)n(w)h(man)o(y)f(maps)g(it)h
(is)f(dealing)h(with.)300 4234 y(The)24 b(data)g(structure)g(that)g
(contains)f(information)f(on)i(the)g(current)g(mapping)f(of)h(the)g(f)o
(aulting)f(address)300 4383 y(is)36 b(called)h(the)f
Fm(uvm)p 1022 4383 V 36 w(faultinfo)e Fs(data)j(structure,)i(sho)n(wn)d
(in)g(Figure)h(5.2.)66 b(The)36 b(f)o(aultinfo)g(data)300
4533 y(structure)24 b(is)h(often)f(called)h(\223)p Fm(ufi)p
Fs(\224)g(for)g(short.)583 4682 y(The)e(\002rst)g(thing)f(the)h(f)o
(ault)g(routine)f(does)g(is)h(to)f(store)h(the)g(f)o(aulting)f(map,)h
(address,)g(and)g(size)f(in)300 4832 y(its)27 b(f)o(aultinfo)f(data)i
(structure.)38 b(F)o(or)28 b(page)g(f)o(aults,)f(the)g(f)o(ault)h(size)
f(is)g(al)o(w)o(ays)g(the)h(page)f(size)h(\(the)f(f)o(ault)300
4981 y(size)e(\002eld)g(is)f(for)h(use)g(by)g(other)f(functions)g(such)
g(as)h(page)g(loanout\).)583 5130 y(The)31 b(f)o(ault)g(routine)f(then)
g(calls)g(the)h Fm(uvmfault)p 2349 5130 V 34 w(lookup)e
Fs(function)h(to)h(look)e(up)i(the)f(map)300 5280 y(entry)f(that)g
(maps)g(the)g(f)o(aulting)f(address.)44 b(The)30 b(f)o(ault)f(lookup)f
(function)g(tak)o(es)h(a)h(f)o(aultinfo)e(structure)p
eop
%%Page: 104 124
104 123 bop 3751 100 a Fs(104)300 249 y(with)24 b(its)f(\002rst)i
(three)f(\002elds)h(\002lled)f(in)g(as)g(input.)30 b(It)24
b(then)g(locks)g(the)g(f)o(aulting)f(map,)h(and)h(does)f(a)g(lookup)300
398 y(on)31 b(the)g(f)o(aulting)f(address.)50 b(If)32
b(the)f(f)o(aulting)f(address)h(is)g(not)f(mapped,)j(the)e(lookup)f
(routine)g(returns)300 548 y(an)k(error)h(code.)58 b(If)34
b(the)g(f)o(aulting)e(address)i(is)g(in)f(a)h(re)o(gion)f(mapped)h(by)f
(a)h(share)g(or)g(submap,)h(then)300 697 y(the)26 b(lookup)g(routine)f
(mak)o(es)i(the)f(original)f(map)i(the)f(\223parent\224)h(map,)f(locks)
g(the)h(ne)n(w)f(map,)g(and)g(then)300 847 y(repeats)h(the)f(lookup)f
(in)h(the)g(ne)n(w)g(map.)35 b(If)27 b(the)f(lookup)f(is)h(successful,)
g(then)g(the)h(f)o(ault)f(lookup)f(func-)300 996 y(tion)h(will)g
(\002ll)h(in)g(the)f(remaining)g(se)n(v)o(en)g(\002elds)h(of)g(the)g(f)
o(aultinfo)f(structure.)37 b(F)o(or)27 b(f)o(aulting)f(addresses)300
1145 y(that)g(map)f(to)h(a)h(share)f(map)g(or)g(submap,)f(the)h
Fm(parent)p 2266 1145 30 4 v 35 w(map)f Fs(\002eld)i(will)e(point)g(to)
g(the)h(original)g(map,)300 1295 y(and)k(the)g Fm(map)f
Fs(\002eld)h(will)g(point)f(to)g(the)h(share)g(or)g(submap.)46
b(If)30 b(there)g(is)g(no)g(share)g(or)g(submap,)g(then)300
1444 y Fm(parent)p 666 1444 V 35 w(map)d Fs(will)g(be)h(null)f(and)h
Fm(map)g Fs(will)f(point)g(to)h(the)f(original)h(map.)40
b(Thus,)28 b(the)g(lo)n(west-le)n(v)o(el)300 1594 y(map)35
b(al)o(w)o(ays)g(ends)f(up)h(in)g(the)g Fm(map)f Fs(\002eld)i(of)f(the)
g(f)o(aultinfo)f(structure.)61 b(This)34 b(map)h(is)g(sometimes)300
1743 y(referred)d(to)e(as)h(the)g(\223current\224)g(map.)48
b(The)31 b Fm(entry)e Fs(\002eld)i(is)f(al)o(w)o(ays)h(a)g(map)f(entry)
h(in)f(this)g(map.)48 b(If)300 1892 y(successful,)24
b(the)h(lookup)f(function)g(returns)g(with)g(the)h(maps)f(lock)o(ed.)
583 2042 y(Note)30 b(that)f(the)h(f)o(aultinfo)f(structure)g(contains)g
(v)o(ersion)g(numbers)g(for)h(both)f(the)h(parent)f(map)300
2191 y(and)d(the)g(current)g(map.)34 b(If)27 b(the)e(f)o(ault)h
(routine)g(unlocks)f(a)h(map)g(for)g(I/O,)g(these)g(v)o(ersion)e
(numbers)i(can)300 2341 y(be)c(used)g(to)g(detect)g(if)h(the)f(map)g(w)
o(as)g(changed)g(while)g(unlock)o(ed.)29 b(If)23 b(the)f(map)g(w)o(as)g
(not)g(changed,)g(then)300 2490 y(the)27 b(f)o(ault)g(routine)g(kno)n
(ws)f(that)h(the)g(lookup)f(information)g(cached)i(in)f(its)f(f)o
(aultinfo)h(structure)g(is)f(still)300 2639 y(v)n(alid,)d(and)h(thus)g
(a)g(fresh)h(lookup)e(is)h(not)f(needed.)31 b(Ho)n(we)n(v)o(er)l(,)23
b(if)h(the)h(v)o(ersion)e(numbers)g(are)i(changed,)300
2789 y(then)h(the)f(f)o(ault)h(routine)f(must)g(repeat)h(the)g(lookup)e
(in)i(case)g(the)g(mappings)e(ha)n(v)o(e)i(changed)g(while)f(the)300
2938 y(map)f(w)o(as)h(unlock)o(ed.)583 3088 y(The)g(UVM)f(f)o(ault)h
(routine)f(has)g(four)h(helper)g(functions)e(relating)h(to)h(map)f
(lookups.)29 b(The)o(y)24 b(are)300 3237 y(summarized)g(in)g(T)-8
b(able)25 b(5.1.)300 3563 y Ff(5.1.3)119 b(P)n(ost-lookup)29
b(Checks)300 3779 y Fs(If)j(the)f(f)o(ault)h(routine')-5
b(s)30 b(call)h(to)h(the)f(f)o(ault)g(lookup)g(routine)f(f)o(ails,)j
(then)e(an)h(in)l(v)n(alid)e(address)h(error)i(is)300
3929 y(returned)c(to)g(the)g(caller)-5 b(.)43 b(If)29
b(the)g(lookup)f(w)o(as)h(successful,)h(then)e(the)h(current)h(map)e
(can)i(be)f(obtained)300 4078 y(through)35 b(the)g(f)o(aultinfo)g(data)
h(structure.)62 b(The)36 b(f)o(ault)f(routine)g(is)g(no)n(w)g(holding)f
(read-locks)i(on)f(the)300 4228 y(maps)24 b(in)g(the)h(f)o(aultinfo)f
(data)h(structure.)30 b(At)25 b(this)e(point)h(the)h(f)o(ault)f
(routine)g(can)h(perform)g(a)g(fe)n(w)g(quick)300 4377
y(checks)g(before)g(it)g(starts)f(looking)f(at)i(the)g(mapped)f(memory)
g(objects.)445 4580 y Fr(\017)49 b Fs(The)34 b(address')g(current)g
(protection)f(is)g(check)o(ed)h(with)f(the)h(type)g(of)f(access)i(that)
e(caused)h(the)544 4729 y(f)o(ault.)c(If)23 b(the)g(access)h(is)f(not)f
(allo)n(wed,)h(then)f(the)h(f)o(ault)g(routine)g(unlocks)f(the)h(maps)f
(and)h(returns)544 4879 y(a)33 b(protection)f(f)o(ailure)h(error)-5
b(.)55 b(F)o(or)32 b(e)o(xample,)i(if)f(a)g(process)g(has)g(a)g(write)f
(f)o(ault)h(to)f(an)h(area)h(of)544 5028 y(memory)24
b(mapped)g(read-only)-6 b(,)24 b(then)h(the)f(f)o(ault)h(routine)f(w)o
(ould)g(return)h(an)g(error)-5 b(.)445 5251 y Fr(\017)49
b Fs(The)33 b(needs-cop)o(y)g(\003ag)h(of)g(the)f(map)g(entry)g(is)g
(check)o(ed.)56 b(If)34 b(the)f(f)o(ault)g(is)g(a)h(write)f(f)o(ault)g
(or)g(if)544 5400 y(the)26 b(mapping)e(is)i(a)g(zero-\002ll)g(mapping,)
f(then)g(the)h(needs-cop)o(y)g(\003ag)g(will)f(need)h(to)f(be)h
(cleared.)p eop
%%Page: 105 125
105 124 bop 3751 100 a Fs(105)1436 300 y(T)-8 b(able)25
b(5.1:)30 b(F)o(ault)24 b(lookup)g(functions)p 532 432
3112 4 v 530 553 4 121 v 582 517 a Fo(Function)p 1742
553 V 830 w(Description)p 3641 553 V 532 556 3112 4 v
530 1158 4 602 v 582 640 a Fm(uvmfault)p 1068 640 30
4 v 34 w(lookup)p 1742 1158 4 602 v 337 w Fs(Looks)e(up)g(a)h(virtual)f
(address)g(in)g(a)h(map,)g(handling)1793 761 y(share)33
b(and)f(submaps.)52 b(The)32 b(virtual)f(address)h(and)1793
881 y(map)c(are)g(passed)g(to)f(this)g(function)g(in)h(a)g(f)o
(aultinfo)1793 1002 y(structure.)57 b(If)35 b(successful,)g(the)f
(lookup)e(function)1793 1122 y(returns)25 b(with)f(the)h(maps)f(lock)o
(ed.)p 3641 1158 V 532 1161 3112 4 v 530 1402 4 241 v
582 1246 a Fm(uvmfault)p 1068 1246 30 4 v 34 w(unlockmaps)p
1742 1402 4 241 v 97 w Fs(Unlocks)44 b(the)g(map)g(pointed)g(to)g(by)g
(a)h(f)o(aultinfo)1793 1366 y(structure.)p 3641 1402
V 532 1405 3112 4 v 530 2007 4 602 v 582 1490 a Fm(uvmfault)p
1068 1490 30 4 v 34 w(relock)p 1742 2007 4 602 v 337
w Fs(Attempts)c(to)i(relock)g(the)f(maps)h(pointed)e(to)i(by)1793
1610 y(a)55 b(f)o(aultinfo)e(structure)h(without)f(doing)g(a)i(ne)n(w)
1793 1730 y(lookup.)d(This)32 b(will)f(succeed)i(only)e(if)i(the)f
(maps')1793 1851 y(v)o(ersion)23 b(numbers)h(ha)n(v)o(e)g(not)g
(changed)g(since)g(the)o(y)1793 1971 y(were)i(lock)o(ed.)p
3641 2007 V 532 2011 3112 4 v 530 2251 4 241 v 582 2095
a Fm(uvmfault)p 1068 2095 30 4 v 34 w(unlockall)p 1742
2251 4 241 v 157 w Fs(Unlocks)32 b(an)i(anon,)h(amap,)f
Fm(uvm)p 3001 2095 30 4 v 36 w(object)p Fs(,)f(and)1793
2215 y(a)25 b(f)o(aultinfo)f(structure.)p 3641 2251 4
241 v 532 2255 3112 4 v 544 2628 a(This)32 b(is)g(done)g(by)g(calling)g
(the)g Fm(uvmfault)p 2155 2628 30 4 v 34 w(amapcopy)f
Fs(function.)52 b(This)32 b(function)g(drops)544 2778
y(the)f(read-lock)h(on)f(the)g(maps,)h(obtains)e(write-locks)h(on)g
(the)g(maps,)h(and)g(clears)f(needs-cop)o(y)544 2927
y(by)24 b(calling)g Fm(amap)p 1210 2927 V 35 w(copy)p
Fs(.)30 b(Then)25 b(the)g(f)o(ault)f(routine)g(restarts)h(the)g(f)o
(ault)f(processing.)445 3160 y Fr(\017)49 b Fs(Once)27
b(needs-cop)o(y)f(has)g(been)h(cleared,)g(the)g(f)o(ault)f(routine)g
(checks)g(the)g(current)h(map)f(entry)g(to)544 3309 y(ensure)34
b(that)f(it)g(has)h(something)e(mapped)h(in)g(at)h(one)f(of)h(the)g(tw)
o(o-le)n(v)o(els.)55 b(If)34 b(the)g(map)f(entry)544
3458 y(has)g(neither)g(an)h(amap)f(nor)h(a)g Fm(uvm)p
1828 3458 V 35 w(object)e Fs(attached)i(to)f(it,)i(then)e(there)h(are)g
(no)f(memory)544 3608 y(objects)24 b(associated)h(with)g(it.)31
b(In)25 b(this)f(case)i(the)f(f)o(ault)g(routine)f(unlocks)h(the)g
(maps)f(and)h(returns)544 3757 y(an)g(in)l(v)n(alid)e(address)i(error)
-5 b(.)300 4088 y Ff(5.1.4)119 b(Establishing)30 b(F)m(ault)g(Range)300
4305 y Fs(After)i(performing)f(the)h(post-lookup)d(check,)34
b(the)e(UVM)f(page)h(f)o(ault)f(routine)g(establishes)g(a)h(range)300
4454 y(of)i(pages)h(to)e(e)o(xamine)h(during)f(the)i(f)o(ault.)58
b(This)34 b(range)h(could)e(be)i(just)e(the)h(f)o(aulting)f(page)i
(\(called)300 4604 y(a)c(\223narro)n(w\224)g(f)o(ault\),)h(or)f(it)f
(could)g(include)g(se)n(v)o(eral)g(neighboring)f(pages.)49
b(The)30 b(size)h(of)g(the)f(range)i(is)300 4753 y(determined)f(by)h
(the)f(size)h(of)g(virtual)f(memory)g(mapped)h(by)f(the)h(map)f(entry)h
(and)g(the)f(map)h(entry')-5 b(s)300 4902 y(memory)32
b(usage)g(hint)g(\(the)h(\223advice\224)g(\002eld)g(in)f(the)h(map)f
(entry\).)54 b(F)o(or)33 b(sequential)e(memory)h(usage,)300
5052 y(pages)26 b(behind)g(the)g(f)o(aulting)g(page)h(are)g(\003ushed)f
(from)h(memory)-6 b(.)34 b(F)o(or)26 b(random)g(memory)g(access,)h(the)
300 5201 y(range)e(is)g(just)f(the)g(f)o(aulting)g(page.)31
b(Normal)24 b(memory)g(access)i(has)f(a)g(range)g(of)g(a)g(fe)n(w)g
(pages)g(in)f(either)300 5351 y(direction.)p eop
%%Page: 106 126
106 125 bop 3751 100 a Fs(106)300 249 y Ff(5.1.5)119
b(Mapping)31 b(Neighboring)g(Resident)g(P)o(ages)300
466 y Fs(After)g(establishing)d(the)i(range)g(of)h(f)o(ault,)g(the)f(f)
o(ault)g(routine)f(then)h(looks)f(for)i(neighboring)e(resident)300
615 y(pages)j(in)f(the)h(mapping')-5 b(s)30 b(amap.)52
b(If)32 b(a)h(neighboring)d(page)i(is)f(found)h(to)f(be)h(currently)g
(unmapped,)300 764 y(b)n(ut)26 b(is)g(resident,)g(then)g(the)g(f)o
(ault)g(routine)g(establishes)f(a)i(mapping)e(for)i(it.)34
b(This)26 b(is)g(done)g(in)g(hopes)g(of)300 914 y(reducing)e(future)h
(f)o(aults)f(by)g(anticipating)f(the)h(need)h(for)g(a)g(resident)f
(page)h(and)f(mapping)f(it)h(in)h(before)300 1063 y(the)g(f)o(ault)f
(occurs.)583 1213 y(UVM)32 b(currently)f(ignores)g(neighboring)g
(non-resident)g(anon)g(with)g(data)h(paged)g(out)f(to)g(the)300
1362 y(sw)o(ap)23 b(area.)31 b(A)23 b(possible)f(future)h(enhancement)g
(to)g(UVM)f(w)o(ould)h(be)g(to)g(modify)f(it)g(to)h(start)g(a)g
(page-in)300 1511 y(operation)28 b(on)h(these)g(pages)g(in)g(hopes)f
(of)i(ha)n(ving)e(them)g(resident)h(by)g(the)g(time)f(the)h(program)g
(f)o(aults)300 1661 y(them.)583 1810 y(If)22 b(the)f(f)o(ault)f
(routine)h(detected)g(that)f(a)h Fm(uvm)p 2094 1810 30
4 v 36 w(object)p Fs(')-5 b(s)19 b(page)i(is)g(needed)g(to)f(resolv)o
(e)h(the)f(f)o(ault)300 1960 y(then)30 b(it)f(looks)h(for)g(resident)g
(pages)g(in)g(that)f(object)h(as)g(well)2429 1923 y Fj(2)2466
1960 y Fs(.)47 b(The)30 b(f)o(ault)g(routine)f(gets)h(these)g(pages)300
2109 y(by)k(calling)g(the)h(object')-5 b(s)34 b(\223pager)h(get\224)g
(function.)59 b(Neighboring)33 b(object)i(pages)f(are)i(mapped)e(into)
300 2258 y(the)28 b(process)g(based)g(on)f(the)h(memory)f(usage)h
(hint.)40 b(Because)29 b(all)e(data)h(structures)g(are)h(lock)o(ed)e
(when)300 2408 y(the)h(get)h(function)f(is)g(called,)h(this)f(is)g
(called)h(a)g(\223lock)o(ed)g(get\224)f(operation.)42
b(If)29 b(the)f(f)o(aulted)h(data)f(is)h(not)300 2557
y(resident,)d(the)f(f)o(ault)h(routine)f(will)g(later)h(unlock)f(the)h
(f)o(ault)f(data)h(structure)g(and)g(call)g(the)f(get)h(function)300
2707 y(again)e(to)h(do)f(the)h(I/O)g(to)f(backing)g(store.)31
b(This)24 b(is)g(called)h(an)g(\223unlock)o(ed)f(get.)-7
b(\224)583 2856 y(After)27 b(the)g(neighboring)e(resident)i(pages)f
(are)i(mapped,)e(the)h(preliminary)e(w)o(ork)i(of)g(the)f(f)o(ault)300
3005 y(routine)c(is)h(done.)30 b(The)23 b(rest)g(of)g(the)g(f)o(ault)g
(routine)g(focuses)g(on)f(getting)g(the)h(page)h(that)e(w)o(as)h(f)o
(aulted)g(on)300 3155 y(mapped)e(in)g(to)g(resolv)o(e)g(the)h(f)o(ault)
f(and)g(allo)n(w)g(the)g(f)o(aulting)g(process)g(to)h(resume)f(e)o(x)o
(ecution.)28 b(In)22 b(UVM,)300 3304 y(page)27 b(f)o(aults)f(are)i(di)n
(vided)d(into)h(tw)o(o)g(major)g(cases)h(based)g(on)f(UVM')-5
b(s)26 b(tw)o(o-layer)h(mapping)e(scheme.)300 3454 y(F)o(aults)h(on)g
(data)h(in)g(the)f(upper)h(layer)g(are)h(\223case)f(1\224)g(or)g
(\223anon\224)g(f)o(aults.)36 b(F)o(aults)26 b(on)h(data)g(in)f(the)h
(lo)n(wer)300 3603 y(layer)e(are)h(\223case)f(2\224)g(or)g
(\223object\224)g(f)o(aults.)300 3934 y Ff(5.1.6)119
b(Anon)31 b(F)m(aults)300 4151 y Fs(In)22 b(an)f(anon)h(f)o(ault,)g
(the)f(data)h(being)f(f)o(aulted)g(resides)h(in)f(an)h(anon)f
(structure.)30 b(Thus,)21 b(the)h(content)f(of)g(the)300
4300 y(mapping')-5 b(s)27 b(object)h(layer)h(is)g(irrele)n(v)n(ant.)41
b(There)29 b(are)h(three)f(steps)f(in)l(v)n(olv)o(ed)f(in)h(processing)
g(an)h(anon)300 4450 y(f)o(ault:)39 b(ensuring)28 b(that)h(the)g(anon')
-5 b(s)28 b(data)i(is)e(resident,)i(handling)e(the)h(tw)o(o)g
(sub-cases)g(of)g(anon)g(f)o(aults,)300 4599 y(and)c(mapping)e(in)i
(the)f(page.)p 300 4689 1440 4 v 416 4750 a Fi(2)449
4780 y Fh(Certain)j(objects)g(need)f(to)h(ha)n(v)o(e)g(complete)f
(control)f(o)o(v)o(er)h(the)h(handling)e(of)i(their)f(f)o(aults.)46
b(In)26 b(this)i(case,)h(the)e(f)o(ault)300 4880 y(routine)19
b(passes)i(control)e(to)h(an)g(object')-5 b(s)20 b(f)o(ault)g(function)
f(to)h(let)h(it)g(resolv)o(e)e(the)h(f)o(ault)g(\(see)h(Section)f
(8.4\).)p eop
%%Page: 107 127
107 126 bop 3751 100 a Fs(107)300 249 y Fo(Ensuring)26
b(the)g(F)n(aulting)e(Data)h(is)f(Resident)300 466 y
Fs(The)37 b(\002rst)g(thing)f(that)h(the)g(f)o(ault)g(routine)f(must)g
(do)h(in)f(an)h(anon)g(f)o(ault)g(is)g(ensure)g(that)f(the)h(data)g(in)
300 615 y(the)32 b(f)o(aulting)f(anon)g(is)h(resident)f(in)h(an)g(a)n
(v)n(ailable)f(page)h(of)g(physical)e(memory)-6 b(.)51
b(This)31 b(is)g(done)h(with)300 764 y(the)26 b(\223anonget\224)h
(function)e(\(called)i Fm(uvmfault)p 2021 764 30 4 v
34 w(anonget)p Fs(\).)34 b(The)27 b(anonget)e(function)h(is)g(called)g
(by)300 914 y(the)33 b(f)o(ault)g(routine)f(with)g(f)o(aultinfo,)j
(amap,)g(and)e(anon)f(as)i(ar)n(guments.)54 b(These)34
b(structures)e(must)g(be)300 1063 y(lock)o(ed)27 b(before)h(the)f
(function)f(is)h(called.)38 b(The)28 b(anonget)e(function)h(must)f(be)h
(prepared)h(to)f(handle)g(the)300 1213 y(follo)n(wing)c(three)i(cases:)
445 1434 y Fr(\017)49 b Fo(non-r)n(esident:)33 b Fs(The)25
b(data)g(has)f(been)h(paged)g(out)f(to)h(the)g(sw)o(ap)f(area.)445
1663 y Fr(\017)49 b Fo(una)n(v)o(ailable)20 b(r)n(esident)h(page:)29
b Fs(The)21 b(data)f(is)g(resident,)g(b)n(ut)g(the)g(page)h(it)f
(resides)g(in)g(is)f(currently)544 1812 y(b)n(usy)-6
b(.)445 2041 y Fr(\017)49 b Fo(a)n(v)o(ailable)23 b(r)n(esident)j
(page:)32 b Fs(The)25 b(data)f(is)h(resident)f(and)h(its)f(page)h(is)f
(a)n(v)n(ailable)g(for)h(use.)300 2263 y(Each)g(of)g(these)g(cases)g
(is)f(described)h(belo)n(w)-6 b(.)583 2412 y(If)25 b(the)f(data)g(is)g
(non-resident,)f(then)h(the)g(anonget)g(function)f(mak)o(es)h(it)f
(resident.)30 b(This)24 b(is)f(done)300 2562 y(by)29
b(allocating)g(a)h(ne)n(w)f(page,)i(unlocking)e(the)g(f)o(ault)h(data)f
(structures,)i(and)e(issuing)f(a)i(request)g(to)f(the)300
2711 y(sw)o(ap)c(I/O)g(layer)g(to)g(read)g(the)g(data)g(from)g(sw)o(ap)
g(into)f(the)h(ne)n(w)g(page.)31 b(While)25 b(the)g(read)g(is)g(in)f
(progress)300 2860 y(the)36 b(process)g(will)g(sleep,)i(thus)e
(releasing)g(the)g(CPU)h(in)f(order)g(to)g(allo)n(w)f(other)h
(processes)g(to)g(run.)300 3010 y(When)25 b(the)f(I/O)h(is)g
(\002nished,)f(the)g(f)o(ault)h(routine)f(will)g(resume)h(e)o(x)o
(ecution.)583 3159 y(If)33 b(the)f(data)g(is)g(resident)f(in)h(an)g
(una)n(v)n(ailable)f(page,)j(then)e(the)f(anonget)h(routine)f(must)g
(mark)300 3308 y(the)e(resident)g(page)h(\223w)o(anted,)-7
b(\224)31 b(unlock)e(the)g(f)o(ault)g(data)h(structures,)g(and)f(then)g
(sleep)g(until)g(the)g(page)300 3458 y(is)24 b(a)n(v)n(ailable.)30
b(There)c(are)f(tw)o(o)g(types)f(of)h(una)n(v)n(ailable)f(pages:)30
b(\223b)n(usy\224)25 b(pages)g(and)f(\223released\224)i(pages.)300
3607 y(A)e(page)g(is)g(mark)o(ed)g(b)n(usy)f(if)h(its)f(data)h(is)g(in)
f(\003ux)i(and)f(should)e(not)i(be)g(accessed.)31 b(F)o(or)24
b(e)o(xample,)f(pages)300 3757 y(whose)30 b(data)g(is)g(currently)g
(being)f(transfered)i(between)f(physical)f(memory)h(and)g(backing)f
(store)h(are)300 3906 y(mark)o(ed)24 b(b)n(usy)-6 b(.)30
b(A)24 b(process)h(that)f(sets)g(the)g(b)n(usy)g(\003ag)h(of)g(a)g
(page)f(is)g(said)h(to)f(be)g(its)g(\223o)n(wner)-5 b(.)e(\224)30
b(Released)300 4055 y(pages)35 b(are)h(pages)g(that)f(are)h(in)f(the)g
(process)g(of)h(being)f(freed.)63 b(When)35 b(clearing)h(a)f(page')-5
b(s)35 b(b)n(usy)g(or)300 4205 y(released)i(\003ags,)i(it)c(is)h(the)g
(responsibility)d(of)j(the)g(page')-5 b(s)36 b(o)n(wner)f(to)h(check)g
(to)g(see)g(if)g(the)g(page)h(is)300 4354 y(w)o(anted.)31
b(If)25 b(the)g(page)g(is)f(w)o(anted,)h(then)f(the)h(o)n(wner)f(must)g
(w)o(ak)o(e)h(an)o(y)f(process)h(w)o(aiting)f(for)h(access)g(to)300
4504 y(the)g(page.)583 4653 y(If)f(the)f(data)g(is)g(resident)f(in)h
(an)g(a)n(v)n(ailable)f(page,)i(then)f(the)g(anonget)f(routine)h(can)g
(successfully)300 4802 y(return.)31 b(The)25 b(pseudo)f(code)h(for)g
Fm(uvmfault)p 1921 4802 V 34 w(anonget)e Fs(is)i(sho)n(wn)e(in)h
(Figure)h(5.3.)583 4952 y(Note)h(that)g(the)g(anonget)f(function)g
(must)g(be)h(prepared)h(to)e(handle)h(se)n(v)o(eral)f(error)i
(conditions,)300 5101 y(including)18 b(running)h(out)h(of)g(physical)e
(memory)-6 b(,)20 b(I/O)g(errors)g(while)f(reading)h(from)g(the)g(sw)o
(ap)f(area,)j(and)300 5251 y(problems)i(re-locking)h(the)h(f)o(ault)f
(data)h(structures)e(after)j(sleeping.)k(A)26 b(discussion)e(of)h
(error)h(reco)o(v)o(ery)300 5400 y(in)e(the)h(f)o(ault)g(routine)f
(will)g(be)h(presented)f(later)l(,)h(in)g(Section)f(5.2.)p
eop
%%Page: 108 128
108 127 bop 3751 100 a Fs(108)300 213 y Fm(uvmfault_anonget\(\))56
b({)420 453 y(while)i(\(1\))h({)539 574 y(if)g(\(page)g(resident\))f({)
659 694 y(if)h(\(page)g(is)g(available\))778 814 y(return\(success\);)
236 b(/*)59 b(done!)g(*/)659 935 y(mark)g(page)f(wanted;)659
1055 y(unlock)g(data)h(structures;)659 1176 y(sleep;)539
1296 y(})h(else)f({)659 1416 y(allocate)f(new)h(page;)659
1537 y(unlock)f(data)h(structures)e(and)j(read)e(page)h(from)g(swap;)
539 1657 y(})539 1777 y(relock)g(data)f(structures;)420
1898 y(})119 b(/*)59 b(end)g(of)h(while)e(loop)h(*/)300
2139 y(})1131 2342 y Fs(Figure)25 b(5.3:)30 b(The)25
b Fm(uvmfault)p 2265 2342 30 4 v 34 w(anonget)f Fs(function)300
2737 y Fo(Anon)h(F)n(ault)g(Sub-cases)300 2954 y Fs(Once)f(the)g(anon')
-5 b(s)22 b(data)i(is)f(resident,)h(the)f(f)o(ault)h(routine)f(di)n
(vides)f(anon)h(f)o(aults)g(into)g(tw)o(o)g(sub-cases,)h(as)300
3103 y(sho)n(wn)g(in)g(Figure)h(5.4.)583 3253 y(In)c(case)g(1A,)g(the)f
(page)h(in)f(the)g(anon)h(is)f(mapped)g(directly)g(into)g(the)g(f)o
(aulting)g(process')g(address)300 3402 y(space.)33 b(Case)26
b(1A)g(is)f(triggered)g(by)g(either)h(a)f(read-f)o(ault)h(on)g(an)f
(anon')-5 b(s)25 b(page,)h(or)f(by)g(a)h(write-f)o(ault)f(on)300
3551 y(an)32 b(anon)g(whose)g(reference)i(count)e(is)g(equal)g(to)g
(one.)53 b(Case)33 b(1B)f(is)g(triggered)g(by)g(a)h(write-f)o(ault)e
(on)300 3701 y(an)f(anon)g(whose)g(reference)i(count)e(is)g(greater)h
(than)f(one.)47 b(Case)31 b(1B)f(is)g(required)g(for)h(proper)f(cop)o
(y-)300 3850 y(on-write)25 b(operation.)32 b(An)25 b(anon')-5
b(s)25 b(reference)i(count)d(can)i(only)f(be)g(greater)h(than)f(one)h
(if)f(tw)o(o)g(or)g(more)744 4802 y @beginspecial 0 @llx
0 @lly 465 @urx 131 @ury 3255 @rwi @setspecial
%%BeginDocument: ../figures/fcase1.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-50.0 278.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4657 m 0 0 l 8613 0 l 8613 4657 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
6150 4575 m
gs 1 -1 sc (old anon) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
3480 3603 m 3450 3723 l 3420 3603 l 3420 3765 l 3480 3765 l cp
clip
n 3450 2700 m 3450 3750 l gs col0 s gr gr

% arrowhead
n 3480 3603 m 3450 3723 l 3420 3603 l 3450 3603 l 3480 3603 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 5700 3300 m 6600 3300 l 6600 4200 l 5700 4200 l cp gs col0 s gr 
% Polyline
n 7500 3300 m 8400 3300 l 8400 4200 l 7500 4200 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
7803 3720 m 7923 3750 l 7803 3780 l 7965 3780 l 7965 3720 l cp
clip
n 6150 2700 m 6150 3750 l 7950 3750 l gs col0 s gr gr

% arrowhead
n 7803 3720 m 7923 3750 l 7803 3780 l 7803 3750 l 7803 3720 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
2400 3900 m
gs 1 -1 sc (anon-layer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3450 2625 m
gs 1 -1 sc (case 1a) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6150 2625 m
gs 1 -1 sc (case 1b) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7050 3675 m
gs 1 -1 sc (copy) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
7950 4575 m
gs 1 -1 sc (new anon) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
30.000 slw
n 3000 3300 m 3900 3300 l 3900 4200 l 3000 4200 l cp gs col0 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 300 5005 a(Figure)h(5.4:)34 b(Anon)25 b(f)o(ault)h
(sub-cases.)35 b(The)26 b(dif)n(ference)h(between)f(case)h(1a)g(and)f
(case)h(1b)f(f)o(ault)g(is)g(that)300 5126 y(in)e(case)i(1b)e(the)h
(data)f(must)g(go)g(through)g(the)h(cop)o(y-on-write)f(process)g(in)h
(order)g(to)f(resolv)o(e)g(the)g(f)o(ault.)p eop
%%Page: 109 129
109 128 bop 3751 100 a Fs(109)300 249 y(processes)27
b(are)g(sharing)f(its)g(page)h(as)g(part)g(of)g(a)g(cop)o(y-on-write)f
(operation.)36 b(Thus,)26 b(when)h(writing)e(to)300 398
y(an)30 b(anon)h(in)e(this)h(state,)h(a)g(cop)o(y)f(of)g(the)g(data)h
(must)e(be)i(made)f(\002rst)g(to)g(preserv)o(e)g(the)h(cop)o
(y-on-write)300 548 y(semantics.)e(Lik)o(e)n(wise,)23
b(for)h(case)g(1A,)f(when)h(f)o(aulting)e(on)i(anons)f(whose)g
(reference)i(count)e(is)g(greater)300 697 y(than)j(one,)i(the)e(f)o
(aulting)g(page)h(must)f(be)h(mapped)f(in)g(read-only)h(to)f(pre)n(v)o
(ent)g(it)g(from)h(being)f(changed)300 847 y(while)e(the)h(reference)h
(count)f(is)f(greater)h(than)g(one.)583 996 y(T)-8 b(o)20
b(handle)g(case)h(1B,)f(the)g(f)o(ault)g(routine)g(must)f(allocate)h(a)
g(ne)n(w)g(anon)g(containing)f(a)h(ne)n(w)g(page.)300
1145 y(The)k(data)h(from)f(the)h(old)e(anon)i(must)e(be)i(copied)f
(into)f(the)i(ne)n(w)f(anon,)g(and)g(then)h(the)f(ne)n(w)g(anon)g(must)
300 1295 y(be)i(installed)f(in)g(place)i(of)f(the)f(old)h(one)g(in)f
(the)h(amap.)34 b(The)26 b(ne)n(w)f(anon)h(will)f(ha)n(v)o(e)h(a)g
(reference)i(count)300 1444 y(of)34 b(one,)j(and)d(the)g(old)f(anon)h
(will)f(lose)h(one)g(reference.)60 b(The)34 b(f)o(ault)g(routine)g
(must)f(be)h(prepared)g(to)300 1594 y(handle)25 b(the)f(sort)h(of)f
(out-of-memory)g(errors)h(described)g(in)f(Section)h(5.2)g(while)f
(handling)f(case)j(1B.)300 1887 y Fo(Mapping)f(the)h(P)o(age)f(in)300
2103 y Fs(Once)20 b(the)g(cop)o(y-on-write)f(process)g(of)h(case)g(1B)g
(has)g(been)g(addressed,)g(the)g(ne)n(w)f(page)h(can)g(be)g(entered)300
2253 y(into)28 b(the)i(f)o(aulting)e(process')h(pmap,)h(thus)f
(establishing)e(a)j(lo)n(w-le)n(v)o(el)d(mapping)h(for)i(the)f(page)h
(being)300 2402 y(f)o(aulted.)f(This)21 b(is)g(done)g(with)f(a)i(call)f
(to)g(the)g Fm(pmap)p 2049 2402 30 4 v 35 w(enter)g Fs(function.)28
b(Once)22 b(the)f(lo)n(w-le)n(v)o(el)e(mapping)300 2552
y(has)35 b(been)h(established)e(the)h(f)o(ault)g(routine)g(can)g
(return)g(successfully)-6 b(.)61 b(The)36 b(f)o(aulting)e(process)h
(will)300 2701 y(resume)25 b(e)o(x)o(ecution)e(with)h(the)h(memory)f
(reference)i(it)e(made)h(to)f(the)h(page)g(that)f(w)o(as)h(just)f(f)o
(aulted)h(on.)300 3030 y Ff(5.1.7)119 b(Object)30 b(F)m(aults)300
3247 y Fs(The)c(second)f(class)h(of)g(f)o(aults)f(that)h(the)f(f)o
(ault)h(routine)f(handles)g(is)g(the)h(object)g(f)o(ault.)33
b(In)26 b(this)f(case,)h(the)300 3396 y(data)g(being)f(f)o(aulted)g
(resides)h(in)f(a)h Fm(uvm)p 1702 3396 V 35 w(object)p
Fs(.)32 b(There)26 b(are)h(three)f(steps)f(in)l(v)n(olv)o(ed)f(in)h
(processing)300 3546 y(an)j(object)g(f)o(ault:)37 b(fetching)27
b(the)h(data)h(if)f(it)f(is)h(not)f(resident,)i(handling)e(the)h(tw)o
(o)f(sub-cases)h(of)h(object)300 3695 y(f)o(aults,)24
b(and)h(mapping)f(in)g(the)h(page.)300 3988 y Fo(F)n(etching)g(Non-r)n
(esident)i(Data)300 4205 y Fs(Earlier)i(in)f(the)g(f)o(ault)g(process,)
h(the)g(f)o(ault)f(routine)g(did)f(a)i(lock)o(ed)f(get)h(to)f(\002nd)g
(an)o(y)g(resident)g(pages)g(in)300 4354 y(the)k(object)g(that)g(were)h
(close)f(to)g(the)g(f)o(aulting)g(page.)53 b(If)33 b(the)f(f)o(aulting)
g(page)g(w)o(as)h(resident)e(and)i(not)300 4504 y(b)n(usy)-6
b(,)23 b(then)h(the)h(lock)o(ed)f(get)g(returned)g(the)h(f)o(aulting)e
(page)i(as)f(well.)30 b(The)25 b(lock)o(ed)f(get)g(sets)g(the)g(\223b)n
(usy\224)300 4653 y(\003ag)k(on)g(the)g(pages)f(it)h(returns.)39
b(The)28 b(f)o(ault)g(routine)f(does)h(not)f(ha)n(v)o(e)g(to)h(w)o
(orry)g(about)f(getting)g(a)h(page)300 4802 y(that)c(is)h(b)n(usy)f(by)
g(another)h(process)g(because)g(the)g(lock)o(ed)f(get)h(will)f(not)g
(return)h(such)f(a)h(page.)583 4952 y(If)i(the)e(page)h(is)g(not)f
(resident,)g(then)h(the)f(f)o(ault)h(routine)f(must)g(issue)g(an)h
(unlock)o(ed)f(get)g(request)300 5101 y(to)j(the)h(pager)g(get)g
(function.)41 b(T)-8 b(o)29 b(do)f(this,)h(the)g(f)o(ault)f(routine)g
(unlocks)g(all)h(its)f(data)g(structures)h(\(with)300
5251 y(the)h(e)o(xception)f(of)h(the)g(object)g(\227)g(the)f(pager)i
(get)f(function)f(will)g(unlock)h(that)f(before)i(starting)e(I/O\))300
5400 y(and)f(calls)g(the)g(pager)g(get)g(function.)39
b(After)29 b(starting)e(I/O,)h(the)f(process)h(will)f(sleep)h(in)g(the)
g(pager)g(get)p eop
%%Page: 110 130
110 129 bop 3751 100 a Fs(110)502 1614 y @beginspecial
0 @llx 0 @lly 548 @urx 251 @ury 3836 @rwi @setspecial
%%BeginDocument: ../figures/fcase2.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-39.0 290.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4873 m 0 0 l 9813 0 l 9813 4873 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
7800 3600 m
gs 1 -1 sc (promote copy) col0 sh gr
% Polyline
7.500 slw
gs  clippath
3480 4203 m 3450 4323 l 3420 4203 l 3420 4365 l 3480 4365 l cp
clip
n 3450 900 m 3450 4350 l gs col0 s gr gr

% arrowhead
n 3480 4203 m 3450 4323 l 3420 4203 l 3450 4203 l 3480 4203 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 3450 3675 m 2850 4800 l 4050 4800 l 3450 3675 l  cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
2400 2100 m
gs 1 -1 sc (anon-layer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3450 825 m
gs 1 -1 sc (case 2a) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2400 4500 m
gs 1 -1 sc (object-layer) dup sw pop neg 0 rm  col0 sh gr
% Polyline
n 8700 1500 m 9600 1500 l 9600 2400 l 8700 2400 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
9150 2775 m
gs 1 -1 sc (new anon) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 6750 3675 m 6150 4800 l 7350 4800 l 6750 3675 l  cp gs col0 s gr 
% Polyline
 [15 90] 90 sd
n 6300 1500 m 7200 1500 l 7200 2400 l 6300 2400 l cp gs col0 s gr  [] 0 sd
% Polyline
7.500 slw
gs  clippath
9025 2033 m 9130 1969 l 9067 2075 l 9182 1961 l 9139 1918 l cp
clip
n 6750 900 m 6750 4350 l 9150 1950 l gs col0 s gr gr

% arrowhead
n 9025 2033 m 9130 1969 l 9067 2075 l 9046 2054 l 9025 2033 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
6750 825 m
gs 1 -1 sc (case 2b) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
30.000 slw
 [15 90] 90 sd
n 3000 1500 m 3900 1500 l 3900 2400 l 3000 2400 l cp gs col0 s gr  [] 0 sd
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1817 a(Figure)37 b(5.5:)54 b(Object)37
b(f)o(ault)f(sub-cases.)67 b(In)36 b(case)i(2a)f(the)f(f)o(aulting)g
(process)h(has)f(direct)h(access)g(to)300 1937 y(the)26
b(object')-5 b(s)25 b(memory)-6 b(,)25 b(while)h(in)g(case)h(2b)f(the)g
(f)o(aulting)f(process)h(has)g(cop)o(y-on-write)g(access)g(to)g(the)300
2058 y(object.)300 2453 y(function)h(until)f(the)h(data)h(is)f(a)n(v)n
(ailable.)38 b(When)28 b(the)f(data)h(is)f(a)n(v)n(ailable,)h(the)f
(pager)h(get)f(function)g(will)300 2602 y(return)d(with)f(the)g(f)o
(aulting)g(page)h(resident)g(and)f(b)n(usy)-6 b(.)30
b(The)23 b(f)o(ault)h(routine)f(must)g(check)h(for)g(errors)g(and)300
2752 y(relock)h(the)g(data)f(structures.)300 3047 y Fo(Object)i(F)n
(ault)e(Sub-cases)300 3263 y Fs(Once)h(the)f(object')-5
b(s)23 b(data)h(is)g(resident,)g(the)g(f)o(ault)g(routine)f(di)n(vides)
g(object)h(f)o(aults)f(into)h(tw)o(o)f(sub-cases,)300
3413 y(as)i(sho)n(wn)e(in)i(Figure)g(5.5.)583 3562 y(In)33
b(case)f(2A)g(the)g(object')-5 b(s)31 b(page)h(is)g(mapped)f(directly)h
(into)f(the)h(f)o(aulting)f(process')h(address)300 3712
y(space.)46 b(Case)30 b(2A)f(is)h(triggered)f(by)g(either)h(a)g(read-f)
o(ault)g(on)f(an)h(object')-5 b(s)29 b(page,)h(or)g(by)g(a)f(write-f)o
(ault)300 3861 y(on)34 b(an)h(object)f(that)f(is)h(mapped)g(shared)h
(\(i.e.)59 b(not)34 b(cop)o(y-on-write\).)59 b(If)35
b(a)f(read-f)o(ault)h(occurs)g(on)f(a)300 4010 y(cop)o(y-on-write)23
b(re)o(gion,)g(then)h(the)g(page)g(will)f(be)h(mapped)f(in)h(read-only)
f(to)h(ensure)g(that)f(the)h(f)o(aulting)300 4160 y(process)h(cannot)g
(attempt)f(to)g(modify)g(it)h(without)e(generating)i(a)g(page)g(f)o
(ault.)31 b(Note)25 b(that)g(if)g(the)g(object)300 4309
y(is)i(a)i(memory)e(mapped)g(\002le,)i(then)e(changes)h(made)g(to)g
(its)f(pages)g(will)g(be)h(re\003ected)h(back)g(to)e(the)h(\002le)300
4459 y(and)d(seen)g(by)f(other)h(processes.)583 4608
y(Case)37 b(2B)e(is)g(triggered)g(by)g(a)h(write-f)o(ault)f(on)g(an)g
(object)g(that)g(is)g(mapped)g(cop)o(y-on-write,)300
4757 y(or)g(by)f(a)h(f)o(ault)f(on)g(a)h(cop)o(y-on-write)f(re)o(gion)g
(that)g(has)g(no)g(object)h(associated)f(with)f(it.)60
b(The)34 b(latter)300 4907 y(case)h(happens)g(with)f(re)o(gions)f(of)i
(virtual)f(memory)g(that)g(are)i(mapped)e(\223zero-\002ll.)-7
b(\224)62 b(When)35 b(data)g(is)300 5056 y(copied)25
b(from)g(the)g(lo)n(wer)n(-le)n(v)o(el)f(object)g(layer)i(to)f(the)g
(upper)n(-le)n(v)o(el)f(anon)h(layer)g(the)g(data)h(is)e(said)h(to)g
(be)300 5206 y(\223promoted.)-7 b(\224)38 b(T)-8 b(o)27
b(promote)f(data,)i(the)f(f)o(ault)g(routine)g(must)f(allocate)h(a)h
(ne)n(w)f(anon)g(with)f(a)i(ne)n(w)f(page)p eop
%%Page: 111 131
111 130 bop 3751 100 a Fs(111)300 249 y(and)24 b(cop)o(y)f(the)h(data)g
(from)f(the)h(old)f(page)h(to)g(the)f(ne)n(w)h(page.)30
b(The)24 b(f)o(ault)f(routine)h(must)e(be)i(prepared)g(to)300
398 y(handle)h(the)f(sort)h(of)f(out)h(of)g(memory)e(errors)j
(described)e(in)h(Section)g(5.2)f(while)g(handling)g(case)h(2B.)300
694 y Fo(Mapping)g(the)h(P)o(age)f(in)300 910 y Fs(Once)33
b(the)f(object)h(page)f(is)h(resident)f(and)g(case)h(2B)g(is)g(tak)o
(en)f(care)i(of,)g(then)e(the)h(ne)n(w)f(page)h(can)g(be)300
1060 y(entered)d(into)f(the)h(the)g(f)o(aulting)f(process')h(pmap)f
(with)g Fm(pmap)p 2517 1060 30 4 v 35 w(enter)p Fs(.)45
b(After)31 b(mapping)d(the)i(page,)300 1209 y(the)37
b(f)o(ault)f(routine)g(must)g(clear)i(the)e(f)o(aulting)g(page')-5
b(s)37 b(b)n(usy)f(\003ag,)k(and)d(check)g(the)g(f)o(aulting)e(page')-5
b(s)300 1358 y(w)o(anted)31 b(\003ag.)50 b(If)31 b(the)g(page)h(is)e(w)
o(anted,)j(then)d(the)h(f)o(ault)g(routine)f(w)o(ak)o(es)i(up)e(an)o(y)
h(process)g(that)f(may)300 1508 y(be)d(sleeping)e(w)o(aiting)h(for)h
(it.)35 b(Once)27 b(this)e(is)h(done,)h(the)f(f)o(ault)g(routine)g(can)
h(return)g(successfully)-6 b(.)34 b(The)300 1657 y(f)o(aulting)24
b(process)i(will)e(resume)h(e)o(x)o(ecution)f(with)g(the)i(memory)e
(reference)j(it)e(made)g(to)g(the)g(page)h(that)300 1807
y(w)o(as)f(just)f(f)o(aulted)g(on.)300 2138 y Ff(5.1.8)119
b(Summary)300 2354 y Fs(In)34 b(summary)-6 b(,)34 b(a)f(page)h(f)o
(ault)f(happens)g(as)h(follo)n(ws:)46 b(First)33 b(the)h(f)o(aultinfo)e
(structure)h(is)g(\002lled)h(in)f(for)300 2504 y(the)g(lookup)e
(operation.)54 b(After)33 b(the)g(lookup)f(operation)g(is)g(performed)h
(the)f(protection)g(is)h(check)o(ed)300 2653 y(and)24
b(needs-cop)o(y)f(is)h(cleared)g(if)g(necessary)-6 b(.)30
b(Ne)o(xt,)23 b(a)n(v)n(ailable)g(resident)h(neighboring)e(pages)i(are)
g(then)300 2803 y(mapped)h(in.)33 b(Finally)-6 b(,)25
b(the)g(f)o(ault)g(routine)g(resolv)o(es)g(the)h(f)o(ault)f(by)g
(determining)g(which)g(case)h(the)f(f)o(ault)300 2952
y(is,)30 b(getting)e(the)i(needed)f(data,)i(and)f(mapping)e(it)h(in.)44
b(Pseudo)29 b(code)h(sho)n(wing)e(the)h(o)o(v)o(erall)f(structure)300
3101 y(of)d(UVM')-5 b(s)24 b(f)o(ault)g(routine)g(is)h(sho)n(wn)e(in)i
(Figure)g(5.6.)300 3485 y Fg(5.2)143 b(Err)m(or)35 b(Reco)o(v)o(ery)300
3737 y Fs(The)j(f)o(ault)g(routine)f(resolv)o(es)g(most)g(page)h(f)o
(aults)f(without)f(encountering)i(an)o(y)f(errors.)70
b(Ho)n(we)n(v)o(er)l(,)300 3887 y(errors)33 b(can)f(occur)h(and)f(the)h
(f)o(ault)f(routine)f(must)g(be)i(prepared)g(to)f(reco)o(v)o(er)g(from)
g(them)g(gracefully)-6 b(.)300 4036 y(This)32 b(section)g(describes)h
(the)f(possible)g(errors)h(the)g(f)o(ault)f(routine)g(may)h(get)f(and)h
(ho)n(w)f(it)g(addresses)300 4186 y(them.)300 4517 y
Ff(5.2.1)119 b(In)-5 b(v)o(alid)30 b(V)l(irtual)g(Addr)n(esses)300
4733 y Fs(In)l(v)n(alid)25 b(virtual)g(addresses)g(are)i(virtual)e
(addresses)g(that)g(are)i(not)e(mapped)g(by)h(an)o(y)f(map)g(entry)h
(in)f(the)300 4883 y(f)o(aulting)g(map.)32 b(An)25 b(in)l(v)n(alid)f
(virtual)h(address)g(is)g(detected)h(by)f(the)h(f)o(ailure)f(of)h(the)f
(f)o(ault)g(lookup)g(func-)300 5032 y(tion.)k(These)22
b(errors)h(are)g(easy)f(to)g(handle)g(because)h(the)o(y)e(are)i
(detected)g(early)f(on)g(in)g(the)g(f)o(ault)g(process.)300
5182 y(Since)g(no)g(resources)g(ha)n(v)o(e)f(been)h(allocated)f(or)h
(lock)o(ed,)g(the)g(f)o(ault)f(routine)g(can)h(just)f(return)h(an)g(in)
l(v)n(alid)p eop
%%Page: 112 132
112 131 bop 3751 100 a Fs(112)300 213 y Fm(uvm_fault\(\))57
b({)420 333 y(fill)h(in)i(faultinfo)e(structure;)300
453 y(ReFault:)420 574 y(call)g(uvmfault_lookup)f(to)i(look)g(up)g
(mapping;)420 694 y(check)f(protection;)420 814 y(clear)g(needs-copy)g
(if)h(necessary;)420 935 y(check)f(for)h(either)g(an)g(amap)g(or)g(an)h
(object;)420 1055 y(establish)d(range)i(of)g(mapping)f(\(for)h
(neighboring)f(pages\);)420 1176 y(map)h(in)g(resident)f(anon)h(pages;)
420 1296 y(map)g(in)g(resident)f(object)g(pages)h(if)g(necessary;)420
1416 y(if)g(\(case)g(1\))g({)539 1537 y(ensure)g(data)f(is)i(resident;)
539 1657 y(if)f(\(case)g(1B\))g({)h(do)f(copy-on-write;)e(})539
1777 y(map)i(in)h(the)f(correct)f(page;)539 1898 y(return\(success\);)
420 2018 y(})h(else)g({)539 2139 y(ensure)g(data)f(is)i(resident;)539
2259 y(if)f(\(case)g(2B\))g({)h(do)f(copy-on-write)e(promotion;)g(})539
2379 y(map)i(in)h(the)f(correct)f(page;)539 2500 y(return\(success\);)
420 2620 y(})420 2741 y(done!)300 2861 y(})1504 3064
y Fs(Figure)25 b(5.6:)30 b(F)o(ault)25 b(pseudo)f(code)300
3459 y(address)e(error)g(code)g(to)f(the)g(caller)-5
b(.)30 b(This)21 b(error)h(most)f(often)g(occurs)h(when)f(b)n(uggy)g
(programs)g(attempt)300 3609 y(to)j(reference)j(data)e(through)f(an)h
(in)l(v)n(alid)e(pointer)-5 b(.)300 3940 y Ff(5.2.2)119
b(Pr)n(otection)30 b(V)l(iolations)300 4157 y Fs(Each)22
b(map)f(entry)g(in)h(a)f(map)h(has)f(a)h(protection)f(code)g
(associated)g(with)g(it.)29 b(Once)22 b(the)g(lookup)e(function)300
4306 y(has)25 b(found)f(the)h(proper)g(map)f(entry)h(in)g(the)f(f)o
(aulting)g(map,)h(the)f(protection)g(code)i(is)e(compared)h(to)f(the)
300 4455 y(access)40 b(type)f(of)h(the)f(f)o(ault.)75
b(If)40 b(the)o(y)f(are)h(incompatible)e(\(e.g.)76 b(a)39
b(write)h(to)f(a)h(read-only)f(area)i(of)300 4605 y(memory\),)33
b(then)e(the)h(f)o(ault)g(routine)f(handles)g(the)h(error)h(by)e
(unlocking)g(the)g(maps)h(and)g(returning)f(a)300 4754
y(protection)d(f)o(ailure)h(error)h(code.)43 b(This)28
b(error)i(most)e(often)h(occurs)g(when)g(b)n(uggy)f(programs)g(attempt)
300 4904 y(to)c(write)h(to)f(their)h(read-only)g(te)o(xt)f(area.)p
eop
%%Page: 113 133
113 132 bop 3751 100 a Fs(113)300 249 y Ff(5.2.3)119
b(Null)31 b(Mappings)300 466 y Fs(If)i(a)g(map)g(entry)g(has)f(neither)
h(an)g(amap)g(nor)f(an)h(object)g(and)g(the)f(mapping)g(is)g(not)h(cop)
o(y-on-write,)300 615 y(then)28 b(the)g(map)g(entry)g(is)g(just)f
(reserving)h(space)h(in)f(the)g(map.)40 b(It)29 b(is)e(not)h(actually)g
(mapping)f(an)o(ything)300 764 y(into)c(the)h(space.)31
b(Memory)23 b(access)h(to)g(this)f(sort)h(of)g(re)o(gion)f(is)g(an)h
(error)h(condition.)k(The)24 b(f)o(ault)g(routine)300
914 y(handles)d(null)f(mappings)g(by)h(unlocking)f(the)h(maps)g(and)g
(returning)f(an)i(in)l(v)n(alid)d(virtual)i(address)g(error)-5
b(.)300 1063 y(This)31 b(error)i(most)d(often)i(occurs)g(when)f(b)n
(uggy)g(programs)h(attempt)e(to)i(reference)h(data)f(through)f(an)300
1213 y(in)l(v)n(alid)23 b(pointer)-5 b(.)300 1544 y Ff(5.2.4)119
b(Out)30 b(of)f(Ph)n(ysical)i(Memory)300 1760 y Fs(The)j(f)o(ault)h
(routine)e(allocates)i(physical)e(memory)g(in)h(tw)o(o)g(cases.)60
b(First,)37 b(if)d(the)g(f)o(aulting)g(memory)300 1910
y(reference)22 b(is)e(on)g(a)h(pre)n(viously)d(unaccessed)j
(zero-\002ll)g(area)g(of)f(memory)-6 b(,)20 b(then)g(the)g(f)o(ault)h
(routine)e(must)300 2059 y(allocate)31 b(and)g(zero)g(a)h(page)f(to)f
(map)h(into)f(that)h(area.)50 b(Second,)33 b(if)e(the)f(f)o(aulting)g
(memory)g(reference)300 2209 y(is)h(a)h(write)f(to)g(a)h(cop)o
(y-on-write)f(area)i(of)e(memory)-6 b(,)32 b(then)f(the)g(f)o(ault)g
(routine)g(must)g(allocate)g(a)h(page)300 2358 y(of)26
b(physical)f(memory)g(to)g(cop)o(y)h(the)g(data)f(to.)34
b(This)25 b(can)h(happen)g(either)g(at)g(the)g(anon)f(or)h(object)g
(layer)300 2507 y(\(f)o(ault)f(cases)g(1B)g(and)g(2B\).)583
2657 y(If)31 b(the)e(system)g(is)g(out)g(of)h(physical)e(memory)-6
b(,)30 b(then)f(the)h(f)o(ault)f(routine')-5 b(s)29 b(allocation)f
(request)300 2806 y(will)i(f)o(ail.)50 b(The)31 b(f)o(ault)g(routine)f
(handles)h(this)f(condition)g(by)g(unlocking)g(all)h(its)f(data)i
(structures)e(and)300 2956 y(w)o(aking)25 b(the)h(pagedaemon.)32
b(It)26 b(then)f(w)o(aits)g(for)h(the)g(pagedaemon)f(to)g(free)i(up)e
(some)g(physical)g(mem-)300 3105 y(ory)j(by)f(doing)g(pageouts.)39
b(When)28 b(the)f(pagedaemon)h(has)f(done)h(this,)f(it)h(will)f(send)g
(a)h(w)o(ak)o(eup)g(to)f(the)300 3254 y(f)o(aulting)d(process.)30
b(The)25 b(f)o(aulting)f(process)h(then)f(restarts)h(the)f(f)o(ault.)
300 3586 y Ff(5.2.5)119 b(Out)30 b(of)f(Anonymous)h(V)l(irtual)h
(Memory)300 3802 y Fs(The)21 b(f)o(ault)f(routine)g(can)h(run)g(out)f
(of)h(anon)o(ymous)e(virtual)h(memory)f(if)i(the)g(entire)f(sw)o(ap)h
(area)h(and)e(most)300 3952 y(of)30 b(RAM)h(is)e(allocated.)47
b(This)30 b(case)g(is)g(detected)g(by)g(the)g(f)o(ailure)h(of)f(an)g
(allocation)g(of)g(a)h(ne)n(w)e(anon.)300 4101 y(UVM')-5
b(s)31 b(f)o(ault)i(routine)f(handles)f(this)h(condition)f(by)h
(unlocking)f(the)i(data)f(structures)g(and)h(causing)300
4250 y(the)25 b(f)o(ault)f(to)h(f)o(ail.)583 4400 y(There)37
b(is)e(room)h(for)g(impro)o(v)o(ement)d(in)j(UVM')-5
b(s)35 b(handling)g(of)h(this)f(condition.)62 b(The)36
b(BSD)300 4549 y(VM)30 b(system)e(\223handles\224)i(this)f(condition)g
(by)h(ignoring)e(it.)46 b(If)31 b(you)e(run)h(a)g(BSD)h(VM)f(system)f
(out)g(of)300 4699 y(virtual)i(memory)f(the)i(system)e(will)h
(deadlock.)50 b(In)32 b(UVM,)f(the)g(process)h(that)f(runs)g(the)g
(system)g(out)300 4848 y(of)g(virtual)e(memory)h(will)g(get)g(an)h
(error)g(signal)e(at)i(the)f(time)g(of)g(the)h(f)o(ault.)47
b(In)31 b(the)f(future,)i(it)e(w)o(ould)300 4997 y(be)38
b(w)o(orthwhile)f(to)g(in)l(v)o(estigate)f(w)o(ays)h(to)h(report)f(the)
h(shortage)f(of)h(virtual)f(memory)g(at)h(memory)300
5147 y(allocation)26 b(time)g(\(when)h(the)g(allocating)f(process)h
(has)g(a)g(chance)h(to)f(do)f(something)g(about)g(it\))h(rather)300
5296 y(than)d(at)h(f)o(ault)g(time)f(\(when)h(the)f(allocating)g
(process)h(will)f(be)h(unlik)o(ely)e(to)i(be)g(able)f(to)h(handle)f
(it\).)p eop
%%Page: 114 134
114 133 bop 3751 100 a Fs(114)300 249 y Ff(5.2.6)119
b(F)m(ailur)n(e)30 b(T)-11 b(o)30 b(Relock)h(Data)e(Structur)n(es)300
466 y Fs(If)36 b(the)f(f)o(ault)g(routine)g(has)g(to)g(w)o(ait)h(for)f
(an)h(I/O)f(operation)g(or)g(w)o(ait)h(for)f(memory)g(to)g(become)g
(free)300 615 y(it)d(al)o(w)o(ays)h(unlocks)f(all)h(its)f(data)h
(structures)f(before)h(going)f(to)h(sleep.)55 b(Once)33
b(the)g(I/O)f(operation)h(is)300 764 y(complete)26 b(or)i(the)f(memory)
f(being)h(w)o(aited)g(on)f(becomes)h(a)n(v)n(ailable,)g(the)g(f)o
(aulting)f(process)i(resumes)300 914 y(e)o(x)o(ecution.)33
b(In)26 b(this)f(situation,)f(the)i(\002rst)g(thing)f(the)h(f)o(ault)f
(routine)h(must)e(do)i(is)g(re-establish)f(locks)g(on)300
1063 y(all)i(the)h(data)g(structures)f(associated)g(with)g(the)h(f)o
(ault.)39 b(Since)28 b(these)f(data)h(structures)f(were)i(unlock)o(ed)
300 1213 y(for)j(a)f(period)h(of)f(time,)h(it)f(is)g(possible)f(that)h
(other)g(processes)h(could)f(ha)n(v)o(e)g(changed)g(or)h(e)n(v)o(en)e
(freed)300 1362 y(them)24 b(while)g(the)h(f)o(aulting)f(process)h(w)o
(as)f(w)o(aiting.)583 1511 y(UVM)h(uses)f(the)g Fm(uvmfault)p
1669 1511 30 4 v 34 w(relock)g Fs(function)f(to)h(relock)h(the)f(map)h
(data)f(structures.)30 b(As)300 1661 y(described)i(earlier)l(,)h(the)f
(relock)g(function)f(uses)g(the)h(map')-5 b(s)30 b(v)o(ersion)h
(numbers)g(to)g(determine)h(if)f(the)300 1810 y(old)25
b(lookup)g(is)g(still)g(v)n(alid.)32 b(If)27 b(the)e(lookup)g(is)g(not)
g(v)n(alid,)g(then)h(the)f(f)o(ault)h(routine)f(reco)o(v)o(ers)g(from)h
(this)300 1960 y(by)e(un-b)n(usying)e(an)o(y)i(b)n(usy)f(pages)h(that)f
(it)h(is)f(holding)g(and)h(restarting)f(the)h(f)o(ault)g(from)g(the)g
(top)f(\(called)300 2109 y(a)i(\223ref)o(ault\224\).)583
2258 y(The)g(BSD)g(VM)f(system)f(does)h(not)g(mak)o(e)g(use)g(of)g(the)
g(map')-5 b(s)24 b(v)o(ersion)f(numbers)h(\227)g(it)f(al)o(w)o(ays)300
2408 y(repeats)f(the)f(lookup.)28 b(Using)21 b(the)g(map')-5
b(s)21 b(v)o(ersion)f(numbers)h(to)g(a)n(v)n(oid)g(the)g(second)g
(lookup)g(appears)g(to)300 2557 y(be)i(a)f(feature)i(of)e(Mach)h(VM)f
(that)g(w)o(as)g(remo)o(v)o(ed)g(from)g(BSD.)h(The)g
Fm(uvmfault)p 3159 2557 V 34 w(relock)e Fs(function)300
2707 y(restores)k(this)f(feature)h(to)f(UVM.)300 3038
y Ff(5.2.7)119 b(I/O)29 b(Err)n(ors)300 3254 y Fs(If)22
b(the)g(f)o(ault)g(routine)f(has)h(requested)g(that)g(an)g(I/O)g
(operation)f(be)i(performed)f(to)f(fetch)h(a)h(f)o(aulting)e(page)300
3404 y(from)g(backing)g(store)h(it)f(is)g(possible)f(that)h(the)h(I/O)f
(operation)g(will)g(f)o(ail.)30 b(F)o(or)21 b(e)o(xample,)g(if)h(a)g
(disk)f(starts)300 3553 y(to)h(malfunction)g(or)h(a)g(de)n(vice)f(dri)n
(v)o(er)g(cannot)h(get)f(access)i(to)e(resources)h(it)g(needs)f(to)h
(perform)g(the)f(I/O,)300 3703 y(then)i(the)h(page-in)g(will)f(f)o(ail)
g(with)g(an)h(error)-5 b(.)583 3852 y(If)27 b(the)f(page-in)f
(operation)h(f)o(ails)f(while)h(attempting)e(to)h(page)h(in)g(anon)o
(ymous)e(memory)-6 b(,)24 b(then)300 4001 y(the)k(f)o(ault)h(routine)e
(must)h(restore)g(the)h(f)o(aulting)e(anon)h(back)h(to)f(the)g(state)h
(it)f(w)o(as)g(in)g(before)h(the)f(f)o(ault.)300 4151
y(That)33 b(means)g(that)g(the)h(page)f(that)h(has)f(been)h(associated)
f(with)f(the)i(anon)f(must)f(be)i(remo)o(v)o(ed)e(from)300
4300 y(it)j(and)g(freed.)63 b(If)35 b(the)g(page-in)h(operation)e(f)o
(ails)h(while)g(attempting)e(to)i(page-in)g(object)g(pages)g(the)300
4450 y(object')-5 b(s)35 b(pager)h(is)g(responsible)e(for)i(freeing)h
(an)o(y)e(allocated)g(pages.)64 b(The)36 b(pager)g(can)h(return)f(tw)o
(o)300 4599 y(types)24 b(of)h(error)h(codes:)31 b(one)24
b(to)h(indicate)f(that)h(the)g(f)o(ault)f(routine)g(should)g(re-try)h
(the)g(f)o(ault)g(and)g(one)f(to)300 4748 y(indicate)g(that)h(the)f
(page-in)h(f)o(ailed)g(and)g(that)f(the)h(f)o(ault)f(routine)g(should)g
(gi)n(v)o(e)f(up.)p eop
%%Page: 115 135
115 134 bop 3751 100 a Fs(115)300 249 y Ff(5.2.8)119
b(Released)30 b(P)o(ages)300 466 y Fs(When)d(the)h(f)o(ault)f(routine)f
(or)i(pagedaemon)f(is)g(ha)n(ving)f(I/O)i(performed)f(on)g(a)h(page)g
(the)f(page')-5 b(s)27 b(b)n(usy)300 615 y(\003ag)32
b(is)f(set)h(to)f(indicate)g(to)g(other)h(processes)f(that)h(this)e
(page)i(is)f(currently)h(in)f(\003ux)h(and)f(should)g(not)300
764 y(be)f(accessed.)47 b(While)29 b(the)h(I/O)g(is)f(in)h(progress)g
(it)f(is)g(possible)g(for)h(some)g(other)f(process)h(to)g(w)o(ant)f(to)
300 914 y(free)f(the)f(b)n(usy)f(page.)38 b(This)27 b(could)f(be)h(due)
g(to)g(the)g(page)g(being)g(unmapped)f(or)i(due)f(to)f(a)i(pager)f
(\003ush)300 1063 y(operation.)62 b(Because)36 b(the)f(page)h(is)f
(currently)g(in)g(the)g(middle)f(of)i(an)f(I/O)h(operation)e(\(and)i
(thus)f(is)300 1213 y(mark)o(ed)24 b(b)n(usy\))h(it)f(cannot)g(be)h
(freed.)31 b(Rather)25 b(than)g(freeing)f(it,)g(the)h(page')-5
b(s)24 b(released)h(\003ag)g(is)f(set.)31 b(This)300
1362 y(tells)c(the)h(process)f(that)h(set)f(the)h(b)n(usy)f(\003ag)h
(that)g(the)f(page)i(needs)e(to)h(be)g(freed)g(as)g(soon)f(as)h(the)g
(I/O)g(is)300 1511 y(complete.)583 1661 y(The)f(f)o(ault)f(routine)f
(must)g(check)i(a)f(page')-5 b(s)26 b(released)h(\003ag)f(after)h
(relocking)f(the)g(f)o(aulting)f(data)300 1810 y(structures)e(to)g
(ensure)h(that)g(the)f(page)h(is)f(still)g(v)n(alid.)29
b(If)24 b(the)f(page)h(is)g(mark)o(ed)f(released,)h(then)g(the)f(f)o
(ault)300 1960 y(routine)j(must)f(dispose)g(of)i(the)f(page)h(and)f
(restart)g(the)h(f)o(ault.)35 b(Anon)26 b(pages)g(can)h(be)f(mark)o(ed)
h(released)300 2109 y(only)36 b(if)h(the)o(y)f(are)h(part)g(of)g(an)g
(anon)g(that)f(is)h(no)f(longer)h(part)g(of)f(an)h(amap)g(\(and)g(thus)
f(the)h(anon')-5 b(s)300 2258 y(reference)30 b(count)d(is)h(zero\).)41
b(In)28 b(this)f(case,)j(the)d(f)o(ault)h(routine)g(must)e(free)j(both)
f(the)g(anon')-5 b(s)27 b(page)h(and)300 2408 y(the)j(anon)g(itself)878
2372 y Fj(3)915 2408 y Fs(.)50 b(Released)32 b(object)f(pages)h(are)g
(handled)f(by)g(the)g(object')-5 b(s)30 b(page)i(release)g(function)300
2557 y(\(described)26 b(in)g(detail)g(in)g(Chapter)h(6\).)35
b(Note)26 b(that)f(one)i(possible)e(result)g(of)i(calling)e(an)i
(object')-5 b(s)25 b(page)300 2707 y(release)g(function)e(is)h(that)g
(the)g(object)g(itself)g(is)g(terminated.)29 b(In)c(this)e(case,)i(the)
f(f)o(ault)g(routine)g(must)f(be)300 2856 y(careful)i(to)g(drop)f(all)h
(references)h(to)f(the)f(terminated)g(object.)300 3235
y Fg(5.3)143 b(BSD)35 b(VM)h(F)l(ault)f(vs.)44 b(UVM)35
b(F)l(ault)300 3488 y Fs(The)d(BSD)h(VM)e(f)o(ault)h(routine)f(and)h
(the)f(UVM)h(f)o(ault)f(routine)h(dif)n(fer)f(in)h(a)g(number)f(of)h(w)
o(ays.)52 b(This)300 3637 y(section)24 b(highlights)f(the)h(major)h
(dif)n(ferences.)300 3964 y Ff(5.3.1)119 b(Map)30 b(Lookup)300
4181 y Fs(In)25 b(the)g(BSD)g(VM)g(system,)e(map)i(lookups)e(are)j
(handled)e(by)h(the)g Fm(vm)p 2707 4181 30 4 v 35 w(map)p
2922 4181 V 35 w(lookup)f Fs(function.)30 b(This)300
4330 y(function)j(tak)o(es)h(eight)f(parameters.)59 b(Three)34
b(of)g(the)g(parameters)g(are)h(inputs)e(to)g(the)h(function:)48
b(the)300 4480 y(f)o(aulting)30 b(map,)i(the)f(f)o(aulting)f(address,)j
(and)e(the)g(f)o(ault)f(type.)49 b(The)31 b(function)g(performs)f(the)h
(lookup,)300 4629 y(handling)h(the)i(presence)g(of)g(share)f(and)h
(submaps.)56 b(In)33 b(addition,)i(it)e(also)g(checks)g(protection,)i
(cre-)300 4779 y(ates)27 b(shado)n(w)g(objects)f(\(if)i(needs-cop)o(y)f
(is)f(set\),)i(and)f(creates)h(zero-\002ll)g(objects.)38
b(When)27 b(the)g(f)o(aulting)300 4928 y(process)e(is)f(done)h(with)f
(the)g(lookup,)g(it)g(calls)h(a)g(\223map)g(lookup)e(done\224)i
(function)f(to)g(unlock)g(the)h(map.)583 5077 y(In)i(UVM,)e(map)h
(lookups)f(are)i(handled)f(by)f Fm(uvmfault)p 2617 5077
V 35 w(lookup)p Fs(.)33 b(This)25 b(function)h(tak)o(es)g(a)300
5227 y(f)o(aultinfo)31 b(data)g(structure)g(and)h(a)f(locking)g(\003ag)
h(and)f(performs)g(the)h(lookup.)49 b(It)32 b(handles)e(share)i(and)p
300 5309 1440 4 v 416 5370 a Fi(3)449 5400 y Fh(The)20
b Fe(uvm)p 754 5400 25 4 v 30 w(anfree)f Fh(function)g(performs)f(both)
i(of)f(these)i(actions.)p eop
%%Page: 116 136
116 135 bop 3751 100 a Fs(116)300 249 y(submaps.)28 b(Issues)21
b(such)g(as)g(protection)f(checking)h(and)g(clearing)g(needs-cop)o(y)g
(are)h(left)f(up)g(to)g(the)g(call-)300 398 y(ing)g(process.)29
b(Unlik)o(e)21 b(BSD)h(VM,)f(UVM)g(sa)n(v)o(es)g(the)g(map')-5
b(s)20 b(v)o(ersions)g(in)h(the)g(f)o(aultinfo)g(data)g(structure)300
548 y(and)j(pro)o(vides)e(a)i(relock)g(function.)30 b(This)23
b(a)n(v)n(oids)g(the)g(e)o(xtra)h(o)o(v)o(erhead)f(of)g(ha)n(ving)h(to)
f(tra)n(v)o(erse)h(the)f(list)300 697 y(of)i(map)f(entry)h(structures)f
(when)h(relocking)f(the)h(maps)f(after)h(an)g(I/O.)583
847 y(While)31 b(both)f(BSD)h(and)g(UVM')-5 b(s)29 b(lookup)h(function)
g(ease)h(the)g(handling)e(of)i(share)g(and)f(sub-)300
996 y(maps,)23 b(the)g(BSD')-5 b(s)24 b(lookup)e(function)h(is)g(o)o(v)
o(erloaded)f(to)h(performs)g(tasks)g(not)g(directly)g(related)g(to)g
(the)300 1145 y(lookup)28 b(such)g(as)h(protection)e(checking)i(and)f
(object)h(chain)f(creation.)42 b(This)28 b(o)o(v)o(erloading)f
(increases)300 1295 y(the)e(comple)o(xity)d(of)j(the)g(BSD)h(lookup)d
(function.)300 1626 y Ff(5.3.2)119 b(Object)30 b(Chaining)h(vs.)37
b(T)-9 b(w)o(o-Le)n(v)o(el)29 b(Mappings)300 1843 y Fs(Another)34
b(source)g(of)g(comple)o(xity)e(in)i(the)f(BSD)i(VM)f(f)o(ault)g
(routine)f(are)i(object)e(chains.)58 b(F)o(or)34 b(each)300
1992 y(page)28 b(f)o(ault,)h(the)f(BSD)h(VM)f(system)f(must)g(tra)n(v)o
(erse)h(do)n(wn)g(the)g(shado)n(w)f(chain)h(to)g(\002nd)g(the)g(f)o
(aulting)300 2141 y(data.)41 b(It)28 b(then)g(must)f(push)g(the)h
(changed)g(data)g(do)n(wn)g(the)g(cop)o(y)f(object)h(chain.)41
b(As)28 b(pages)g(are)h(being)300 2291 y(written)21 b(the)g(BSD)i(VM)e
(has)g(to)h(check)g(its)f(object)g(chains)g(to)g(see)h(if)g(the)o(y)e
(can)i(be)g(collapsed)f(to)g(pre)n(v)o(ent)300 2440 y(them)i(from)g
(becoming)f(too)h(long.)29 b(There)24 b(is)e(no)h(limit)f(to)h(the)g
(number)g(of)g(objects)g(that)f(the)h(BSD)i(VM)300 2590
y(must)d(e)o(xamine)g(to)g(resolv)o(e)h(a)g(f)o(ault!)30
b(In)23 b(contrast,)g(UVM)f(has)h(a)g(simple)f(tw)o(o-le)n(v)o(el)f
(mapping)h(scheme)300 2739 y(that)k(does)g(not)f(require)i(an)o(y)f(e)o
(xtra)g(collapse)g(processing.)34 b(The)26 b(f)o(aulted)g(data)g(can)h
(be)f(in)g(only)g(one)g(of)300 2888 y(tw)o(o)e(places:)31
b(the)25 b(amap)f(layer)h(or)g(the)g(object)f(layer)-5
b(.)583 3038 y(In)27 b(order)f(to)g(properly)g(handle)g(a)h(f)o(ault,)f
(the)g(BSD)i(VM)d(system)h(must)f(do)h(the)g(follo)n(wing)e(if)j(it)300
3187 y(is)d(going)g(to)h(unlock)f(the)g(maps)h(to)f(perform)h(I/O:)445
3420 y Fr(\017)49 b Fs(A)25 b(b)n(usy)f(page)h(must)f(be)h(placed)g(in)
f(the)h(top-le)n(v)o(el)e(shado)n(w)h(object)g(of)h(the)g(f)o(aulting)e
(map.)31 b(This)544 3569 y(pre)n(v)o(ents)22 b(a)i(race)h(condition)d
(between)h(the)h(f)o(aulting)f(process)g(and)h(other)f(processes)h
(that)f(share)544 3718 y(the)34 b(same)h(address)f(space.)61
b(W)l(ithout)33 b(the)i(b)n(usy)f(page,)j(tw)o(o)d(processes)h(could)f
(be)h(trying)e(to)544 3868 y(install)23 b(the)i(same)g(page)g(in)f(the)
h(top-le)n(v)o(el)e(object)h(at)h(the)g(same)f(time.)445
4100 y Fr(\017)49 b Fs(An)o(y)31 b(object)h(that)f(the)h(f)o(ault)g
(routine)f(puts)g(a)i(b)n(usy)e(page)h(in)g(must)f(ha)n(v)o(e)h(its)f
(\223paging)g(in)h(pro-)544 4250 y(gress\224)27 b(counter)h
(incremented.)38 b(In)27 b(the)h(BSD)g(VM,)f(an)o(y)g(object)g(that)g
(has)g(a)h(non-zero)g(paging)544 4399 y(in)h(process)f(counter)h(is)g
(not)g(allo)n(wed)f(to)g(be)i(collapsed.)42 b(This)29
b(pre)n(v)o(ents)e(objects)i(from)g(being)544 4548 y(yank)o(ed)c(out)f
(from)g(under)h(the)g(f)o(ault)f(routine)g(while)h(it)f(is)g(w)o
(aiting)g(for)h(I/O)g(to)f(complete.)300 4781 y(Because)h(of)e(UVM')-5
b(s)23 b(tw)o(o-le)n(v)o(el)f(mapping)h(scheme,)g(there)h(is)f(no)h
(need)g(for)f(UVM')-5 b(s)23 b(f)o(ault)g(routine)g(to)300
4930 y(w)o(orry)j(about)f(races)i(do)n(wn)d(an)i(object)g(chain)g(or)f
(objects)h(being)f(collapsed)g(out)g(from)h(under)g(it.)33
b(This)300 5080 y(simpli\002es)23 b(UVM')-5 b(s)24 b(f)o(ault)h
(handling.)p eop
%%Page: 117 137
117 136 bop 3751 100 a Fs(117)300 249 y Ff(5.3.3)119
b(Mapping)31 b(Neighboring)g(Resident)g(P)o(ages)300
466 y Fs(As)39 b(e)o(xplained)f(earlier)l(,)44 b(the)39
b(UVM)g(f)o(ault)g(routine)g(maps)g(in)g(neighboring)e(resident)i
(pages)h(while)300 615 y(processing)28 b(a)h(f)o(ault.)42
b(This)27 b(usually)h(reduces)h(the)f(total)g(number)g(of)h(page)g(f)o
(aults)f(processes)g(ha)n(v)o(e)g(to)300 764 y(tak)o(e.)34
b(In)26 b(contrast,)g(the)f(BSD)i(VM)e(f)o(ault)h(routine)f(ignores)h
(neighboring)e(pages.)34 b(If)26 b(the)o(y)f(are)i(needed)300
914 y(the)o(y)c(will)g(be)h(f)o(aulted)g(in)g(later)-5
b(.)30 b(Thus,)23 b(UVM)h(reduces)g(process')g(f)o(ault)f(o)o(v)o
(erhead.)30 b(F)o(or)24 b(e)o(xample,)f(the)300 1063
y(number)g(of)g(pages)g(f)o(aults)g(for)h(the)f(command)f(\223)p
Fm(ls)60 b(/)p Fs(\224)23 b(w)o(as)h(reduced)g(from)f(59)g(to)g(33)g
(by)g(UVM)g(\(see)300 1213 y(Section)i(10.5.3\).)583
1362 y(It)e(should)f(be)g(noted)h(that)f(UVM')-5 b(s)21
b(tw)o(o-le)n(v)o(el)g(mapping)h(scheme)g(mak)o(es)h(mapping)e(in)h
(neigh-)300 1511 y(boring)31 b(pages)h(relati)n(v)o(ely)f(easy)-6
b(.)52 b(The)32 b(neighboring)e(pages)i(are)h(either)f(in)g(the)g(amap)
g(or)g(the)g(object)300 1661 y(layer)-5 b(.)30 b(In)22
b(the)g(BSD)i(VM)e(system)f(to)h(search)h(for)g(neighboring)e(pages,)i
(the)f(f)o(ault)g(routine)g(w)o(ould)f(ha)n(v)o(e)300
1810 y(the)k(additional)e(o)o(v)o(erhead)h(of)h(w)o(alking)f(the)h
(object)f(chains)g(to)h(\002nd)g(neighboring)e(pages.)300
2194 y Fg(5.4)143 b(Summary)300 2446 y Fs(In)26 b(this)f(chapter)i(we)f
(ha)n(v)o(e)g(re)n(vie)n(wed)f(the)h(function)f(of)i(the)e(UVM)h(f)o
(ault)g(routine.)34 b(W)-8 b(e)26 b(e)o(xplained)f(the)300
2596 y(steps)34 b(the)g(f)o(ault)g(routine)g(goes)g(through)f(to)h
(resolv)o(e)g(a)g(f)o(ault.)59 b(The)35 b(possible)e(errors)h(that)g
(the)g(f)o(ault)300 2745 y(routine)28 b(may)h(encounter)f(and)h(ho)n(w)
f(it)g(reco)o(v)o(ers)h(from)f(the)h(were)g(described.)43
b(Finally)-6 b(,)28 b(some)g(of)h(the)300 2895 y(dif)n(ferences)c
(between)g(the)f(UVM)h(f)o(ault)f(routine)g(and)h(the)g(BSD)h(VM)e(f)o
(ault)g(routine)h(were)g(presented.)p eop
%%Page: 118 138
118 137 bop 3751 100 a Fs(118)300 973 y Fp(Chapter)51
b(6)300 1448 y(P)n(ager)h(Interface)300 1930 y Fs(This)34
b(chapter)g(describes)h(UVM')-5 b(s)33 b(pager)i(interf)o(ace.)60
b(The)35 b(pager)g(is)f(responsible)f(for)i(performing)300
2079 y(operations)e(on)h Fm(uvm)p 1069 2079 30 4 v 36
w(object)f Fs(structures.)58 b(Such)35 b(operations)e(include)h
(changing)f(the)h(reference)300 2229 y(count)29 b(of)g(a)h
Fm(uvm)p 923 2229 V 35 w(object)e Fs(and)i(transferring)f(data)h
(between)f(backing)g(store)g(and)h(physical)e(mem-)300
2378 y(ory)-6 b(.)38 b(This)27 b(chapter)g(contains)g(a)h(description)e
(of)h(the)h(role)f(of)h(the)f(pager)l(,)h(e)o(xplanations)e(of)h(the)h
(pager)300 2527 y(functions,)c(and)g(a)i(comparison)d(of)i(UVM')-5
b(s)24 b(pager)h(interf)o(ace)h(with)e(the)g(BSD)i(VM)e(pager)h(interf)
o(ace.)300 2909 y Fg(6.1)143 b(The)35 b(Role)g(of)g(the)g(P)o(ager)300
3161 y Fs(In)24 b(UVM,)g(a)g(pager)g(is)g(a)g(data)g(structure)g(that)g
(contains)f(pointers)g(to)g(a)i(set)f(of)g(functions)f(that)g(perform)
300 3311 y(operations)28 b(on)h(a)g Fm(uvm)p 1132 3311
V 35 w(object)p Fs(.)42 b(Each)30 b Fm(uvm)p 2003 3311
V 35 w(object)e Fs(structure)g(on)h(the)g(system)f(has)g(a)i(pointer)
300 3460 y(to)24 b(its)g(set)h(of)g(pager)g(functions.)30
b(UVM)24 b(currently)h(has)f(three)h(pagers:)300 3679
y Fo(aobj:)49 b Fs(The)20 b(aobj)g(pager)g(is)g(used)f(by)h
Fm(uvm)p 1773 3679 V 35 w(object)f Fs(structures)h(that)f(contain)h
(anon)o(ymous)e(memory)-6 b(.)300 3907 y Fo(de)o(vice:)49
b Fs(The)24 b(de)n(vice)f(pager)h(is)f(used)g(by)g Fm(uvm)p
1956 3907 V 35 w(object)g Fs(structures)f(that)h(contain)g(de)n(vice)h
(memory)-6 b(.)300 4135 y Fo(vnode:)50 b Fs(The)20 b(vnode)h(pager)g
(is)f(used)g(by)h Fm(uvm)p 1916 4135 V 35 w(object)e
Fs(structures)h(that)g(contain)g(normal)g(\002le)i(mem-)544
4284 y(ory)-6 b(.)300 4504 y(UVM)20 b(performs)h(all)g(pager)n
(-related)g(operations)f(on)h(a)g Fm(uvm)p 2407 4504
V 35 w(object)f Fs(through)g(its)g(pager)h(functions.)300
4653 y(This)e(allo)n(ws)f(UVM)h(to)h(treat)f Fm(uvm)p
1506 4653 V 36 w(object)f Fs(structures)h(that)g(represent)h(dif)n
(ferent)f(types)g(of)h(memory)300 4802 y(alik)o(e.)583
4952 y(Note)38 b(that)g(there)g(are)h(tw)o(o)f(types)f(of)h(memory)g
(objects)f(in)h(UVM:)f Fm(uvm)p 3247 4952 V 35 w(object)g
Fs(struc-)300 5101 y(tures)29 b(and)h(anon)f(structures.)44
b(P)o(agers)30 b(only)f(perform)g(operations)g(on)g Fm(uvm)p
2988 5101 V 35 w(object)g Fs(memory)f(ob-)300 5251 y(jects.)60
b(F)o(or)35 b(the)g(remainder)g(of)g(this)e(chapter)j(the)e(term)h
(\223object\224)g(will)f(be)h(used)f(as)h(shorthand)f(for)300
5400 y(\223)p Fm(uvm)p 530 5400 V 35 w(object)24 b Fs(structure.)-7
b(\224)p eop
%%Page: 119 139
119 138 bop 3751 100 a Fs(119)p 376 153 3449 4 v 374
273 4 121 v 426 237 a Fo(Function)p 1323 273 V 567 w(Description)p
3822 273 V 376 276 3449 4 v 374 517 4 241 v 426 361 a
Fm(pgo)p 612 361 30 4 v 35 w(init)p 1323 517 4 241 v
493 w Fs(init)20 b(a)h(pager')-5 b(s)21 b(pri)n(v)n(ate)e(data)i
(structures)f(\226)h(called)f(when)h(the)f(system)1374
481 y(is)25 b(booted)p 3822 517 V 376 521 3449 4 v 374
761 4 241 v 426 605 a(attach)p 1323 761 V 710 w(gain)g(a)i(reference)g
(to)f(k)o(ernel)g(data)g(structure)f(that)h(can)g(be)g(memory)1374
725 y(mapped)f(by)f(an)h(object)p 3822 761 V 376 765
3449 4 v 374 885 4 121 v 426 849 a Fm(pgo)p 612 849 30
4 v 35 w(reference)p 1323 885 4 121 v 193 w Fs(add)g(a)g(reference)i
(to)d(an)h(object)p 3822 885 V 376 888 3449 4 v 374 1009
4 121 v 426 973 a Fm(pgo)p 612 973 30 4 v 35 w(detach)p
1323 1009 4 121 v 373 w Fs(drop)g(a)g(reference)h(to)f(an)g(object)p
3822 1009 V 376 1012 3449 4 v 374 1132 4 121 v 426 1096
a Fm(pgo)p 612 1096 30 4 v 35 w(get)p 1323 1132 4 121
v 553 w Fs(get)g(pages)g(from)f(backing)h(store)p 3822
1132 V 376 1136 3449 4 v 374 1377 4 241 v 426 1220 a
Fm(pgo)p 612 1220 30 4 v 35 w(asyncget)p 1323 1377 4
241 v 253 w Fs(start)h(an)g(asynchronous)f(I/O)i(operation)e(to)h(get)g
(pages)g(from)g(back-)1374 1340 y(ing)e(store)p 3822
1377 V 376 1380 3449 4 v 374 1500 4 121 v 426 1464 a
Fm(pgo)p 612 1464 30 4 v 35 w(fault)p 1323 1500 4 121
v 433 w Fs(object)h(f)o(ault)f(handler)h(function)p 3822
1500 V 376 1504 3449 4 v 374 1624 4 121 v 426 1588 a
Fm(pgo)p 612 1588 30 4 v 35 w(put)p 1323 1624 4 121 v
553 w Fs(write)g(pages)g(to)f(backing)g(store)p 3822
1624 V 376 1627 3449 4 v 374 1748 4 121 v 426 1711 a
Fm(pgo)p 612 1711 30 4 v 35 w(flush)p 1323 1748 4 121
v 433 w Fs(\003ush)h(an)g(object')-5 b(s)24 b(pages)g(from)h(memory)p
3822 1748 V 376 1751 3449 4 v 374 1871 4 121 v 426 1835
a Fm(pgo)p 612 1835 30 4 v 35 w(cluster)p 1323 1871 4
121 v 313 w Fs(determine)20 b(ho)n(w)g(man)o(y)f(pages)h(can)h(be)g
(get)f(or)g(put)g(at)h(the)f(same)g(time)p 3822 1871
V 376 1875 3449 4 v 374 1995 4 121 v 426 1959 a Fm(pgo)p
612 1959 30 4 v 35 w(mk)p 767 1959 V 35 w(pcluster)p
1323 1995 4 121 v 98 w Fs(mak)o(e)25 b(a)g(cluster)g(for)g(a)g(pageout)
f(operation)p 3822 1995 V 376 1998 3449 4 v 374 2119
4 121 v 426 2083 a Fm(pgo)p 612 2083 30 4 v 35 w(shareprot)p
1323 2119 4 121 v 193 w Fs(change)e(protection)e(of)i(an)f(object)g
(that)g(is)g(mapped)g(by)g(a)h(share)g(map)p 3822 2119
V 376 2122 3449 4 v 374 2242 4 121 v 426 2206 a Fm(pgo)p
612 2206 30 4 v 35 w(aiodone)p 1323 2242 4 121 v 313
w Fs(handle)j(the)f(completion)g(of)g(an)h(asynchronous)f(I/O)h
(operation)p 3822 2242 V 376 2246 3449 4 v 374 2366 4
121 v 426 2330 a Fm(pgo)p 612 2330 30 4 v 35 w(releasepg)p
1323 2366 4 121 v 193 w Fs(free)h(a)f(released)g(page)p
3822 2366 V 376 2369 3449 4 v 300 2529 a(T)-8 b(able)51
b(6.1:)81 b(The)51 b(P)o(ager)g(Operations.)107 b(Note)50
b(that)g(the)h(attach)f(function)g(is)g(not)g(part)h(of)f(the)300
2649 y Fm(uvm)p 486 2649 30 4 v 35 w(pagerops)23 b Fs(structure.)300
3038 y Fg(6.2)143 b(P)o(ager)34 b(Operations)300 3291
y Fs(A)21 b(pager)h(is)f(composed)f(of)h(a)h(set)f(of)g(functions)f
(that)h(perform)g(operations)f(on)h(an)h(object.)29 b(These)21
b(func-)300 3440 y(tions)i(are)h(called)g(pager)g(operations.)29
b(Pointers)23 b(to)h(all)f(of)h(these)f(functions)g(e)o(xcept)g(one)h
(\(the)g(\223attach\224)300 3589 y(function\))k(are)h(de\002ned)h(by)e
(a)h Fm(uvm)p 1554 3589 V 35 w(pagerops)e Fs(structure.)42
b(This)28 b(section)g(contains)g(a)h(description)300
3739 y(of)c(each)g(of)g(the)g(pager)g(operations.)30
b(The)25 b(pager)g(operations)f(are)h(summarized)f(in)h(T)-8
b(able)24 b(6.1.)300 4070 y Ff(6.2.1)119 b(The)30 b(Init)g(Operation)
300 4287 y Fs(UVM)35 b(k)o(eeps)g(a)g(global)f(list)h(of)g(all)g
(pagers)g(in)g(the)g(VM)f(system.)61 b(When)35 b(the)g(system)f(is)h
(booting,)300 4436 y(UVM')-5 b(s)25 b(startup)h(routine)g(will)g(call)g
(each)h(pager')-5 b(s)27 b Fm(pgo)p 2294 4436 V 35 w(init)f
Fs(function.)35 b(This)25 b(allo)n(ws)h(each)h(pager)300
4585 y(to)e(set)g(up)g(an)o(y)g(global)f(data)i(structures)e(it)h
(needs)h(before)f(the)h(pager)f(is)g(\002rst)h(used.)31
b(F)o(or)26 b(e)o(xample,)e(the)300 4735 y(de)n(vice)i(pager)i(k)o
(eeps)e(a)i(link)o(ed)d(list)h(of)h(all)g(allocated)f(de)n(vice-back)o
(ed)h(objects.)36 b(The)27 b(de)n(vice)f(pager')-5 b(s)300
4884 y Fm(pgo)p 486 4884 V 35 w(init)24 b Fs(function)g(initializes)g
(this)f(list)h(to)h(the)f(empty)g(state.)583 5033 y(Note)f(that)g(the)g
(pager)g(init)f(function)g(is)h(not)f(needed)h(by)g(all)g(pagers.)30
b(P)o(agers)23 b(that)g(do)f(not)h(need)300 5183 y(to)h(perform)h(an)o
(y)f(actions)h(at)f(system)g(startup)g(time)g(can)h(set)g(the)g
Fm(pgo)p 2751 5183 V 35 w(init)f Fs(pointer)g(to)g Fm(NULL)p
Fs(.)p eop
%%Page: 120 140
120 139 bop 3751 100 a Fs(120)300 249 y Ff(6.2.2)119
b(The)30 b(Attach)g(Operation)300 466 y Fs(A)35 b(pager')-5
b(s)36 b(attach)f(function)g(is)g(used)g(to)g(gain)f(an)i(initial)e
(reference)j(to)e(an)g(object.)63 b(Because)36 b(this)300
615 y(function)i(must)h(be)g(called)g(before)h(the)f(VM)g(system)f(has)
i(a)f(pointer)g(to)g(the)g(object)g(and)g(its)g(cor)n(-)300
764 y(responding)33 b Fm(uvm)p 963 764 30 4 v 36 w(pagerops)g
Fs(structure,)j(the)f(attach)f(function)g(is)g(not)g(included)g(as)h
(part)g(of)f(the)300 914 y Fm(uvm)p 486 914 V 35 w(pagerops)k
Fs(structure.)75 b(The)39 b(attach)h(function)f(returns)g(a)h(pointer)f
(to)g(the)g Fm(uvm)p 3512 914 V 35 w(object)300 1063
y Fs(structure.)583 1213 y(Each)26 b(of)e(UVM')-5 b(s)24
b(three)h(pagers)g(has)g(its)f(o)n(wn)g(attach)h(function.)30
b(These)24 b(functions)g(are:)300 1445 y Fd(uao)p 486
1445 V 35 w(create)p Fo(:)48 b Fs(the)35 b(aobj)f(pager)i(attach)f
(function.)60 b(The)35 b Fm(uao)p 2643 1445 V 35 w(create)f
Fs(functions)g(allocates)h(a)544 1594 y(ne)n(w)23 b(aobj-object)g(of)h
(the)g(speci\002ed)g(size)g(and)g(returns)f(a)i(pointer)e(to)g(its)g
Fm(uvm)p 3261 1594 V 36 w(object)f Fs(struc-)544 1744
y(ture.)31 b(This)24 b(type)g(of)h(object)f(is)h(used)f(to)h(map)f
(System)g(V)h(shared)g(memory)-6 b(.)300 1976 y Fd(udv)p
486 1976 V 35 w(attach)p Fo(:)48 b Fs(the)22 b(de)n(vice)g(pager)h
(attach)f(function.)29 b(This)22 b(function)f(tak)o(es)h(a)h
Fm(dev)p 3304 1976 V 35 w(t)f Fs(de)n(vice)g(iden-)544
2126 y(ti\002er)j(and)f(returns)g(a)h(pointer)f(to)g(its)g
Fm(uvm)p 2009 2126 V 35 w(object)p Fs(.)30 b(If)24 b(the)h(de)n(vice)f
(does)g(not)g(currently)g(ha)n(v)o(e)544 2275 y(a)32
b Fm(uvm)p 806 2275 V 35 w(object)f Fs(structure)h(allocated)g(for)g
(it)g(then)g(the)g(attach)g(function)f(will)g(allocate)h(one)544
2424 y(for)25 b(the)g(de)n(vice.)300 2657 y Fd(uvn)p
486 2657 V 35 w(attach)p Fo(:)48 b Fs(the)36 b(vnode)g(pager)h(attach)g
(function.)65 b(This)35 b(function)h(tak)o(es)g(a)h(pointer)f(to)g(a)h
(vn-)544 2806 y(ode)g(structure)f(and)h(returns)f(a)h(pointer)f(to)h
(the)f(vnode')-5 b(s)36 b Fm(uvm)p 2810 2806 V 35 w(object)g
Fs(structure.)66 b(If)37 b(the)544 2956 y Fm(uvm)p 730
2956 V 35 w(object)27 b Fs(structure)h(is)g(not)g(being)g(used,)g(then)
g Fm(uvn)p 2646 2956 V 36 w(attach)f Fs(will)g(initialize)g(it.)41
b(The)544 3105 y Fm(uvn)p 730 3105 V 35 w(attach)22 b
Fs(function)g(also)g(tak)o(es)h(an)g(access)g(le)n(v)o(el)f(as)h(an)g
(ar)n(gument.)30 b(The)22 b(access)i(le)n(v)o(el)e(is)544
3254 y(used)i(to)h(determine)f(if)h(the)g(vnode)f(is)g(being)h(mapped)f
(writable)g(or)h(not.)300 3487 y(All)f(of)h(the)g(attach)g(functions)e
(return)i Fm(NULL)f Fs(if)h(the)g(attach)f(operation)h(f)o(ails.)300
3818 y Ff(6.2.3)119 b(The)30 b(Refer)n(ence)h(Operation)300
4035 y Fs(The)23 b(reference)i(function)d(tak)o(es)h(a)h(pointer)e(to)h
(an)g(unlock)o(ed)g(object)f(and)i(adds)e(a)i(reference)h(to)d(it.)30
b(The)300 4184 y(reference)k(function)e(is)g(called)h(when)f
(performing)g(mapping)f(operations.)53 b(F)o(or)33 b(e)o(xample,)g
(when)g(a)300 4333 y(process)c(is)f(forking)h(a)g(child)f(process,)i
(the)f(child)f(gains)g(a)i(reference)g(to)f(an)o(y)f
Fm(uvm)p 3256 4333 V 35 w(object)g Fs(struc-)300 4483
y(tures)d(that)f(it)g(inherits)g(from)h(the)f(parent)h(process.)300
4814 y Ff(6.2.4)119 b(The)30 b(Detach)g(Operation)300
5031 y Fs(The)j(detach)f(function)g(tak)o(es)g(a)h(pointer)f(to)g(an)h
(unlock)o(ed)f(object)g(and)g(drops)g(a)h(reference)h(from)f(it.)300
5180 y(The)g(detach)f(function)g(is)g(called)h(during)f(an)h(unmap)f
(operation)g(to)g(dispose)g(of)g(an)o(y)g(references)i(to)300
5329 y Fm(uvm)p 486 5329 V 35 w(object)24 b Fs(structures)g(the)h(area)
g(being)g(unmapped)f(may)g(ha)n(v)o(e.)p eop
%%Page: 121 141
121 140 bop 3751 100 a Fs(121)300 249 y Ff(6.2.5)119
b(The)30 b(Get)g(Operation)300 466 y Fs(The)k(get)f(function)g(is)g
(used)h(to)f(obtain)g(pages)h(from)f(an)h(object.)57
b(It)34 b(is)f(most)f(frequently)i(called)f(by)300 615
y(the)26 b(page)h(f)o(ault)g(routine)e(to)i(get)f(an)h(object')-5
b(s)25 b(pages)i(to)f(help)g(resolv)o(e)g(a)h(page)g(f)o(ault.)36
b(The)26 b(get)h(routine)300 764 y(returns)e(one)f(or)h(more)g
(contiguous)e(pages)i(in)f(an)h(object.)583 914 y(When)36
b(requesting)e(a)h(block)g(of)g(pages,)j(the)d(f)o(ault)g(routine)f
(has)h(one)g(page)h(that)e(it)h(is)g(espe-)300 1063 y(cially)28
b(interested)h(in)f(\227)h(the)f(one)h(the)g(page)g(f)o(ault)g
(occurred)g(in.)43 b(That)28 b(page)h(is)g(called)f(the)h
(\223center\224)300 1213 y(page.)46 b(While)30 b(the)f(get)h(must)f(al)
o(w)o(ays)g(fetch)h(the)g(center)g(page)h(if)e(possible,)h(fetching)g
(the)f(requested)300 1362 y(neighboring)i(pages)h(is)g(left)g(up)g(to)g
(the)g(get)g(function.)52 b(This)31 b(beha)n(vior)h(can)h(be)f
(modi\002ed)g(with)f(the)300 1511 y(\223allpages\224)26
b(\003ag.)36 b(If)27 b(set,)g(this)e(instructs)g(the)i(get)f(function)f
(that)h(all)h(pages)f(are)h(of)f(equal)h(importance)300
1661 y(and)e(that)f(the)o(y)g(should)g(all)g(be)h(fetched.)583
1810 y(As)j(e)o(xplained)f(earlier)i(in)f(Chapter)h(5,)f(the)g(get)g
(operation)g(has)g(tw)o(o)g(modes)f(of)h(operation:)37
b(a)300 1960 y(lock)o(ed)c(get)g(and)g(an)g(unlock)o(ed)g(get.)55
b(In)34 b(a)f(lock)o(ed)g(get)g(the)g(calling)f(function)h(is)f
(assumed)h(to)f(ha)n(v)o(e)300 2109 y(critical)37 b(data)g(structures)f
(\(including)g(the)h(object\))g(lock)o(ed)f(and)h(does)g(not)g(wish)f
(to)h(unlock)f(them.)300 2258 y(Because)26 b(returning)f(non-resident)g
(pages)g(requires)g(an)h(I/O)f(operation)g(and)g(I/O)g(operations)g
(require)300 2408 y(the)33 b(calling)g(function)g(to)g(sleep,)i(which)e
(in)g(turn)g(requires)h(data)f(structures)g(to)g(be)h(unlock)o(ed,)h
(only)300 2557 y(resident)25 b(pages)h(can)h(be)f(returned)g(by)f(a)h
(lock)o(ed)g(get.)34 b(In)26 b(an)g(unlock)o(ed)f(get,)h(the)g(pager)g
(is)g(allo)n(wed)e(to)300 2707 y(unlock)g(the)h(object)f(and)h(perform)
g(I/O.)583 2856 y(The)g(get)g(function)f(tak)o(es)h(eight)f(ar)n
(guments:)300 3088 y Fo(uobj:)50 b Fs(A)31 b(pointer)g(to)g(the)g(lock)
o(ed)h(object)f(whose)g(data)g(is)g(being)g(requested.)51
b(This)31 b(object)g(may)g(be)544 3238 y(unlock)o(ed)24
b(for)h(I/O)g(only)f(in)g(an)h(unlock)o(ed)f(get)h(operation.)300
3470 y Fo(offset:)49 b Fs(The)25 b(location)f(in)g(the)h(object)f(of)h
(the)g(\002rst)g(page)g(being)f(requested.)300 3703 y
Fo(pps:)49 b Fs(An)35 b(array)h(of)f(pointers)e(to)i
Fm(vm)p 1640 3703 30 4 v 35 w(page)f Fs(structures.)60
b(There)36 b(is)e(one)h(pointer)f(per)h(page)g(in)f(the)544
3852 y(requested)24 b(range.)31 b(The)24 b(calling)f(function)g
(initializes)g(the)h(pointers)f(to)h(null)f(if)h(the)g(get)g(routine)
544 4001 y(is)e(to)h(fetch)g(the)g(page.)30 b(An)o(y)22
b(other)g(v)n(alue)h(\(including)e(the)i(\223don')n(t)g(care\224)h(v)n
(alue\))e(will)g(cause)h(the)544 4151 y(get)i(function)e(to)i(skip)f(o)
o(v)o(er)g(that)g(page.)300 4383 y Fo(npagesp:)50 b Fs(A)31
b(pointer)g(to)g(an)h(inte)o(ger)f(that)g(contains)f(the)i(number)f(of)
g(page)h(pointers)f(in)g(the)g(\223pps\224)544 4533 y(array)-6
b(.)29 b(F)o(or)20 b(lock)o(ed)f(get)h(operations,)f(the)h(number)f(of)
h(pages)f(found)h(is)f(returned)g(in)h(this)e(inte)o(ger)-5
b(.)300 4765 y Fo(centeridx:)50 b Fs(The)25 b(inde)o(x)f(of)h(the)g
(\223center\224)g(page)g(in)g(the)f(pps)h(array)-6 b(.)300
4997 y Fo(access)p 566 4997 V 36 w(type:)49 b Fs(Indicates)23
b(ho)n(w)f(the)h(caller)g(w)o(ants)g(to)f(access)i(the)f(page.)30
b(The)23 b(access)g(type)g(will)f(either)544 5147 y(be)j(read)g(or)g
(write.)p eop
%%Page: 122 142
122 141 bop 3751 100 a Fs(122)300 249 y Fo(advice:)49
b Fs(A)21 b(hint)g(to)f(the)i(pager)f(as)g(to)g(the)g(calling)g
(process')g(access)h(pattern)f(on)g(the)g(object')-5
b(s)20 b(memory)544 398 y(\(for)g(e)o(xample,)f(normal,)g(random,)h(or)
f(sequential\).)28 b(This)19 b(v)n(alue)f(usually)h(comes)f(from)h(the)
g(map)544 548 y(entry)25 b(data)f(structure')-5 b(s)24
b(advice)h(\002eld.)300 780 y Fo(\003ags:)49 b Fs(Flags)23
b(for)g(the)f(get)h(operation.)29 b(The)23 b(get)g(function)f(has)g(tw)
o(o)h(\003ags:)29 b(\223lock)o(ed\224)23 b(and)g(\223allpages.)-7
b(\224)583 1013 y(The)32 b(get)g(function)f(returns)h(an)g(inte)o(ger)f
(code)h(v)n(alue)g(that)f(indicates)g(the)h(results)f(of)h(the)g(get)
300 1162 y(operation.)e(Possible)24 b(return)h(v)n(alues)f(are:)300
1394 y Fd(VM)p 426 1394 30 4 v 35 w(PAGER)p 761 1394
V 35 w(OK)p Fo(:)49 b Fs(The)24 b(get)h(operation)f(w)o(as)h
(successful.)300 1627 y Fd(VM)p 426 1627 V 35 w(PAGER)p
761 1627 V 35 w(BAD)p Fo(:)48 b Fs(The)25 b(requested)g(pages)g(are)g
(not)f(part)h(of)g(the)g(object.)300 1859 y Fd(VM)p 426
1859 V 35 w(PAGER)p 761 1859 V 35 w(ERROR)p Fo(:)48 b
Fs(An)35 b(I/O)h(error)g(occurred)g(while)f(fetching)g(the)g(data.)63
b(This)35 b(is)g(usually)f(the)544 2009 y(result)24 b(of)h(a)g(hardw)o
(are)h(problem.)300 2241 y Fd(VM)p 426 2241 V 35 w(PAGER)p
761 2241 V 35 w(AGAIN)p Fo(:)48 b Fs(A)25 b(temporary)f(resource)i
(shortage)e(occurred.)300 2474 y Fd(VM)p 426 2474 V 35
w(PAGER)p 761 2474 V 35 w(UNLOCK)p Fo(:)48 b Fs(The)26
b(requested)g(pages)h(cannot)f(be)g(retrie)n(v)o(ed)g(without)f
(unlocking)g(the)h(ob-)544 2623 y(ject)f(for)g(I/O.)f(This)g(v)n(alue)h
(can)g(only)f(be)h(returned)g(by)f(a)h(lock)o(ed)g(get)f(operation.)300
2855 y(The)31 b(get)g(operation)f(sets)h(the)f(b)n(usy)h(\003ag)g(on)g
(an)o(y)f(page)h(it)g(returns)g(on)f(behalf)h(of)g(the)g(caller)-5
b(.)49 b(When)300 3005 y(the)32 b(caller)h(is)g(\002nished)f(with)g
(the)g(pages)h(it)f(must)f(clear)j(the)e(b)n(usy)g(\003ag.)55
b(Note)32 b(that)g(there)h(is)g(also)f(a)300 3154 y Fm(VM)p
426 3154 V 35 w(PAGER)p 761 3154 V 35 w(PEND)d Fs(return)h(v)n(alue)f
(that)g(is)h(used)f(for)h(asynchronous)f(I/O.)g(Since)i(the)e(get)h
(operation)300 3304 y(is)24 b(al)o(w)o(ays)h(synchronous)e(it)i(cannot)
f(return)h(this)f(v)n(alue.)583 3453 y(The)e(get)g(operation)f(can)i
(be)f(called)f(by)h(the)g(f)o(ault)f(routine)g(or)h(the)g(loanout)f
(routine)g(\(described)300 3602 y(in)j(Chapter)g(7\).)31
b(Once)24 b(the)g(calling)f(routine)g(looks)g(up)h(the)f(f)o(aulting)g
(or)h(loaning)f(address)h(in)g(the)g(map,)300 3752 y(it)d(then)h
(determines)f(the)h(range)g(of)h(interest.)29 b(The)22
b(range)g(includes)f(the)h(page)g(currently)g(being)f(f)o(aulted)300
3901 y(or)26 b(loaned)f(and)h(an)o(y)f(neighboring)f(pages)h(of)h
(interest.)32 b(The)26 b(calling)f(routine)g(then)g(checks)h(the)f
(amap)300 4051 y(layer)36 b(for)g(the)g(page.)63 b(If)36
b(the)g(page)g(is)f(not)g(found)h(in)f(the)h(amap)f(layer)h(and)g
(there)g(is)f(an)h(object)f(in)300 4200 y(the)25 b(object)g(layer)l(,)g
(then)g(the)g(calling)g(routine)f(performs)h(a)g(lock)o(ed)g(get)g
(operation)g(using)f(the)h(object')-5 b(s)300 4349 y(get)29
b(routine.)45 b(The)29 b(calling)g(routine)g(passes)g(an)h(array)g(of)f
(page)h(pointers)f(into)f(the)i(get)f(routine)g(with)300
4499 y(the)k(f)o(aulting)f(or)h(loaning)g(page)g(as)g(the)g(center)h
(page.)56 b(The)33 b(pointers)f(for)i(neighboring)d(pages)j(that)300
4648 y(are)h(already)g(in)f(the)g(amap)g(layer)h(are)g(set)f(to)g
(\223don')n(t)h(care.)-7 b(\224)60 b(The)35 b(rest)f(of)g(the)h
(pointers)e(are)i(set)f(to)300 4797 y(null.)29 b(If)22
b(the)g(lock)o(ed)g(get)g(\002nds)g(the)g(center)g(page)g(resident)g
(and)g(a)n(v)n(ailable)f(it)h(returns)f Fm(VM)p 3391
4797 V 36 w(PAGER)p 3727 4797 V 35 w(OK)p Fs(,)300 4947
y(otherwise)i(it)g(returns)h Fm(VM)p 1217 4947 V 35 w(PAGER)p
1552 4947 V 35 w(UNLOCK)p Fs(.)e(If)j(the)e(pager)h(returns)g
(\223ok\224)g(then)f(the)h(calling)f(routine)300 5096
y(has)j(all)g(the)g(pages)g(it)g(needs.)34 b(It)26 b(need)h(only)e
(clear)i(the)f(b)n(usy)f(\003ag)i(on)f(the)g(pages)g(it)g(gets)f(from)h
(the)g(get)300 5246 y(operation)j(before)h(returning.)44
b(Note)30 b(that)f(a)h(get)f(operation)g(can)h(still)e(return)h
(neighboring)g(resident)300 5395 y(pages)c(e)n(v)o(en)f(if)h(it)f
(returns)g Fm(VM)p 1354 5395 V 36 w(PAGER)p 1690 5395
V 35 w(UNLOCK)p Fs(.)p eop
%%Page: 123 143
123 142 bop 3751 100 a Fs(123)583 249 y(If)28 b(the)e(lock)o(ed)h(get)f
(returns)h Fm(VM)p 1695 249 30 4 v 35 w(PAGER)p 2030
249 V 35 w(UNLOCK)p Fs(,)e(then)i(the)f(calling)g(routine)g(will)g(e)n
(v)o(entu-)300 398 y(ally)f(ha)n(v)o(e)h(to)g(unlock)f(its)g(data)h
(structures)f(and)h(perform)g(an)g(unlock)o(ed)g(get.)34
b(Note)25 b(that)h(an)g(unlock)o(ed)300 548 y(get)h(operation)g
(requires)g(a)h(lock)o(ed)f(object.)37 b(The)28 b(get)f(routine)f(will)
h(unlock)f(the)i(object)e(before)i(start-)300 697 y(ing)i(I/O.)h(When)g
(I/O)f(is)h(complete,)g(the)g(get)f(routine)g(will)g(return)h(with)f
(the)h(object)f(unlock)o(ed.)48 b(The)300 847 y(calling)28
b(routine)g(must)g(then)h(relock)g(all)f(its)g(data)h(structures)f(and)
h(re)n(v)o(erify)g(the)f(map)h(lookup)f(before)300 996
y(continuing)23 b(to)i(process.)300 1327 y Ff(6.2.6)119
b(The)30 b(Asyncget)g(Operation)300 1544 y Fs(The)35
b(asyncget)f(function)f(causes)i(the)f(pager)h(to)f(start)h(paging)e
(in)h(an)h(object')-5 b(s)34 b(data)g(from)h(backing)300
1693 y(store.)29 b(Ho)n(we)n(v)o(er)l(,)21 b(unlik)o(e)f(the)i(normal)e
(get)h(operation,)h(the)f(asyncget)g(function)f(returns)h(after)h
(starting)300 1843 y(I/O)j(\227)g(it)f(does)h(not)g(w)o(ait)f(for)i(it)
e(to)h(complete.)31 b(This)24 b(allo)n(ws)g(the)h(VM)g(system)e(to)i
(preload)g(data)g(in)g(an)300 1992 y(object)f(in)h(hopes)f(of)h(ha)n
(ving)f(the)h(data)g(resident)f(by)h(the)f(time)g(it)g(is)h(needed.)583
2141 y(UVM)38 b(currently)f(does)h(not)f(use)h(the)g(asyncget)f
(operation.)69 b(It)38 b(is)g(pro)o(vided)e(for)i(possible)300
2291 y(future)25 b(use)g(to)f(impro)o(v)o(e)f(the)i(performance)g(of)g
(the)f(system.)300 2622 y Ff(6.2.7)119 b(The)30 b(F)m(ault)g(Operation)
300 2839 y Fs(The)j(f)o(ault)f(function)g(is)h(an)g(operation)f(that)g
(allo)n(ws)g(the)g(pager)h(more)g(control)f(o)o(v)o(er)g(ho)n(w)g(its)g
(pages)300 2988 y(are)f(f)o(aulted)g(in.)48 b(P)o(agers)31
b(either)f(ha)n(v)o(e)h(a)g(\223get\224)g(operation)f(or)h(a)g(\223f)o
(ault\224)g(operation.)47 b(The)31 b(pager)g(get)300
3137 y(operation)d(tak)o(es)h(an)h(object)e(and)h(returns)g(pointers)f
(to)h Fm(vm)p 2396 3137 V 36 w(page)f Fs(structures.)43
b(F)o(or)29 b(pagers)g(such)g(as)300 3287 y(the)f(de)n(vice)f(pager)h
(this)f(is)h(not)f(suf)n(\002cient.)39 b(The)28 b(de)n(vice)g(pager)g
(manages)f(de)n(vice)h(memory)f(and)h(that)300 3436 y(memory)20
b(does)h(not)g(ha)n(v)o(e)g(or)g(need)h(an)o(y)e Fm(vm)p
1815 3436 V 36 w(page)g Fs(structures)h(associated)g(with)f(it.)29
b(Thus,)21 b(the)g(de)n(vice)300 3586 y(pager)k(has)g(nothing)e(it)i
(can)g(return)g(to)f(the)h(f)o(ault)f(routine)g(through)g(the)h(get)f
(interf)o(ace.)583 3735 y(The)k(pager)h(f)o(ault)f(operation)f(allo)n
(ws)g(the)h(pager)g(to)g(tak)o(e)g(o)o(v)o(er)f(and)h(resolv)o(e)f(a)h
(page)h(f)o(ault)e(on)300 3884 y(its)d(memory)-6 b(.)29
b(It)c(tak)o(es)g(the)f(follo)n(wing)f(eight)h(ar)n(guments:)300
4117 y Fo(u\002:)50 b Fs(A)25 b Fm(uvm)p 776 4117 V 35
w(faultinfo)e Fs(data)i(structure)f(that)g(contains)g(the)h(current)g
(state)g(of)f(the)h(f)o(ault.)300 4349 y Fo(v)o(addr:)50
b Fs(The)20 b(virtual)g(address)g(of)g(the)g(\002rst)h(page)f(in)g(the)
g(requested)h(re)o(gion)e(in)h(the)g(current)h Fm(vm)p
3625 4349 V 35 w(map)p Fs(')-5 b(s)544 4499 y(address)25
b(space.)300 4731 y Fo(pps:)49 b Fs(An)31 b(array)g(of)g
Fm(vm)p 1159 4731 V 35 w(page)f Fs(pointers.)48 b(The)30
b(f)o(ault)h(routine)f(ignores)g(an)o(y)g(page)h(with)e(a)i(non-null)
544 4880 y(pointer)-5 b(.)300 5113 y Fo(npages:)49 b
Fs(The)25 b(number)f(of)h(pages)g(in)f(the)h(pps)f(array)-6
b(.)300 5345 y Fo(centeridx:)50 b Fs(The)25 b(inde)o(x)f(in)g(pps)h(of)
g(the)f(page)h(being)f(f)o(aulted)h(on.)p eop
%%Page: 124 144
124 143 bop 3751 100 a Fs(124)300 249 y Fo(fault)p 505
249 30 4 v 36 w(type:)50 b Fs(The)25 b(f)o(ault)f(type.)300
481 y Fo(access)p 566 481 V 36 w(type:)49 b Fs(The)25
b(access)h(type.)300 714 y Fo(\003ags:)49 b Fs(The)25
b(\003ags)g(\(only)f(\223allpages\224)h(is)f(allo)n(wed\).)300
946 y(The)36 b(f)o(ault)g(operation)f(has)h(the)g(same)g(set)g(of)g
(return)g(v)n(alues)f(as)i(the)f(get)f(operation.)64
b(In)36 b(order)h(for)300 1096 y(the)27 b(f)o(ault)g(operation)f(to)h
(successfully)f(resolv)o(e)h(a)g(f)o(ault,)g(it)g(must)f(call)h
Fm(pmap)p 3020 1096 V 35 w(enter)f Fs(to)h(establish)f(a)300
1245 y(mapping)e(for)h(the)f(page)h(being)g(f)o(aulted.)300
1576 y Ff(6.2.8)119 b(The)30 b(Put)g(Operation)300 1793
y Fs(The)36 b(put)f(function)g(tak)o(es)g(modi\002ed)h
(\(\223dirty\224\))f(pages)h(in)g(an)f(object)h(and)g(\003ushes)f(the)h
(changes)f(to)300 1942 y(backing)28 b(store.)42 b(It)28
b(is)g(called)h(by)f(the)h(pagedaemon)f(and)g(the)h(pager)f(\003ush)h
(operation)f(to)g(clean)h(dirty)300 2092 y(pages.)i(The)24
b(put)h(routine)f(tak)o(es)g(the)h(follo)n(wing)e(ar)n(guments:)300
2324 y Fo(uobj:)50 b Fs(The)20 b(lock)o(ed)f(object)h(to)f(which)h(the)
g(pages)g(belong.)28 b(The)20 b(put)f(function)g(will)g(unlock)h(the)g
(object)544 2473 y(before)25 b(starting)f(I/O)h(and)f(return)h(with)f
(the)h(object)f(unlock)o(ed.)300 2706 y Fo(pps:)49 b
Fs(An)30 b(array)g(of)g(pointers)f(to)g(the)h(pages)f(being)g
(\003ushed.)45 b(The)30 b(pages)g(must)e(ha)n(v)o(e)h(been)h(mark)o(ed)
544 2855 y(b)n(usy)24 b(by)h(the)f(caller)-5 b(.)300
3088 y Fo(npages:)49 b Fs(The)25 b(number)f(of)h(pages)g(in)f(the)h
(pps)f(array)-6 b(.)300 3320 y Fo(\003ags:)49 b Fs(The)33
b(\003ags.)56 b(Currently)33 b(there)h(is)f(only)f(one)h(\003ag:)48
b Fm(PGO)p 2579 3320 V 35 w(SYNCIO)p Fs(.)32 b(If)i(this)e(\003ag)i(is)
e(set)h(then)544 3470 y(synchronous)23 b(I/O)i(rather)g(than)g
(asynchronous)f(I/O)g(is)h(used.)300 3702 y(The)32 b(put)g(operation)f
(returns)h(either)g(one)g(of)g(the)g(return)g(v)n(alues)f(used)h(by)g
(the)g(get)g(operation)f(or)h(\227)300 3851 y(when)e(an)h(asynchronous)
e(I/O)i(operation)f(has)g(been)h(successfully)e(started)i(\227)f
Fm(VM)p 3272 3851 V 35 w(PAGER)p 3607 3851 V 35 w(PEND)p
Fs(.)300 4001 y(In)25 b(cases)h(when)f(the)f(put)h(operation)f(returns)
h Fm(VM)p 2013 4001 V 36 w(PAGER)p 2349 4001 V 34 w(PEND)g
Fs(the)g(pager)g(will)f(unb)n(usy)g(the)h(pages)300 4150
y(and)g(set)f(their)h(clean)g(\003ag)g(rather)h(than)e(the)h(calling)f
(function.)583 4300 y(If)39 b(the)g(put)f(routine)g(returns)g(an)o
(ything)f(other)h(than)g Fm(VM)p 2616 4300 V 36 w(PAGER)p
2952 4300 V 35 w(PEND)f Fs(then)h(the)h(calling)300 4449
y(function)34 b(must)f(clear)i(the)f(pages')h(b)n(usy)f(\003ags.)60
b(If)35 b(the)f(put)g(w)o(as)h(successful)f(it)g(must)f(also)h(set)g
(the)300 4598 y(pages')25 b(clean)g(\003ags)g(to)g(indicate)f(that)g
(the)h(page)g(and)g(backing)f(store)h(are)g(no)n(w)f(in)g(sync.)300
4929 y Ff(6.2.9)119 b(The)30 b(Flush)g(Operation)300
5146 y Fs(The)d(\003ush)g(function)f(performs)g(a)h(number)g(of)g
(\003ushing)f(operations)g(on)g(pages)h(in)g(an)g(object.)36
b(These)300 5295 y(operations)24 b(include:)p eop
%%Page: 125 145
125 144 bop 3751 100 a Fs(125)445 249 y Fr(\017)49 b
Fs(marking)24 b(pages)h(in)f(an)h(object)f(inacti)n(v)o(e.)445
481 y Fr(\017)49 b Fs(remo)o(ving)23 b(pages)i(from)f(an)h(object.)445
714 y Fr(\017)49 b Fs(writing)41 b(dirty)h(pages)h(in)f(an)h(object)f
(to)g(backing)g(store)g(\(either)h(synchronously)e(or)h(asyn-)544
863 y(chronously\).)300 1096 y(The)32 b(\003ush)g(operation)g(is)g
(used)f(by)h(the)g Fm(msync)g Fs(system)f(call)h(to)g(write)g(memory)f
(to)h(backing)f(store)300 1245 y(and)f(in)l(v)n(alidate)f(pages.)46
b(The)30 b(vnode)g(pager)g(uses)g(its)f(\003ush)h(operation)g(to)f
(clean)i(out)e(all)h(pages)g(in)g(a)300 1394 y(vnode')-5
b(s)24 b Fm(uvm)p 821 1394 30 4 v 35 w(object)g Fs(before)h(freeing)g
(it.)583 1544 y(The)g(\003ush)g(routine)f(tak)o(es)h(the)f(follo)n
(wing)f(ar)n(guments:)300 1776 y Fo(uobj:)50 b Fs(The)32
b(lock)o(ed)g(object)f(to)h(which)g(the)g(pages)g(belong.)52
b(The)32 b(\003ush)g(function)f(returns)h(with)f(the)544
1926 y(object)f(lock)o(ed.)49 b(The)31 b(calling)f(function)g(must)g
(not)g(be)h(holding)f(the)h(page)g(queue)g(lock)f(since)544
2075 y(the)c(\003ush)h(function)e(may)h(ha)n(v)o(e)h(to)f(lock)g(it.)35
b(The)26 b(\003ush)h(function)e(will)h(unlock)g(the)g(object)g(if)h(it)
544 2224 y(has)e(to)f(perform)h(an)o(y)f(I/O.)300 2457
y Fo(start:)49 b Fs(The)25 b(starting)f(of)n(fset)g(in)g(the)h(object.)
300 2689 y Fo(end:)50 b Fs(The)24 b(ending)f(of)n(fset)h(in)f(the)h
(object.)30 b(P)o(ages)24 b(from)g(the)g(ending)f(of)n(fset)g(onw)o
(ard)h(are)h(not)e(\003ushed.)300 2922 y Fo(\003ags:)49
b Fs(The)25 b(\003ags.)300 3154 y(The)g(\003ush)g(operation)f(returns)g
(\223TR)l(UE\224)i(unless)e(there)h(w)o(as)g(an)g(I/O)f(error)-5
b(.)583 3304 y(The)23 b(\003ush)f(operation')-5 b(s)21
b(\003ags)i(control)f(ho)n(w)f(the)i(object')-5 b(s)21
b(pages)i(are)g(\003ushed.)30 b(The)22 b(\003ags)h(are:)300
3536 y Fd(PGO)p 486 3536 V 35 w(CLEANIT)p Fo(:)48 b Fs(Write)25
b(dirty)h(pages)f(to)h(backing)f(store.)34 b(If)26 b(this)f(\003ag)i
(is)e(set,)h(then)f(the)h(\003ush)g(func-)544 3685 y(tion)e(will)h
(unlock)f(the)h(object)g(while)g(performing)g(I/O.)g(If)g(this)g
(\003ag)h(is)e(not)h(set,)g(then)g(the)g(\003ush)544
3835 y(function)f(will)g(ne)n(v)o(er)g(unlock)g(the)h(object.)300
4067 y Fd(PGO)p 486 4067 V 35 w(SYNCIO)p Fo(:)48 b Fs(Causes)24
b(all)g(page)h(cleaning)f(I/O)g(operations)f(to)h(be)g(synchronous.)30
b(The)24 b(\003ush)g(rou-)544 4217 y(tine)i(will)f(not)h(return)g
(until)g(I/O)g(is)g(complete.)35 b(This)25 b(\003ag)i(has)f(no)g(ef)n
(fect)h(unless)f(the)g(\223cleanit\224)544 4366 y(\003ag)f(is)g
(speci\002ed.)300 4598 y Fd(PGO)p 486 4598 V 35 w(DOACTCLUST)p
Fo(:)47 b Fs(Causes)56 b(the)g(\003ush)f(function)g(to)g(consider)h
(pages)g(that)f(are)h(currently)544 4748 y(mapped)24
b(for)g(clustering)f(when)i(writing)e(to)h(backing)f(store.)31
b(Normally)23 b(when)h(writing)f(a)i(page)544 4897 y(to)d(backing)h
(store)g(the)f(\003ush)h(function)f(looks)g(for)i(neighboring)d(dirty)h
(inacti)n(v)o(e)g(pages)h(to)f(write)544 5047 y(along)29
b(with)g(the)h(page)g(being)f(\003ushed.)45 b(Specifying)30
b(this)e(\003ag)j(causes)e(the)h(\003ush)g(function)e(to)544
5196 y(also)c(consider)h(acti)n(v)o(e)f(\(mapped\))g(pages)h(for)g
(clustering.)p eop
%%Page: 126 146
126 145 bop 3751 100 a Fs(126)300 249 y Fd(PGO)p 486
249 30 4 v 35 w(DEACTIVATE)p Fo(:)47 b Fs(Causes)33 b(an)h(object')-5
b(s)32 b(pages)h(to)g(be)h(mark)o(ed)f(inacti)n(v)o(e.)54
b(This)33 b(mak)o(es)g(them)544 398 y(more)25 b(lik)o(ely)e(to)i(be)g
(rec)o(ycled)g(by)f(the)h(pagedaemon)f(if)h(memory)f(becomes)g(scarce.)
300 631 y Fd(PGO)p 486 631 V 35 w(FREE)p Fo(:)48 b Fs(Causes)42
b(an)f(object')-5 b(s)40 b(pages)h(to)f(be)i(freed.)80
b(Note)41 b(that)f Fm(PGO)p 3088 631 V 35 w(DEACTIVATE)f
Fs(and)544 780 y Fm(PGO)p 730 780 V 35 w(FREE)30 b Fs(cannot)h(both)f
(be)h(speci\002ed)g(at)g(the)f(same)h(time.)48 b(If)31
b(both)g Fm(PGO)p 3278 780 V 35 w(CLEANIT)e Fs(and)544
930 y Fm(PGO)p 730 930 V 35 w(FREE)24 b Fs(are)i(speci\002ed,)f(the)f
(pages)h(are)h(cleaned)f(before)g(the)o(y)f(are)i(freed.)300
1162 y Fd(PGO)p 486 1162 V 35 w(ALLPAGES)p Fo(:)47 b
Fs(Causes)35 b(the)g(\003ush)f(operation)g(to)h(ignore)f(the)g
(\223start\224)h(and)g(\223end\224)g(ar)n(guments)544
1311 y(and)25 b(perform)f(the)h(speci\002ed)g(\003ushing)f(operation)g
(on)h(all)f(pages)h(in)g(the)f(object.)300 1643 y Ff(6.2.10)118
b(The)31 b(Cluster)f(Operation)300 1859 y Fs(The)35 b(cluster)f
(function)g(determines)g(ho)n(w)g(lar)n(ge)i(a)f(clustered)f(I/O)h
(operation)f(can)i(be.)60 b(It)35 b(tak)o(es)g(an)300
2009 y(object)26 b(and)h(the)f(of)n(fset)g(of)h(a)g(page)f(in)h(that)f
(object.)35 b(The)27 b(calling)f(function)g(is)g(interested)g(in)g(b)n
(uilding)300 2158 y(a)36 b(cluster)f(of)h(pages)f(around)g(that)h
(page.)63 b(The)35 b(cluster)g(routine)g(returns)g(the)h(starting)e
(and)i(ending)300 2307 y(of)n(fsets)f(of)h(a)g(cluster)g(of)g(pages)g
(b)n(uilt)f(around)g(the)h(page)g(passed)g(in.)63 b(Since)37
b(the)e(lar)n(gest)h(size)g(I/O)300 2457 y(operation)g(a)g(de)n(vice)g
(dri)n(v)o(er)f(is)h(required)g(to)g(perform)g(is)g Fm(MAXBSIZE)p
Fs(,)e(a)j(cluster)f(can)g(include)g(at)300 2606 y(most)29
b Fm(MAXBSIZE)f Fs(bytes)i(of)g(data.)47 b(F)o(or)30
b(pagers)g(that)g(do)g(not)f(wish)g(to)h(cluster)g(the)g(cluster)g
(routine)300 2756 y(can)f(just)f(return)g(a)h(\223cluster\224)g(of)f
(one)h(page.)42 b(The)29 b(cluster)f(operation)g(is)g(currently)g(only)
g(used)g(when)300 2905 y(b)n(uilding)d(a)j(cluster)e(for)i(a)f(pager)h
(put)e(operation.)37 b(Future)27 b(UVM)g(enhancements)f(may)h(mak)o(e)g
(use)g(of)300 3054 y(this)d(operation.)300 3386 y Ff(6.2.11)118
b(The)31 b(Mak)o(e)e(Put)i(Cluster)f(Operation)300 3602
y Fs(The)d(mak)o(e)g(put)g(cluster)g(function)f(is)h(an)h(optional)d
(pager)j(operation)f(that)f(b)n(uilds)g(a)i(cluster)f(of)g(pages)300
3752 y(for)35 b(a)f(pageout)g(operation.)59 b(If)34 b(the)h(mak)o(e)f
(put)g(cluster)g(function)f(is)h(null,)i(then)e(I/O)g(will)f(ne)n(v)o
(er)h(be)300 3901 y(clustered)j(on)g(pageout.)68 b(UVM)36
b(pro)o(vides)g Fm(uvm)p 2077 3901 V 35 w(mk)p 2232 3901
V 36 w(pcluster)p Fs(,)i(a)g(generic)g(mak)o(e)f(put)f(cluster)300
4050 y(function)f(that)g(pagers)h(may)f(use)h(if)g(a)g(special)f
(function)g(is)g(not)g(needed.)64 b(In)36 b(UVM)f(currently)g(all)300
4200 y(pagers)28 b(that)f(do)g(clustered)h(pageout)f(use)g(the)h
(generic)g(function.)38 b(The)28 b(mak)o(e)f(put)g(cluster)h(routine)f
(is)300 4349 y(called)e(by)g(the)g(pagedaemon)g(when)h(paging)e(out)h
(data)g(to)g(backing)g(store)g(to)g(see)g(if)h(an)o(y)f(neighboring)300
4499 y(pages)g(can)g(be)g(included)f(in)g(the)h(I/O)g(operation.)583
4648 y(The)30 b(mak)o(e)f(put)g(cluster)g(function)f(is)h(called)h(and)
f(returns)g(with)g(both)f(the)h(page)h(queues)f(and)300
4797 y(the)c(pager')-5 b(s)26 b(object)f(lock)o(ed.)32
b(It)26 b(tak)o(es)f(an)h(uninitialized)e(array)i(of)g(page)f(pointers)
g(and)g(a)h(b)n(usy)f(write-)300 4947 y(protected)31
b(page.)48 b(It)31 b(uses)f(the)h(object')-5 b(s)30 b(cluster)g
(operation)g(to)h(establish)e(the)i(range)g(of)g(the)f(cluster)l(,)300
5096 y(and)21 b(then)g(\002lls)g(the)g(array)h(with)e(pages)h(that)g
(are)h(candidate)f(for)g(being)g(included)g(in)f(the)h(cluster)-5
b(.)29 b(These)300 5246 y(pages)19 b(must)f(be)i(dirty)e(pages)i(that)e
(are)i(not)f(already)h(b)n(usy)-6 b(.)27 b(The)20 b(mak)o(e)f(put)f
(cluster)h(function)g(will)f(write)p eop
%%Page: 127 147
127 146 bop 3751 100 a Fs(127)300 249 y(protect)24 b(and)g(set)h(the)f
(b)n(usy)f(\003ag)i(on)f(an)o(y)g(page)h(it)f(adds)g(to)g(the)g
(cluster)-5 b(.)30 b(The)24 b(caller)h(is)f(responsible)f(for)300
398 y(clearing)i(this)f(\003ag)h(when)g(it)f(is)g(done)h(with)f(the)h
(pages)f(in)h(the)f(cluster)-5 b(.)300 730 y Ff(6.2.12)118
b(The)31 b(Shar)n(e)f(Pr)n(otect)g(Operation)300 946
y Fs(The)i(share)g(protect)g(operation)g(is)f(an)i(optional)d(pager)j
(operation)e(that)h(changes)g(the)g(protection)f(of)300
1096 y(an)g(object')-5 b(s)31 b(pages)g(in)f(all)h(maps)g(that)g(the)o
(y)f(are)i(mapped)f(in.)49 b(The)31 b(object)g(must)f(be)h(lock)o(ed)g
(by)g(the)300 1245 y(caller)-5 b(.)44 b(This)29 b(function)f(is)h
(called)g(when)g(remo)o(ving)f(mappings)g(from)h(a)h(share)f(map.)44
b(If)30 b(memory)e(in)300 1394 y(a)j(share)g(map)g(is)f(unmapped,)h
(then)g(it)f(must)g(be)h(remo)o(v)o(ed)e(from)i(all)f(process')h(that)g
(are)g(sharing)f(the)300 1544 y(map.)f(Since)22 b(the)f(VM)g(system)g
(does)g(not)g(k)o(eep)g(track)h(of)g(which)f(processes)g(are)h(sharing)
f(a)h(share)g(map,)300 1693 y(it)28 b(must)g(play)h(it)g(safe)g(and)g
(remo)o(v)o(e)f(the)h(mappings)e(from)i(all)g(processes)g(that)f(map)h
(the)g(memory)-6 b(.)42 b(If)300 1843 y(a)30 b(pager)g(does)g(not)f
(pro)o(vide)f(a)i(share)g(protect)g(function,)g(then)f(objects)g(that)g
(use)h(that)f(pager)h(are)h(not)300 1992 y(allo)n(wed)22
b(to)h(be)g(mapped)f(by)h(share)h(maps.)29 b(UVM)23 b(pro)o(vides)e(a)j
(generic)f(share)g(protect)g(operation)g(that)300 2141
y(is)h(currently)h(used)f(by)h(all)f(pagers)h(that)g(can)g(be)g(used)f
(by)h(share)g(maps.)300 2473 y Ff(6.2.13)118 b(The)31
b(Async)f(I/O)f(Done)i(Operation)300 2689 y Fs(In)d(a)h(synchronous)d
(I/O)i(request,)h(the)f(pager)g(starts)g(the)g(I/O)g(operation,)g(w)o
(aits)f(for)i(the)f(I/O)g(to)f(com-)300 2839 y(plete,)33
b(and)f(then)f(returns)g(a)h(status)f(v)n(alue.)51 b(In)32
b(an)f(asynchronous)g(I/O)g(operation,)i(the)f(pager)g(starts)300
2988 y(the)23 b(I/O)f(operation)g(and)h(immediately)e(return)i
Fm(VM)p 2074 2988 30 4 v 35 w(PAGER)p 2409 2988 V 35
w(PEND)f Fs(\(I/O)h(pending\).)29 b(This)22 b(allo)n(ws)f(the)300
3137 y(calling)34 b(process)g(to)g(continue)g(to)g(run)g(while)g(the)h
(I/O)f(is)g(in)g(progress.)59 b(When)35 b(the)f(asynchronous)300
3287 y(I/O)h(operation)f(completes)g(the)h(pager')-5
b(s)35 b(async)f(I/O)h(done)g(operation)f(is)h(called)f(to)h(\002nish)f
(the)h(I/O)300 3436 y(operation.)583 3586 y(The)22 b(pager)g(normally)e
(has)i(the)f(option)f(of)i(using)e(asynchronous)h(or)g(synchronous)f
(I/O.)i(Since)300 3735 y(the)27 b(pager)h(can)g(al)o(w)o(ays)f(opt)g
(to)g(use)g(synchronous)f(I/O,)h(pagers)h(are)g(not)e(required)i(to)f
(support)f(asyn-)300 3884 y(chronous)21 b(I/O.)g(A)g(calling)g(process)
g(has)g(the)h(option)e(of)h(forcing)g(a)h(pager)g(to)f(use)g
(synchronous)f(I/O)h(by)300 4034 y(specifying)k(the)i
Fm(PGO)p 1076 4034 V 35 w(SYNCIO)e Fs(\003ag)i(to)e(the)i(pager)f(I/O)g
(operations.)35 b(This)25 b(is)h(useful)g(if)g(the)g(process)300
4183 y(w)o(ants)e(to)h(ensure)g(that)f(the)h(I/O)f(is)h(complete)f
(before)h(continuing.)583 4333 y(In)j(synchronous)f(I/O,)h(the)f(state)
h(of)g(the)g(I/O)g(operation)f(can)h(be)g(stored)g(on)f(the)h(calling)f
(pro-)300 4482 y(cess')g(k)o(ernel)g(stack.)37 b(Ho)n(we)n(v)o(er)l(,)
26 b(with)g(asynchronous)f(I/O,)i(the)g(calling)f(process)h(starts)f
(the)g(I/O)h(and)300 4631 y(then)35 b(continues)f(running)g(\(and)h
(using)f(its)h(k)o(ernel)g(stack\))g(while)f(the)h(I/O)g(is)g(in)g
(progress.)61 b(So)35 b(the)300 4781 y(k)o(ernel)f(stack)g(cannot)g(be)
g(used)g(to)g(store)g(I/O)f(state)h(for)h(asynchronous)e(I/O)h
(operations.)57 b(Instead,)300 4930 y(the)29 b(pager)h(must)e(store)h
(the)g(state)g(of)g(the)g(asynchronous)f(I/O)h(operation)g(in)g(its)f
(o)n(wn)h(memory)f(area.)300 5080 y(P)o(art)33 b(of)g(this)f(memory)g
(area)h(is)g(the)f Fm(uvm)p 1788 5080 V 35 w(aiodesc)g
Fs(structure.)54 b(The)33 b Fm(uvm)p 3071 5080 V 35 w(aiodesc)e
Fs(structure)300 5229 y(describes)22 b(the)g(pager)n(-independent)f
(state)h(information)e(associated)i(with)f(an)h(asynchronous)f(I/O)h
(op-)300 5378 y(eration.)30 b(This)23 b(structure)h(contains)f(the)g
(number)h(of)f(pages)h(in)g(the)f(I/O)h(operation,)f(the)h(k)o(ernel)g
(virtual)p eop
%%Page: 128 148
128 147 bop 3751 100 a Fs(128)300 249 y(address)23 b(those)g(pages)h
(are)g(mapped)f(in)g(at,)h(a)g(pointer)f(to)g(the)g(async)h(I/O)f(done)
h(function,)f(a)g(link)o(ed)g(list)300 398 y(pointer)l(,)h(and)h
(pointer)f(to)g(pager)n(-dependent)h(data.)583 548 y(When)f(a)f(pager)h
(decides)f(to)g(perform)h(an)f(asynchronous)f(I/O)i(operation)e(the)i
(follo)n(wing)d(hap-)300 697 y(pens:)62 b(The)41 b(pager)g(allocates)g
(memory)f(to)h(store)f(state)h(information,)i(starts)d(the)h(I/O)g
(operation,)300 847 y(and)36 b(returns)g Fm(VM)p 919
847 30 4 v 35 w(PAGER)p 1254 847 V 35 w(PEND)p Fs(.)f(When)h(the)g(I/O)
f(operation)h(completes)f(an)h(interrupt)f(is)h(gener)n(-)300
996 y(ated.)51 b(As)32 b(part)f(of)h(the)g(interrupt)e(handling,)j(the)
e(pager')-5 b(s)31 b Fm(uvm)p 2580 996 V 36 w(aiodesc)f
Fs(structure)h(for)h(the)g(cur)n(-)300 1145 y(rent)38
b(I/O)h(operation)f(is)g(placed)g(on)g(a)h(global)f(list)f(of)i
(completed)e(asynchronous)h(I/O)g(operations)300 1295
y(\()p Fm(uvm.aio)p 759 1295 V 34 w(done)p Fs(\))33 b(and)h(a)g(w)o(ak)
o(eup)f(signal)g(is)g(sent)g(to)g(the)g(pagedaemon.)57
b(The)33 b(pagedaemon)h(is)300 1444 y(responsible)23
b(for)i(\002nishing)e(the)h(asynchronous)f(I/O)i(operation.)k(It)c
(goes)f(do)n(wn)f(the)h(list)f(of)i(complete)300 1594
y(asynchronous)31 b(I/O)g(operations)g(and)h(calls)f(the)h
(asynchronous)f(I/O)g(done)h(function)f(for)h(each)g(one.)300
1743 y(The)25 b(asynchronous)f(I/O)h(done)g(function)f(must)g(un-b)n
(usy)g(the)h(pages)g(in)l(v)n(olv)o(ed)e(in)i(the)g(I/O)g(and)g(w)o(ak)
o(e)300 1892 y(up)31 b(an)o(y)g(processes)g(that)g(were)h(w)o(aiting)e
(for)i(the)f(I/O)g(operation)g(to)f(complete.)50 b(It)31
b(\002nally)g(frees)h(the)300 2042 y(asynchronous)24
b(I/O)g(state)h(information.)583 2191 y(The)41 b(reason)g(the)g
(asynchronous)f(I/O)g(done)h(function)f(is)g(called)h(from)g(the)f
(pagedaemon)300 2341 y(rather)34 b(than)e(directly)h(from)g(the)g
(interrupt)f(handler)h(is)f(that)h(the)g(VM)g(data)g(structure)g
(locking)f(cur)n(-)300 2490 y(rently)24 b(does)h(not)f(handle)h(access)
g(from)g(the)f(bottom)f(half)i(of)g(the)g(k)o(ernel.)300
2821 y Ff(6.2.14)118 b(The)31 b(Release)f(P)o(age)f(Operation)300
3038 y Fs(The)h(release)g(page)g(function)f(is)g(called)h(when)f(a)h
(released)g(object)g(page)f(is)h(encountered.)45 b(This)29
b(can)300 3187 y(happen)i(only)g(if)h(the)f(follo)n(wing)f(is)h(true:)
44 b(a)32 b(process)f(locks)g(an)h(object,)g(sets)g(the)f(b)n(usy)g
(\003ag)h(on)f(one)300 3337 y(of)k(the)g(object')-5 b(s)34
b(pages)h(\(e.g.)61 b(for)35 b(I/O\),)g(and)g(then)g(unlocks)f(the)h
(object.)61 b(If)35 b(some)f(other)h(process)300 3486
y(locks)26 b(the)h(object)g(to)f(free)i(a)g(page)f(only)f(to)h(disco)o
(v)o(er)e(that)i(it)f(is)h(b)n(usy)-6 b(,)26 b(then)h(it)f(must)g(set)h
(the)g(released)300 3635 y(\003ag.)k(Ev)o(entually)-6
b(,)22 b(the)i(I/O)g(will)f(complete)h(and)g(the)g(process)g(that)g
(set)g(the)g(b)n(usy)f(\003ag)i(will)e(relock)h(the)300
3785 y(object)g(and)g(clear)h(the)f(b)n(usy)f(\003ag.)31
b(At)24 b(that)g(time)f(it)h(must)f(check)h(to)g(see)g(if)g(the)g
(released)h(\003ag)g(is)e(set.)31 b(If)300 3934 y(so,)24
b(then)h(the)f(process)h(must)f(call)h(the)f(object')-5
b(s)24 b(release)i(page)f(pager)g(operation)f(to)g(free)i(the)f(page.)
583 4084 y(The)k(release)g(page)f(function)f(tak)o(es)h(a)h(pointer)f
(to)f(a)i(lock)o(ed)f(object)g(and)g(a)g(released)h(page)f(in)300
4233 y(that)22 b(object.)29 b(It)22 b(disposes)f(of)h(the)g(released)g
(page)g(and)g(then)g(returns)g(either)g(true)g(or)g(f)o(alse.)30
b(If)22 b(releasing)300 4382 y(the)28 b(page)h(caused)g(the)g(object)f
(to)g(be)h(terminated)f(\(e.g.)42 b(because)29 b(the)g(last)f(page)h
(of)g(an)f(object)h(being)300 4532 y(remo)o(v)o(ed)23
b(from)h(the)g(system)g(w)o(as)g(freed\))h(then)f(the)h(release)g(page)
f(function)g(returns)g(f)o(alse)g(indicating)300 4681
y(that)30 b(the)h(object)f(has)g(been)h(freed.)49 b(The)31
b(release)g(page)g(function)f(returns)g(true)h(if)g(the)f(object)g(is)g
(still)300 4830 y(ali)n(v)o(e)24 b(after)h(the)g(release)g(page)g
(operation.)p eop
%%Page: 129 149
129 148 bop 3751 100 a Fs(129)300 249 y Fg(6.3)143 b(BSD)35
b(VM)h(P)o(ager)d(vs.)44 b(UVM)36 b(P)o(ager)300 502
y Fs(In)e(this)e(section)h(the)g(role)g(of)h(the)f(pager)h(in)f(BSD)h
(VM)f(is)g(compared)h(to)f(its)f(role)i(in)f(UVM.)g(UVM)300
651 y(uses)26 b(a)h(dif)n(ferent)f(data)h(structure)f(layout)f(than)i
(BSD)g(VM.)f(P)o(ages)g(are)i(also)e(accessed)h(dif)n(ferently)e(in)300
800 y(UVM.)300 1132 y Ff(6.3.1)119 b(Data)29 b(Structur)n(e)i(Lay)m
(out)300 1348 y Fs(There)f(is)f(a)h(signi\002cant)f(dif)n(ference)h
(between)g(the)g(w)o(ay)g(the)f(pager)n(-related)h(data)g(structures)f
(are)i(or)n(-)300 1498 y(ganized)d(in)g(BSD)h(VM)f(and)g(UVM.)f(First,)
i(in)f(UVM)g(the)g Fm(uvm)p 2552 1498 30 4 v 35 w(object)f
Fs(structure)h(is)g(designed)f(to)300 1647 y(be)c(embedded)e(within)h
(a)g(memory)g(mappable)g(data)g(structure.)30 b(In)22
b(BSD)h(VM)f(the)g Fm(vm)p 3323 1647 V 36 w(object)f
Fs(data)300 1796 y(structure)k(is)g(allocated)h(and)f(managed)g
(separately)h(from)f(the)g(object)h(it)f(memory)f(maps.)32
b(Second,)26 b(in)300 1946 y(UVM)h(the)h(object)g(structure)f(has)h(a)g
(pointer)g(directly)f(to)g(the)h(pager)g(operations)g(structure.)39
b(In)28 b(BSD)300 2095 y(VM,)c(the)h(object)f(points)g(to)g(a)h
Fm(vm)p 1491 2095 V 35 w(pager)p Fs(.)30 b(That)25 b(structure)f(has)h
(a)g(pointer)f(to)g(the)h(pager)g(operations)300 2245
y(structure)c(and)g(a)g(pri)n(v)n(ate)f(pointer)g(to)h(a)g(pager)n
(-speci\002c)h(data)f(structure.)29 b(In)21 b(UVM,)f(the)h(pager)h
(speci\002c)300 2394 y(data)j(is)f(stored)h(in)f(the)h(object)f(in)g
(which)h(the)g Fm(uvm)p 2072 2394 V 35 w(object)e Fs(is)i(embedded.)583
2543 y(Figure)i(6.1)e(sho)n(ws)g(the)h(data)g(structure)f
(con\002gurations)h(for)g(both)f(BSD)i(VM)e(and)h(UVM)g(for)300
2693 y(a)33 b(memory-mapped)f(\002le.)57 b(In)33 b(BSD)h(VM)f(the)g
(object,)h Fm(vm)p 2421 2693 V 36 w(pager)p Fs(,)g Fm(vn)p
2936 2693 V 35 w(pager)p Fs(,)g(and)g(vnode)e(are)300
2842 y(separately)h(allocated)g(structures.)55 b(The)33
b(pagerops)g(structure)g(contains)f(the)h(pager)h(operations)e(for)300
2991 y(the)37 b(vnode)g(pager)h(and)f(is)g(shared)h(among)f(all)g
(pagers)g(associated)g(with)g(vnodes.)68 b(In)37 b(UVM,)g(the)300
3141 y(object)28 b(and)g(vnode-speci\002c)g(data)g(\(the)g
Fm(uvm)p 1916 3141 V 35 w(vnode)f Fs(structure)g(that)h(serv)o(es)g
(the)f(same)h(role)g(as)g(the)300 3290 y Fm(vn)p 426
3290 V 35 w(pager)c Fs(data)h(structure)f(in)h(BSD)g(VM\))g(are)g
(embedded)g(in)f(the)h(vnode)f(structure.)30 b(UVM)25
b(has)f(no)300 3440 y(need)h(for)g(a)g Fm(vm)p 849 3440
V 36 w(pager)e Fs(structure.)31 b(Instead,)24 b(the)h(object)f(points)g
(directly)g(to)h(the)f(pager)h(operations.)583 3589 y(Note)d(that)g(on)
f(the)h(BSD)h(VM)e(side)h(of)g(Figure)g(6.1)g(there)g(is)f(no)h
(pointer)f(from)h(the)g Fm(vm)p 3572 3589 V 35 w(pager)300
3738 y Fs(data)i(structure)g(to)f(the)h Fm(vm)p 1236
3738 V 35 w(object)f Fs(structure.)30 b(Instead,)24 b(the)g(BSD)g(VM)g
(system)f(maintains)f(a)i(hash)300 3888 y(table)30 b(that)g(hashes)h(a)
f Fm(vm)p 1201 3888 V 36 w(pager)f Fs(pointer)h(to)g(a)h
Fm(vm)p 2182 3888 V 36 w(object)e Fs(pointer)-5 b(.)46
b(This)30 b(hash)g(table)h(appears)300 4037 y(to)c(be)g(pro)o(vide)g
(additional)f(functions)g(in)h(Mach)g(VM)g(that)g(are)h(not)f(used)g
(by)g(BSD)h(VM,)f(and)g(thus)g(it)300 4187 y(could)d(be)h(replaced)h
(easily)e(by)g(a)i(simple)d(pointer)h(BSD)i(VM.)583 4336
y(So,)c(in)f(order)g(to)g(set)f(up)h(the)g(initial)e(mappings)h(of)h(a)
g(\002le)g(the)g(BSD)h(VM)f(system)e(must)h(allocate)300
4485 y(three)h(data)g(structures)g(\()p Fm(vm)p 1275
4485 V 35 w(object)p Fs(,)g Fm(vm)p 1836 4485 V 35 w(pager)p
Fs(,)g(and)f Fm(vn)p 2501 4485 V 36 w(pager)p Fs(\),)h(and)f(enter)i
(the)e(pager)i(in)e(the)300 4635 y(pager)28 b(hash)f(table.)40
b(On)27 b(the)h(other)f(hand,)h(UVM)f(doesn')n(t)h(ha)n(v)o(e)f(to)g
(access)i(a)f(hash)f(table)g(or)h(allocate)300 4784 y(an)o(y)33
b(data)h(structures.)58 b(All)33 b(the)h(data)g(structures)g(UVM)f
(needs)h(are)h(embedded)e(within)g(the)h(vnode)300 4934
y(structure.)583 5083 y(In)41 b(addition)e(to)h(ha)n(ving)g(more)g
(comple)o(x)f(data)h(structure)g(handling,)j(the)d(BSD)i(VM)e(sys-)300
5232 y(tem)d(also)h(has)g(an)g(e)o(xtra)f(layer)h(of)g(pager)g
(functions.)69 b(F)o(or)38 b(e)o(xample,)i(consider)e(the)f(\223put)h
(pages\224)300 5382 y(function)k(sho)n(wn)g(in)g(Figure)h(6.2.)85
b(This)42 b(function)g(does)g(nothing)g(b)n(ut)g(call)h(out)f(to)h(the)
f(pager')-5 b(s)p eop
%%Page: 130 150
130 149 bop 3751 100 a Fs(130)645 2407 y @beginspecial
0 @llx 0 @lly 499 @urx 387 @ury 3493 @rwi @setspecial
%%BeginDocument: ../figures/bsdpgr.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-16.0 430.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7198 m 0 0 l 8623 0 l 8623 7198 l cp clip
 0.06000 0.06000 sc
/Helvetica ff 300.00 scf sf
3600 5250 m
gs 1 -1 sc (vn_pager) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2400 6975 m
gs 1 -1 sc (vnode) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
30.000 slw
n 1500 1425 m 3300 1425 l 3300 1950 l 1500 1950 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
2400 1800 m
gs 1 -1 sc (vm_object) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 300 4875 m 2100 4875 l 2100 5400 l 300 5400 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
1200 5250 m
gs 1 -1 sc (pagerops) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 5400 3975 m 7200 3975 l 7200 4500 l 5400 4500 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
6300 4350 m
gs 1 -1 sc (pagerops) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
n 6600 1950 m 8250 1950 l 8250 1425 l gs col0 s gr 
% Polyline
30.000 slw
n 6600 1425 m 8550 1425 l 8550 3450 l 6600 3450 l cp gs col0 s gr 
% Polyline
15.000 slw
n 6600 2400 m 8400 2400 l 8400 1425 l gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
6349 3833 m 6303 3948 l 6290 3825 l 6268 3986 l 6328 3994 l cp
clip
n 6600 1725 m 6300 3975 l gs col0 s gr gr

% arrowhead
n 6349 3833 m 6303 3948 l 6290 3825 l 6319 3829 l 6349 3833 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
7500 900 m
gs 1 -1 sc (UVM) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
6675 1800 m
gs 1 -1 sc (uvm_object) col0 sh gr
/Helvetica ff 300.00 scf sf
6675 2250 m
gs 1 -1 sc (uvm_vnode) col0 sh gr
/Helvetica ff 300.00 scf sf
6675 3000 m
gs 1 -1 sc (vnode) col0 sh gr
% Polyline
30.000 slw
n 1500 3150 m 3300 3150 l 3300 3675 l 1500 3675 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
2430 3003 m 2400 3123 l 2370 3003 l 2370 3165 l 2430 3165 l cp
clip
n 2400 1950 m 2400 3150 l gs col0 s gr gr

% arrowhead
n 2430 3003 m 2400 3123 l 2370 3003 l 2400 3003 l 2430 3003 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
1325 4792 m 1219 4855 l 1283 4750 l 1168 4864 l 1211 4907 l cp
clip
n 2400 3675 m 1200 4875 l gs col0 s gr gr

% arrowhead
n 1325 4792 m 1219 4855 l 1283 4750 l 1304 4771 l 1325 4792 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 2700 4875 m 4500 4875 l 4500 5400 l 2700 5400 l cp gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
3517 4750 m 3580 4855 l 3475 4792 l 3589 4907 l 3632 4864 l cp
clip
n 2400 3675 m 3600 4875 l gs col0 s gr gr

% arrowhead
n 3517 4750 m 3580 4855 l 3475 4792 l 3496 4771 l 3517 4750 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2525 6517 m 2419 6580 l 2483 6475 l 2368 6589 l 2411 6632 l cp
clip
n 3600 5400 m 2400 6600 l gs col0 s gr gr

% arrowhead
n 2525 6517 m 2419 6580 l 2483 6475 l 2504 6496 l 2525 6517 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2370 3897 m 2400 3777 l 2430 3897 l 2430 3735 l 2370 3735 l cp
clip
n 2400 6600 m 2400 3750 l gs col0 s gr gr

% arrowhead
n 2370 3897 m 2400 3777 l 2430 3897 l 2400 3897 l 2370 3897 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
2400 900 m
gs 1 -1 sc (BSD VM) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
2400 3525 m
gs 1 -1 sc (vm_pager) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
30.000 slw
n 1500 6600 m 3300 6600 l 3300 7125 l 1500 7125 l cp gs col0 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 1452 2610 a(Figure)25 b(6.1:)30 b(P)o(ager)25
b(data)g(structures)300 3006 y Fm(pgo)p 486 3006 30 4
v 35 w(putpages)g Fs(operation.)37 b(The)27 b(e)o(xtra)f(o)o(v)o
(erhead)g(of)h(a)h(function)e(call)h(is)f(not)g(needed.)38
b(In)27 b(UVM)300 3155 y(all)32 b(pager)h(operations)f(are)h(routed)f
(directly)g(to)g(the)h(pager)g(rather)g(than)f(through)g(a)g(small)g
(function)300 3304 y(lik)o(e)24 b Fm(vm)p 599 3304 V
36 w(pager)p 935 3304 V 35 w(put)p 1150 3304 V 35 w(pages)p
Fs(.)300 3635 y Ff(6.3.2)119 b(P)o(age)29 b(Access)300
3852 y Fs(The)23 b(w)o(ay)h(pages)f(are)h(accessed)g(in)e(UVM)h(is)g
(quite)g(a)g(bit)g(dif)n(ferent)g(from)g(the)g(w)o(ay)g(the)o(y)g(are)h
(accessed)300 4001 y(in)g(BSD)g(VM.)g(In)g(UVM)f(all)h(accesses)g(to)g
(an)g(object')-5 b(s)23 b(pages)h(go)g(through)f(the)g(pager')-5
b(s)24 b(get)g(function.)300 4151 y(Resident)g(pages)g(are)h(fetched)g
(with)e(a)i(lock)o(ed)f(get)g(operation,)g(and)g(non-resident)g(pages)g
(are)h(fetched)300 4300 y(with)d(an)g(unlock)o(ed)g(get)g(operation.)30
b(In)22 b(BSD)i(VM,)e(the)g(pager)h(is)f(only)g(consulted)f(if)h(the)h
(page)f(is)g(non-)300 4450 y(resident.)29 b(Resident)22
b(pages)g(are)h(accessed)g(directly)f(by)f(using)h(the)f(object-of)n
(fset)h(hash)g(table.)29 b(Since)23 b(a)300 4599 y(BSD)h(VM)e(pager)h
(is)f(only)g(called)h(when)f(a)h(page)g(is)f(non-resident,)h(it)f(has)g
(less)h(information)e(a)n(v)n(ailable)300 4748 y(to)k(it)h(on)f(ho)n(w)
g(its)h(pages)f(are)i(being)e(used.)34 b(A)26 b(UVM)f(pager)h(\(and)g
(the)g(\002lesystem)f(layer)h(underneath\))300 4898 y(can)d(tak)o(e)h
(adv)n(antage)e(of)h(this)g(e)o(xtra)f(information)g(to)h(determine)f
(the)h(page)h(access)f(pattern)g(and)g(mak)o(e)300 5047
y(more)32 b(intelligent)f(decisions)g(about)h(which)g(pages)g(to)g(k)o
(eep)h(resident,)g(which)f(pages)h(to)f(pre-fetch,)300
5197 y(and)27 b(which)g(pages)g(to)g(discard.)38 b(This)26
b(will)h(be)g(especially)g(useful)g(in)g(the)g(future)g(when)g(the)g
(VM)g(and)300 5346 y(b)n(uf)n(fer)e(caches)g(are)h(mer)n(ged)f(and)f
(all)h(I/O)g(goes)f(through)g(the)h(a)g(VM)f(interf)o(ace.)p
eop
%%Page: 131 151
131 150 bop 3751 100 a Fs(131)300 215 y Fm(int)59 b
(vm_pager_put_pages\(pager,)54 b(mlist,)59 b(npages,)f(sync\))300
456 y(vm_pager_t)g(pager;)300 577 y(vm_page_t)g(*mlist;)300
697 y(int)h(npages;)300 817 y(boolean_t)f(sync;)300 1058
y({)420 1179 y(if)h(\(pager)f(==)i(NULL\))539 1299 y
(panic\("vm_pager_put_pages:)54 b(null)59 b(pager"\);)420
1419 y(return)f(\(\(*pager->pg_ops->pgo_putpage)o(s\))1017
1540 y(\(pager,)h(mlist,)f(npages,)g(sync\)\);)300 1660
y(})840 1863 y Fs(Figure)25 b(6.2:)30 b(The)24 b(unnecessary)h
Fm(vm)p 2125 1863 30 4 v 36 w(pager)p 2461 1863 V 34
w(put)p 2675 1863 V 36 w(pages)e Fs(function)583 2259
y(Another)f(dif)n(ference)h(between)f(BSD)h(VM)f(and)g(UVM)f(is)h(ho)n
(w)f(the)h(pager)h(get)f(operation)g(gets)300 2408 y(pages.)42
b(In)29 b(BSD)h(VM,)e(the)h(process)f(fetching)g(the)h(data)g(from)f
(backing)g(store)h(must)e(allocate)i(a)g(free)300 2557
y(page,)e(add)g(it)f(to)g(the)g(object,)h(and)f(then)g(pass)h(it)f
(into)f(the)i(pager)g(get)f(routine.)35 b(In)27 b(UVM,)f(the)g(process)
300 2707 y(fetching)k(the)h(data)g(does)f(not)g(allocate)h(an)o
(ything.)47 b(If)31 b(the)g(pager)g(needs)f(a)h(free)h(page)f(it)f
(allocates)h(it)300 2856 y(itself.)f(This)24 b(allo)n(ws)g(the)g(pager)
h(to)g(ha)n(v)o(e)f(full)h(control)f(o)o(v)o(er)g(when)g(pages)h(get)g
(added)g(to)f(the)h(object.)583 3006 y(A)35 b(related)g(problem)f(with)
g(the)g(BSD)i(VM)e(pager)h(get)g(operation)f(is)g(that)g(it)h(is)f
(required)g(to)300 3155 y(return)26 b(a)g Fm(vm)p 760
3155 V 35 w(page)f Fs(structure.)33 b(This)25 b(causes)h(problems)e
(for)i(pagers)g(that)f(manage)h(de)n(vice)f(memory)300
3304 y(because)20 b(de)n(vice)g(memory)f(does)h(not)f(ha)n(v)o(e)h(an)o
(y)f Fm(vm)p 2108 3304 V 36 w(page)g Fs(structures)g(associated)h(with)
f(it.)28 b(Consider)300 3454 y(what)j(happens)g(when)g(a)g(process)g
(generates)h(a)f(page)h(f)o(ault)e(on)h(a)h(de)n(vice')-5
b(s)30 b(page)h(under)h(BSD)g(VM.)300 3603 y(The)26 b(f)o(ault)f
(routine)g(will)g(allocate)h(a)g(free)g(page)g(and)g(add)g(it)f(to)g
(the)h(de)n(vice')-5 b(s)24 b(memory)h(object.)33 b(It)26
b(will)300 3753 y(then)c(call)f(the)h(pager)g(get)g(operation)f(to)h
(\002ll)f(the)h(page)g(with)f(\223data\224)i(\(actually)e(the)h(de)n
(vice')-5 b(s)21 b(memory\).)300 3902 y(T)-8 b(o)23 b(service)g(this)g
(request,)g(the)g(de)n(vice)g(pager)g(must)f(use)h(the)g(k)o(ernel)h
(memory)e(allocator)h(to)g(allocate)g(a)300 4051 y(\002ctitious)e
Fm(vm)p 797 4051 V 36 w(page)g Fs(structure)h(that)g(is)f(associated)h
(with)g(the)g(de)n(vice')-5 b(s)21 b(memory)-6 b(.)29
b(The)22 b(de)n(vice)g(pager)300 4201 y(get)j(operation)f(must)g(then)g
(remo)o(v)o(e)g(the)g(normal)h(page)g(of)g(memory)f(passed)g(into)g(it)
g(from)h(the)g(object,)300 4350 y(free)31 b(the)e(page,)i(and)f(then)f
(install)f(the)i(\002ctitious)e(page)i(in)f(the)h(object)f(and)g
(return.)46 b(This)28 b(will)h(allo)n(w)300 4500 y(the)35
b(f)o(ault)f(routine)g(to)h(resolv)o(e)f(the)h(f)o(ault.)60
b(The)35 b(BSD)h(VM)e(system)g(must)f(be)i(careful)h(that)e(it)g(does)
300 4649 y(not)27 b(allo)n(w)g(a)g(\002ctitious)g(page)h(to)f(be)h
(added)f(to)g(the)h(page)f(queues)h(or)f(free)i(page)f(list)e(as)i(the)
f(\002ctitious)300 4798 y(page')-5 b(s)24 b(memory)g(is)h(part)g(of)f
(de)n(vice)h(memory)-6 b(.)583 4948 y(In)33 b(UVM)f(\002ctitious)f
(pages)h(are)h(not)e(necessary)-6 b(.)53 b(The)32 b(de)n(vice)g(pager)h
(uses)f(the)g(pager)g(f)o(ault)300 5097 y(operation)f(to)g(map)g(de)n
(vice)g(memory)g(into)f(a)i(f)o(aulting)f(process')g(address)h(space)g
(without)e(the)h(need)300 5247 y(for)25 b(\002ctitious)f(pages.)p
eop
%%Page: 132 152
132 151 bop 3751 100 a Fs(132)300 249 y Ff(6.3.3)119
b(Other)30 b(Minor)g(Differ)n(ences)300 466 y Fs(There)25
b(are)h(tw)o(o)e(note)n(w)o(orthy)f(minor)h(dif)n(ferences)h(between)g
(pagers)f(in)h(UVM)f(and)h(BSD)h(VM:)445 698 y Fr(\017)49
b Fs(In)24 b(BSD)h(VM,)e(the)h(pager)g(get)g(operation)f(can)h(return)g
Fm(VM)p 2565 698 30 4 v 36 w(PAGER)p 2901 698 V 34 w(FAIL)f
Fs(if)h(the)g(of)n(fset)f(of)h(the)544 848 y(requested)i(page)g(is)g(v)
n(alid)f(b)n(ut)h(the)g(page)h(does)f(not)f(reside)h(in)g(the)g
(object.)35 b(This)25 b(is)h(used)g(when)544 997 y(w)o(alking)i(an)h
(object)g(chain.)43 b(If)29 b(a)g(pager)h(returns)e Fm(VM)p
2423 997 V 36 w(PAGER)p 2759 997 V 35 w(FAIL)g Fs(then)g(the)h(f)o
(ault)g(routine)544 1146 y(kno)n(ws)g(to)i(skip)f(to)g(the)h(ne)o(xt)e
(object.)48 b(Since)32 b(UVM)e(does)g(not)h(ha)n(v)o(e)f(an)o(y)g
(object)g(chains,)i(the)544 1296 y Fm(VM)p 670 1296 V
35 w(PAGER)p 1005 1296 V 35 w(FAIL)24 b Fs(error)i(code)f(is)f(not)g
(used.)445 1528 y Fr(\017)49 b Fs(UVM)41 b(pro)o(vides)f(a)i(generic)g
(structure)f(\()p Fm(uvm)p 2231 1528 V 36 w(aiodesc)p
Fs(\))f(for)i(maintaining)d(the)j(state)f(of)544 1678
y(asynchronous)28 b(I/O)h(operations.)43 b(This)28 b(structure)h(is)g
(allocated)f(by)h(a)h(pager)f(when)g(the)g(asyn-)544
1827 y(chronous)21 b(I/O)g(operation)g(is)h(initiated.)28
b(When)21 b(the)h(de)n(vice)f(has)h(\002nished)f(all)g(parts)h(of)f(an)
h(asyn-)544 1976 y(chronous)d(I/O)h(operation,)g(the)g
Fm(uvm)p 1832 1976 V 35 w(aiodesc)e Fs(structure)i(for)g(that)f
(operation)h(is)f(placed)h(on)g(a)544 2126 y(globally)102
b(link)o(ed)h(list)f(of)h(completed)g(asynchronous)f(I/O)i(operations)e
(called)544 2275 y Fm(uvm.aio)p 970 2275 V 34 w(done)p
Fs(.)32 b(At)25 b(this)g(time)g(the)g(pagedaemon)g(is)g(w)o(ok)o(en)h
(up.)32 b(As)26 b(part)f(of)h(the)f(state)g(in-)544 2424
y(formation)d(for)h(the)g(asynchronous)f(I/O)g(operation,)h(the)g
Fm(uvm)p 2726 2424 V 35 w(aiodesc)e Fs(structure)i(contains)544
2574 y(a)j(pointer)f(to)h(an)g(\223asynchronous)f(I/O)h(done\224)g
(pager)h(operation.)33 b(The)26 b(pagedaemon)g(will)f(tra-)544
2723 y(v)o(erse)20 b(the)h(completed)f(asynchronous)f(I/O)i(operations)
e(on)i(the)f Fm(uvm.aio)p 3198 2723 V 34 w(done)g Fs(list)g(calling)544
2873 y(each)31 b(operation')-5 b(s)29 b(asynchronous)g(I/O)h(done)g
(function.)47 b(This)29 b(function)h(frees)h(all)f(resources)544
3022 y(being)24 b(used)g(for)h(that)f(asynchronous)f(I/O)i(operation,)f
(including)f(the)h Fm(uvm)p 3201 3022 V 35 w(aiodesc)f
Fs(struc-)544 3171 y(ture.)544 3362 y(In)40 b(contrast,)i(BSD)f(VM)e
(pro)o(vides)f(v)o(ery)h(little)g(generic)h(structure)f(for)h
(asynchronous)e(I/O)544 3512 y(operations.)28 b(In)19
b(BSD)h(VM,)f(the)g(pager)g(put)g(operation)f(is)h(o)o(v)o(erloaded)f
(to)h(be)g(the)g(asynchronous)544 3661 y(I/O)k(done)g(operation)f(as)i
(well.)29 b(If)24 b(the)f(pager)g(put)g(operation)f(is)h(called)g(with)
g(a)g(non-null)f(pager)l(,)544 3811 y(then)35 b(the)g(request)g(is)f
(treated)i(lik)o(e)f(a)g(normal)g(put)f(operation.)61
b(Ho)n(we)n(v)o(er)l(,)37 b(if)e(the)g(pager)h(put)544
3960 y(operation)f(is)g(called)g(with)g(its)g(pager)g(ar)n(gument)g
(set)h(to)f(null,)i(then)e(that)g(is)g(a)h(signal)e(to)h(the)544
4109 y(pager)25 b(to)f(look)h(for)g(an)o(y)f(completed)g(asynchronous)g
(I/O)g(operations)g(to)h(clean)g(up.)544 4300 y(when)33
b(the)f(BSD)i(VM)f(pagedaemon)f(\002rst)h(being)f(running)g(it)h(calls)
f(each)i(pager')-5 b(s)32 b(put)h(func-)544 4450 y(tion)28
b(with)h(pager)g(set)g(to)g(null)f(\227)h(re)o(gardless)f(of)i(whether)
f(there)g(are)h(an)o(y)f(asynchronous)f(I/O)544 4599
y(operations)h(w)o(aiting)h(to)g(be)g(\002nished.)47
b(This)30 b(is)g(inef)n(\002cient)f(because)i(there)g(often)f(are)h(no)
f(I/O)544 4748 y(operations)d(w)o(aiting)g(to)h(be)h(\002nished.)40
b(BSD)29 b(VM')-5 b(s)27 b(o)o(v)o(erloading)f(of)j(the)f(pager)g(put)g
(function)544 4898 y(is)f(confusing)f(because)i(it)f(is)f(not)h(well)g
(documented)g(and)g(the)g(completion)f(of)h(asynchronous)544
5047 y(I/O)j(operations)f(has)g(little)g(to)g(do)h(with)f(starting)g(a)
h(pageout.)45 b(BSD)31 b(VM)e(pagers)h(that)f(do)h(not)544
5197 y(support)24 b(asynchronous)f(I/O)i(ignore)g(put)f(requests)g
(with)g(null)g(pagers.)p eop
%%Page: 133 153
133 152 bop 3751 100 a Fs(133)583 249 y(It)23 b(should)f(be)g(noted)g
(that)h(the)f(BSD)i(I/O)e(subsystem)2422 213 y Fj(1)2480
249 y Fs(currently)h(requires)f(that)h(all)f(pages)h(that)300
398 y(are)k(in)f(I/O)g(be)g(mapped)f(in)h(the)g(k)o(ernel')-5
b(s)26 b(virtual)f(address)h(space.)35 b(F)o(or)26 b(I/O)g(operations)f
(that)h(directly)300 548 y(access)i(memory)f(\(i.e.)38
b(use)28 b(DMA\))f(this)f(mapping)h(is)f(unnecessary)i(because)g(the)f
(k)o(ernel)h(mappings)300 697 y(are)i(ne)n(v)o(er)e(used.)43
b(In)29 b(the)g(future)g(the)g(I/O)g(subsystem)e(should)h(be)h
(modi\002ed)f(to)h(tak)o(e)g(a)g(list)f(of)h(pages)300
847 y(rather)k(than)f(a)h(k)o(ernel)g(virtual)f(address.)54
b(That)33 b(w)o(ay)g(only)e(dri)n(v)o(ers)h(that)g(need)h(to)f(ha)n(v)o
(e)h(their)f(pages)300 996 y(mapped)g(in)g(the)g(k)o(ernel')-5
b(s)32 b(address)g(space)g(will)g(bother)g(to)g(do)f(so)h(and)h(the)f
(e)o(xtra)g(o)o(v)o(erhead)f(can)i(be)300 1145 y(a)n(v)n(oided)24
b(for)h(dri)n(v)o(ers)f(that)g(do)h(not)f(need)h(k)o(ernel)g(mappings.)
300 1529 y Fg(6.4)143 b(Summary)300 1782 y Fs(In)29 b(this)g(chapter)g
(the)g(design)f(of)i(UVM')-5 b(s)28 b(pager)h(interf)o(ace)h(w)o(as)f
(presented.)44 b(The)29 b(pager)h(pro)o(vides)e(a)300
1931 y(set)h(of)g(functions)f(that)g(present)h(a)g(uniform)f(interf)o
(ace)i(to)e Fm(uvm)p 2539 1931 30 4 v 35 w(object)g Fs(memory)g
(objects.)43 b(Func-)300 2080 y(tions)31 b(in)h(the)g(pager)h(interf)o
(ace)f(include)g(functions)f(that)h(adjust)f(an)i(object')-5
b(s)31 b(reference)j(count,)f(and)300 2230 y(functions)c(that)g
(transfer)i(data)f(between)g(backing)g(store)f(and)h(physical)f(memory)
-6 b(.)45 b(The)30 b(dif)n(ferences)300 2379 y(between)d(the)h(BSD)g
(VM)f(pager)g(interf)o(ace)h(and)g(UVM')-5 b(s)26 b(pager)i(interf)o
(ace)g(were)g(also)f(discussed.)37 b(In)300 2528 y(BSD)c(VM,)f(each)h
Fm(vm)p 1085 2528 V 35 w(object)e Fs(data)i(structure)f(is)f(indi)n
(vidually)f(allocated)i(and)g(has)g(its)g(o)n(wn)f(pri-)300
2678 y(v)n(ate)36 b Fm(vm)p 626 2678 V 35 w(pager)g Fs(data)g
(structure.)65 b(In)36 b(UVM,)g(the)g Fm(uvm)p 2389 2678
V 35 w(object)g Fs(structure)g(is)f(designed)h(to)g(be)300
2827 y(embedded)28 b(within)f(a)i(mappable)f(k)o(ernel)g(data)h
(structure)f(such)g(as)h(a)g(vnode.)41 b(Rather)29 b(than)f(ha)n(ving)g
(a)300 2977 y Fm(uvm)p 486 2977 V 35 w(pager)e Fs(structure,)h(the)g
Fm(uvm)p 1577 2977 V 35 w(object)f Fs(contains)g(a)i(pointer)e(to)h(a)g
(shared)g(set)g(of)g(pager)h(oper)n(-)300 3126 y(ations.)p
300 5308 1440 4 v 416 5370 a Fi(1)449 5400 y Fh(The)20
b(operating)f(systems)h(that)h(use)f(UVM)g(use)h(the)f(BSD)h(I/O)g
(subsystem.)p eop
%%Page: 134 154
134 153 bop 3751 100 a Fs(134)300 973 y Fp(Chapter)51
b(7)300 1448 y(Using)i(UVM)f(to)f(Mo)n(v)n(e)h(Data)300
1930 y Fs(This)24 b(chapter)h(describes)g(the)g(design)f(and)h
(function)f(of)h(UVM')-5 b(s)24 b(page)h(loan)g(out,)f(page)h(transfer)
l(,)g(and)300 2079 y(map)34 b(entry)h(passing)f(interf)o(aces.)60
b(W)l(ith)34 b(page)h(loanout,)h(a)f(process)g(can)g(safely)f
(\223loan\224)h(read-only)300 2229 y(copies)f(of)g(its)g(memory)g
(pages)g(out)g(to)g(the)g(k)o(ernel)g(or)h(other)f(processes.)59
b(P)o(age)35 b(transfer)g(allo)n(ws)e(a)300 2378 y(process)k(to)f
(recei)n(v)o(e)h(pages)g(from)g(the)f(k)o(ernel)h(or)g(other)g
(processes.)67 b(Map)37 b(entry)f(passing)g(allo)n(ws)300
2527 y(processes)28 b(to)f(cop)o(y)h(or)g(mo)o(v)o(e)f(chunks)g(of)h
(virtual)f(address)h(space)g(between)g(themselv)o(es.)38
b(All)28 b(three)300 2677 y(interf)o(aces)33 b(allo)n(w)e(a)i(process)f
(to)h(mo)o(v)o(e)e(data)h(using)g(the)g(virtual)g(memory)f(system)h
(and)g(thus)g(a)n(v)n(oid)300 2826 y(costly)c(data)g(copies.)41
b(These)29 b(interf)o(aces)g(pro)o(vide)e(the)h(basic)h(b)n(uilding)d
(blocks)i(on)g(which)g(adv)n(anced)300 2976 y(I/O)i(and)h(IPC)g
(subsystems)e(can)h(be)h(b)n(uilt.)46 b(In)31 b(this)e(chapter)i(we)g
(e)o(xplain)e(the)h(w)o(orkings)g(of)g(UVM')-5 b(s)300
3125 y(page)28 b(loanout,)f(page)h(transfer)l(,)g(and)f(map)h(entry)f
(passing.)38 b(In)27 b(Chapter)h(10)g(we)f(will)g(present)g(perfor)n(-)
300 3274 y(mance)e(data)g(for)g(our)g(implementation)d(of)j(these)f
(functions.)583 3424 y(Mo)o(ving)31 b(data)i(with)e(the)i(virtual)e
(memory)h(system)f(is)h(more)h(ef)n(\002cient)f(than)h(cop)o(ying)e
(data.)300 3573 y(T)-8 b(o)39 b(transfer)g(a)h(page)f(of)g(data)g(from)
g(one)g(page)h(to)e(another)h(through)f(cop)o(ying,)k(the)d(k)o(ernel)g
(must)300 3723 y(\002rst)32 b(ensure)g(that)f(both)g(the)h(source)g
(and)g(destination)e(pages)i(are)g(properly)g(mapped)f(in)g(the)h(k)o
(ernel)300 3872 y(and)g(then)f(cop)o(y)-6 b(,)33 b(w)o(ord)f(by)g(w)o
(ord,)h(each)f(piece)h(of)f(data)g(in)f(the)h(page.)52
b(T)-8 b(o)32 b(transfer)g(a)g(page)g(of)g(data)300 4021
y(using)22 b(the)h(virtual)f(memory)g(system)g(the)h(k)o(ernel)g(need)h
(only)e(ensure)h(that)g(the)f(page)i(is)e(read-only)h(and)300
4171 y(establish)h(a)h(second)f(mapping)g(of)h(the)f(page)h(at)g(the)g
(destination)e(virtual)h(address.)3200 4135 y Fj(1)583
4320 y Fs(Ho)n(we)n(v)o(er)l(,)35 b(mo)o(ving)c(data)j(with)e(the)h
(virtual)g(memory)g(system)f(is)h(more)g(complicated)f(than)300
4470 y(cop)o(ying)25 b(data.)33 b(First,)26 b(the)f(k)o(ernel)h(must)f
(use)g(cop)o(y-on-write)h(to)f(pre)n(v)o(ent)f(data)i(corruption.)33
b(Second,)300 4619 y(for)21 b(pages)g(that)g(are)g(going)g(to)f(be)h
(used)g(by)g(the)g(k)o(ernel)g(for)g(I/O,)g(the)g(k)o(ernel)g(must)f
(ensure)h(that)f(the)h(data)300 4768 y(remains)29 b(wired)g(and)g(is)f
(not)h(paged)g(out)g(or)g(\003ushed.)44 b(Third,)29 b(virtual)f(memory)
h(based)g(data)g(mo)o(ving)p 300 4858 1440 4 v 416 4919
a Fi(1)449 4949 y Fh(On)21 b(an)f(i386)f(system)i(there)e(are)i(1024)d
(w)o(ords)i(in)h(a)f(page,)g(thus)g(cop)o(ying)e(a)j(page)e(requires)g
(a)i(loop)f(of)f(1024)g(memory)300 5049 y(loads)26 b(and)f(1024)f
(memory)g(stores.)42 b(T)m(ransferring)24 b(a)i(page)f(of)h(data)f
(using)h(the)f(virtual)g(memory)g(system)h(requires)e(tw)o(o)300
5149 y(memory)30 b(loads)h(and)g(stores,)k(one)c(load-store)f(pair)h
(to)h(write)g(protect)f(the)g(source)g(virtual)g(address)g(and)g(one)g
(pair)g(to)300 5248 y(establish)24 b(a)g(mapping)e(at)i(the)g
(destination)e(address.)35 b(There)23 b(is)i(also)f(some)f(o)o(v)o
(erhead)e(associated)i(with)h(looking)e(up)i(the)300
5348 y(page)c(and)f(adjusting)g(some)h(counters.)p eop
%%Page: 135 155
135 154 bop 3751 100 a Fs(135)300 249 y(only)30 b(w)o(orks)g(for)h(lar)
n(ge)g(chunks)f(of)g(data)h(\(close)g(to)f(page-sized\).)48
b(Cop)o(ying)30 b(small)f(chunks)h(of)h(data)300 398
y(is)g(more)g(ef)n(\002cient)g(than)g(using)f(the)h(virtual)g(memory)f
(system)g(to)h(mo)o(v)o(e)f(the)h(data.)50 b(Thus,)32
b(a)f(hybrid)300 548 y(approach)25 b(is)f(optimal.)300
931 y Fg(7.1)143 b(P)o(age)34 b(Loanout)300 1184 y Fs(Under)26
b(a)g(traditional)e(k)o(ernel,)i(sending)e(data)i(from)f(one)h(process)
f(to)h(another)f(process)h(or)f(a)h(de)n(vice)g(is)300
1333 y(a)j(tw)o(o-step)g(procedure.)43 b(First)29 b(the)g(data)g(is)f
(copied)h(from)g(the)g(process')g(address)g(space)g(to)g(a)g(k)o(ernel)
300 1483 y(b)n(uf)n(fer)-5 b(.)38 b(Then)27 b(the)g(k)o(ernel)h(b)n(uf)
n(fer)f(is)g(handed)g(of)n(f)h(to)f(its)f(destination)g(\(either)i(a)f
(de)n(vice)g(dri)n(v)o(er)g(or)g(the)300 1632 y(IPC)i(layer\).)42
b(The)28 b(cop)o(y)g(of)g(the)h(data)f(from)g(the)g(process)g(address)g
(space)h(to)f(the)g(k)o(ernel)g(b)n(uf)n(fer)g(adds)300
1781 y(o)o(v)o(erhead)23 b(to)h(the)g(I/O)g(operation.)29
b(It)24 b(w)o(ould)f(be)i(nice)f(if)g(I/O)f(could)h(be)g(performed)g
(directly)g(from)f(the)300 1931 y(process')32 b(address)g(space,)i(b)n
(ut)d(in)g(a)i(traditional)d(k)o(ernel)i(it)g(is)f(necessary)h(to)g
(cop)o(y)f(the)h(data)g(for)g(the)300 2080 y(follo)n(wing)23
b(reasons:)445 2313 y Fr(\017)49 b Fs(The)29 b(data)h(may)f(not)f(be)i
(resident.)44 b(As)29 b(part)g(of)h(the)f(data)g(cop)o(ying)g(process)g
(the)g(k)o(ernel)h(f)o(aults)544 2462 y(in)i(an)o(y)f(non-resident)h
(pages)g(in)g(the)g(process')g(address)g(space)h(before)g(cop)o(ying)e
(the)h(data)g(to)544 2611 y(the)e(k)o(ernel)h(b)n(uf)n(fer)-5
b(.)47 b(This)30 b(ensures)g(that)g(nonresident)g(pages)g(do)g(not)g
(interfere)h(with)f(the)g(I/O)544 2761 y(operation.)445
2993 y Fr(\017)49 b Fs(A)21 b(process)f(may)h(modify)f(its)g(data)h
(while)f(the)h(I/O)g(operation)f(is)g(in)h(progress.)29
b(If)21 b(the)g(k)o(ernel)g(did)544 3143 y(not)k(mak)o(e)h(a)g(cop)o(y)
f(of)h(the)f(data,)h(then)g(these)f(modi\002cations)f(could)i(ef)n
(fect)g(the)f(I/O)h(operation.)544 3292 y(By)g(making)f(a)i(cop)o(y)f
(of)g(the)g(data)g(in)g(a)g(pri)n(v)n(ate)f(b)n(uf)n(fer)l(,)h(the)g(k)
o(ernel)h(ensures)f(that)f(changes)h(the)544 3441 y(process)32
b(may)f(mak)o(e)h(to)g(its)f(memory)g(after)i(the)f(I/O)f(operation)h
(has)g(started)f(will)g(not)h(ef)n(fect)544 3591 y(data)25
b(that)f(the)h(process)f(considers)h(already)g(sent.)445
3823 y Fr(\017)49 b Fs(The)19 b(data)g(may)g(be)g(\003ushed)g(or)g
(paged)g(out)f(by)h(another)g(process)g(or)g(the)g(page)g(daemon.)28
b(The)19 b(I/O)544 3973 y(system)24 b(requires)h(that)f(data)h(must)f
(remain)h(resident)f(while)h(an)g(I/O)g(operation)f(is)h(in)g
(progress.)544 4122 y(Since)39 b(k)o(ernel)h(b)n(uf)n(fers)f(are)h(al)o
(w)o(ays)e(resident)h(and)g(ne)n(v)o(er)g(touched)f(by)h(the)g(page)h
(daemon,)544 4271 y(performing)24 b(I/O)h(on)f(a)h(k)o(ernel)g(b)n(uf)n
(fer)g(is)f(not)h(a)g(problem.)583 4504 y(P)o(age)h(loanout)f(is)g(a)h
(feature)g(of)g(UVM)f(that)g(addresses)h(these)f(issues)g(by)g(allo)n
(wing)f(a)i(process)300 4653 y(to)34 b(safely)h(loan)f(out)g(its)g
(pages)g(to)g(another)g(process)h(or)f(the)h(k)o(ernel.)60
b(This)33 b(allo)n(ws)h(the)g(process)g(to)300 4802 y(send)28
b(data)g(directly)g(from)g(its)f(memory)g(to)h(a)g(de)n(vice)g(or)g
(another)g(process)g(without)f(ha)n(ving)h(to)f(cop)o(y)300
4952 y(the)h(data)g(to)f(an)h(intermediate)f(k)o(ernel)h(b)n(uf)n(fer)
-5 b(.)40 b(This)27 b(reduces)h(the)g(o)o(v)o(erhead)f(of)h(I/O)g(and)g
(allo)n(ws)e(the)300 5101 y(k)o(ernel)f(to)f(spend)h(more)f(time)g
(doing)g(useful)h(w)o(ork)f(and)h(less)f(time)g(cop)o(ying)g(data.)583
5251 y(At)k(an)h(abstract)f(le)n(v)o(el,)g(loaning)f(a)i(page)f(of)g
(memory)g(out)f(is)h(not)g(o)o(v)o(erly)f(comple)o(x.)39
b(T)-8 b(o)28 b(loan)300 5400 y(out)j(a)h(page,)i(UVM)d(must)g(mak)o(e)
g(the)h(page)g(read-only)g(and,)h(increment)e(the)h(page')-5
b(s)31 b(loan)h(counter)-5 b(.)p eop
%%Page: 136 156
136 155 bop 3751 100 a Fs(136)744 1339 y @beginspecial
0 @llx 0 @lly 465 @urx 204 @ury 3255 @rwi @setspecial
%%BeginDocument: ../figures/loan.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-27.0 218.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 3673 m 0 0 l 8232 0 l 8232 3673 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
1950 450 m
gs 1 -1 sc (virtual address space) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1455 m
gs 1 -1 sc (wired kernel pages) col0 sh gr
% Polyline
30.000 slw
n 1200 600 m 1200 3600 l gs col0 s gr 
% Polyline
n 2700 600 m 2700 3600 l gs col0 s gr 
% Polyline
n 1200 900 m 2700 900 l gs col0 s gr 
% Polyline
n 1200 1500 m 2700 1500 l gs col0 s gr 
% Polyline
n 1200 2100 m 2700 2100 l gs col0 s gr 
% Polyline
n 1200 2700 m 2700 2700 l gs col0 s gr 
% Polyline
n 1200 3300 m 2700 3300 l gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
4050 899 m 4173 905 l 4062 958 l 4221 926 l 4209 868 l cp
clip
n 2700 1200 m 4200 900 l gs col0 s gr gr

% arrowhead
n 4050 899 m 4173 905 l 4062 958 l 4056 929 l 4050 899 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4050 1499 m 4173 1505 l 4062 1558 l 4221 1526 l 4209 1468 l cp
clip
n 2700 1800 m 4200 1500 l gs col0 s gr gr

% arrowhead
n 4050 1499 m 4173 1505 l 4062 1558 l 4056 1529 l 4050 1499 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4062 2642 m 4173 2694 l 4050 2701 l 4209 2732 l 4221 2674 l cp
clip
n 2700 2400 m 4200 2700 l gs col0 s gr gr

% arrowhead
n 4062 2642 m 4173 2694 l 4050 2701 l 4056 2671 l 4062 2642 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4062 3242 m 4173 3294 l 4050 3301 l 4209 3332 l 4221 3274 l cp
clip
n 2700 3000 m 4200 3300 l gs col0 s gr gr

% arrowhead
n 4062 3242 m 4173 3294 l 4050 3301 l 4056 3271 l 4062 3242 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica ff 300.00 scf sf
1950 1275 m
gs 1 -1 sc (obj page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1950 1875 m
gs 1 -1 sc (anon page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1950 2475 m
gs 1 -1 sc (obj page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1950 3075 m
gs 1 -1 sc (anon page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 2925 m
gs 1 -1 sc (page loanout to pageable) col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3255 m
gs 1 -1 sc (anonymous memory \(anons\)) col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1125 m
gs 1 -1 sc (page loanout to) col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1608 1543 a(Figure)25 b(7.1:)30 b(P)o(age)25
b(loanout)300 1938 y(Then)31 b(the)g(page)h(can)g(safely)f(be)h(mapped)
f(\(read-only\).)50 b(The)31 b(comple)o(xity)f(of)h(page)h(loanout)e
(arises)300 2087 y(when)j(handling)f(the)i(special)f(cases)h(where)f
(some)g(other)g(process)h(needs)f(to)g(mak)o(e)g(use)h(of)f(a)h(page)
300 2237 y(currently)25 b(loaned)f(out.)30 b(In)25 b(that)f(case)i(the)
e(loan)h(may)f(ha)n(v)o(e)h(to)f(be)h(brok)o(en.)300
2568 y Ff(7.1.1)119 b(Loan)29 b(T)-9 b(ypes)30 b(and)h(Attrib)n(utes)
300 2785 y Fs(A)e(page)g(of)g(memory)f(loaned)g(out)h(by)f(a)h(process)
g(must)f(come)h(from)f(one)h(of)g(UVM')-5 b(s)28 b(tw)o(o)g(mapping)300
2934 y(layers.)h(A)21 b(process)g(can)g(loan)f(its)g(memory)g(out)g(to)
h(either)f(the)h(k)o(ernel)g(or)g(to)f(another)h(process.)29
b(T)-8 b(o)20 b(loan)300 3083 y(memory)i(to)g(the)h(k)o(ernel,)g(UVM)f
(creates)i(an)f(array)g(of)g(pointers)f(to)g Fm(vm)p
2771 3083 30 4 v 35 w(page)g Fs(structures)h(that)f(can)h(be)300
3233 y(mapped)i(into)g(the)h(k)o(ernel')-5 b(s)25 b(address)h(space.)34
b(T)-8 b(o)25 b(loan)h(memory)e(to)i(other)f(processes,)h(UVM)f
(creates)300 3382 y(an)35 b(array)h(of)f(pointers)f(to)h(anon)g
(structures)f(that)h(can)g(be)g(entered)h(into)e(an)h(amap)g(that)f
(belongs)g(to)300 3532 y(the)24 b(tar)n(get)h(process.)31
b(The)24 b(tar)n(get)h(process)g(can)g(treat)f(the)h(loaned)f(memory)g
(lik)o(e)g(normal)g(anon)o(ymous)300 3681 y(memory)g(for)h(the)g(most)e
(part.)31 b(P)o(age)25 b(loanout)f(is)g(sho)n(wn)g(in)g(Figure)h(7.1.)
583 3830 y(Thus,)e(an)o(y)f(loanout)g(of)h(a)h(page)f(of)g(memory)f
(must)g(f)o(all)h(into)f(one)h(of)g(the)f(follo)n(wing)f(four)i(loan)
300 3980 y(types:)300 4212 y Fo(object)j(to)f(k)o(er)o(nel:)49
b Fs(A)25 b(page)g(from)g(a)g Fm(uvm)p 1827 4212 V 35
w(object)f Fs(loaned)g(out)h(to)f(the)h(k)o(ernel.)300
4445 y Fo(anon)g(to)g(k)o(er)o(nel:)50 b Fs(A)25 b(page)g(from)f(an)h
(anon)g(loaned)f(out)h(to)f(the)h(k)o(ernel.)300 4677
y Fo(object)h(to)f(anon:)49 b Fs(A)25 b(page)g(from)g(a)g
Fm(uvm)p 1769 4677 V 35 w(object)e Fs(loaned)i(out)f(to)h(an)g(anon.)
300 4909 y Fo(anon)g(to)g(anon:)50 b Fs(A)24 b(page)g(from)g(an)g(anon)
g(loaned)g(out)g(as)g(an)g(anon.)30 b(Since)25 b(the)f(data)g(is)g
(already)g(in)g(an)544 5059 y(anon,)d(no)e(special)h(action)g(other)g
(than)g(incrementing)f(the)h(anon')-5 b(s)19 b(reference)j(count)d(is)h
(required)544 5208 y(to)k(create)i(a)f(loan)g(of)f(this)g(type.)p
eop
%%Page: 137 157
137 156 bop 3751 100 a Fs(137)300 249 y(The)42 b(procedures)f(for)h
(performing)f(each)i(of)e(these)h(types)f(of)h(loans)f(will)f(be)i
(described)g(in)f(Sec-)300 398 y(tion)36 b(7.1.5.)67
b(Note)36 b(that)h(it)f(is)h(possible)e(for)j(a)f(page)g(from)g(a)g
Fm(uvm)p 2718 398 30 4 v 35 w(object)f Fs(to)h(be)g(loaned)f(to)h(an)
300 548 y(anon)25 b(and)f(then)h(later)g(loaned)f(from)h(that)f(anon)h
(to)f(the)h(k)o(ernel.)583 697 y(All)31 b(types)f(of)h(loaned-out)g
(pages)g(are)g(read-only)-6 b(.)49 b(As)31 b(long)f(as)h(the)g(page)g
(is)g(loaned-out)f(its)300 847 y(data)k(cannot)h(be)f(modi\002ed.)59
b(In)34 b(order)h(to)f(modify)f(data)i(in)f(a)h(loaned)f(out)g(page,)j
(the)d(k)o(ernel)g(must)300 996 y(terminate)26 b(the)g(loan.)36
b(This)25 b(is)h(called)h(\223breaking\224)g(the)f(loan.)35
b(Breaking)27 b(a)g(loan)f(in)l(v)n(olv)o(es)f(allocating)300
1145 y(a)32 b(ne)n(w)f(page)g(of)n(f)h(the)f(free)h(list,)g(cop)o(ying)
f(the)g(data)g(from)h(the)f(loaned)g(page)h(to)f(the)g(ne)n(w)g(page,)i
(and)300 1295 y(then)24 b(using)g(the)h(ne)n(w)f(page.)583
1444 y(There)h(are)g(se)n(v)o(eral)e(e)n(v)o(ents)f(that)i(can)g(cause)
h(UVM)e(to)h(break)g(a)g(loan.)30 b(These)24 b(e)n(v)o(ents)f(include:)
445 1677 y Fr(\017)49 b Fs(The)25 b(o)n(wner)f(of)h(a)g(loaned)g(page)g
(w)o(ants)f(to)g(free)i(the)f(page.)445 1909 y Fr(\017)49
b Fs(A)25 b(write)f(f)o(ault)h(on)f(a)i(loaned)e(page.)445
2141 y Fr(\017)49 b Fs(The)25 b(pagedaemon)f(w)o(ants)g(to)h(pageout)f
(a)h(page)g(currently)g(loaned)f(out.)445 2374 y Fr(\017)49
b Fs(An)25 b(object)f(needs)h(to)f(\003ush)h(a)g(loaned)f(page.)300
2606 y(UVM)19 b(had)g(to)g(be)g(modi\002ed)g(to)f(handle)h(loaned)g
(pages)g(in)g(each)h(of)f(these)g(cases.)29 b(These)20
b(modi\002cations)300 2756 y(are)26 b(described)e(later)h(in)g(this)e
(chapter)-5 b(.)583 2905 y(Memory)34 b(pages)g(loaned)g(to)g(the)g(k)o
(ernel)g(ha)n(v)o(e)g(three)h(important)d(properties.)59
b(First,)36 b(pages)300 3054 y(loaned)g(to)f(the)h(k)o(ernel)g(must)f
(be)i(resident.)64 b(If)36 b(the)g(data)g(is)g(on)g(backing)f(store)h
(then)g(it)f(is)h(fetched)300 3204 y(before)28 b(the)e(loanout)g
(proceeds.)38 b(Second,)28 b(each)f(page)g(loaned)g(to)g(the)g(k)o
(ernel)g(is)f(\223wired\224)i(to)e(pre)n(v)o(ent)300
3353 y(the)e(pagedaemon)f(from)h(attempting)e(to)h(pageout)h(a)g(page)g
(loaned)g(to)f(the)h(k)o(ernel)g(while)f(the)h(k)o(ernel)g(is)300
3503 y(still)e(using)f(it.)30 b(This)22 b(is)h(important)e(because)i
(if)g(the)g(pagedaemon)f(w)o(as)h(allo)n(wed)f(to)h(pageout)f(the)h
(page)300 3652 y(then)g(the)g(ne)o(xt)g(time)g(the)g(k)o(ernel)h
(accessed)g(the)f(loaned)g(page)h(an)f(unresolv)n(able)f(page)i(f)o
(ault)f(w)o(ould)g(be)300 3801 y(generated)j(\(and)f(the)h(system)e(w)o
(ould)h(crash\).)33 b(Third,)25 b(pages)g(loaned)g(to)g(the)h(k)o
(ernel)f(are)h(entered)g(into)300 3951 y(the)j(k)o(ernel')-5
b(s)29 b(pmap)f(with)h(a)g(special)g(function)f(that)h(pre)n(v)o(ents)f
(page-based)h(pmap)g(operations)f(from)300 4100 y(af)n(fecting)f(the)f
(k)o(ernel)h(mapping.)36 b(This)26 b(allo)n(ws)f(UVM)i(to)f(perform)h
(normal)f(VM)h(operations)f(on)g(the)300 4250 y(loaned-out)c(page)i
(without)d(ha)n(ving)h(to)h(w)o(orry)g(about)g(disrupting)e(the)i(k)o
(ernel')-5 b(s)23 b(loaned)f(mapping)g(and)300 4399 y(causing)i(an)h
(unresolv)n(able)f(page)h(f)o(ault.)583 4548 y(Memory)36
b(pages)h(loaned)f(from)h(an)f(object)h(to)f(an)h(anon)f(ha)n(v)o(e)g
(tw)o(o)h(important)e(properties.)300 4698 y(First,)d(while)e(most)g
(pages)h(are)h(referenced)g(by)f(either)f(a)i Fm(uvm)p
2529 4698 V 35 w(object)d Fs(or)i(an)g(anon,)h(these)f(pages)300
4847 y(are)22 b(referenced)h(by)f(both)f(types)g(of)g(memory)g
(objects.)29 b(Ho)n(we)n(v)o(er)l(,)21 b(it)g(should)g(be)g(noted)h
(that)f(the)g(pages)300 4997 y(are)j(considered)f(o)n(wned)f(by)h
(their)f Fm(uvm)p 1700 4997 V 36 w(object)f Fs(and)i(not)g(the)g(anon)g
(that)f(the)o(y)h(are)g(loaned)g(to.)30 b(This)300 5146
y(means)23 b(that)f(in)h(order)g(to)g(lock)g(the)g(\002elds)g(of)g(a)g
(page)g(loaned)g(from)g(a)g Fm(uvm)p 2907 5146 V 36 w(object)e
Fs(to)i(an)g(anon,)g(the)300 5295 y Fm(uvm)p 486 5295
V 35 w(object)j Fs(must)g(be)h(lock)o(ed.)36 b(Second,)28
b(a)f Fm(uvm)p 2172 5295 V 35 w(object)p Fs(')-5 b(s)26
b(page)h(can)g(only)f(be)h(loaned)g(to)f(one)p eop
%%Page: 138 158
138 157 bop 3751 100 a Fs(138)300 249 y(anon)27 b(at)g(a)h(time.)38
b(Future)27 b(loans)g(to)g(an)g(anon)g(need)h(only)f(gain)f(a)i
(reference)h(to)e(the)g(anon)g(the)g(page)h(is)300 398
y(already)d(loaned)g(to)f(\(rather)h(than)g(allocating)f(a)h(ne)n(w)f
(anon)h(to)f(loan)h(to\).)583 548 y(When)d(an)f(object)g(that)g(o)n
(wns)g(a)h(loaned)f(page)g(decides)h(to)f(free)h(it,)f(the)h(page)f
(cannot)g(be)h(placed)300 697 y(on)k(the)h(free)h(page)f(list)e
(because)i(it)f(is)h(still)e(being)h(used)h(by)f(the)h(process)f(that)g
(the)h(page)g(is)f(loaned)h(to.)300 847 y(Rather)22 b(than)f(free)h
(the)f(page,)h(the)f(page)h(becomes)f(o)n(wnerless.)28
b(If)22 b(an)g(o)n(wnerless)e(page)h(w)o(as)h(originally)300
996 y(loaned)h(from)f(a)h Fm(uvm)p 1058 996 30 4 v 36
w(object)e Fs(to)i(an)g(anon,)f(then)h(the)g(anon)f(is)h(free)g(to)g
(tak)o(e)g(o)o(v)o(er)f(the)h(o)n(wnership)e(of)300 1145
y(the)27 b(page)h(the)f(ne)o(xt)g(time)g(it)g(holds)f(the)h
(appropriate)h(lock.)38 b(When)28 b(the)f(loan)g(count)g(of)g(an)h(o)n
(wnerless)300 1295 y(page)d(is)f(decremented)h(to)g(zero,)g(then)f(the)
h(page)g(can)g(be)g(placed)g(on)g(the)f(free)i(list.)300
1626 y Ff(7.1.2)119 b(Loaning)30 b(and)g(Locking)300
1843 y Fs(As)35 b(stated)g(in)g(the)h(pre)n(vious)e(section,)j(in)e
(order)h(to)f(lock)g(a)h(page)g(one)f(must)g(lock)g(its)f(o)n(wner)-5
b(.)62 b(F)o(or)300 1992 y(e)o(xample,)29 b(if)g(an)h(anon)e(contains)h
(a)g(page)g(that)g(is)g(on)f(loan)h(from)g(a)h Fm(uvm)p
2866 1992 V 35 w(object)e Fs(the)h(object)f(must)300
2141 y(be)f(lock)o(ed)g(to)g(access)g(the)g Fm(vm)p 1374
2141 V 36 w(page)f Fs(data)h(structure')-5 b(s)26 b(\002elds.)38
b(There)27 b(are)h(tw)o(o)f(problem)f(with)g(this.)300
2291 y(The)32 b(\002rst)g(has)f(to)h(do)f(with)g(lock)h(ordering.)51
b(If)32 b(UVM)f(is)g(already)i(holding)d(a)i(lock)f(on)h(the)f(anon,)j
(it)300 2440 y(cannot)27 b(just)f(lock)h(the)g Fm(uvm)p
1298 2440 V 35 w(object)f Fs(since)g(that)h(violates)f(lock)h
(ordering.)37 b(Instead,)27 b(it)g(must)f(\223try\224)300
2590 y(to)e(lock)h(the)g(object,)f(and)h(if)f(that)h(f)o(ails)f(it)g
(must)g(drop)h(the)f(anon)h(lock)f(and)h(then)g(try)f(again.)583
2739 y(The)35 b(second)f(problem)f(is)h(that)g(an)g(anon)g(that)g(has)g
(a)h(page)f(on)g(loan)g(from)g(an)h(object)e(does)300
2888 y(not)27 b(hold)g(a)h(reference)h(to)f(that)f(object.)39
b(Thus,)27 b(when)h(attempting)e(to)h(lock)g(the)h(object)f(it)g(is)g
(possible)300 3038 y(for)f(the)f(object)g(to)g(terminate)g(between)h
(the)f(time)g(the)g(page')-5 b(s)25 b(object)g(\002eld)h(is)f(read)h
(and)f(the)h(time)e(the)300 3187 y(lock)30 b(on)g(the)g(object)g(is)g
(attempted.)47 b(In)30 b(order)h(to)f(pre)n(v)o(ent)f(this,)i(the)f
(page)h(queues)f(must)f(be)h(lock)o(ed)300 3337 y(before)h(trying)f(to)
g(lock)g(the)h(object.)47 b(Locking)30 b(the)g(page)h(queues)g(pre)n(v)
o(ents)e(the)h(page')-5 b(s)30 b(loan)h(count)300 3486
y(from)26 b(changing)f(and)g(thus)g(ensures)h(that)g(the)f(object)h
(cannot)f(be)h(terminated)f(until)g(the)g(page)h(queues)300
3635 y(are)g(unlock)o(ed.)583 3785 y(The)34 b(option)f(of)g(allo)n
(wing)f(an)i(anon)g(that)f(has)g(a)h(page)g(on)g(loan)f(from)g(an)h
(object)g(to)f(hold)g(a)300 3934 y(reference)28 b(to)e(that)g(object)g
(w)o(as)h(considered.)35 b(Ho)n(we)n(v)o(er)26 b(this)f(pro)o(v)o(ed)g
(to)i(be)f(impractical)g(in)g(the)h(case)300 4084 y(where)c(the)g
(pagedaemon)f(needs)g(to)h(break)g(the)f(loan.)30 b(In)22
b(that)h(case)g(the)f(pagedaemon)g(w)o(ould)g(ha)n(v)o(e)g(to)300
4233 y(drop)27 b(the)g(reference)i(to)e(the)h(object,)f(possibly)f
(triggering)g(asynchronous)h(I/O.)g(This)f(w)o(ould)h(lead)g(to)300
4382 y(deadlock)d(because)g(the)g(pagedaemon)f(w)o(ould)g(be)h(w)o
(aiting)f(for)h(the)g(asynchronous)e(I/O)i(operation)f(to)300
4532 y(complete,)i(b)n(ut)h(the)f(services)h(of)g(the)g(pagedaemon)f(w)
o(ould)g(be)h(needed)g(to)f(complete)h(the)f(I/O.)h(Thus,)300
4681 y(the)c(idea)g(of)g(allo)n(wing)e(an)i(anon)g(with)f(a)h(loaned)f
(page)h(to)g(hold)f(a)h(reference)i(to)d(the)h(object)f(that)h(o)n
(wned)300 4830 y(the)h(page)h(w)o(as)g(rejected)f(and)h(instead)f(we)h
(rely)f(on)g(the)h(page)f(queue)h(lock)f(to)g(pre)n(v)o(ent)g(an)g
(object)g(from)300 4980 y(being)h(freed)i(out)e(from)h(under)f(an)h
(anon)g(with)f(a)h(loaned)g(page.)p eop
%%Page: 139 159
139 158 bop 3751 100 a Fs(139)300 249 y Ff(7.1.3)119
b(Loanout)29 b(Data)h(Structur)n(es)h(and)f(Functions)300
466 y Fs(In)g(order)g(to)f(support)g(page)g(loanout,)h(tw)o(o)f(minor)g
(changes)h(had)f(to)h(be)f(made)h(to)f(UVM)g(data)h(struc-)300
615 y(tures.)67 b(First,)40 b(a)e(ne)n(w)e(\223loan)h(count\224)g
(\002eld)g(w)o(as)g(added)h(to)e(the)h Fm(vm)p 2752 615
30 4 v 36 w(page)f Fs(structure.)67 b(A)37 b(page)h(is)300
764 y(currently)31 b(loaned)h(out)f(if)g(its)g(loan)h(count)f(is)g
(non-zero.)51 b(In)32 b(order)g(to)f(change)h(the)g(loan)f(count)g(of)h
(a)300 914 y(page,)j(the)d(k)o(ernel)h(must)f(be)h(holding)e(both)h
(the)g(page)h(o)n(wner)g(lock)f(and)h(the)f(page)h(queue)g(lock.)54
b(In)300 1063 y(order)25 b(to)g(read)g(the)g(loan)f(count,)g(only)g
(one)h(of)g(the)g(locks)f(need)h(be)g(held.)583 1213
y(Second,)e(the)e(page)h(o)n(wner)e(\002eld)i(had)f(to)g(be)h(changed.)
29 b(Before)23 b(page)e(loanout)g(w)o(as)g(supported)300
1362 y(a)j(page)f(could)g(belong)f(to)h(either)g(a)h
Fm(uvm)p 1723 1362 V 35 w(object)e Fs(or)h(an)h(anon.)30
b(The)23 b(o)n(wner)g(\002eld)g(w)o(as)h(a)f(union)g(that)300
1511 y(contained)32 b(a)i(pointer)e(to)g(each)i(of)f(these)g
(structures.)54 b(No)n(w)32 b(that)h(page)g(loanout)f(is)g(supported)g
(it)h(is)300 1661 y(possible)g(for)i(a)f(page)h(that)f(is)f(part)i(of)f
(a)h Fm(uvm)p 1969 1661 V 35 w(object)e Fs(to)h(be)g(loaned)g(out)g(to)
g(an)g(anon.)59 b(So,)37 b(the)300 1810 y(union)26 b(w)o(as)g(con)l(v)o
(erted)g(to)h(a)g(structure)f(so)g(that)g(a)h(page)g(can)g(refer)h(to)e
(both)g(a)h Fm(uvm)p 3221 1810 V 35 w(object)e Fs(and)i(an)300
1960 y(anon)e(at)f(the)h(same)g(time.)583 2109 y(Three)53
b(major)f(functions)f(were)i(added)f(to)g(UVM)g(to)g(support)f
(loanout:)85 b Fm(uvm)p 3607 2109 V 35 w(loan)p Fs(,)300
2258 y Fm(uvm)p 486 2258 V 35 w(unloananon)p Fs(,)19
b(and)i Fm(uvm)p 1510 2258 V 35 w(unloanpage)p Fs(.)27
b(The)21 b Fm(uvm)p 2553 2258 V 35 w(loan)f Fs(function)g(establishes)f
(a)i(page)300 2408 y(loanout.)52 b(It)32 b(tak)o(es)g(a)g(range)g(of)h
(virtual)e(addresses)h(in)g(a)g Fm(vm)p 2469 2408 V 35
w(map)g Fs(and)g(returns)g(either)g(an)g(array)h(of)300
2557 y(page)27 b(pointers)f(or)h(anon)g(pointers)f(\(depending)h(on)g
(if)g(the)f(loan)h(is)g(to)f(the)h(k)o(ernel)g(or)g(to)g(anons\).)37
b(The)300 2707 y(loan)25 b(function)f(can)i(f)o(ail)f(if)g(part)h(of)f
(the)g(address)g(range)h(speci\002ed)g(is)e(unmapped)h(or)g(if)g(it)g
(w)o(as)g(unable)300 2856 y(to)f(get)g(some)g(of)h(the)f(pages)g(in)h
(the)f(speci\002ed)h(range)f(\(e.g.)31 b(due)25 b(to)f(pager)g
(errors\).)32 b(Once)24 b(a)h(process)g(is)300 3005 y(\002nished)g
(with)g(loaned)g(pages,)h(it)f(can)h(drop)g(the)f(loan)g(by)h(using)e
(either)i(the)f Fm(uvm)p 3164 3005 V 36 w(unloanpage)e
Fs(or)300 3155 y(the)28 b Fm(uvm)p 636 3155 V 35 w(unloananon)e
Fs(functions.)39 b(Memory)27 b(loaned)h(to)g(anons)f(that)h(is)f
(currently)h(mapped)g(can)300 3304 y(also)c(be)h(freed)h(with)e(the)h
(standard)f Fm(uvm)p 1731 3304 V 35 w(unmap)g Fs(function.)300
3635 y Ff(7.1.4)119 b(Anonget)30 b(and)h(Loaned)f(P)o(ages)300
3852 y Fs(An)k(anon)h(can)g(point)e(to)i(a)f(page)h(loaned)g(from)f(a)h
Fm(uvm)p 2305 3852 V 35 w(object)p Fs(.)59 b(The)34 b
Fm(uvmfault)p 3453 3852 V 35 w(anonget)300 4001 y Fs(function)j(has)g
(tw)o(o)g(features)g(that)g(are)i(used)e(to)g(handle)g(pages)g(loaned)g
(from)g(objects)3444 3965 y Fj(2)3481 4001 y Fs(.)68
b(First,)40 b(in)300 4151 y(cases)27 b(where)g(the)g(anon)f(does)h(not)
f(o)n(wn)g(the)g(page)h(that)g(it)f(refers)h(to,)g(the)g(anonget)f
(routine)g(locks)g(the)300 4300 y(object)35 b(that)g(o)n(wns)f(the)i
(page.)62 b(This)35 b(means)g(that)g(a)h(function)e(that)h(uses)g
Fm(uvmfault)p 3453 4300 V 35 w(anonget)300 4450 y Fs(must)22
b(unlock)g(the)h(object)f(before)i(returning.)29 b(Second,)24
b(when)f(the)g(anonget)f(routine)g(detects)h(an)g(anon)300
4599 y(that)h(points)f(to)g(an)i(o)n(wnerless)e(page)h(it)g(causes)g
(the)g(anon)g(to)g(tak)o(e)g(o)o(v)o(er)f(o)n(wnership)g(of)h(the)g
(page.)31 b(The)300 4748 y(follo)n(wing)23 b(is)h(pseudo)g(code)h(for)g
(these)g(parts)g(of)g(the)f(anonget)h(routine:)300 4977
y Fm(/*)59 b(start)g(with)g(a)g(locked)g(anon)g(that)g(points)f(to)h(a)
360 5097 y(*)g(loaned)g(page)g(...)g(*/)300 5217 y(restart:)p
300 5287 1440 4 v 416 5348 a Fi(2)449 5378 y Fh(See)21
b(Section)f(5.1.6)f(for)g(a)i(description)e(of)g Fe(uvmfault)p
2106 5378 25 4 v 29 w(anonget)p Fh(.)p eop
%%Page: 140 160
140 159 bop 3751 100 a Fs(140)420 249 y Fm(lock\(page)57
b(queues\);)420 369 y(if)i(\(anon->page->object\))c({)539
490 y(if)k(\(!try_lock\(anon->page->object\)\))53 b({)659
610 y(unlock\(anon,)k(page)i(queues\);)659 731 y(/*)g(allow)g(other)f
(processes)g(to)h(proceed)g(*/)659 851 y(lock\(anon\);)659
971 y(goto)g(restart;)539 1092 y(})420 1212 y(})g(else)g(if)g(\(page)g
(is)g(ownerless\))f({)539 1333 y(page->owner)f(=)j(anon;)420
1453 y(})420 1573 y(unlock\(page)d(queues\);)420 1694
y(/*)i(done,)g(continue)f(anonget)g(*/)300 2240 y Ff(7.1.5)119
b(Loanout)29 b(Pr)n(ocedur)n(e)300 2457 y Fs(In)35 b(this)f(section)h
(the)f(procedure)i(used)f(to)f(establish)g(each)i(of)f(the)g(four)g
(types)f(of)h(page)h(loanout)e(is)300 2606 y(described.)300
2900 y Fo(Object)26 b(to)f(K)n(er)o(nel)f(Loan)300 3116
y Fs(T)-8 b(o)28 b(loan)g(a)g(page)g(from)g(a)g Fm(uvm)p
1399 3116 30 4 v 36 w(object)e Fs(to)i(the)g(k)o(ernel)g(the)g(follo)n
(wing)e(steps)h(are)i(tak)o(en.)40 b(First)28 b(the)300
3266 y(object)h(is)g(lock)o(ed.)45 b(Second,)32 b(the)d(page)h(is)f
(fetched)h(from)g(the)f(object)g(using)g(the)h(object')-5
b(s)28 b(pager)i(get)300 3415 y(function.)e(If)21 b(the)f(page)h(is)f
(not)g(resident,)g(then)g(the)g(object)g(is)g(unlock)o(ed)g(and)g(an)h
(I/O)f(is)g(initiated.)28 b(Once)300 3565 y(the)20 b(page)h(is)f
(resident)f(the)i(object)e(is)h(relock)o(ed.)30 b(Third,)20
b(the)g(page)h(queues)f(are)h(lock)o(ed.)29 b(Since)21
b(both)e(the)300 3714 y(object)j(and)f(the)h(page)g(queues)g(are)h
(lock)o(ed)e(this)g(allo)n(ws)g(the)h(pages)g(loan)f(counter)h(to)g(be)
g(incremented.)300 3863 y(If)34 b(the)e(loan)h(counter)g(w)o(as)g
(zero,)j(then)c(the)h(page)h(must)e(be)h(globally)f(write-protected)g
(to)h(trigger)g(a)300 4013 y(cop)o(y-on-write)27 b(operation)g(in)f
(the)i(e)n(v)o(ent)e(that)h(some)f(process)i(attempts)e(to)h(modify)f
(the)h(page)h(while)300 4162 y(the)34 b(loan)g(is)f(established.)57
b(F)o(ourth,)36 b(the)e(page)g(is)f(wired)h(\(i.e.)59
b(remo)o(v)o(ed)32 b(from)i(the)g(pagedaemon')-5 b(s)300
4311 y(queues\).)54 b(Finally)32 b(the)h(page)g(queues)f(and)h(object)f
(can)h(be)g(unlock)o(ed.)54 b(The)32 b(pseudo)g(code)h(for)g(this)300
4461 y(process)25 b(is:)300 4678 y Fm(lock\(object\);)300
4798 y(page)59 b(=)g(get_page\(object,offset\);)c(/*)k(make)g(resident)
f(*/)300 4918 y(lock\(page)g(queues\);)300 5039 y(if)h
(\(page->loan_count)d(==)k(0\))420 5159 y(write_protect\(page\);)300
5280 y(page->loan_count++;)300 5400 y(wire\(page\);)p
eop
%%Page: 141 161
141 160 bop 3751 100 a Fs(141)300 249 y Fm(unlock\(object,)57
b(page)i(queues\);)300 369 y(return\(page\);)300 893
y Fo(Anon)25 b(to)g(K)n(er)o(nel)g(Loan)300 1109 y Fs(T)-8
b(o)31 b(loan)g(a)h(page)f(from)g(an)h(anon)f(to)g(a)g(wired)g(k)o
(ernel)h(page)f(the)g(follo)n(wing)f(steps)g(are)i(tak)o(en.)50
b(First,)300 1259 y(the)31 b(anon)h(must)e(be)h(lock)o(ed.)51
b(Second,)33 b(the)e Fm(uvmfault)p 2360 1259 30 4 v 35
w(anonget)f Fs(function)g(must)g(be)i(called)f(to)300
1408 y(mak)o(e)23 b(the)g(anon')-5 b(s)22 b(page)h(resident.)30
b(Note)23 b(that)f Fm(uvmfault)p 2423 1408 V 34 w(anonget)g
Fs(checks)h(for)g(anon)g(that)f(ha)n(v)o(e)300 1558 y(pages)j(on)f
(loan)h(from)g Fm(uvm)p 1278 1558 V 35 w(object)p Fs(s.)k(In)c(that)g
(case)g(the)g(anonget)f(function)g(will)g(ensure)h(that)g(both)300
1707 y(the)e(anon)h(and)f(the)g Fm(uvm)p 1161 1707 V
36 w(object)f Fs(are)i(lock)o(ed.)30 b(Third,)23 b(the)h(page)f(queues)
h(are)g(lock)o(ed)f(and)h(the)f(page)300 1856 y(is)f(write)h(protected)
g(\(if)g(needed\),)g(the)g(loan)g(count)f(is)g(incremented,)h(and)g
(the)g(page)g(is)f(wired.)30 b(Finally)-6 b(,)300 2006
y(the)24 b(anon,)g Fm(uvm)p 875 2006 V 35 w(object)f
Fs(\(if)h(there)h(is)e(one\),)i(and)f(the)g(page)g(queues)g(are)h
(unlock)o(ed)e(and)h(the)g(page)h(is)300 2155 y(returned.)31
b(The)25 b(pseudo)f(code)h(for)g(this)f(process)g(is:)300
2384 y Fm(lock\(anon\);)300 2504 y(uvmfault_anonget\(anon\);)114
b(/*)60 b(makes)e(resident)g(*/)300 2624 y(/*)h(if)h(anon's)e(page)h
(has)g(an)g(object,)g(it)g(is)g(locked)g(*/)300 2745
y(lock\(page)f(queues\);)300 2865 y(if)h(\(anon->page->loan_count)c(==)
k(0\))420 2985 y(write_protect\(anon->page\);)300 3106
y(anon->page->loan_count++;)300 3226 y(wire\(anon->page\);)300
3347 y(if)g(\(anon->page->object\))420 3467 y
(unlock\(anon->page->object\);)300 3587 y(unlock\(anon,)e(page)i
(queues\);)300 3708 y(return\(anon->page\);)300 4231
y Fo(Object)26 b(to)f(Anon)g(Loan)300 4448 y Fs(T)-8
b(o)28 b(loan)f(a)h(page)g(from)g(an)g(object)f(to)h(an)g(anon)g(the)f
(follo)n(wing)f(steps)h(are)i(tak)o(en.)40 b(First)27
b(the)h(object)g(is)300 4597 y(lock)o(ed)g(and)g(the)h(page)f(is)g
(look)o(ed)g(up)g(using)f(the)i(pager)f(get)h(function.)40
b(If)29 b(the)f(page)h(is)f(not)g(resident,)300 4747
y(then)i(it)g(is)g(fetched.)49 b(Second,)32 b(UVM)e(checks)h(to)f(see)h
(if)f(the)h(page)f(has)h(already)g(been)g(loaned)f(to)g(an)300
4896 y(anon.)i(If)26 b(so,)f(it)g(locks)g(the)g(anon,)h(increments)e
(the)i(anon')-5 b(s)24 b(reference)j(count,)e(unlocks)g(the)g(anon)g
(and)300 5045 y(object,)f(and)g(returns)g(a)h(pointer)f(to)f(the)i
(anon.)30 b(Third,)24 b(if)g(the)g(page)h(has)f(not)g(been)g(loaned)g
(to)g(an)g(anon,)300 5195 y(then)h(a)i(ne)n(w)e(anon)g(is)h(allocated.)
33 b(The)26 b(page)g(queues)f(are)i(then)e(lock)o(ed,)h(the)f(page)h
(is)g(write)f(protected)300 5344 y(if)k(necessary)-6
b(,)31 b(the)e(loan)g(count)g(is)g(incremented,)h(and)f(a)h
(bi-direction)e(link)h(is)g(established)f(between)p eop
%%Page: 142 162
142 161 bop 3751 100 a Fs(142)300 249 y(the)27 b(ne)n(w)g(anon)h(and)f
(the)g(page.)39 b(Finally)-6 b(,)27 b(the)g(page)h(queues)f(and)h
(object)f(are)h(unlock)o(ed)f(and)g(the)h(ne)n(w)300
398 y(anon)d(is)f(returned.)31 b(The)25 b(pseudo)f(code)h(for)g(this)f
(process)g(is:)300 627 y Fm(lock\(object\);)300 747 y(page)59
b(=)g(get_page\(object,offset\);)c(/*)k(make)g(resident)f(*/)300
868 y(if)h(\(page->anon\))e({)j(/*)f(already)f(loaned)h(to)g(an)h
(anon?)e(*/)420 988 y(lock\(anon\);)420 1108 y
(anon->reference_count++1;)420 1229 y(unlock\(anon,object\);)420
1349 y(return\(page\);)300 1469 y(})300 1590 y(allocate)g(new)h(anon;)
300 1710 y(point)g(new)g(anon)g(at)g(page)g(and)g(vice-versa;)300
1831 y(lock\(page)f(queues\);)300 1951 y(if)h(\(page->loan_count)d(==)k
(0\))420 2071 y(write_protect\(page\);)300 2192 y(page->loan_count++;)
300 2312 y(unlock\(page)d(queues,object\);)300 2432 y(return\(new)h
(anon\);)300 2956 y Fo(Anon)25 b(to)g(Anon)h(Loan)300
3173 y Fs(Loaning)g(a)h(page)g(from)g(an)g(anon)g(to)f(an)h(anon)g(is)f
(a)h(simple)f(matter)g(since)h(the)g(page)g(is)f(already)h(in)g(an)300
3322 y(anon.)40 b(All)27 b(that)g(needs)h(to)f(be)h(done)g(is)f(to)h
(lock)f(the)h(anon,)g(increment)g(the)f(anon')-5 b(s)27
b(reference)j(count,)300 3471 y(write)25 b(protect)f(the)h(page)g(\(if)
g(necessary\),)g(and)g(then)f(unlock)g(and)h(return)g(the)g(anon.)300
3802 y Ff(7.1.6)119 b(Dr)n(opping)31 b(and)g(Fr)n(eeing)f(Loaned-Out)g
(P)o(ages)300 4019 y Fs(When)24 b(a)g(process)g(or)g(the)f(k)o(ernel)h
(is)g(\002nished)f(with)g(loaned)h(out)f(pages)h(the)f(loan)h(should)f
(be)h(dropped.)300 4169 y(F)o(or)37 b(pages)g(loaned)g(to)g(an)g(anon)g
(this)f(is)g(simply)g(a)h(matter)g(of)g(locking)f(the)h(anon,)j
(decrementing)300 4318 y(the)33 b(anon')-5 b(s)32 b(reference)j(count,)
g(and)e(unlocking)f(the)h(anon.)55 b(If)34 b(the)f(anon')-5
b(s)32 b(reference)j(count)e(drops)300 4467 y(to)c(zero)h(then)e(the)i
(anon)e(can)i(be)f(freed)h(with)f(the)g(standard)g Fm(uvm)p
2618 4467 30 4 v 35 w(anfree)f Fs(function.)43 b(This)28
b(allo)n(ws)300 4617 y(pages)35 b(loaned)h(to)f(anons)g(that)g(are)h
(mapped)f(in)g(other)h(processes)f(to)g(be)h(freed)g(with)f(the)g
(standard)300 4766 y Fm(uvm)p 486 4766 V 35 w(unmap)23
b Fs(function.)30 b(The)24 b Fm(uvm)p 1591 4766 V 35
w(anfree)f Fs(function)g(handles)g(pages)h(that)g(ha)n(v)o(e)g(been)g
(loaned)f(to)300 4915 y(an)j(anon.)32 b(If)26 b(the)f(page)h(in)f(an)h
(anon)f(has)h(a)f(non-zero)h(loan)f(count,)g(then)g(the)h(anon)f(free)h
(function)f(\002rst)300 5065 y(attempts)20 b(to)i(lock)f(the)h(true)g
(o)n(wner)f(of)h(the)f(page.)30 b(If)22 b(the)g(page)g(is)f(o)n
(wnerless,)h(then)f(the)h(anon)f(will)g(tak)o(e)300 5214
y(o)o(v)o(er)31 b(o)n(wnership)f(of)i(the)g(page.)52
b(At)32 b(this)f(point,)h(if)g(the)f(page)h(is)g(o)n(wned)f(by)g(a)i
Fm(uvm)p 3309 5214 V 35 w(object)d Fs(then)300 5364 y(the)f(page)h
(queues)f(are)h(lock)o(ed)f(while)g(the)g(page')-5 b(s)29
b(loan)g(count)g(is)f(dropped)h(and)h(the)f(page')-5
b(s)29 b(pointer)p eop
%%Page: 143 163
143 162 bop 3751 100 a Fs(143)300 249 y(to)29 b(the)g(anon)h(is)f
(zeroed.)45 b(Once)30 b(that)f(is)g(done,)h(the)g(page)f(is)g(no)h
(longer)f(loaned)g(to)g(an)h(anon)f(and)g(the)300 398
y Fm(uvm)p 486 398 30 4 v 35 w(anfree)24 b Fs(function)g(need)h(not)f
(w)o(orry)h(about)f(it)g(an)o(ymore.)583 548 y(If)33
b(the)f(page)g(w)o(as)g(loaned)f(b)n(ut)h(not)f(o)n(wned)g(by)h(a)g
Fm(uvm)p 2545 548 V 35 w(object)p Fs(,)h(then)e(it)h(must)e(be)i
(loaned)300 697 y(by)26 b(the)f(anon)h(to)f(the)h(k)o(ernel.)34
b(In)26 b(this)e(case,)j(the)f(page)g(is)f(passed)h(to)f(the)h
Fm(uvm)p 3035 697 V 35 w(pagefree)e Fs(function)300 847
y(and)33 b(then)g(the)h(anon)f(is)g(freed.)57 b(If)34
b(a)g(loaned)f(page)h(is)f(freed,)j(rather)e(than)f(adding)f(the)i
(page)f(to)g(the)300 996 y(free)28 b(page)f(list)f(the)g(o)n(wnership)g
(of)h(the)g(page)g(is)f(dropped)h(and)g(the)f(page)h(becomes)g(o)n
(wnerless.)36 b(This)300 1145 y(allo)n(ws)23 b(memory)h(objects)g(to)g
(free)i(their)e(pages)h(without)e(ha)n(ving)h(to)g(w)o(orry)h(about)f
(whether)g(the)h(page)300 1295 y(is)g(currently)h(loaned)f(out)g(or)h
(not.)32 b(Thus,)25 b(this)g(handles)g(the)g(case)i(where)f(an)f
(object')-5 b(s)25 b(pager)h(is)f(ask)o(ed)300 1444 y(to)f(\003ush)h
(out)f(and)h(free)h(the)e(object')-5 b(s)24 b(pages.)300
1775 y Ff(7.1.7)119 b(The)30 b(P)o(agedaemon)f(and)i(Loaned)f(Out)g(P)o
(ages)300 1992 y Fs(The)36 b(pagedaemon)f(pages)h(out)f(and)h(frees)g
(pages)g(when)f(free)i(physical)d(memory)h(is)h(scarce.)64
b(The)300 2141 y(pagedaemon)38 b(must)g(tak)o(e)h(special)f(care)i(in)e
(case)h(it)g(encounters)f(a)h(loaned)f(out)h(page.)72
b(The)39 b(only)300 2291 y(type)f(of)g(loaned)g(out)f(page)i(the)f
(pagedaemon)f(can)i(encounter)f(is)g(a)g(page)g(that)g(has)g(been)g
(loaned)300 2440 y(from)28 b(a)g Fm(uvm)p 780 2440 V
35 w(object)e Fs(to)i(an)g(anon.)39 b(All)28 b(loans)f(to)g(the)h(k)o
(ernel)g(are)g(done)g(via)g(wired)f(pages,)i(so)e(the)300
2590 y(pagedaemon)d(w)o(ould)g(ne)n(v)o(er)h(encounter)f(this)g(sort)h
(of)f(page.)583 2739 y(The)35 b(\002rst)g(thing)f(the)h(pagedaemon)f
(will)g(do)h(is)f(try)h(and)g(lock)f(the)h(page')-5 b(s)34
b Fm(uvm)p 3487 2739 V 35 w(object)p Fs(.)300 2888 y(If)40
b(the)f(lock)h(f)o(ails,)j(then)c(the)g(pagedaemon)g(will)g(skip)g(to)g
(the)g(ne)o(xt)g(page.)75 b(If)40 b(the)g(page)g(is)f(dirty)300
3038 y(then)29 b(the)g(pagedaemon)g(can)g(proceed)h(as)f(normal)g(\227)
g(it)f(will)h(start)f(a)i(pageout)f(I/O)g(operation.)43
b(The)300 3187 y(page)24 b(will)e(already)i(be)g(read-only)f(because)h
(it)f(has)g(been)h(loaned)f(out.)29 b(If)24 b(the)g(page)f(is)g(clean,)
h(then)f(the)300 3337 y(pagedaemon)d(can)g(call)g Fm(uvm)p
1332 3337 V 36 w(pagefree)e Fs(lik)o(e)i(it)f(normally)g(w)o(ould.)29
b(As)20 b(described)g(in)f(the)h(pre)n(vious)300 3486
y(section,)30 b(this)f(will)h(cause)g(the)g(object)f(to)h(drop)f(o)n
(wnership)g(of)h(the)g(page)g(\(the)g(anon)g(will)f(be)h(free)g(to)300
3635 y(claim)24 b(o)n(wnership)g(of)h(the)f(page\))h(and)g(the)g(loan)f
(will)g(be)h(brok)o(en.)583 3785 y(The)g(pagedaemon)f(can)g(also)g
(detect)g(o)n(wnerless)g(pages.)30 b(This)23 b(can)i(happen)f(if)g(an)h
(object)f(that)300 3934 y(o)n(wned)i(a)i(page)f(that)g(has)g(been)h
(loaned)f(to)g(an)g(anon)g(has)g(dropped)g(o)n(wnership)f(of)h(that)g
(page.)38 b(If)28 b(this)300 4084 y(sort)h(of)h(page)f(is)g
(encountered)h(then)f(the)g(pagedaemon)h(attempts)e(to)h(lock)g(the)h
(page')-5 b(s)29 b(anon.)44 b(If)30 b(the)300 4233 y(attempt)20
b(f)o(ails,)h(then)f(the)h(pagedaemon)f(skips)g(to)g(the)h(ne)o(xt)f
(page.)29 b(If)21 b(the)g(anon)f(is)h(successfully)e(lock)o(ed)300
4382 y(then)25 b(the)g(pagedaemon)g(causes)g(the)g(anon)g(to)g(tak)o(e)
g(o)o(v)o(er)f(o)n(wnership)g(of)h(the)g(page.)32 b(At)25
b(this)f(point)g(the)300 4532 y(page)32 b(will)f(no)g(longer)h(be)g
(loaned)f(out)g(and)h(can)g(be)g(treated)g(lik)o(e)f(a)h(normal)g
(anon-o)n(wned)e(page.)52 b(It)300 4681 y(should)23 b(be)i(noted)g
(that)f(the)g(pagedaemon)h(should)e(ne)n(v)o(er)h(encounter)h(an)g(o)n
(wnerless)e(page)i(that)f(is)h(not)300 4830 y(on)e(loan)g(to)g(an)h
(anon)f(because)h(that)f(can)g(only)g(happen)g(with)g(pages)g(loaned)g
(to)g(the)h(k)o(ernel,)f(and)h(those)300 4980 y(pages)h(are)g(al)o(w)o
(ays)g(wired.)p eop
%%Page: 144 164
144 163 bop 3751 100 a Fs(144)300 249 y Ff(7.1.8)119
b(F)m(aulting)30 b(on)h(a)e Fb(uvm)p 1586 249 36 4 v
42 w(object)g Ff(with)h(Loaned-Out)h(P)o(ages)300 466
y Fs(The)36 b(page)h(f)o(ault)f(routine)f(must)h(also)f(be)i(a)o(w)o
(are)g(of)f(loaned)g(pages.)65 b(It)36 b(must)f(ensure)i(tw)o(o)f
(things:)300 615 y(loaned)27 b(out)g(pages)g(are)h(ne)n(v)o(er)f
(mapped)g(read-write)h(and)f(that)g(write)g(f)o(aults)g(on)g(loaned)g
(pages)h(cause)300 764 y(the)d(loans)f(to)g(be)h(brok)o(en.)30
b(The)25 b(case)g(of)g(a)g(page)g(f)o(ault)f(on)h(an)f(object)h(\(a)g
(\223case)g(2\224)g(f)o(ault,)f(as)h(described)300 914
y(in)34 b(Chapter)g(5\))h(is)e(handled)h(as)g(follo)n(ws.)58
b(F)o(or)34 b(cop)o(y-on-write)f(and)h(zero-\002ll)h(f)o(aults)f
(\(case)h(2B\))f(no)300 1063 y(special)27 b(action)f(is)h(required)g
(since)g(the)f(object')-5 b(s)26 b(pages)h(are)h(ne)n(v)o(er)e(written)
h(in)f(that)h(case.)38 b(F)o(or)27 b(f)o(aults)300 1213
y(directly)i(on)g(the)g(object')-5 b(s)28 b(pages)i(\(case)g(2A\),)f
(if)g(the)h(f)o(ault)f(is)f(a)i(read)g(f)o(ault)f(on)g(a)h(loaned)f
(page,)h(then)300 1362 y(the)i(f)o(ault)h(routine)e(must)h(ensure)g
(that)g(the)h(page)f(is)h(al)o(w)o(ays)f(mapped)g(read-only)g(re)o
(gardless)g(of)g(the)300 1511 y(current)g(protection)f(on)g(the)h
(mapping.)50 b(If)32 b(the)g(f)o(ault)f(is)h(a)g(write)f(f)o(ault)h(on)
f(a)h(loaned)g(page)g(then)f(the)300 1661 y(loan)24 b(must)g(be)h(brok)
o(en.)583 1810 y(T)-8 b(o)24 b(break)h(the)f(loan)f(the)h(follo)n(wing)
f(steps)g(are)i(tak)o(en:)30 b(the)24 b(object)f(is)h(lock)o(ed)g(and)g
(a)g(ne)n(w)g(page)300 1960 y(is)32 b(allocated.)53 b(The)32
b(data)g(from)g(the)g(old)g(loaned)g(out)g(page)g(is)g(copied)g(to)g
(the)g(ne)n(w)g(page.)53 b(Then)32 b(all)300 2109 y(mappings)d(of)h
(the)g(old)f(page)h(are)h(remo)o(v)o(ed)e(thus)g(forcing)h(all)g(users)
f(of)i(the)e(object)h(to)g(refresh)g(their)300 2258 y(mapping)25
b(of)h(the)g(page)g(the)g(ne)o(xt)f(time)h(it)f(is)h(referenced.)36
b(The)26 b(old)f(page)h(is)g(then)g(remo)o(v)o(ed)e(from)i(the)300
2408 y(object)f(and)h(its)e(o)n(wnership)g(is)h(dropped.)33
b(Then)25 b(the)g(ne)n(w)g(page)h(is)f(installed)f(in)h(the)h(object)f
(at)g(the)h(old)300 2557 y(page')-5 b(s)23 b(of)n(fset.)30
b(At)23 b(this)g(point)g(the)g(ne)n(wly)g(allocated)h(page)f(has)h
(replaced)g(the)g(old)f(page)h(in)f(the)h(object)300
2707 y(and)29 b(the)g(f)o(ault)g(can)h(proceed)f(as)h(usual.)43
b(The)29 b(old)g(page)g(is)g(o)n(wnerless)f(and)i(will)e(be)h(freed)h
(when)f(the)300 2856 y(processes)c(to)f(which)g(it)h(is)f(loaned)h(are)
g(\002nished)g(with)f(it.)300 3187 y Ff(7.1.9)119 b(F)m(aulting)30
b(on)h(an)f(Anon)h(W)n(ith)e(Loaned-Out)i(P)o(ages)300
3404 y Fs(P)o(age)g(f)o(aults)f(on)g(anons)g(that)g(point)g(to)g
(loaned)g(pages)h(also)f(require)h(special)f(handling)g(by)g(the)g(f)o
(ault)300 3553 y(routine.)74 b(First,)42 b(as)e(pre)n(viously)d
(described,)43 b(calling)c Fm(uvmfault)p 2759 3553 30
4 v 34 w(anonget)f Fs(on)h(an)g(anon)h(that)300 3703
y(points)21 b(to)g(a)i(loaned)f(page)g(that)g(has)g(no)f(o)n(wner)h
(will)f(cause)i(the)f(anon)g(to)f(tak)o(e)h(o)o(v)o(er)g(o)n(wnership)e
(of)j(that)300 3852 y(page.)45 b(Calling)29 b Fm(uvmfault)p
1367 3852 V 34 w(anonget)f Fs(on)h(an)h(anon)f(that)g(points)f(to)h(a)h
(loaned)f(page)h(that)f(has)g(an)300 4001 y(o)n(wner)c(will)f(lock)g
(the)h(page')-5 b(s)25 b(o)n(wner)f(\(if)h(it)g(is)f(not)h(that)f
(anon\).)32 b(If)25 b(the)g(f)o(ault)g(is)f(a)h(read)h(f)o(ault,)f
(then)f(the)300 4151 y(f)o(ault)f(routine)f(must)g(ensure)h(that)g(the)
g(page)g(is)g(entered)g(into)f(the)h(f)o(aulting)f(process')h(pmap)g
(read-only)-6 b(,)300 4300 y(e)n(v)o(en)26 b(if)h(the)g(anon')-5
b(s)26 b(reference)i(count)f(is)f(one.)37 b(If)28 b(the)f(f)o(ault)f
(is)h(a)g(write)g(f)o(ault,)g(then)f(the)h(f)o(ault)g(routine)300
4450 y(must)f(break)i(the)f(loan.)37 b(F)o(or)27 b(anon')-5
b(s)27 b(with)f(a)h(reference)i(count)e(that)f(is)h(greater)h(than)f
(one,)g(no)g(special)300 4599 y(action)33 b(is)f(required)h(because)g
(the)g(normal)g(anon)f(cop)o(y-on-write)h(mechanism)f(will)g(handle)g
(things)300 4748 y(properly)-6 b(.)32 b(A)25 b(ne)n(w)g(anon)g(will)g
(be)g(created)h(and)g(the)f(data)h(copied)f(to)g(a)g(ne)n(w)g(page)h
(associated)f(with)g(it.)300 4898 y(The)31 b(original)g(anon)g(with)f
(the)i(loaned-out)e(page)i(will)e(remain)h(untouched)g(\(other)g(than)g
(ha)n(ving)g(its)300 5047 y(reference)26 b(count)f(decremented\).)583
5197 y(T)-8 b(o)22 b(break)g(the)g(loan)g(for)g(a)g(write)g(f)o(ault)g
(on)f(an)h(anon)g(with)f(a)h(reference)i(count)d(of)h(one,)h(the)e(f)o
(ault)300 5346 y(routine)27 b(must)f(do)g(the)i(follo)n(wing.)35
b(It)28 b(must)e(\002rst)h(allocate)g(a)h(ne)n(w)e(page.)38
b(If)28 b(no)f(pages)g(are)h(a)n(v)n(ailable,)p eop
%%Page: 145 165
145 164 bop 3751 100 a Fs(145)300 249 y(then)37 b(the)g(f)o(ault)g
(routine)g(w)o(ak)o(es)g(the)h(pagedaemon)e(and)i(w)o(aits)f(for)g(it)g
(to)g(mak)o(e)g(some)g(free)h(pages)300 398 y(a)n(v)n(ailable.)44
b(Once)30 b(the)f(ne)n(w)g(page)h(is)f(allocated,)h(then)f(the)h(f)o
(ault)f(routine)g(must)f(cop)o(y)h(the)h(data)f(from)300
548 y(the)c(old)f(page)h(to)f(ne)n(w)g(page.)31 b(Then)24
b(the)h(f)o(ault)f(routine)g(remo)o(v)o(es)g(the)g(old)g(page)h(from)g
(all)f(user)h(pmaps)300 697 y(to)j(cause)g(them)f(to)h(refresh)h(their)
e(mappings)g(on)g(their)h(ne)o(xt)f(memory)g(reference.)42
b(It)28 b(then)g(locks)f(the)300 847 y(page)e(queues,)g(decrements)g
(the)g(loan)g(count)g(on)g(the)g(old)f(page)i(and)f(zeros)g(the)h
(page')-5 b(s)24 b(anon)h(pointer)-5 b(.)300 996 y(If)28
b(the)f(anon)h(o)n(wned)e(the)i(page)f(\(and)h(thus)f(it)g(w)o(as)g
(loaned)g(out)g(to)g(the)h(k)o(ernel\),)g(then)f(this)g(causes)g(the)
300 1145 y(page)j(to)f(become)h(o)n(wnerless.)45 b(If)30
b(a)g Fm(uvm)p 1788 1145 30 4 v 36 w(object)e Fs(o)n(wned)h(the)h
(page,)h(then)e(this)g(causes)h(the)g(page)300 1295 y(to)f(no)f(longer)
h(be)g(loaned)g(out)f(to)h(an)g(anon.)43 b(At)29 b(this)f(point)g(the)g
(f)o(ault)h(routine)f(can)i(unlock)e(the)h(page)300 1444
y(queues)h(and)g(the)f(old)h(page')-5 b(s)29 b Fm(uvm)p
1560 1444 V 36 w(object)f Fs(\(if)i(it)g(had)g(one\).)46
b(Finally)-6 b(,)30 b(the)g(f)o(ault)f(routine)h(installs)300
1594 y(the)22 b(ne)n(w)g(page)h(into)e(the)h(anon)h(and)f(the)g(f)o
(ault)g(can)h(be)g(resolv)o(ed)e(as)i(usual.)29 b(In)22
b(essence,)h(what)g(happens)300 1743 y(is)29 b(that)h(the)f(old)h
(loaned)f(page)h(is)g(disassociated)e(from)i(the)g(the)f(anon)h(and)g
(replaced)g(with)f(a)h(freshly)300 1892 y(allocated)25
b(page)g(that)f(is)g(not)g(loaned)h(out.)300 2224 y Ff(7.1.10)118
b(Using)31 b(P)o(age)e(Loanout)300 2440 y Fs(P)o(age)j(loanout)f(can)i
(be)f(used)g(in)f(a)i(number)e(of)h(w)o(ays.)52 b(F)o(or)32
b(e)o(xample,)h(to)f(quickly)f(transfer)h(a)h(lar)n(ge)300
2590 y(chunk)28 b(of)h(data)g(from)g(one)g(process)f(to)h(another)g
(the)f(data)h(can)g(be)g(loaned)g(out)f(to)h(anons,)g(and)g(those)300
2739 y(anons)21 b(can)g(then)g(be)g(inserted)f(into)h(an)g(amap)g
(belonging)e(to)i(the)g(tar)n(get)g(process.)29 b(P)o(age)22
b(loanout)e(to)g(the)300 2888 y(k)o(ernel)27 b(can)h(be)g(used)f(to)g
(impro)o(v)o(e)e(both)i(netw)o(ork)g(and)g(de)n(vice)g(I/O.)g(F)o(or)g
(e)o(xample,)g(when)h(a)f(process)300 3038 y(w)o(ants)36
b(to)f(send)h(data)g(out)g(o)o(v)o(er)f(the)h(netw)o(ork)f(the)h(k)o
(ernel)g(w)o(ould)g(normally)e(cop)o(y)i(the)g(data)g(from)300
3187 y(the)e(process')g(memory)g(into)f(k)o(ernel)h(netw)o(ork)g(b)n
(uf)n(fers)g(\(mb)n(ufs\).)59 b(Ho)n(we)n(v)o(er)l(,)35
b(instead)f(of)g(cop)o(ying)300 3337 y(the)e(process')h(pages,)h(the)e
(pages)g(could)g(be)g(loaned)g(out)g(to)g(the)g(k)o(ernel)h(and)f(then)
g(associated)g(with)300 3486 y(mb)n(ufs,)24 b(thus)g(a)n(v)n(oiding)g
(a)i(costly)e(data)h(cop)o(y)-6 b(.)31 b(An)25 b(audio)f(de)n(vice)h
(could)g(access)g(pages)g(of)g(audio)g(data)300 3635
y(loaned)e(from)h(the)f(user)h(process')f(virtual)g(address)h(space)g
(to)f(the)g(audio)g(dri)n(v)o(er)g(directly)-6 b(.)29
b(This)23 b(w)o(ould)300 3785 y(eliminate)h(the)g(need)h(to)g(cop)o(y)f
(the)h(data)g(to)f(a)h(pri)n(v)n(ate)f(k)o(ernel)h(b)n(uf)n(fer)-5
b(.)583 3934 y(P)o(age)22 b(loanout)e(can)h(also)f(be)h(used)g(to)g
(partly)f(replace)i(the)e(k)o(ernel')-5 b(s)21 b Fm(physio)f
Fs(interf)o(ace)h(that)g(is)300 4084 y(used)i(for)g(\223ra)o(w\224)h
(I/O)f(to)g(de)n(vices)g(such)g(as)g(a)g(disk.)30 b(The)23
b Fm(physio)f Fs(function)g(allo)n(ws)g(a)i(de)n(vice)f(to)g(read)300
4233 y(and)j(write)g(directly)f(from)h(a)g(user)g(process')g(memory)g
(without)e(ha)n(ving)h(to)h(mak)o(e)g(a)g(data)g(cop)o(y)-6
b(.)34 b(P)o(age)300 4382 y(loaning)d(can)h(be)g(used)f(to)g(\002x)h
(se)n(v)o(eral)f(problems)g(associated)g(with)g(using)g
Fm(physio)f Fs(to)h(write)h(data)300 4532 y(directly)24
b(from)h(a)g(process')g(address)f(space)h(to)g(a)g(de)n(vice.)30
b(The)25 b Fm(physio)e Fs(function)h(w)o(orks)g(by)h(wiring)300
4681 y(a)d(process')g(memory)-6 b(,)21 b(encapsulating)g(that)h(memory)
f(in)g(a)i(k)o(ernel)f(b)n(uf)n(fer)l(,)g(starting)f(an)h(I/O)g
(operation,)300 4830 y(and)35 b(then)g(w)o(aiting)f(for)i(the)f(I/O)g
(operation)g(to)f(\002nish.)62 b(Once)36 b(the)f(I/O)g(operation)f
(completes,)j(the)300 4980 y Fm(physio)25 b Fs(function)h(returns.)35
b(There)26 b(are)h(tw)o(o)f(problems)f(with)h(I/O)g(performed)h(using)e
(this)g(process.)300 5129 y(First,)35 b Fm(physio)d Fs(assumes)g(that)g
(no)h(process)g(other)g(than)g(the)g(one)g(performing)f(I/O)h(has)g
(access)g(to)300 5279 y(the)27 b(process')g(virtual)g(address)g(space,)
h(and)f(thus)f(the)h(process')g(memory)f(cannot)h(change)h(while)e(the)
p eop
%%Page: 146 166
146 165 bop 3751 100 a Fs(146)300 249 y Fm(physio)28
b Fs(operation)h(is)h(in)f(progress.)45 b(While)29 b(this)g(is)g(true)h
(for)f(single)g(threaded)h(systems,)f(it)g(is)h(not)300
398 y(true)g(for)h(multithreaded)e(systems)g(where)i(a)g(process')f
(address)g(space)h(can)g(be)f(shared)h(by)f(multiple)300
548 y(threads.)36 b(On)26 b(such)h(a)f(system,)g(it)g(is)g(possible)g
(for)g(one)h(thread)g(to)f(be)h(performing)e(a)i Fm(physio)f
Fs(on)g(an)300 697 y(area)e(of)g(virtual)e(memory)g(while)h(another)g
(thread)h(writes)e(to)h(or)h(unmaps)e(the)h(same)g(area)h(of)g(memory)
-6 b(.)300 847 y(Thus)24 b Fm(physio)g Fs(as)h(it)f(is)g(currently)h
(implemented)e(is)h(unsuitable)g(for)h(use)g(on)f(those)g(systems.)583
996 y(The)30 b(second)f(problem)f(with)h(processes)g(using)f
Fm(physio)g Fs(to)h(write)g(data)g(to)g(de)n(vices)g(is)g(that)300
1145 y Fm(physio)k Fs(only)g(supports)f(synchronous)h(I/O.)h(Process)g
(performing)f(a)h Fm(physio)f Fs(operation)g(must)300
1295 y(w)o(ait)24 b(until)f(the)h(operation)f(completes)g(before)i(the)
o(y)e(can)i(continue)e(e)o(x)o(ecution.)29 b(This)23
b(is)h(necessary)g(to)300 1444 y(pre)n(v)o(ent)g(the)g(process)h(from)g
(disturbing)e(the)h(mapping)g(of)h(its)f(b)n(uf)n(fer)h(while)f(the)h
(I/O)f(is)h(in)f(progress.)583 1594 y(Both)30 b(these)f(problems)f(can)
h(be)h(addressed)f(by)g(modifying)e Fm(physio)h Fs(to)h(use)g(page)g
(loanout)300 1743 y(to)c(loan)g(out)g(the)g(pages)h(containing)e(the)h
(data)g(being)g(written)g(to)g(the)g(k)o(ernel.)33 b(The)25
b(modi\002ed)g(v)o(ersion)300 1892 y(of)34 b Fm(physio)f
Fs(w)o(ould)g(operate)h(as)g(follo)n(ws.)56 b(First,)36
b(a)e(process)g(w)o(ould)f(perform)h(a)g(write)g(operation)300
2042 y(that)29 b(in)l(v)n(ok)o(ed)g Fm(physio)p Fs(.)44
b(The)30 b Fm(physio)e Fs(function)h(w)o(ould)g(then)g(use)h
Fm(uvm)p 3015 2042 30 4 v 35 w(loan)f Fs(to)g(loan)g(out)g(the)300
2191 y(process')j(b)n(uf)n(fers)g(to)f(the)h(k)o(ernel.)52
b(Second,)34 b Fm(physio)d Fs(w)o(ould)g(use)g(the)h(loaned)g(out)f
(pages)h(to)f(start)300 2341 y(the)39 b(asynchronous)f(I/O)i
(operation.)73 b(Third,)43 b(the)c Fm(physio)f Fs(operation)g(w)o(ould)
h(return,)k(allo)n(wing)300 2490 y(the)31 b(process)f(to)h(continue)f
(e)o(x)o(ecution.)47 b(Ev)o(entually)-6 b(,)30 b(the)h(I/O)g(operation)
f(w)o(ould)g(complete)g(and)h(the)300 2639 y(k)o(ernel)25
b(w)o(ould)f(drop)h(the)g(loan)f(of)h(the)g(process')g(memory)-6
b(.)30 b(While)24 b(the)h(I/O)g(is)g(in)f(progress)h(the)g(user')-5
b(s)300 2789 y(b)n(uf)n(fer)19 b(will)f(be)h(cop)o(y-on-write,)h(thus)e
(pre)n(v)o(enting)f(the)i(process)g(from)f(writing)g(to)h(the)f(pages)h
Fm(physio)300 2938 y Fs(is)37 b(using)f(for)i(I/O.)f(Furthermore,)k
(the)c(process)h(can)f(safely)h(unmap)f(and)g(free)h(its)f(pages)h
(without)300 3088 y(disrupting)27 b(the)h(I/O)g(operation.)41
b(If)29 b(the)f(loaned)g(out)g(pages)g(are)h(freed)g(due)g(to)e(an)i
(unmap,)f(the)o(y)g(will)300 3237 y(become)20 b(o)n(wnerless)g
(loaned-out)f(pages)h(and)h(will)e(e)n(v)o(entually)f(be)j(freed)g
(when)f(the)g(k)o(ernel)h(is)e(\002nished)300 3386 y(with)24
b(them)g(\(b)n(ut)h(not)f(before)h(then\).)300 3770 y
Fg(7.2)143 b(P)o(age)34 b(T)-11 b(ransfer)300 4022 y
Fs(Under)33 b(a)g(traditional)e(BSD)j(k)o(ernel,)g(when)f(the)f(k)o
(ernel)h(w)o(ants)f(to)h(mo)o(v)o(e)e(some)h(of)h(its)f(data)g(from)h
(a)300 4172 y(k)o(ernel)28 b(b)n(uf)n(fer)h(to)f(a)h(user)f(process')h
(virtual)e(address)h(space)h(it)f(uses)g(the)g Fm(copyout)f
Fs(function.)41 b(This)300 4321 y(function)27 b(copies)g(the)g(data)g
(w)o(ord)h(by)f(w)o(ord)g(to)g(a)h(user)f(b)n(uf)n(fer)-5
b(.)38 b(If)28 b(the)g(user')-5 b(s)26 b(b)n(uf)n(fer)i(is)f(not)g
(resident,)300 4471 y(then)d(a)i(page)f(f)o(ault)f(is)g(triggered)h
(and)g(the)f(the)h(b)n(uf)n(fer)g(is)f(paged)h(in)f(before)i(the)e(cop)
o(y)h(is)f(started.)583 4620 y(F)o(or)k(lar)n(ge)g(chunks)f(of)h(data)f
(all)h(this)e(cop)o(ying)h(can)h(get)f(e)o(xpensi)n(v)o(e.)38
b(P)o(age)27 b(transfer)h(pro)o(vides)300 4769 y(the)j(k)o(ernel)h(a)g
(w)o(ay)f(to)g(w)o(ork)g(around)h(this)e(data)i(cop)o(y)f(by)g(allo)n
(wing)f(the)h(k)o(ernel)h(to)f(inject)g(pages)g(of)300
4919 y(memory)h(into)f(a)i(process')g(virtual)f(address)g(space.)55
b(P)o(age)33 b(transfer)g(tak)o(es)f(either)h(k)o(ernel)f(pages)h(or)
300 5068 y(anons)h(and)h(installs)e(them)h(at)h(either)f(a)h(virtual)f
(address)h(speci\002ed)g(by)f(the)h(user)f(process)h(or)g(if)f(no)300
5218 y(address)23 b(is)f(speci\002ed,)h(it)f(installs)f(them)h(in)h(an)
g(area)g(of)g(virtual)f(memory)g(reserv)o(ed)g(for)h(page)g(transfer)-5
b(.)p eop
%%Page: 147 167
147 166 bop 3751 100 a Fs(147)744 1339 y @beginspecial
0 @llx 0 @lly 465 @urx 204 @ury 3255 @rwi @setspecial
%%BeginDocument: ../figures/xfer.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-27.0 506.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 8473 m 0 0 l 8232 0 l 8232 8473 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
1950 5250 m
gs 1 -1 sc (virtual address space) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 6255 m
gs 1 -1 sc (donated kernel pages) col0 sh gr
/Helvetica ff 300.00 scf sf
4500 7725 m
gs 1 -1 sc (page transfer from pageable) col0 sh gr
/Helvetica ff 300.00 scf sf
4500 8055 m
gs 1 -1 sc (anonymous memory \(anons\)) col0 sh gr
% Polyline
30.000 slw
n 1200 5400 m 1200 8400 l gs col0 s gr 
% Polyline
n 2700 5400 m 2700 8400 l gs col0 s gr 
% Polyline
n 1200 5700 m 2700 5700 l gs col0 s gr 
% Polyline
n 1200 6300 m 2700 6300 l gs col0 s gr 
% Polyline
n 1200 6900 m 2700 6900 l gs col0 s gr 
% Polyline
n 1200 7500 m 2700 7500 l gs col0 s gr 
% Polyline
n 1200 8100 m 2700 8100 l gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
2850 6001 m 2726 5994 l 2838 5942 l 2679 5974 l 2691 6032 l cp
clip
n 2700 6000 m 4200 5700 l gs col0 s gr gr

% arrowhead
n 2850 6001 m 2726 5994 l 2838 5942 l 2844 5971 l 2850 6001 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2850 6601 m 2726 6594 l 2838 6542 l 2679 6574 l 2691 6632 l cp
clip
n 2700 6600 m 4200 6300 l gs col0 s gr gr

% arrowhead
n 2850 6601 m 2726 6594 l 2838 6542 l 2844 6571 l 2850 6601 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2838 7258 m 2726 7205 l 2850 7199 l 2691 7168 l 2679 7226 l cp
clip
n 2700 7200 m 4200 7500 l gs col0 s gr gr

% arrowhead
n 2838 7258 m 2726 7205 l 2850 7199 l 2844 7229 l 2838 7258 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2838 7858 m 2726 7805 l 2850 7799 l 2691 7768 l 2679 7826 l cp
clip
n 2700 7800 m 4200 8100 l gs col0 s gr gr

% arrowhead
n 2838 7858 m 2726 7805 l 2850 7799 l 2844 7829 l 2838 7858 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica ff 300.00 scf sf
1950 6075 m
gs 1 -1 sc (anon page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1950 6675 m
gs 1 -1 sc (anon page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1950 7275 m
gs 1 -1 sc (anon page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
1950 7875 m
gs 1 -1 sc (anon page) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 5925 m
gs 1 -1 sc (page transfer from) col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1605 1543 a(Figure)25 b(7.2:)30 b(P)o(age)25
b(transfer)300 1938 y(Once)31 b(a)h(page)f(has)g(been)g(transfered)h
(into)e(a)h(process')g(address)g(space)h(it)e(is)h(treated)g(lik)o(e)g
(an)o(y)f(other)300 2087 y(page)25 b(of)g(anon)o(ymous)e(memory)-6
b(.)29 b(P)o(age)c(transfer)g(is)g(sho)n(wn)e(in)i(Figure)g(7.2.)583
2237 y(There)38 b(are)h(tw)o(o)e(types)g(of)g(page)h(transfer:)57
b(k)o(ernel)37 b(page)h(transfer)g(and)f(anon)o(ymous)f(page)300
2386 y(transfer)-5 b(.)31 b(These)24 b(tw)o(o)h(types)f(of)h(page)g
(transfer)g(are)h(described)e(in)h(the)f(follo)n(wing)f(sections.)300
2717 y Ff(7.2.1)119 b(K)m(er)n(nel)31 b(P)o(age)e(T)-9
b(ransfer)300 2934 y Fs(K)n(ernel)36 b(page)g(transfer)g(occurs)g(when)
g(a)g(page-sized)g(b)n(uf)n(fer)g(that)f(is)h(part)g(of)g(the)f(k)o
(ernel')-5 b(s)36 b(virtual)300 3083 y(memory)23 b(is)g(transfered)i
(into)e(a)h(process')g(address)g(space.)31 b(F)o(or)23
b(e)o(xample,)h(consider)f(an)h(audio)f(de)n(vice)300
3233 y(that)28 b(is)g(currently)g(recording)h(into)f(a)g(b)n(uf)n(fer)
-5 b(.)42 b(The)28 b(audio)h(de)n(vice)f(dri)n(v)o(er)f(can)i(allocate)
g(a)g(page)f(from)300 3382 y(UVM)i(to)g(act)g(as)g(its)g(b)n(uf)n(fer)
-5 b(.)46 b(When)30 b(the)g(page)h(is)f(full)f(the)h(dri)n(v)o(er)g
(can)g(mak)o(e)g(it)g(a)n(v)n(ailable)f(for)i(page)300
3532 y(transfer)-5 b(.)30 b(When)24 b(a)g(process)f(issues)g(a)h(read)g
(on)f(the)h(audio)f(de)n(vice)g(the)h(follo)n(wing)d(procedure)j(is)f
(used.)300 3681 y(A)28 b(ne)n(w)f(anon)h(is)f(allocated)g(and)h(the)f
(page)h(with)f(the)h(data)g(is)f(attached)h(to)f(the)h(ne)n(w)f(anon)g
(as)h(its)f(data)300 3830 y(page.)51 b(Ne)o(xt)31 b(one)h(of)f(tw)o(o)h
(things)e(can)i(happen.)51 b(If)32 b(the)f(user)h(process)g
(speci\002ed)f(a)h(virtual)f(address)300 3980 y(at)e(which)g(to)g(put)f
(the)h(data,)h(then)f(UVM)g(ensures)g(that)g(that)f(address)h(is)g
(mapped)g(and)g(has)g(an)g(amap)300 4129 y(associated)g(with)f(it.)43
b(If)30 b(it)e(is)h(mapped)f(b)n(ut)h(does)g(not)f(ha)n(v)o(e)h(an)g
(amap,)h(then)f(UVM)g(will)f(allocate)h(an)300 4279 y(amap.)52
b(Then)32 b(the)g(anon)g(is)g(installed)e(into)h(the)h(amap)g(at)g(the)
g(appropriate)g(address.)52 b(On)32 b(the)g(other)300
4428 y(hand,)e(if)f(the)g(user)h(process)f(did)g(not)f(specify)h(a)h
(virtual)e(address)h(at)h(which)f(to)f(place)i(the)f(data,)h(then)300
4577 y(UVM)f(chooses)f(a)i(free)g(virtual)e(address)h(at)g(which)g(to)g
(place)g(the)g(data.)44 b(The)29 b(page)g(transfer)h(area)g(of)300
4727 y(the)35 b(virtual)f(address)h(space)h(is)f(al)o(w)o(ays)g(mapped)
f(by)h(an)g(amap.)62 b(UVM)35 b(installs)e(the)i(anon)g(in)g(this)300
4876 y(amap.)c(At)24 b(this)g(point)g(the)g(data)h(has)g(been)g
(transfered)g(and)g(the)g(user)f(process)h(has)g(access)g(to)g(it.)583
5025 y(The)k(netw)o(orking)e(subsystem)g(can)h(also)g(bene\002t)h(from)
f(page)g(transfer)-5 b(.)41 b(K)n(ernel)28 b(netw)o(orking)300
5175 y(b)n(uf)n(fers)f(\(mb)n(ufs\))g(are)h(\002x)o(ed)f(in)g(tw)o(o)g
(sizes)g(at)g(compile)g(time:)34 b(lar)n(ge)28 b(and)f(small.)37
b(If)28 b(the)f(lar)n(ge)h(mb)n(ufs)300 5324 y(are)j(made)g(page)g
(sized,)h(then)e(the)o(y)g(are)h(eligible)f(for)h(page)g(transfer)-5
b(.)48 b(The)31 b(procedure)g(is)f(similar)f(to)p eop
%%Page: 148 168
148 167 bop 3751 100 a Fs(148)300 249 y(what)26 b(is)g(described)g(abo)
o(v)o(e,)g(ho)n(we)n(v)o(er)f(it)g(is)h(more)g(comple)o(x)f(because)i
(mb)n(uf)f(pages)g(usually)f(start)h(of)n(f)300 398 y(as)c(pages)g
(that)f(belong)g(to)h(a)g(k)o(ernel)g Fm(uvm)p 1740 398
30 4 v 35 w(object)e Fs(allocated)i(out)f(of)h(a)g(k)o(ernel)g(submap)f
(with)g(k)o(ernel)300 548 y(mappings.)29 b(In)24 b(this)f(case)i(page)f
(transfer)h(code)f(must)f(remo)o(v)o(e)g(the)h(association)f(between)h
(the)g(mb)n(uf)5 b(')-5 b(s)300 697 y(page)29 b(and)g(the)f(mb)n(uf)g
(system)g(before)h(the)g(page)g(can)g(be)g(transfered.)43
b(This)28 b(procedure)h(is)f(described)300 847 y(belo)n(w)-6
b(.)583 996 y(There)36 b(are)f(tw)o(o)f(possible)f(types)h(of)h(lar)n
(ge)g(mb)n(ufs:)50 b(mb)n(ufs)33 b(that)i(ha)n(v)o(e)f(normal)g
(page-sized)300 1145 y(data)j(areas)h(allocated)f(out)g(of)g(a)h(k)o
(ernel)f(object)g(and)g(mb)n(ufs)f(that)h(ha)n(v)o(e)g(\223e)o
(xternal\224)g(data)g(b)n(uf)n(fers.)300 1295 y(External)28
b(data)g(b)n(uf)n(fers)g(could)g(be)g(pages)h(that)e(are)i(part)g(of)f
(a)h(de)n(vice')-5 b(s)27 b(hardw)o(are)i(memory)-6 b(,)28
b(or)g(the)o(y)300 1444 y(could)c(be)g(pages)h(that)f(were)h(loaned)f
(out)f(from)h(another)h(process.)30 b(P)o(ages)25 b(that)e(are)j(part)e
(of)g(a)h(de)n(vice')-5 b(s)300 1594 y(memory)23 b(must)f(be)i(copied)f
(because)i(the)o(y)d(are)j(not)e(managed)g(by)h(the)f(VM)g(system.)30
b(P)o(ages)23 b(that)g(were)300 1743 y(loaned)33 b(out)f(from)h
(another)g(process)f(can)i(be)f(loaned)f(out)h(to)f(anons)h(and)g(thus)
f(transfered)h(into)f(the)300 1892 y(user')-5 b(s)28
b(address)g(space)1109 1856 y Fj(3)1146 1892 y Fs(.)41
b(Lar)n(ge)29 b(mb)n(ufs)e(that)h(ha)n(v)o(e)g(normally)f(allocated)h
(pages)g(can)g(be)h(handled)e(by)300 2042 y(page)g(sw)o(apping.)34
b(T)-8 b(o)27 b(do)f(this,)g(the)g(netw)o(orking)f(system)h(\002rst)g
(allocates)g(a)h(ne)n(w)f(page)h(and)f(obtains)g(a)300
2191 y(pointer)j(to)g(the)h(page)f(that)g(contains)g(the)h(data.)45
b(It)29 b(then)g(remo)o(v)o(es)g(the)g(page)h(that)f(contains)g(the)g
(data)300 2341 y(from)c(the)h(mb)n(uf)f(system,)f(replacing)i(it)f
(with)g(the)g(ne)n(w)g(page.)33 b(At)26 b(this)e(point)h(the)g(mb)n(uf)
g(is)h(associated)300 2490 y(with)e(the)h(ne)n(w)f(page)h(and)g(the)f
(old)h(page)g(is)f(a)n(v)n(ailable)g(for)h(page)g(transfer)-5
b(.)300 2821 y Ff(7.2.2)119 b(Anonymous)30 b(P)o(age)f(T)-9
b(ransfer)300 3038 y Fs(Anon)o(ymous)36 b(page)j(transfer)g(is)f(used)g
(when)h(the)f(pages)h(to)f(be)h(transfered)g(into)e(a)i(user)g
(process')300 3187 y(address)31 b(space)g(are)g(already)g(associated)f
(with)g(anon)g(structures.)48 b(F)o(or)31 b(e)o(xample,)g(this)f(could)
g(occur)300 3337 y(when)g(another)g(process)g(loans)g(part)g(of)g(its)g
(memory)f(out)h(to)g(anons)f(in)h(order)h(for)f(it)g(to)g(be)g(used)g
(for)300 3486 y(page)23 b(transfer)-5 b(.)29 b(In)23
b(this)e(case)i(UVM)f(need)g(only)g(identify)f(the)h(appropriate)g
(amap)h(structure)f(in)g(which)300 3635 y(to)i(put)h(the)f(anons.)583
3785 y(Anon)o(ymous)19 b(page)i(transfer)g(can)g(be)g(used)g(with)f
(page)h(loanout)e(\(to)i(anons\))f(as)h(part)g(of)g(an)g(IPC)300
3934 y(mechanism.)34 b(The)27 b(IPC)g(system)f(can)g(use)h(these)f(f)o
(acilities)g(to)g(allo)n(w)f(processes)h(to)g(easily)g(e)o(xchange)300
4084 y(anon)c(pages)g(of)h(data.)29 b(Anon)o(ymous)20
b(page)j(transfer)f(can)h(also)f(be)g(used)g(to)g(impro)o(v)o(e)f(the)h
(performance)300 4233 y(of)g Fm(read)g Fs(system)f(calls)g(on)h(plain)g
(\002les)g(if)g(the)g(read)h(b)n(uf)n(fer)f(is)g(page)g(aligned)f(and)h
(page)h(sized.)29 b(Rather)300 4382 y(than)k(cop)o(ying)f(the)g(data)h
(from)g(a)g Fm(uvm)p 1701 4382 V 35 w(object)p Fs(')-5
b(s)32 b(pages)g(to)h(anon)o(ymous)e(memory)-6 b(,)33
b(the)g(object')-5 b(s)300 4532 y(pages)29 b(can)h(be)f(loaned)g(out)f
(to)h(anons.)43 b(Then)29 b(these)g(anons)g(can)g(be)g(transfered)h
(into)e(a)i(process')f(ad-)300 4681 y(dress)19 b(space.)30
b(F)o(or)19 b(normal)g(\002les)h(a)g(similar)e(ef)n(fect)i(could)f(be)h
(achie)n(v)o(ed)f(by)g(using)g Fm(mmap)g Fs(or)g(ha)n(ving)g(the)300
4830 y(k)o(ernel)30 b(establish)e(a)i(normal)f(mapping)g(underneath)g
(the)h Fm(read)f Fs(call.)45 b(The)30 b(disadv)n(antage)e(of)i(doing)
300 4980 y(I/O)d(this)f(w)o(ay)i(is)f(that)f(it)h(leads)g(to)g(more)g
(memory)g(mappings)f(and)h(thus)f(map)h(entry)g(fragmentation.)p
300 5070 1440 4 v 416 5131 a Fi(3)449 5161 y Fh(Thus,)20
b(page)f(loanout)g(and)h(page)f(transfer)h(can)g(both)f(be)h(used)g(at)
h(the)f(same)g(time.)p eop
%%Page: 149 169
149 168 bop 3751 100 a Fs(149)300 249 y(Also,)30 b(if)f(the)h(process)f
(writes)g(to)g(its)g(b)n(uf)n(fer)g(each)h(mapped)f(area)i(will)d(get)i
(its)e(o)n(wn)h(amap.)45 b(This)28 b(re-)300 398 y(quires)c(more)g
(amap)h(memory)f(then)g(anon)o(ymous)e(page)j(transfer)g(and)f(results)
g(in)g(longer)g(map)h(search)300 548 y(times.)43 b(Another)29
b(adv)n(antage)g(of)h(using)e(page)i(transfer)f(is)g(that)g(it)g(gi)n
(v)o(es)f(page-le)n(v)o(el)g(granularity)h(for)300 697
y(mappings.)300 1028 y Ff(7.2.3)119 b(Disposing)30 b(of)f(T)-9
b(ransfer)n(ed)30 b(Data)300 1245 y Fs(If)k(a)g(process)f(is)g(recei)n
(ving)g(data)h(via)f(page)h(transfer)l(,)h(then)f(it)f(needs)g(a)h(w)o
(ay)f(to)h(release)g(transfered)300 1394 y(pages)25 b(when)h(the)o(y)e
(are)i(no)g(longed)e(needed.)33 b(One)26 b(w)o(ay)f(to)g(do)g(this)g
(is)g(to)g(use)g(the)g(standard)g Fm(munmap)300 1544
y Fs(system)34 b(call)g(to)h(unmap)f(the)g(transfered)h(pages.)61
b(The)34 b(problem)g(with)g(this)g(is)g(that)g(not)g(only)g(does)300
1693 y Fm(munmap)24 b Fs(free)h(the)g(transfered)g(pages,)g(b)n(ut)f
(it)h(also)f(frees)i(the)e(amap)h(in)g(which)f(the)h(transfered)g
(pages)300 1843 y(li)n(v)o(e.)51 b(This)31 b(will)g(force)i(the)f(VM)g
(system)f(to)g(allocate)h(a)g(brand)g(ne)n(w)g(amap)g(if)g(it)g(w)o
(ants)f(to)h(transfer)300 1992 y(more)h(pages)g(to)g(the)g(same)g(area)
h(of)f(virtual)f(memory)-6 b(.)54 b(T)-8 b(o)33 b(address)g(this)f
(problem)h(the)g Fm(anflush)300 2141 y Fs(system)20 b(call)h(w)o(as)g
(added)g(to)f(UVM.)h(This)f(ne)n(w)h(system)f(call)h(remo)o(v)o(es)e
(anons)i(from)g(an)g(amap)g(without)300 2291 y(freeing)30
b(the)g(amap)g(itself.)45 b(The)30 b Fm(anflush)e Fs(system)h(call)g
(can)i(also)e(be)h(used)g(to)f(restore)h(an)g(area)h(of)300
2440 y(anon)o(ymous)23 b(memory)h(to)g(a)h(zero-\002ll)h(state.)300
2824 y Fg(7.3)143 b(Map)36 b(Entry)e(P)o(assing)300 3076
y Fs(Under)c(a)g(traditional)e(k)o(ernel,)i(processes)g(typically)e(e)o
(xchange)i(data)f(either)h(using)e(pipes)h(or)h(shared)300
3226 y(memory)-6 b(.)62 b(Internal)36 b(to)g(the)f(k)o(ernel,)k(pipes)c
(are)i(typically)d(implemented)g(as)i(a)g(connected)g(pair)g(of)300
3375 y(netw)o(ork)g(sock)o(ets.)65 b(When)37 b(the)f(sending)f(process)
i(writes)f(data)g(on)h(the)f(pipe)g(it)g(is)g(copied)g(by)g(the)300
3524 y(k)o(ernel)d(from)f(that)h(process')f(address)h(space)g(into)f(a)
h(k)o(ernel)g(b)n(uf)n(fer)g(\(mb)n(uf\).)54 b(The)33
b(mb)n(uf)f(is)g(placed)300 3674 y(on)26 b(a)g(queue)g(for)g(the)g
(recei)n(ving)f(process.)34 b(When)26 b(the)g(recei)n(ving)f(process)h
(reads)g(data)g(from)g(the)f(pipe)300 3823 y(the)j(data)h(is)f(copied)h
(from)f(the)g(mb)n(uf)g(out)g(to)h(the)f(recei)n(ving)g(process')h
(address)f(space.)42 b(Thus,)29 b(when)300 3973 y(sending)f(data)i(o)o
(v)o(er)e(a)i(pipe)f(the)g(data)h(is)e(copied)h(twice,)i(once)e(from)g
(the)h(sender)f(to)g(a)h(k)o(ernel)f(b)n(uf)n(fer)300
4122 y(and)c(once)g(from)f(the)h(k)o(ernel)g(b)n(uf)n(fer)g(to)f(the)h
(recei)n(v)o(er)-5 b(.)583 4271 y(In)37 b(a)g(traditional)e(k)o(ernel)i
(shared)f(memory)g(between)g(tw)o(o)g(processes)h(can)g(be)f
(established)300 4421 y(in)e(three)g(w)o(ays.)58 b(First,)37
b(most)c(k)o(ernels)g(support)g(the)h(System)g(V)g(shared)g(memory)g
(API.)g(This)g(API)300 4570 y(allo)n(ws)23 b(a)h(process)g(to)f(create)
i(a)f(shared)g(memory)f(se)o(gment)g(of)g(speci\002ed)i(size)f(and)f
(protection.)30 b(Once)300 4720 y(created,)37 b(other)e(processes)f
(with)g(the)g(appropriate)g(permissions)f(can)i(attach)f(the)g(shared)h
(memory)300 4869 y(se)o(gment)d(into)g(their)g(address)h(space.)55
b(Second,)36 b(an)o(y)c(number)g(of)h(processes)g(can)g
Fm(mmap)g Fs(a)g(normal)300 5018 y(\002le)e Fm(MAP)p
644 5018 30 4 v 35 w(SHARED)p Fs(.)f(Changes)h(made)g(to)f(the)h
(\002le')-5 b(s)31 b(memory)f(will)g(be)h(seen)g(by)f(all)h(processes)g
(that)300 5168 y(are)j(sharing)e(it.)56 b(Third,)34 b(a)g(process)f
(can)g(allocate)g(virtual)g(memory)f(with)g(an)i(inheritance)f(code)g
(of)p eop
%%Page: 150 170
150 169 bop 3751 100 a Fs(150)785 2080 y @beginspecial
0 @llx 0 @lly 451 @urx 331 @ury 3157 @rwi @setspecial
%%BeginDocument: ../figures/pass2.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-76.0 457.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 7648 m 0 0 l 8811 0 l 8811 7648 l cp clip
 0.06000 0.06000 sc
% Polyline
7.500 slw
n 2025 6150 m 2625 6150 l 2625 6450 l 2025 6450 l cp gs col7 0.50 shd ef gr gs col0 s gr 
% Polyline
n 7425 2925 m 8025 2925 l 8025 3975 l 7425 3975 l cp gs col7 0.50 shd ef gr gs col0 s gr 
% Polyline
n 2025 7050 m 2625 7050 l 2625 7425 l 2025 7425 l cp gs col7 0.50 shd ef gr gs col0 s gr 
% Polyline
n 2025 3600 m 2625 3600 l 2625 3750 l 2025 3750 l cp gs col7 0.50 shd ef gr gs col0 s gr 
% Polyline
n 7425 5625 m 8025 5625 l 8025 6225 l 7425 6225 l cp gs col7 0.50 shd ef gr gs col0 s gr 
% Polyline
n 7425 4650 m 8025 4650 l 8025 4800 l 7425 4800 l cp gs col7 0.50 shd ef gr gs col0 s gr 
% Polyline
n 7425 6825 m 8025 6825 l 8025 7425 l 7425 7425 l cp gs col7 0.50 shd ef gr gs col0 s gr 
% Polyline
n 2025 4575 m 2625 4575 l 2625 5400 l 2025 5400 l cp gs col7 0.50 shd ef gr gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
2325 2670 m
gs 1 -1 sc (address space) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
7725 2325 m
gs 1 -1 sc (target virtual) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
7725 2670 m
gs 1 -1 sc (address space) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
n 7425 3975 m 8025 3975 l 8025 4650 l 7425 4650 l cp gs col0 s gr 
% Polyline
n 7425 4800 m 8025 4800 l 8025 5100 l 7425 5100 l cp gs col0 s gr 
% Polyline
n 7425 5100 m 8025 5100 l 8025 5625 l 7425 5625 l cp gs col0 s gr 
% Polyline
30.000 slw
n 7425 2775 m 7425 7575 l gs col0 s gr 
% Polyline
n 8025 2775 m 8025 7575 l gs col0 s gr 
% Polyline
7.500 slw
n 7425 6225 m 8025 6225 l 8025 6825 l 7425 6825 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
3375 5025 m
gs 1 -1 sc (map entry passing) col0 sh gr
/Helvetica ff 300.00 scf sf
3375 5355 m
gs 1 -1 sc (\(copy, share, or donate\)) col0 sh gr
% Polyline
gs  clippath
3003 2895 m 3123 2925 l 3003 2955 l 3165 2955 l 3165 2895 l cp
clip
n 2700 2925 m 3150 2925 l gs col0 s gr gr

% arrowhead
n 3003 2895 m 3123 2925 l 3003 2955 l 3003 2925 l 3003 2895 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3003 4545 m 3123 4575 l 3003 4605 l 3165 4605 l 3165 4545 l cp
clip
n 2700 4575 m 3150 4575 l gs col0 s gr gr

% arrowhead
n 3003 4545 m 3123 4575 l 3003 4605 l 3003 4575 l 3003 4545 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 3225 2925 m 3375 2925 l 3375 4575 l 3225 4575 l gs col0 s gr 
% Polyline
 [15 45] 45 sd
gs  clippath
6544 4727 m 6649 4791 l 6526 4784 l 6680 4833 l 6698 4776 l cp
clip
n 3375 3750 m 6675 4800 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 6544 4727 m 6649 4791 l 6526 4784 l 6535 4755 l 6544 4727 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
7203 3945 m 7323 3975 l 7203 4005 l 7365 4005 l 7365 3945 l cp
clip
n 6900 3975 m 7350 3975 l gs col0 s gr gr

% arrowhead
n 7203 3945 m 7323 3975 l 7203 4005 l 7203 3975 l 7203 3945 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
n 6825 3975 m 6675 3975 l 6675 5625 l 6825 5625 l gs col0 s gr 
% Polyline
30.000 slw
n 2025 2775 m 2025 7575 l gs col0 s gr 
% Polyline
7.500 slw
gs  clippath
7203 5595 m 7323 5625 l 7203 5655 l 7365 5655 l 7365 5595 l cp
clip
n 6900 5625 m 7350 5625 l gs col0 s gr gr

% arrowhead
n 7203 5595 m 7323 5625 l 7203 5655 l 7203 5625 l 7203 5595 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
30.000 slw
n 2625 2775 m 2625 7575 l gs col0 s gr 
% Polyline
7.500 slw
n 2025 2925 m 2625 2925 l 2625 3600 l 2025 3600 l cp gs col0 s gr 
% Polyline
n 2025 3750 m 2625 3750 l 2625 4050 l 2025 4050 l cp gs col0 s gr 
% Polyline
n 2025 4050 m 2625 4050 l 2625 4575 l 2025 4575 l cp gs col0 s gr 
% Polyline
n 2025 5400 m 2625 5400 l 2625 6150 l 2025 6150 l cp gs col0 s gr 
% Polyline
n 2025 6450 m 2625 6450 l 2625 7050 l 2025 7050 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
2325 2325 m
gs 1 -1 sc (source virtual) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1498 2284 a(Figure)25 b(7.3:)30 b(Map)25
b(entry)f(passing)300 2679 y(\223share.)-7 b(\224)49
b(When)30 b(that)h(process)f(forks)g(a)h(child)f(process)h(it)f(will)f
(share)i(the)g(memory)f(with)f(the)i(child)300 2828 y(process.)583
2978 y(UVM)d(pro)o(vides)f(a)h(ne)n(w)g(w)o(ay)g(for)h(processes)f(to)g
(e)o(xchange)f(data:)38 b(map)27 b(entry)h(passing.)40
b(F)o(or)300 3127 y(lar)n(ge)g(data)f(sizes,)k(this)38
b(is)h(more)g(ef)n(\002cient)h(than)e(pipes)h(because)h(data)f(is)g(mo)
o(v)o(ed)f(without)g(being)300 3276 y(copied.)30 b(Map)23
b(entry)f(passing)g(is)h(also)g(more)g(\003e)o(xible)f(than)h
(traditional)f(shared)h(memory)-6 b(.)29 b(Map)22 b(entry)300
3426 y(passing)g(does)g(not)g(ha)n(v)o(e)g(System)g(V)h(shared)f
(memory')-5 b(s)21 b(requirement)h(that)h(a)f(process)h(pre-allocate)g
(a)300 3575 y(shared)f(memory)g(se)o(gment.)28 b(It)22
b(also)g(does)g(not)f(require)i(the)f(services)g(of)g(the)g
(\002lesystem)f(layer)l(,)i(unlik)o(e)300 3725 y Fm(mmap)p
Fs(.)50 b(Additionally)-6 b(,)31 b(map)g(entry)h(passing)e(allo)n(ws)h
(a)h(range)g(of)g(virtual)e(addresses)i(to)f(be)h(shared.)300
3874 y(This)21 b(range)h(can)g(include)f(multiple)f(memory)h(mappings)f
(and)i(unmapped)e(areas)j(of)f(virtual)f(memory)-6 b(.)300
4023 y(Map)25 b(entry)f(passing)g(is)g(sho)n(wn)g(in)g(Figure)h(7.3.)
300 4355 y Ff(7.3.1)119 b(Export)29 b(and)i(Import)e(of)g(V)l(irtual)i
(Memory)300 4571 y Fs(UVM')-5 b(s)22 b(map)g(entry)g(passing)g
(mechanism)f(allo)n(ws)g(another)i(alternati)n(v)o(e)e(for)i(processes)
f(to)g(e)o(xchange)300 4721 y(data.)59 b(W)l(ith)33 b(map)h(entry)g
(passing)f(a)h(process)g(sending)f(data)h(can)h(\223e)o(xport\224)f(a)g
(range)g(of)h(its)e(virtual)300 4870 y(address)g(space.)54
b(This)32 b(allo)n(ws)g(a)h(recei)n(ving)f(process)g(to)g
(\223import\224)g(that)h(memory)e(into)h(its)g(address)300
5019 y(space.)583 5169 y(T)-8 b(o)27 b(e)o(xport)f(a)i(block)e(of)h
(virtual)f(memory)-6 b(,)27 b(the)f(sending)g(process)h(must)f(create)i
(a)f(description)300 5318 y(of)21 b(the)g(block.)29 b(The)21
b Fm(mexpimp)p 1425 5318 30 4 v 35 w(info)f Fs(structure)h(describes)g
(a)h(block)e(of)h(virtual)g(memory)f(to)h(e)o(xport,)p
eop
%%Page: 151 171
151 170 bop 3751 100 a Fs(151)1418 1339 y @beginspecial
0 @llx 0 @lly 234 @urx 204 @ury 1638 @rwi @setspecial
%%BeginDocument: ../figures/mexpimp.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-96.0 254.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4273 m 0 0 l 5540 0 l 5540 4273 l cp clip
 0.06000 0.06000 sc
/Helvetica-Oblique ff 300.00 scf sf
3300 3000 m
gs 1 -1 sc (process ID) dup sw pop neg 0 rm  col0 sh gr
% Polyline
7.500 slw
n 3600 1950 m 5400 1950 l gs col0 s gr 
% Polyline
n 3600 2325 m 5400 2325 l gs col0 s gr 
% Polyline
n 3600 2700 m 5400 2700 l gs col0 s gr 
% Polyline
n 3600 3075 m 5400 3075 l gs col0 s gr 
% Polyline
n 3600 3450 m 5400 3450 l gs col0 s gr 
% Polyline
n 3600 3825 m 5400 3825 l gs col0 s gr 
% Polyline
30.000 slw
n 3600 1200 m 5400 1200 l 5400 4200 l 3600 4200 l cp gs col0 s gr 
/Helvetica ff 300.00 scf sf
4500 2250 m
gs 1 -1 sc (type) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1500 m
gs 1 -1 sc (base) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 1875 m
gs 1 -1 sc (len) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4500 1050 m
gs 1 -1 sc (mexpimp_info) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3000 m
gs 1 -1 sc (pid) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3375 m
gs 1 -1 sc (uid) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 3750 m
gs 1 -1 sc (gid) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 4125 m
gs 1 -1 sc (mode) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica ff 300.00 scf sf
4500 2625 m
gs 1 -1 sc (flags) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1500 m
gs 1 -1 sc (base address) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 1875 m
gs 1 -1 sc (length) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 2250 m
gs 1 -1 sc (export type) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 2625 m
gs 1 -1 sc (export flags) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 4125 m
gs 1 -1 sc (mode) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 3375 m
gs 1 -1 sc (user ID) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Oblique ff 300.00 scf sf
3300 3750 m
gs 1 -1 sc (group ID) dup sw pop neg 0 rm  col0 sh gr
% Polyline
7.500 slw
n 3600 1575 m 5400 1575 l gs col0 s gr 
$F2psEnd
rs
%%EndDocument
 @endspecial 1243 1543 a(Figure)25 b(7.4:)30 b(The)25
b Fm(mexpimp)p 2317 1543 30 4 v 34 w(info)f Fs(structure)300
1938 y(as)j(sho)n(wn)f(in)g(Figure)h(7.4.)37 b(The)27
b(base)g(and)g(len)g(\002elds)g(identify)f(the)g(block)h(of)g(virtual)f
(address)h(space)300 2087 y(that)22 b(is)g(e)o(xported.)30
b(Note)22 b(that)g(more)h(than)f(one)h(object)f(can)h(be)g(mapped)f(in)
g(this)g(space)h(and)f(it)g(also)h(can)300 2237 y(ha)n(v)o(e)c
(unmapped)g(gaps)f(in)h(it.)29 b(In)19 b(f)o(act,)i(it)e(can)g(e)n(v)o
(en)g(be)h(completely)e(unmapped.)28 b(The)19 b(e)o(xport)g(type)g(can)
300 2386 y(describes)30 b(ho)n(w)f(the)g(block)h(of)g(memory)f(is)g(e)o
(xported.)45 b(There)30 b(are)h(currently)f(four)f(possible)g(v)n
(alues)300 2536 y(for)e(this)e(\002eld)h(\(described)h(in)f(the)g(ne)o
(xt)f(paragraph\).)36 b(The)26 b(e)o(xport)g(\003ags)g(along)g(with)f
(the)h(process)h(id,)300 2685 y(user)d(id,)f(group)g(id,)g(and)h(mode)e
(are)j(used)e(to)g(control)g(access)h(to)f(the)g(e)o(xported)g(re)o
(gion)g(of)g(memory)-6 b(.)29 b(A)300 2834 y(process)c(has)h(the)f
(option)g(of)g(e)o(xporting)f(memory)h(to)g(a)h(speci\002c)g(process)g
(or)f(establishing)f(a)i(\002le-lik)o(e)300 2984 y(protection)e(code.)
31 b(The)25 b(e)o(xport)f(\003ags)h(control)f(which)g(access)i(control)
e(mechanism)f(is)i(used.)583 3133 y(The)g(four)g(e)o(xport)f(type)h(v)n
(alues)f(are)h(as)g(follo)n(ws:)300 3366 y Fo(shar)n(e:)50
b Fs(causes)25 b(the)f(importing)f(process)i(to)f(share)h(the)g(memory)
f(with)g(the)h(e)o(xporting)e(process.)300 3598 y Fo(copy:)49
b Fs(causes)36 b(the)g(importing)e(process)i(to)g(get)g(a)g(cop)o
(y-on-write)g(cop)o(y)g(of)g(the)g(e)o(xported)f(virtual)544
3747 y(memory)-6 b(.)300 3980 y Fo(donate:)50 b Fs(causes)37
b(the)h(memory)e(to)h(be)h(remo)o(v)o(ed)e(from)h(the)g(e)o(xporting)f
(process')i(virtual)e(address)544 4129 y(space)27 b(and)g(placed)g(in)f
(the)h(importing)e(process')i(space.)37 b(After)27 b(the)f(import)g
(the)h(virtual)f(space)544 4279 y(in)e(the)h(e)o(xporting)e(process)i
(will)f(be)h(unmapped.)300 4511 y Fo(donate)h(with)f(zer)n(o:)49
b Fs(the)28 b(same)f(as)g(\223donate,)-7 b(\224)29 b(e)o(xcept)e
(rather)h(than)f(lea)n(ving)f(the)i(e)o(xported)e(range)i(of)544
4660 y(virtual)c(space)h(unmapped)f(after)h(the)g(import)f(it)g(is)g
(reset)h(to)g(be)g(zero-\002ll)g(memory)-6 b(.)583 4893
y(On)23 b(a)h(successful)e(e)o(xport)h(of)g(memory)-6
b(,)22 b(a)h(\223tag\224)h(structure)e(is)h(created)h(for)f(the)g
(memory)-6 b(.)29 b(This)300 5042 y(structure)f(is)g(called)g
Fm(mexpimp)p 1464 5042 V 34 w(tag)g Fs(and)g(it)g(contains)f(a)i
(process)f(ID)h(and)f(timestamp.)39 b(T)-8 b(o)28 b(import)300
5192 y(virtual)22 b(memory)g(this)g(tag)h(must)e(be)i(passed)g(in)f(to)
h(the)g(import)e(system)h(call.)30 b(The)23 b(tag)f(is)h(used)f(to)h
(look)300 5341 y(up)i(the)f(e)o(xported)g(re)o(gion)g(of)h(memory)f
(and)h(import)e(it.)p eop
%%Page: 152 172
152 171 bop 3751 100 a Fs(152)583 249 y(UVM)27 b(pro)o(vides)f(tw)o(o)g
(system)g(calls)h(for)g(the)g(e)o(xport)f(and)h(import)e(operations.)37
b(Their)27 b(signa-)300 398 y(tures)e(are:)300 631 y
Fm(int)59 b(mexport\(struct)e(mexpimp_tag)g(*tag,)i(struct)f
(mexpimp_info)f(*i\))300 780 y(int)i(mimport\(struct)e(mexpimp_tag)g
(*tag,)i(struct)f(mexpimp_info)f(*i\))300 1013 y Fs(Both)32
b(system)e(calls)i(return)g(zero)g(on)g(success)g(and)f
Fr(\000)p Fa(1)i Fs(if)e(there)i(is)e(an)h(error)-5 b(.)52
b(F)o(or)32 b(the)g(e)o(xport)f(sys-)300 1162 y(tem)e(call,)h(the)f(e)o
(xporting)f(process)h(\002lls)f(out)h(a)h Fm(mexpimp)p
2402 1162 30 4 v 34 w(info)e Fs(structure)h(and)g(if)h(successful)e
(the)300 1311 y(k)o(ernel)e(will)f(\002ll)h(out)f(the)h(tag)f
(structure)h(with)f(the)h(tag)f(of)h(the)g(e)o(xported)f(re)o(gion)g
(of)h(memory)-6 b(.)32 b(F)o(or)26 b(the)300 1461 y(import)f(system)g
(call,)h(the)g(importing)e(process)i(\002lls)g(out)f(the)h(tag)g
(structure)g(and)g(calls)g(import.)33 b(If)26 b(the)300
1610 y Fm(mexpimp)p 726 1610 V 34 w(info)31 b Fs(pointer)g(is)g
(non-null,)g(then)g(the)g(info)g(used)h(to)f(e)o(xport)f(that)h(re)o
(gion)f(of)i(memory)300 1760 y(will)24 b(be)h(returned)g(in)f(the)h
(structure)f(pointed)g(to)g(by)h(this)f(pointer)-5 b(.)300
2091 y Ff(7.3.2)119 b(Implementation)29 b(of)h(Map)g(Entry)g(P)o
(assing)300 2307 y Fs(Map)g(entry)h(passing)f(is)g(implemented)f(on)i
(top)f(of)h(UVM')-5 b(s)30 b Fm(uvm)p 2646 2307 V 35
w(map)p 2861 2307 V 35 w(extract)f Fs(function.)48 b(The)300
2457 y(map)24 b(e)o(xtraction)f(function)g(e)o(xtracts)g(part)h(of)g
(the)g(virtual)f(memory)g(mapped)g(by)h(a)g(map)g(and)g(places)g(it)300
2606 y(in)e(another)g(map.)30 b(In)23 b(addition)e(to)h(being)g(used)g
(for)h(map)f(entry)g(passing,)g(the)h(e)o(xtract)f(function)f(is)i
(also)300 2756 y(used)e(by)h(the)g Fm(procfs)e Fs(process)i(\002le)g
(system)e(and)i(the)g Fm(ptrace)e Fs(system)h(call)h(\(used)f(for)h
(deb)n(ugging\))300 2905 y(to)i(allo)n(w)g(one)h(process)g(to)f(access)
h(another)g(process')g(virtual)f(address)h(space.)583
3054 y(The)32 b Fm(uvm)p 956 3054 V 35 w(map)p 1171 3054
V 36 w(extract)e Fs(function)h(is)g(called)g(with)g(a)h(source)g(map,)h
(source)f(virtual)f(ad-)300 3204 y(dress,)37 b(length,)f(destination)d
(map,)j(destination)d(address)h(pointer)l(,)j(and)d(a)h(set)f(of)h
(\003ags.)60 b(The)35 b(\003ags)300 3353 y(are:)300 3586
y Fo(r)n(emo)o(v)o(e:)49 b Fs(remo)o(v)o(e)24 b(the)h(mapping)e(from)i
(the)g(source)g(map)f(after)h(it)g(has)f(been)h(transfered.)300
3818 y Fo(zer)n(o:)50 b Fs(v)n(alid)27 b(only)g(if)h(\223remo)o(v)o
(e\224)f(is)h(set,)g(this)f(causes)h(the)g(remo)o(v)o(ed)f(area)i(to)e
(become)h(zero-\002ll)g(after)544 3967 y(the)d(e)o(xtract)f(operation.)
300 4200 y Fo(contig:)49 b Fs(abort)30 b(if)g(there)g(are)g(unmapped)f
(gaps)g(in)h(the)f(re)o(gion.)45 b(The)30 b(contig)f(\003ag)i(is)e(a)h
(\223best)g(ef)n(fort\224)544 4349 y(\003ag.)g(It)23
b(is)g(possible)e(for)i(the)g(e)o(xtract)g(to)f(succeed)i(e)n(v)o(en)e
(if)h(there)g(are)g(gaps)f(in)h(the)g(map)f(in)h(some)544
4499 y(cases.)300 4731 y Fo(qr)n(ef:)50 b Fs(\223quick\224)28
b(references.)41 b(The)28 b(qref)g(\003ag)h(is)e(used)h(for)g(brief)g
(map)g(e)o(xtractions)e(such)i(as)g(the)f(ones)544 4880
y(generated)f(by)f Fm(ptrace)p Fs(.)31 b(W)l(ith)25 b
Fm(ptrace)f Fs(the)h(follo)n(wing)f(pattern)h(is)g(used:)31
b(e)o(xtract)25 b(a)h(single)544 5030 y(page)33 b(from)g(a)g(process')g
(map,)h(read)f(or)g(write)g(a)g(w)o(ord)g(in)f(that)h(page,)i(unmap)d
(the)g(e)o(xtracted)544 5179 y(re)o(gion.)d(Under)24
b(normal)f(VM)g(operation)g(this)g(sort)g(of)g(operation)g(w)o(ould)g
(lead)h(to)f(a)h(lot)f(of)g(map)544 5329 y(entry)28 b(fragmentation)f
(because)i(of)f(the)g(clipping)f(used)h(to)g(e)o(xtract)g(the)g
(paged-sized)g(chunks.)p eop
%%Page: 153 173
153 172 bop 3751 100 a Fs(153)544 249 y(Quick)32 b(references)j(tak)o
(e)e(adv)n(antage)f(of)h(the)g(f)o(act)g(that)g(the)g(e)o(xtracted)f
(mapping)g(is)h(going)e(to)544 398 y(be)24 b(short)f(li)n(v)o(ed)f(to)h
(relax)h(the)f(management)g(of)h(references)h(to)e Fm(uvm)p
2933 398 30 4 v 36 w(object)f Fs(structures)h(and)544
548 y(amaps)h(and)h(a)n(v)n(oid)f(map)h(entry)f(fragmentation.)300
780 y Fo(\002xpr)n(ot:)50 b Fs(causes)31 b(the)f(protection)f(of)i(the)
f(e)o(xtracted)h(area)g(to)f(be)h(set)f(to)g(the)g(maximum)f
(protection.)544 930 y(This)34 b(is)g(necessary)g(for)h(the)f
Fm(ptrace)g Fs(call)g(because)h(it)f(needs)g(to)g(write)h(break)g
(points)e(to)h(a)544 1079 y(process')21 b(te)o(xt)f(area.)31
b(The)21 b(te)o(xt)f(area)j(is)d(normally)g(mapped)h(cop)o(y-on-write)g
(with)f(is)h(protection)544 1228 y(set)26 b(to)g(read-only)g(and)g(its)
f(maximum)f(protection)i(set)f(to)h(read-write.)35 b(In)27
b(order)f(for)g Fm(ptrace)544 1378 y Fs(to)35 b(be)h(able)g(to)g(write)
g(to)f(this)g(memory)-6 b(,)37 b(the)f(protection)f(must)g(be)h(raised)
g(from)g(its)f(current)544 1527 y(read-only)24 b(v)n(alue)g(to)g(its)f
(maximum)g(v)n(alue.)29 b(Note)c(that)e(this)h(does)g(not)f(ef)n(fect)i
(the)f(source)h(map,)544 1677 y(only)f(the)h(destination)e(map.)583
1909 y(The)i Fm(uvm)p 949 1909 V 35 w(map)p 1164 1909
V 36 w(extract)e Fs(operates)i(as)g(follo)n(ws:)445 2141
y Fr(\017)49 b Fs(A)30 b(sanity)f(check)h(of)g Fm(uvm)p
1475 2141 V 35 w(map)p 1690 2141 V 35 w(extract)p Fs(')-5
b(s)28 b(ar)n(guments)h(is)g(performed.)46 b(The)30 b(starting)f(ad-)
544 2291 y(dress)23 b(must)g(be)h(on)f(a)h(page)g(boundary)f(and)h(the)
f(length)g(must)f(be)i(a)g(multiple)e(of)i(the)f(page)h(size.)544
2440 y(Also,)d(the)f(\223remo)o(v)o(e\224)g(\003ag)h(is)g(mutually)e(e)
o(xclusi)n(v)o(e)f(with)i(both)g(the)h(\223contig\224)f(and)h(\223qref)
5 b(\224)22 b(\003ags.)445 2673 y Fr(\017)49 b Fs(V)-6
b(irtual)23 b(space)h(is)g(reserv)o(ed)f(in)h(the)f(destination)g(map)g
(for)h(the)g(e)o(xtracted)f(memory)g(\(done)h(with)544
2822 y(the)h Fm(uvm)p 877 2822 V 35 w(map)p 1092 2822
V 35 w(reserve)e Fs(function\).)445 3054 y Fr(\017)49
b Fs(The)28 b(source)g(map')-5 b(s)26 b(map)i(entry)f(list)g(is)g
(searched)i(for)f(the)f(\002rst)h(map)g(entry)f(that)g(contains)g(the)
544 3204 y(starting)d(virtual)g(address.)30 b(Then)25
b(a)g(loop)f(o)o(v)o(er)g(the)h(source)g(map')-5 b(s)24
b(virtual)g(space)h(is)f(entered.)445 3436 y Fr(\017)49
b Fs(Each)32 b(source)h(map)f(entry)g(in)g(the)g(virtual)f(range)i(is)e
(copied)h(into)g(a)g(list)f(of)i(map)f(entries)g(that)544
3586 y(will)24 b(be)g(inserted)h(in)f(the)g(destination)f(map)h(\(if)h
(the)g(remo)o(v)o(e)e(\003ag)i(is)g(set,)f(then)g(the)h(source)f(map)
544 3735 y(entry)h(is)f(remo)o(v)o(ed)f(from)i(the)g(source)g(map\).)
445 3967 y Fr(\017)49 b Fs(When)25 b(the)g(end)h(of)f(the)g(virtual)g
(range)g(is)g(reached,)h(the)g(ne)n(w)e(map)h(entries)g(are)i(inserted)
d(in)h(the)544 4117 y(destination)e(map.)300 4349 y(The)30
b(actual)f Fm(uvm)p 938 4349 V 36 w(map)p 1154 4349 V
35 w(extract)f Fs(function)h(is)g(a)h(bit)f(more)h(comple)o(x)e(than)i
(this)e(due)i(to)f(the)h(need)300 4499 y(to)24 b(handle)h(quick)f
(references)i(and)f(data)g(structure)g(locking)e(properly)-6
b(.)300 4830 y Ff(7.3.3)119 b(Usage)29 b(of)g(Map)h(Entry)g(P)o(assing)
300 5046 y Fs(Map)i(entry)h(passing)e(can)i(be)f(used)h(to)f(mo)o(v)o
(e)f(lar)n(ge)i(chunks)f(of)g(data)h(between)f(processes)h(without)300
5196 y(the)24 b(o)o(v)o(erhead)f(of)i(data)f(cop)o(ying.)29
b(F)o(or)24 b(lar)n(ge)h(data)f(map)g(entry)g(passing)f(is)h(more)g(ef)
n(\002cient)g(than)g(pipes)300 5345 y(because)h(the)g(data)g(is)f(not)g
(copied,)h(instead)f(it)g(is)h(mo)o(v)o(ed)e(using)g(the)i(virtual)f
(memory)g(system.)p eop
%%Page: 154 174
154 173 bop 3751 100 a Fs(154)583 249 y(Map)26 b(entry)f(passing)g(is)g
(also)h(more)f(\003e)o(xible)g(than)h(memory)e(shared)i(with)f(System)g
(V)h(shared)300 398 y(memory)-6 b(.)41 b(W)l(ith)27 b(System)h(V)h
(shared)g(memory)-6 b(,)28 b(the)g(shared)h(memory)e(re)o(gion)h(must)g
(be)g(allocated)g(in)300 548 y(adv)n(ance)e(and)h(all)f(shared)g(data)h
(must)e(be)i(placed)f(in)g(it.)35 b(Also,)26 b(the)g(shared)h(memory)e
(re)o(gion)h(must)f(be)300 697 y(a)34 b(contiguous)d(chunk)i(of)g(anon)
o(ymous)f(memory)-6 b(.)54 b(On)33 b(the)g(other)h(hand)f(memory)f
(shared)h(via)g(map)300 847 y(entry)38 b(passing)g(can)g(span)h
(multiple)d(mappings,)41 b(include)c(unmapped)h(re)o(gions,)j(and)d
(can)h(contain)300 996 y(\002le)34 b(mappings)e(as)h(well)g(as)h(anon)o
(ymous)d(memory)-6 b(.)56 b(An)o(y)32 b(re)o(gion)h(of)g(a)h(process')g
(memory)e(can)i(be)300 1145 y(e)o(xported)24 b(on)h(the)f(\003y)-6
b(,)25 b(there)g(is)f(no)h(need)g(to)f(pre-allocate)h(a)g(re)o(gion)f
(of)h(memory)-6 b(.)583 1295 y(Map)41 b(entry)f(passing)g(can)g(be)h
(more)f(ef)n(\002cient)h(and)f(\003e)o(xible)g(than)h(memory)e(shared)i
(with)300 1444 y Fm(mmap)p Fs(.)74 b(Re)o(gions)38 b(of)i(memory)e
(shared)i(with)e Fm(mmap)h Fs(require)h(interactions)e(with)h(the)g
(\002lesystem)300 1594 y(layer)l(,)24 b(and)f(this)f(can)h(slo)n(w)f
(things)g(do)n(wn.)29 b(This)22 b(cost)h(can)g(be)g(mitigated)e(some)i
(by)f(placing)h(the)g(mem-)300 1743 y(ory)i(mapped)g(\002le)h(on)f(a)h
(RAM)g(disk.)31 b(It)26 b(should)e(be)i(noted)f(that)g(using)f
Fm(mmap)h Fs(for)g(shared)h(memory)f(is)300 1892 y(still)c(quite)g
(useful.)30 b(Systems)21 b(lik)o(e)h(M-NFS)g([43])h(allo)n(w)e(memory)g
(mapped)h(\002les)g(to)g(be)g(shared)g(across)300 2042
y(a)h(netw)o(ork.)30 b(Map)23 b(entry)f(passing)g(cannot)h(be)g(used)f
(to)h(do)g(this)f(\(since)h(it)f(is)g(not)h(possible)e(to)i(pass)f(map)
300 2191 y(entries)j(between)f(machines)h(on)f(a)h(netw)o(ork\).)583
2341 y(UVM')-5 b(s)27 b(map)g(entry)g(passing)g(also)g(allo)n(ws)f(a)i
(process)f(to)g(grant)h(another)f(unrelated)g(process)300
2490 y(access)34 b(to)g(only)e(part)i(of)g(a)g(\002le.)58
b(In)34 b(traditional)e(Unix,)j(if)f(a)g(\002le)g(descriptor)f(is)h
(passed)f(to)g(another)300 2639 y(process)g(using)f(\002le)i
(descriptor)e(passing,)j(then)d(the)h(recei)n(ving)g(process)g(gets)g
(access)g(to)g(the)g(entire)300 2789 y(\002le)27 b(at)g(what)g(e)n(v)o
(er)g(permission)e(the)i(\002le)h(descriptor)e(allo)n(ws.)36
b(The)27 b(only)f(w)o(ay)i(to)e(pass)h(partial)g(access)300
2938 y(of)i(a)h(\002le)g(to)f(another)g(process)g(is)g(to)g(open)g(the)
g(\002le,)h Fm(mmap)f Fs(in)g(the)g(part)g(of)h(the)f(\002le)g(to)g(be)
h(accessed,)300 3088 y(close)f(the)f(\002le,)i(and)f(then)f(fork)h(a)g
(child)f(process)h(that)f(only)g(has)g(access)i(to)e(the)g(part)h(of)g
(the)f(\002le)i(that)300 3237 y(w)o(as)25 b(memory)f(mapped.)583
3386 y(Using)e(UVM')-5 b(s)22 b(map)g(entry)h(passing,)e(an)o(y)i
(process)f(can)h(memory)f(map)g(a)h(\002le)g(and)g(then)f(of)n(fer)300
3536 y(to)g(send)f(that)h(mapping)e(to)i(other)g(processes.)29
b(T)-8 b(o)22 b(do)g(this,)f(the)h(serv)o(er)g(process)g(need)g(only)f
(map)h(in)f(the)300 3685 y(part)28 b(of)g(the)f(\002le)i(that)e(it)g(w)
o(ants)h(to)f(share)h(and)g(then)g(e)o(xport)f(that)g(mapping)g(to)g
(the)h(process)g(that)f(is)g(to)300 3835 y(recei)n(v)o(e)g(partial)h
(\002le)g(access.)39 b(The)28 b(recei)n(ving)f(process)h(can)g(then)f
(import)f(the)i(mapping)e(of)i(that)f(part)300 3984 y(of)k(the)h
(\002le.)50 b(The)32 b(recei)n(ving)f(process)g(will)f(only)h(ha)n(v)o
(e)g(access)h(to)f(part)g(of)h(the)f(\002le)h(that)f(is)g(mapped)300
4133 y(by)e(the)f(e)o(xported)h(pages.)43 b(P)o(arts)29
b(of)g(the)f(\002le)i(outside)e(of)h(that)f(range)h(will)g(be)g
(inaccessible)f(and)h(will)300 4283 y(remain)35 b(so)f(as)h(there)g(is)
f(no)h(w)o(ay)g(for)g(a)g(process)g(to)f(change)h(the)g(size)g(of)g(a)g
(\002le')-5 b(s)34 b(mapping.)60 b(This)300 4432 y(could)24
b(be)g(useful)f(in)h(allo)n(wing)e(processes)i(access)h(to)f(only)f(a)h
(page-sized)h(section)e(of)h(a)h(database,)f(for)300
4581 y(e)o(xample.)583 4731 y(Note)30 b(that)g(with)f(some)h(more)g(k)o
(ernel)g(structure,)h(it)e(w)o(ould)h(be)g(possible)f(to)g(transfer)i
(virtual)300 4880 y(address)25 b(space)g(between)g(processes)g(using)f
(map)h(entry)f(passing)g(without)g(the)h(need)g(for)g(tags.)31
b(T)-8 b(o)24 b(do)300 5030 y(this,)d(the)h Fm(uvm)p
821 5030 30 4 v 35 w(map)p 1036 5030 V 35 w(extract)f
Fs(function)g(could)g(be)h(modi\002ed)f(to)h(return)g(a)g(list)f(of)h
(map)f(entries)h(that)300 5179 y(can)29 b(be)f(queued)g(for)h(a)g(tar)n
(get)f(process.)41 b(Then)29 b(when)f(the)g(tar)n(get)g(process)h(w)o
(as)f(ready)h(it)f(could)f(ha)n(v)o(e)300 5328 y(this)d(list)g(of)h
(map)f(entries)g(inserted)h(in)f(its)g(map.)p eop
%%Page: 155 175
155 174 bop 3751 100 a Fs(155)300 249 y Fg(7.4)143 b(Summary)300
502 y Fs(In)25 b(this)e(chapter)i(UVM')-5 b(s)23 b(ne)n(w)h(data)h(mo)o
(v)o(ement)d(features)j(were)g(presented.)31 b(These)24
b(features)h(e)o(xtend)300 651 y(the)30 b(services)g(of)n(fered)g(by)g
(the)g(VM)f(well)h(be)o(yond)f(what)h(is)f(supported)g(in)h(BSD)h(VM.)e
(The)o(y)h(can)g(be)300 800 y(used)21 b(to)h(b)n(uild)e(adv)n(anced)h
(I/O)h(and)g(IPC)g(subsystems)e(such)h(as)h(the)f(ones)h(presented)f
(in)g(Section)h(3.4.2.)300 950 y(P)o(age)j(loanout)f(pro)o(vides)g(a)i
(w)o(ay)f(for)g(a)g(process)g(to)g(loan)g(its)f(memory)g(out)h(to)f
(other)h(processes)g(or)g(the)300 1099 y(k)o(ernel.)33
b(P)o(age)25 b(transfer)h(pro)o(vides)f(a)g(w)o(ay)h(for)g(a)f(process)
h(to)f(import)f(memory)h(from)g(other)g(processes)300
1249 y(or)35 b(the)f(k)o(ernel)h(into)f(its)g(address)g(space.)61
b(Both)34 b(page)h(loanout)f(and)g(page)h(transfer)g(pro)o(vide)f
(page-)300 1398 y(le)n(v)o(el)c(granularity)h(and)g(can)h(be)g(used)f
(alone)g(or)h(together)-5 b(.)49 b(Map)31 b(entry)h(passing)e(allo)n
(ws)g(chunks)h(of)300 1547 y(virtual)f(address)h(space)g(to)g(be)g
(transfered)g(between)g(processes)g(\(or)g(the)g(k)o(ernel\))g(by)f
(using)g(UVM')-5 b(s)300 1697 y(map)24 b(e)o(xtraction)g(function.)p
eop
%%Page: 156 176
156 175 bop 3751 100 a Fs(156)300 973 y Fp(Chapter)51
b(8)300 1448 y(Secondary)g(Design)i(Elements)300 1930
y Fs(This)19 b(chapter)h(describes)f(a)h(number)f(of)g(the)h(secondary)
f(design)g(elements)g(of)g(UVM.)g(These)h(elements)300
2079 y(are)28 b(small)e(parts)h(of)g(the)g(UVM)g(design)f(that)h(dif)n
(fer)g(from)g(BSD)h(VM)f(and)g(contrib)n(ute)g(to)f(the)h(o)o(v)o
(erall)300 2229 y(function)d(of)h(UVM.)f(T)-8 b(opics)24
b(co)o(v)o(ered)g(in)g(this)g(chapter)h(include)f(amap)h(chunking,)e
(clustered)i(anon)o(y-)300 2378 y(mous)c(pageout,)h(the)g(design)f(of)i
(UVM')-5 b(s)21 b(three)h(pagers,)h(memory)e(mapping)g(issues,)g(page)i
(\003ags,)g(VM)300 2527 y(startup,)h(and)h(pmap)f(issues.)300
2907 y Fg(8.1)143 b(Amap)34 b(Chunking)300 3159 y Fs(As)e(e)o(xplained)
f(in)g(Chapter)i(2,)g(e)n(v)o(ery)e(process)h(running)f(on)h(the)g
(system)e(has)i(a)g(stack)g(area.)53 b(In)32 b(the)300
3308 y(BSD)f(k)o(ernel,)f(the)g(size)g(of)f(the)h(stack)f(area)i(is)e
(determined)g(by)h(a)g(process')f(resource)i(limits.)43
b(These)300 3458 y(limits)20 b(are)i(are)h(read)f(and)g(set)f(with)g
(the)g Fm(getrlimit)f Fs(and)i Fm(setrlimit)e Fs(system)g(calls.)30
b(Resources)300 3607 y(controlled)25 b(by)h(limits)f(include)g(CPU)j
(time,)d(\002le)i(size,)g(coredump)e(size,)i(and)f(stack)g(size.)35
b(Each)27 b(limit)300 3757 y(has)34 b(tw)o(o)g(v)n(alues:)48
b(the)34 b(current)g(\223soft\224)g(limit)e(and)i(the)g(\223hard\224)h
(limit.)57 b(A)34 b(process)g(can)g(change)g(the)300
3906 y(v)n(alue)21 b(of)h(the)g(soft)g(limit)e(to)i(an)o(y)f(v)n(alue)g
(that)h(does)f(not)h(e)o(xceed)g(the)g(hard)g(limit.)28
b(F)o(or)22 b(the)g(stack,)g(typical)300 4055 y(v)n(alues)e(for)i(the)f
(soft)g(and)g(hard)g(limits)f(are)i(tw)o(o)e(and)i(thirty-tw)o(o)d(me)o
(gabytes,)h(respecti)n(v)o(ely)-6 b(.)28 b(The)21 b(BSD)300
4205 y(k)o(ernel)28 b(reserv)o(es)h(space)f(in)g(each)h(process')g(map)
f(for)g(the)g(lar)n(gest)h(possible)e(stack)h(\(i.e.)41
b(for)29 b(the)f(hard)300 4354 y(limit\).)g(This)22 b(requires)g(tw)o
(o)g(map)g(entries.)29 b(One)22 b(to)g(map)g(the)g(current)g(stack)g
(zero-\002ll)h(read-write,)g(and)300 4504 y(one)i(to)f(map)g(the)h
(space)g(from)f(the)h(end)f(of)h(the)g(current)g(stack)f(to)g(the)h
(hard)g(limit)e(zero-\002ll)i(no-access.)583 4653 y(F)o(or)34
b(a)f(typical)g(stack)g(each)h(process)f(starts)g(with)f(a)i(tw)o(o)f
(me)o(gabyte)f(read-write)h(re)o(gion)g(for)300 4802
y(the)g(current)h(stack)f(and)g(a)h(thirty)e(me)o(gabyte)g(re)o(gion)g
(that)h(is)g(not)g(accessible.)56 b(Note)33 b(that)g(for)g(most)300
4952 y(normal)i(processes)g(only)g(a)g(small)g(part)g(of)g(the)h
(current)f(stack)h(gets)e(used.)63 b(Under)35 b(the)g(BSD)i(VM)300
5101 y(system,)31 b(this)f(results)f(in)i(a)g(single)e(anon)o(ymous)g
(tw)o(o)h(me)o(gabyte)f Fm(vm)p 2761 5101 30 4 v 36 w(object)g
Fs(being)h(allocated)g(to)300 5251 y(back)c(the)g(current)g(stack.)33
b(While)25 b(this)g(object)g(is)h(lar)n(ge,)g(it)f(is)h(not)f(a)h
(problem)f(for)h(BSD)g(VM)g(because)300 5400 y(the)j(size)h(of)g(a)g
Fm(vm)p 949 5400 V 35 w(object)e Fs(is)h(constant)g(no)h(matter)f(ho)n
(w)f(lar)n(ge)j(it)e(is.)44 b(On)30 b(an)f(i386,)h(for)g(e)o(xample,)p
eop
%%Page: 157 177
157 176 bop 3751 100 a Fs(157)300 249 y(a)27 b Fm(vm)p
497 249 30 4 v 35 w(object)e Fs(is)h(al)o(w)o(ays)g(76)h(bytes.)34
b(Ho)n(we)n(v)o(er)l(,)26 b(if)g(left)g(uncheck)o(ed,)h(this)f(is)g(a)g
(problem)g(for)h(UVM)300 398 y(because)35 b(the)f(amount)f(of)h(k)o
(ernel)h(memory)e(allocated)h(for)h(an)f(amap)h(gro)n(ws)e(with)g(the)i
(size)f(of)g(the)300 548 y(amap.)44 b(This)28 b(is)h(due)g(to)g(the)g
(amap)g(containing)f(three)h(arrays)h(whose)f(length)f(is)h(determined)
f(by)h(the)300 697 y(number)e(of)i(pages)f(the)f(amap)h(maps.)40
b(On)28 b(a)g(system)f(with)g(a)i(4K)f(page)g(size)g(a)g(tw)o(o)g(me)o
(gabyte)e(amap)300 847 y(consumes)h(a)i(little)e(o)o(v)o(er)g(six)h
(thousand)f(bytes)h(of)g(k)o(ernel)g(memory)2699 810
y Fj(1)2736 847 y Fs(.)41 b(Allocations)26 b(of)j(that)e(size)i(can)300
996 y(quickly)24 b(\002ll)g(up)h(the)g(k)o(ernel')-5
b(s)24 b(virtual)g(memory)g(space)h(reserv)o(ed)g(for)g(its)f(memory)g
(allocator)-5 b(.)583 1145 y(T)d(o)38 b(address)f(this)g(problem,)j
(UVM)d(w)o(as)g(modi\002ed)g(to)g(break)h(up)g(v)o(ery)f(lar)n(ge)h
(amaps)f(into)300 1295 y(smaller)e(amaps)g(when)g(possible.)61
b(This)35 b(is)g(called)g(amap)h(\223chunking.)-7 b(\224)61
b(Currently)36 b(UVM)f(uses)g(a)300 1444 y(chunk)21 b(size)g(of)h
(64KB.)f(Allocating)f(an)i(amap)f(that)g(maps)f(64KB)i(requires)f
(about)g(tw)o(o)g(hundred)g(bytes)300 1594 y(of)31 b(k)o(ernel)g
(memory)-6 b(.)48 b(The)31 b Fm(amap)p 1525 1594 V 35
w(copy)f Fs(function)g(tak)o(es)h(a)g(boolean)g(parameter)g(that)g
(indicates)f(if)300 1743 y(chunking)24 b(is)g(allo)n(wed)g(or)h(not.)
583 1892 y(As)j(an)f(e)o(xample)g(of)g(the)g(bene\002ts)h(of)f(amap)g
(chunking,)g(consider)g(a)h(ne)n(wly)e(created)i(process)300
2042 y(that)k(has)g(not)g(accessed)h(its)e(stack)h(yet.)53
b(Its)32 b(stack)h(re)o(gion)e(will)g(be)i(mapped)f(by)g(tw)o(o)g
(zero-\002ll)g(map)300 2191 y(entries)d(both)g(with)f(needs-cop)o(y)h
(set.)44 b(The)30 b(\002rst)f(map)g(entry)g(reserv)o(es)h(thirty)e(me)o
(gabytes)f(of)j(virtual)300 2341 y(memory)f(in)h(case)h(the)g(stack')-5
b(s)29 b(resource)i(limits)d(are)k(changed.)47 b(The)30
b(second)g(map)g(entry)h(maps)e(the)300 2490 y(current)35
b(tw)o(o-me)o(gabyte)d(stack.)60 b(When)34 b(the)h(process)f(\002rst)h
(accesses)g(its)f(stack,)i(a)f(page)g(f)o(ault)f(will)300
2639 y(be)e(generated.)54 b(W)l(ithout)31 b(amap)h(chunking,)h(the)f
Fm(uvm)p 2265 2639 V 35 w(fault)g Fs(routine)f(will)h(look)f(up)h(the)g
(second)300 2789 y(map)23 b(entry)g(and)g(call)g Fm(amap)p
1303 2789 V 35 w(copy)f Fs(to)h(clear)h(needs-cop)o(y)-6
b(.)29 b(This)23 b(will)f(cause)h(a)h(tw)o(o)f(me)o(gabyte)e(amap)300
2938 y(to)32 b(be)h(allocated)f(for)h(the)f(second)g(map)g(entry)h(and)
f(consume)g(o)o(v)o(er)f(six)h(thousand)g(bytes)f(of)i(k)o(ernel)300
3088 y(memory)-6 b(.)29 b(But)24 b(with)g(amap)g(chunking)f(enabled,)h
Fm(uvm)p 2231 3088 V 35 w(fault)f Fs(calls)h Fm(amap)p
3036 3088 V 35 w(copy)f Fs(with)g(chunking)300 3237 y(allo)n(wed.)44
b(As)29 b(a)h(result,)g Fm(amap)p 1420 3237 V 35 w(copy)f
Fs(breaks)h(the)f(second)g(map)g(entry)h(up)f(into)g(tw)o(o)g(chunks.)
44 b(The)300 3386 y(\002rst)30 b(chunk)f(will)g(map)h(1984KB)f(of)h
(zero-\002ll)h(stack)e(memory)g(with)g(needs-cop)o(y)h(set.)45
b(The)30 b(second)300 3536 y(chunk)35 b(will)f(map)h(the)g(f)o(aulting)
f(address)h(and)g(be)h(attached)f(to)g(a)g(freshly)g(allocated)g(64KB)g
(amap.)300 3685 y(By)i(chunking)f(the)h(amap)g(allocation,)i(UVM)e
(typically)f(sa)n(v)o(es)g(a)i(little)e(less)g(than)h(6000)g(bytes)f
(of)300 3835 y(allocated)23 b(k)o(ernel)g(memory)g(per)g(process.)30
b(UVM)23 b(still)f(uses)h(more)g(memory)f(than)h(BSD)h(VM)f(for)g(this)
300 3984 y(procedure)28 b(because)g(of)g(its)e(use)i(of)f(amaps.)39
b(Ho)n(we)n(v)o(er)l(,)27 b(amaps)g(pro)o(vide)g(per)n(-page)h
(granularity)f(that)300 4133 y(is)21 b(useful)g(for)h(page)g(loanout)e
(and)i(page)g(transfer)g(and)f(help)h(eliminate)e(the)h(object)h
(collapse)f(and)g(sw)o(ap)300 4283 y(memory)j(leak)h(problems)f(found)g
(in)g(BSD)i(VM.)300 4666 y Fg(8.2)143 b(Cluster)m(ed)34
b(Anonymous)f(Memory)i(P)o(ageout)300 4919 y Fs(When)40
b(BSD)g(is)f(running)g(lo)n(w)g(on)g(free)i(memory)-6
b(,)41 b(the)f(pagedaemon)f(process)h(is)f(in)l(v)n(ok)o(ed.)74
b(The)300 5068 y(pagedaemon')-5 b(s)31 b(job)f(is)h(to)h(scan)f(the)g
(page)h(queues)f(in)g(search)h(of)g(resident)f(pages)g(of)h(memory)f
(that)p 300 5158 1440 4 v 416 5219 a Fi(1)449 5249 y
Fh(A)d(tw)o(o)f(me)o(gabyte)d(re)o(gion)h(contains)i(512)e(pages.)45
b(Assuming)26 b(a)h(32)f(bit)h(machine,)h(the)e(size)i(of)e(each)h
(entry)f(in)h(an)300 5349 y(array)19 b(is)i(four)e(bytes.)25
b(Thus)20 b(three)g(512)f(entry)g(arrays)h(w)o(ould)f(tak)o(e)i(6144)d
(bytes.)p eop
%%Page: 158 178
158 177 bop 3751 100 a Fs(158)300 249 y(ha)n(v)o(e)39
b(not)g(been)g(used)g(recently)-6 b(.)74 b(When)39 b(such)g(a)g(page)h
(is)f(found)g(the)g(pagedaemon)g(attempts)e(to)300 398
y(pageout)27 b(the)h(page)f(to)g(backing)h(store.)38
b(After)28 b(a)g(page)g(is)f(successfully)g(paged)g(out)g(it)g(can)h
(be)g(reused)300 548 y(as)c(its)f(data)h(is)f(safely)h(non-resident)f
(in)g(backing)h(store.)30 b(P)o(ages)24 b(that)f(contain)g(\002le)h
(data)g(are)h(paged)f(out)300 697 y(to)k(their)g(backing)g(\002le,)i
(while)e(anon)o(ymous)e(memory)i(pages)g(are)i(paged)e(out)g(to)g(the)g
(system')-5 b(s)27 b(sw)o(ap)300 847 y(area.)583 996
y(There)i(are)g(tw)o(o)f(types)g(of)g(pages)h(that)f(the)g(pagedaemon)g
(can)h(encounter:)37 b(clean)29 b(pages)f(and)300 1145
y(dirty)d(pages.)34 b(Clean)27 b(pages)f(are)g(pages)g(that)g(ha)n(v)o
(e)g(ne)n(v)o(er)f(been)h(modi\002ed)f(since)h(being)g(loaded)f(from)
300 1295 y(backing)35 b(store.)63 b(As)35 b(the)h(data)f(in)g(a)h
(clean)g(page)g(is)f(identical)g(to)g(the)g(data)h(currently)f(on)h
(backing)300 1444 y(store,)30 b(to)f(pageout)f(a)i(clean)f(page)h(all)f
(the)g(pagedaemon)f(has)i(to)e(do)h(is)g(free)h(it.)43
b(On)29 b(the)g(other)g(hand,)300 1594 y(dirty)f(pages)g(are)h(pages)f
(that)g(ha)n(v)o(e)g(been)h(modi\002ed)f(since)g(the)o(y)f(were)i
(loaded)f(from)h(backing)e(store.)300 1743 y(T)-8 b(o)37
b(pageout)g(a)h(dirty)f(page,)k(the)c(pagedaemon)g(must)g(\002rst)g
(clean)h(the)g(page)f(by)h(in)l(v)n(oking)e(an)h(I/O)300
1892 y(operation)f(to)g(write)h(the)f(page')-5 b(s)36
b(data)h(to)f(backing)g(store.)66 b(Then)36 b(the)h(pagedaemon)f(can)h
(free)g(the)300 2042 y(page.)583 2191 y(When)25 b(writing)e(data)i(out)
f(to)g(backing)g(store,)g(it)g(is)g(more)g(ef)n(\002cient)g(for)h(the)f
(k)o(ernel)h(to)f(transfer)300 2341 y(multiple)35 b(contiguous)g(pages)
h(at)h(the)f(same)h(time)e(because)i(it)f(in)l(v)n(olv)o(es)f(less)h(o)
o(v)o(erhead)g(\(e.g.)66 b(I/O)300 2490 y(setup)37 b(and)h
(interrupts\).)70 b(P)o(aging)37 b(out)g(multiple)g(contiguous)f(pages)
i(at)g(the)g(same)f(time)h(is)f(called)300 2639 y(clustered)f(pageout.)
64 b(F)o(or)36 b(e)o(xample)f(consider)h(a)g(system)f(with)g(a)i(4096)e
(byte)h(page)g(size)g(\(4096)g(is)300 2789 y(0x1000)20
b(in)h(he)o(xadecimal\).)29 b(Assume)21 b(that)g(there)h(is)f(a)g
(\002le)h(that)f(has)h(three)f(dirty)g(pages)g(at)h(byte)f(of)n(fsets)
300 2938 y(0x4000,)26 b(0x5000,)g(and)g(0x6000.)35 b(Suppose)26
b(memory)g(is)g(scarce)h(and)g(the)f(pagedaemon)g(is)g(running.)300
3088 y(W)l(ithout)e(clustered)h(pageout,)g(each)h(of)g(these)f(pages)h
(will)e(be)i(indi)n(vidually)c(paged)k(out)f(in)g(their)g(o)n(wn)300
3237 y(I/O)38 b(transaction.)70 b(Ho)n(we)n(v)o(er)l(,)40
b(if)e(clustered)f(pageout)h(is)g(a)n(v)n(ailable)f(then)h(when)g(the)f
(pagedaemon)300 3386 y(encounters)d(the)f(page)h(at)g(of)n(fset)g
(0x5000)e(it)i(will)f(not)g(immediately)f(page)i(it)g(out.)57
b(Instead)34 b(it)f(will)300 3536 y(search)c(for)f(dirty)g(pages)g
(preceding)g(and)g(follo)n(wing)f(the)h(page)g(at)g(of)n(fset)g
(0x5000.)40 b(This)27 b(will)h(cause)300 3685 y(it)33
b(to)f(\002nd)i(the)f(pages)g(at)g(0x4000)f(and)h(0x6000.)55
b(The)33 b(pagedaemon)g(will)f(then)h(cluster)g(these)g(tw)o(o)300
3835 y(pages)28 b(with)g(the)g(original)f(page)i(at)f(0x5000)f(to)h
(form)g(a)h(three)f(page)h(cluster)-5 b(.)40 b(Thus,)29
b(all)f(three)g(pages)300 3984 y(will)f(be)h(cleaned)h(in)e(a)i(single)
e(I/O)h(transaction.)39 b(Note)28 b(that)f(if)h(the)g(of)n(fsets)f(of)h
(the)g(dirty)f(pages)h(were)300 4133 y(changed)23 b(to)g(0x3000,)f
(0x5000,)g(and)h(0x7000)f(then)h(the)g(pagedaemon)g(w)o(ould)f(not)g
(be)i(able)f(to)f(cluster)300 4283 y(the)j(pages)f(together)h(because)g
(the)o(y)f(are)i(no)e(longer)h(contiguous.)583 4432 y(In)j(additional)d
(to)i(\002le)h(memory)-6 b(,)26 b(the)h(pagedaemon)g(can)g(also)g
(cluster)g(anon)o(ymous)e(memory)300 4581 y(for)32 b(pageout)g(to)f
(the)h(sw)o(ap)g(area.)53 b(In)32 b(the)g(BSD)g(VM)g(system,)g(all)g
(pageable)g(anon)o(ymous)e(memory)300 4731 y(must)c(be)h(part)g(of)f(a)
i Fm(vm)p 1131 4731 30 4 v 35 w(object)e Fs(whose)g(pager)h(is)g(the)f
(\223sw)o(ap)h(pager)-5 b(.)e(\224)37 b(The)27 b(sw)o(ap)g(pager)g
(operates)300 4880 y(by)h(taking)g(the)g(object)h(and)f(di)n(viding)e
(it)i(into)g(\002x)o(ed-sized)g(sw)o(ap)h(blocks.)41
b(Each)29 b(sw)o(ap)f(block)g(is)g(one)300 5030 y(or)h(more)g(pages)g
(in)f(length)g(\(lar)n(ger)i(objects)e(ha)n(v)o(e)h(lar)n(ger)h(sw)o
(ap)e(blocks\).)43 b(The)29 b(\002rst)g(time)f(a)h(page)g(in)300
5179 y(a)e(sw)o(ap)g(block)f(is)h(paged)g(out)f(to)h(sw)o(ap)g(the)f
(sw)o(ap)h(block)f(is)h(assigned)f(a)h(contiguous)f(location)g(in)g
(the)p eop
%%Page: 159 179
159 178 bop 3751 100 a Fs(159)300 249 y(sw)o(ap)30 b(area.)47
b(This)29 b(assignment)f(is)i(static,)g(once)h(an)f(anon)o(ymous)e
(page)i(has)g(been)g(assigned)f(a)h(sw)o(ap)300 398 y(location)24
b(on)g(backing)h(store)f(it)h(is)f(al)o(w)o(ays)h(paged)f(out)h(to)f
(that)g(location.)583 548 y(One)c(unique)f(property)h(of)f(anon)o
(ymous)f(memory)h(is)g(that)h(it)f(is)g(completely)g(under)g(the)h
(control)300 697 y(of)27 b(the)g(VM)f(system)g(and)g(it)h(has)f(no)h
(permanent)f(home)g(on)h(backing)f(store.)37 b(UVM)26
b(tak)o(es)h(adv)n(antage)300 847 y(of)f(this)f(property)h(to)g(more)g
(aggressi)n(v)o(ely)e(cluster)i(anon)o(ymous)e(memory)h(than)h(is)f
(possible)g(with)g(the)300 996 y(scheme)c(used)f(by)h(BSD)h(VM.)e(The)h
(k)o(e)o(y)g(to)f(this)g(aggressi)n(v)o(e)g(clustering)g(is)g(that)h
(UVM')-5 b(s)19 b(pagedaemon)300 1145 y(can)27 b(reassign)e(an)i(anon)o
(ymous)d(page')-5 b(s)26 b(pageout)g(location)f(on)h(backing)g(store.)
35 b(This)25 b(allo)n(ws)g(UVM')-5 b(s)300 1295 y(pagedaemon)27
b(to)f(collect)h(enough)f(dirty)h(anon)o(ymous)e(pages)i(to)f(form)h(a)
g(lar)n(ge)h(cluster)e(for)i(pageout.)300 1444 y(Each)23
b(page')-5 b(s)23 b(location)f(on)h(sw)o(ap)g(is)f(assigned)h(\(or)g
(reassigned\))g(so)g(that)f(the)h(cluster)g(occupies)g(a)g(con-)300
1594 y(tiguous)i(chunk)g(of)h(sw)o(ap)g(and)g(can)h(be)f(paged)g(out)g
(in)f(a)i(single)e(lar)n(ge)i(I/O)f(operation.)33 b(So,)27
b(if)f(UVM')-5 b(s)300 1743 y(pagedaemon)29 b(detects)f(dirty)g(pages)h
(at)g(of)n(fsets)f(0x3000,)h(0x5000,)g(and)g(0x7000)f(in)g(an)h(anon)o
(ymous)300 1892 y(object)h(it)f(can)i(still)d(group)i(these)g(pages)g
(in)g(a)g(single)f(cluster)l(,)i(while)f(the)g(BSD)g(VM)g(w)o(ould)f
(end)h(up)300 2042 y(performing)24 b(three)h(separate)g(I/O)g
(operations)f(to)h(pageout)f(the)g(same)h(pages.)583
2191 y(The)31 b(result)f(of)g(this)g(is)g(that)f(UVM)h(can)h(reco)o(v)o
(er)f(from)g(page)h(shortages)f(quick)o(er)g(and)g(more)300
2341 y(ef)n(\002ciently)24 b(than)h(BSD)h(VM.)300 2724
y Fg(8.3)143 b(The)35 b(Anonymous)e(Memory)i(Object)f(P)o(ager)300
2977 y Fs(Anon)o(ymous)d(memory)h(can)h(be)g(found)f(at)h(either)g(le)n
(v)o(el)e(of)i(UVM')-5 b(s)32 b(tw)o(o-le)n(v)o(el)f(memory)h(mapping)
300 3126 y(scheme.)68 b(At)37 b(the)h(amap)f(layer)l(,)k(anon)o(ymous)
35 b(memory)h(is)h(associated)g(with)g(anon)g(structures,)j(as)300
3275 y(e)o(xplained)26 b(in)i(Chapter)f(4.)39 b(At)27
b(the)h(object)f(layer)g(UVM)g(supports)g(a)g Fm(uvm)p
2932 3275 30 4 v 36 w(object)f Fs(that)h(is)g(back)o(ed)300
3425 y(by)h(anon)o(ymous)e(memory)-6 b(.)39 b(These)28
b(sorts)f(of)i(objects)e(are)i(managed)f(by)f(the)h(\223aobj\224)g
(pager)h(and)f(thus)300 3574 y(are)e(called)e(aobj-objects.)30
b(In)25 b(this)f(section)g(the)h(design)f(of)h(the)f(aobj)h(pager)g(is)
f(brie\003y)h(presented.)300 3905 y Ff(8.3.1)119 b(The)30
b Fb(uvm)p 1111 3905 36 4 v 42 w(aobj)f Ff(Structur)n(e)300
4122 y Fs(The)20 b(state)f(information)g(for)h(an)g(aobj-object)f(is)g
(stored)g(in)h(the)f Fm(uvm)p 2660 4122 30 4 v 35 w(aobj)g
Fs(structure.)29 b(The)20 b(main)f(role)300 4271 y(of)k(the)f
Fm(uvm)p 736 4271 V 35 w(aobj)g Fs(structure)g(is)g(to)g(k)o(eep)h
(track)g(of)g(the)f(size)h(of)f(the)h(object)f(and)g(where)h(its)f
(paged)h(out)300 4421 y(data)h(resides)g(on)f(backing)h(store.)30
b(This)23 b(structure)h(contains)f(the)h Fm(uvm)p 2765
4421 V 35 w(object)p Fs(,)f(structure,)g(the)h(size)300
4570 y(of)g(the)f(object)g(\(in)h(pages\),)f(some)g(\003ags,)h(an)g
(array)g(or)g(hash)f(table)h(that)f(maps)g(the)g(of)n(fset)g(in)g(the)h
(object)300 4720 y(to)29 b(its)f(location)h(on)g(sw)o(ap,)h(and)f
(pointers)f(to)h(maintain)f(a)i(link)o(ed)e(list)g(of)i(all)f(acti)n(v)
o(e)f(aobj-objects)g(on)300 4869 y(the)d(system.)583
5018 y(When)d(an)f(aobj-object)g(is)g(created,)h(the)g(aobj)e(pager)i
(e)o(xamines)e(the)i(size)f(of)g(the)g(object.)29 b(If)22
b(the)300 5168 y(object)31 b(contains)f(a)i(relati)n(v)o(ely)e(small)g
(number)h(of)g(pages,)i(then)e(the)g(pager)h(allocates)f(an)g(array)i
(that)300 5317 y(has)c(an)h(entry)f(for)h(each)g(page)g(in)f(the)g
(object.)45 b(Each)29 b(entry)h(contains)e(the)i(location)e(on)h(sw)o
(ap)h(where)p eop
%%Page: 160 180
160 179 bop 3751 100 a Fs(160)300 249 y(the)24 b(page')-5
b(s)24 b(non-resident)g(data)h(resides.)30 b(P)o(ages)25
b(that)f(ha)n(v)o(e)g(ne)n(v)o(er)g(been)g(paged)h(out)f(ha)n(v)o(e)g
(their)g(entry)300 398 y(set)33 b(to)f(zero)h(\(an)g(in)l(v)n(alid)f
(sw)o(ap)g(location\).)54 b(F)o(or)33 b(lar)n(ge)g(objects,)h(such)f
(an)g(array)g(could)g(consume)f(a)300 548 y(lot)e(of)g(k)o(ernel)g
(virtual)g(memory)-6 b(,)30 b(so)g(if)h(the)f(object)g(is)g(lar)n(ger)h
(than)f(a)g(certain)h(number)f(of)g(pages)g(the)300 697
y(aobj)d(pager)g(allocates)g(a)g(hash)g(table)g(to)g(map)g(page)g
(number)g(to)f(sw)o(ap)h(location.)37 b(This)26 b(allo)n(ws)g(small)300
847 y(objects)g(to)h(recei)n(v)o(e)g(the)g(bene\002t)g(of)g(f)o(ast)h
(array-based)f(lookups)f(while)h(lar)n(ger)g(objects)g(using)f(a)h
(hash)300 996 y(table)e(do)f(not)g(put)h(a)g(lar)n(ge)g(b)n(urden)g(on)
f(the)h(k)o(ernel)g(memory)f(allocator)-5 b(.)300 1321
y Ff(8.3.2)119 b(The)30 b(Aobj)g(P)o(ager)g(Functions)300
1537 y Fs(The)36 b(aobj)g(pager')-5 b(s)36 b(pager)h(functions)e(of)h
(interest)g(are)h(the)f(attach)g(and)g(I/O)g(functions.)64
b(The)36 b(aobj)300 1687 y(pager')-5 b(s)25 b(attach)f(function)g(is)h
Fm(uao)p 1510 1687 30 4 v 35 w(create)p Fs(.)k(The)c(prototype)f(for)h
(this)f(function)g(is:)300 1884 y Fm(struct)58 b(uvm_object)g
(*uao_create\(vm_size_t)d(size,)k(int)g(flags\))300 2081
y Fs(This)33 b(function)g(creates)h(a)h(ne)n(w)e(aobj-based)g
Fm(uvm)p 2114 2081 V 36 w(object)f Fs(of)i(the)g(speci\002ed)g(size.)58
b(The)33 b(\223\003ags\224)300 2231 y(ar)n(gument)28
b(is)g(used)g(during)g(system)f(startup)h(to)g(create)h(a)g(special)f
(k)o(ernel)g(object)g(\(see)h(Section)f(8.8\),)300 2380
y(otherwise)g(it)h(is)f(zero.)43 b(Once)29 b(created,)i(an)e
(aobj-object)f(will)g(remain)g(allocated)h(until)e(its)h(reference)300
2529 y(count)h(drops)g(to)g(zero.)45 b(Once)30 b(that)f(happens)g(the)h
(aobj-object)f(and)g(all)g(the)h(resources)f(it)g(is)h(holding)300
2679 y(will)24 b(be)h(released.)583 2828 y(Due)k(to)g(UVM')-5
b(s)27 b(aggressi)n(v)o(e)h(clustering)f(of)i(anon)o(ymous)e(memory)h
(for)h(pageout)f(all)h(writes)300 2978 y(to)k(the)h(sw)o(ap)g(area)g
(are)h(handled)e(specially)g(by)h(the)g(pagedaemon.)57
b(As)33 b(a)i(result)e(of)h(this,)h(the)e(aobj)300 3127
y(pager')-5 b(s)35 b(\223put\224)g(function)g(ne)n(v)o(er)f(gets)h
(called)h(\(and)f(thus)f(can)i(be)g(set)f(to)g(null\).)61
b(The)35 b(aobj')-5 b(s)35 b(pager)300 3276 y(\223get\224)29
b(function)e(is)h(a)h(simple)e(front)i(end)f(that)g(calls)g(out)g(to)g
(functions)f(that)h(handle)h(I/O)f(to)g(the)g(sw)o(ap)300
3426 y(area.)k(These)24 b(functions)g(are)i(used)e(to)h(access)g(both)f
(amap)h(and)g(aobj)f(based)h(anon)o(ymous)e(memory)-6
b(.)300 3803 y Fg(8.4)143 b(The)35 b(De)n(vice)f(P)o(ager)300
4055 y Fs(The)28 b(de)n(vice)g(pager)g(allo)n(ws)f(de)n(vice)h(memory)f
(to)g(be)i(mapped)e(by)h(user)g(processes.)40 b(The)28
b(most)f(com-)300 4205 y(mon)c(de)n(vices)g(that)g(allo)n(w)g(their)h
(memory)f(to)g(be)h(mapped)f(are)i(graphical)e(frameb)n(uf)n(fers.)31
b(The)23 b(de)n(vice)300 4354 y(pager')-5 b(s)29 b(attach)g(function)f
(tak)o(es)h(a)g(de)n(vice)g(speci\002er)h(and)f(returns)g(a)g(pointer)g
(to)f(the)h Fm(uvm)p 3512 4354 V 35 w(object)300 4504
y Fs(for)36 b(that)g(de)n(vice.)64 b(Internally)-6 b(,)37
b(the)f(de)n(vice)g(pager)g(maintains)f(a)h(link)o(ed)f(list)g(of)i
(all)e(acti)n(v)o(e)g(de)n(vice-)300 4653 y(objects)26
b(on)g(the)g(system.)33 b(When)27 b(the)f(attach)g(function)f(is)h
(called,)h(the)f(list)f(is)h(\002rst)g(searched)h(to)f(see)g(if)300
4802 y(the)21 b(de)n(vice)g(already)g(has)g(a)g Fm(uvm)p
1441 4802 V 36 w(object)p Fs(.)28 b(If)21 b(so,)h(that)e(object')-5
b(s)20 b(reference)j(counter)e(is)g(incremented)300 4952
y(and)29 b(a)g(pointer)e(to)i(that)f(object)g(is)g(returned.)42
b(If)29 b(not,)g(then)g(a)f(ne)n(w)h Fm(uvm)p 2836 4952
V 35 w(object)e Fs(is)h(allocated,)i(ini-)300 5101 y(tialized,)24
b(and)h(returned.)583 5251 y(The)32 b(de)n(vice)f(pager)h(is)f(unique)g
(in)g(that)g(it)g(performs)g(no)g(I/O.)h(Rather)g(than)f(ha)n(ving)g(a)
h(pager)300 5400 y(\223get\224)i(function,)i(the)e(de)n(vice)g(pager)g
(has)g(a)h(pager)f(\223f)o(ault\224)g(function.)58 b(When)34
b(a)h(process)f(f)o(aults)f(on)p eop
%%Page: 161 181
161 180 bop 3751 100 a Fs(161)300 249 y(de)n(vice)24
b(memory)-6 b(,)23 b(the)i Fm(uvm)p 1290 249 30 4 v 35
w(fault)f Fs(routine)f(transfers)i(control)f(of)h(the)f(handling)g(of)g
(the)h(page)f(f)o(ault)300 398 y(to)30 b(the)f(de)n(vice)h(pager')-5
b(s)30 b(f)o(ault)f(routine.)46 b(The)30 b(f)o(ault)g(routine)f
(consults)f(the)i(de)n(vice)g(dri)n(v)o(er')-5 b(s)28
b Fm(d)p 3631 398 V 36 w(mmap)300 548 y Fs(function)f(to)g(determine)g
(the)h(correct)g(de)n(vice)g(page)f(to)h(map)f(in)g(and)h(then)f(it)g
(calls)h Fm(pmap)p 3467 548 V 35 w(enter)e Fs(to)300
697 y(enter)f(the)g(mapping)e(and)i(resolv)o(e)f(the)h(f)o(ault.)30
b(The)25 b(de)n(vice)g(pager)g(also)f(has)h(a)g(null)f(\223put\224)h
(function.)583 847 y(Note)33 b(that)g(this)f(is)h(dif)n(ferent)g(from)g
(the)g(BSD)h(VM)e(de)n(vice)h(pager)-5 b(.)56 b(The)33
b(BSD)h(VM)e(de)n(vice)300 996 y(pager)f(is)g(stuck)f(with)h(the)g(BSD)
h(VM)e(pager)i(interf)o(ace)f(that)g(requires)g(it)f(to)h(pro)o(vide)f
(a)h(pager)h(\223get\224)300 1145 y(function)26 b(that)h(returns)g(a)g
(pointer)g(to)f Fm(vm)p 1751 1145 V 36 w(page)g Fs(structure.)37
b(Since)28 b(de)n(vice)f(memory)f(does)h(not)f(ha)n(v)o(e)300
1295 y Fm(vm)p 426 1295 V 35 w(page)c Fs(structure,)h(the)f(BSD)h(VM)f
(de)n(vice)g(pager)h(must)e(allocate)i(a)f(\223\002ctitious\224)g
Fm(vm)p 3382 1295 V 36 w(page)f Fs(struc-)300 1444 y(ture)37
b(and)f(return)h(it.)65 b(The)36 b(rest)h(of)f(the)h(BSD)g(VM)f(system)
g(must)f(be)i(careful)g(to)f(a)n(v)n(oid)g(placing)g(a)300
1594 y(\002ctitious)22 b(page)h(in)g(the)f(general)i(page)f(pool)f
(\(e.g.)30 b(by)23 b(paging)f(it)h(out\))f(because)i(its)e(memory)g(is)
g(de)n(vice)300 1743 y(memory)35 b(and)h(cannot)g(be)g(used)g(as)g
(general)g(purpose)g(memory)-6 b(.)63 b(UVM')-5 b(s)35
b(pager)h(f)o(ault)g(operation)300 1892 y(eliminates)23
b(the)i(need)g(for)g(messy)f(\002ctitious)g(pages.)300
2276 y Fg(8.5)143 b(The)35 b(Vnode)f(P)o(ager)300 2528
y Fs(The)24 b(vnode)g(pager)g(manages)g Fm(uvm)p 1551
2528 V 36 w(object)e Fs(structures)i(associated)g(with)f(\002les.)31
b(The)24 b(vnode)g(pager)300 2678 y(is)33 b(hea)n(vily)f(used)h(by)g
(the)h(BSD)g(k)o(ernel)f(as)g(all)g(programs)g(are)h(memory)e(mapped)h
(through)g(it.)55 b(The)300 2827 y(design)24 b(of)h(UVM')-5
b(s)24 b(vnode)g(pager)h(is)g(presented)f(in)h(this)f(section.)300
3158 y Ff(8.5.1)119 b(BSD)30 b(VM)g(Vnode)h(Management)300
3375 y Fs(UVM)26 b(and)g(BSD)g(VM)g(handle)g(the)g(VM)f(related)i
(vnode)e(data)h(structures)g(quite)f(dif)n(ferently)-6
b(.)33 b(This)26 b(is)300 3524 y(due)k(to)f(changes)h(to)f(the)h
(object)f(cache)i(and)e(the)h(embedding)f(of)g(the)h
Fm(uvm)p 2969 3524 V 35 w(object)p Fs(.)44 b(Under)30
b(BSD)300 3674 y(VM,)24 b(to)h(memory)f(map)g(a)h(\002le)h(the)e(follo)
n(wing)f(steps)h(are)i(tak)o(en)e(by)h(the)g Fm(vm)p
2952 3674 V 35 w(mmap)f Fs(function:)445 3906 y Fr(\017)49
b Fs(The)26 b Fm(vm)p 851 3906 V 36 w(pager)p 1187 3906
V 34 w(allocate)f Fs(function)h(is)g(called)g(with)g(the)g(vnode)g(as)g
(an)h(ar)n(gument.)35 b(This)544 4056 y(function)24 b(calls)g(the)h
(BSD)h(VM)e(vnode)g(pager')-5 b(s)25 b(allocate)g(function.)445
4288 y Fr(\017)49 b Fs(The)36 b(BSD)h(VM)f(vnode)f(pager')-5
b(s)36 b(allocate)g(function)f(checks)i(the)e(vnode)h(to)g(see)g(if)g
(there)h(is)544 4437 y(already)25 b(a)g Fm(vm)p 1057
4437 V 36 w(pager)e Fs(structure)i(associated)f(with)g(that)h(vnode.)
660 4670 y Fo(\226)48 b Fs(If)27 b(there)f(is)g(already)g(a)g(pager)g
(associated)g(with)f(the)h(vnode,)g(then)f(the)h(allocate)g(function)
758 4819 y(lookups)g(up)i(the)f Fm(vm)p 1504 4819 V 35
w(object)f Fs(associated)h(with)g(that)g(pager)l(,)h(gains)e(a)i
(reference)h(to)e(it,)758 4969 y(and)e(returns)g(a)g(pointer)f(to)h
(the)f(pager)-5 b(.)660 5160 y Fo(\226)48 b Fs(If)31
b(there)f(is)g(no)g(pager)g(associated)g(with)f(the)h(vnode,)h(then)f
(the)g(allocate)g(function)f(mal-)758 5309 y(locs)j(a)h(ne)n(w)f
Fm(vm)p 1350 5309 V 35 w(pager)p Fs(,)h Fm(vn)p 1863
5309 V 35 w(pager)p Fs(,)g(and)g Fm(vm)p 2553 5309 V
35 w(object)e Fs(structure)h(for)g(the)h(vnode)p eop
%%Page: 162 182
162 181 bop 3751 100 a Fs(162)758 249 y(and)31 b(ties)g(them)f(all)h
(together)-5 b(.)48 b(The)31 b(allocate)g(function)f(then)h(gains)f(a)h
(reference)i(to)d(the)758 398 y(backing)d(vnode)f(using)g(the)h
Fm(VREF)f Fs(macro)h(and)g(returns)g(a)g(pointer)f(to)h(the)g(freshly)f
(allo-)758 548 y(cated)g(pager)-5 b(.)445 780 y Fr(\017)49
b Fs(The)25 b(pager)g(is)f(then)h(used)f(by)h Fm(vm)p
1716 780 30 4 v 35 w(mmap)f Fs(to)h(lookup)e(the)i(vnode')-5
b(s)24 b Fm(vm)p 3021 780 V 35 w(object)g Fs(\(again\).)660
1013 y Fo(\226)48 b Fs(F)o(or)164 b(shared)g(mappings,)196
b(the)163 b Fm(vm)p 2504 1013 V 36 w(mmap)f Fs(function)h(calls)g(the)
758 1162 y Fm(vm)p 884 1162 V 36 w(allocate)p 1400 1162
V 34 w(with)p 1674 1162 V 35 w(pager)35 b Fs(function)g(to)h(enter)h
(the)f(object)f(in)h(the)g(map)g(struc-)758 1311 y(ture.)660
1502 y Fo(\226)48 b Fs(F)o(or)38 b(cop)o(y-on-write)g(mappings,)i(a)e
(rather)g(comple)o(x)f(set)h(of)g(function)f(calls)h(are)h(per)n(-)758
1652 y(formed)c(to)g(enter)h(the)e(object)h(in)g(the)g(map)g(structure)
f(with)h(the)g(correct)h(object)e(chain)758 1801 y(con\002guration)25
b(for)g(cop)o(y-on-write)2020 1765 y Fj(2)2057 1801 y
Fs(.)300 2034 y(It)g(should)e(be)i(noted)f(that)g(in)g(BSD)h(VM)f(the)h
(vnode')-5 b(s)23 b Fm(vm)p 2327 2034 V 36 w(object)g
Fs(maintains)g(an)i(acti)n(v)o(e)e(reference)300 2183
y(to)i(the)f(vnode.)31 b(The)25 b(reference)i(is)d(gained)g(with)h
Fm(VREF)f Fs(when)h(the)f Fm(vm)p 2786 2183 V 36 w(object)f
Fs(is)i(allocated)g(and)g(it)300 2332 y(is)j(dropped)h(with)f
Fm(vrele)g Fs(when)g(the)h(object)f(is)h(freed.)43 b(The)29
b Fm(vm)p 2630 2332 V 35 w(object)f Fs(has)g(its)h(o)n(wn)e(reference)
300 2482 y(count)d(that)h(is)f(used)g(to)h(count)f(ho)n(w)g(man)o(y)g
(VM)g(data)h(structures)f(are)i(using)e(it.)583 2631
y(The)30 b(BSD)g(VM)e(system)g(also)h(has)g(a)g(data)g(structure)g
(called)g(the)g(\223object)g(cache.)-7 b(\224)45 b(The)29
b(pur)n(-)300 2781 y(pose)21 b(of)g(the)g(object)f(cache)i(is)e(to)h
(allo)n(w)f Fm(vm)p 1815 2781 V 35 w(object)g Fs(structures)h(that)f
(are)i(not)e(currently)h(being)f(used)300 2930 y(to)25
b(remain)f(acti)n(v)o(e)h(for)g(a)g(time)f(after)i(their)f(last)f
(reference)j(is)e(dropped.)31 b(Objects)24 b(in)h(the)g(object)f(cache)
300 3079 y(are)i(said)f(to)g(be)h(\223persisting.)-7
b(\224)31 b(This)25 b(is)g(useful)g(for)g Fm(vm)p 2213
3079 V 36 w(object)f Fs(structures)h(that)g(map)g(\002les)g(that)g(are)
300 3229 y(repeatedly)d(used)h(for)f(short)g(periods)g(of)g(time.)29
b(F)o(or)23 b(e)o(xample,)f(it)g(is)g(useful)g(for)g(the)h
Fm(/bin/ls)e Fs(object)300 3378 y(to)g(remain)h(acti)n(v)o(e)f(e)n(v)o
(en)g(when)g(the)h(program)f(is)h(not)f(being)g(run)h(because)g(it)f
(is)h(used)f(frequently)-6 b(.)29 b(Each)300 3528 y(object)j(on)g(the)f
(system)g(has)h(a)h(\003ag)g(that)e(says)h(whether)g(it)g(is)f(allo)n
(wed)g(to)h(persist)f(or)i(not.)52 b(When)32 b(a)300
3677 y Fm(vm)p 426 3677 V 35 w(object)c Fs(structure')-5
b(s)28 b(reference)j(count)e(drops)f(to)h(zero,)h(if)f(its)g(persist)f
(\003ag)h(is)g(true)g(it)g(is)f(added)300 3826 y(to)c(the)h(object)f
(cache,)i(otherwise)e(it)h(is)f(freed.)583 3976 y(The)33
b(number)f(of)h(objects)f(allo)n(wed)f(in)h(BSD)i(VM')-5
b(s)31 b(object)i(cache)g(is)f(statically)f(limited)g(to)300
4125 y(100)24 b(objects)g(\()p Fm(vm)p 940 4125 V 36
w(cache)p 1276 4125 V 34 w(max)p Fs(\).)31 b(If)25 b(this)e(limit)g(is)
h(reached,)i(an)f(older)f(object)g(from)h(the)f(cache)h(may)300
4274 y(be)f(freed)h(to)f(mak)o(e)g(room)f(for)h(a)h(ne)n(w)e(one.)31
b(If)24 b(a)h(process)f(memory)f(maps)g(an)i(object)e(that)h(is)f
(currently)300 4424 y(in)k(the)h(cache)g(then)g(it)f(is)g(remo)o(v)o
(ed)f(from)i(the)f(cache)i(when)e(the)h Fm(vm)p 2704
4424 V 35 w(object)p Fs(')-5 b(s)26 b(reference)j(count)f(is)300
4573 y(incremented)c(to)h(one.)583 4723 y(The)31 b(main)e(problem)g
(with)g(the)h(object)g(cache)h(is)e(that)h(persisting)e(unreferenced)k
(vnode)d(ob-)300 4872 y(jects)23 b(that)g(are)h(in)f(the)g(object)g
(cache)h(are)g(still)e(holding)g(a)i(reference)h(to)e(their)g(backing)g
(vnode.)30 b(BSD')-5 b(s)300 5021 y(vnode)26 b(layer)h(has)f(a)h
(similar)f(caching)g(mechanism)f(to)i(the)f(object)g(cache,)i(and)e
(the)h(f)o(act)g(that)f(vnodes)p 300 5111 1440 4 v 416
5172 a Fi(2)449 5202 y Fh(Describing)19 b(the)i(details)f(of)g(this)h
(code)e(is)i(be)o(yond)d(the)j(scope)e(of)h(this)h(section)f(\227)h
(see)g Fe(vm)p 3097 5202 25 4 v 29 w(mmap.c)f Fh(for)f(details.)p
eop
%%Page: 163 183
163 182 bop 3751 100 a Fs(163)300 249 y(persisting)29
b(in)h(the)h(VM)f(system)f(ha)n(v)o(e)i(an)g(acti)n(v)o(e)e(reference)j
(pre)n(v)o(ents)e(the)g(vnodes)g(from)g(being)g(re-)300
398 y(c)o(ycled)h(of)n(f)h(of)g(the)f(vnode)g(cache.)53
b(The)31 b(net)h(result)f(is)g(that)h(in)f(BSD)h(VM)g(there)g(are)g(tw)
o(o)f(layers)h(of)300 548 y(persistence)c(caching)g(code)h(and)f(the)g
(VM)g(object)g(cache)h(interferes)f(with)g(the)g(proper)g(operation)g
(of)300 697 y(the)d(vnode)g(cache.)33 b(Thus,)25 b(useful)g(persisting)
f(virtual)g(memory)h(information)f(may)h(be)g(thro)n(wn)f(a)o(w)o(ay)
300 847 y(prematurely)-6 b(,)26 b(and)h(the)g(selection)f(of)i(a)f
(vnode)f(to)h(rec)o(ycle)g(may)g(be)g(less)g(than)f(optimal)g(because)h
(vn-)300 996 y(odes)d(with)f(virtual)h(memory)f(data)h(in)g(the)g
(object)g(cache)h(cannot)f(be)g(rec)o(ycled)h(e)n(v)o(en)e(though)g
(the)o(y)g(are)300 1145 y(no)i(longer)f(being)g(used.)300
1477 y Ff(8.5.2)119 b(UVM)30 b(Vnode)h(Management)300
1693 y Fs(UVM)e(replaces)g(BSD)h(VM')-5 b(s)28 b(vnode)h(management)f
(structure)h(with)f(a)i(ne)n(w)f(one)g(created)h(for)f(it.)43
b(In)300 1843 y(BSD)24 b(VM)f(the)g(object)g(cache)h(is)f(part)g(of)g
(the)g(main)g(VM)g(code.)30 b(In)23 b(UVM)g(the)g(object)g(cache)h(has)
f(been)300 1992 y(eliminated.)57 b(The)33 b(persistence)h(of)g
Fm(uvm)p 1772 1992 30 4 v 35 w(object)f Fs(data)h(structures)f(is)h
(handled)f(by)g(their)h(pagers.)300 2141 y(The)25 b(aobj)f(and)h(de)n
(vice)f(pagers)h(ha)n(v)o(e)g(no)f(need)h(for)h(persisting)d(objects.)
583 2291 y(UVM')-5 b(s)31 b(vnode)g(pager)h(supports)e(persisting)g
(objects)g(using)h(the)g(e)o(xisting)e(vnode)i(cache)h(to)300
2440 y(control)18 b(persistence.)29 b(This)18 b(eliminates)g(one)h
(layer)g(of)g(object)g(caching)g(and)g(pre)n(v)o(ents)f(the)h
(situation)e(of)300 2590 y(ha)n(ving)25 b(tw)o(o)g(caching)g(layers)h
(at)f(odds)g(with)g(each)h(other)-5 b(.)32 b(In)25 b(UVM)g(all)g(VM)g
(related)h(data)g(structures)300 2739 y(are)j(embedded)e(within)g(the)h
(vnode)f(structure.)40 b(The)28 b(vnode)f(has)h(a)g(\003ag)h(that)e
(indicates)g(whether)h(the)300 2888 y(VM)g(data)h(structures)g(are)g
(currently)g(in)f(use.)43 b(The)28 b(vnode)h(layer)g(clears)g(this)f
(\003ag)h(when)g(a)g(vnode)g(is)300 3038 y(\002rst)f(allocated.)39
b(When)27 b(a)h(\002le)h(is)e(memory)g(mapped,)g(UVM')-5
b(s)27 b Fm(uvm)p 2735 3038 V 35 w(mmap)g Fs(function)g(performs)g(the)
300 3187 y(follo)n(wing)c(actions:)445 3420 y Fr(\017)49
b Fs(The)20 b(vnode')-5 b(s)18 b(attach)i(function)f(is)g(called)h
(with)f(the)h(vnode)f(as)h(ar)n(gument.)28 b(The)20 b(attach)g
(function)544 3569 y(returns)k(a)i(pointer)e(to)g(the)h
Fm(uvm)p 1657 3569 V 35 w(object)f Fs(associated)g(with)g(that)g
(vnode.)660 3801 y Fo(\226)48 b Fs(If)24 b(the)g Fm(uvm)p
1180 3801 V 35 w(object)e Fs(is)h(not)g(currently)g(in)g(use,)g(then)g
(the)h(attach)f(function)g(will)f(get)h(the)758 3951
y(size)j(of)g(the)g(vnode,)f(initialize)g(the)g Fm(uvm)p
2198 3951 V 35 w(object)g Fs(structure,)h(gain)e(a)j(reference)g(to)e
(the)758 4100 y(vnode)g(with)f Fm(VREF)p Fs(,)g(and)h(then)f(return)h
(a)g(pointer)f(to)h(the)f Fm(uvm)p 2957 4100 V 35 w(object)g
Fs(structure.)660 4291 y Fo(\226)48 b Fs(If)35 b(the)g
Fm(uvm)p 1202 4291 V 35 w(object)e Fs(is)h(already)g(acti)n(v)o(e)g
(then)g(the)g(attach)g(function)g(will)f(check)i(the)758
4440 y(object')-5 b(s)28 b(reference)i(count.)41 b(If)29
b(it)f(is)g(zero)h(then)f(the)g(object)g(is)g(currently)g(persisting.)
40 b(In)758 4590 y(that)22 b(case)g(the)f(reference)i(count)e(is)g
(incremented)g(to)h(one)f(and)h(the)f(attach)g(function)g(gains)758
4739 y(a)i(reference)i(to)d(the)g(backing)g(vnode)h(with)e
Fm(VREF)p Fs(.)h(If)h(the)g(object)f(is)g(not)g(persisting,)f(then)758
4889 y(the)32 b(only)f(action)g(required)h(is)f(to)g(increment)h(the)f
(reference)i(count.)51 b(A)32 b(pointer)f(to)g(the)758
5038 y Fm(uvm)p 944 5038 V 36 w(object)23 b Fs(structure)i(is)f
(returned.)445 5270 y Fr(\017)49 b Fs(The)23 b Fm(uvm)p
908 5270 V 35 w(map)g Fs(function)g(is)g(called)g(to)g(map)g(that)g
(object)g(in)f(with)h(the)g(appropriate)g(attrib)n(utes.)p
eop
%%Page: 164 184
164 183 bop 3751 100 a Fs(164)583 249 y(When)30 b(the)f(\002nal)h
(reference)h(to)f(a)g(vnode)f Fm(uvm)p 2250 249 30 4
v 35 w(object)f Fs(is)h(dropped)g(the)h(reference)h(to)e(the)300
398 y(underlying)36 b(vnode)h(is)g(dropped)h(\(with)e
Fm(vrele)p Fs(\).)68 b(This)37 b(causes)h(the)f(vnode)g(to)g(enter)h
(the)g(vnode)300 548 y(cache.)50 b(If)32 b(the)f(vnode')-5
b(s)30 b(\003ag)i(is)f(set)f(to)h(allo)n(w)f(the)h Fm(uvm)p
2311 548 V 35 w(object)f Fs(to)h(persist,)h(then)f(the)g(persisting)300
697 y(\003ag)c(is)g(set)g(and)g(processing)f(is)g(complete.)37
b(If)27 b(the)g(object)f(is)h(not)f(allo)n(wed)g(to)h(persist,)g(then)f
(all)h(of)g(its)300 847 y(pages)e(are)g(freed)h(and)f(it)f(is)g(mark)o
(ed)h(as)g(being)f(in)l(v)n(alid.)583 996 y(In)32 b(order)h(for)f(UVM')
-5 b(s)31 b(scheme)g(to)h(w)o(ork,)h(UVM)f(must)e(be)i(noti\002ed)g
(when)g(a)g(vnode)f(is)h(be-)300 1145 y(ing)j(remo)o(v)o(ed)g(from)g
(the)h(vnode)f(cache)i(for)f(rec)o(ycling.)62 b(The)36
b(vnode)f(pager)h(pro)o(vides)f(a)h(function)300 1295
y Fm(uvm)p 486 1295 V 35 w(vnp)p 701 1295 V 35 w(terminate)28
b Fs(for)j(this.)45 b(When)30 b(the)g(vnode)g(layer)g(of)g(the)g
(operating)f(system)g(w)o(ants)g(to)300 1444 y(rec)o(ycle)e(an)g
(unreferenced)h(vnode)e(of)n(f)h(the)g(vnode)f(cache)i(it)e(calls)g
Fm(uvm)p 2842 1444 V 36 w(vnp)p 3058 1444 V 35 w(terminate)f
Fs(on)h(the)300 1594 y(vnode.)41 b(This)28 b(function)f(checks)i(to)f
(see)h(if)f(the)h(vnode')-5 b(s)27 b Fm(uvm)p 2502 1594
V 35 w(object)h Fs(is)g(persisting.)40 b(If)29 b(so,)f(it)g(re-)300
1743 y(leases)d(all)h(the)f Fm(uvm)p 1022 1743 V 35 w(object)p
Fs(')-5 b(s)24 b(resources)i(and)f(marks)g(it)g(in)l(v)n(alid.)31
b(The)26 b Fm(uvm)p 3118 1743 V 35 w(vnp)p 3333 1743
V 35 w(terminate)300 1892 y Fs(function)e(is)g(called)h(from)g(the)f
Fm(vclean)g Fs(function)g(in)g Fm(vfs)p 2405 1892 V 35
w(subr.c)p Fs(.)300 2224 y Ff(8.5.3)119 b(Vnode)31 b(Helper)f
(Functions)300 2440 y Fs(The)35 b(vnode)g(pager)g(has)g(se)n(v)o(eral)g
(helper)g(function)f(that)h(are)h(called)f(by)g(other)g(parts)g(of)g
(the)g(k)o(ernel)300 2590 y(to)f(perform)h(actions)f(on)h(a)g(vnode')-5
b(s)34 b(VM)h(data.)60 b(These)35 b(functions)f(are)i(the)e(setsize)h
(function,)h(the)300 2739 y(umount)19 b(function,)i(the)f(uncache)i
(function,)e(the)h(terminate)f(function)g(and)h(the)f(sync)h(function.)
28 b(These)300 2888 y(functions)d(are)i(named)f(dif)n(ferently)f
(depending)g(on)h(which)f(VM)h(system)f(is)h(being)f(used.)34
b(F)o(or)27 b(e)o(xam-)300 3038 y(ple,)j(the)f(setsize)g(function)f(is)
h(called)g Fm(vnode)p 1953 3038 V 35 w(pager)p 2288 3038
V 35 w(setsize)e Fs(in)i(BSD)h(VM,)f(and)g(it)f(is)h(called)300
3187 y Fm(uvm)p 486 3187 V 35 w(vnp)p 701 3187 V 35 w(setsize)e
Fs(in)h(UVM.)g(The)g(role)g(of)h(these)f(helper)g(functions)f(is)h
(described)g(in)g(this)g(sec-)300 3337 y(tion.)583 3486
y(When)f(the)g(I/O)f(system)g(changes)g(the)h(size)f(of)h(a)g(\002le)g
(the)g Fo(setsize)g Fs(function)e(is)i(called)f(so)h(that)300
3635 y(the)e(VM)f(system)g(can)h(update)f(its)g(cop)o(y)h(of)g(the)g
(size.)583 3785 y(The)36 b Fo(umount)g Fs(function)f(is)g(called)g
(when)g(a)h(\002lesystem)f(is)g(being)f(unmounted.)61
b(Before)37 b(a)300 3934 y(\002lesystem)25 b(can)h(successfully)f(be)g
(unmounted)f(all)i(references)h(to)e(the)h(\002les)g(on)f(the)g
(\002lesystem)g(must)300 4084 y(be)32 b(remo)o(v)o(ed.)49
b(As)31 b(part)h(of)f(this)g(process,)h(the)g(BSD)g(k)o(ernel)g(rec)o
(ycles)f(all)g(vnodes)g(associated)g(with)300 4233 y(the)26
b(\002lesystem.)34 b(In)26 b(the)g(BSD)h(VM)f(system)f(this)g(presents)
h(a)h(problem)e(because)i(if)f(an)g(unreferenced)300
4382 y(vnode)32 b(has)g(an)g(unreferenced)h Fm(vm)p 1545
4382 V 36 w(object)e Fs(persisting)f(in)i(the)g(object)g(cache)h(the)f
(vnode)g(rec)o(ycle)300 4532 y(operation)19 b(will)g(f)o(ail.)29
b(The)20 b(umount)e(function)h(addresses)h(this)f(problem.)28
b(When)20 b(unmounting,)f(before)300 4681 y(rec)o(ycling)33
b(the)g(\002lesystem')-5 b(s)32 b(vnodes)g(the)h(BSD)h(k)o(ernel)g
(calls)f(the)g(umount)f(helper)h(function.)55 b(The)300
4830 y(umount)29 b(function)h(goes)g(do)n(wn)g(the)g(list)f(of)i
(vnodes)f(associated)g(with)g(the)g(\002lesystem)g(and)g(ensures)300
4980 y(that)k(an)o(y)f Fm(vm)p 786 4980 V 35 w(object)g
Fs(associated)h(with)f(the)h(vnode)f(cannot)h(persist)f(in)h(the)f
(object)h(cache.)59 b(The)300 5129 y(umount)24 b(helper)i(function)f
(is)g(not)g(needed)h(in)f(UVM)g(because)h(there)g(is)f(no)g(object)h
(cache.)34 b(When)25 b(the)p eop
%%Page: 165 185
165 184 bop 3751 100 a Fs(165)300 249 y(unmount)34 b(operation)g(rec)o
(ycles)h(the)h(vnodes)e(in)h(the)g(vnode)g(cache,)k(the)c
Fm(uvm)p 3118 249 30 4 v 35 w(vnp)p 3333 249 V 35 w(terminate)300
398 y Fs(function)24 b(will)g(be)h(called)g(to)f(clean)h(out)f(an)o(y)h
(persisting)e(VM)h(data)h(from)g(the)g(vnode.)583 548
y(The)f Fo(uncache)g Fs(function)f(is)f(called)h(when)g(the)g(BSD)h(k)o
(ernel)f(w)o(ants)g(to)g(ensure)g(that)g(a)g(vnode')-5
b(s)300 697 y(VM)19 b(data)g(will)g(not)g(persist)f(when)i(the)f(last)g
(reference)i(to)e(it)f(is)h(dropped.)29 b(This)18 b(function)h(simply)f
(clears)300 847 y(the)26 b(object')-5 b(s)25 b(\223can)h(persist\224)f
(\003ag.)35 b(This)25 b(function)g(is)g(called)h(when)g(e)n(v)o(er)f(a)
h(\002le)g(is)g(written,)f(renamed,)300 996 y(or)g(remo)o(v)o(ed)e(to)i
(ensure)g(that)f(the)h(VM)f(and)h(\002le)g(data)g(are)h(in)e(sync)h
(when)f(the)h(\002le)g(is)f(closed)3526 960 y Fj(3)3563
996 y Fs(.)583 1145 y(The)g(UVM-speci\002c)f Fo(terminate)h
Fs(function)e(is)g(used)h(by)g(the)g(vnode)g(cache)g(code)h(to)e(clean)
i(out)300 1295 y(a)h(vnode')-5 b(s)25 b(VM)f(data)h(when)g(the)g(vnode)
g(is)f(being)h(rec)o(ycled.)32 b(The)25 b(BSD)h(VM)e(system)g(does)h
(not)f(ha)n(v)o(e)300 1444 y(a)h(terminate)f(helper)h(function.)583
1594 y(The)31 b Fo(sync)g Fs(helper)g(function)f(w)o(as)h(added)f(to)h
(BSD)g(VM)f(to)h(allo)n(w)e(modi\002ed)h(data)h(in)g(vnode)300
1743 y(objects)23 b(to)g(be)h(periodically)f(\003ushed)h(out)f(to)g
(backing)g(store.)30 b(This)23 b(function)g(is)g(called)h(as)g(part)f
(of)h(the)300 1892 y(sync)d(system)e(call.)30 b(Before)22
b(the)f(sync)f(helper)h(function)f(w)o(as)h(added)g(to)g(NetBSD,)g
(modi\002ed)g(VM)f(data)300 2042 y(w)o(as)32 b(only)e(\003ushed)i(to)f
(backing)g(store)h(when)f(the)h(object)f(containing)f(it)h(w)o(as)h
(freed)g(or)g(the)f Fm(msync)300 2191 y Fs(system)d(call)i(w)o(as)f
(used.)45 b(Thus,)30 b(changes)g(made)f(to)g(a)h(\002le)g(via)f(a)h
(writable)f(memory)g(mapping)f(by)i(a)300 2341 y(program)f(that)g(k)o
(ept)g(the)g(\002le)g(open)g(for)h(a)f(long)g(period)g(of)g(time)f
(were)i(apt)f(to)g(be)h(lost)e(if)h(the)g(system)300
2490 y(crashed)35 b(before)g(the)g(program)f(closed)g(and)h(unmapped)f
(the)h(\002le.)60 b(The)35 b(sync)f(function)g(addresses)300
2639 y(this)f(problem.)58 b(It)34 b(w)o(orks)f(by)h(b)n(uilding)f(a)h
(list)f(of)h(all)g(acti)n(v)o(e)f(vnode)h(objects)f(and)h(\003ushing)f
(all)h(the)300 2789 y(pages)c(in)g(them)f(to)h(backing)g(store.)47
b(UVM')-5 b(s)29 b(vnode)g(pager)i(also)f(includes)f(the)h(sync)g
(function,)h(b)n(ut)300 2938 y(it)g(impro)o(v)o(es)f(the)h(design.)51
b(UVM')-5 b(s)30 b(vnode)i(pager')-5 b(s)31 b(attach)h(function)f(is)g
(used)g(to)g(gain)g(access)h(to)g(a)300 3088 y(vnode')-5
b(s)24 b Fm(uvm)p 821 3088 V 35 w(object)p Fs(.)29 b(Its)c(prototype)f
(is:)300 3320 y Fm(struct)58 b(uvm_object)g(*uvn_attach\(struct)e
(vnode)i(*vn,)2093 3469 y(vm_prot_t)g(accessprot\))300
3702 y Fs(The)24 b(second)f(ar)n(gument)g(of)g Fm(uvn)p
1469 3702 V 36 w(attach)f Fs(is)h(the)g(protection)g(access)h(le)n(v)o
(el)e(that)h(the)h(caller)f(desires.)300 3851 y(F)o(or)i(e)o(xample,)g
(if)g(a)h(\002le)g(is)f(to)g(be)h(memory)e(mapped)h(read-only)h(or)f
(cop)o(y-on-write,)g(then)g(the)h(access)300 4001 y(protection)f(w)o
(ould)g(be)g(\223read\224)i(to)e(indicate)h(that)f(the)g(attacher)h
(will)f(not)g(modify)g(the)h(object')-5 b(s)24 b(pages.)300
4150 y(On)j(the)g(other)h(hand,)f(if)h(the)f(attacher)g(is)g(going)g
(to)g(modify)f(the)h(object,)h(then)f(it)g(speci\002es)g(an)h(access)
300 4299 y(protection)k(of)g(\223write.)-7 b(\224)54
b(The)33 b(vnode)f(pager)h(uses)f(this)f(information)g(to)h(maintain)g
(a)h(list)e(of)i(vnode)300 4449 y(objects)24 b(that)h(are)h(currently)f
(writable.)31 b(Then)25 b(when)g(the)g(vnode)g(sync)g(helper)g
(function)f(is)h(called)g(the)300 4598 y(vnode)30 b(pager)i(only)e
(considers)g(vnode)g(objects)h(on)f(the)h(writable)f(list.)48
b(Since)32 b(most)d(vnode)i(objects)300 4748 y(are)c(mapped)f
(read-only)-6 b(,)27 b(this)f(reduces)h(the)f(o)o(v)o(erhead)g(of)h
(the)f(sync)g(operation)g(because)h(rather)g(than)300
4897 y(tra)n(v)o(ersing)f(e)n(v)o(ery)g(page)h(of)g(e)n(v)o(ery)f(acti)
n(v)o(e)f(vnode)i(object)f(to)g(see)h(if)g(it)f(needs)h(to)f(be)h
(cleaned)g(only)f(the)300 5046 y(writable)e(vnodes)h(need)g(to)f(be)h
(check)o(ed.)p 300 5116 1440 4 v 416 5177 a Fi(3)449
5207 y Fh(This)c(function)d(is)j(necessary)f(in)g(both)f(BSD)i(VM)g
(and)e(UVM)i(because)e(the)h(VM)h(cache)e(and)h(b)n(uf)n(fer)f(cache)g
(ha)n(v)o(e)h(not)300 5307 y(yet)g(been)g(mer)o(ged)e(in)i(NetBSD.)p
eop
%%Page: 166 186
166 185 bop 3751 100 a Fs(166)300 300 y(T)-8 b(able)55
b(8.1:)91 b(The)55 b(eight)f(BSD)i(VM)f(memory)f(mapping)g(functions.)
120 b(The)55 b Fm(vm)p 3391 300 30 4 v 36 w(map)p 3607
300 V 35 w(find)p Fs(,)300 421 y Fm(vm)p 426 421 V 35
w(allocate)p Fs(,)26 b Fm(vm)p 1112 421 V 35 w(allocate)p
1627 421 V 34 w(with)p 1901 421 V 35 w(pager)p Fs(,)g(and)h
Fm(vm)p 2578 421 V 35 w(mmap)f Fs(functions)g(map)g(memory)g(at)300
541 y(either)36 b(a)h(speci\002ed)g(virtual)f(address)g(or)h(the)o(y)f
(use)g Fm(vm)p 2289 541 V 36 w(map)p 2505 541 V 35 w(findspace)e
Fs(to)i(\002nd)h(an)g(a)n(v)n(ailable)300 662 y(virtual)24
b(address)h(for)g(the)f(mapping.)p 316 794 3543 4 v 314
914 4 121 v 366 878 a Fo(Function)p 1658 914 V 962 w(Usage)p
3857 914 V 316 917 3543 4 v 314 1399 4 482 v 366 1002
a Fm(vm)p 492 1002 30 4 v 35 w(map)p 707 1002 V 36 w(lookup)p
1103 1002 V 34 w(entry)p 1658 1399 4 482 v 278 w Fs(looks)33
b(for)h(the)g(map)g(entry)g(that)f(maps)h(the)g(speci\002ed)g(ad-)1709
1122 y(dress;)23 b(if)g(the)g(address)g(is)g(not)f(found,)h(then)g
(return)g(the)f(map)1709 1242 y(entry)31 b(that)g(maps)g(the)g(area)i
(preceding)e(the)g(speci\002ed)h(ad-)1709 1363 y(dress)p
3857 1399 V 316 1402 3543 4 v 314 1522 4 121 v 366 1486
a Fm(vm)p 492 1486 30 4 v 35 w(map)p 707 1486 V 36 w(entry)p
1043 1486 V 34 w(link)p 1658 1522 4 121 v 398 w Fs(links)24
b(a)h(ne)n(w)f(map)h(entry)f(into)g(a)h(map)p 3857 1522
V 316 1526 3543 4 v 314 1646 4 121 v 366 1610 a Fm(vm)p
492 1610 30 4 v 35 w(map)p 707 1610 V 36 w(findspace)p
1658 1646 4 121 v 432 w Fs(\002nds)g(unallocated)f(space)h(in)f(a)i
(map)p 3857 1646 V 316 1650 3543 4 v 314 1890 4 241 v
366 1734 a Fm(vm)p 492 1734 30 4 v 35 w(map)p 707 1734
V 36 w(insert)p 1658 1890 4 241 v 612 w Fs(inserts)h(a)g(mapping)f(of)i
(an)f(object)g(in)g(a)h(map)f(at)g(the)g(speci-)1709
1854 y(\002ed)e(address)p 3857 1890 V 316 1894 3543 4
v 314 2014 4 121 v 366 1978 a Fm(vm)p 492 1978 30 4 v
35 w(map)p 707 1978 V 36 w(find)p 1658 2014 4 121 v 732
w Fs(inserts)f(a)h(mapping)f(of)h(an)g(object)f(in)g(a)i(map)p
3857 2014 V 316 2017 3543 4 v 314 2138 4 121 v 366 2102
a Fm(vm)p 492 2102 30 4 v 35 w(allocate)p 1658 2138 4
121 v 708 w Fs(allocates)f(zero)g(\002ll)g(in)f(a)h(map)p
3857 2138 V 316 2141 3543 4 v 314 2382 4 241 v 366 2225
a Fm(vm)p 492 2225 30 4 v 35 w(allocate)p 1007 2225 V
35 w(with)p 1282 2225 V 35 w(pager)p 1658 2382 4 241
v 98 w Fs(maps)30 b(a)i(pager')-5 b(s)30 b(object)h(into)f(a)h(map;)i
(the)e(ne)n(w)f(mapping)1709 2346 y(is)24 b(shared)h(\(rather)h(than)e
(cop)o(y-on-write\))p 3857 2382 V 316 2385 3543 4 v 314
2746 4 362 v 366 2469 a Fm(vm)p 492 2469 30 4 v 35 w(mmap)p
1658 2746 4 362 v 948 w Fs(maps)h(a)g(\002le)h(or)f(de)n(vice)g(into)f
(a)h(map;)g(the)g Fm(vm)p 3305 2469 30 4 v 35 w(mmap)g
Fs(func-)1709 2590 y(tion)i(handles)h(the)f(special)h(object)g(chain)f
(adjustments)f(re-)1709 2710 y(quired)e(to)h(map)f(an)h(object)g(in)f
(cop)o(y-on-write)p 3857 2746 4 362 v 316 2750 3543 4
v 300 3117 a Fg(8.6)143 b(Memory)34 b(Mapping)h(Functions)300
3369 y Fs(In)e(the)f(BSD)i(k)o(ernel)e(memory)g(there)h(are)g(four)g
(system)f(calls)g(that)g(map)h(memory)e(into)h(a)h(process')300
3519 y(address)25 b(space:)300 3742 y Fo(exec:)49 b Fs(maps)26
b(a)g(ne)n(wly)f(e)o(x)o(ecuted)g(program')-5 b(s)25
b(te)o(xt,)g(data,)h(and)g(bss)f(areas)i(into)e(the)g(process')h
(address)544 3891 y(space.)300 4121 y Fo(mmap:)49 b Fs(maps)24
b(a)h(\002le)h(or)f(anon)o(ymous)d(memory)i(into)g(a)h(process')g
(address)g(space.)300 4350 y Fo(obr)n(eak:)50 b Fs(gro)n(ws)24
b(a)h(process')g(heap)g(by)f(mapping)g(zero-\002ll)h(memory)f(at)h(the)
g(end)g(of)f(the)h(heap.)300 4579 y Fo(shmat:)49 b Fs(maps)24
b(a)h(System)g(V)g(shared)f(memory)g(se)o(gment)g(into)g(a)h(process')g
(address)g(space.)583 4802 y(The)30 b(BSD)g(VM)f(system)f(pro)o(vides)g
(eight)g(functions)g(that)h(are)h(used)f(to)g(establish)f(mappings)300
4952 y(for)d(these)g(four)f(system)g(calls.)30 b(These)25
b(eight)f(functions)g(are)h(sho)n(wn)f(in)g(T)-8 b(able)25
b(8.1.)30 b(The)25 b(call)f(path)h(for)300 5101 y(these)g(functions)e
(is)i(comple)o(x,)e(as)i(sho)n(wn)f(in)g(Figure)h(8.1.)583
5251 y(On)20 b(the)g(other)g(hand,)h(UVM)f(pro)o(vides)e(\002)n(v)o(e)i
(functions)f(for)h(establishing)e(memory)i(mappings.)300
5400 y(These)31 b(functions)g(are)h(sho)n(wn)e(in)h(T)-8
b(able)31 b(8.2.)50 b(Unlik)o(e)31 b(BSD)h(VM,)f(UVM)g(has)g(one)h
(main)e(mapping)p eop
%%Page: 167 187
167 186 bop 3751 100 a Fs(167)846 2862 y @beginspecial
0 @llx 0 @lly 430 @urx 465 @ury 3010 @rwi @setspecial
%%BeginDocument: ../figures/bsdpath.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-25.0 508.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 8494 m 0 0 l 7609 0 l 7609 8494 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
2100 8400 m
gs 1 -1 sc (vm_map_entry_link) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
2130 7953 m 2100 8073 l 2070 7953 l 2070 8115 l 2130 8115 l cp
clip
n 2100 6975 m 2100 8100 l gs col0 s gr gr

% arrowhead
n 2130 7953 m 2100 8073 l 2070 7953 l 2100 7953 l 2130 7953 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5643 8028 m 5749 8092 l 5626 8086 l 5781 8133 l 5798 8076 l cp
clip
n 2100 6975 m 5775 8100 l gs col0 s gr gr

% arrowhead
n 5643 8028 m 5749 8092 l 5626 8086 l 5634 8057 l 5643 8028 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6030 6453 m 6000 6573 l 5970 6453 l 5970 6615 l 6030 6615 l cp
clip
n 6000 5475 m 6000 6600 l gs col0 s gr gr

% arrowhead
n 6030 6453 m 6000 6573 l 5970 6453 l 6000 6453 l 6030 6453 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3447 6571 m 3324 6589 l 3424 6516 l 3275 6578 l 3298 6633 l cp
clip
n 6000 5475 m 3300 6600 l gs col0 s gr gr

% arrowhead
n 3447 6571 m 3324 6589 l 3424 6516 l 3436 6543 l 3447 6571 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6030 4953 m 6000 5073 l 5970 4953 l 5970 5115 l 6030 5115 l cp
clip
n 6000 3975 m 6000 5100 l gs col0 s gr gr

% arrowhead
n 6030 4953 m 6000 5073 l 5970 4953 l 6000 4953 l 6030 4953 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2130 6453 m 2100 6573 l 2070 6453 l 2070 6615 l 2130 6615 l cp
clip
n 2100 3975 m 2100 6600 l gs col0 s gr gr

% arrowhead
n 2130 6453 m 2100 6573 l 2070 6453 l 2100 6453 l 2130 6453 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5009 6481 m 5079 6582 l 4970 6526 l 5092 6632 l 5131 6587 l cp
clip
n 2100 3975 m 5100 6600 l gs col0 s gr gr

% arrowhead
n 5009 6481 m 5079 6582 l 4970 6526 l 4989 6503 l 5009 6481 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2130 3453 m 2100 3573 l 2070 3453 l 2070 3615 l 2130 3615 l cp
clip
n 2100 2475 m 2100 3600 l gs col0 s gr gr

% arrowhead
n 2130 3453 m 2100 3573 l 2070 3453 l 2100 3453 l 2130 3453 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5382 6451 m 5391 6574 l 5325 6470 l 5376 6624 l 5433 6605 l cp
clip
n 2700 2475 m 4500 3900 l 5400 6600 l gs col0 s gr gr

% arrowhead
n 5382 6451 m 5391 6574 l 5325 6470 l 5354 6461 l 5382 6451 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2798 6486 m 2713 6576 l 2745 6457 l 2666 6599 l 2719 6628 l cp
clip
n 2400 2400 m 4200 3900 l 2700 6600 l gs col0 s gr gr

% arrowhead
n 2798 6486 m 2713 6576 l 2745 6457 l 2771 6471 l 2798 6486 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
1900 1959 m 1936 2076 l 1849 1989 l 1932 2128 l 1983 2097 l cp
clip
n 1275 975 m 1950 2100 l gs col0 s gr gr

% arrowhead
n 1900 1959 m 1936 2076 l 1849 1989 l 1874 1974 l 1900 1959 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2357 1994 m 2264 2077 l 2307 1961 l 2217 2096 l 2267 2129 l cp
clip
n 3000 975 m 2250 2100 l gs col0 s gr gr

% arrowhead
n 2357 1994 m 2264 2077 l 2307 1961 l 2332 1978 l 2357 1994 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5966 3454 m 5988 3575 l 5912 3479 l 5979 3626 l 6034 3601 l cp
clip
n 4800 975 m 6000 3600 l gs col0 s gr gr

% arrowhead
n 5966 3454 m 5988 3575 l 5912 3479 l 5939 3466 l 5966 3454 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3102 6490 m 3014 6576 l 3051 6459 l 2967 6597 l 3018 6628 l cp
clip
n 6450 975 m 3000 6600 l gs col0 s gr gr

% arrowhead
n 3102 6490 m 3014 6576 l 3051 6459 l 3077 6475 l 3102 6490 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6675 6470 m 6608 6574 l 6618 6451 l 6567 6605 l 6624 6624 l cp
clip
n 6750 975 m 7200 4800 l 6600 6600 l gs col0 s gr gr

% arrowhead
n 6675 6470 m 6608 6574 l 6618 6451 l 6646 6461 l 6675 6470 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
1200 900 m
gs 1 -1 sc (exec) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3000 900 m
gs 1 -1 sc (mmap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 900 m
gs 1 -1 sc (obreak) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6600 900 m
gs 1 -1 sc (shmat) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 2400 m
gs 1 -1 sc (vm_mmap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 3900 m
gs 1 -1 sc (vm_allocate_with_pager) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 3900 m
gs 1 -1 sc (vm_allocate) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 5400 m
gs 1 -1 sc (vm_map_find) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 6900 m
gs 1 -1 sc (vm_map_findspace) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 6900 m
gs 1 -1 sc (vm_map_insert) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6000 8400 m
gs 1 -1 sc (vm_map_lookup_entry) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
gs  clippath
6030 7953 m 6000 8073 l 5970 7953 l 5970 8115 l 6030 8115 l cp
clip
n 6000 6975 m 6000 8100 l gs col0 s gr gr

% arrowhead
n 6030 7953 m 6000 8073 l 5970 7953 l 6000 7953 l 6030 7953 l  cp gs 0.00 setgray ef gr  col0 s
$F2psEnd
rs
%%EndDocument
 @endspecial 704 3065 a(Figure)25 b(8.1:)30 b(The)25
b(BSD)g(VM)g(call)g(paths)f(for)h(the)f(four)h(mapping)f(system)g
(calls)300 3460 y(function,)i Fm(uvm)p 870 3460 30 4
v 35 w(map)p Fs(.)35 b(All)26 b(mapping)g(operations)f(use)i(this)e
(function)h(to)g(establish)f(their)i(mappings.)300 3610
y(This)c(mak)o(es)h(UVM')-5 b(s)23 b(code)h(cleaner)h(and)f(easier)g
(to)g(understand)f(than)h(the)g(BSD)h(VM)e(code.)31 b(UVM')-5
b(s)300 3759 y(mapping)24 b(call)g(path)h(is)f(sho)n(wn)g(in)g(Figure)h
(8.2.)583 3909 y(The)g(prototype)f(for)h(the)g Fm(uvm)p
1644 3909 V 35 w(map)f Fs(function)g(is:)300 4141 y Fm(int)59
b(uvm_map\(vm_map_t)d(map,)j(vm_offset_t)e(*startp,)778
4290 y(vm_size_t)h(size,)h(struct)f(uvm_object)g(*uobj,)778
4440 y(vm_offset_t)g(uoffset,)f(uvm_flag_t)h(flags\))300
4672 y Fs(A)34 b(call)h(to)e Fm(uvm)p 882 4672 V 36 w(map)g
Fs(maps)h Fm(size)g Fs(bytes)f(of)i(object)e Fm(uobj)h
Fs(into)f(map)h Fm(map)p Fs(.)59 b(The)34 b(\002rst)h(page)f(of)300
4822 y(the)23 b(mapping)e(maps)i(to)f(of)n(fset)h Fm(uoffset)e
Fs(in)i(the)f(object)h(being)f(mapped.)30 b(The)23 b
Fm(startp)f Fs(ar)n(gument)300 4971 y(contains)f(a)g(hint)g(for)h(the)f
(address)g(where)h(the)g(mapping)e(should)g(be)i(established.)28
b(Once)22 b(the)f(mapping)300 5120 y(is)28 b(established,)g(the)g
(actual)g(address)g(used)g(for)h(the)f(mapping)f(is)h(returned)g(in)g
Fm(startp)p Fs(.)40 b(The)28 b(\003ags,)300 5270 y(described)e(belo)n
(w)-6 b(,)24 b(are)j(used)e(to)h(control)f(the)g(attrib)n(utes)g(of)h
(the)f(mapping.)33 b(The)26 b Fm(uvm)p 3334 5270 V 35
w(map)f Fs(function)p eop
%%Page: 168 188
168 187 bop 3751 100 a Fs(168)1032 300 y(T)-8 b(able)25
b(8.2:)30 b(The)25 b(\002)n(v)o(e)f(UVM)h(memory)e(mapping)h(functions)
p 526 432 3124 4 v 524 553 4 121 v 576 517 a Fo(Function)p
1748 553 V 842 w(Usage)p 3647 553 V 526 556 3124 4 v
524 1038 4 482 v 576 640 a Fm(uvm)p 762 640 30 4 v 35
w(map)p 977 640 V 35 w(lookup)p 1372 640 V 35 w(entry)p
1748 1038 4 482 v 98 w Fs(looks)30 b(for)i(the)f(map)g(entry)g(that)g
(maps)f(the)h(speci-)1799 761 y(\002ed)k(address;)j(if)c(the)g(address)
g(is)g(not)g(found,)i(re-)1799 881 y(turns)g(the)h(map)f(entry)h(that)f
(maps)g(the)h(area)h(pre-)1799 1002 y(ceding)25 b(the)f(speci\002ed)h
(address)p 3647 1038 V 526 1041 3124 4 v 524 1161 4 121
v 576 1125 a Fm(uvm)p 762 1125 30 4 v 35 w(map)p 977
1125 V 35 w(entry)p 1312 1125 V 35 w(link)p 1748 1161
4 121 v 218 w Fs(links)f(a)h(ne)n(w)f(map)h(entry)g(into)e(a)j(map)p
3647 1161 V 526 1165 3124 4 v 524 1405 4 241 v 576 1249
a Fm(uvm)p 762 1249 30 4 v 35 w(map)p 977 1249 V 35 w(findspace)p
1748 1405 4 241 v 253 w Fs(\002nds)e(space)f(in)g(a)h(map)f(and)h
(inserts)e(a)i(mapping)e(of)1799 1369 y(the)j(speci\002ed)g(object)p
3647 1405 V 526 1409 3124 4 v 524 1529 4 121 v 576 1493
a Fm(uvm)p 762 1493 30 4 v 35 w(map)p 1748 1529 4 121
v 828 w Fs(establishes)f(a)h(mapping)p 3647 1529 V 526
1532 3124 4 v 524 1773 4 241 v 576 1617 a Fm(uvm)p 762
1617 30 4 v 35 w(mmap)p 1748 1773 4 241 v 768 w Fs(attaches)31
b(to)f(a)g(\002le')-5 b(s)31 b(or)f(de)n(vice')-5 b(s)29
b Fm(uvm)p 3211 1617 30 4 v 36 w(object)1799 1737 y Fs(and)c(maps)f(it)
h(in)p 3647 1773 4 241 v 526 1777 3124 4 v 300 2150 a(returns)i
Fm(KERN)p 850 2150 30 4 v 35 w(SUCCESS)e Fs(if)i(the)g(mapping)e(w)o
(as)i(successfully)f(established,)h(otherwise)f(it)g(returns)300
2300 y(an)f(error)g(code.)583 2449 y(The)h Fm(uvm)p 950
2449 V 35 w(map)f Fs(function')-5 b(s)24 b Fm(flags)g
Fs(are)j(a)e(bitwise)g(encoding)g(of)g(the)g(desired)h(attrib)n(utes)e
(of)300 2598 y(the)33 b(mapping.)53 b(This)32 b(encoding)g(is)g
(usually)g(created)h(with)f(a)h(call)g(to)f(the)h Fm(UVM)p
3146 2598 V 35 w(MAPFLAG)e Fs(macro.)300 2748 y(This)24
b(macro)h(tak)o(es)g(the)f(follo)n(wing)f(ar)n(guments:)300
2980 y Fo(pr)n(otection:)50 b Fs(the)38 b(initial)e(protection)h(of)h
(the)f(mapping.)68 b(This)37 b(protection)g(must)f(not)h(e)o(xceed)h
(the)544 3130 y(maximum)23 b(protection.)300 3362 y Fo(maximum)i(pr)n
(otection:)50 b Fs(the)25 b(maximum)e(allo)n(wed)g(protection)h(of)h
(the)g(mapping.)300 3594 y Fo(inheritance:)50 b Fs(the)25
b(initial)f(inheritance)g(v)n(alue)g(for)h(the)g(mapping.)300
3827 y Fo(advice:)49 b Fs(the)25 b(initial)e(usage)i(advice)g(for)g
(the)g(mapping.)300 4059 y Fo(mapping)g(\003ags:)49 b
Fs(further)25 b(mapping)f(\003ags.)31 b(These)24 b(\003ags)i(are:)544
4292 y Fo(\002xed:)50 b Fs(the)24 b(mapping)g(must)g(be)h(established)e
(at)i(the)g(address)f(speci\002ed)h(in)g Fm(startp)p
Fs(.)544 4483 y Fo(o)o(v)o(erlay:)48 b Fs(allocate)25
b(an)g(amap)g(for)g(the)f(mapping)g(no)n(w)-6 b(.)544
4673 y Fo(nomer)o(ge:)50 b Fs(do)24 b(not)g(try)h(and)g(mer)n(ge)g
(this)f(mapping)f(in)i(with)f(its)g(neighbors.)544 4864
y Fo(copy)n(onw:)49 b Fs(set)24 b(the)h(cop)o(y-on-write)f(\003ag)i
(for)f(this)f(mapping.)544 5055 y Fo(amappad:)49 b Fs(add)25
b(some)g(padding)f(to)h(the)g(amap)g(so)f(that)h(it)f(can)i(be)f(gro)n
(wn)f(without)g(reallocat-)758 5205 y(ing)h(its)f(memory)g(\(v)n(alid)g
(only)g(if)g(\223o)o(v)o(erlay\224)h(is)f(true\).)p eop
%%Page: 169 189
169 188 bop 3751 100 a Fs(169)930 2337 y @beginspecial
0 @llx 0 @lly 401 @urx 375 @ury 2807 @rwi @setspecial
%%BeginDocument: ../figures/uvmpath.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-41.0 418.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 6994 m 0 0 l 7393 0 l 7393 6994 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
5700 6900 m
gs 1 -1 sc (uvm_map_lookup_entry) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
7.500 slw
gs  clippath
4119 3467 m 4057 3574 l 4062 3450 l 4017 3606 l 4075 3623 l cp
clip
n 4800 975 m 4050 3600 l gs col0 s gr gr

% arrowhead
n 4119 3467 m 4057 3574 l 4062 3450 l 4090 3459 l 4119 3467 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
4468 3508 m 4367 3579 l 4423 3469 l 4317 3592 l 4363 3631 l cp
clip
n 6600 975 m 4350 3600 l gs col0 s gr gr

% arrowhead
n 4468 3508 m 4367 3579 l 4423 3469 l 4446 3488 l 4468 3508 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3693 3461 m 3735 3577 l 3643 3494 l 3733 3629 l 3783 3596 l cp
clip
n 3000 2475 m 3750 3600 l gs col0 s gr gr

% arrowhead
n 3693 3461 m 3735 3577 l 3643 3494 l 3668 3478 l 3693 3461 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3349 3489 m 3428 3584 l 3313 3538 l 3444 3633 l 3480 3585 l cp
clip
n 1200 975 m 1800 2400 l 3450 3600 l gs col0 s gr gr

% arrowhead
n 3349 3489 m 3428 3584 l 3313 3538 l 3331 3514 l 3349 3489 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3930 4953 m 3900 5073 l 3870 4953 l 3870 5115 l 3930 5115 l cp
clip
n 3900 3975 m 3900 5100 l gs col0 s gr gr

% arrowhead
n 3930 4953 m 3900 5073 l 3870 4953 l 3900 4953 l 3930 4953 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2241 6548 m 2122 6585 l 2209 6497 l 2071 6583 l 2103 6633 l cp
clip
n 3900 5475 m 2100 6600 l gs col0 s gr gr

% arrowhead
n 2241 6548 m 2122 6585 l 2209 6497 l 2225 6522 l 2241 6548 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5591 6497 m 5677 6585 l 5559 6548 l 5697 6633 l 5729 6583 l cp
clip
n 3900 5475 m 5700 6600 l gs col0 s gr gr

% arrowhead
n 5591 6497 m 5677 6585 l 5559 6548 l 5575 6522 l 5591 6497 l  cp gs 0.00 setgray ef gr  col0 s
/Helvetica-Bold ff 300.00 scf sf
1200 900 m
gs 1 -1 sc (exec) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3000 900 m
gs 1 -1 sc (mmap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
4800 900 m
gs 1 -1 sc (obreak) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6600 900 m
gs 1 -1 sc (shmat) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3000 2400 m
gs 1 -1 sc (uvm_mmap) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3900 3900 m
gs 1 -1 sc (uvm_map) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3900 5400 m
gs 1 -1 sc (uvm_map_findspace) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 6900 m
gs 1 -1 sc (uvm_map_entry_link) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
gs  clippath
3030 1953 m 3000 2073 l 2970 1953 l 2970 2115 l 3030 2115 l cp
clip
n 3000 975 m 3000 2100 l gs col0 s gr gr

% arrowhead
n 3030 1953 m 3000 2073 l 2970 1953 l 3000 1953 l 3030 1953 l  cp gs 0.00 setgray ef gr  col0 s
$F2psEnd
rs
%%EndDocument
 @endspecial 1347 2540 a(Figure)25 b(8.2:)30 b(UVM')-5
b(s)24 b(mapping)g(call)g(path)544 2930 y Fo(trylock:)49
b Fs(try)34 b(and)g(lock)f(the)h(map.)58 b(If)34 b(the)g(map)g(is)f
(already)h(lock)o(ed,)i(return)e(an)g(error)h(code)758
3079 y(rather)26 b(than)e(sleep)h(w)o(aiting)f(for)h(the)f(map)h(to)f
(be)h(unlock)o(ed.)583 3308 y(Note)e(that)f(under)h(UVM)f(the)h
Fm(uvm)p 1808 3308 30 4 v 35 w(map)g Fs(function)f(allo)n(ws)f(all)i
(the)f(mapping)g(attrib)n(utes)g(to)g(be)300 3458 y(speci\002ed)h(at)f
(map)g(time.)30 b(This)21 b(cannot)h(be)h(done)f(under)h(BSD)g(VM.)f
(BSD)h(VM')-5 b(s)22 b(mapping)f(functions)300 3607 y(al)o(w)o(ays)35
b(establish)f(a)h(mapping)f(with)g(a)i(def)o(ault)f(protection)f(and)h
(inheritance.)61 b(F)o(or)36 b(e)o(xample,)g(the)300
3757 y(def)o(ault)26 b(protection)f(of)h(a)g(mapping)f(under)h(BSD)g
(VM)g(is)f(read-write.)35 b(Thus,)25 b(if)h(the)g(k)o(ernel)g(w)o(ants)
f(to)300 3906 y(establish)d(a)h(read-only)g(mapping)e(of)i(a)g(\002le)g
(using)f(the)h(BSD)h(VM)e(system)g(it)g(must)g(\002rst)h(use)g(the)f
(map-)300 4055 y(ping)k(functions)f(to)h(establish)g(a)g(read-write)h
(mapping.)35 b(It)27 b(then)f(must)f(use)i(the)f Fm(vm)p
3237 4055 V 35 w(map)p 3452 4055 V 36 w(protect)300 4205
y Fs(function)31 b(to)h(write-protect)g(the)f(mapping.)52
b(This)31 b(is)g(both)h(w)o(asteful)f(and)h(dangerous.)52
b(It)32 b(is)g(w)o(aste-)300 4354 y(ful)c(because)g(the)g(mapping)f
(function)g(locks)h(the)f(map,)i(establishes)e(the)g(mapping)g(with)g
(the)h(def)o(ault)300 4504 y(protection,)h(and)g(then)g(unlocks)f(the)h
(map.)44 b(Then)29 b(the)f Fm(vm)p 2374 4504 V 36 w(map)p
2590 4504 V 35 w(protect)g Fs(function)g(must)g(relock)300
4653 y(the)k(map,)i(repeat)f(the)f(map)g(lookup,)h(change)g(the)f
(protection,)h(and)g(then)f(unlock)g(the)g(map.)53 b(Thus,)300
4802 y(under)28 b(BSD)g(VM)g(the)f(map)h(must)e(be)i(lock)o(ed)g(and)f
(unlock)o(ed)g(twice,)i(and)f(there)g(is)f(an)h(e)o(xtra)f(lookup)300
4952 y(and)h(protection)e(change.)39 b(This)27 b(is)g(also)g(dangerous)
h(because)g(when)f(establishing)f(a)i(memory)e(map-)300
5101 y(ping)c(there)g(is)g(a)h(brief)g(windo)n(w)e(of)h(time)g(between)
g(establishing)f(the)h(mapping)f(and)i(write)f(protecting)300
5251 y(the)31 b(mapping)e(where)j(the)e(map)h(is)f(unlock)o(ed)h(and)f
(the)h(object)g(is)f(mapped)h(read-write.)49 b(On)31
b(a)g(mul-)300 5400 y(tithreaded)d(system)f(this)g(could)g(allo)n(w)g
(a)i(malicious)d(process)i(to)g(race)h(the)f(k)o(ernel)g(and)g
(successfully)p eop
%%Page: 170 190
170 189 bop 3751 100 a Fs(170)300 249 y(modify)19 b(a)i(read-only)f
(\002le)h(before)g(the)f(k)o(ernel)g(has)g(a)h(chance)g(to)f
(write-protect)g(the)g(mapping.)28 b(UVM')-5 b(s)300
398 y Fm(uvm)p 486 398 30 4 v 35 w(map)22 b Fs(function)g(a)n(v)n(oids)
g(both)g(these)h(problems)f(by)g(allo)n(wing)f(the)i(attrib)n(utes)e
(of)i(the)g(mapping)e(to)300 548 y(be)k(speci\002ed)g(at)g(the)g(time)f
(the)g(mapping)g(is)g(created.)583 697 y(If)29 b(a)g(caller)f(to)g
Fm(uvm)p 1292 697 V 35 w(map)g Fs(does)g(not)f(wish)h(to)g(map)g(an)g
(object)g(in)f(at)i(the)f(object)g(layer)g(of)g(the)300
847 y(mapping,)35 b(it)f(can)h(call)f Fm(uvm)p 1337 847
V 35 w(map)g Fs(with)f Fm(uobj)h Fs(set)g(to)g(null.)58
b(Thus,)36 b(a)e(zero-\002ll)h(mapping)e(can)i(be)300
996 y(created)26 b(by)e(setting)g Fm(uobj)g Fs(to)g(null)g(and)h
(setting)e(the)i(\223cop)o(yonw\224)g(\003ag.)583 1145
y(Note)34 b(that)f(both)g(BSD)i(VM)e(and)h(UVM)f(support)g(the)h(BSD)g
(\223pmap)g(prefer\224)g(interf)o(ace)h(for)300 1295
y(systems)i(with)g(virtually)g(addressed)h(caches)h(\(V)-13
b(A)l(Cs\))39 b(or)f(MMUs)f(that)h(do)g(not)f(allo)n(w)h(mappings)300
1444 y(in)33 b(certain)h(virtual)f(address)h(ranges)g(\(e.g.)57
b(Sun)34 b(sparc)g(systems\).)57 b(This)33 b(interf)o(ace)h(is)f(used)h
(by)f(the)300 1594 y(mapping)22 b(functions)g(to)h(push)f(a)h(mapping)f
(address)h(forw)o(ard)h(so)f(that)f(it)h(does)g(not)f(create)i(V)-13
b(A)l(C)23 b(cache)300 1743 y(aliases)i(or)f(place)i(a)f(mapping)e(at)i
(an)g(in)l(v)n(alid)e(address.)300 2127 y Fg(8.7)143
b(Unmapping)33 b(Memory)300 2379 y Fs(In)c(the)g(BSD)h(VM)e(system,)h
(memory)f(is)g(unmapped)g(with)h(the)f Fm(vm)p 2690 2379
V 36 w(map)p 2906 2379 V 35 w(delete)g Fs(function.)42
b(This)300 2528 y(function)30 b(operates)h(by)g(locking)f(the)h(map,)h
(searching)e(for)i(map)e(entries)h(to)f(remo)o(v)o(e,)i(and)f(then)f
(un-)300 2678 y(locking)d(the)h(map.)40 b(When)29 b(a)f(map)g(entry)g
(that)g(needs)g(to)f(be)i(remo)o(v)o(ed)e(is)g(found,)i(the)f(address)g
(range)300 2827 y(that)23 b(the)h(map)f(entry)g(maps)g(is)h(pur)n(ged)f
(from)h(the)f(pmap)g(and)h(the)f(reference)i(to)f(the)f(mapped)g
(object)h(is)300 2977 y(dropped.)42 b(While)28 b(this)g(w)o(orks)g
(correctly)-6 b(,)30 b(it)e(is)g(not)g(optimal)f(for)i(the)g(follo)n
(wing)e(reason.)42 b(Dropping)300 3126 y(the)20 b(reference)j(to)d(an)g
(object)h(usually)e(means)h(decrementing)g(a)h(reference)h(counter)-5
b(.)29 b(This)20 b(usually)f(has)300 3275 y(a)30 b(lo)n(w)e(o)o(v)o
(erhead,)h(ho)n(we)n(v)o(er)l(,)g(if)g(the)g(reference)i(counter)e
(drops)g(to)g(zero,)h(then)f(the)g(pager)h(may)f(wish)300
3425 y(to)23 b(free)h(the)f(mapped)g(object.)30 b(If)23
b(the)g(mapped)g(object)g(contains)f(dirty)h(pages,)g(then)g(the)o(y)g
(will)f(need)h(to)300 3574 y(be)h(\003ushed)g(before)g(that)f(object)h
(can)g(be)g(freed.)31 b(This)23 b(means)h(that)f(an)h(I/O)g(operation)f
(will)g(ha)n(v)o(e)h(to)f(be)300 3724 y(initiated.)41
b(When)29 b(the)g(I/O)g(operation)f(is)g(started)h(the)f(map)h(that)f
(the)h(object)f(w)o(as)h(mapped)g(in)f(is)g(still)300
3873 y(lock)o(ed)23 b(by)f(the)h(unmap)f(function.)30
b(Neither)22 b(the)h(k)o(ernel)g(nor)g(an)o(y)f(other)h(process)g(can)g
(access)h(the)e(map)300 4022 y(while)h(the)g(unmap)f(function)h(has)g
(it)g(lock)o(ed.)30 b(Hopefully)22 b(the)h(pager)h(will)e(perform)i(an)
f(asynchronous)300 4172 y(I/O)j(operation)f(so)g(that)g(the)h(unmap)f
(operation)g(can)h(complete)f(without)g(ha)n(ving)g(to)g(w)o(ait)h(for)
g(the)f(I/O)300 4321 y(to)f(complete.)31 b(Ho)n(we)n(v)o(er)l(,)23
b(since)i(pagers)g(are)g(not)g(required)g(to)f(pro)o(vide)g
(asynchronous)g(I/O)h(this)e(may)300 4471 y(not)h(be)h(case.)583
4620 y(In)35 b(UVM)f(this)g(issue)g(has)g(been)h(addressed)g(by)f
(breaking)g(an)h(unmap)f(operation)g(into)g(tw)o(o)300
4769 y(parts.)60 b(The)35 b Fm(uvm)p 955 4769 V 35 w(unmap)f
Fs(function)g(\002rst)h(locks)f(the)g(map)h(and)g(calls)f
Fm(uvm)p 3065 4769 V 35 w(unmap)p 3400 4769 V 35 w(remove)f
Fs(to)300 4919 y(clean)72 b(out)f(the)h(map')-5 b(s)70
b(pmap)h(and)h(remo)o(v)o(e)f(the)g(speci\002ed)h(map)f(entries.)171
b(Note)72 b(that)300 5068 y Fm(uvm)p 486 5068 V 35 w(unmap)p
821 5068 V 35 w(remove)40 b Fs(does)h(not)g(drop)f(references)j(to)e
(an)o(y)g(mapped)f(objects.)80 b(Instead)41 b(it)f(re-)300
5218 y(turns)34 b(the)g(list)f(of)i(map)f(entries)g(remo)o(v)o(ed)f
(from)h(the)g(map.)59 b(At)34 b(this)f(point)h Fm(uvm)p
3228 5218 V 35 w(unmap)f Fs(unlocks)300 5367 y(the)27
b(map,)h(allo)n(wing)e(the)i(k)o(ernel)f(and)h(other)f(processes)h
(access)g(to)f(it.)39 b(Then)27 b Fm(uvm)p 3212 5367
V 35 w(unmap)g Fs(calls)g(the)p eop
%%Page: 171 191
171 190 bop 3751 100 a Fs(171)300 249 y Fm(uvm)p 486
249 30 4 v 35 w(unmap)p 821 249 V 35 w(detach)23 b Fs(function.)29
b(This)23 b(function)g(goes)h(do)n(wn)f(the)h(list)f(of)h(map)f
(entries)h(and)g(drops)300 398 y(the)g(reference)i(to)d(an)o(y)h(amaps)
g(or)g Fm(uvm)p 1681 398 V 35 w(object)f Fs(structures)g(that)h(are)h
(pointed)e(to.)30 b(It)24 b(then)g(frees)g(the)300 548
y(map)j(entry)-6 b(.)36 b(Once)27 b Fm(uvm)p 1182 548
V 35 w(unmap)p 1517 548 V 35 w(detach)f Fs(returns)h(the)f(unmap)h
(operation)f(is)g(complete.)37 b(Unmap)300 697 y(operations)24
b(under)h(UVM)f(do)h(not)f(lea)n(v)o(e)g(the)h(map)g(lock)o(ed)f
(during)g(pager)h(I/O.)300 1081 y Fg(8.8)143 b(K)l(er)n(nel)34
b(Memory)h(Management)300 1333 y Fs(The)26 b(k)o(ernel')-5
b(s)26 b(virtual)g(address)g(space)h(contains)f(the)g(k)o(ernel')-5
b(s)26 b(te)o(xt,)g(data,)g(bss,)h(and)f(mappings.)34
b(The)300 1483 y(k)o(ernel')-5 b(s)22 b(memory)g(is)g(mapped)g(by)g
(the)g Fm(kernel)p 2051 1483 V 35 w(map)g Fs(map.)29
b(While)22 b(the)h(k)o(ernel)f(can)h(use)f Fm(uvm)p 3691
1483 V 36 w(map)300 1632 y Fs(to)35 b(map)g(\002les)h(and)f(de)n(vices)
g(into)g(its)f(address)i(space,)i(the)d(k)o(ernel)h(also)f(needs)g(to)g
(be)h(able)f(to)g(map)300 1782 y(pri)n(v)n(ate)23 b(memory)h(into)f
(its)h(address)g(space)h(to)f(support)g(the)g(k)o(ernel)g(memory)g
(allocator)g(\(malloc\))g(and)300 1931 y(other)30 b(k)o(ernel)g
(subsystems.)45 b(In)31 b(both)e(BSD)i(VM)f(and)g(UVM)g(there)g(are)h
(a)g(special)f(set)g(of)g(functions)300 2080 y(used)i(to)f(establish)g
(and)g(remo)o(v)o(e)g(pri)n(v)n(ate)g(k)o(ernel)h(mappings.)50
b(These)32 b(functions)f(are)h(called)g(k)o(ernel)300
2230 y(memory)39 b(management)f(functions.)74 b(UVM)39
b(uses)g(the)g(same)g(API)h(as)g(BSD)g(VM)f(for)h(the)f(k)o(ernel)300
2379 y(memory)20 b(management)h(functions,)g(although)f(the)h
(functions)f(ha)n(v)o(e)h(been)h(renamed)f(to)g(be)h(consistent)300
2528 y(with)33 b(UVM)g(coding)g(style.)57 b(In)34 b(this)f(section)g
(these)h(functions)f(and)g(their)h(usage)g(by)f(the)h(k)o(ernel)g(is)
300 2678 y(described.)300 3009 y Ff(8.8.1)119 b(K)m(er)n(nel)31
b(Memory)e(Management)g(Functions)300 3226 y Fs(UVM)24
b(pro)o(vides)g(the)h(follo)n(wing)d(functions)i(for)h(the)g
(management)f(of)h(pri)n(v)n(ate)e(k)o(ernel)i(memory:)300
3458 y Fd(uvm)p 486 3458 V 35 w(km)p 641 3458 V 36 w(alloc)p
Fo(:)47 b Fs(The)36 b(alloc)g(function)f(allocates)g(wired)h(memory)f
(in)h(the)f(k)o(ernel')-5 b(s)36 b(virtual)f(ad-)544
3607 y(dress)29 b(space.)45 b(The)30 b(allocated)f(memory)f(is)h
(uninitialized.)43 b(If)30 b(there)g(is)f(not)g(enough)f(physical)544
3757 y(memory)e(a)n(v)n(ailable)g(to)g(satisfy)g(the)g(allocation,)g
(then)h(the)f(allocating)g(process)g(will)g(w)o(ak)o(e)h(the)544
3906 y(pagedaemon)c(and)g(sleep)g(until)f(memory)g(is)g(a)n(v)n
(ailable.)30 b(If)23 b(there)h(is)e(not)h(enough)f(virtual)h(space)544
4056 y(in)31 b(the)h(map)f(this)g(function)g(will)g(f)o(ail.)51
b(BSD)33 b(VM)e(does)h(not)f(ha)n(v)o(e)g(a)h(function)f(that)h
(\002lls)f(this)544 4205 y(role)25 b(\(b)n(ut)f(see)h
Fm(uvm)p 1245 4205 V 35 w(km)p 1400 4205 V 36 w(zalloc)e
Fs(belo)n(w\).)300 4437 y Fd(uvm)p 486 4437 V 35 w(km)p
641 4437 V 36 w(zalloc)p Fo(:)47 b Fs(This)24 b(function)g(operates)g
(in)g(the)h(same)f(w)o(ay)g(as)h Fm(uvm)p 2987 4437 V
35 w(km)p 3142 4437 V 36 w(alloc)e Fs(e)o(xcept)h(the)544
4587 y(allocated)37 b(memory)g(is)g(zeroed)h(by)g(the)f(memory)g
(allocator)-5 b(.)68 b(This)37 b(function)g(is)g(kno)n(wn)f(as)544
4736 y Fm(kmem)p 790 4736 V 35 w(alloc)24 b Fs(in)g(BSD)i(VM.)300
4969 y Fd(uvm)p 486 4969 V 35 w(km)p 641 4969 V 36 w(valloc)p
Fo(:)47 b Fs(The)40 b(v)n(alloc)f(function)f(allocates)i(zero-\002ll)g
(virtual)f(memory)f(in)i(the)f(k)o(ernel)544 5118 y(address)30
b(space.)48 b(No)30 b(physical)f(pages)h(are)i(allocated)e(for)g(the)h
(memory)-6 b(.)46 b(As)30 b(the)g(memory)g(is)544 5267
y(accessed)g(the)g(f)o(ault)f(routine)g(will)g(map)g(in)h(zeroed)g
(pages)g(to)f(resolv)o(e)g(the)h(f)o(aults.)44 b(If)31
b(there)f(is)p eop
%%Page: 172 192
172 191 bop 3751 100 a Fs(172)544 249 y(no)34 b(free)g(virtual)f(space)
i(in)e(the)h(map)g(this)f(function)g(will)g(f)o(ail.)58
b(This)33 b(function)g(is)g(kno)n(wn)g(as)544 398 y Fm(kmem)p
790 398 30 4 v 35 w(alloc)p 1125 398 V 35 w(pageable)23
b Fs(in)h(BSD)i(VM.)300 631 y Fd(uvm)p 486 631 V 35 w(km)p
641 631 V 36 w(valloc)p 1037 631 V 34 w(wait)p Fo(:)48
b Fs(This)36 b(function)f(operates)i(in)f(the)g(same)g(w)o(ay)g(as)h
Fm(uvm)p 3357 631 V 35 w(km)p 3512 631 V 35 w(valloc)544
780 y Fs(e)o(xcept)28 b(that)h(if)f(the)h(map)f(is)h(out)f(of)h
(virtual)f(space)h(then)f(the)h(caller)g(will)f(sleep)h(until)e(space)j
(is)544 930 y(a)n(v)n(ailable.)g(This)24 b(function)g(is)g(kno)n(wn)g
(as)h Fm(kmem)p 2253 930 V 35 w(alloc)p 2588 930 V 34
w(wait)f Fs(in)h(BSD)g(VM.)300 1162 y Fd(uvm)p 486 1162
V 35 w(km)p 641 1162 V 36 w(kmemalloc)p Fo(:)47 b Fs(This)18
b(function)g(is)h(the)g(lo)n(w-le)n(v)o(el)e(memory)i(allocator)g(for)g
(the)g(k)o(ernel)g(mal-)544 1311 y(loc.)38 b(It)28 b(allocates)f(wired)
g(memory)f(in)h(the)h(speci\002ed)f(map.)38 b(If)28 b(there)g(is)f(not)
g(enough)f(physical)544 1461 y(memory)g(a)n(v)n(ailable)g(to)g(satisfy)
g(the)g(allocation,)g(then)h(the)f(allocating)g(process)g(will)g(w)o
(ak)o(e)h(the)544 1610 y(pagedaemon)c(and)g(sleep)g(until)e(memory)i
(is)f(a)n(v)n(ailable)h(unless)f(a)h(\223cannot)g(w)o(ait\224)g(\003ag)
h(is)f(set.)30 b(If)544 1760 y(there)f(is)g(not)f(enough)g(virtual)h
(space)g(for)g(the)g(allocation)f(then)h(this)f(function)g(will)g(f)o
(ail.)43 b(This)544 1909 y(function)24 b(is)g(kno)n(wn)g(as)h
Fm(kmem)p 1640 1909 V 35 w(malloc)e Fs(in)i(BSD)g(VM.)300
2141 y Fd(uvm)p 486 2141 V 35 w(km)p 641 2141 V 36 w(free)p
Fo(:)48 b Fs(This)25 b(function)h(is)g(a)h(simple)e(front)h(end)h(for)f
(the)h(standard)f(unmap)f(function.)35 b(It)27 b(is)544
2291 y(kno)n(wn)c(as)i Fm(kmem)p 1191 2291 V 35 w(free)f
Fs(in)h(BSD)g(VM.)300 2523 y Fd(uvm)p 486 2523 V 35 w(km)p
641 2523 V 36 w(free)p 917 2523 V 35 w(wakeup)p Fo(:)47
b Fs(This)36 b(function)f(is)h(the)h(same)f(as)g Fm(uvm)p
2776 2523 V 35 w(km)p 2931 2523 V 36 w(free)g Fs(e)o(xcept)g(that)f
(after)544 2673 y(freeing)26 b(the)g(memory)f(it)h(w)o(ak)o(es)g(up)g
(an)o(y)f(processes)h(that)g(are)g(w)o(aiting)f(for)i(space)f(in)g(the)
g(map.)544 2822 y(It)f(is)f(kno)n(wn)g(as)g Fm(kmem)p
1368 2822 V 35 w(free)p 1643 2822 V 35 w(wakeup)g Fs(in)g(BSD)i(VM.)300
3153 y Ff(8.8.2)119 b(K)m(er)n(nel)31 b(Memory)e(Objects)300
3370 y Fs(Most)k(pri)n(v)n(ate)f(k)o(ernel)i(memory)f(resides)g(in)h
(lar)n(ge)g(objects)f(called)h(k)o(ernel)f(memory)g(objects.)57
b(The)300 3519 y(main)28 b(k)o(ernel)g(memory)g(object)g(is)g
Fm(kernel)p 1898 3519 V 34 w(object)p Fs(.)40 b(This)28
b(object)g(spans)g(the)g(entire)g(virtual)g(ad-)300 3669
y(dress)38 b(space)g(of)f(the)h(k)o(ernel.)69 b(Thus,)41
b(each)d(virtual)f(address)g(in)h(the)f(k)o(ernel')-5
b(s)38 b(address)f(space)h(has)300 3818 y(a)e(corresponding)e(location)
h(in)g(the)g(k)o(ernel)h(object.)62 b(F)o(or)36 b(e)o(xample,)h(on)e
(the)h(i386,)h(the)e(k)o(ernel)h(ad-)300 3967 y(dress)24
b(space)g(currently)f(starts)h(at)g(0xf0000000)e(and)i(ends)f(at)h(0xf)
n(f)n(f)n(f)n(f)n(f)n(f)n(f.)k(The)c(k)o(ernel)g(virtual)f(address)300
4117 y(0xf0000000)31 b(is)h(assigned)g(to)g(of)n(fset)g(0)h(in)f(the)g
(k)o(ernel)h(object.)54 b(Lik)o(e)n(wise,)33 b(k)o(ernel)f(virtual)g
(address)300 4266 y(0xf0004000)23 b(is)i(assigned)f(to)g(of)n(fset)g
(0x4000.)583 4416 y(Although)h(the)h(k)o(ernel)g(object)g(is)f(quite)g
(lar)n(ge,)i(only)e(a)i(small)e(part)h(of)g(that)g(space)g(is)g(in)f
(use)h(at)300 4565 y(an)o(y)k(one)g(time.)46 b(The)30
b(unused)f(parts)h(of)h(the)f(k)o(ernel)g(object)g(consumes)f(neither)h
(virtual)f(or)h(physical)300 4714 y(memory)-6 b(.)45
b(The)30 b(only)f(time)h(that)f(the)h(k)o(ernel)g(object)g(comes)g
(into)f(play)h(is)f(when)h(it)g(is)f(mapped.)46 b(F)o(or)300
4864 y(e)o(xample,)25 b(in)g(UVM,)g(the)h Fm(uvm)p 1407
4864 V 35 w(km)p 1562 4864 V 35 w(alloc)f Fs(function)g(operates)g(by)h
(\002nding)f(a)h(free)g(virtual)f(address)300 5013 y(and)g(mapping)e
(the)i(corresponding)f(part)h(of)g(the)f(k)o(ernel)h(object)g(into)e
(that)i(virtual)f(address.)583 5163 y(There)31 b(are)g(tw)o(o)f(main)g
(adv)n(antages)g(of)g(ha)n(ving)g(lar)n(ge)h(k)o(ernel)g(objects.)46
b(The)31 b(\002rst)f(is)g(that)g(all)300 5312 y(the)c(k)o(ernel')-5
b(s)26 b(pri)n(v)n(ate)f(pages)h(are)h(collected)f(into)f(a)i(fe)n(w)f
(objects.)34 b(This)26 b(can)g(ease)h(deb)n(ugging)e(k)o(ernel)p
eop
%%Page: 173 193
173 192 bop 3751 100 a Fs(173)300 249 y(memory)34 b(problems)g(by)g
(reducing)h(the)g(number)f(of)h(data)g(structures.)60
b(The)35 b(second)g(adv)n(antage)f(of)300 398 y(lar)n(ge)29
b(k)o(ernel)g(objects)f(is)g(that)g(it)g(reduces)h(map)f(entry)g
(fragmentation)g(by)g(allo)n(wing)f(map)h(entries)g(to)300
548 y(be)34 b(mer)n(ged)f(together)-5 b(.)56 b(F)o(or)34
b(e)o(xample,)g(if)g(the)f(k)o(ernel)h(maps)f(virtual)g(address)g
(0xf0008000)f(in)h(and)300 697 y(then)25 b(later)h(maps)e(in)h
(0xf0009000)f(\(the)i(follo)n(wing)d(page)j(assuming)e(a)h(4096)g(byte)
g(page)h(size\),)f(these)300 847 y(tw)o(o)d(one-page)h(mappings)e(of)i
(the)f(k)o(ernel)h(object)f(can)h(be)g(mer)n(ged)g(into)e(a)i(single)f
(tw)o(o-page)g(mapping)300 996 y(of)27 b(the)g(k)o(ernel)g(object)g(at)
g(address)g(0xf0008000.)36 b(If)28 b(each)g(mapping)d(were)j(in)f(dif)n
(ferent)g(objects)f(this)300 1145 y(w)o(ould)32 b(not)g(be)h(possible)f
(because)h(a)g(single)f(map)g(entry)h(cannot)g(point)e(to)i(more)f
(than)h(one)g(object.)300 1295 y(Reducing)39 b(map)g(entry)g
(fragmentation)f(reduces)i(k)o(ernel)f(memory)g(use)g(and)g(lo)n(wers)g
(map)g(search)300 1444 y(time.)583 1594 y(As)45 b(stated)f(earlier)l(,)
50 b(most)43 b(of)i(the)f(k)o(ernel)h(memory)f(allocations)f(are)i
(done)g(through)e(the)300 1743 y Fm(kernel)p 666 1743
30 4 v 35 w(object)27 b Fs(structure.)43 b(Ho)n(we)n(v)o(er)l(,)29
b(some)f(of)h(the)g(k)o(ernel')-5 b(s)29 b(submaps)f(ha)n(v)o(e)g
(their)h(o)n(wn)f(pri-)300 1892 y(v)n(ate)g(k)o(ernel)h(memory)f
(objects.)42 b(F)o(or)29 b(e)o(xample,)g(the)g Fm(kmem)p
2434 1892 V 35 w(map)f Fs(is)g(used)h(to)f(allocate)h(memory)f(for)300
2042 y(the)e(k)o(ernel)g(memory)g(allocator)-5 b(.)34
b(It)26 b(has)g(its)f(o)n(wn)g(pri)n(v)n(ate)g(k)o(ernel)i(object)e
Fm(kmem)p 3133 2042 V 35 w(object)g Fs(that)h(con-)300
2191 y(tains)i(its)f(memory)-6 b(.)40 b(This)28 b(is)g(necessary)g
(because)h(the)f Fm(kmem)p 2487 2191 V 35 w(map)g Fs(needs)g(to)g(be)h
(accessible)f(during)300 2341 y(an)37 b(interrupt)f(and)h(the)g(more)f
(general)i Fm(kernel)p 2089 2341 V 34 w(map)e Fs(is)h(not)f(properly)h
(protected)f(for)i(access)f(at)300 2490 y(interrupt)24
b(time.)300 2821 y Ff(8.8.3)119 b(Comparison)45 b(of)g(BSD)h(VM)g(and)g
(UVM)g(K)m(er)n(nel)h(Memory)d(Manage-)659 3007 y(ment)300
3223 y Fs(While)24 b(both)f(BSD)j(VM)e(and)g(UVM)g(use)g(the)g(same)g
(basic)g(API)h(for)g(the)f(allocation)g(of)g(pri)n(v)n(ate)f(k)o(ernel)
300 3373 y(memory)-6 b(,)30 b(there)h(are)f(a)h(number)f(of)g
(implementation)e(dif)n(ferences)i(between)g(the)g(tw)o(o)g(systems)f
(that)300 3522 y(mak)o(es)24 b(UVM')-5 b(s)24 b(k)o(ernel)h(memory)f
(management)g(more)h(ef)n(\002cient)g(than)f(BSD)i(VM')-5
b(s.)583 3671 y(Once)24 b(dif)n(ference)h(between)e(UVM)h(and)f(BSD)i
(VM)e(is)g(the)h(w)o(ay)g(the)f(k)o(ernel)h(map)f(is)h(accessed)300
3821 y(to)i(establish)e(a)j(pri)n(v)n(ate)e(k)o(ernel)h(memory)f
(mapping)g(of)h(a)g(k)o(ernel)g(object.)34 b(The)26 b(unusual)f(part)h
(of)g(such)300 3970 y(a)g(mapping)f(is)h(that)g(the)g(of)n(fset)f
(within)g(the)h(k)o(ernel)h(object)e(depends)h(on)g(the)g(virtual)f
(address)h(chosen)300 4120 y(for)h(the)h(mapping)e(and)h(that)f
(address)i(is)e(not)h(kno)n(wn)f(by)h(the)g(function)f(that)h(wishes)f
(to)h(establish)f(the)300 4269 y(mapping.)54 b(In)34
b(BSD)g(VM,)e(one)h(w)o(ould)g(normally)f(use)h(a)g(function)g(such)f
(as)i Fm(vm)p 3210 4269 V 35 w(allocate)e Fs(that)300
4418 y(locks)d(the)g(map,)h(establishes)e(the)i(mapping,)f(and)g(then)g
(unlocks)g(the)g(map)g(and)g(returns.)44 b(Ho)n(we)n(v)o(er)l(,)300
4568 y(since)19 b(the)h(of)n(fset)f(in)g(the)g(k)o(ernel)h(object)f(is)
g(not)g(kno)n(wn)g(in)g(adv)n(ance,)i(this)d(is)h(not)g(possible.)28
b(Instead,)20 b(the)300 4717 y(k)o(ernel)25 b(memory)g(allocation)f
(functions)g(must)g(lock)h(the)g(map,)g(use)g(a)g(tw)o(o-step)f
(process)i(to)e(establish)300 4867 y(the)e(mapping,)f(and)h(then)g
(unlock)f(the)h(map.)30 b(The)22 b(\002rst)g(step)g(is)f(to)h(\002nd)g
(space)h(in)f(the)f(k)o(ernel')-5 b(s)22 b(map)g(for)300
5016 y(the)j(mapping.)30 b(At)25 b(this)f(point)g(the)h(virtual)f
(address)h(to)g(be)g(used)g(for)g(the)g(mapping)f(is)g(kno)n(wn)g(and)h
(the)300 5165 y(of)n(fset)k(in)g(the)h(k)o(ernel)f(object)h(can)g(be)f
(computed.)44 b(The)30 b(second)f(step)h(is)f(to)g(insert)g(a)h
(mapping)e(from)300 5315 y(the)f(virtual)f(address)g(allocated)h(in)f
(the)h(\002rst)g(step)g(to)f(the)h(k)o(ernel)g(object)f(at)h(the)g
(correct)g(of)n(fset.)36 b(Both)p eop
%%Page: 174 194
174 193 bop 3751 100 a Fs(174)300 249 y(steps)29 b(require)g(address)g
(lookups)f(in)g(the)h(tar)n(get)h(map.)43 b(The)29 b(second)g(lookup)f
(is)h(redundant)g(because)300 398 y(it)i(is)g(recomputing)g
(information)f(already)i(computed)f(in)g(the)h(\002rst)g(lookup.)50
b(F)o(ortunately)-6 b(,)32 b(the)g(VM)300 548 y(system)25
b(caches)i(the)g(result)f(of)g(the)h(last)f(lookup)f(on)h(the)h(map)f
(so)g(the)g(second)g(lookup)g(will)f(not)h(be)h(as)300
697 y(e)o(xpensi)n(v)o(e.)583 847 y(In)32 b(UVM)g(such)f(mappings)g
(are)h(established)f(with)g(a)h(single)f(call)g(to)h
Fm(uvm)p 3251 847 30 4 v 35 w(map)p Fs(.)51 b(The)32
b(call-)300 996 y(ing)e(function)g(speci\002es)h(which)g(k)o(ernel)g
(map)f(and)h(which)g(k)o(ernel)g(object)f(to)h(use)g(for)g(the)f
(mapping.)300 1145 y(Rather)j(than)f(specifying)f(an)h(of)n(fset)g(in)g
(the)g(object,)h(the)f(calling)g(function)f(uses)h(the)g(special)g(v)n
(alue)300 1295 y Fm(UVM)p 486 1295 V 35 w(UNKNOWN)p 941
1295 V 34 w(OFFSET)p Fs(.)c(By)h(specifying)f(an)h(unkno)n(wn)f(of)n
(fset,)h(the)g(calling)f(function)g(tells)g(the)300 1444
y Fm(uvm)p 486 1444 V 35 w(map)e Fs(function)f(that)h(it)g(needs)g(to)g
(compute)g(the)g(true)h(of)n(fset)e(of)i(the)f(mapping)f(once)i(the)f
(virtual)300 1594 y(address)34 b(has)f(been)h(determined.)58
b(This)33 b(is)g(done)h(by)f(subtracting)g(the)g(starting)g(virtual)g
(address)h(of)300 1743 y(k)o(ernel)f(space)g(from)g(the)g(ne)n(wly)f
(allocated)h(virtual)f(address.)55 b(Thus,)35 b(only)d(a)h(single)f
(mapping)g(call)300 1892 y(and)c(a)g(single)f(map)h(lookup)f(are)h
(needed)h(to)e(establish)g(the)h(mapping)e(under)i(UVM.)g(If)g(the)g
(function)300 2042 y(calling)h Fm(uvm)p 787 2042 V 35
w(map)g Fs(also)g(needs)h(to)f(use)g(the)h(of)n(fset,)g(it)f(can)h
(simply)e(compute)h(it)g(by)g(subtracting)f(of)n(f)300
2191 y(the)d(k)o(ernel')-5 b(s)24 b(starting)g(virtual)g(address)g
(from)h(the)g(address)f(returned)h(by)g(the)f Fm(uvm)p
3221 2191 V 36 w(map)g Fs(function.)583 2341 y(UVM)35
b(and)g(BSD)g(VM)g(allocate)g(pageable)g(k)o(ernel)g(virtual)f(memory)g
(dif)n(ferently)g(as)h(well.)300 2490 y(P)o(ageable)26
b(k)o(ernel)g(virtual)g(memory)f(is)g(virtual)h(memory)f(that)g(is)h
(mapped)g(zero-\002ll)g(b)n(ut)g(no)f(physical)300 2639
y(memory)k(is)h(assigned)f(to)h(it)f(until)g(the)h(\002rst)g(page)g(f)o
(ault)g(on)g(it.)46 b(BSD)31 b(VM)e(allocates)h(such)g(memory)300
2789 y(by)c(mapping)f(in)g(a)i(null)e(object)g(cop)o(y-on-write.)34
b(This)26 b(causes)g(the)g(page)g(f)o(ault)g(routine)f(to)h(allocate)g
(a)300 2938 y(ne)n(w)f(anon)o(ymous)e Fm(vm)p 1098 2938
V 35 w(object)h Fs(to)g(contain)h(the)g(memory)f(for)h(this)f(area)i
(when)f(the)g(\002rst)g(page)g(f)o(ault)300 3088 y(occurs.)59
b(While)34 b(this)f(simpli\002es)g(the)h(memory)g(mapping)f(procedure)i
(\(since)f(there)g(are)i(no)e(object)300 3237 y(of)n(fsets)d(to)g(w)o
(orry)h(about\))f(it)g(also)g(nulli\002es)g(the)h(bene\002ts)f(of)h(ha)
n(ving)f(a)h(single)f(lar)n(ge)h(k)o(ernel)g(object)300
3386 y(and)24 b(can)h(lead)f(to)f(map)h(entry)g(fragmentation)f(and)h
(the)g(allocation)f(of)h(multiple)f(smaller)g(anon)o(ymous)300
3536 y(k)o(ernel)39 b(objects.)72 b(UVM,)38 b(on)h(the)f(other)h(hand,)
j(uses)c(the)h(usual)f(\223unkno)n(wn)g(of)n(fset\224)g(mechanism)300
3685 y(to)f(establish)f(pageable)h(k)o(ernel)g(mappings,)i(thus)d(allo)
n(wing)g(it)g(to)h(use)g(a)h(k)o(ernel)f(object)g(for)g(these)300
3835 y(mappings.)583 3984 y(Another)25 b(dif)n(ference)h(between)f(UVM)
g(and)g(BSD)h(VM)f(in)g(k)o(ernel)g(memory)g(mapping)f(is)h(that)300
4133 y(BSD)i(VM)e(uses)h(the)g Fm(vm)p 1178 4133 V 35
w(page)p 1453 4133 V 35 w(zero)p 1728 4133 V 35 w(fill)f
Fs(function)g(to)h(zero)g(an)o(y)g(wired)f(memory)h(that)f(it)g(allo-)
300 4283 y(cates.)38 b(There)27 b(are)h(tw)o(o)f(problems)f(this.)36
b(First,)27 b(the)g(page)h(zero)f(function)f(is)h(a)g(v)o(ery)g(simple)
f(function)300 4432 y(that)e(calls)h(out)f(to)h(the)f
Fm(pmap)p 1329 4432 V 35 w(zero)p 1604 4432 V 35 w(page)g
Fs(function:)300 4653 y Fm(boolean_t)58 b(vm_page_zero_fill\(struct)c
(vm_page)k(*m\))300 4802 y({)420 4952 y(m->flags)g(&=)h(\230PG_CLEAN;)
420 5101 y(pmap_zero_page\(VM_PAGE_TO_P)o(HYS\(m)o(\)\);)420
5251 y(return\(TRUE\);)300 5400 y(})p eop
%%Page: 175 195
175 194 bop 3751 100 a Fs(175)300 249 y(Since)31 b(this)f(function)g
(does)g(not)g(actually)g(do)g(an)o(ything)f(other)i(than)f(clear)h(the)
g(clean)g(bit)f(and)g(call)h(a)300 398 y(pmap)h(function)g(it)g(is)h
(unnecessary)-6 b(.)54 b(The)33 b(second)f(problem)g(with)g(using)g
(the)h(zero)g(page)g(function)300 548 y(is)j(that)h(it)f(assumes)g
(that)g(the)h(page)g(being)f(zeroed)i(is)e(not)g(currently)h(mapped)f
(in)h(the)f(k)o(ernel)h(and)300 697 y(will)29 b(not)h(be)g(mapped)g(in)
g(the)g(k)o(ernel)g(an)o(y)g(time)f(in)h(the)g(future.)47
b(Thus,)31 b(it)f(operates)g(by)g(temporarily)300 847
y(mapping)d(the)h(page)g(in,)h(zeroing)f(it,)g(and)g(then)g(unmapping)f
(the)h(page.)41 b(The)28 b(resulting)f(sequence)h(of)300
996 y(operations)e(under)h(BSD)g(VM)g(are)h(allocate)e(a)h(page,)h
(temporarily)e(map)g(the)h(page)g(into)f(the)h(k)o(ernel')-5
b(s)300 1145 y(address)29 b(space,)g(zero)h(the)e(page,)i(unmap)e(the)g
(page)h(\(\003ushing)f(the)h(TLB)g(and)f(cache)i(as)f(necessary\),)300
1295 y(and)22 b(\002nally)f(map)g(the)h(page)g(into)e(the)i(k)o(ernel)f
(at)h(its)f(\002nal)h(address.)29 b(Since)22 b(all)g(pri)n(v)n(ate)e(k)
o(ernel)i(memory)300 1444 y(is)f(mapped)f(in)h(the)g(k)o(ernel')-5
b(s)21 b(address)g(space)h(the)f(e)o(xtra)f(o)o(v)o(erhead)h(of)g
(establishing)e(and)j(remo)o(ving)d(the)300 1594 y(the)28
b(temporary)f(mapping)f(of)i(the)g(page)g(is)f(complete)g(unnecessary)
-6 b(.)39 b(In)28 b(UVM)f(wired)g(k)o(ernel)h(pages)300
1743 y(are)23 b(mapping)d(in)i(and)g(zeroed)g(at)g(their)g(tar)n(get)g
(address,)h(thus)e(a)n(v)n(oiding)f(this)h(e)o(xtra)h(layer)g(of)g
(mapping.)583 1892 y(One)39 b(other)f(dif)n(ference)g(between)g(UVM)g
(and)g(BSD)h(VM')-5 b(s)37 b(k)o(ernel)h(memory)g(mapping)f(is)300
2042 y(in)43 b(the)g(operation)g(of)h(the)f(lo)n(w-le)n(v)o(el)e(k)o
(ernel)j(memory)f(allocator)g(\()p Fm(uvm)p 2990 2042
30 4 v 35 w(km)p 3145 2042 V 36 w(kmemalloc)e Fs(and)300
2191 y Fm(kmem)p 546 2191 V 35 w(malloc)p Fs(\).)62 b(In)35
b(BSD)i(VM,)e(this)f(function)h(operates)g(as)h(follo)n(ws.)61
b(First)36 b(BSD)g(VM')-5 b(s)35 b(tw)o(o)300 2341 y(step)e(mapping)f
(procedure)i(is)f(used)h(to)f(determine)g(what)g(virtual)g(address)g
(to)g(map)g(the)h(data)f(in)g(at.)300 2490 y(Then)22
b(BSD)i(VM)e(e)o(x)o(ecutes)f(tw)o(o)h(loops)g(o)o(v)o(er)g(that)g
(area.)30 b(In)23 b(the)f(\002rst)h(loop,)f(pages)g(of)h(memory)f(are)h
(al-)300 2639 y(located)h(in)h(the)f(speci\002ed)h(k)o(ernel)f(object.)
31 b(In)24 b(the)h(second)f(loop)g(the)g(pages)h(in)f(the)g(object)h
(are)g(look)o(ed)300 2789 y(up)f(by)g(of)n(fset)g(and)g(entered)h(in)f
(the)g(k)o(ernel')-5 b(s)24 b(pmap.)30 b(This)24 b(is)g(w)o(asteful)g
(for)g(tw)o(o)g(reasons.)31 b(First,)24 b(there)300 2938
y(are)32 b(tw)o(o)e(loops)g(o)o(v)o(er)f(the)i(same)g(address)f(space.)
49 b(Second,)33 b(in)d(the)h(\002rst)g(loop)f(all)g(the)h(pages)f(are)i
(al-)300 3088 y(located.)42 b(Rather)30 b(than)e(sa)n(ving)g(the)h
(pointers)f(to)g(these)h(pages)f(for)h(the)g(second)f(loop,)h(the)g
(BSD)h(VM)300 3237 y(function)20 b(looks)h(up)g(the)g(pages)g(in)g(the)
g(k)o(ernel)g(object.)29 b(This)21 b(lookup)f(is)g(a)i(more)f(e)o
(xpensi)n(v)o(e)e(hash)i(table)300 3386 y(lookup.)45
b(T)-8 b(o)30 b(contrast,)g(UVM)g(establishes)e(the)i(mapping)f(with)g
(a)h(single)f Fm(uvm)p 3142 3386 V 35 w(map)h Fs(call)g(and)f(then)300
3536 y(enters)c(a)f(loop)g(o)o(v)o(er)g(the)g(allocated)g(virtual)g
(address)g(space)h(that)f(allocates)h(a)f(page)h(and)g(then)f(maps)g
(it)300 3685 y(in.)30 b(No)25 b(hash)f(table)h(lookups)e(are)j
(required.)300 4069 y Fg(8.9)143 b(W)m(ir)m(ed)36 b(Memory)300
4321 y Fs(W)l(ired)e(memory)e(is)h(resident)g(memory)g(that)g(is)g(not)
g(allo)n(wed)g(to)g(be)h(paged)f(out)g(to)g(backing)g(store.)300
4471 y(Memory)24 b(is)g(wired)h(in)g(BSD)g(in)g(the)f(follo)n(wing)f
(situations:)445 4703 y Fr(\017)49 b Fs(A)43 b(user)g(process)f(can)h
(wire)g(and)g(unwire)g(parts)f(of)h(its)f(memory)g(using)g(the)g
Fm(mlock)g Fs(and)544 4852 y Fm(munlock)24 b Fs(system)g(calls.)33
b(This)25 b(allo)n(ws)f(a)i(process)g(that)f(performs)g(time-critical)g
(operations)544 5002 y(to)g(a)n(v)n(oid)h(the)f(e)o(xtra)h(o)o(v)o
(erhead)f(of)h(an)g(une)o(xpected)f(page)h(f)o(ault)f(by)h(ensuring)f
(that)g(all)g(possible)544 5151 y(f)o(aults)f(in)h(the)f(wired)h(area)h
(of)f(memory)f(are)h(resolv)o(ed)f(in)h(adv)n(ance.)p
eop
%%Page: 176 196
176 195 bop 3751 100 a Fs(176)445 249 y Fr(\017)49 b
Fs(The)21 b(memory)g(used)f(to)h(store)g(the)g(k)o(ernel')-5
b(s)21 b(code)h(se)o(gments)d(\(te)o(xt,)i(data,)h(and)f(bss\))g(and)g
(critical)544 398 y(data)h(structures)f(is)h(wired.)29
b(This)22 b(is)f(done)h(to)f(pre)n(v)o(ent)g(the)h(k)o(ernel)g(from)g
(taking)f(an)h(une)o(xpected)544 548 y(page)30 b(f)o(ault)f(in)g(a)h
(critical)f(section)g(of)h(code.)45 b(Also,)30 b(certain)g(parts)f(of)h
(the)g(k)o(ernel)f(such)h(as)f(the)544 697 y(memory)d(that)h(contains)f
(page)h(f)o(ault)g(handlers)f(cannot)h(not)g(be)g(paged)g(out)f(since)h
(this)f(code)i(is)544 847 y(needed)d(to)f(handle)h(future)g(page)g(f)o
(aults.)445 1079 y Fr(\017)49 b Fs(Each)25 b(process)f(on)h(the)f
(system)g(has)g(a)h Fm(proc)f Fs(and)h(a)g Fm(user)f
Fs(structure)g(that)g(store)h(the)f(process')544 1228
y(state.)30 b(The)23 b Fm(user)g Fs(structure)g(contains)f(the)h
(process')h(k)o(ernel)f(stack,)h(signal)e(information,)g(and)544
1378 y(process)29 b(control)g(block.)43 b(These)29 b(three)h(items)e
(are)i(used)f(only)f(when)h(a)h(process)f(is)g(runnable.)544
1527 y(When)22 b(a)h(process)g(is)f(created,)h(its)f
Fm(user)g Fs(structure)g(is)g(wired)h(in)f(pageable)g(k)o(ernel)h
(memory)-6 b(.)29 b(If)544 1677 y(memory)23 b(becomes)h(scarce,)h(a)g
(process)f(can)g(be)h(\223sw)o(apped)f(out.)-7 b(\224)30
b(T)-8 b(o)24 b(sw)o(ap)g(out)g(a)g(process)g(the)544
1826 y(k)o(ernel)29 b(unwires)f(the)g(process')h(user)f(area)i(and)e
(sets)g(a)h(\003ag)g(in)g(the)f(process')h Fm(proc)e
Fs(structure)544 1975 y(that)d(indicates)g(that)h(the)g(process)f(is)h
(sw)o(apped)f(out.)31 b(When)25 b(a)g(sw)o(apped)g(out)f(process)h
(needs)f(to)544 2125 y(be)30 b(run,)i(it)d(must)g(\002rst)i(be)f
(\223sw)o(apped)g(in.)-7 b(\224)47 b(T)-8 b(o)30 b(sw)o(ap)g(in)g(a)h
(process,)g(the)f(k)o(ernel)h(re-wires)f(the)544 2274
y(process')25 b(user)g(area)g(and)g(restores)g(the)g(process')f(sw)o
(ap)h(\003ag)g(in)g(its)f Fm(proc)g Fs(structure.)445
2507 y Fr(\017)49 b Fs(The)25 b Fm(sysctl)f Fs(system)f(call)i(is)g
(used)f(by)h(a)g(process)g(to)g(query)g(the)f(k)o(ernel)h(about)g(some)
f(aspect)544 2656 y(of)g(the)g(operating)f(system.)29
b(The)24 b(k)o(ernel)g(responds)f(to)g(the)h Fm(sysctl)f
Fs(system)g(call)g(by)h(cop)o(ying)544 2805 y(out)31
b(the)g(requested)h(information)e(into)h(a)h(b)n(uf)n(fer)g(pro)o
(vided)e(by)h(the)h(process)f(in)h(the)f(process')544
2955 y(address)22 b(space.)30 b(The)22 b(b)n(uf)n(fer)g(pro)o(vided)e
(by)i(the)g(process)g(may)f(or)h(may)g(not)f(be)h(resident.)30
b(If)22 b(it)g(is)544 3104 y(not)i(resident,)g(then)g(when)h(the)f(k)o
(ernel)h(copies)f(out)g(the)g(data)h(a)g(page)g(f)o(ault)f(may)g(be)h
(generated.)544 3254 y(While)33 b(the)g(f)o(ault)h(is)f(being)g
(serviced)g(the)h(k)o(ernel')-5 b(s)33 b(data)g(may)h(become)f(dated.)
57 b(In)34 b(order)f(to)544 3403 y(pre)n(v)o(ent)f(this)g(and)i(ensure)
f(that)g(the)g(calling)g(process)g(recei)n(v)o(es)g(the)g(freshest)g
(data)h(possible,)544 3552 y(the)27 b(k)o(ernel)f(wires)h(the)g
(process')g(b)n(uf)n(fer)g(before)g(cop)o(ying)f(the)g(data)h(out,)g
(and)g(then)f(unwires)h(it)544 3702 y(once)e(the)g(cop)o(y)f(is)g
(complete.)445 3934 y Fr(\017)49 b Fs(The)38 b(k)o(ernel)g
Fm(physio)e Fs(function)h(is)g(used)h(by)f(the)h(I/O)g(system)e(when)i
(a)g(process)g(reads)g(or)544 4084 y(writes)28 b(to)f(a)i(\223ra)o
(w\224)f(de)n(vice.)41 b(Such)28 b(I/O)g(operations)g(al)o(w)o(ays)g
(mo)o(v)o(e)e(data)i(between)h(the)f(user')-5 b(s)544
4233 y(memory)31 b(and)h(the)g(de)n(vice)f(\(bypassing)g(an)o(y)h
(resident)f(data)h(the)g(k)o(ernel)g(may)g(ha)n(v)o(e)f(cached\).)544
4382 y(In)i(order)g(to)g(perform)g(a)h Fm(physio)e Fs(operation,)i(the)
f(k)o(ernel)g(must)f(ensure)h(that)g(the)g(process')544
4532 y(pro)o(vides)i(resident)g(memory)g(for)h(the)g(I/O)g(operation)f
(and)h(that)g(that)f(memory)g(will)h(not)f(be)544 4681
y(modi\002ed)27 b(or)g(paged)h(out)f(during)g(the)g(I/O)g(operation.)39
b(T)-8 b(o)27 b(ensure)h(this,)f(the)g(k)o(ernel)h(wires)f(the)544
4831 y(user')-5 b(s)22 b(memory)h(before)g(starting)f(the)h(I/O)g
(operation.)30 b(After)23 b(the)g(I/O)g(operation)f(is)h(complete,)544
4980 y(the)i(k)o(ernel)f(unwires)h(the)f(memory)-6 b(.)p
eop
%%Page: 177 197
177 196 bop 3751 100 a Fs(177)583 249 y(There)46 b(are)g(tw)o(o)f(k)o
(ernel)h(interf)o(aces)f(for)h(wiring)e(memory:)71 b
Fm(vslock)p Fs(/)p Fm(vsunlock)42 b Fs(and)300 398 y
Fm(vm)p 426 398 30 4 v 35 w(map)p 641 398 V 36 w(pageable)36
b Fs(\()p Fm(uvm)p 1406 398 V 35 w(map)p 1621 398 V 35
w(pageable)g Fs(in)i(UVM\).)f(The)h Fm(vm)p 2929 398
V 35 w(map)p 3144 398 V 36 w(pageable)e Fs(func-)300
548 y(tion)26 b(tak)o(es)h(a)g(map,)g(a)h(starting)e(virtual)g
(address,)h(an)g(ending)f(virtual)h(address,)g(and)g(a)g(boolean)g(v)n
(alue)300 697 y(that)37 b(indicates)g(whether)h(the)g(speci\002ed)g
(memory)f(should)f(be)i(wired)g(or)g(not.)69 b(In)37
b(BSD)i(VM,)e(the)300 847 y Fm(vslock)21 b Fs(and)i Fm(vsunlock)e
Fs(functions)g(are)j(implemented)d(as)i(calls)f(to)g
Fm(vm)p 2967 847 V 36 w(map)p 3183 847 V 35 w(pageable)p
Fs(.)28 b(The)300 996 y Fm(vslock)64 b Fs(interf)o(ace)j(is)e(only)g
(used)g(by)g Fm(sysctl)g Fs(and)g Fm(physio)p Fs(,)75
b(e)n(v)o(erything)64 b(else)h(uses)300 1145 y Fm(vm)p
426 1145 V 35 w(map)p 641 1145 V 36 w(pageable)p Fs(.)583
1295 y(The)37 b(wiring)f(of)g(memory)g(is)g(counted)g(in)g(tw)o(o)g
(places.)66 b(First,)39 b(each)e Fm(vm)p 3246 1295 V
36 w(page)e Fs(structure)300 1444 y(has)25 b(a)g(wire)h(count.)31
b(If)25 b(this)f(count)h(is)g(greater)g(than)g(zero,)h(then)e(the)h
(page)h(is)e(remo)o(v)o(ed)g(from)h(the)g(page)300 1594
y(queues,)c(thus)f(pre)n(v)o(enting)f(the)i(pagedaemon)f(from)g(paging)
g(out)h(the)f(page.)30 b(Second,)22 b(each)f(map)f(entry)300
1743 y(in)j(a)h(map)f(has)g(a)h(wire)f(count)g(that)g(indicates)g(ho)n
(w)g(man)o(y)f(times)g(the)i(memory)e(mapped)h(by)g(that)g(entry)300
1892 y(has)29 b(been)h(wired.)45 b(Lik)o(e)30 b(other)f(map)g(entry)h
(attrib)n(utes)e(such)h(as)h(protection)f(and)g(inheritance,)i(if)e
(the)300 2042 y(wiring)d(of)g(only)g(a)g(part)h(of)f(memory)g(mapped)f
(by)h(a)h(map)f(entry)g(is)g(changed)h(then)f(a)g(ne)n(w)g(map)g(entry)
300 2191 y(must)e(be)h(allocated)f(and)h(inserted)f(in)h(the)f(map)h
(for)g(that)f(area.)583 2341 y(When)j(an)f(area)h(of)f(memory)f(is)h
(wired,)g(the)g(wire)h(count)e(of)h(the)g(map)g(entry)g(that)g(is)f
(mapping)300 2490 y(the)h(area)i(is)e(incremented.)36
b(If)27 b(the)f(count)g(w)o(as)h(zero,)g(then)g(each)g(page)g(in)f(the)
g(mapped)g(area)i(is)e(made)300 2639 y(resident)c(\(using)g(the)h(f)o
(ault)g(routine\),)f(remo)o(v)o(ed)g(from)h(the)f(page)i(queues,)e(and)
h(the)g(page')-5 b(s)23 b(wire)g(count)300 2789 y(is)j(incremented.)35
b(When)26 b(an)h(area)g(of)g(memory)e(is)h(unwired,)h(the)f(map)g
(entry')-5 b(s)26 b(wire)g(count)g(is)g(decre-)300 2938
y(mented.)59 b(If)35 b(the)f(count)g(reaches)h(zero,)i(then)d(the)g
(wire)h(count)e(on)i(each)g(page)f(on)g(the)g(mapping)g(is)300
3088 y(decremented.)43 b(If)29 b(the)g(page')-5 b(s)29
b(wire)g(count)f(is)h(decremented)g(to)f(zero,)i(then)f(the)g(page)g
(is)f(put)h(on)f(the)300 3237 y(page)23 b(queues)g(so)f(that)h(the)f
(pagedaemon)h(will)f(consider)g(it)h(for)g(pageout)f(if)h(memory)f
(becomes)g(scare.)300 3568 y Ff(8.9.1)119 b(W)n(iring)30
b(and)g(Map)g(Entry)g(Fragmentation)300 3785 y Fs(The)22
b(problem)g(with)f(wiring)h(memory)f(is)h(that)g(it)g(causes)g(map)g
(entry)g(fragmentation.)29 b(The)22 b(more)g(map)300
3934 y(entries)30 b(a)h(map)f(has)g(the)g(more)h(k)o(ernel)f(memory)f
(it)h(tak)o(es)h(and)f(the)g(longer)g(it)g(tak)o(es)g(to)g(search)h
(for)g(a)300 4084 y(mapping.)38 b(Such)28 b(fragmentation)f(occurs)h
(in)f(a)h(number)f(of)h(situations.)38 b(F)o(or)28 b(e)o(xample,)f(the)
h(k)o(ernel')-5 b(s)300 4233 y(map)31 b(gets)f(fragmented)h(due)g(to)f
(process')h Fm(user)f Fs(structure)h(being)f(wired)h(and)g(unwired)f
(as)h(part)g(of)300 4382 y(sw)o(apout.)583 4532 y(User)26
b(process)f(maps)f(also)h(get)g(fragmented)g(due)g(to)g
Fm(sysctl)f Fs(calls)g(\(and)i(to)e(a)i(lesser)f(e)o(xtent)300
4681 y Fm(physio)33 b Fs(I/O)i(operations)e(and)i Fm(mlock)e
Fs(calls\).)60 b(While)34 b(man)o(y)g(programs)g(do)g(not)g(call)g
Fm(sysctl)300 4830 y Fs(directly)-6 b(,)22 b(the)g(BSD)h(C)g(library)e
(mak)o(es)h(use)g(of)h Fm(sysctl)e Fs(to)g(obtain)h(the)g(current)g
(con\002guration)g(of)g(the)300 4980 y(operating)i(system.)p
eop
%%Page: 178 198
178 197 bop 3751 100 a Fs(178)300 249 y Ff(8.9.2)119
b(W)n(iring)30 b(Under)h(UVM)300 466 y Fs(There)f(are)g(tw)o(o)g(main)f
(w)o(ays)g(to)g(a)n(v)n(oid)h(map)f(the)g(entry)h(fragmentation)f
(caused)g(by)h(the)f(wiring)g(and)300 615 y(unwiring)20
b(of)g(memory)-6 b(.)28 b(One)21 b(w)o(ay)g(to)f(a)n(v)n(oid)g(such)h
(fragmentation)e(is)h(to)h(attempt)e(to)i(coalesce)g(adjoin-)300
764 y(ing)j(map)g(entries)g(together)g(when)g(e)n(v)o(er)g(a)g(map)g
(or)h(its)e(attrib)n(utes)h(are)h(modi\002ed.)k(This)24
b(w)o(ould)f(reduce)300 914 y(map)30 b(entry)g(fragmentation)f(caused)h
(by)g(calls)g(such)g(as)h Fm(sysctl)e Fs(that)g(wire)i(memory)-6
b(,)30 b(perform)g(an)300 1063 y(operation,)37 b(and)e(then)g(unwire)g
(memory)-6 b(.)61 b(The)35 b(other)g(w)o(ay)g(to)g(reduce)h(map)f
(entry)g(fragmentation)300 1213 y(is)f(to)f(a)n(v)n(oid)h(it)g(in)f
(the)h(\002rst)h(place.)59 b(UVM)33 b(attempts)g(to)h(a)n(v)n(oid)g
(map)f(entry)h(fragmentation)f(due)h(to)300 1362 y(wiring)29
b(whene)n(v)o(er)g(possible.)43 b(The)29 b(adv)n(antage)g(of)h(a)n(v)n
(oiding)e(map)h(entry)g(fragmentation)g(o)o(v)o(er)g(coa-)300
1511 y(lescing)23 b(map)g(entries)g(is)g(that)g(it)g(is)g(more)g(ef)n
(\002cient)g(and)h(less)f(comple)o(x.)29 b(It)23 b(is)g(more)g(ef)n
(\002cient)h(because)300 1661 y(attempts)g(to)g(coalesce)i(the)e(map)h
(each)h(time)e(the)h(map)f(is)h(touched)f(are)i(not)e(required.)31
b(It)25 b(is)g(less)f(com-)300 1810 y(ple)o(x)g(because)h(the)g(code)g
(needed)g(to)f(manage)h(the)g(coalescing)f(of)h(the)g(map)f(entries)h
(is)f(not)g(needed.)583 1960 y(The)32 b(main)e(reason)h(a)g(map)g
(entry)g(needs)g(to)g(be)g(fragmented)g(when)f(part)h(of)h(the)e
(memory)h(it)300 2109 y(maps)24 b(is)g(wired)h(is)f(to)g(k)o(eep)g
(track)h(of)g(the)f(wiring.)30 b(When)25 b(the)f(area)i(is)e(unwired)g
(and)g(the)h(map)f(entry')-5 b(s)300 2258 y(wire)26 b(count)f(reaches)i
(zero)f(this)f(information)g(allo)n(ws)f(the)i(page')-5
b(s)25 b(state)h(to)f(be)h(restored.)34 b(In)26 b(essence,)300
2408 y(the)k(map)g(is)f(being)h(used)f(to)h(store)g(state)f
(information.)45 b(In)30 b(this)f(case)i(the)f(state)f(information)g
(is)h(that)300 2557 y(\223this)23 b(part)h(of)g(memory)e(is)i(wired.)-7
b(\224)30 b(If)24 b(this)f(state)h(information)e(is)h(stored)g(some)n
(where)g(other)h(than)f(the)300 2707 y(map)31 b(entry)f(then)h(the)g
(map)f(entry')-5 b(s)31 b(wire)g(count)f(does)h(not)f(need)h(to)g(be)g
(changed.)49 b(UVM)30 b(uses)h(this)300 2856 y(approach)25
b(to)f(reduce)i(map)e(entry)h(fragmentation)f(in)g(se)n(v)o(eral)g
(cases:)300 3088 y Fo(pri)o(v)o(ate)h(k)o(er)o(nel)h(memory:)49
b Fs(Pri)n(v)n(ate)26 b(k)o(ernel)g(memory)f(is)h(al)o(w)o(ays)g(wired)
h(and)f(only)g(appears)g(within)544 3238 y(the)35 b(k)o(ernel)h(map.)63
b(BSD)36 b(VM)f(stores)h(the)f(wired)h(state)f(of)h(wired)f(k)o(ernel)h
(memory)f(in)g(both)544 3387 y(the)26 b(k)o(ernel)f(map)h(and)g(the)f
Fm(vm)p 1606 3387 30 4 v 36 w(page)g Fs(structures)g(that)h(are)g
(mapped)g(by)f(the)h(k)o(ernel.)34 b(In)26 b(UVM)544
3537 y(the)h(wired)h(state)f(is)g(only)f(stored)i(in)f(the)g
Fm(vm)p 2108 3537 V 35 w(page)g Fs(structures,)g(reducing)h(k)o(ernel)f
(map)g(entry)544 3686 y(fragmentation.)300 3918 y Fo(pageable)e(k)o(er)
o(nel)h(memory:)49 b Fs(P)o(ageable)36 b(k)o(ernel)f(memory)g(is)g
(used)g(for)h(processes')f Fm(user)g Fs(struc-)544 4068
y(ture.)i(BSD)28 b(VM)e(stores)g(the)h(wired)g(state)g(of)g(a)g
(processes)g Fm(user)f Fs(structure)g(in)h(both)f(a)h(k)o(ernel)544
4217 y(map)j(entry)g(and)h(in)f(the)g(process')h Fm(proc)e
Fs(structures)h(\003ag.)48 b(UVM)30 b(tak)o(es)h(adv)n(antage)f(of)g
(this.)544 4367 y(Since)21 b(the)f(wired)h(state)f(is)g(stored)h(in)f
(the)g Fm(proc)g Fs(structure,)h(there)g(is)f(no)h(need)f(to)h(store)f
(a)h(redun-)544 4516 y(dant)27 b(cop)o(y)g(of)g(the)g(state)g
(information)e(in)i(the)g(k)o(ernel)g(map.)38 b(In)27
b(UVM,)f(instead)h(of)g(fragment-)544 4665 y(ing)j(the)g(k)o(ernel)h
(map)f(the)h(map')-5 b(s)30 b(wire)h(counters)f(are)h(left)g(alone.)48
b(When)31 b(a)g Fm(user)e Fs(structure)544 4815 y(is)e(wired)g(or)g
(unwired)g(both)g(the)g(\003ag)h(in)f(the)g Fm(proc)f
Fs(structure)h(and)h(the)f(wire)g(counters)g(in)g(the)544
4964 y Fm(vm)p 670 4964 V 35 w(page)33 b Fs(structures)h(that)f(map)g
(the)h Fm(user)f Fs(structure)h(are)g(adjusted)f(appropriately)-6
b(.)57 b(This)544 5114 y(also)24 b(reduces)h(k)o(ernel)g(map)g(entry)f
(fragmentation.)p eop
%%Page: 179 199
179 198 bop 3751 100 a Fs(179)300 249 y Fd(sysctl)24
b Fo(and)h Fd(physio)p Fo(:)48 b Fs(In)27 b(both)f(of)i(these)f
(functions,)f(memory)h(is)f(wired,)i(an)f(operation)g(is)g(per)n(-)544
398 y(formed,)21 b(memory)e(is)h(unwired,)h(and)f(the)g(function)g
(returns.)29 b(BSD)21 b(VM)f(stores)g(the)g(wired)g(state)544
548 y(of)g(processes)g(performing)g(these)g(functions)f(in)h(both)g
(the)g(process')g(map,)h(and)f(on)g(the)g(process')544
697 y(k)o(ernel)h(stack.)30 b(In)21 b(UVM)g(the)g(wired)g(state)g(of)g
(memory)g(is)f(only)h(stored)g(on)g(the)g(process')g(k)o(ernel)544
847 y(stack.)30 b(This)24 b(reduces)i(user)e(map)h(entry)g
(fragmentation.)583 1079 y(It)j(should)e(be)h(noted)g(that)g(in)g(UVM,)
f(unlik)o(e)h(in)g(BSD)h(VM,)e(the)i Fm(vslock)e Fs(and)h
Fm(vsunlock)300 1228 y Fs(interf)o(ace)c(used)g(by)g
Fm(sysctl)e Fs(and)i Fm(physio)f Fs(wire)h(memory)f(using)g(the)g
Fm(vm)p 2993 1228 30 4 v 36 w(page)g Fs(structure')-5
b(s)22 b(wire)300 1378 y(counter)j(and)f(do)h(not)f(change)h(map)g
(entries.)583 1527 y(In)34 b(UVM,)f(the)h(only)f(time)g(a)h(map)f
(entry')-5 b(s)33 b(wire)h(counter)g(is)f(used)h(is)f(for)h(the)f
Fm(mlock)g Fs(and)300 1676 y Fm(munlock)38 b Fs(system)g(calls.)75
b(All)39 b(other)g(places)h(that)f(use)g(wired)h(memory)e(store)i(the)f
(wired)g(state)300 1826 y(information)32 b(else)n(where)i(to)g(a)n(v)n
(oid)f(map)h(entry)g(fragmentation.)57 b(As)34 b(a)g(result)f(maps)h
(under)g(UVM)300 1975 y(ha)n(v)o(e)25 b(fe)n(wer)g(entries)f(than)h
(under)f(BSD)i(VM.)300 2359 y Fg(8.10)143 b(Minor)35
b(Mapping)g(Issues)300 2611 y Fs(In)25 b(this)f(section)g(tw)o(o)g
(minor)g(mapping)g(related)h(issues)f(are)h(discussed)f(brie\003y)-6
b(.)300 2942 y Ff(8.10.1)118 b(Buffer)30 b(Map)300 3159
y Fs(In)22 b(BSD)i(VM,)d(the)h(b)n(uf)n(fer)h(map)f(is)g(used)g(to)f
(allocate)i(physical)e(memory)g(for)i(the)f(BSD)h(b)n(uf)n(fer)f
(system)300 3308 y(at)34 b(boot)g(time.)59 b(The)34 b(w)o(ay)g(BSD)i
(VM)e(allocates)g(this)f(memory)h(is)f(quite)h(w)o(asteful.)59
b(A)34 b(b)n(uf)n(fer)h(is)f(a)300 3458 y(\002x)o(ed)29
b(size)g(chunk)f(of)h(virtual)f(memory)g(that)g(is)h(partly)f
(populated)g(with)g(physical)g(memory)-6 b(.)41 b(When)300
3607 y(booting)22 b(the)g(BSD)i(k)o(ernel)f(allocates)g(a)h(number)e
(of)h(b)n(uf)n(fers)g(and)g(partially)f(populates)g(some)h(of)g(them)
300 3757 y(with)h(physical)g(memory)-6 b(.)31 b(Once)25
b(this)f(memory)h(is)g(allocated,)f(it)h(is)g(no)g(longer)g(managed)g
(by)f(the)i(VM)300 3906 y(system)e(\(the)g(b)n(uf)n(fer)h(system)f
(uses)g(an)h(older)g(interf)o(ace)g(inherited)f(from)h(earlier)g(v)o
(ersions)f(of)h(BSD\).)583 4055 y(T)-8 b(o)31 b(allocate)g(b)n(uf)n
(fer)g(memory)-6 b(,)32 b(the)e(BSD)i(VM)f(system)f(allocates)h(a)g
(submap)f(of)h(the)g(k)o(ernel)300 4205 y(map)38 b(at)g(boot)f(time)g
(\()p Fm(buffer)p 1449 4205 V 35 w(map)p Fs(\).)69 b(The)38
b(virtual)g(address)f(space)i(managed)e(by)h(this)f(submap)300
4354 y(is)i(used)g(for)g(the)g(b)n(uf)n(fers.)74 b(The)39
b(entire)g(virtual)g(address)g(space)h(of)f(the)g(submap)f(is)h
(allocated)g(as)300 4504 y(one)33 b(lar)n(ge)h(chunk)f(of)h
(zero-\002ll)g(memory)-6 b(.)55 b(T)-8 b(o)34 b(populate)e(the)i(b)n
(uf)n(fer)f(system)f(with)h(memory)-6 b(,)34 b(BSD)300
4653 y(VM)d(calls)g Fm(vm)p 832 4653 V 35 w(map)p 1047
4653 V 36 w(pageable)e Fs(on)i(parts)g(of)h(the)f(zero-\002ll)h(area)g
(to)f(f)o(ault)g(and)g(wire)h(in)e(physical)300 4802
y(memory)-6 b(.)29 b(Once)c(this)f(is)g(done,)h(the)f(b)n(uf)n(fer)h
(map)g(is)f(ne)n(v)o(er)g(used)g(again)g(\226)h(from)g(then)f(on)g(the)
h(memory)300 4952 y(is)f(managed)h(via)g(the)f(old)g(interf)o(ace.)583
5101 y(The)29 b(problem)f(with)h(this)f(is)g(that)g(the)h(wiring)f(of)h
(the)g(memory)f(with)g Fm(vm)p 3177 5101 V 36 w(map)p
3393 5101 V 35 w(pageable)300 5251 y Fs(leads)34 b(to)f(map)h(entry)g
(fragmentation.)57 b(F)o(or)34 b(e)o(xample,)h(consider)f(a)g(system)f
(with)g(a)h(b)n(uf)n(fer)g(size)g(of)300 5400 y(64KB)29
b(and)g(a)g(small)f(four)h(b)n(uf)n(fer)f(map.)43 b(Assume)28
b(each)h(b)n(uf)n(fer)g(should)e(get)i(populated)f(with)g(16KB)p
eop
%%Page: 180 200
180 199 bop 3751 100 a Fs(180)300 249 y(of)39 b(physical)e(memory)h(at)
h(boot)f(time.)71 b(BSD)40 b(VM)e(w)o(ould)g(\002rst)h(allocate)f(a)h
(256KB)g(submap)f(for)300 398 y(the)30 b(b)n(uf)n(fer)g(map.)46
b(This)30 b(space)g(w)o(ould)f(be)i(di)n(vided)d(into)h(four)i(64KB)f
(chunks.)46 b(Initially)-6 b(,)29 b(the)h(entire)300
548 y(256KB)d(is)f(mapped)g(zero-\002ll)i(with)e(a)h(single)f(map)g
(entry)-6 b(.)36 b(Then)26 b(BSD)i(VM)e(will)g(wire)h(do)n(wn)f(16KB)
300 697 y(in)32 b(each)h(64KB)f(b)n(uf)n(fer)-5 b(.)52
b(The)33 b(results)e(will)g(be)i(a)f(submap)g(with)f(eight)h(map)g
(entries,)h(tw)o(o)f(for)g(each)300 847 y(b)n(uf)n(fer)-5
b(.)30 b(Once)25 b(these)g(map)f(entry)h(structures)f(are)h(allocated)g
(the)o(y)e(are)j(neither)e(freed)i(nor)e(used)h(again.)583
996 y(In)g(UVM)g(there)g(is)f(no)g(longer)h(a)g(b)n(uf)n(fer)f(map.)31
b(Instead,)24 b(a)h(chunk)g(of)f(the)h(k)o(ernel)g(map)f(is)g(allo-)300
1145 y(cated)d(for)g(the)f(b)n(uf)n(fer)h(system.)28
b(Instead)20 b(of)h(using)e Fm(uvm)p 2235 1145 30 4 v
35 w(map)p 2450 1145 V 36 w(pageable)f Fs(to)j(allocate)f(the)h(memory)
-6 b(,)300 1295 y(UVM)25 b(allocates)g(the)g(pages)g(directly)g(and)g
(maps)g(them)g(into)f(the)h(b)n(uf)n(fer)h(area.)33 b(This)25
b(pre)n(v)o(ents)f(UVM)300 1444 y(from)h(w)o(asting)e(map)i(entries)f
(on)h(the)g(b)n(uf)n(fer)f(area.)300 1775 y Ff(8.10.2)118
b(Obsolete)30 b Fb(MAP)p 1416 1775 36 4 v 43 w(FILE)e
Ff(Interface)300 1992 y Fs(The)e Fm(mmap)f Fs(system)g(call)h(supports)
f(tw)o(o)h(types)f(of)h(mappings:)32 b(shared)26 b(\()p
Fm(MAP)p 3057 1992 30 4 v 35 w(SHARED)p Fs(\))f(and)h(cop)o(y-)300
2141 y(on-write)d(\()p Fm(MAP)p 880 2141 V 36 w(PRIVATE)p
Fs(\).)f(These)h(tw)o(o)g(types)g(of)h(mappings)e(are)i(standard)f
([30].)31 b(Unfortunately)-6 b(,)300 2291 y(4.4BSD)31
b(also)e(supports)g(another)h(mapping)f(\003ag:)42 b
Fm(MAP)p 2320 2291 V 35 w(FILE)p Fs(.)30 b(The)g Fm(MAP)p
3015 2291 V 35 w(FILE)g Fs(constant)f(is)h(de-)300 2440
y(\002ned)35 b(to)f(be)h(zero)g(and)g(the)f(type)g(of)h(mapping)e(it)h
(produces)h(depends)f(on)g(what)g(type)h(of)f(object)h(is)300
2590 y(being)30 b(mapped.)48 b(If)31 b(the)g(object)f(is)g(a)h(plain)f
(\002le,)j(then)d(the)h(mapping)e(is)i(cop)o(y-on-write.)47
b(Ho)n(we)n(v)o(er)l(,)300 2739 y(if)35 b(the)g(object)g(is)g(a)h(de)n
(vice,)h(then)e(the)g(mapping)f(is)h(shared.)63 b(Since)35
b Fm(MAP)p 2974 2739 V 36 w(FILE)f Fs(is)h(non-standard)300
2888 y(and)26 b(dependent)f(on)g(the)h(type)f(of)h(\002le)g(being)f
(mapped)g(its)g(use)h(has)g(been)f(depreciated)h(in)g(UVM)f(\(and)300
3038 y(support)f(for)h(it)f(may)h(e)n(v)o(entually)e(be)i(remo)o(v)o
(ed\).)300 3421 y Fg(8.11)143 b(P)o(age)34 b(Flags)300
3674 y Fs(Each)d(page)g(of)g(physical)f(memory)g(that)g(is)h(managed)f
(by)h(the)g(virtual)f(memory)g(system)g(has)g(a)i(cor)n(-)300
3823 y(responding)24 b Fm(vm)p 894 3823 V 36 w(page)g
Fs(structure)h(that)g(contains)g(information)f(about)h(the)g
(allocation)g(of)g(that)g(page.)300 3973 y(As)c(part)g(of)g(that)f
(information,)h(each)g(page)h(has)e(a)i(set)f(of)g(boolean)f(\003ags.)
30 b(In)21 b(the)g(transition)e(from)i(BSD)300 4122 y(VM)k(to)g(UVM)g
(these)h(\003ags)f(were)i(rearranged.)33 b(Initially)-6
b(,)24 b(in)h(BSD)h(VM)g(the)f(page)h(\003ags)f(were)i(stored)300
4271 y(in)i(tw)o(o)f(separate)i(inte)o(ger)e(bit\002elds.)43
b(One)29 b(bit\002eld)g(w)o(as)g(lock)o(ed)g(by)g(the)g(object)f(lock)h
(and)g(the)g(other)300 4421 y(bit\002eld)e(w)o(as)h(lock)o(ed)g(by)g
(the)f(page)h(queues.)40 b(At)28 b(some)f(point)g(in)g(the)h(e)n(v)n
(olution)e(of)i(BSD)h(VM)e(these)300 4570 y(tw)o(o)20
b(bit\002elds)h(were)g(combined)f(into)g(a)h(single)f(inte)o(ger)h
(that)f(had)h(its)f(bits)g(de\002ned)h(as)g(C)h(pre-processor)300
4720 y(symbols.)42 b(This)29 b(w)o(as)g(unfortunate)g(because)g(it)g
(messed)f(up)h(the)h(locking)e(of)h(the)g(bits)f(\(some)h(bits)f(in)300
4869 y(the)35 b(inte)o(ger)f(are)h(lock)o(ed)g(by)f(the)h(object)g(and)
f(others)h(lock)o(ed)f(by)h(the)g(page)g(queues\).)60
b(This)34 b(is)h(not)300 5018 y(currently)25 b(a)g(problem)f(for)h(BSD)
h(VM)f(because)g(\002ne-grain)g(locking)f(is)h(not)f(used.)31
b(Ho)n(we)n(v)o(er)l(,)23 b(if)i(BSD)300 5168 y(is)f(to)g(support)g
(\002ne-grain)h(multiprocessor)e(locking,)h(then)g(the)h(page)f(\003ag)
i(locking)d(w)o(ould)h(become)h(a)300 5317 y(problem.)p
eop
%%Page: 181 201
181 200 bop 3751 100 a Fs(181)583 249 y(In)48 b(UVM)f(the)g(page')-5
b(s)48 b(\003ags)f(ha)n(v)o(e)h(been)f(separated)h(into)f(tw)o(o)g
(inte)o(gers:)75 b Fm(flags)46 b Fs(and)300 398 y Fm(pqflags)p
Fs(.)29 b(The)c Fm(flags)f Fs(\002eld)h(is)f(lock)o(ed)g(by)h(the)f
(object)h(that)f(o)n(wns)g(the)g(page)h(and)g(the)g Fm(pqflags)300
548 y Fs(\002eld)31 b(is)f(lock)o(ed)g(by)h(the)f(page)h(queues.)48
b(Also,)32 b(in)e(UVM)g(some)g(of)h(the)f(\003ags)h(ha)n(v)o(e)g(been)f
(remo)o(v)o(ed.)300 697 y(The)25 b(v)n(alid)e Fm(flags)h
Fs(bits)g(for)h(UVM)g(are:)300 930 y Fd(PG)p 426 930
30 4 v 35 w(BUSY)p Fo(:)48 b Fs(The)36 b(data)f(in)f(the)h(page)g(is)g
(currently)g(in)f(the)h(process)g(of)g(being)g(transfered)g(between)544
1079 y(memory)g(and)g(backing)h(store.)63 b(All)35 b(processes)h(that)f
(wish)g(to)g(access)h(the)g(page)g(must)e(w)o(ait)544
1228 y(until)23 b(the)i(page)g(becomes)g(\223unb)n(usy\224)f(before)h
(accessing)g(the)g(page)g(\(see)g Fm(PG)p 3241 1228 V
35 w(WANTED)p Fs(\).)300 1461 y Fd(PG)p 426 1461 V 35
w(CLEAN)p Fo(:)48 b Fs(The)21 b(page)g(has)g(not)f(been)h(modi\002ed)f
(since)h(it)f(w)o(as)h(loaded)f(from)h(backing)f(store.)29
b(P)o(ages)544 1610 y(that)24 b(are)i(not)e(clean)h(are)h(said)e(to)g
(be)h(\223dirty)-6 b(.)f(\224)300 1843 y Fd(PG)p 426
1843 V 35 w(CLEANCHK)p Fo(:)48 b Fs(The)29 b(clean)g(check)h(\003ag)g
(is)f(used)g(as)g(a)h(hint)e(by)h(the)g(clustering)f(code)i(to)f
(indicate)544 1992 y(if)e(a)g(mapped)f(page)h(has)g(been)g(check)o(ed)g
(to)g(see)g(if)g(it)f(is)g(clean)i(or)f(not.)36 b(If)27
b(the)g(hint)f(is)g(wrong)h(it)544 2141 y(may)c(pre)n(v)o(ent)g
(clustering)g(b)n(ut)h(it)f(will)g(not)g(cause)i(an)o(y)e(problems.)29
b(The)24 b(clean)h(check)f(\003ag)g(is)g(an)544 2291
y(optimization)e(borro)n(wed)j(by)f(UVM)h(from)f(FreeBSD.)300
2523 y Fd(PG)p 426 2523 V 35 w(FAKE)p Fo(:)48 b Fs(The)29
b(f)o(ak)o(e)h(\003ag)f(indicates)f(that)g(a)h(page)g(has)g(been)g
(allocated)f(to)h(an)g(object)f(b)n(ut)g(has)h(not)544
2673 y(yet)k(been)g(\002lled)g(with)f(v)n(alid)g(data.)55
b(UVM)32 b(currently)h(does)g(not)f(use)h(this)f(\003ag)i(for)f(an)o
(ything)544 2822 y(other)25 b(than)f(to)g(assist)g(with)g(deb)n
(ugging.)300 3054 y Fd(PG)p 426 3054 V 35 w(RELEASED)p
Fo(:)48 b Fs(The)33 b(released)g(\003ag)g(indicates)g(that)f(a)h(page)g
(that)g(is)f(currently)h(b)n(usy)f(should)g(be)544 3204
y(freed)24 b(when)g(it)f(becomes)h(unb)n(usy)-6 b(.)28
b(It)c(is)f(the)h(responsibility)d(of)j(the)g(process)f(that)h(set)f
(the)h(b)n(usy)544 3353 y(\003ag)h(to)g(check)g(the)g(released)g
(\003ag)g(when)g(unb)n(usying)e(the)i(page.)300 3586
y Fd(PG)p 426 3586 V 35 w(TABLED)p Fo(:)48 b Fs(The)30
b(tabled)g(\003ag)g(indicates)g(that)f(the)h(page)g(is)g(currently)f
(part)h(of)h(the)e(object/of)n(fset)544 3735 y(hash)k(table.)58
b(When)34 b(a)g(page)g(that)g(is)f(tabled)h(is)f(freed,)k(it)c(is)h
(remo)o(v)o(ed)e(from)i(the)g(hash)f(table)544 3884 y(before)25
b(being)f(added)h(to)g(the)f(free)i(list.)300 4117 y
Fd(PG)p 426 4117 V 35 w(WANTED)p Fo(:)48 b Fs(The)31
b(w)o(anted)g(\003ag)h(is)e(set)h(on)g(a)g(b)n(usy)g(page)g(to)g
(indicate)f(that)h(a)h(process)e(is)h(w)o(aiting)544
4266 y(for)26 b(the)g(page)g(to)f(become)h(unb)n(usy)f(so)h(that)f(it)g
(can)i(access)f(it.)34 b(When)26 b(the)f(process)h(that)g(set)f(the)544
4416 y(b)n(usy)30 b(\003ag)h(on)g(the)f(page)h(clears)g(it,)h(it)e
(must)g(check)h(the)f(w)o(anted)h(\003ag.)49 b(If)31
b(the)g(w)o(anted)f(\003ag)i(is)544 4565 y(set,)24 b(then)h(it)f(must)g
(issue)g(a)h(w)o(ak)o(eup)g(call)g(to)f(w)o(ak)o(eup)h(the)f(process)h
(w)o(aiting)f(for)h(the)g(page.)300 4797 y(In)30 b(addition)f(to)h
(these)g(\003ags)g(there)g(are)h(\002)n(v)o(e)f(additional)e(page)j
(\003ags)f(that)g(appear)g(in)g(BSD)h(VM)f(that)300 4947
y(should)25 b(no)i(longer)f(be)h(used:)33 b Fm(PG)p 1491
4947 V 36 w(FICTITIOUS)p Fs(,)24 b Fm(PG)p 2296 4947
V 35 w(FAULTING)p Fs(,)h Fm(PG)p 2981 4947 V 36 w(DIRTY)p
Fs(,)g Fm(PG)p 3487 4947 V 35 w(FILLED)p Fs(,)300 5096
y(and)j Fm(PG)p 598 5096 V 35 w(LAUNDRY)p Fs(.)f(The)h(elimination)e
(of)i(the)f Fm(PG)p 2150 5096 V 36 w(FICTITIOUS)e Fs(\003ag)k(for)f(de)
n(vice)g(pages)g(UVM)300 5246 y(w)o(as)36 b(described)f(earlier)h(in)f
(Section)h(8.4.)63 b(The)35 b Fm(PG)p 2174 5246 V 36
w(FAULTING)e Fs(\003ag)k(is)e(used)g(by)g(BSD)i(VM)e(for)300
5395 y(deb)n(ugging)22 b(the)g(sw)o(ap)h(pager)g(and)g(is)g(not)f
(applicable)h(to)f(UVM.)g(BSD)i(VM)f(uses)f(the)h(dirty)f(and)h
(\002lled)p eop
%%Page: 182 202
182 201 bop 3751 100 a Fs(182)300 249 y(\003ags)27 b(for)f(deb)n
(ugging)f(by)h(the)g(I/O)g(system.)34 b(This)26 b(usage)g(should)f(be)i
(discontinued)d(because)j(the)f(I/O)300 398 y(system)i(does)h(not)f
(obtain)g(the)h(proper)g(locks)f(before)i(accessing)f(the)f(\003ags)i
(and)f(thus)f(could)g(corrupt)300 548 y(the)f(\003ags)g(if)f
(\002ne-grain)h(locking)f(is)g(in)h(use.)36 b(The)27
b(laundry)f(\003ag)h(is)f(used)h(by)f(BSD)i(VM)e(to)h(indicate)f(a)300
697 y(dirty)e(inacti)n(v)o(e)f(page)1037 661 y Fj(4)1075
697 y Fs(.)31 b(This)24 b(\003ag)h(is)f(not)h(needed)g(by)f(UVM.)583
847 y(Note)e(that)f(functions)g(that)g(set)g(and)h(clear)g(the)g(b)n
(usy)f(bit)g(of)h(a)g(page)f(need)h(to)g(check)g(the)f(w)o(anted)300
996 y(and)32 b(released)g(bits)f(only)g(if)h(the)g(object)g(that)f(o)n
(wns)g(the)h(page)g(w)o(as)g(unlock)o(ed)f(while)g(the)h(page)g(w)o(as)
300 1145 y(b)n(usy)-6 b(.)34 b(If)27 b(the)f(object)g(w)o(as)g(not)g
(unlock)o(ed)g(while)g(the)g(page)g(w)o(as)h(b)n(usy)-6
b(,)25 b(then)h(no)g(other)g(process)h(could)300 1295
y(step)d(in)h(and)g(set)f(the)h(w)o(anted)f(or)h(released)h(bits)d
(because)j(the)o(y)e(are)h(protected)g(by)f(the)h(object')-5
b(s)24 b(lock.)583 1444 y(The)h(v)n(alid)f Fm(pqflags)f
Fs(are:)300 1677 y Fd(PQ)p 426 1677 30 4 v 35 w(ACTIVE)p
Fo(:)48 b Fs(The)25 b(page)g(is)f(on)h(the)f(acti)n(v)o(e)g(page)h
(queue.)300 1909 y Fd(PQ)p 426 1909 V 35 w(ANON)p Fo(:)48
b Fs(The)25 b(page)g(is)g(part)f(of)h(an)g(anon.)300
2141 y Fd(PQ)p 426 2141 V 35 w(AOBJ)p Fo(:)48 b Fs(The)25
b(page)g(is)g(part)f(of)h(a)h(aobj)e Fm(uvm)p 2000 2141
V 35 w(object)p Fs(.)300 2374 y Fd(PQ)p 426 2374 V 35
w(FREE)p Fo(:)48 b Fs(The)27 b(page)g(is)f(on)h(the)f(free)i(page)e
(list.)36 b(If)27 b Fm(PQ)p 2340 2374 V 35 w(FREE)f Fs(is)g(set,)h
(then)f(all)h(other)f(page)h(queue)544 2523 y(\003ags)e(must)f(be)h
(clear)-5 b(.)300 2756 y Fd(PQ)p 426 2756 V 35 w(INACTIVE)p
Fo(:)48 b Fs(The)24 b(page)h(is)g(on)f(the)h(inacti)n(v)o(e)e(page)i
(queue.)300 2988 y Fd(PQ)p 426 2988 V 35 w(SWAPBACKED)p
Fo(:)47 b Fs(The)52 b(page)h(is)e(back)o(ed)i(by)f(the)g(sw)o(ap)g
(area,)59 b(and)53 b(thus)e(must)g(be)h(either)544 3137
y Fm(PQ)p 670 3137 V 35 w(ANON)36 b Fs(or)h Fm(PQ)p 1221
3137 V 35 w(AOBJ)f Fs(\(and)h(in)f(f)o(act,)k(this)c(\003ag)h(is)f
(de\002ned)i(as)e(the)h(logical-or)f(of)h(those)544 3287
y(tw)o(o)24 b(\003ags\).)300 3670 y Fg(8.12)143 b(VM)35
b(System)g(Startup)300 3923 y Fs(In)26 b(this)f(section)g(the)h
(initialization)e(of)i(the)f(VM)h(system)f(at)h(system)e(startup)i
(time)f(is)g(described.)34 b(The)300 4072 y(k)o(ernel)21
b(is)f(loaded)g(into)g(memory)g(by)g(a)h(lo)n(w)f(le)n(v)o(el)f
(bootstrap)h(program.)29 b(Once)21 b(loaded,)g(it)f(is)g(e)o(x)o
(ecuted.)300 4222 y(When)26 b(the)f(k)o(ernel)h(\002rst)g(starts)f(the)
g(VM)h(system)e(has)i(not)f(been)h(initialized)e(and)i(is)f(not)g(a)n
(v)n(ailable)g(for)300 4371 y(usage.)58 b(The)34 b(k)o(ernel)g(must)e
(initialize)h(the)h(k)o(ernel)g(en)l(vironment)e(enough)h(to)h(call)g
(the)f(VM)h(startup)300 4521 y(function)24 b(\()p Fm(vm)p
816 4521 V 36 w(mem)p 1032 4521 V 35 w(init)g Fs(in)g(BSD)i(VM,)e
Fm(uvm)p 2042 4521 V 35 w(init)g Fs(in)h(UVM\).)300 4852
y Ff(8.12.1)118 b(Bef)m(or)n(e)30 b(VM)g(Startup:)38
b(Ph)n(ysical)30 b(Memory)f(Con\002guration)300 5068
y Fs(Before)f(the)f(VM)g(system)f(is)h(started,)g(the)g(k)o(ernel)g
(needs)g(to)g(determine)g(se)n(v)o(eral)f(pieces)h(of)g(informa-)300
5218 y(tion.)35 b(First,)27 b(it)f(must)f(determine)h(ho)n(w)g(the)g
(physical)g(memory)f(is)i(con\002gured.)36 b(Older)26
b(systems)f(ha)n(v)o(e)p 300 5307 1440 4 v 416 5369 a
Fi(4)449 5399 y Fh(This)c(\003ag)f(is)h(not)f(well)h(documented)c(\227)
k(it)g(may)f(ha)n(v)o(e)f(other)h(uses)p eop
%%Page: 183 203
183 202 bop 3751 100 a Fs(183)300 249 y(contiguous)28
b(physical)g(memory)-6 b(.)42 b(Ne)n(wer)30 b(systems)d(ha)n(v)o(e)i
(non-contiguous)f(physical)g(memory)-6 b(.)42 b(On)300
398 y(these)36 b(ne)n(w)f(systems)g(the)g(blocks)h(of)g(physical)e
(memory)h(often)h(correspond)g(to)f(memory)g(module)300
548 y(sized)25 b(chunks.)583 697 y(The)h(original)e(v)o(ersion)g(of)h
(the)g(BSD)g(VM)g(system)f(only)g(handled)h(systems)e(with)i
(contiguous)300 847 y(physical)32 b(memory)-6 b(.)56
b(If)34 b(a)g(system)f(such)g(as)h(a)g(Sparc1)g(w)o(as)g(to)f(run)h
(BSD,)g(then)g(it)f(had)g(to)h(emulate)300 996 y(a)i(system)f(with)g
(physical)f(contiguous)g(memory)h(in)g(the)h(machine-dependent)f(layer)
h(of)f(the)h(code)300 1145 y(\(and)26 b(in)g(f)o(act)g(the)g(sparc)g
(4.4BSD)g(port)g(does)f(this\).)34 b(Later)26 b(v)o(ersions)e(of)i(BSD)
h(directly)e(support)g(non-)300 1295 y(contiguous)38
b(memory)g(through)g(the)h Fm(MACHINE)p 2084 1295 30
4 v 34 w(NONCONTIG)f Fs(interf)o(ace.)74 b(Unfortunately)-6
b(,)41 b(this)300 1444 y(interf)o(ace)35 b(is)e(dif)n(ferent)h(from)f
(the)h(def)o(ault)g(interf)o(ace)h(and)f(the)f(BSD)i(VM)f(code)g(has)g
(tw)o(o)f(dif)n(ferent)300 1594 y(code)24 b(paths)f(for)h(physical)e
(memory)h(management.)29 b(One)24 b(of)f(the)h(code)g(paths)f(is)g
(selected)g(at)h(compile)300 1743 y(time)g(\(using)g(a)h(C)h
(pre-processor)f(de\002ne\).)31 b(Both)25 b(interf)o(aces)g(are)g
(brie\003y)g(described)g(belo)n(w)-6 b(.)300 2038 y Fo(Contiguous)25
b(Memory)300 2255 y Fs(If)k(the)f Fm(MACHINE)p 971 2255
V 35 w(NONCONTIG)e Fs(symbol)h(is)h(not)g(de\002ned)h(for)g(the)f(C)h
(pre-processor)g(then)f(the)h(old)300 2404 y(contiguous)24
b(physical)g(memory)h(interf)o(ace)h(is)f(selected.)32
b(T)-8 b(o)26 b(use)f(this)g(interf)o(ace,)h(a)g(process)f(must)f(set)
300 2554 y(up)i(four)h(global)f(v)n(ariables)f(before)i(calling)f
Fm(vm)p 1983 2554 V 36 w(mem)p 2199 2554 V 35 w(init)p
Fs(.)35 b(The)26 b(v)n(ariables)g(are)h Fm(avail)p 3547
2554 V 35 w(start)p Fs(,)300 2703 y Fm(avail)p 606 2703
V 35 w(end)p Fs(,)21 b Fm(virtual)p 1287 2703 V 35 w(avail)p
Fs(,)g(and)g Fm(virtual)p 2253 2703 V 35 w(end)p Fs(.)29
b(These)21 b(v)n(ariables)g(de\002ne)h(the)g(start)f(and)300
2852 y(end)j(of)f(a)n(v)n(ailable)g(physical)g(memory)-6
b(,)22 b(and)i(the)f(start)g(and)h(end)g(of)f(a)n(v)n(ailable)g(k)o
(ernel)h(virtual)f(memory)300 3002 y(\(respecti)n(v)o(ely\).)300
3297 y Fo(Non-contiguous)j(Memory)300 3513 y Fs(If)41
b(the)f Fm(MACHINE)p 995 3513 V 34 w(NONCONTIG)e Fs(symbol)h(is)g
(de\002ned)i(in)f(the)g(C)g(pre-processor)h(then)e(the)h(non-)300
3663 y(contiguous)28 b(physical)h(memory)g(interf)o(ace)h(is)g
(selected.)46 b(The)30 b(non-contig)e(interf)o(ace)j(is)e(de\002ned)h
(by)300 3812 y(se)n(v)o(eral)24 b(functions:)300 4045
y Fd(pmap)p 546 4045 V 35 w(virtual)p 1001 4045 V 34
w(space)p Fo(:)48 b Fs(returns)38 b(v)n(alues)f(that)g(indicate)g(the)h
(range)g(of)g(k)o(ernel)g(virtual)f(space)544 4194 y(that)24
b(is)h(a)n(v)n(ailable)f(for)h(use)f(by)h(the)g(VM)f(system.)300
4426 y Fd(pmap)p 546 4426 V 35 w(free)p 821 4426 V 35
w(pages)p Fo(:)48 b Fs(returns)24 b(the)h(number)f(of)h(pages)g(that)f
(are)i(currently)e(free.)300 4659 y Fd(pmap)p 546 4659
V 35 w(next)p 821 4659 V 35 w(page)p Fo(:)48 b Fs(returns)28
b(the)g(physical)f(address)h(of)h(the)f(ne)o(xt)f(free)i(page)g(of)f(a)
n(v)n(ailable)g(mem-)544 4808 y(ory)-6 b(.)300 5041 y
Fd(pmap)p 546 5041 V 35 w(page)p 821 5041 V 35 w(index)p
Fo(:)48 b Fs(gi)n(v)o(en)21 b(a)h(physical)f(address,)i(return)g(the)f
(inde)o(x)f(of)i(the)f(page)h(in)f(the)g(array)h(of)544
5190 y Fm(vm)p 670 5190 V 35 w(page)h Fs(structures.)p
eop
%%Page: 184 204
184 203 bop 3751 100 a Fs(184)300 249 y Fd(pmap)p 546
249 30 4 v 35 w(steal)p 881 249 V 35 w(memory)p Fo(:)47
b Fs(allocates)36 b(memory)-6 b(.)64 b(This)36 b(allocator)g(can)g(be)h
(used)f(only)f(before)i(the)544 398 y(VM)24 b(system)g(is)g(started.)
300 730 y Ff(8.12.2)118 b(UVM')l(s)30 b(Ph)n(ysical)g(Memory)f
(Con\002guration)i(Interface)300 946 y Fs(The)39 b(tw)o(o)f(interf)o
(aces)h(supported)f(by)h(BSD)g(VM)g(are)g(quite)f(dif)n(ferent)h(and)g
(require)g(a)g(number)f(of)300 1096 y(C)43 b Fm(ifdef)f
Fs(statements)g(in)g(the)h(BSD)g(VM)f(source)h(code.)85
b(In)43 b(order)g(to)f(address)h(this)f(problem)300 1245
y(UVM)g(pro)o(vides)f(a)i(ne)n(w)f(physical)f(memory)h(con\002guration)
g(interf)o(ace)h(that)f(supports)f(all)h(phys-)300 1394
y(ical)f(memory)g(con\002gurations)f(with)h(a)g(single)g(uni\002ed)g
(interf)o(ace.)81 b(UVM')-5 b(s)40 b(interf)o(ace)i(is)f(called)300
1544 y Fm(MACHINE)p 726 1544 V 34 w(NEW)p 940 1544 V
35 w(NONCONTIG)p Fs(,)c(or)i(MNN)f(for)h(short.)72 b(MNN)39
b(supports)e(both)h(contiguous)f(and)300 1693 y(non-contiguous)21
b(physical)g(memory)-6 b(,)22 b(and)g(its)g(support)g(of)h(contiguous)e
(memory)g(has)i(no)f(e)o(xtra)h(o)o(v)o(er)n(-)300 1843
y(head)i(o)o(v)o(er)f(the)h(old)f(interf)o(ace.)583 1992
y(In)g(MNN,)e(physical)g(memory)g(is)g(managed)h(using)f(a)h
(statically-allocated)f(array)i(of)f(memory)300 2141
y(se)o(gment)c(descriptors.)29 b(The)20 b(maximum)f(number)g(of)i
(these)f(se)o(gments)f(is)h(de\002ned)h(when)f(the)g(k)o(ernel)h(is)300
2291 y(compiled.)31 b(F)o(or)25 b(systems)f(with)g(contiguous)g(memory)
g(the)h(number)g(of)g(entries)g(in)g(this)f(array)i(is)f(sim-)300
2440 y(ply)k(one.)45 b(F)o(or)30 b(non-contiguous)d(systems)h(the)i
(number)f(of)h(entries)f(is)g(hardw)o(are)h(dependent.)45
b(Each)300 2590 y(entry)26 b(in)f(the)h(array)g(identi\002es)f(the)h
(start)g(and)f(end)h(of)g(the)g(re)o(gion)f(of)h(physical)e(memory)h
(it)g(describes)300 2739 y(and)31 b(contains)f(pointers)g(to)g(an)h
(array)h(of)f Fm(vm)p 1899 2739 V 35 w(page)f Fs(structures)g(for)i
(that)e(memory)-6 b(.)47 b(The)31 b(machine-)300 2888
y(dependent)c(pmap)g(module)g(is)g(also)g(allo)n(wed)g(to)g(place)h
(some)f(machine-dependent)f(information)g(in)300 3038
y(this)e(array)-6 b(.)583 3187 y(One)31 b(common)e(operation)h
(performed)g(by)g(the)g(VM)g(system)f(is)h(looking)f(up)h(the)g
Fm(vm)p 3631 3187 V 36 w(page)300 3337 y Fs(structure)36
b(for)g(a)g(physical)f(address.)63 b(T)-8 b(o)36 b(do)g(this)f(under)h
(MNN,)f(the)h(array)g(of)g(physical)f(memory)300 3486
y(se)o(gments)30 b(must)g(be)h(searched.)51 b(MNN)31
b(allo)n(ws)f(the)h(search)h(to)f(be)h(optimized)e(based)h(on)g(the)g
(lik)o(ely)300 3635 y(physical)22 b(memory)h(con\002guration)g(of)h
(the)f(system.)30 b(F)o(or)23 b(systems)f(with)h(contiguous)f(physical)
h(mem-)300 3785 y(ory)29 b(no)g(search)h(is)f(necessary:)39
b(the)29 b(desired)g(page)h(is)f(either)g(in)g(the)g(\002rst)g(entry)g
(of)g(the)h(array)g(or)f(it)g(is)300 3934 y(not)g(a)h(v)n(alid)e
(managed)i(page.)45 b(Thus,)30 b(for)f(contiguous)f(systems)g(no)i
(search)g(code)f(is)h(compiled)e(into)300 4084 y(the)21
b(k)o(ernel.)30 b(F)o(or)22 b(non-contiguous)d(systems)h(MNN)h(pro)o
(vides)g(se)n(v)o(eral)f(search)i(algorithms)e(to)h(choose)300
4233 y(from:)300 4465 y Fo(random:)50 b Fs(The)25 b(array)i(of)f
(physical)e(memory)h(se)o(gments)f(is)i(stored)f(in)g(random)h(order)g
(and)g(searched)544 4615 y(linearly)e(for)h(the)g(requested)g(page.)300
4847 y Fo(bsear)n(ch:)50 b Fs(The)29 b(array)g(of)g(physical)e(memory)h
(se)o(gments)f(is)h(sorted)h(by)f(physical)f(address)i(and)f(a)h(bi-)
544 4997 y(nary)c(search)g(is)g(used)f(to)g(\002nd)h(the)g(correct)g
(entry)-6 b(.)p eop
%%Page: 185 205
185 204 bop 3751 100 a Fs(185)300 249 y Fo(big\002rst:)49
b Fs(The)24 b(array)g(of)g(physical)e(memory)g(se)o(gments)g(is)h
(sorted)g(by)g(the)h(size)f(of)h(memory)e(se)o(gment)544
398 y(and)33 b(searched)g(linearly)-6 b(.)53 b(This)32
b(is)g(useful)h(for)g(systems)e(lik)o(e)h(the)h(i386)f(that)g(ha)n(v)o
(e)g(one)h(small)544 548 y(chunk)24 b(of)h(physical)f(memory)g(and)g
(one)h(lar)n(ge)g(chunk.)300 775 y(MNN)f(encapsulates)h(these)f
(options)g(into)g(a)h(single)f(function)g(with)g(the)g(follo)n(wing)f
(prototype:)300 1003 y Fm(int)59 b(vm_physseg_find\(vm_offset_t)54
b(phys_addr,)j(int)i(*offset\);)300 1230 y Fs(This)28
b(function)f(returns)h(the)g(inde)o(x)g(of)g(the)h(entry)f(in)g(the)g
(array)h(of)f(physical)g(memory)f(se)o(gments)g(for)300
1379 y(the)32 b(speci\002ed)g(physical)f(address)h(\(or)g(it)g(returns)
g Fr(\000)p Fa(1)g Fs(if)g(the)g(physical)f(address)h(is)f(not)h(v)n
(alid\).)51 b(The)300 1529 y(\223of)n(fset\224)25 b(is)f(the)h(of)n
(fset)f(in)g(the)h(se)o(gment)f(for)h(the)f(gi)n(v)o(en)g(physical)f
(address.)583 1678 y(When)33 b(a)f(system)f(using)g(MNN)h(is)f
(booting,)i(before)f(calling)g(the)g(VM)f(startup)h(function,)h(it)300
1828 y(must)e(\002rst)i(load)f(a)g(description)f(of)i(physical)e
(memory)g(into)h(the)g(array)h(of)f(physical)f(memory)h(se)o(g-)300
1977 y(ments.)61 b(This)34 b(is)h(done)g(with)f(the)h
Fm(uvm)p 1723 1977 30 4 v 35 w(page)p 1998 1977 V 35
w(physload)f Fs(function.)61 b(This)34 b(function)g(tak)o(es)h(the)300
2126 y(starting)e(and)h(ending)f(physical)g(addresses)g(of)i(a)f(se)o
(gment)e(of)i(physical)f(memory)g(and)h(inserts)f(the)300
2276 y(se)o(gment)f(into)g(the)i(array)-6 b(,)35 b(maintaining)d(the)h
(requested)g(sorting)f(order)-5 b(.)56 b(This)33 b(single)f(function)g
(re-)300 2425 y(places)25 b(the)g(tw)o(o)f(older)h(interf)o(aces)g
(supported)e(by)i(BSD)h(VM.)300 2755 y Ff(8.12.3)118
b(UVM)31 b(Startup)g(Pr)n(ocedur)n(e)300 2972 y Fs(Once)39
b(physical)f(memory)g(has)h(been)g(loaded)g(into)f(the)h(VM)f(system)g
(using)g(the)h(MNN)g(interf)o(ace)300 3121 y(then)33
b(the)g Fm(uvm)p 846 3121 V 35 w(init)f Fs(function)g(can)i(be)f
(called)g(to)g(bring)f(up)h(the)g(rest)g(of)g(the)g(VM)g(system.)54
b(This)300 3271 y(function)38 b(is)h(called)g(as)h(part)f(of)g(the)h(k)
o(ernel')-5 b(s)38 b Fm(main)h Fs(function.)73 b(UVM)39
b(is)g(brought)f(up)h(in)g(eight)300 3420 y(steps.)j(First,)30
b(UVM')-5 b(s)28 b(global)g(data)h(structures)g(are)g(initialized.)42
b(Second,)30 b(the)f(page)g(sub-system)f(is)300 3570
y(brought)f(up.)40 b(This)27 b(includes)g(initializing)f(the)i(page)g
(queues,)h(allocating)e Fm(vm)p 3072 3570 V 35 w(page)g
Fs(structures)h(for)300 3719 y(a)n(v)n(ailable)33 b(physical)g(memory)g
(and)g(placing)h(them)f(on)h(the)f(free)i(list.)57 b(Third,)35
b(the)f(k)o(ernel')-5 b(s)33 b(pri)n(v)n(ate)300 3868
y(pool)27 b(of)g(statically)g(allocated)g(map)g(entries)g(is)g(set)h
(up.)38 b(F)o(ourth,)27 b(the)h(k)o(ernel')-5 b(s)27
b(virtual)f(memory)h(data)300 4018 y(structures,)c(including)f(the)h(k)
o(ernel')-5 b(s)22 b(map)h(and)h(submaps,)e(and)h(the)g(k)o(ernel)g
(object)g(are)h(allocated)f(and)300 4167 y(initialized.)29
b(Fifth,)23 b(the)h(machine-dependent)e Fm(pmap)p 2191
4167 V 35 w(init)h Fs(function)f(is)h(called)h(to)f(allo)n(w)f(the)i
(pmap)300 4317 y(to)c(do)h(an)o(y)f(last)h(minute)f(setup)g(before)h
(the)g(rest)g(of)g(the)g(VM)f(system)g(is)g(brought)g(up.)29
b(Sixth,)21 b(the)g(k)o(ernel)300 4466 y(memory)28 b(allocator)g(\()p
Fm(malloc)p Fs(\))f(is)h(initialized.)40 b(Se)n(v)o(enth,)28
b(the)g(pagers)h(are)g(initialized.)40 b(Finally)-6 b(,)28
b(an)300 4615 y(initial)23 b(pool)h(of)h(free)h(anons)e(is)h
(allocated.)30 b(At)25 b(this)f(point)f(the)i(VM)f(system)g(is)g
(operational.)300 4998 y Fg(8.13)143 b(New)34 b(Pmap)h(Interface)300
5251 y Fs(UVM)i(supports)f(both)h(the)g(BSD)i(VM)e(pmap)g(API)h(and)f
(a)h(ne)n(w)f(modi\002ed)g(pmap)g(API.)h(The)g(ne)n(w)300
5400 y(pmap)29 b(API,)i(called)f Fm(PMAP)p 1281 5400
V 35 w(NEW)p Fs(,)f(is)h(required)g(if)g(page)g(loanout)f(to)h(the)g(k)
o(ernel)g(is)f(to)h(be)g(supported)p eop
%%Page: 186 206
186 205 bop 3751 100 a Fs(186)300 249 y(\(otherwise)32
b(such)g(loanouts)f(will)g(al)o(w)o(ays)h(f)o(ail\).)53
b(The)32 b(pmap)g(API)h(w)o(as)f(changed)g(in)g(\002)n(v)o(e)g(areas)h
(for)300 398 y Fm(PMAP)p 546 398 30 4 v 35 w(NEW)p Fs(.)24
b(These)h(changes)g(are)g(described)g(belo)n(w)-6 b(.)300
730 y Ff(8.13.1)118 b(P)o(age)30 b(Functions)300 946
y Fs(The)f(pmap)f(API)h(has)g(se)n(v)o(eral)f(functions)g(that)g
(operate)h(on)g(all)f(mappings)g(of)g(a)i(managed)e(page.)43
b(\(A)300 1096 y(managed)32 b(page)h(is)f(one)g(that)g(has)g(a)h
Fm(vm)p 1738 1096 V 35 w(page)f Fs(structure)g(and)g(is)g(used)g(by)h
(the)f(VM)g(system.\))52 b(An)300 1245 y(e)o(xample)29
b(of)h(such)g(a)g(function)f(is)g Fm(pmap)p 1770 1245
V 35 w(page)p 2045 1245 V 35 w(protect)p Fs(,)h(a)g(function)f(that)h
(sets)f(the)h(protection)300 1394 y(on)j(all)f(mappings)g(of)h(a)g
(page.)56 b(This)32 b(function)g(is)h(used)g(to)f(write)h(protect)g
(all)f(acti)n(v)o(e)g(mappings)g(of)300 1544 y(a)k(page.)65
b(Other)36 b(such)g(functions)f(include)g(functions)g(that)h(query)g
(and)g(clear)h(the)f(referenced)h(and)300 1693 y(modi\002ed)31
b(bits)f(of)h(a)h(page.)50 b(In)31 b(order)h(to)f(support)f(such)h
(functions,)h(the)f(pmap)g(module)f(must)g(k)o(eep)300
1843 y(track)37 b(of)h(all)f(pmap)f(structures)h(that)g(reference)i(a)e
(page.)68 b(T)-8 b(ypically)37 b(this)f(is)h(done)g(with)f(a)i(list)e
(of)300 1992 y(mappings)23 b(for)i(each)h(page.)31 b(Each)25
b(managed)f(page)h(has)g(its)f(o)n(wn)g(list)g(of)h(acti)n(v)o(e)f
(mappings.)583 2141 y(In)35 b(the)g(current)g(pmap)f(API,)h(functions)f
(that)g(perform)h(operations)f(on)g(all)h(mappings)e(of)i(a)300
2291 y(page)25 b(tak)o(e)h(the)f(physical)f(address)h(of)g(the)g(page)g
(as)h(one)f(of)g(their)g(ar)n(guments.)31 b(The)25 b(physical)f
(address)300 2440 y(of)f(a)g(page)g(is)g(determined)f(through)g(the)g
Fm(vm)p 1848 2440 V 36 w(page)g Fs(structure')-5 b(s)22
b Fm(phys)p 2824 2440 V 35 w(addr)g Fs(\002eld.)30 b(Thus,)23
b(to)f(write)300 2590 y(protect)j(all)f(mappings)f(of)i(a)g(page,)g
(one)g(w)o(ould)f(use:)300 2822 y Fm(pmap_page_protect\(page->phys_)o
(addr,)53 b(VM_PROT_READ\);)300 3054 y Fs(In)31 b(order)h(to)f(process)
g(this,)h(the)f(pmap)g(module)f(must)g(look)h(up)g(the)g(physical)f
(address)h(in)g(the)g(table)300 3204 y(of)d(managed)g(pages)g(to)g
(determine)f(what)h Fm(vm)p 1934 3204 V 35 w(page)g Fs(the)g(physical)e
(page)j(belongs)e(to)g(so)h(the)g(list)f(of)300 3353
y(mappings)h(for)h(that)g(page)h(can)f(be)h(tra)n(v)o(ersed.)44
b(If)30 b(the)f(page)g(is)g(not)g(a)g(managed)h(page,)g(then)f(there)h
(is)300 3503 y(no)25 b(such)f(list)g(and)h(no)f(action)g(is)h
(performed.)583 3652 y(The)k(current)f(procedure)h(is)f(w)o(asteful)g
(because)g(the)h(function)e(calling)h(the)g(pmap)g(page)g(pro-)300
3801 y(tection)22 b(function)g(kno)n(ws)g(the)h Fm(vm)p
1501 3801 V 35 w(page)g Fs(structure)f(for)i(the)f(page,)g(b)n(ut)f
(does)h(not)g(pass)f(this)g(informa-)300 3951 y(tion)28
b(to)g(the)h(pmap)f(module.)42 b(This)28 b(forces)h(the)g(pmap)f
(module)g(to)g(do)g(a)i(page)f(lookup)e(to)i(determine)300
4100 y(the)e(identity)e(of)i(the)g(physical)f(address')h(page.)37
b(In)27 b(the)g(ne)n(w)g(pmap)f(interf)o(ace,)i(these)f(functions)f
(tak)o(e)300 4250 y(a)32 b(pointer)f(to)g(a)h Fm(vm)p
1001 4250 V 35 w(page)f Fs(structure)g(rather)h(than)f(a)h(physical)e
(address)h(so)g(that)g(this)g(e)o(xtra)g(lookup)300 4399
y(operation)24 b(can)h(be)g(a)n(v)n(oided.)300 4730 y
Ff(8.13.2)118 b(K)m(er)n(nel)31 b(Pmap)f(Enter)g(Functions)300
4947 y Fs(Pmap)h(enter)f(functions)g(establish)f(a)i(lo)n(w-le)n(v)o
(el)d(mapping)h(for)i(a)g(gi)n(v)o(en)e(page.)48 b(The)30
b(FreeBSD)j(VM)300 5096 y(system')-5 b(s)31 b(pmap)i(API)g(pro)o(vides)
f(se)n(v)o(eral)g(special)h(k)o(ernel)g(pmap)f(enter)i(functions)e
(that)g(establish)g(a)300 5246 y(k)o(ernel)c(mapping)f(for)i(a)f(page)h
(f)o(aster)f(than)g(the)g(normal)f Fm(pmap)p 2541 5246
V 35 w(enter)h Fs(function.)40 b(The)28 b(speedup)g(is)300
5395 y(achie)n(v)o(ed)j(by)h(not)f(entering)h(the)g(page')-5
b(s)31 b(mapping)g(on)h(the)g(list)f(of)h(mappings)f(for)h(that)f
(page.)53 b(This)p eop
%%Page: 187 207
187 206 bop 3751 100 a Fs(187)300 249 y(allo)n(ws)22
b(pages)h(that)g(will)g(only)f(be)i(mapped)f(by)g(the)g(k)o(ernel)h
(\(e.g.)30 b(for)24 b Fm(malloc)p Fs(\))e(to)h(be)h(entered)f(in)g(the)
300 398 y(k)o(ernel)29 b(pmap)f(quickly)-6 b(.)41 b(UVM')-5
b(s)28 b(ne)n(w)g(pmap)g(interf)o(ace)h(supports)f(the)g(FreeBSD)j
(pmap)d(API.)h(Ne)n(w)300 548 y(functions)22 b(include)h
Fm(pmap)p 1257 548 30 4 v 35 w(kenter)p 1652 548 V 34
w(pa)p Fs(,)h Fm(pmap)p 2095 548 V 35 w(kenter)p 2490
548 V 34 w(pgs)p Fs(,)f(and)g Fm(pmap)p 3159 548 V 35
w(kremove)p Fs(.)29 b(These)300 697 y(functions)23 b(establish)g(a)i(k)
o(ernel)g(mapping)e(for)h(a)h(physical)e(address,)h(establish)g(a)g(k)o
(ernel)h(mapping)e(for)300 847 y(an)i(array)g(of)g(page)g(structures,)g
(or)f(remo)o(v)o(e)g(k)o(ernel)h(mappings.)583 996 y(While)j(FreeBSD')
-5 b(s)30 b(moti)n(v)n(ation)25 b(for)j(these)g(functions)f(w)o(as)h
(to)g(speed)g(k)o(ernel)g(pmap)g(access,)300 1145 y(UVM)j(also)g(uses)g
(the)g(functions)f(to)h(support)f(page)i(loanout)e(to)h(the)g(k)o
(ernel.)50 b(When)32 b(a)f(page)h(that)f(is)300 1295
y(mapped)20 b(by)h(a)g(user)g(process)g(is)g(loaned)f(out)h(to)f(the)h
(k)o(ernel,)h(it)e(is)g(mapped)h(with)f Fm(pmap)p 3332
1295 V 35 w(kenter)p 3727 1295 V 35 w(pa)p Fs(.)300 1444
y(Since)31 b(the)g(ne)n(w)g(mapping)f(is)g(not)h(entered)g(on)g(the)g
(list)f(of)h(mappings)e(for)i(the)g(page,)i(it)d(will)h(not)f(be)300
1594 y(ef)n(fected)j(by)f Fm(pmap)p 1029 1594 V 35 w(page)p
1304 1594 V 35 w(protect)p Fs(.)52 b(The)32 b(bene\002t)h(of)f(this)g
(is)g(that)g(it)f(pro)o(vides)g(a)i(w)o(ay)g(for)f(the)300
1743 y(VM)f(system)g(to)g(remo)o(v)o(e)g(all)g(mappings)f(of)i(a)g
(page)g(e)o(xcept)f(for)h(the)f(ones)h(the)f(k)o(ernel)h(is)f(using)g
(for)300 1892 y(page)37 b(loanout.)67 b(This)37 b(allo)n(ws)f(the)h
(pagedaemon)g(to)f(page)i(out)e(a)i(page)f(loaned)g(to)g(the)g(k)o
(ernel)g(by)300 2042 y(remo)o(ving)29 b(all)h(its)g(user)n(-le)n(v)o
(el)g(mappings)f(with)g Fm(pmap)p 2255 2042 V 35 w(page)p
2530 2042 V 35 w(protect)g Fs(without)h(disturbing)e(the)300
2191 y(k)o(ernel')-5 b(s)39 b(mappings.)72 b(Then)38
b(the)h(pagedaemon,)j(follo)n(wing)37 b(the)i(rules)g(presented)g(in)g
(Chapter)g(7,)300 2341 y(causes)34 b(o)n(wnership)e(of)i(the)g(page)g
(to)f(be)h(dropped,)h(thus)e(allo)n(wing)f(the)i(page)g(to)f(remain)g
(allocated)300 2490 y(until)h(the)h(k)o(ernel)g(is)f(done)h(with)f(the)
h(loan.)61 b(This)35 b(ef)n(fect)g(is)g(impossible)d(to)j(achie)n(v)o
(e)g(with)f(the)h(old)300 2639 y(pmap)24 b(interf)o(ace.)300
2971 y Ff(8.13.3)118 b(Other)31 b(Changes)300 3187 y
Fs(The)25 b(other)f(three)i(pmap)e(API)h(changes)g(are)h(minor)-5
b(.)29 b(The)o(y)24 b(are:)445 3420 y Fr(\017)49 b Fs(The)20
b(FreeBSD)j Fm(pmap)p 1357 3420 V 35 w(growkernel)18
b Fs(function)i(w)o(as)g(added)h(to)f(the)g(pmap)g(API.)h(If)g
(enabled,)544 3569 y(this)26 b(pmap)g(function)f(is)h(called)h(when)f
(UVM)h(allocates)f(a)h(chunk)f(of)h(k)o(ernel)f(virtual)g(memory)544
3718 y(for)34 b(the)f(\002rst)h(time.)56 b(This)33 b(allo)n(ws)f(a)i
(pmap)f(module)f(to)h(allocate)h(page)g(table)f(pages)g(for)h(the)544
3868 y(memory)24 b(before)h(it)f(is)h(used.)445 4100
y Fr(\017)49 b Fs(The)29 b(\223size\224)h(ar)n(gument)g(to)f(the)g
Fm(pmap)p 1910 4100 V 35 w(create)f Fs(function)h(has)g(been)h(remo)o
(v)o(ed.)44 b(This)29 b(ar)n(gu-)544 4250 y(ment)24 b(is)g(a)i(holdo)o
(v)o(er)d(from)h(Mach)h(VM)f(and)h(is)f(not)h(used)f(in)h(either)f(BSD)
i(VM)e(or)h(UVM.)445 4482 y Fr(\017)49 b Fs(The)28 b
Fm(pmap)p 973 4482 V 35 w(clear)p 1308 4482 V 34 w(reference)e
Fs(and)i Fm(pmap)p 2320 4482 V 35 w(clear)p 2655 4482
V 34 w(modify)f Fs(functions)f(were)j(mod-)544 4631 y(i\002ed)e(to)g
(return)h(a)f(boolean)g(v)n(alue.)38 b(The)o(y)27 b(return)g(f)o(alse)h
(if)f(the)g(speci\002ed)h(bit)e(is)h(already)h(clear)-5
b(.)544 4781 y(Otherwise,)26 b(the)o(y)g(clear)i(the)e(bit)g(and)h
(return)f(true.)37 b(This)26 b(allo)n(ws)f(the)i(k)o(ernel)f(to)h(test)
f(and)g(clear)544 4930 y(the)f(bit)f(at)g(the)h(same)g(time.)p
eop
%%Page: 188 208
188 207 bop 3751 100 a Fs(188)300 249 y Fg(8.14)143 b(New)34
b(I386)h(Pmap)g(Module)300 502 y Fs(UVM)e(includes)g(a)h(ne)n(w)f(pmap)
g(module)g(for)g(the)h(i386)f(processor)-5 b(.)56 b(The)34
b(pmap)f(module)f(has)i(been)300 651 y(re)n(written)k(to)h(address)g
(problems)f(with)g(the)h(old)f(pmap,)k(support)c(UVM')-5
b(s)38 b(ne)n(w)g(pmap)h(API,)g(and)300 800 y(incorporate)26
b(impro)o(v)o(ements)d(from)j(other)g(operating)f(systems)g(such)h(as)g
(FreeBSD.)i(The)e(ne)n(w)g(pmap)300 950 y(uses)e(the)h
Fm(PMAP)p 889 950 30 4 v 35 w(NEW)f Fs(interf)o(ace.)583
1099 y(The)c(i386)f(pmap)g(module)g(maintains)f(tw)o(o)h(main)g(types)h
(of)f(data)h(structures:)27 b(pmap)20 b(structures)300
1249 y(and)27 b(pvlist)f(structures.)37 b(The)27 b(pmap)g(structure)g
(contains)f(the)h(hardw)o(are-speci\002c)i(state)e(information)300
1398 y(for)f(a)f(single)g(virtual)f(address)h(space.)33
b(Each)26 b(process)f(has)g(its)g(o)n(wn)f(pmap.)32 b(The)25
b(pvlist)f(structure)h(is)g(a)300 1547 y(per)n(-page)j(structure)f
(that)g(contains)g(a)g(link)o(ed)g(list)f(of)i(a)f(page')-5
b(s)28 b(current)f(mappings.)37 b(An)27 b(element)g(on)300
1697 y(this)f(list)g(is)h(called)g(a)g(pv)o(entry)-6
b(.)36 b(Each)27 b(pv)o(entry)f(contains)g(a)i(pmap)e(pointer)l(,)h(a)g
(virtual)f(address,)i(and)f(a)300 1846 y(pointer)h(to)h(the)f(ne)o(xt)g
(pv)o(entry)g(in)h(the)f(pvlist.)42 b(The)29 b(pvlist)e(is)i(used)f(to)
h(change)g(the)f(protection)g(of)h(all)300 1996 y(mappings)23
b(of)i(a)g(page)g(and)g(to)g(k)o(eep)g(track)g(of)g(whether)f(the)h
(page)g(is)f(referenced)j(or)d(modi\002ed.)583 2145 y(The)31
b(three)h(most)e(common)f(pmap)i(operations)f(are)i(establishing)d(a)i
(mapping,)g(remo)o(ving)f(a)300 2294 y(mapping,)e(and)f(changing)h(the)
g(mapping)e(of)j(a)f(speci\002c)g(page)h(in)e(all)h(pmaps)f(that)h
(reference)h(it.)40 b(The)300 2444 y(pmap)24 b(module)g(performs)h
(these)f(operations)g(as)h(follo)n(ws:)445 2674 y Fr(\017)49
b Fs(When)35 b Fm(pmap)p 1063 2674 V 35 w(enter)f Fs(is)g(called)h(to)f
(establish)g(a)h(mapping)f(of)h(a)g(page)g(in)g(a)g(pmap,)i(it)d
(\002rst)544 2823 y(ensures)j(that)f(there)i(is)e(a)i(v)n(alid)e(page)h
(table)g(for)g(the)g(requested)g(virtual)f(address.)67
b(If)38 b(there)544 2973 y(is)e(currently)g(no)g(page)g(table,)j(a)d
(free)h(page)g(is)f(allocated)g(to)f(contain)h(the)g(ne)n(w)g(page)g
(table.)544 3122 y(Since)30 b(the)f(size)h(of)f(a)h(page)g(table)f(on)g
(the)g(i386)g(is)g(equal)g(to)g(the)h(size)f(of)h(a)f(page,)i(a)f(page)
g(that)544 3272 y(contains)g(a)h(page)h(table)f(is)f(called)h(a)h
(\223page)f(table)g(page.)-7 b(\224)50 b(Once)31 b(a)h(page)f(table)g
(is)f(allocated,)544 3421 y(the)g(pmap)f(module)g(allocates)h(a)g(pv)o
(entry)f(structure)h(to)g(record)g(the)g(mapping)f(on)h(the)f(page')-5
b(s)544 3570 y(pvlist.)29 b(Finally)-6 b(,)24 b(an)h(entry)f(for)h(the)
g(mapping)f(is)g(entered)h(in)g(the)f(page)h(table.)445
3802 y Fr(\017)49 b Fs(When)39 b Fm(pmap)p 1067 3802
V 35 w(remove)f Fs(is)h(called)g(to)g(remo)o(v)o(e)f(a)i(mapping)e(of)i
(a)f(page)h(the)f(procedure)h(is)544 3952 y(re)n(v)o(ersed.)31
b(The)25 b(page')-5 b(s)24 b(entry)h(is)g(remo)o(v)o(ed)e(from)i(the)g
(page)g(table,)g(and)g(the)f(pv)o(entry)g(structure)544
4101 y(is)j(remo)o(v)o(ed)e(from)i(the)g(pvlist.)36 b(If)28
b(the)f(\002nal)g(entry)g(w)o(as)g(remo)o(v)o(ed)f(from)h(the)g(page)g
(table,)g(then)544 4250 y(the)j(page)h(table)f(page)g(is)g(freed.)48
b(Additionally)-6 b(,)29 b(when)i(remo)o(ving)e(addresses)h(from)g(a)h
(pmap,)544 4400 y(the)20 b(i386')-5 b(s)20 b(hardw)o(are)h(cache)h(of)f
(current)f(page)h(table)g(entries)f(must)g(be)h(\003ushed.)29
b(This)20 b(is)g(called)544 4549 y(a)25 b(translation)f(lookaside)f(b)n
(uf)n(fer)i(\(TLB\))h(\003ush.)445 4781 y Fr(\017)49
b Fs(When)39 b Fm(pmap)p 1067 4781 V 35 w(page)p 1342
4781 V 35 w(protect)e Fs(is)i(called)f(to)h(change)g(the)g(protection)f
(of)h(a)g(page)g(in)f(all)544 4930 y(pmaps)30 b(that)g(refer)i(to)f
(it,)h(the)f(page')-5 b(s)30 b(pvlist)g(is)g(tra)n(v)o(ersed.)49
b(F)o(or)31 b(each)g(pv)o(entry)f(on)h(the)g(pvlist)544
5080 y(the)g(mapping)f(is)g(changed.)50 b(If)31 b(the)g(ne)n(w)f
(protection)h(is)f Fm(VM)p 2684 5080 V 36 w(PROT)p 2960
5080 V 35 w(READ)g Fs(then)g(the)h(page)h(is)544 5229
y(write-protected.)38 b(If)28 b(the)f(ne)n(w)g(protection)f(is)h
Fm(VM)p 2301 5229 V 35 w(PROT)p 2576 5229 V 35 w(NONE)p
Fs(,)g(then)g(the)g(page)h(is)e(remo)o(v)o(ed)544 5378
y(from)e(all)h(pmaps)f(referencing)i(it)e(\(in)g(this)g(case)i(the)e
(pvlist)g(must)f(be)i(zeroed\).)p eop
%%Page: 189 209
189 208 bop 3751 100 a Fs(189)300 249 y Ff(8.14.1)118
b(UVM)31 b(Pmap)f(F)m(eatur)n(es)f(Fr)n(om)g(Other)i(Operating)f
(Systems)300 466 y Fs(UVM')-5 b(s)25 b(ne)n(w)g(i386)g(pmap)g(includes)
f(se)n(v)o(eral)h(ne)n(w)g(features)h(inspired)f(by)g(other)h
(operating)f(systems.)300 615 y(These)g(features)g(are:)445
848 y Fr(\017)49 b Fs(Making)33 b(use)i(of)f(the)g(single)g(page)g(TLB)
h(\003ush)f(instruction.)58 b(When)34 b(remo)o(ving)f(page)h(map-)544
997 y(pings,)27 b(the)g(only)f(w)o(ay)i(the)f(original)f(i386)g
(processor)i(could)e(\003ush)h(the)h(TLB)f(w)o(as)g(to)g(\003ush)g(all)
544 1146 y(entries)i(out.)45 b(Not)29 b(only)g(does)g(this)g(\003ush)g
(the)h(TLB)f(entry)h(of)g(the)f(mapping)f(being)h(remo)o(v)o(ed,)544
1296 y(b)n(ut)22 b(it)g(also)g(\003ushes)g(all)g(the)g(other)h(v)n
(alid)e(entries)h(as)h(well,)f(thus)g(causing)g(them)f(to)h(be)h
(reloaded.)544 1445 y(This)33 b(is)h(inef)n(\002cient.)58
b(Starting)34 b(with)f(the)h(i486)f(processor)l(,)k(Intel)d(added)g(a)g
(ne)n(w)g(instruction)544 1594 y(that)26 b(\003ushes)g(a)h(single)f
(entry)g(out)g(of)h(the)f(TLB.)h(The)g(FreeBSD)h(pmap)e(mak)o(es)h(use)
f(of)h(this)e(in-)544 1744 y(struction)h(to)h(a)n(v)n(oid)g(the)g
(unnecessary)g(\003ushing)g(of)g(v)n(alid)g(TLB)g(entries.)38
b(UVM')-5 b(s)27 b(ne)n(w)g(pmap)544 1893 y(includes)d(code)h(based)g
(on)f(FreeBSD')-5 b(s)26 b(code)f(to)g(use)f(this)g(ne)n(w)h
(instruction.)445 2126 y Fr(\017)49 b Fs(Intel)22 b(also)g(added)g(a)h
(ne)n(w)e(\003ag)i(to)f(the)g(Pentium)g(for)g(a)h(page)f(table)g(entry)
-6 b(.)30 b(The)22 b(ne)n(w)g(\003ag,)h Fm(PG)p 3786
2126 30 4 v 35 w(G)p Fs(,)544 2275 y(indicates)28 b(that)h(if)g(this)f
(mapping)g(is)h(cached)g(in)g(the)g(TLB)g(it)g(should)f(only)g(be)h
(\003ushed)g(by)g(the)544 2424 y(single)f(page)h(\003ush)f
(instruction.)41 b(The)29 b(instruction)e(to)i(\003ush)f(the)h(entire)g
(TLB)g(will)f(not)g(ef)n(fect)544 2574 y(mappings)h(with)g
Fm(PG)p 1295 2574 V 36 w(G)h Fs(set.)46 b(The)31 b(bene\002t)f(of)g
(this)g(is)f(that)h(all)g(the)g(k)o(ernel')-5 b(s)30
b(memory)f(can)i(be)544 2723 y(mapped)k(with)f Fm(PG)p
1233 2723 V 35 w(G)p Fs(.)h(When)g(a)h(conte)o(xt)e(switch)g(occurs,)k
(the)d(entire)g(TLB)g(is)g(\003ushed,)j(b)n(ut)544 2873
y(the)31 b(k)o(ernel')-5 b(s)30 b(TLB)i(entries)f(will)f(persist)g
(because)i Fm(PG)p 2509 2873 V 35 w(G)f Fs(is)g(set)f(on)h(them.)49
b(UVM')-5 b(s)30 b(code)h(to)544 3022 y(manage)25 b(the)f
Fm(PG)p 1151 3022 V 36 w(G)g Fs(bit)g(w)o(as)h(based)g(on)g(FreeBSD.)
445 3254 y Fr(\017)49 b Fs(Under)29 b(BSD)h(VM,)e(a)h(user)h(process')f
(page)g(tables)f(are)i(placed)f(in)g(the)f(top)h(part)g(of)g(the)g
(user')-5 b(s)544 3404 y(address)29 b(space)h(and)g(managed)f(as)h
(anon)o(ymous)e(memory)-6 b(.)43 b(This)29 b(is)g(a)h(problem)f(for)h
(tw)o(o)f(rea-)544 3553 y(sons.)63 b(First,)39 b(when)d(the)g(\002nal)g
(entry)g(of)g(a)g(page)g(table)g(is)g(remo)o(v)o(ed)e(the)i(page)g
(table)g(is)g(not)544 3703 y(freed.)58 b(Instead,)36
b(the)d(page)h(table)g(persists)e(until)h(the)h(process)f(e)o(xits.)56
b(Second,)37 b(page)d(tables)544 3852 y(must)28 b(be)h(pref)o(aulted)g
(before)h(the)f(k)o(ernel)g(attempts)f(to)h(access)h(their)e(PTEs.)44
b(In)29 b(the)g(common)544 4001 y(case)23 b(of)g(a)g(page)g(f)o(ault,)g
(an)g(e)o(xtra)f(call)h(to)f(the)h(f)o(ault)f(routine)g(can)h(f)o(ault)
g(in)f(the)h(page)g(table)f(pages,)544 4151 y(ho)n(we)n(v)o(er)l(,)k
(there)h(are)h(other)f(paths)f(such)h(as)g Fm(mlock)f
Fs(that)h(bypass)f(this)g(pre-f)o(ault)h(code.)38 b(If)27
b(the)544 4300 y(pre-f)o(ault)22 b(code)g(is)g(bypassed)g(and)g(the)g
(desired)g(page)g(table)g(is)f(not)h(present)g(then)g(the)g(BSD)h(k)o
(er)n(-)544 4450 y(nel)j(crashes)h(with)e(a)i(\223)p
Fm(ptdi)p Fs(\224)f(panic.)35 b(This)25 b(problem)h(is)g(solv)o(ed)f
(in)g(FreeBSD)k(by)d(ha)n(ving)f(the)544 4599 y(pmap)f(module)g
(directly)g(manage)h(the)g(page)g(table)f(pages.)31 b(UVM)24
b(uses)h(a)g(similar)e(approach.)445 4831 y Fr(\017)49
b Fs(The)24 b(BSD)i(VM)e(pmap)g(does)g(not)g(ha)n(v)o(e)g(an)o(y)g
(locking)g(on)g(its)g(data)g(structures.)30 b(The)25
b(Mach)g(VM)544 4981 y(pmap)j(contains)f(a)i(scheme)f(for)g(data)g
(structure)g(locking.)40 b(Each)29 b(pvlist)e(has)h(a)g(lock)g(and)g
(each)544 5130 y(pmap)21 b(has)g(a)g(lock.)29 b(In)21
b(UVM)g(a)h(locking)e(scheme)h(based)g(on)g(the)g(Mach)g(VM)g(scheme)g
(has)g(been)544 5280 y(implemented.)29 b(The)c(locking)f(scheme)g(had)h
(to)f(be)h(adapted)g(for)g(the)g(i386)f(processor)-5
b(.)p eop
%%Page: 190 210
190 209 bop 3751 100 a Fs(190)300 249 y Ff(8.14.2)118
b(UVM-Speci\002c)33 b(Pmap)c(F)m(eatur)n(es)300 466 y
Fs(UVM')-5 b(s)39 b(i386)f(pmap)i(has)f(tw)o(o)g(ne)n(w)h(features)g
(that)f(are)h(UVM)f(speci\002c.)76 b(First,)43 b(the)c(ne)n(w)h(pmap)
300 615 y(has)34 b(been)f(carefully)h(designed)f(to)g(manage)h(pmap)f
(resources)h(without)e(deadlocking)h(the)g(system.)300
764 y(The)26 b(locking)f(scheme)g(of)h(the)g(machine-independent)e
(layer)i(of)g(both)f(BSD)i(VM)e(and)h(UVM)f(e)o(xpect)300
914 y(that)37 b(pmap)f(operations)g(will)g(ne)n(v)o(er)h(block.)67
b(Although)35 b(this)h(is)h(e)o(xpected)g(in)f(BSD)i(VM,)f(the)g(old)
300 1063 y(i386)h(pmap)g(does)h(not)f(deli)n(v)o(er)f(on)i(this)f
(promise.)72 b(F)o(or)38 b(e)o(xample,)k(the)c Fm(pmap)p
3201 1063 30 4 v 35 w(enter)g Fs(function)300 1213 y(allocates)27
b(a)h(pv)o(entry)e(structure)h(when)g(establishing)e(a)j(mapping.)37
b(The)27 b(BSD)h(VM)f(system)f(uses)h(the)300 1362 y
Fm(kmem)p 546 1362 V 35 w(alloc)37 b Fs(function)g(to)g(allocate)g(a)i
(pool)d(of)i(pv)o(entry)f(structures.)69 b(But)38 b(the)f
Fm(kmem)p 3572 1362 V 35 w(alloc)300 1511 y Fs(locks)32
b(the)h(k)o(ernel)g(map)f(during)g(allocation)g(and)g(sleeps)h(if)f
(not)h(enough)f(memory)g(is)g(a)n(v)n(ailable.)54 b(If)300
1661 y(the)26 b(function)f(calling)g Fm(pmap)p 1349 1661
V 35 w(enter)g Fs(calls)h(when)f(there)i(is)e(a)h(shortage)g(of)g(pv)o
(entry)f(structures)g(and)300 1810 y(it)35 b(already)h(has)g(the)f(k)o
(ernel)h(map)f(lock)o(ed,)j(or)e(if)g(there)f(is)h(not)f(enough)g
(memory)g(to)g(allocate)h(ne)n(w)300 1960 y(pv)o(entry)27
b(structures,)i(the)g(system)e(will)h(deadlock.)41 b(This)28
b(usually)f(does)i(not)f(occur)g(because)h(the)g(old)300
2109 y(pmap)i(module)f(k)o(eeps)i(a)f(pool)g(of)g(allocated)h(pv)o
(entry)e(structures)h(a)n(v)n(ailable)f(for)i(usage.)50
b(Ho)n(we)n(v)o(er)l(,)300 2258 y(the)25 b(beha)n(vior)f(of)h(the)g
(old)f(i386)g(pmap)g(module)g(is)g(clearly)h(wrong.)583
2408 y(UVM')-5 b(s)22 b Fm(pmap)p 1151 2408 V 35 w(enter)f
Fs(uses)h(se)n(v)o(eral)g(dif)n(ferent)g(strate)o(gies)g(to)g(a)n(v)n
(oid)g(deadlock)g(when)g(allo-)300 2557 y(cating)f(pv)o(entry)g
(structures.)29 b(First,)22 b(lik)o(e)f(BSD)i(VM,)e(it)g(maintains)g(a)
h(pool)f(of)g(free)i(pv)o(entry)e(structures)300 2707
y(and)32 b(attempts)e(to)h(k)o(eep)h(the)f(pool)g(reasonable)h(full.)51
b(Ho)n(we)n(v)o(er)l(,)32 b(if)f(the)h(pool)e(runs)i(out,)g(UVM)f(uses)
300 2856 y(a)h(second)f(strate)o(gy)-6 b(.)49 b(UVM)31
b(has)g(a)h(special)f(allocation)g(function)f(used)h(to)g(allocate)h
(more)f(memory)300 3005 y(for)c(pv)o(entrys.)34 b(The)26
b(function)g(attempts)f(to)h(lock)g(the)g(k)o(ernel)g(map.)35
b(But)27 b(rather)f(than)g(sleeping)g(if)g(the)300 3155
y(k)o(ernel)34 b(map)g(is)f(already)h(lock)o(ed,)i(the)e(allocation)f
(function)g(f)o(ails)h(instead.)57 b(If)34 b(this)f(function)h(f)o
(ails,)300 3304 y(then)27 b(UVM)h(f)o(alls)f(back)h(to)g(a)g(\002nal)g
(strate)o(gy)-6 b(.)38 b(The)28 b(\002nal)g(strate)o(gy)f(is)g(to)h
(lock)f(a)h(pvlist)f(structure)g(and)300 3454 y(attempt)35
b(to)h(\223steal\224)h(a)g(pv)o(entry)e(structure)h(from)g(it.)65
b(The)37 b(pv)o(entry)e(structures)h(can)h(be)f(stolen)g(be-)300
3603 y(cause)28 b(the)f(information)f(that)h(the)o(y)g(store)g(can)h
(be)g(reconstructed)f(based)h(on)f(the)g(information)f(in)h(the)300
3752 y Fm(vm)p 426 3752 V 35 w(map)21 b Fs(structure.)30
b(In)21 b(the)h(highly)e(unlik)o(ely)g(e)n(v)o(ent)h(that)g(this)g
(\002nal)h(strate)o(gy)e(f)o(ails)h(UVM)h(will)e(panic.)300
3902 y(UVM)27 b(also)f(allocates)h(page)g(table)g(pages)g(using)f(a)i
(similar)e(strate)o(gy)-6 b(.)36 b(If)27 b(there)h(are)g(no)e(pages)h
(on)g(the)300 4051 y(free)34 b(list,)g(the)f(pmap)g(module)f(will)g
(attempt)g(to)h(\223steal\224)h(a)f(page)g(table)g(page)h(from)f
(another)g(pmap.)300 4201 y(T)-8 b(o)32 b(do)g(this,)h(it)f(must)f
(\002rst)h(remo)o(v)o(e)f(all)h(mappings)f(from)h(the)g(page)h(table.)
52 b(By)33 b(allocating)e(pv)o(entry)300 4350 y(structures)e(and)g
(page)g(table)g(pages)g(this)g(w)o(ay)-6 b(,)29 b(the)g(UVM)g(v)o
(ersion)f(of)h Fm(pmap)p 3065 4350 V 35 w(enter)g Fs(\(and)g(related)
300 4499 y(functions\))24 b(ne)n(v)o(er)g(block)g(machine-independent)g
(code)h(\(unlik)o(e)f(BSD)i(VM\).)583 4649 y(The)37 b(second)f
(UVM-speci\002c)h(feature)g(is)f(the)g(dynamic)f(handling)h(of)g(TLB)h
(\003ushes.)65 b(The)300 4798 y(i386')-5 b(s)33 b(TLB)h(can)h(be)f
(\003ushed)g(in)g(one)g(of)g(tw)o(o)f(w)o(ays.)59 b(Either)34
b(all)f(the)h(entries)g(can)h(be)f(\003ushed,)i(or)300
4948 y(a)31 b(single)e(entry)h(can)h(be)g(\003ushed.)47
b(If)31 b(a)f(lar)n(ge)h(number)f(of)g(pages)h(are)g(being)f(unmapped,)
h(it)e(is)h(more)300 5097 y(ef)n(\002cient)f(to)f(\003ush)g(the)h
(entire)f(TLB)h(than)f(to)h(\003ush)f(each)h(page)g(one)f(at)h(a)g
(time.)41 b(Ho)n(we)n(v)o(er)l(,)28 b(if)h(only)f(a)300
5246 y(fe)n(w)c(entries)f(are)h(going)f(to)g(be)h(\003ushed,)f(then)h
(it)f(is)g(more)g(ef)n(\002cient)h(to)f(\003ush)h(the)f(pages)h(one)f
(at)h(a)g(time.)300 5396 y(UVM')-5 b(s)33 b(ne)n(w)h(pmap)g(includes)g
(code)g(that)g(dynamically)f(chooses)h(between)g(these)g(tw)o(o)g
(strate)o(gies)p eop
%%Page: 191 211
191 210 bop 3751 100 a Fs(191)300 249 y(depending)21
b(on)i(ho)n(w)e(man)o(y)g(pages)i(are)g(going)e(to)h(be)h(remo)o(v)o
(ed.)28 b(Note)22 b(that)g(this)g(decision)f(is)h(based)g(on)300
398 y(the)e(number)g(of)h(pages)g(remo)o(v)o(ed,)f(not)g(the)g(size)h
(of)f(area)i(being)e(remo)o(v)o(ed.)28 b(Lar)n(ge)21
b(sparsely)f(populated)300 548 y(re)o(gions)k(of)h(VM)f(may)g(still)g
(bene\002t)h(from)g(single-page)f(TLB)h(\003ushing,)f(and)h(UVM)f(allo)
n(ws)f(for)i(this.)300 931 y Fg(8.15)143 b(Summary)300
1184 y Fs(In)35 b(this)e(chapter)i(a)g(number)f(of)h(secondary)f
(design)g(elements)g(of)h(UVM)f(were)h(presented.)60
b(These)300 1333 y(elements)24 b(include:)445 1566 y
Fr(\017)49 b Fs(the)32 b(chunking)f(of)h(amap)g(allocation)f(to)g
(reduce)i(the)f(amount)f(of)h(k)o(ernel)g(memory)f(allocated)544
1715 y(for)25 b(a)g(sparsely)f(populated)g(amap.)445
1948 y Fr(\017)49 b Fs(the)20 b(aggressi)n(v)o(e)e(pageout)i
(clustering)f(of)h(anon)o(ymous)e(memory)h(that)g(allo)n(ws)g(UVM)h(to)
f(quickly)544 2097 y(reco)o(v)o(er)24 b(from)h(a)g(memory)f(shortage.)
445 2329 y Fr(\017)49 b Fs(the)30 b(design)f(of)i(UVM')-5
b(s)29 b(three)i(pagers:)41 b(the)30 b(aobj)g(pager)l(,)i(the)e(de)n
(vice)g(pager)l(,)i(and)e(the)h(vnode)544 2479 y(pager)-5
b(.)445 2711 y Fr(\017)49 b Fs(the)28 b Fm(uvm)p 880
2711 30 4 v 35 w(map)f Fs(memory)g(mapping)g(function)g(that)g(pro)o
(vides)g(a)h(single)f(uniform)g(interf)o(ace)h(to)544
2861 y(memory)c(mapping)f(under)i(UVM.)445 3093 y Fr(\017)49
b Fs(the)27 b(unmapping)f(function)g(that)h(separates)g(unmapping)f
(memory)g(and)i(dropping)e(references)544 3242 y(to)e(memory)g
(objects.)445 3475 y Fr(\017)49 b Fs(the)23 b(management)f(of)i(k)o
(ernel)f(memory)f(maps)h(and)g(objects)f(that)h(reduces)h(the)f(number)
f(of)i(VM)544 3624 y(calls)g(needed)h(to)g(establish)e(k)o(ernel)i
(memory)f(mappings.)445 3857 y Fr(\017)49 b Fs(changes)31
b(in)f(the)g(management)g(of)h(wired)g(memory)f(that)g(pre)n(v)o(ents)f
(unnecessary)i(map)f(entry)544 4006 y(fragmentation)24
b(and)g(thus)g(reduces)i(map)e(lookup)g(time.)445 4238
y Fr(\017)49 b Fs(the)33 b(redesign)h(of)g(the)f(page)h(\003ags)g(to)f
(accommodate)h(\002ne)g(grain)f(locking)g(and)h(to)f(eliminate)544
4388 y(unneeded)25 b(\003ags.)445 4620 y Fr(\017)49 b
Fm(MACHINE)p 970 4620 V 34 w(NEW)p 1184 4620 V 35 w(NONCONTIG)p
Fs(,)21 b(the)i(ne)n(w)f(uni\002ed)h(scheme)f(used)h(to)f(manage)h(a)g
(computer')-5 b(s)544 4770 y(physical)23 b(memory)-6
b(.)445 5002 y Fr(\017)49 b Fs(the)29 b(ne)n(w)h(pmap)f(interf)o(ace)h
(that)f(supports)g(features)h(incorporated)f(from)g(FreeBSD)j(and)e
(also)544 5151 y(k)o(ernel)25 b(page)g(loanout.)p eop
%%Page: 192 212
192 211 bop 3751 100 a Fs(192)445 249 y Fr(\017)49 b
Fs(the)25 b(ne)n(w)g(i386)g(pmap)g(module)g(that)g(manages)g(pmaps)g
(more)h(ef)n(\002ciently)f(and)g(does)h(not)f(block)544
398 y(machine-independent)e(code.)300 631 y(While)29
b(the)h(design)e(elements)h(are)i(secondary)-6 b(,)30
b(the)o(y)f(cumulate)g(to)g(produce)g(a)h(bene\002cial)g(ef)n(fect)g
(on)300 780 y(UVM')-5 b(s)24 b(design)g(and)h(performance,)g(and)g
(thus)f(play)g(an)h(important)e(role)i(within)f(UVM.)p
eop
%%Page: 193 213
193 212 bop 3751 100 a Fs(193)300 973 y Fp(Chapter)51
b(9)300 1448 y(Implementation)h(Methods)300 1930 y Fs(This)24
b(chapter)i(describes)f(the)f(methods)g(used)h(to)g(implement)e(and)i
(deb)n(ug)g(UVM.)f(First,)h(the)g(strate)o(gy)300 2079
y(behind)20 b(the)h(UVM)g(implementation)e(is)h(presented.)30
b(Then)21 b(the)f(tools)g(used)h(to)g(assist)f(with)g(deb)n(ugging)300
2229 y(are)28 b(presented.)38 b(These)27 b(tools)f(include)h(the)g(UVM)
f(history)g(mechanism)g(and)i(functions)e(that)g(can)i(be)300
2378 y(called)d(from)g(the)g(k)o(ernel)g(deb)n(ugger)-5
b(.)30 b(Finally)-6 b(,)24 b(tw)o(o)g(user)n(-le)n(v)o(el)g
(applications)g(that)g(display)g(the)h(status)300 2527
y(of)g(UVM)f(are)i(presented.)300 2907 y Fg(9.1)143 b(UVM)35
b(Implementation)d(Strategy)300 3159 y Fs(Implementing)25
b(a)i(softw)o(are)f(system)g(as)g(lar)n(ge)h(as)g(UVM)f(is)g(a)h(major)
f(task,)h(especially)f(when)g(almost)300 3308 y(all)32
b(of)g(the)f(w)o(ork)h(is)g(being)f(done)h(by)f(a)i(single)e(person.)52
b(The)32 b(choice)g(of)g(implementation)d(strate)o(gy)300
3458 y(for)k(such)g(a)g(project)f(is)h(critical)f(if)h(one)g(hopes)f
(to)g(bring)g(the)h(project)g(to)f(a)h(successful)f(conclusion.)300
3607 y(A)e(poor)g(implementation)e(strate)o(gy)i(could)g(lead)g(to)g
(one)g(of)h(tw)o(o)f(possible)f(conclusions.)46 b(First,)31
b(the)300 3757 y(project)f(could)h(become)f(so)h(comple)o(x)e(that)h
(it)g(cannot)h(be)g(completed.)47 b(Second,)33 b(the)d(project)h(could)
300 3906 y(be)g(completed)f(in)g(such)h(a)g(w)o(ay)g(that)f(it)h(is)f
(so)g(dif)n(\002cult)g(to)h(use)f(and)h(install)f(that)g(no)h(one)f
(bothers)g(to)300 4055 y(consider)22 b(using)f(it.)29
b(Either)22 b(one)g(of)h(these)f(alternati)n(v)o(es)f(is)g
(unacceptable)i(for)f(UVM.)g(W)-8 b(e)23 b(w)o(ant)f(UVM)300
4205 y(to)i(be)h(completed,)f(mak)o(e)h(an)g(impact,)f(and)h(be)g
Fq(used)i Fs(by)d(people.)583 4354 y(Three)d(implementation)c(strate)o
(gies)i(for)h(UVM)g(were)h(considered.)28 b(The)20 b(\002rst)g(strate)o
(gy)f(w)o(as)h(to)300 4504 y(re-design)j(and)g(re-implement)f(the)h
(whole)f(VM)h(system)f(from)h(scratch.)30 b(This)23 b(strate)o(gy)f(w)o
(as)h(rejected)300 4653 y(because)e(it)f(w)o(as)g(too)g(much)g(w)o(ork)
g(for)h(too)e(little)h(gain.)28 b(There)21 b(were)g(certain)f(aspects)h
(of)f(the)g(BSD)i(VM)300 4802 y(system)j(that)g(w)o(ork)o(ed)h(\002ne)h
(and)f(did)f(not)h(need)g(to)g(be)g(modi\002ed)f(or)h(rein)l(v)o
(ented.)34 b(F)o(or)26 b(e)o(xample,)f(BSD)300 4952 y(VM')-5
b(s)32 b(machine-independent/machine-dependent)f(layering)i(is)g
(perfectly)g(adequate)g(for)h(UVM.)300 5101 y(In)g(f)o(act,)i(making)d
(machine-dependent)h(design)f(changes)h(is)f(highly)g(unattracti)n(v)o
(e)f(because)i(of)g(the)300 5251 y(number)e(of)h(platforms)e(BSD)j
(runs)e(on)h(\(NetBSD)g(currently)g(has)f(eighteen)g(dif)n(ferent)h
(pmap)f(mod-)300 5400 y(ules\).)60 b(The)35 b(second)f(implementation)e
(strate)o(gy)i(considered)g(w)o(as)h(to)f(start)h(with)e(the)i(source)g
(tree,)p eop
%%Page: 194 214
194 213 bop 3751 100 a Fs(194)300 249 y(completely)26
b(remo)o(v)o(e)g(the)i(BSD)g(VM)f(source)g(code)h(from)f(it,)h(and)f
(write)g(UVM)g(to)g(replace)h(it)f(\(using)300 398 y(the)i(same)h
(API\).)g(The)f(problem)g(with)f(this)h(strate)o(gy)f(is)h(that)g(it)g
(is)g(v)o(ery)g(dif)n(\002cult)g(to)g(deb)n(ug)g(because)300
548 y(most)35 b(of)h(UVM)f(has)h(to)g(be)g(written)f(before)i(it)e(can)
i(be)f(deb)n(ugged.)64 b(Also,)38 b(all)d(deb)n(ugging)g(w)o(ould)300
697 y(ha)n(v)o(e)23 b(to)h(be)f(done)h(at)f(a)h(v)o(ery)f(lo)n(w)g(le)n
(v)o(el,)g(without)f(the)h(assistance)g(of)h(the)g(k)o(ernel)f(deb)n
(ugger)l(,)h(since)f(the)300 847 y(system)g(w)o(ould)g(not)g(be)h(able)
g(to)f(fully)g(boot)g(without)g(a)h(w)o(orking)f(VM)g(system.)29
b(The)24 b(third)f(UVM)h(im-)300 996 y(plementation)j(strate)o(gy)-6
b(,)29 b(described)g(in)f(greater)i(detail)e(belo)n(w)-6
b(,)29 b(in)l(v)n(olv)o(es)e(implementing)g(the)i(UVM)300
1145 y(system)24 b(in)g(parallel)h(with)f(the)g(e)o(xisting)f(VM)i
(system.)583 1295 y(UVM)19 b(w)o(as)h(implemented)d(in)i(four)h(main)f
(phases.)28 b(In)20 b(the)f(\002rst)g(phase)h(we)f(studied)g(the)g
(current)300 1444 y(BSD)38 b(VM.)f(In)h(the)f(second)h(phase)f(we)h
(implemented)e(the)h(core)h(of)g(UVM')-5 b(s)37 b(mapping)f(and)h(f)o
(ault)300 1594 y(mechanism)24 b(within)f(BSD)i(VM.)g(In)f(the)h(third)f
(phase)g(we)h(put)f(all)h(user)f(process')h(memory)f(under)g(the)300
1743 y(control)i(of)h(UVM,)f(k)o(eeping)h(the)f(k)o(ernel)h(under)g
(the)g(control)f(of)h(BSD)h(VM.)e(In)h(the)g(fourth)f(and)h(\002nal)300
1892 y(phase)f(we)g(put)f(the)g(k)o(ernel)h(under)g(UVM)f(and)h(remo)o
(v)o(ed)e(BSD)j(VM)e(from)h(the)f(system.)33 b(Throughout)300
2042 y(the)28 b(implementation)e(process,)j(the)g(UVM)f(source)g(tree)h
(w)o(as)g(managed)f(in)g(such)g(a)h(w)o(ay)g(that)f(UVM)300
2191 y(w)o(as)d(easy)g(to)f(use)h(and)g(install.)k(The)c(rest)g(of)g
(this)e(section)i(discusses)e(these)i(phases)f(in)h(more)f(detail.)300
2522 y Ff(9.1.1)119 b(Phase)29 b(1:)37 b(Study)31 b(of)e(BSD)i(VM)300
2739 y Fs(Before)41 b(e)n(v)o(en)d(attempting)g(to)h(write)g(UVM)g
(code,)k(it)c(w)o(as)g(important)f(to)h(understand)g(ho)n(w)f(BSD)300
2888 y(VM)29 b(functions)g(and)g(the)g(set)h(of)f(features)h(it)f(pro)o
(vides.)44 b(This)29 b(w)o(as)g(no)g(easy)h(task,)g(as)g(the)f(BSD)i
(VM)300 3038 y(system)c(is)h(not)g(well)h(documented)e(and)i(at)f(the)g
(time)g(the)h(UVM)f(project)g(w)o(as)g(started)h(the)f(only)g(real)300
3187 y(documentation)33 b(on)h(the)h(BSD)g(VM)g(system)e(were)j(some)e
(papers)h(put)f(out)g(by)g(the)h(Mach)f(project.)300
3337 y(So)29 b(most)f(of)h(the)f(study)g(of)h(BSD)h(VM)e(w)o(as)h
(based)g(on)g(information)e(collected)i(from)f(the)h(BSD)h(VM)300
3486 y(source)24 b(code.)30 b(The)24 b(result)f(of)h(phase)g(one)f(of)h
(UVM)f(w)o(as)h(a)g(set)f(of)h(notes)f(that)h(described)f(the)h
(detailed)300 3635 y(operation)30 b(of)h(BSD)g(VM)f(and)h(the)f
(desired)g(features)h(and)g(structure)f(of)h(UVM.)f(Much)g(of)h(what)f
(we)300 3785 y(learned)25 b(in)g(this)e(phase)i(is)f(documented)g(in)h
(Chapter)g(2.)300 4116 y Ff(9.1.2)119 b(Phase)29 b(2:)37
b(UVM)30 b(Under)i(BSD)e(VM)300 4333 y Fs(The)c(second)f(phase)g(of)h
(the)f(UVM)g(implementation)e(in)l(v)n(olv)o(ed)h(implementing)f(UVM')
-5 b(s)25 b(core)h(mem-)300 4482 y(ory)35 b(mapping)e(and)i(f)o(ault)f
(handling)g(routines.)60 b(This)34 b(w)o(as)g(done)h(by)f(taking)g(adv)
n(antage)g(of)h(one)g(of)300 4631 y(the)e(attracti)n(v)o(e)g(features)g
(of)h(BSD)g(VM.)f(In)h(BSD)g(VM)f(the)h(machine-independent)e(and)h
(machine-)300 4781 y(dependent)h(code)h(are)h(cleanly)f(separated.)61
b(Thus,)36 b(the)f(machine-dependent)f(pmap)h(layer)g(can)g(be)300
4930 y(used)19 b(to)g(establish)f(and)i(remo)o(v)o(e)e(lo)n(w-le)n(v)o
(el)f(memory)i(mappings)f(without)g(in)l(v)n(olving)f(the)i(upper)h
(layer)300 5080 y(of)29 b(the)g(BSD)h(VM.)f(This)f(allo)n(wed)g(UVM')-5
b(s)28 b(core)i(memory)e(mapping)g(and)h(f)o(ault)g(handling)f
(routines)300 5229 y(to)c(be)h(de)n(v)o(eloped)f(in)g(a)h(li)n(v)o(e)f
(k)o(ernel)h(running)e(the)i(BSD)h(VM)e(system.)p eop
%%Page: 195 215
195 214 bop 3751 100 a Fs(195)583 249 y(T)-8 b(o)37 b(achie)n(v)o(e)e
(this,)k(se)n(v)o(eral)c(minor)h(changes)g(were)h(made)f(to)g(the)g
(BSD)i(k)o(ernel.)65 b(First,)39 b(we)300 398 y(modi\002ed)f(the)h(k)o
(ernel)f(so)h(that)f(after)h(the)g(system)e(w)o(as)i(booted)f(and)g
(the)h(BSD)g(VM)g(system)e(w)o(as)300 548 y(brought)28
b(up,)h(the)g(UVM)f(testing)g(subsystem)f(w)o(ould)h(allocate)g(a)h
(number)g(of)f(pages)h(from)g(the)f(BSD)300 697 y(VM)19
b(system)g(to)g(be)h(used)f(for)h(testing.)27 b(Second,)21
b(another)f(pointer)f(to)g(a)h Fm(vm)p 2892 697 30 4
v 35 w(map)f Fs(structure)g(w)o(as)h(added)300 847 y(to)29
b(the)g Fm(vmspace)f Fs(structure)h(for)h(UVM.)f(When)h(a)f(process)h
(is)f(created)h(this)e(map)h(pointer)g(is)g(set)g(to)300
996 y(null.)38 b(Third,)27 b(the)h(BSD)g(VM)f(f)o(ault)h(routine)e(w)o
(as)i(modi\002ed)f(to)g(detect)g(f)o(aults)g(on)h(memory)e(managed)300
1145 y(by)e(the)f(UVM)h(testing)f(subsystem)f(and)i(dele)o(gate)f(them)
g(to)h(the)f(ne)n(w)h Fm(uvm)p 2921 1145 V 35 w(fault)f
Fs(routine.)30 b(F)o(ourth,)300 1295 y(the)d(k)o(ernel)h(w)o(as)g
(modi\002ed)f(to)g(free)i(an)o(y)e(UVM)g(related)h(resources)g(a)g
(process)f(is)h(holding)e(when)h(the)300 1444 y(process)f(e)o(xits.)35
b(Finally)-6 b(,)26 b(a)g(UVM)g(testing)g(system)f(call)h(w)o(as)h
(added)f(to)g(the)h(k)o(ernel)f(to)g(allo)n(w)g(normal)300
1594 y(user)n(-le)n(v)o(el)e(processes)g(to)h(manipulate)e(UVM.)583
1743 y(In)j(order)g(to)f(test)f(UVM)h(using)g(this)f(setup,)h(a)h
(process)f(performs)g(the)g(follo)n(wing)f(steps.)31
b(First)300 1892 y(the)26 b(process)g(uses)g(the)h(UVM)f(test)f(system)
h(call)g(to)g(establish)f(a)i(block)f(of)g(virtual)g(memory)f(that)h
(will)300 2042 y(be)i(managed)g(by)g(UVM.)g(The)g(system)g(call)g(uses)
g(BSD)h(VM)f(to)g(allocate)g(a)g(chunk)g(of)h(the)f(speci\002ed)300
2191 y(size)d(out)f(of)h(its)f(map.)31 b(A)25 b(null)f
Fm(vm)p 1490 2191 V 36 w(object)f Fs(is)i(mapped)f(there.)32
b(Second,)25 b(a)g(ne)n(w)g Fm(vm)p 3318 2191 V 35 w(map)f
Fs(structure)300 2341 y(is)e(allocated)g(and)g(initialized)f(to)h
(manage)g(this)g(ne)n(wly)f(allocated)h(area)i(of)e(virtual)g(memory)-6
b(.)28 b(The)23 b(ne)n(w)300 2490 y(map)h(is)h(installed)e(in)i(the)f
(process)h Fm(vmspace)e Fs(structure')-5 b(s)24 b(second)h
Fm(vm)p 2834 2490 V 35 w(map)g Fs(pointer)-5 b(.)583
2639 y(At)39 b(this)f(point,)j(the)d(testing)g(process)g(can)h(use)g
(the)f(UVM)h(test)f(system)f(call)i(to)f(establish)300
2789 y(shared)26 b(and)h(cop)o(y-on-write)e(mappings)g(to)h(a)h
(\002le,)g(or)f(establish)f(a)i(zero-\002ll)g(mapping.)34
b(The)26 b(process)300 2938 y(can)32 b(then)f(perform)h(reads)f(and)h
(writes)f(on)g(the)h(UVM)f(block)g(of)g(virtual)g(memory)-6
b(.)50 b(The)31 b(reads)h(and)300 3088 y(writes)37 b(can)g(trigger)g
(page)g(f)o(aults.)67 b(The)37 b(BSD)h(VM)f(f)o(ault)g(routine)f
(detects)h(the)g(UVM)g(f)o(aults)f(and)300 3237 y(dele)o(gates)24
b(the)g(handling)g(of)h(them)f(to)g(the)h(UVM)f(f)o(ault)h(routine.)583
3386 y(As)f(a)g(result)g(of)f(the)h(changes)g(implemented)e(in)i(Phase)
g(2,)g(a)g(user)n(-le)n(v)o(el)f(process)h(on)f(a)h(system)300
3536 y(running)i(the)h(BSD)h(VM)f(system)f(can)i(easily)f(test)f(a)i
(number)f(of)g(UVM)g(features)g(such)g(as)g(mapping,)300
3685 y(shared)33 b(memory)-6 b(,)34 b(zero-\002ll)g(memory)-6
b(,)33 b(and)g(cop)o(y-on-write.)55 b(As)33 b(cop)o(y-on-write)g(is)f
(handled)h(with)300 3835 y(amaps)21 b(and)h(anons,)g(the)g(test)f
(program)h(also)f(tests)g(these)h(subsystems.)27 b(If)c(an)f(error)g
(occurs,)g(either)g(the)300 3984 y(process)k(will)g(get)h(an)f(error)i
(signal,)e(or)g(the)h(k)o(ernel)f(will)g(crash.)36 b(Since)27
b(the)g(k)o(ernel)f(is)h(running)e(under)300 4133 y(the)30
b(fully)g(operational)f(BSD)j(VM)d(system,)i(the)f(normal)g(k)o(ernel)g
(deb)n(ugger)g(\()p Fm(ddb)p Fs(\))g(can)h(be)f(used)g(to)300
4283 y(deb)n(ug)24 b(and)h(impro)o(v)o(e)e(UVM.)300 4614
y Ff(9.1.3)119 b(Phase)29 b(3:)37 b(Users)29 b(Under)j(UVM)300
4830 y Fs(At)e(the)g(completion)e(of)i(the)g(second)g(phase)g(of)g(the)
g(UVM)f(implementation)f(strate)o(gy)h(the)h(memory)300
4980 y(mapping,)24 b(anon)o(ymous)f(memory)-6 b(,)24
b(and)h(f)o(ault)g(code)h(were)f(in)g(reasonable)h(shape.)31
b(In)26 b(the)f(third)f(phase)p eop
%%Page: 196 216
196 215 bop 3751 100 a Fs(196)300 249 y(all)26 b(user)f(processes')h
(virtual)f(memory)g(w)o(as)h(placed)g(under)g(the)f(control)g(of)h
(UVM.)f(The)h(k)o(ernel)g(con-)300 398 y(tinued)34 b(to)h(operate)g
(under)g(BSD)h(VM,)e(thus)h(allo)n(wing)e(UVM)h(to)h(be)g(deb)n(ugged)g
(with)f(the)h(normal)300 548 y(k)o(ernel)25 b(deb)n(ugger)-5
b(.)583 697 y(T)d(o)23 b(place)h(all)e(user)h(processes')g(virtual)g
(memory)f(under)h(the)g(control)f(of)h(UVM,)g(the)f(standard)300
847 y(user)n(-le)n(v)o(el)k(VM)h(system)g(calls)g(were)h(redirected)f
(from)h(the)f(BSD)h(VM)f(system)f(to)h(UVM.)g(Also,)g(the)300
996 y(number)h(of)g(pages)g(allocated)f(by)h(UVM)g(from)g(BSD)h(VM)e
(at)h(system)f(startup)h(time)f(w)o(as)h(increased.)300
1145 y(When)d(a)h(testing)e(k)o(ernel)h(boots,)g(the)g(\002rst)g(user)n
(-le)n(v)o(el)g(process)g(is)g Fm(/sbin/init)p Fs(.)30
b(The)25 b(k)o(ernel)g(uses)300 1295 y(the)f(code)h(already)f(tested)g
(in)g(phase)h(tw)o(o)e(to)h(memory)g(map)g(and)g(f)o(ault)g(init')-5
b(s)23 b(te)o(xt,)g(data,)i(and)f(bss)g(into)300 1444
y(its)g(address)h(space.)583 1594 y(In)h(phase)g(three,)h(the)e(main)h
(part)g(of)g(UVM)f(that)g(w)o(as)h(tested)g(w)o(as)g(the)f(code)h(that)
g(handles)f(the)300 1743 y(duplication)33 b(of)i(a)g(process')f
(address)h(space)g(during)f(a)h Fm(fork)e Fs(operation.)60
b(Indeed,)37 b(it)d(took)g(man)o(y)300 1892 y(attempts)24
b(before)h(init)f(w)o(as)h(successfully)e(able)i(to)g(fork)g(of)n(f)f
(a)h Fm(/bin/sh)f Fs(process.)300 2224 y Ff(9.1.4)119
b(Phase)29 b(4:)37 b(K)m(er)n(nel)31 b(Under)g(UVM)300
2440 y Fs(The)e(\002nal)g(phase)f(in)l(v)n(olv)o(ed)f(switching)g(the)i
(management)f(of)g(k)o(ernel)h(memory)f(to)g(UVM.)g(The)h(\002rst)300
2590 y(step)e(in)h(this)e(process)i(w)o(as)f(to)h(address)f(the)h(dif)n
(ferences)g(between)f(machines)g(with)g(contiguous)f(and)300
2739 y(non-contiguous)37 b(physical)h(memory)-6 b(.)73
b(As)40 b(part)f(of)g(this)g(ef)n(fort,)k Fm(MACHINE)p
3119 2739 30 4 v 34 w(NEW)p 3333 2739 V 35 w(NONCONTIG)300
2888 y Fs(\(MNN\))36 b(w)o(as)h(de)n(v)o(eloped)e(\(see)i(Section)g
(8.12.2\).)65 b(Once)37 b(MNN)f(w)o(as)g(created,)k(the)d(k)o(ernel)f
(had)h(a)300 3038 y(single)h(uni\002ed)h(interf)o(ace)h(for)g(managing)
e(physical)g(memory)-6 b(.)72 b(The)39 b(second)g(step)g(in)g(this)f
(phase)300 3187 y(w)o(as)29 b(to)g(write)g(the)f(code)i(that)e(managed)
h(the)g(k)o(ernel')-5 b(s)28 b(memory)g(\(see)i(Section)f(8.8)g(on)f
(the)h Fm(uvm)p 3751 3187 V 35 w(km)300 3337 y Fs(functions\).)41
b(Once)29 b(this)e(step)i(w)o(as)f(completed,)h(a)g(BSD)g(k)o(ernel)g
(could)f(run)g(multiuser)f(under)i(UVM)300 3486 y(with)f(only)g(tw)o(o)
g(features)h(missing:)36 b(the)28 b(ability)f(to)h(con\002gure)h(and)g
(pageout)f(to)g(sw)o(ap,)h(and)g(System)300 3635 y(V)36
b(shared)f(memory)-6 b(.)62 b(These)35 b(\002nal)h(tw)o(o)f(features)h
(were)g(added)f(to)h(UVM)f(in)g(step)g(three)h(with)e(the)300
3785 y(assistance)24 b(of)h(Matthe)n(w)f(Green)h(and)g(Chuck)g(Silv)o
(ers)f(\227)h(tw)o(o)f(NetBSD)h(contrib)n(utors.)300
4116 y Ff(9.1.5)119 b(Sour)n(ce)30 b(T)-9 b(r)n(ee)30
b(Management)300 4333 y Fs(One)d(of)g(our)g(goals)f(for)i(UVM)e(w)o(as)
h(to)g(get)f(the)h(system)f(inte)o(grated)g(into)g(one)h(or)g(more)g
(of)g(the)g(freely)300 4482 y(a)n(v)n(ailable)c(BSD)h(systems.)29
b(This)23 b(put)g(tw)o(o)g(constraints)f(on)h(the)g(de)n(v)o(elopment)f
(of)h(UVM.)g(First,)h(UVM)300 4631 y(had)32 b(to)g(k)o(eep)h(up)f(with)
g(current)g(de)n(v)o(elopments)e(in)i(the)g(BSD)h(systems.)52
b(UVM)32 b(w)o(as)h(implemented)300 4781 y(within)24
b(the)h(NetBSD)h(k)o(ernel.)32 b(NetBSD)26 b(w)o(as)f(selected)g
(because)h(we)f(were)h(already)f(f)o(amiliar)g(with)g(it)300
4930 y(and)k(it)f(w)o(as)h(the)g(only)f(BSD)i(operating)f(system)f
(than)g(ran)i(on)e(the)h(sparc)g(hardw)o(are)h(that)f(UVM)f(w)o(as)300
5080 y(being)g(de)n(v)o(eloped)f(on)h(at)g(the)g(time.)41
b(The)28 b(NetBSD)h(k)o(ernel)f(is)g(a)h(mo)o(ving)d(tar)n(get)j(\227)f
(it)g(is)f(constantly)300 5229 y(e)n(v)n(olving.)49 b(F)o(ortunately)-6
b(,)32 b(the)f(NetBSD)i(source)e(tree)h(is)f(managed)h(with)f(the)g
(Concurrent)h(V)-11 b(ersions)300 5378 y(System)33 b(\(CVS\).)h(CVS)g
(allo)n(ws)e(multiple)f(de)n(v)o(elopers)h(to)h(use)g(the)g(same)g
(source)g(tree)h(at)f(the)g(same)p eop
%%Page: 197 217
197 216 bop 3751 100 a Fs(197)300 249 y(time.)29 b(CVS)22
b(allo)n(wed)f(UVM)f(to)h(be)h(de)n(v)o(eloped)e(in)h(parallel)g(with)g
(the)g(NetBSD)h(k)o(ernel.)30 b(Periodically)-6 b(,)300
398 y(changes)35 b(made)f(to)g(the)h(master)f(NetBSD)i(source)e(tree)i
(were)f(mer)n(ged)g(into)e(the)i(UVM)f(tree)h(using)300
548 y(CVS.)583 697 y(The)26 b(second)f(constraint)f(placed)i(on)f(UVM)g
(de)n(v)o(elopment)e(w)o(as)i(that)g(UVM)g(presence)h(in)f(the)300
847 y(source)30 b(tree)g(could)f(not)f(disrupt)h(the)g(BSD)i(VM)e
(source)g(code.)45 b(The)30 b(transition)e(from)h(BSD)h(VM)f(to)300
996 y(UVM)e(w)o(as)h(made)g(as)f(easy)h(as)g(possible)e(for)i(both)f
(users)h(and)f(de)n(v)o(elopers.)39 b(T)-8 b(o)27 b(achie)n(v)o(e)g
(this,)h(UVM)300 1145 y(w)o(as)f(written)g(in)g(such)g(a)h(w)o(ay)f(to)
g(allo)n(w)g(the)g(selection)f(of)i(VM)f(system)f(\(BSD)i(VM)f(or)h
(UVM\))f(to)g(be)300 1295 y(made)k(when)g(compiling)f(the)h(k)o(ernel.)
50 b(Both)32 b(BSD)g(VM)f(and)g(UVM)g(source)g(li)n(v)o(e)f(within)g
(the)h(same)300 1444 y(source)i(tree.)57 b(This)33 b(allo)n(ws)f(a)i
(user)f(to)g(easily)g(switch)g(between)g(VM)g(systems)f(without)g(ha)n
(ving)g(to)300 1594 y(ha)n(v)o(e)26 b(more)h(than)f(one)h(source)g
(tree.)37 b(Also,)26 b(MNN)g(w)o(as)h(ported)f(to)h(BSD)g(VM.)f(This)g
(allo)n(wed)g(k)o(ernel)300 1743 y(de)n(v)o(elopers)32
b(to)h(mo)o(v)o(e)f(their)h(ports)f(to)h(UVM)g(with)f(a)i(tw)o(o)f
(step)g(process.)55 b(First,)36 b(MNN)c(support)h(is)300
1892 y(added)g(to)f(the)h(machine-dependent)f(part)h(of)g(the)f(port.)
55 b(Second,)35 b(UVM)d(support)g(is)g(added)h(to)f(the)300
2042 y(port.)49 b(Ha)n(ving)31 b(MNN)f(run)i(under)f(BSD)h(VM)e(allo)n
(ws)g(k)o(ernel)h(de)n(v)o(elopers)f(to)h(test)g(MNN)f(machine-)300
2191 y(dependent)24 b(code)h(separately)g(from)g(UVM.)300
2575 y Fg(9.2)143 b(UVMHIST)-11 b(:)34 b(UVM)i(Function)e(Call)h
(History)300 2827 y Fs(One)28 b(important)e(tool)i(used)f(in)h(the)f
(implementation)f(and)i(deb)n(ugging)e(of)j(UVM)e(is)g(the)h(UVMHIST)
300 2977 y(function)22 b(call)i(history)e(subsystem.)28
b(UVMHIST)c(pro)o(vides)e(a)h(w)o(ay)h(for)f(UVM)g(to)g(produce)g(a)h
(trace)g(of)300 3126 y(requests)30 b(being)g(made)g(to)g(the)g(VM)g
(system)f(and)i(the)f(corresponding)f(functions)h(called)g(to)g
(service)300 3275 y(these)h(requests.)51 b(Such)32 b(a)g(trace)g(can)g
(be)g(produced)g(without)e(disrupting)g(the)h(normal)g(operation)g(of)
300 3425 y(the)25 b(operating)g(system.)31 b(This)25
b(allo)n(ws)f(a)h(k)o(ernel)h(de)n(v)o(eloper)e(to)h(easily)g(trace)h
(the)f(path)g(tak)o(en)g(through)300 3574 y(the)g(UVM)f(source)h(code)g
(and)g(determine)f(if)h(either)g(an)f(incorrect)h(or)g(inef)n
(\002cient)g(path)f(w)o(as)h(tak)o(en.)583 3724 y(UVMHIST)i(is)f
(implemented)e(as)j(a)f(circular)h(array)g(of)f(log)g(records.)36
b(Each)26 b(record)h(contains)300 3873 y(the)e(follo)n(wing)e
(information:)445 4105 y Fr(\017)49 b Fs(The)25 b(name)f(of)h(the)g
(function)f(that)g(generated)h(the)g(log)f(message.)445
4338 y Fr(\017)49 b Fs(The)27 b(call)h(number)f(of)h(the)f(function.)38
b(The)28 b(call)f(number)g(indicates)g(which)g(in)l(v)n(ocation)g(of)g
(the)544 4487 y(function)k(generated)h(the)g(log.)52
b(Call)32 b(numbers)f(start)h(at)g(zero)g(and)g(are)h(incremented)e(by)
h(one)544 4637 y(each)27 b(time)f(the)g(function)f(is)h(called.)36
b(The)26 b(call)h(number)e(is)h(useful)g(for)h(separating)f(e)n(v)o
(ents)f(and)544 4786 y(detecting)f(recursion.)445 5018
y Fr(\017)49 b Fs(A)25 b(timestamp)e(collected)h(from)h(the)g(system')
-5 b(s)23 b(clock.)445 5251 y Fr(\017)49 b Fs(A)25 b(pointer)f(to)g(a)h
(string)f(containing)g(a)h Fm(printf)e Fs(format.)p eop
%%Page: 198 218
198 217 bop 3751 100 a Fs(198)578 1742 y @beginspecial
0 @llx 0 @lly 522 @urx 273 @ury 3654 @rwi @setspecial
%%BeginDocument: ../figures/uvmhist.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-16.0 327.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 5482 m 0 0 l 8998 0 l 8998 5482 l cp clip
 0.06000 0.06000 sc
/Helvetica-Bold ff 300.00 scf sf
4500 3150 m
gs 1 -1 sc (corresponding uvmhist_dump output) dup sw pop 2 div neg 0 rm  col0 sh gr
/Courier ff 180.00 scf sf
1200 1575 m
gs 1 -1 sc (UVMHIST_LOG\(maphist, "\(addr=0x%x, size=%d, prot=%d, flags=%d\)",) col0 sh gr
% Polyline
7.500 slw
gs  clippath
1320 3897 m 1350 3777 l 1380 3897 l 1380 3735 l 1320 3735 l cp
clip
n 1350 4200 m 1350 3750 l gs col0 s gr gr

% arrowhead
n 1320 3897 m 1350 3777 l 1380 3897 l 1350 3897 l 1320 3897 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
2820 3897 m 2850 3777 l 2880 3897 l 2880 3735 l 2820 3735 l cp
clip
n 2850 4200 m 2850 3750 l gs col0 s gr gr

% arrowhead
n 2820 3897 m 2850 3777 l 2880 3897 l 2850 3897 l 2820 3897 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6270 3897 m 6300 3777 l 6330 3897 l 6330 3735 l 6270 3735 l cp
clip
n 6300 4200 m 6300 3750 l gs col0 s gr gr

% arrowhead
n 6270 3897 m 6300 3777 l 6330 3897 l 6300 3897 l 6270 3897 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
3570 3897 m 3600 3777 l 3630 3897 l 3630 3735 l 3570 3735 l cp
clip
n 3600 5100 m 3600 3750 l gs col0 s gr gr

% arrowhead
n 3570 3897 m 3600 3777 l 3630 3897 l 3600 3897 l 3570 3897 l  cp gs 0.00 setgray ef gr  col0 s
/Courier ff 180.00 scf sf
600 3600 m
gs 1 -1 sc (831491479.243243 sys_u_mmap#0: \(addr=0x30001000, size=4096, prot=0, flags=0\)) col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
1350 4500 m
gs 1 -1 sc (timestamp) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2850 4500 m
gs 1 -1 sc (function) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
6300 4500 m
gs 1 -1 sc (log message) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3600 5400 m
gs 1 -1 sc (invocation number) dup sw pop 2 div neg 0 rm  col0 sh gr
% Polyline
30.000 slw
n 900 1200 m 8250 1200 l 8250 2025 l 900 2025 l cp gs col0 s gr 
% Polyline
n 300 3225 m 8925 3225 l 8925 3750 l 300 3750 l cp gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
4500 1125 m
gs 1 -1 sc (UVMHIST_LOG statement) dup sw pop 2 div neg 0 rm  col0 sh gr
/Courier ff 180.00 scf sf
1200 1785 m
gs 1 -1 sc (                          addr, size, prot, flags\);) col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 1513 1945 a(Figure)25 b(9.1:)30 b(UVMHIST)25
b(usage)445 2341 y Fr(\017)49 b Fs(F)o(our)24 b(inte)o(gers)g(that)h
(contain)f(the)h(data)f(for)h(the)g Fm(printf)f Fs(format.)300
2573 y(UVM)g(supports)g(multiple)f(UVMHIST)i(arrays.)583
2722 y(Log)34 b(entries)f(are)i(entered)f(into)f(the)g(UVMHIST)h(log)f
(using)g(the)h Fm(UVMHIST)p 3385 2722 30 4 v 34 w(LOG)f
Fs(macro.)300 2872 y(Calls)f(to)g(the)g Fm(UVMHIST)p
1227 2872 V 34 w(LOG)g Fs(are)h(distrib)n(uted)e(throughout)f(the)i
(UVM)g(source)g(code.)54 b(Note)32 b(that)300 3021 y(on)g(systems)g
(with)g(UVMHIST)g(disabled)g(the)g Fm(UVMHIST)p 2422
3021 V 35 w(LOG)g Fs(macro)g(is)h(null.)53 b(This)32
b(allo)n(ws)f(the)300 3170 y Fm(UVMHIST)p 726 3170 V
34 w(LOG)25 b Fs(calls)f(to)g(remain)h(in)f(production)g(code)h(with)f
(no)h(o)o(v)o(erhead.)583 3320 y(UVMHIST)31 b(includes)f(a)i(function)e
(called)g Fm(uvmhist)p 2564 3320 V 35 w(dump)g Fs(that)g(prints)g(the)h
(contents)f(of)300 3469 y(an)j(array)h(of)f(history)f(entries.)55
b(An)33 b(e)o(xample)f(of)h(a)g Fm(UVMHIST)p 2580 3469
V 35 w(LOG)f Fs(call)h(and)g(the)g(corresponding)300
3619 y(output)24 b(from)g Fm(uvmhist)p 1224 3619 V 34
w(dump)g Fs(is)h(sho)n(wn)e(in)i(Figure)g(9.1.)583 3768
y(UVMHIST)30 b(has)g(had)g(a)h(bene\002cial)f(ef)n(fect)g(on)g(the)g
(UVM)g(project)f(in)h(se)n(v)o(eral)f(w)o(ays.)46 b(First,)300
3917 y(it)33 b(is)h(an)g(ef)n(fecti)n(v)o(e)f(educational)g(tool)g(for)
h(learning)g(about)f(the)h(VM)f(system.)57 b(Second,)36
b(data)e(from)300 4067 y(UVMHIST)28 b(traces)h(has)g(found)f(se)n(v)o
(eral)f(redundant)h(calls)g(to)h(the)f(VM)g(system)f(in)h(the)h(BSD)g
(source)300 4216 y(code.)40 b(Eliminating)25 b(these)i(calls)h(reduced)
g(VM)f(system)g(o)o(v)o(erhead.)38 b(Third,)28 b(data)g(from)f(UVMHIST)
300 4366 y(traces)43 b(has)g(also)f(been)h(used)f(to)g(modify)g(UVM')-5
b(s)41 b(design)h(to)h(reduce)g(the)f(o)o(v)o(erhead)g(of)h(certain)300
4515 y(common)c(operations.)78 b(The)41 b(remainder)f(of)h(this)f
(section)g(pro)o(vides)f(details)h(on)h(the)f(bene\002ts)h(of)300
4664 y(UVMHIST)25 b(in)f(these)h(three)g(areas.)300 4996
y Ff(9.2.1)119 b(UVMHIST)30 b(As)f(an)i(Educational)f(T)-11
b(ool)300 5212 y Fs(The)30 b(primary)f(w)o(ay)h(to)f(learn)h(about)f
(the)h(operation)f(of)h(most)f(k)o(ernel)g(subsystems)f(is)h(to)h
(either)g(read)300 5362 y(the)h(source)g(code)g(or)g(try)g(and)f
(\002nd)h(a)h(paper)f(or)g(book)f(that)h(describes)f(the)h(subsystem')
-5 b(s)29 b(operation.)p eop
%%Page: 199 219
199 218 bop 3751 100 a Fs(199)300 249 y(While)25 b(such)g(information)f
(resources)i(do)g(e)o(xplain)e(the)h(data)h(structures)f(and)h
(functions,)e(this)h(is)g(only)300 398 y(part)k(of)f(the)h(story)-6
b(.)41 b(Source)29 b(code)g(and)f(papers)h(only)f(present)g(a)h(static)
f(vie)n(w)g(of)h(a)g(softw)o(are)f(system.)300 548 y(It)f(is)g(dif)n
(\002cult)f(to)h(fully)g(understand)g(and)g(appreciate)g(a)h(k)o(ernel)
f(subsystem)f(without)g(being)h(f)o(amiliar)300 697 y(with)36
b(the)h(dynamic)g(aspects)f(of)i(the)f(system.)66 b(In)37
b(other)g(w)o(ords,)j(understanding)35 b(what)i(functions)300
847 y(are)30 b(commonly)d(called)i(and)f(the)h(order)g(in)g(which)f
(the)o(y)g(are)i(called)e(in)h(response)f(to)h(a)g(request)g(is)f(an)
300 996 y(important)22 b(part)i(of)f(understanding)f(a)i(system.)29
b(This)23 b(is)g(one)h(of)f(the)h(reasons)f(that)g(understanding)f(the)
300 1145 y(detailed)h(function)g(of)h(BSD)h(VM)e(is)h(dif)n(\002cult.)
29 b(It)24 b(has)g(man)o(y)e(functions)h(and)h(no)f(roadmap)h(to)f(e)o
(xplain)300 1295 y(ho)n(w)h(all)h(the)f(functions)g(interrelate)h
(during)f(normal)g(VM)g(system)g(operation.)583 1444
y(UVMHIST)29 b(allo)n(ws)e(k)o(ernel)i(de)n(v)o(elopers)e(to)h(more)h
(easily)f(educate)h(themselv)o(es)e(on)h(the)g(op-)300
1594 y(eration)h(of)h(UVM.)f(A)g(de)n(v)o(eloper)g(can)g(run)h(a)g
(program)f(that)g(mak)o(es)g(a)h(request)f(to)g(the)g(VM)g(system.)300
1743 y(Once)i(the)g(request)g(is)f(complete,)i(the)f(de)n(v)o(eloper)f
(can)h(dump)f(out)g(the)h(UVMHIST)g(and)g(easily)f(un-)300
1892 y(derstand)24 b(the)g(path)g(tak)o(en)h(through)e(UVM)h(to)g
(satisfy)g(that)g(request.)30 b(An)25 b(especially)f(useful)g(e)o(x)o
(ercise)300 2042 y(is)g(to)f(enable)h(UVMHIST)g(and)g(boot)g(a)g
(system)f(single)g(user)h(and)g(re)n(vie)n(w)g(the)f(UVM)h(calls)g
(necessary)300 2191 y(to)g(to)h(start)f Fm(/sbin/init)p
Fs(.)300 2517 y Ff(9.2.2)119 b(UVMHIST)30 b(and)g(Redundant)j(VM)d
(Calls)300 2734 y Fs(The)35 b(traces)h(produced)f(by)g(UVMHIST)g
(during)f(single)h(user)g(operation)g(were)g(used)g(to)g(eliminate)300
2883 y(se)n(v)o(eral)24 b(redundant)f(calls)h(to)g(the)h(VM)f(system)f
(in)h(the)g(BSD)h(k)o(ernel.)31 b(Redundant)24 b(calls)g(are)h
(harmless)300 3032 y(to)38 b(the)f(operation)h(of)g(the)f(k)o(ernel,)42
b(b)n(ut)37 b(the)o(y)g(add)h(needless)g(e)o(xtra)f(VM)h(system)f(o)o
(v)o(erhead)g(to)g(the)300 3182 y(life)28 b(time)f(of)h(a)h(process.)40
b(The)28 b(follo)n(wing)f(redundant)g(calls)h(were)h(found)e(in)h(the)g
(BSD)h(k)o(ernel)f(using)300 3331 y(UVMHIST)-5 b(:)445
3534 y Fr(\017)49 b Fs(When)34 b(forking)f(a)h(process,)h(the)f
Fm(uvm)p 1922 3534 30 4 v 35 w(fork)f Fs(function)g(uses)g
Fm(uvm)p 2981 3534 V 36 w(map)p 3197 3534 V 35 w(inherit)f
Fs(to)h(set)544 3683 y(the)41 b(inheritance)g(v)n(alue)g(of)g(the)g
(user')-5 b(s)41 b(page)g(tables)g(to)g(\223none\224)h(before)f(cop)o
(ying)g(the)g(ad-)544 3833 y(dress)f(space.)78 b(This)40
b(call)g(is)g(necessary)h(to)f(pre)n(v)o(ent)g(the)g(child)g(process)g
(from)g(interfering)544 3982 y(with)30 b(the)i(parent')-5
b(s)30 b(processes)h(page)h(tables.)50 b(Ho)n(we)n(v)o(er)l(,)31
b(after)h(cop)o(ying)f(the)g(address)g(space,)544 4132
y(the)g Fm(uvm)p 883 4132 V 36 w(fork)f Fs(performs)i(tw)o(o)f
(redundant)g(VM)g(operations)g(on)g(the)h(ne)n(wly)e(created)j(child)
544 4281 y(process')g(map.)55 b(First,)35 b(it)e(unmaps)f(the)h(area)h
(of)f(the)g(child')-5 b(s)32 b(address)h(space)h(used)f(for)g(page)544
4430 y(table)27 b(pages.)40 b(Second,)28 b(after)h(re-allocating)e
(that)g(space)h(for)g(the)g(child')-5 b(s)26 b(page)i(tables)f(it)g
(calls)544 4580 y Fm(uvm)p 730 4580 V 35 w(map)p 945
4580 V 35 w(inherit)d Fs(to)g(set)h(the)f(inheritance)h(v)n(alue)f(of)h
(the)g(page)g(table)f(space)h(to)g(\223none.)-7 b(\224)544
4766 y(The)38 b(unmap)g(call)g(is)g(redundant)g(because)h(the)f
Fm(uvm)p 2471 4766 V 35 w(fork)g Fs(function)f(set)h(the)g(inheritance)
544 4915 y(of)d(the)g(page)h(table)f(space)g(to)g(\223none\224)g
(before)h(cop)o(ying)f(the)g(address)g(space,)j(thus)c(it)h(is)g(not)
544 5065 y(possible)23 b(for)i(an)o(y)g(page)g(table)f(mappings)g(to)g
(be)h(acti)n(v)o(e)f(after)h(the)g(address)g(space)g(is)f(copied.)544
5251 y(The)h(second)g(inheritance)g(change)h(is)f(there)g(to)g(pre)n(v)
o(ent)f(a)i(child)f(of)g(the)g(child')-5 b(s)24 b(process)h(from)544
5400 y(inheriting)g(the)i(child')-5 b(s)25 b(page)i(tables.)37
b(This)26 b(call)g(is)h(unnecessary)g(because)g(if)f(the)h(child)f
(forks)p eop
%%Page: 200 220
200 219 bop 3751 100 a Fs(200)544 249 y(the)32 b Fm(uvm)p
884 249 30 4 v 35 w(fork)g Fs(function)g(will)f(reset)i(the)f
(inheritance)h(of)f(this)g(re)o(gion)f(of)i(memory)f(before)544
398 y(cop)o(ying)24 b(the)g(child')-5 b(s)24 b(address)h(space.)445
631 y Fr(\017)49 b Fs(In)27 b(the)g Fm(exec)f Fs(code,)h(the)g
(function)f Fm(vmcmd)p 2123 631 V 35 w(map)p 2338 631
V 35 w(pagedvn)g Fs(is)g(used)h(to)g(memory)f(map)g(the)544
780 y(te)o(xt)32 b(or)i(data)g(portion)e(of)i(a)g(vnode)f(into)g(a)h
(process')f(address)h(space.)57 b(Initially)-6 b(,)34
b(it)f(used)g(the)544 930 y Fm(uvm)p 730 930 V 35 w(mmap)g
Fs(function)f(with)h Fm(MAP)p 1794 930 V 35 w(FIXED)g
Fs(to)g(establish)f(this)g(mapping.)56 b(At)33 b(the)g(time)g(this)544
1079 y(mapping)h(is)h(established)f(the)i(process')f(address)g(space)h
(is)f(being)g(\002lled)g(for)h(the)f(\002rst)h(time)544
1228 y(with)d(the)h(ne)n(w)g(program,)i(so)e(there)g(should)f(ne)n(v)o
(er)g(be)i(a)f(pre)n(viously)e(established)h(mapping)544
1378 y(that)21 b(w)o(ould)f(block)g(the)h(mapping)f(being)h(created.)30
b(Ho)n(we)n(v)o(er)l(,)21 b(due)g(to)g(the)g(requirements)f(of)h(the)
544 1527 y Fm(mmap)e Fs(system)f(call,)j(if)e(the)h Fm(MAP)p
1697 1527 V 35 w(FIXED)e Fs(\003ag)i(is)g(set,)g(the)f
Fm(uvm)p 2783 1527 V 36 w(mmap)f Fs(function)h(al)o(w)o(ays)g(calls)544
1677 y(the)27 b(unmap)g(function)f(to)h(clear)h(out)f(an)o(y)g(pre)n
(viously)f(established)g(mapping.)37 b(This)27 b(results)f(in)544
1826 y(the)f(UVMHIST)f(trace)i(containing)d(the)i(follo)n(wing)e(VM)h
(operations)g(at)h Fm(exec)f Fs(time:)635 2058 y(1.)48
b(allocate)25 b(a)g(ne)n(w)g(vmspace)f(\(the)h(ne)n(w)f(space)i(has)e
(no)h(acti)n(v)o(e)f(mappings\))635 2249 y(2.)48 b(unmap)25
b(te)o(xt)e(area)j([redundant])635 2440 y(3.)48 b(map)25
b(te)o(xt)635 2631 y(4.)48 b(unmap)25 b(data)f(area)i([redundant])635
2822 y(5.)48 b(map)25 b(data)544 3054 y(Clearly)32 b(both)e(unmap)h
(operations)f(are)i(redundant.)49 b(T)-8 b(o)32 b(\002x)f(this)f
(problem,)i(the)f Fm(exec)g Fs(code)544 3204 y(w)o(as)e(modi\002ed)g
(to)g(call)g Fm(uvm)p 1577 3204 V 35 w(map)g Fs(directly)-6
b(,)29 b(since)g(the)g(special)g(handling)g(of)g Fm(uvm)p
3536 3204 V 35 w(mmap)g Fs(is)544 3353 y(not)24 b(needed)h(in)g(UVM.)
445 3586 y Fr(\017)49 b Fs(UVMHIST)20 b(traces)h(also)f(detected)h(a)g
(redundant)f(call)g(to)g Fm(uvm)p 2737 3586 V 35 w(map)p
2952 3586 V 35 w(protect)f Fs(in)i(the)f Fm(exec)544
3735 y Fs(code)h(path.)29 b(The)21 b(function)f Fm(vmcmd)p
1814 3735 V 34 w(map)p 2028 3735 V 36 w(zero)g Fs(establishes)f
(zero-\002ll)i(mappings.)28 b(It)21 b(is)f(used)544 3884
y(to)30 b(memory)h(map)f(the)h(bss)f(and)h(stack)g(se)o(gments)e(of)i
(a)h(process.)48 b(As)31 b(pre)n(viously)e(described,)544
4034 y(in)35 b(BSD)i(VM)e(all)g(mappings)g(are)h(established)f(with)g
(the)g(def)o(ault)h(protection)e(\(read-write\).)544
4183 y(Early)i(v)o(ersions)f(of)h(UVM')-5 b(s)36 b(memory)f(mapping)g
(function)g(also)h(al)o(w)o(ays)g(used)g(the)g(def)o(ault)544
4333 y(protection.)f(It)27 b(turn)f(out)g(that)g(in)g(the)h(BSD)g(code)
g(the)g Fm(vmcmd)p 2757 4333 V 35 w(map)p 2972 4333 V
35 w(zero)f Fs(function)f(al)o(w)o(ays)544 4482 y(used)e
Fm(uvm)p 936 4482 V 35 w(map)p 1151 4482 V 36 w(protect)f
Fs(to)h(set)h(the)f(protection)g(after)h(the)g(mapping)e(w)o(as)i
(established)e(\227)544 4631 y(e)n(v)o(en)f(if)h(the)g(desired)g
(protection)f(w)o(as)h(the)g(def)o(ault)g(protection.)29
b(This)21 b(results)g(in)h(the)g(follo)n(wing)544 4781
y(trace)j(during)f(an)h Fm(exec)p Fs(:)635 5013 y(1.)48
b(zero-map)26 b(the)e(bss)g(se)o(gment)g(\(the)h(protection)f(is)g(set)
h(to)f(the)h(def)o(ault,)f(read-write\).)635 5204 y(2.)48
b(set)25 b(the)g(protection)f(of)h(the)f(bss)g(se)o(gment)g(to)g
(read-write)i([redundant])635 5395 y(3.)48 b(zero-map)26
b(the)e(reserv)o(ed)h(stack)g(area)p eop
%%Page: 201 221
201 220 bop 3751 100 a Fs(201)635 249 y(4.)48 b(set)25
b(the)g(protection)f(of)h(the)f(reserv)o(ed)h(stack)g(area)g(to)g
(\223none\224)635 440 y(5.)48 b(zero-map)26 b(the)e(acti)n(v)o(e)g
(stack)h(area)635 631 y(6.)48 b(set)25 b(the)g(protection)f(of)h(the)f
(acti)n(v)o(e)g(stack)h(area)g(to)g(read-write)g([redundant])544
863 y(The)37 b(tw)o(o)h(redundant)f Fm(uvm)p 1545 863
30 4 v 35 w(map)p 1760 863 V 35 w(protect)f Fs(calls)h(set)h(the)f
(protection)g(to)g(the)h(v)n(alue)e(it)i(is)544 1013
y(already)31 b(set)f(to.)47 b(This)29 b(trace)i(w)o(as)g(one)f(of)h
(the)f(moti)n(v)n(ating)d(f)o(actors)k(for)f(allo)n(wing)f(protection)
544 1162 y(to)24 b(be)h(speci\002ed)g(in)g(the)f(\003ags)i(of)f(the)f
Fm(uvm)p 2047 1162 V 35 w(map)h Fs(function.)30 b(Thus,)24
b(in)g(UVM)g(not)h(only)f(are)h(the)544 1311 y(redundant)h
Fm(uvm)p 1155 1311 V 35 w(map)p 1370 1311 V 35 w(protect)f
Fs(calls)h(eliminated,)g(b)n(ut)g(the)g(call)h(to)f(set)g(the)g
(protection)g(of)544 1461 y(the)f(reserv)o(ed)h(stack)g(area)g(to)g
(\223none\224)g(is)f(also)g(eliminated)f(since)i(that)f(protection)g
(can)h(no)n(w)f(be)544 1610 y(set)f(while)h(memory)f(mapping)f(the)i
(area.)445 1843 y Fr(\017)49 b Fs(When)31 b(a)h(process)g(e)o(xits,)f
(it)g(must)g(unmap)g(its)f(memory)h(to)g(free)i(it.)50
b(The)31 b(UVMHIST)h(traces)544 1992 y(sho)n(w)24 b(that)i(the)f(BSD)i
(k)o(ernel)f(w)o(as)f(unmapping)f(an)i(e)o(xiting)e(process')i(address)
g(space)g(in)f(three)544 2141 y(places)i(on)g(i386)g(systems:)34
b(once)28 b(in)f(the)g(main)g(e)o(xit)f(function,)h(once)h(in)f(the)g
(machine-depen-)544 2291 y(dent)35 b Fm(cpu)p 937 2291
V 35 w(exit)g Fs(function,)j(and)e(once)g(in)f(the)g
Fm(uvmspace)p 2797 2291 V 35 w(free)f Fs(function.)63
b(Based)36 b(on)544 2440 y(this)26 b(information)g(the)h(unmap)f(in)h
Fm(cpu)p 1951 2440 V 35 w(exit)f Fs(w)o(as)i(remo)o(v)o(ed)d(and)j(the)
f(unmap)f(operation)g(in)544 2590 y Fm(uvmspace)p 1030
2590 V 34 w(free)19 b Fs(w)o(as)i(modi\002ed)f(to)g(only)f(occur)i(if)f
(the)g(map)g(being)g(freed)h(still)e(has)h(entries.)300
2921 y Ff(9.2.3)119 b(UVMHIST)30 b(and)g(UVM)h(Design)f(Adjustments)300
3137 y Fs(In)22 b(addition)e(to)h(being)g(used)h(to)f(detect)h
(redundant)f(VM)g(calls,)h(UVMHIST)g(traces)g(were)g(also)f(used)g(to)
300 3287 y(mak)o(e)f(tw)o(o)g(adjustments)e(to)i(UVM')-5
b(s)19 b(amap)h(code.)29 b(One)21 b(change)f(moti)n(v)n(ated)e(by)i
(the)g(UVMHIST)g(logs)300 3436 y(w)o(as)32 b(the)h(amap)f(chunking)f
(code)i(pre)n(viously)d(described)i(in)g(Section)h(8.1.)53
b(Using)31 b(the)h(UVMHIST)300 3586 y(trace)21 b(produced)f(o)o(v)o(er)
g(part)g(of)g(a)h(system')-5 b(s)19 b(bootup,)h(it)f(w)o(as)i
(determined)e(that)h(before)h(amap)f(chunking)300 3735
y(w)o(as)i(added)h(to)f(the)g(system)f(11186)g(pages)i(of)f(virtual)g
(memory)f(were)i(co)o(v)o(ered)f(by)g(the)g(amap)g(system.)300
3884 y(After)29 b(adding)f(amap)g(chunking,)h(UVMHIST)f(sho)n(ws)g
(that)g(in)g(the)g(same)h(bootup)e(operation)h(amaps)300
4034 y(co)o(v)o(ered)c(only)g(107)h(pages)f(of)h(virtual)f(memory)-6
b(.)583 4183 y(Another)39 b(area)g(where)g(the)f(UVMHIST)h(traces)g
(contrib)n(uted)e(to)h(a)h(UVM)f(design)g(change)300
4333 y(w)o(as)26 b(in)f(the)g(handling)g(of)g(the)h Fm(sys)p
1547 4333 V 35 w(obreak)f Fs(system)f(call.)33 b(This)25
b(system)f(call)i(is)f(used)h(to)f(e)o(xpand)g(a)300
4482 y(process')c(heap)g(area)h(for)g Fm(malloc)p Fs(.)28
b(Expanding)19 b(the)i(heap)h(area)f(in)l(v)n(olv)o(es)f(e)o(xtending)f
(the)i(size)g(of)g(the)300 4631 y(amap)28 b(that)g(allocates)f(that)h
(area.)41 b(This)27 b(can)i(be)f(some)n(what)f(e)o(xpensi)n(v)o(e)f
(since)i(the)g(data)g(in)f(the)h(amap)300 4781 y(may)19
b(ha)n(v)o(e)g(to)h(be)f(copied)g(in)h(order)f(to)h(increase)f(its)g
(memory)g(allocation.)28 b(When)19 b(booting)f(single)h(user)l(,)300
4930 y(the)35 b(UVMHIST)f(trace)i(sho)n(wed)d(that)i(the)f
Fm(/sbin/init)f Fs(process)i(calls)f Fm(sys)p 3221 4930
V 35 w(obreak)g Fs(ele)n(v)o(en)300 5080 y(times)d(before)h(it)f(gets)h
(to)f(the)h(point)f(where)h(it)f(can)h(prompt)f(for)h(a)g(shell)f(on)h
(the)g(system')-5 b(s)30 b(console.)300 5229 y(Each)38
b(time)g(the)f(break)i(gre)n(w)-6 b(,)40 b(the)e(corresponding)f(amap)h
(had)g(to)g(be)g(e)o(xtended.)70 b(T)-8 b(o)38 b(reduce)g(the)300
5378 y(o)o(v)o(erhead)23 b(of)g(this,)g(the)g(\223amappad\224)h(\003ag)
g(w)o(as)g(added)f(to)g(the)h Fm(uvm)p 2647 5378 V 35
w(map)f Fs(function.)29 b(This)23 b(\003ag)h(causes)p
eop
%%Page: 202 222
202 221 bop 3751 100 a Fs(202)300 249 y(the)37 b(mapping)e(function)h
(to)h(allocate)g(an)g(amap)f(for)h(the)g(mapped)f(re)o(gion)g(that)h
(is)f(lar)n(ger)i(than)e(the)300 398 y(re)o(gion)25 b(itself.)34
b(This)26 b(allo)n(ws)f(the)h(amap)g(to)g(be)g(e)o(xtended)f(in-place)i
(without)d(the)i(need)h(for)f(allocating)300 548 y(a)31
b(ne)n(w)f(amap)g(and)h(cop)o(ying)e(the)i(data)f(from)h(the)f(old)g
(amap)g(to)g(the)h(ne)n(w)f(amap.)47 b(After)31 b(adding)f(this)300
697 y(\003ag,)43 b(the)c(UVMHIST)g(trace)h(sho)n(ws)e(that)g(the)h
(number)g(of)g(amap)g(e)o(xtends)f(that)h(cause)g(an)g(amap)300
847 y(reallocation)24 b(w)o(as)h(reduced)g(from)g(ele)n(v)o(en)f(to)g
(one.)300 1230 y Fg(9.3)143 b(UVM)35 b(and)g(the)g(K)l(er)n(nel)g(Deb)m
(ugger)300 1483 y Fs(Another)g(useful)g(tool)g(used)g(in)g(deb)n
(ugging)f(the)h(implementation)e(of)j(UVM)f(is)g(DDB,)h(the)f(k)o
(ernel)300 1632 y(deb)n(ugger)g(b)n(uilt)g(into)f(BSD)i(k)o(ernel.)63
b(If)36 b(DDB)g(is)f(compiled)f(into)h(the)g(k)o(ernel,)j(the)e(k)o
(ernel)f(can)h(be)300 1782 y(stopped)26 b(at)h(almost)e(an)o(y)h(point)
g(and)h(the)f(VM)h(data)g(structure)f(can)h(be)g(e)o(xamined.)36
b(Because)27 b(DDB)h(is)300 1931 y(much)d(easier)h(to)f(enable)h(and)f
(use)h(than)f(source-le)n(v)o(el)f(k)o(ernel)i(deb)n(uggers)f(such)g
(as)h(KGDB)g([63])g(that)300 2080 y(require)e(special)f(serial)h(line)f
(setup,)g(it)g(is)g(e)o(xtremely)f(useful)i(for)f(k)o(ernel)h(de)n(v)o
(elopers)e(deb)n(ugging)h(VM)300 2230 y(problems)d(reported)h(o)o(v)o
(er)f(the)h(Internet.)29 b(In)22 b(these)e(cases)i(the)f(de)n(v)o
(eloper)f(often)h(does)f(not)h(ha)n(v)o(e)g(access)300
2379 y(to)31 b(the)g(hardw)o(are)h(that)f(is)g(e)o(xperiencing)g(the)g
(problem)f(b)n(ut)h(the)o(y)g(can)h(guide)e(the)i(person)f(reporting)
300 2528 y(the)25 b(problem)f(through)f(the)i(process)g(of)g(using)e
(DDB)j(to)e(diagnose)g(the)h(problem.)583 2678 y(K)n(ernels)f(with)f
(DDB)h(enabled)g(e)o(xperience)g(little)e(if)i(an)o(y)f(o)o(v)o(erhead)
h(due)f(to)h(DDB')-5 b(s)24 b(presence)300 2827 y(as)g(DDB)h(is)f
(usual)g(not)g(acti)n(v)o(e.)30 b(DDB)24 b(can)h(be)g(in)l(v)n(ok)o(ed)
e(in)h(one)h(of)f(three)h(cases:)30 b(the)25 b(system)e(crashes,)300
2977 y(the)29 b(k)o(ernel)g(calls)g(the)g Fm(Debugger)e
Fs(function)h(to)h(in)l(v)n(ok)o(e)f(DDB,)i(or)f(the)g(user)g(hits)f(a)
i(special)f(escape)300 3126 y(sequence)i(to)g(break)g(the)g(k)o(ernel)g
(into)f(DDB)1885 3090 y Fj(1)1923 3126 y Fs(.)h(Once)g(running,)h(DDB)f
(prompts)f(for)h(input)f(with)g(the)300 3275 y(\223)p
Fm(db>)p Fs(\224)c(prompt.)35 b(At)27 b(that)f(point)f(the)i(system)e
(operator)i(can)g(e)o(xamine)f(most)f(UVM)h(data)h(structures.)300
3425 y(Useful)32 b(UVM)f(related)h(DDB)g(commands)f(are)h(sho)n(wn)f
(in)g(T)-8 b(able)32 b(9.1.)52 b(In)32 b(addition)e(to)i(these)f(com-)
300 3574 y(mands,)22 b(the)g(standard)f(commands)g(used)h(to)f(set)h
(and)g(clear)h(breakpoints)e(and)h(to)f(single-step)g(through)300
3724 y(k)o(ernel)j(functions)f(are)i(also)f(useful.)30
b(K)n(ernel)23 b(te)o(xt)h(addresses)g(displayed)f(by)g(DDB)i(can)f(be)
h(translated)300 3873 y(to)30 b(their)g(line)g(number)g(in)g(the)g
(source)g(code)h(by)f(using)f(GDB)i(on)f(the)g(object)g(\002le)h(that)f
(contains)f(the)300 4022 y(function)24 b(in)g(question.)300
4406 y Fg(9.4)143 b(UVM)35 b(User)-5 b(-Le)n(v)o(el)32
b(A)l(pplications)300 4659 y Fs(In)19 b(addition)f(to)h(k)o(ernel-le)n
(v)o(el)f(tools)g(such)h(as)g(UVMHIST)g(and)g(DDB,)h(UVM)e(includes)g
(tw)o(o)h(user)n(-le)n(v)o(el)300 4808 y(applications)i(that)g(display)
g(UVM)h(status)f(information.)28 b(In)22 b(traditional)f(systems,)g
(such)h(applications)300 4957 y(require)33 b(special)f(pri)n(vile)o
(ges)f(to)h(run)g(because)h(the)o(y)f(need)h(read)g(access)g(to)f(k)o
(ernel)h(virtual)f(memory)300 5107 y(\()p Fm(/dev/kmem)p
Fs(\))21 b(and)i(the)g(\002le)h(containing)d(the)i(currently)g(running)
f(k)o(ernel.)30 b(Ho)n(we)n(v)o(er)l(,)22 b(in)h(UVM)f(this)p
300 5196 1440 4 v 416 5258 a Fi(1)449 5288 y Fh(On)f(an)f(i386)f(the)h
(DDB)h(escape)f(sequence)f(is)j(CTL-AL)-8 b(T)g(-ESC.)20
b(On)g(a)g(sparc)g(it)h(is)g(L1-A)f(or)g(BREAK.)p eop
%%Page: 203 223
203 222 bop 3751 100 a Fs(203)1268 300 y(T)-8 b(able)25
b(9.1:)30 b(Useful)24 b(UVM)h(DDB)g(Commands)p 488 432
3200 4 v 486 553 4 121 v 538 517 a Fo(Command)p 1486
553 V 551 w(Usage)p 3686 553 V 488 556 3200 4 v 486 917
4 362 v 538 640 a Fm(ps)p 1486 917 V 879 w Fs(Lists)35
b(all)g(acti)n(v)o(e)f(processes)i(on)f(the)g(system.)61
b(If)36 b(the)g(\223a\224)1537 761 y(option)23 b(is)g(speci\002ed)h
(\(\223)p Fm(ps/a)p Fs(\224\),)f(then)h(the)f(k)o(ernel)h(address)1537
881 y(of)h(each)h(processes')f Fm(vm)p 2419 881 30 4
v 35 w(map)f Fs(structure)h(is)f(printed.)p 3686 917
4 362 v 488 921 3200 4 v 486 1643 4 723 v 538 1005 a
Fm(show)59 b(map)p 1486 1643 V 520 w Fs(Sho)n(ws)37 b(the)g(contents)g
(of)g(the)h(speci\002ed)f Fm(vm)p 3164 1005 30 4 v 36
w(map)g Fs(struc-)1537 1125 y(ture.)68 b(If)38 b(the)f(\223f)5
b(\224)38 b(option)e(is)h(speci\002ed,)j(then)d(the)g(list)f(of)1537
1246 y(map)30 b(entries)g(attached)g(to)g(the)g(map)g(is)g(also)f
(printed.)46 b(F)o(or)1537 1366 y(user)23 b(processes,)g(use)f(the)h
(\223)p Fm(ps/a)p Fs(\224)f(command)f(to)h(get)h(map)1537
1486 y(addresses.)42 b(F)o(or)28 b(the)g(k)o(ernel)h(map,)f(use)h(the)f
(\223)p Fm(show)59 b(map)1537 1607 y(*kernel)p 1963 1607
V 35 w(map)p Fs(\224)24 b(command.)p 3686 1643 4 723
v 488 1646 3200 4 v 486 2007 4 362 v 538 1730 a Fm(show)59
b(object)p 1486 2007 V 340 w Fs(Sho)n(ws)41 b(the)h(contents)e(of)i
(the)g(speci\002ed)g Fm(uvm)p 3250 1730 30 4 v 35 w(object)1537
1851 y Fs(structure.)69 b(If)38 b(the)f(\223f)5 b(\224)39
b(option)d(is)i(speci\002ed,)i(then)e(a)g(list)1537 1971
y(of)25 b(all)g(pages)g(in)f(the)h(object)f(is)g(also)h(printed.)p
3686 2007 4 362 v 488 2011 3200 4 v 486 2372 4 362 v
538 2095 a Fm(show)59 b(page)p 1486 2372 V 460 w Fs(Sho)n(ws)29
b(the)f(contents)g(of)h(the)g(speci\002ed)g Fm(vm)p 3113
2095 30 4 v 35 w(page)g Fs(struc-)1537 2215 y(ture.)62
b(If)36 b(the)f(\223f)5 b(\224)37 b(option)d(is)g(speci\002ed,)k(the)d
(e)o(xtra)g(sanity)1537 2336 y(checks)25 b(on)g(the)g(page)g(are)g
(performed.)p 3686 2372 4 362 v 488 2375 3200 4 v 486
2616 4 241 v 538 2459 a Fm(call)59 b(uvm)p 1023 2459
30 4 v 35 w(dump)p 1486 2616 4 241 v 245 w Fs(Sho)n(ws)44
b(the)g(current)h(v)n(alues)f(of)g(the)h(counters)f(used)g(by)1537
2580 y(UVM)25 b(and)f(the)h(k)o(ernel)g(addresses)g(of)g(k)o(ernel)f
(objects.)p 3686 2616 V 488 2619 3200 4 v 300 2993 a(is)f(no)g(longer)g
(the)g(case.)31 b(UVM)23 b(supports)f(a)i Fm(sysctl)e
Fs(system)h(call)g(that)g(an)o(y)g(process)g(can)h(use)f(to)g(get)300
3142 y(UVM)30 b(status)f(information)f(without)h(the)h(need)g(for)h
(special)e(pri)n(vile)o(ges.)45 b(This)29 b(gi)n(v)o(es)g(normal)g
(users)300 3292 y(the)c(\003e)o(xibility)e(to)h(write)h(their)g(o)n(wn)
f(status)g(gathering)g(programs)g(without)f(the)i(need)g(to)g(bother)f
(their)300 3441 y(system)g(administrator)-5 b(.)583 3590
y(The)37 b(\002rst)g(UVM)g(status)f(program)g(is)h(called)f
Fm(uvmexp)p Fs(.)66 b(It)37 b(is)f(a)h(simple)f(te)o(xt-based)g(pro-)
300 3740 y(gram)42 b(that)f(gets)g(the)h(status)f(of)h(UVM,)f(prints)g
(it,)46 b(and)41 b(e)o(xits.)81 b(This)41 b(is)g(much)h(lik)o(e)f(the)h
(\223)p Fm(call)300 3889 y(uvm)p 486 3889 30 4 v 35 w(dump)p
Fs(\224)34 b(command)f(in)g(DDB.)i(The)f(second)f(UVM)h(status)f
(program)h(is)f(an)h(X11-based)g(pro-)300 4039 y(gram)25
b(called)h Fm(xuvmstat)p Fs(.)32 b(This)25 b(program)g(creates)h(a)g
(windo)n(w)e(and)i(graphically)f(displays)f(v)n(arious)300
4188 y(system)33 b(counts)g(\(updating)g(the)h(display)f(once)h(a)h
(second\).)58 b(A)34 b(screen)h(dump)e(of)h(the)g Fm(xuvmstat)300
4337 y Fs(program)24 b(is)h(sho)n(wn)e(in)i(Figure)g(9.2.)300
4721 y Fg(9.5)143 b(Summary)300 4973 y Fs(In)28 b(this)g(chapter)g(we)h
(ha)n(v)o(e)f(re)n(vie)n(wed)g(the)g(methods)f(used)h(to)g(implement)f
(and)h(deb)n(ug)g(UVM.)g(UVM)300 5123 y(w)o(as)k(implemented)e(in)h
(four)h(phases.)50 b(First)32 b(the)f(design)g(of)h(the)f(BSD)i(VM)e(w)
o(as)h(studied.)50 b(Second,)300 5272 y(UVM')-5 b(s)20
b(core)h(memory)e(mapping)h(and)g(page)h(f)o(ault)f(functions)g(were)h
(implemented)e(and)h(tested)g(under)p eop
%%Page: 204 224
204 223 bop 3751 100 a Fs(204)300 249 y(a)27 b(system)f(running)h(BSD)g
(VM.)g(Third,)g(virtual)f(memory)h(management)f(of)h(all)g(user)n
(-processes)g(w)o(as)300 398 y(switched)22 b(from)h(BSD)h(VM)e(to)h
(UVM.)f(Finally)-6 b(,)22 b(the)h(k)o(ernel')-5 b(s)23
b(memory)f(management)g(w)o(as)h(switched)300 548 y(o)o(v)o(er)29
b(to)g(UVM.)h(Throughout)e(the)i(implementation)d(process,)k(changes)f
(made)f(to)h(the)f(BSD)i(source)300 697 y(tree)25 b(were)g(mer)n(ged)f
(into)f(the)h(UVM)g(k)o(ernel)g(source)g(tree)h(using)e(CVS.)i(This)f
(eased)g(of)h(inte)o(gration)d(of)300 847 y(UVM)i(into)f(the)g(main)h
(source)g(tree.)31 b(Additionally)-6 b(,)21 b(UVM)j(w)o(as)g(designed)f
(to)h(co-e)o(xist)f(in)g(the)h(source)300 996 y(tree)31
b(with)f(BSD)h(VM.)f(This)g(allo)n(ws)f(for)i(a)f(smooth)f(transition)g
(for)i(BSD)h(users)e(from)g(BSD)h(VM)f(to)300 1145 y(UVM.)583
1295 y(The)c(UVMHIST)f(tracing)g(f)o(acility)-6 b(,)24
b(UVM)g(DDB)i(commands,)e(and)h(UVM)g(status)f(programs)300
1444 y(were)33 b(also)f(presented)g(in)h(this)e(chapter)-5
b(.)54 b(UVMHIST)32 b(allo)n(ws)f(k)o(ernel)i(de)n(v)o(elopers)e(to)h
(produce)g(dy-)300 1594 y(namic)i(code)h(traces)g(through)f(the)g(VM)g
(system.)59 b(This)34 b(helps)g(de)n(v)o(elopers)f(better)h(understand)
g(the)300 1743 y(operation)g(of)i(UVM)e(and)h(also)g(w)o(as)g(used)g
(to)g(detect)g(redundant)f(calls)h(in)g(the)g(VM)g(system.)60
b(The)300 1892 y(UVM)25 b(DDB)i(commands)e(allo)n(w)f(a)j(user)f(to)f
(easily)h(e)o(xamine)f(the)h(state)f(of)h(UVM)g(on)f(a)i(running)e
(sys-)300 2042 y(tem.)30 b(The)24 b(UVM)g(status)f(programs)g(are)i(b)n
(uilt)e(on)g(top)h(of)g(a)g(non-pri)n(vile)o(ged)e(system)h(call)h
(that)f(allo)n(ws)300 2191 y(users)i(to)f(query)h(the)f(status)g(of)h
(UVM.)p eop
%%Page: 205 225
205 224 bop 3751 100 a Fs(205)p 1009 338 2182 4 v 1009
4907 4 4570 v 1037 4882 a @beginspecial 156 @llx 77 @lly
456 @urx 715 @ury 2550 @rwi @setspecial
%%BeginDocument: ../figures/xuvmstat.ps


% remember original state
/origstate save def

% build a temporary dictionary
20 dict begin

% define space for color conversions
/grays 300 string def  % space for gray scale line
/npixls 0 def
/rgbindx 0 def

% lower left corner
156 77 translate

% size of image (on paper, in 1/72inch coords)
300.02400 637.99200 scale

% define 'colorimage' if it isn't defined
%   ('colortogray' and 'mergeprocs' come from xwd2ps
%     via xgrab)
/colorimage where   % do we know about 'colorimage'?
  { pop }           % yes: pop off the 'dict' returned
  {                 % no:  define one
    /colortogray {  % define an RGB->I function
      /rgbdata exch store    % call input 'rgbdata'
      rgbdata length 3 idiv
      /npixls exch store
      /rgbindx 0 store
      0 1 npixls 1 sub {
        grays exch
        rgbdata rgbindx       get 20 mul    % Red
        rgbdata rgbindx 1 add get 32 mul    % Green
        rgbdata rgbindx 2 add get 12 mul    % Blue
        add add 64 idiv      % I = .5G + .31R + .18B
        put
        /rgbindx rgbindx 3 add store
      } for
      grays 0 npixls getinterval
    } bind def

    % Utility procedure for colorimage operator.
    % This procedure takes two procedures off the
    % stack and merges them into a single procedure.

    /mergeprocs { % def
      dup length
      3 -1 roll
      dup
      length
      dup
      5 1 roll
      3 -1 roll
      add
      array cvx
      dup
      3 -1 roll
      0 exch
      putinterval
      dup
      4 2 roll
      putinterval
    } bind def

    /colorimage { % def
      pop pop     % remove 'false 3' operands
      {colortogray} mergeprocs
      image
    } bind def
  } ifelse          % end of 'false' case



% define the colormap
/cmap 24 string def


% load up the colormap
currentfile cmap readhexstring
000000 0000c8 0000f8 208820 a020f0 e87400 f80000 f8fcf8 
pop pop   % lose return values from readhexstring


% rlecmapimage expects to have 'w h bits matrix' on stack
/rlecmapimage {
  /buffer 1 string def
  /rgbval 3 string def
  /block  384 string def

  % proc to read a block from file, and return RGB data
  { currentfile buffer readhexstring pop
    /bcount exch 0 get store
    bcount 128 ge
    {  % it's a non-run block
      0 1 bcount 128 sub
      { currentfile buffer readhexstring pop pop

        % look up value in color map
        /rgbval cmap buffer 0 get 3 mul 3 getinterval store

        % and put it in position i*3 in block
        block exch 3 mul rgbval putinterval
      } for
      block  0  bcount 127 sub 3 mul  getinterval
    }

    { % else it's a run block
      currentfile buffer readhexstring pop pop

      % look up value in colormap
      /rgbval cmap buffer 0 get 3 mul 3 getinterval store

      0 1 bcount { block exch 3 mul rgbval putinterval } for

      block 0 bcount 1 add 3 mul getinterval
    } ifelse
  } % end of proc
  false 3 colorimage
} bind def


300 638 8			% dimensions of data
[300 0 0 -638 0 638]		% mapping matrix
rlecmapimage

7f017f012b01
7f017f012b01
7f017f012b01
02010e077f0174010e0703010e070201
02018107010b018107010f0101077f016101810701040101070401810701020181070102
01810701010181070102018107010101
02018107010b018107010f018107012c0101070a0101077f012501810701040101070401
81070102018107010201810701010181070102018107010101
02018107010201040703018107010e0101072d0101070a0101077f012501810701020105
07020181070102018107010201810701010181070102018107010101
02018107010101060702018107010e018207010781070101010107810107810701010101
078101078107010201010781010782070107820701070107030103070101040701010307
010104077f01240181070101018107018101078107018201070182010701020181070102
01810701010181070102018107010101
0201810701810107070701018107010d0101078101078107018101078107018101078107
010101010781010781070102010107810107010781010701078101078107018101078107
018101078107018101078107010101010701010107010101077f01260181070182010701
010101070201830701070102010507020181070102018107010101
0201810701810107070701018107010d0181070101018207010781070181010781070102
010107810107810701010101070101010701010107010101070101010705010107060101
07010101077f012601810701820107018101070207010183070107010201810701060181
070102018107010101
0201810701810107070701018107010c0101070201020702010107020101070101010701
010107010101070101010701010107030102070201010703010407010101077f01270106
07010105070301810701060181070102018107010101
0201810701810107070701018107010c0181070102010207020101070201010701010107
010101070101010701010107010101070501010701010107020101070101010701010107
7f0127010607010105070301810701060181070102018107010101
0201810701810107070701018107010b0101070201010782010701810107810701010101
070301820701078107010101010701010107010101078101078107010101010781010781
070101010107020101078101078107017f01270181070182010701810107020701018307
0107010201090703018107010101
020181070101010607020181070107010107010181070101010107010101078101078107
018101070107030102070201010701010107010101070101010701010107010101070201
010701010107010101077f01280181070182010701010101070201830701070102018107
010b018107010101
020181070102010407030181070107010107810107810701810107810701010101070101
020781010781070102010107030101070101010701010107020103070301010702010207
8101078107018101078107017f0126018107010101810701810107810701820107018201
070102018107010b018107010101
02018107010b018107017f01730181070102010507020181070102018107010b01810701
0101
02018107010b018107017f01730181070104010107040181070102018107010b01810701
0101
02010e077f0174010e0703010e070201
7f017f012b01
7f017f012b01
7f017f012b01
7f027f022b02
7f027f022b02
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
040701000207010081070081000701070100810700810007010701000907040002070100
0d070100250701000c0706001c0702000a0702000b070400010706000b07010004070200
0b070400020704000c070100030704002007
040701000207010081070081000701070100810700810007010701000807010002070100
010701000d070100250701000c07010003078100070a0701000f0701000b0701000a0701
00020701008107008100070e070200030701008107008100070807010002070100810700
810007010701000a07020002070100020701001f07
040701000207010081070081000701070100810700010081070001000807010002070100
010701000d070100250701000c070100100701000f0701000b0701000a07010002070100
8107008100070d0703000207010002070100030701000207010002070100810700810007
01070100030701000307030002070100020701001f07
040701000207010081070081000701070100810700050008070100060701000507040002
0701000407010002070100010704000a070400020701000c070100050705001607010081
070081000701070100030701000f07010081070004000c07010002070100020701000207
03000607010081070081000701070100020703000407010002070100020701001f07
040701000207010001078100070107810007810700840007000700810007080704000107
05000607010081070004000107010002070100810700810007010701000d070100810700
0400090704000207020001070100020702000f0701008107008100070107010003070100
0e07010001070200010701000b0701000207010002070100030701000607010002070400
0407010005070100030704002007
040701000207010001070100810700810007810700810007010701000d07010001070100
05070500010701000407010002070100010703000b070500010701000c07010005070100
080701000f07010081070081000701070100030701000d070100070701000b0701000207
0100020701000b07010002070100020701000b07010002070100020701001f07
040701000207010001070100810700810007810700810007010701000d07010001070100
040701000207010001070100040701000207010002070300090701000207010001070100
0c07010005070100080701000f07010081070081000701070100030701000c0701000807
01000b07010002070100020701000a07010003070100020701000b070100020701000207
01001f07
040701000207010002070200020701000207010008070100020701000107010004070100
02070100010701000407010002070100050701000807010002070100010701000c070100
05070100080701000a0701000207010081070081000701070100030701000b0701000907
01000b070100020701000207010003070100030701000407010002070100030701000507
010002070100020701001f07
040701000207010002070200020701000207010008070100020701000107010001070100
810700810007810700010001070100010701008107008100078107000100810700810007
01070100080701000107020001070100010701000807010005070100080701000a070100
020701008107008100078107000100030701000a07010005070100020701000b07010003
070100810700810007020703000107010005070100020701000207030004070100020701
00020701001f07
050704000407810007020701000207010009070400030703000207050002070300020705
00010704000a070500020703000907010005070100070703000a07040002070500020703
0009070600010704000a0705000207020005070100020706000107040004070100030705
00010704002007
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f007f002b00
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
04070400820700070f07810007010783000700070107830007000701078100075f070400
0107020002070200020702000a078100070207810007020702000207020007078100075e
07
060781000701078100070f07810007010783000700070107830007000701078100071807
810007480783000700070107830007000701078300070007010781000708078100070107
83000700078207000701078300070007010781000705078100070a078100075107
060781000701078100070f07810007010783000700070107820007008200070081000718
078100074707810007820700070307810007010783000700070b07010001078100070107
83000700070107830007000709078100070a078100075107
060781000701078200070081000701070200070781000701078300070007010787000700
070007000706070200010781000701078100078107000100010703000207020001070100
820700070607010082070007010702000107820007008100070107020002070200020702
00020702000a0781000782070007070783000700070a0783000700078207000701078300
070007010783000700070907030001078100070107820007000200020702000707030002
0702000207020002070200020702002607
060781000701070100010783000700070107810007050781000701078100078407000700
078607000700070007050781000701078300070007010783000700070107810007820700
070207810007010787000700070007000705078500070007000703078200070081000782
070007030783000700070107830007000701078300070007010781000707078100070107
030004078100078107000200080783000700078207000701078100078107000200810700
020001070400820700070107830007000701078100078207000702078100070107810007
050781000701078100070307830007000701078300070007010783000700070107810007
2407
060781000701078100070107820007000300060781000701078100078407000700078207
000701078100070607010002078100070107810007810700810007020781000702070400
860700070007000705078500070007000781070002008207000701078100078107000200
820700070107820007000300010701000a07810007010781000701078100070107810007
010781000701078100070507810007820700078207000701078100070307830007000701
078100070507810007010783000700070107810007820700070207040006078100070107
8100078107000200820700070107820007000300010701002707
060781000701078100070107830007000709078100070107810007840700070007820700
070107810007080781000782070007810700810007020781000701078100070207810007
030785000700070007050787000700070007000701078300070007010783000700070107
830007000701078300070007060781000707078100070207810007010781000782070007
020781000701078100070507040082070007010781000703078300070007010781000705
078100070107830007000781070081000782070007020781000709078100070107830007
0007010783000700070107830007000706078100072507
060781000701078100070107830007000701078100070507810007010781000701078100
070107810007010781000705078100070107810007810700850007000700070107810007
820700078407000700070107870007000700070007050787000700070007000701078300
070007010783000700070107810007810700020082070007010783000700070107810007
060781000702078100070107830007000703078100070107810007080781000701078300
070007820700070107830007000701078100070507810007010781000781070083000700
078207000784070007000701078100070507030001078100070107810007810700020082
0700070107830007000701078100072407
060781000701078100070107810007810700010008070200030781000701078100070107
810007060702000507810007810700010003070100020702000107810007010781000705
078100070107810007810700020082070007010781000781070002000407810007810700
01000207020008078100070307020001070400010702000a078100070207810007020702
000207020007070300050781000701070100020702000707810007040703000407810007
8107000100020702002607
3a0781000701078100073507810007010781000753078100070107810007110781000709
0781000701078100073007
3b070200380702005607020013078100070a0702003207
7f077f072b07
7f077f072b07
7f077f072b07
04077f060a0638023403020523040607
04077f060a0638023403020523040607
04077f060a0638023403020523040607
04077f060a0638023403020523040607
04077f060a0638023403020523040607
04077f060a0638023403020523040607
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
3a0704060107020602070206010704065607810207010704020207810207030781020709
070103270781030704078103070207810307010704032507
110781060704078106072307830607060701078306070607010781060703078106071307
810207140781020704078102072007010202078102070407830207020701078302070207
0707810307820703072407010305078103070107830307030704078103072407
1107810607290781060782070607030781060706078106072b0781020726078302070207
010781020703078102070107830207020701078102070607810307260783030703070307
01030107810307010781030702078103072507
050702060207020601070306020701060207810607010781060781070601060707040608
078106070107810607030781060705078106071407010202078202070281020701070202
020702020107030202070102020781020701078102078107020102070704020807810207
010782020702810207820702070107830207020701078102070607810307020782030703
810307010702030207020307070403080781030702078303070307820703070107810307
02078103072507
080783060706070107810607820706070407810607010781060701078306070607010781
060712070206010703060107030602070206150781020701070102010781020703078302
070207010781020782070207040781020701078102070107830207020701078102071307
810207010701020107830207020701078302070207010781020705070303010701030107
830307030701078303070307010781030713078103070207830307030782070307010781
030701078103072607
050703068207060704078106070407810607010781060701078206070603061607830607
060701078306070607010781060703078106071307810207010781020701078102078107
020202820702070407810207040781020701078102070107820207020302140781020705
078302070207010783020702070107810207060781030702078103070307040381070303
03140781030701078103078207030782070307010781030701078103072607
040781060701078306070607040781060704078106070207830607060782070607090704
060a07830607060701078306070607010781060703078106071307810207010781020701
078302070207010783020702070407810207040781020702078302070207820702070907
040208078102070507830207020701078302070207010781020706078103070207810307
030781030703078103070907040308078103070107040382070307010781030782070307
2707
040781060701078306070607010781060782070607820706070107810607020783060706
078207060701078106071107810607010783060706070107830607060701078306070607
010781060713078102070107810207010783020702070107830207020701078102078207
020782070207010781020702078302070207820702070107810207130781020701078102
070107810207840702070207010783020702070707810307020781030703078103070107
83030703070107810307130781030704078103070107830307030701078103072707
050703060107020603070106020702060307810607020702061407020602070206020702
060207020614070202010781020701078102078107020202010702020307010202070202
030781020702070202130704020107020203078102070307810207080781030702078103
070407020302070203130704030307810307020781030702078103072707
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
200781050712070205010704052b07010403070104120781040712070204020702040107
04047f07
0c0781050711078105071107810507010781050703078105072b07810407030781040711
07810407110781040701078304070407010781040703078104077e07
20078105071107810507010781050702078105072c078104070307810407110781040711
078104070107830407040706078104077f07
040781050701078105078107058105070107820507058105070107020502070305060704
050607810507010781050701078105072607020403078104070307810407020702040207
0204020703040607040406078104070107830407040705078104077f070007
040781050701078105070107810507010701050107830507050701078305070507010781
050712070305010702052907810407010781040703078104070107810407010783040704
07010783040704070107810407120703048107040204020702047f070007
040785050705070507010781050701078105070307040582070507010781050715078105
070307810507240703040207810407030781040701078104070107830407040703078104
07010781040715078304070407010781040703078104077e07
040785050705070507010781050701078105070307810507030781050701078105070507
04050a078105070307810507230781040701078104070107810407030781040701078104
070107830407040703078104070107810407050704040a07830407040701078104070307
8104077e07
040785050705070507010781050701078105070307810507010783050705070107810507
110781050701078305070507010781050723078104070107810407010781040703078104
070107810407010783040704070107830407040701078104071107810407010783040704
070107830407040701078104077e07
050783050705070107020501078105070407020502070305130702050207020526070304
01070204020702040207020402070204020703041307020402070204020702047f070007

7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
040701007f077f072407
040701007f077f072407
040701007f077f072407
040701007f077f072407
040701007f077f072407
040701007f077f072407
7f077f072b07
040702007f077f072307
040702007f077f072307
040702007f077f072307
040702007f077f072307
040702007f077f072307
040702007f077f072307
7f077f072b07
040734037f077107
040734037f077107
040734037f077107
040734037f077107
040734037f077107
040734037f077107
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
060701003807020004078100074b0701004a070200010704003c07
05078100078207000719078100071907810007010781000702078100074a078100078207
000712078100071b078100071407810007010783000700073f07
05078100073807810007050701004b0781000715078100071b0781000714078100070107
83000700073f07
050781000702078200070081000701070200020702000107010082070007010701000207
82000700810007060704000607810007040783000700074a078100070207820007008100
070107020002070200010703000207020001078200070081000701070200020702000107
030007070400060781000701078400070007008100073c07
040703000107010001078300070007010783000700070107870007000700070007010781
000701070100010781000711070300020783000700074907030001070100010783000700
070107830007000701078100078207000706078200070081000784070007000701078300
070007010781000782070007150702000107010001078100073b07
050781000702078100070307040081070003008607000700070007010781000701078100
070107810007110781000701078300070007820700074a07810007020781000703070400
810700030001078100070307030082070007030781000701078200070003000107810007
1407810007010781000703078100073b07
050781000702078100070307810007030781000703078500070007000701078100070107
810007010781000705070400060781000701078200070003004a07810007020781000703
078100070307810007040781000702078100070107830007000703078100070107830007
00070407810007080704000607810007010781000703078100073b07
050781000702078100070307810007010783000700070107870007000700070007010781
0007010781000701078100071107810007010781000702078100074a0781000702078100
070307810007010783000700070107810007820700078407000700070107830007000704
070300820700070107810007820700078207000711078100070107830007000701078100
073b07
050781000702078100070407020002070200010781000701078100078107000100010781
000701078100071207020004078100074a07810007020781000704070200020702000307
01000207030082070007070781000781070001000307010014070200020702003d07
7f073f0781000701078100076507
7f07400702006707
7f077f072b07
7f077f072b07
06070103270781030704078103070207810307010704037f076507
0507810307820703072407010305078103070107830307030704078103077f076407
050781030726078303070307030701030107810307010781030702078103077f076507
050781030702078203070381030701070203020702030707040308078103070207830307
030782070307010781030702078103077f076507
040703030107010301078303070307010783030703070107810307130781030702078303
07030782070307010781030701078103077f076607
050781030702078103070307040381070303031407810307010781030782070307820703
07010781030701078103077f076607
050781030702078103070307810307030781030709070403080781030701070403820703
070107810307820703077f076707
050781030702078103070307810307010783030703070107810307130781030704078103
070107830307030701078103077f076707
050781030702078103070407020302070203130704030307810307020781030702078103
077f076707
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
040738027f076d07
040738027f076d07
040738027f076d07
040738027f076d07
040738027f076d07
040738027f076d07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7207810007640781020701070402020781020703078102073d07
06078100071407810007040781000714078100071b078100071507830007000721078102
071407810207040781020720070102020781020704078302070207010783020702073c07

1d078100071b078100071b07810007140781000701078100073707810207260783020702
07010781020703078102070107830207020701078102073b07
050701000207820007008100070107020002070200010703000207010002078100070107
810007810700010007070300020702000107820007008100070107020002070200010703
0007070400060781000701078100071f0701020207820207028102070107020202070202
010703020207010202078102070107810207810702010207070402080781020701078202
0702810207820702070107830207020701078102073b07
060781000701070100010781000703078300070007010781000782070007040781000701
078100070107830007000701078100070607810007060782000700810007840700070007
010783000700070107810007820700071407810007010781000720078102070107010201
078102070307830207020701078102078207020704078102070107810207010783020702
070107810207130781020701070102010783020702070107830207020701078102073b07

060781000701078100070107810007810700020082070007040781000704078100070107
810007010782000700030007078100070307030082070007030781000701078200070003
000107810007140781000701078100072007810207010781020701078102078107020202
820702070407810207040781020701078102070107820207020302140781020705078302
0702070107830207020701078102073b07
060781000701078100070107830007000701078300070007040781000704078100070207
8300070007820700070a0781000702078100070107830007000703078100070107830007
000704078100070807040006078100070107810007200781020701078102070107830207
020701078302070207040781020704078102070207830207020782070207090704020807
810207050783020702070107830207020701078102073b07
060781000701078100070107830007000701078300070007010781000782070007820700
070107810007020783000700078207000701078100070607810007840700070007010783
000700070407030082070007010781000782070007820700071207830007000721078102
070107810207010783020702070107830207020701078102078207020782070207010781
020702078302070207820702070107810207130781020701078102070107810207840702
070207010783020702073c07
050702000107810007010781000781070002000107020003070100020702000307810007
020702000907010002070300820700070707810007810700010003070100150781000721
070202010781020701078102078107020202010702020307010202070202030781020702
0702021307040201070202030781020703078102073d07
4c0781000701078100077f075807
4d0702007f075a07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
04075f007f074607
04075f007f074607
04075f007f074607
04075f007f074607
04075f007f074607
04075f007f074607
7f077f072b07
040702057f077f072307
040702057f077f072307
040702057f077f072307
040702057f077f072307
040702057f077f072307
040702057f077f072307
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
20078100072a070200010704000307810007010702004e0781050712070205010704055a
07
0c0781000711078100072907810007010783000700070607810007820700070107810007
380781050711078105071107810507010781050703078105075907
200781000729078100070107830007000705070100010781000701078100074c07810507
1107810507010781050702078105075a07
040781000701078100078107008100070107820007008100070107020002070300060701
00820700070107020001078100070107810007050704000a078400070007008100070107
830007000704078100073007810507010781050781070581050701078205070581050701
07020502070305060704050607810507010781050701078105075b07
040781000701078100070107810007010701000107830007000701078300070007010781
000705078500070007000703078100078407000700071507810007810700810007820700
078407000700070307810007310781050701078105070107810507010701050107830507
050701078305070507010781050712070305010702055b07
040785000700070007010781000701078100070307040082070007010781000705078500
070007000781070002000207810007150781000705078300070007820700070207810007
320785050705070507010781050701078105070307040582070507010781050715078105
0703078105075907
040785000700070007010781000701078100070307810007030781000701078100070507
870007000700070007010781000701078100070707040007078100070607820007000300
010781000733078505070507050701078105070107810507030781050703078105070107
810507050704050a0781050703078105075907
040785000700070007010781000701078100070307810007010783000700070107810007
050787000700070007000701078100078407000700071207810007030781000701078100
070207810007820700073407850507050705070107810507010781050703078105070107
8305070507010781050711078105070107830507050701078105075907
050783000700070107020001078100070407020002070300060781000701078100078107
000200820700070107810007110704000107020004078100078107000300320783050705
07010702050107810507040702050207030513070205020702055b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
02077f00110002077f0011000107
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
020781000701070400020781000701078100070107830007000703070400010702001007
810007180704000207810007010704000107810007290781000701078100070107040081
070002000307810007010703000207020010078100071807040001070200010704000107
8100072f078100070007
020781000701078100070407830007000782070007010783000700070507810007010781
000701078100070d078100071d0781000784070007000704078100070107810007280781
000701078100070307810007010781000701078100078407000700078207000701078300
07000701078100070d078100071907810007030781000701078100070307810007010781
00072e078100070007
020781000701078100070307810007010783000700070107830007000705078100070107
81000711078100071c078100078207000701078100070207810007020781000728078100
070107810007030781000701078100070107830007000701078300070007010783000700
071107810007190781000703078100070107810007020781000702078100072e07810007
0007
020781000701078100070307810007010783000700070107830007000705078100070107
810007100781000702070100820700070107020001078100070107820007000300020781
000701078100070107810007020781000703078100072707810007010781000703078100
070107810007010783000700070107830007000701078300070007100781000702070100
820700070107020001078100070107820007000300830700070081000782070007010781
0007020781000703078100072d078100070007
020781000701070300010781000701078300070007010783000700070507810007020702
000e07810007020785000700070007030781000784070007000707070200010781000701
078100070107810007040781000727078100070107810007030781000701070300010781
00070107820007000200020702000e078100070207850007000700070307810007840700
0700070607010001078100078107000200020781000704078100072d078100070007
02078100070107810007030704008207000701078300070007050781000705078100070c
07810007020785000700070007810700020002078100070b078300070007010781000701
078100070407810007270781000701078100070307810007010783000700070107040082
07000707078100070c07810007020785000700070007810700020002078100070b078100
070307810007010781000704078100072d078100070007
020781000701078100070307810007010783000700070107830007000705078100070507
8100070d0781000701078700070007000700070107810007010781000701070400040783
000700070107810007820700070407810007280781000701078100070307810007010781
000782070007820700070107830007000707078100070d07810007010787000700070007
00070107810007010781000701070400040781000703078100078207000704078100072e
078100070007
020781000701078100070307810007010783000700070107830007000705078100070107
81000701078100070d078100070107870007000700070007010781000784070007000706
078100070107810007840700070007010781000704078100072807810007010781000703
0781000701078100070107830007000701078300070007030781000701078100070d0781
000701078700070007000700070107810007840700070007060781000701078300070007
01078100078207000704078100072e078100070007
020781000701078100070307810007010781000781070001000107040002078100070207
020010078100078207000701078100078107000200820700070107810007060702000307
810007020781000703078100072907810007010781000703078100070107810007010783
000700070107830007000704070200100781000782070007010781000781070002008207
000701078100070607020002070200020781000703078100072f078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02077f00110002077f0011000107
0207810007170781000707078100076a0781000701078100077b07810007100781000700
07
0207810007170781000707078100076a0781000701078100077b07810007100781000700
07
0207810007170781000707078100076a0781000701078100077b07810007100781000700
07
0207810007170781000707078100076a0781000701078100077b07810007100781000700
07
0207810007170781000707078100076a0781000701078100077b07810007100781000700
07
0207810007170781000707078100076a0781000701078100077b07810007100781000700
07
0207810007170781040707078100076a0781000701078100077b07810007100781000700
07
02078100070d07810007070781040707078100076a0781000701078100077b0781000710
078100070007
02078100070d078100070707810407070701006a0781000701078100077b078100071007
8100070007
020781000703078100070707810007060783000400070507830007000769078100070107
8100077b0781000710078100070007
020781000703078100070707810007060783000400070507830007000769078100070107
8100077a0783000700070f078100070007
020781000703078100070707810007060783000400070507830007000769078100070107
8100077a0783000700070f078100070007
020781000703078100070707810007060783000400070507830007000769078100070107
8100077a0783000700070f078100070007
020781000703078100070707810007060783000400070507830007000769078100070107
8100077a0783000700070f078100070007
020781000703078100070707810007060783000400070507830007000769078100070107
8100077a0783000700070f078100070007
020781000703078100070707010006078304070407050783000700076907810007010781
00077a0783000700070f078100070007
020781000703078100070607830007000705078304070407050783000700076907810007
01078100077a0783000700070f078100070007
020781000703078100070607830007000705078304070407050783000700076907810007
01078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070507830407040705078300070007690781
000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070407840004070407050781000782070007
680781000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070407850004070400070307810007010781
0007680781000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070407850004070400070307810007010781
0007680781000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070407850004070400070307810007010781
0007680781000701078100077a0783000700070f078100070007
020781000702078300070007050783000700070407850004070400070307810007010781
0007680781000701078100077a0783000700070f078100070007
020781000702078300070007050781000782070007030781040783070400070307810007
010781000768078100070107810007790781000701078100070e078100070007
020781000702078300070007040781000701078100070307810407010781040703078100
07010781000768078100070107810007790781000701078100070e078100070007
020781000702078300070007040781000701078100070307810407010781040703078100
07010781000768078100070107810007790781000701078100070e078100070007
020781000701078100070107810007030781000701078100070307810407010781040703
07810007010781000768078100070107810007790781000701078100070e078100070007

020781000701078100070107810007030781000701078100070307810407010781040703
078100070107810007050781000760078100070107810007790781000701078100070e07
8100070007
020781000701078100070107810007030781000701078100070307810407010781040703
078100070107810007050781000760078100070107810007790781000701078100070e07
8100070007
020781000701078100070107810007030781000701078100070307810407010781040703
078100070107810007050781000760078100070107810007790781000701078100070e07
8100070007
020781000701078100070107810007030785000704070007030781040701078104070307
8100070107810007050781000760078100070107810007790781000701078100070e0781
00070007
020781000701078100070107810007030785000704070007030781040701078104070307
8100070107810007050781000760078100070107810007790781000701078100070e0781
00070007
020781000701078100070107810007030785000704070007030781040701078104070307
8100070107810007050781000760078100070107810007790781000701078100070e0781
00070007
020781000701078100070107810007030785000704070007030781040701078104070307
8100070107810007040783000700075f0781000701078100070307810007730781000701
078100070e078100070007
020781000701078100070107810007030785000704070007030781040701078104070307
8100070107810007040783000700075f0781000701078100070307810007730781000701
078100070e078100070007
020781000701078100070107810007030782000704820400070207820004070107810407
03078100070107810007040783000700075f078100070107810007030781000773078100
0701078100070e078100070007
020781000701078100070107810007030785000407040007020782000407010781040703
078100070207810007030783000700075f07810007010781000703078100077307810007
01078100070e078100070007
020781000701078100070107810007030785000407040007020782000407010782040007
01078100070307810007030783000700075f078100070107810007030781000773078100
0701078100070e078100070007
020781000701078100070107810007030785000407040007020782000407010782040007
01078100070307810007030783000700075f078100070107810007030781000773078100
0701078100070e078100070007
020781000701078100070107810007030786000407040700070107810407020782040007
01078100070307810007030783000400075f078100070107810007030781000773078100
0701078100070e078100070007
020781000701078100070107810007030786000407040700070107810407020782040007
01078100070307810007030783000400075f078100070107810007020783000700071a07
810007550781000701078100070e078100070007
020781000701078100070107810007020787000704070407000701078104070307810407
01078100070307810007030783000400075f078100070107810007020783000700070607
81000707078100070707810007550781000701078100070e078100070007
020781000782070007030781000701078700070407040700070107810407030781040701
078100070307810007030783000400075f07810007010781000702078300070007060781
000707078100070707810007550781000701078100070e078100070007
020781000782070007030781000701078700070407040700070107810407030781040701
07810007030781000702078400070400075f078100070107810007020783000700070607
81000707078100070707810007540781000703078100070d078100070007
020781000782070007030781000701078700070407040700070107810407030781040701
0781000703078100070207850004070400075e0781000701078100070207830007000706
0781000707078100070707810007540781000703078100070d078100070007
020781000782070007030781000701078300070407830704000701078104070307810407
010781000703078100070207850004070400075e07810007010781000702078300070007
060781000707078100070707810007540781000703078100070d078100070007
020781000782070007030781000701078200040701078204000701078104070307810407
010781000782070407820700070207850004070400075e07810007010781000702078300
0700070607810007070781000706078300070007530781000703078100070d0781000700
07
020781000782070007030781000701078200040701078204000701078104070307810407
010781000782070407820700070207850004070400075e07810007010781000702078300
070007050783000700070507830007000705078300070007530781000703078100070d07
8100070007
020781000782070007820704078207000701078200040701078204000701078104070307
810407010781000782070407820700070207850004070400075e07810007010781000702
078300070007050783000700070507830007000705078300070007530781000703078100
070d078100070007
020781000782070007820704078207000701078200040701078204000701078104070307
810407010781000782070407820700070207850004070400075e07810007010781000702
078300070007050783000700070507830007000705078300070007530781000703078100
070d078100070007
020781000782070007820704078207000701078200040701078204000701078104070307
81040701078700070407040700070207850004070400075e078100070107810007020783
00070007050783000700070507830007000705078300070007530781000703078100070d
078100070007
020781000782070007820704078207000701078200040701078204000701078104070307
81040701078700070407040700070207850004070400075e078100070107810007020783
00070007050783000700070507830007000705078300070007530781000703078100070d
078100070007
020781000788070007040704070007010782000407010782040007010781040703078104
070107870007040704070007020781040783070400075e07810007010781000701078100
070107810007040783000700070507830007000705078300070007530781000703078100
070d078100070007
020781000788070007040704070007010782000407010782040007830700040703078104
070107870007040704070007020781040701078104075e07810007010781000701078100
070107810007040783000700070507830007000705078300070007530781000703078100
070d078100070007
020781000788070007040704070007010782000407010782040007830700040703078104
0701078500070407040782070007830700040701078104075e0781000701078100070107
810007010781000704078300070007050783000700070507830007000753078100070307
8100070d078100070007
020781000788070007040704070007010782000407020784040007040704078404000700
078407040704078207000783070004070107820400075d07810007010781000701078100
07010781000704078300070007050783000700070507830007000706078100074a078100
0703078100070d078100070007
020781000788070007040704070007010782000407020784040007040704078404000700
078407040704078207000783070004070107820400075d07810007010781000701078100
070107810007040783000700070507830007000705078100078207000705078100074a07
81000703078100070d078100070007
020781000788070007040704070007010781040703078404000704070407840400070007
820704078407040700078307000407010782040007180781060742078100070107810007
010781000701078100070407810007820700070307810007820700070407810007010781
000705078100074a0781000703078100070d078100070007
020783000700078407040704078507000700040703078404000704070507850407000704
070107830407000783070004070107820400071807810607420781000701078100070107
810007010781000703078100070107810007030781000701078100070307810007010781
000705078100074a0781000703078100070d078100070007
020785000700070407010786040700070004070307840400070407050785040700070407
010783040700078307000407010782040007180781060742078100070107810007010781
000701078100070307810007010781000703078100070107810007030781000701078100
0704078300070007490781000703078100070d078100070007
02078500070007040701078604070007000407030784040007040705078b040700070407
030704070007830700040701078204000717078306070607410781000701078100070107
810007010781000703078100070107810007030781000701078100070307810007010781
000704078300070007490781000703078100070d078100070007
02078500070007040701078604070007000407030784040007040705078b040700070407
030704070007820704070307810407170783060706074107810007010781000701078100
070107810007030781000701078100070307810007010781000703078100070107810007
04078300070007490781000703078100070d078100070007
02078500070007040701078604070007000407030784040007040705078b040700070407
030704070007820704070307810407170783060706074107810007010781000701078100
070107810007030781000701078100070307810007010781000703078100070107810007
04078300070007490781000703078100070d078100070007
02078e000700070407060704070007000407820703078507040007040705078b04070007
040306030407000782070407030781040717078306070607410781000701078100070107
810007010781000703078100070107810007030781000701078100070307810007010781
000704078300070007490781000703078100070d078100070007
02078e000700070407030704070007000407820703078507040007040705078b04070007
040307030704000782070407030781040717078306070607410781000701078100078207
000703078100070207810007010781000703078100070107810007030781000701078100
0704078300070007480781000705078100070c078100070007
0207920007000704060306040700070004070307030784070407040705078e0407000407
030703070400070004070307810407160781060701078106074007810007010781000782
070007030781000702078100070107810007030781000701078100070307810007010781
000704078300070007480781000705078100070c078100070007
0207920007000407030703070400070004070307030784070407040705078e0407000407
030703070400070004070307820400071507810607010781060705078100073807810007
010781000782070007030781000702078100070107810007030781000701078100070307
810007010781000704078300070007480781000705078100070c078100070007
0207920007000407030703070400070004070307030784070407040705078e0407000403
060706030400070004070307820400071507810607010781060705078100073807810007
010781000782070007030781000702078100070207810007010781000702078100070307
8100070207810007020781000701078100072307810007210781000705078100070c0781
00070007
02078d000700040703070307040007040784070307030784070407040705078504070004
030701078603040007000407030782040007150781060701078106070407830004000737
078100070107810007820700070307810007010781000703078100070107810007030781
000701078100070307810007020781000701078100072307810007210781000705078100
070c078100070007
02078f000700040603070306040007040703070107850307040704070507850407000403
070107860304000700040703078204000715078106070107810607040783000400073707
810007010781000782070007030781000701078100070307810007010781000703078100
070107810007030781000702078100070107810007230781000721078100070507810007
0c078100070007
020785000700040307010787030400070407030701078503070400040705078504070004
030701078503040007040705078104071407810607030781060703078404070400073607
810007010781000782070007030781000701078100070307810007010781000703078100
070107810007030781000702078100070107810007220783000700072007810007050781
00070c078100070007
020785000700040307010787030400070407030701078203070481040706078504070004
030701078506040007040705078104071407810607030781060702078500040704000736
078100070107810007820700070307810007010781000703078100070107810007030781
000701078100070307810007020781000701078100072207830007000720078100070507
8100070c078100070007
020785000700040307010787030400070407030701078203070481040706078404070403
070307840304000407050781040714078106070307810607020782000407820704070f07
810007240781000701078100078207000703078100070107810007030781000701078100
070307810007010781000703078100070207810007010781000722078300070007200781
000705078100070c078100070007
020785000704060307010786030604070403070307810304810407060784040004030703
0784030400040705078104071407810607030781060702078104070107820400070d0783
000400072307810007010781000782070007030781000701078100070307810007010781
000703078100070107810007030781000702078100070107810007220783000700072007
81000705078100070c078100070007
020701008204030703078503040004030703078103048104070607840400040307030784
030400040701078103070107810407140781060703078106070107820004070207810407
0d0783040704072307810007010781000782070007030781000701078100070307810007
010781000703078100070107810007030781000701078100070207810007220783000700
07200781000705078100070c078100070007
020701008204030703078503040004030703078303070407070701048103070307840604
0004078407030703078207040713078106070507810607830700040702078104070c0785
000407040007220781000701078100078207000703078100070107810007030781000701
078100070307810007010781000703078100070107810007030781000721078100078207
00071f0781000705078100070c078100070007
020701008204030782070507860703040004030782070607840703070407070701048103
070407830400040784070307030782070407130781060705078106078207040703078204
00070b078104070107810407220781000701078100078207000703078100070107810007
030781000701078100070307810007010781000703078100070107810007030781000720
0781000701078100071f0781000705078100070c078100070007
020701008b04030705070507030400040784070607060783070304070207810307020701
040207810507010785040004070307010784030704000712078106070507810607820704
0704078104070a0782000407010782040007210781000701078300070007050781000782
070007040783000700070407810007010781000703078100070107810007030781000720
0781000701078100071f0781000705078100070c078100070007
020701008104078407050705078107048404030706070107840607030407010783030703
070107010401078305070507810704830407030702078403070400071207810607050784
060700040704078204000709078104070307810407210781000701078300070007050781
000782070007040783000700070407810007010781000704078100078207000703078100
071807810007050781000701078100071f0781000705078100070c078100070007
020701008304070507010782050704830403060782070507840706030407820703070107
810307810704830407050701078505070604030704078303070407120781060705078306
070407060781040708078200040703078204000720078100070107830007000705078300
070007050783000700070507830007000705078100078207000703078100071807810007
050781000701078100071f0781000705078100070c078100070007
0207840004030507820702078d0705030403060705070507060307820703070307850307
040305070307840507040307010781050784070307040711078106070707820604070607
810400810007060781040705078104072007810007010783000700070507830007000705
078300070007050783000700070507810007820700070307810007170783000700070407
81000702078100071e0781000705078100070c078100070007
020784000405070282020702850207050406058105070107010584060307030703078503
070407050703078305070406810605820507058405070304071107810607070782060407
0707010401000407820004070507820400071f0781000701078300070007050783000700
070507830007000705078300070007050781000782070007030781000717078300070007
030781000703078100071e0781000705078100070c078100070007
020784000405020583050405028402050405020502810503820306050305830603040584
0506030405840506050405810506030601058104061b0681040681060303030406010404
06810406810605030501068104061c060207810007010783000700070507830007000705
078300070007050783000700070507830007000704078100071707830007000703078100
0703078100071e0781000705078100070c078100070007
020782000402810205820504028102058205040281020582050402020202050402010581
040281020582050402810205010508021e040d0505040105040301051e04020781000701
078300070007050783000700070507830007000705078300070007050783000700070507
81000716078300070007030781000703078100070e078100070d0781000705078100070c
078100070007
02078100077f070e07810007010783000700070507830007000705078300070007050783
000700070507830007000705078100071507810007010781000702078100070307810007
0e0701000707810007030781000705078100070c078100070007
02078100077f070e07810007010783000700070507830007000705078300070007050783
000700070507830007000705078100071507810007010781000702078100070307810007
0d0783000700070507010003078100070707810007020781000706078100070007
02078100077f070e07810007010783000700070507830007000705078300070007050783
000700070507830007000705078100071507810007010781000702078100070407810007
0c0781000782070007040783000700070107810007070781000701078300070007050781
00070007
02078100077f070e07810007010783000700070507830007000706078100070607830007
0007050783000700070507810007140781000703078100078207000705078100070b0781
000701078100070307810007820700070107810007070781000701078300070007050781
00070007
0207810007040701000e0701007607810007010783000700070507830007000706078100
070607830007000706070100060781000714078100070307810007820700070507810007
0b0781000702078100070207810007010781000782070007070781000782070007010781
000704078100070007
02078100070307810007820700070d078100070207810007700781000701070100080701
000707810007060783000700070607010006078100071407810007030781000782070007
05078100070a078100070307810007010781000702078100078207000707078100078207
0007010781000704078100070007
020781000703078100071007810007020781000770078100070107010008078100070707
81000707078100070707810007060781000713078100070507830007000705078100070a
078100070407810007820700070307830007000707078300070007030781000703078100
070007
020781000703078100070307020001078100070107810007010781000701070300020702
000e070206010782060706810607010702060107820607068106070d0702020107820207
028102070107020202070202010781020701078102071907810007010701000807810007
070781000707078100070707810007070781000702078100070d07810007050783000700
070607810007090781000704078300070007040783000700070707830007000703078100
0703078100070007
020781000702070300050783000700070107810007010781000702078100070207810007
01078100070f0782060706810607840706070607010782060706810607820706070f0782
020702810207840702070207010783020702070107830207020701078102071907810007
010701000807810007070781000707078100070707810007070781000701078300070007
060781000703078100070507830007000706078100070807810007060701000607010008
070100060781000702078100070007
020781000703078100070307030082070007010781000701078100070207810007030701
000f07030682070607010783060706070107830607060701078106070c07030282070207
010783020702070307810207010787020702070207020719078100070107010008078100
071107810007070781000707078200070081000701070100030701008107008100070107
810007050701000807060003078100070607810007060701000807010006078100070207
8100070007
020781000703078100070207810007010783000700070107810007010781000702078100
0705078100070c0781060701078306070607010783060706070107830607060701078106
070b07810207010783020702070107830207020703078102070107870207020702070207
190781000701070100080781000711078100071107010006078200070081000703070200
08078100070e0701008207000711078100070707810007070781000701078100070007
020781000703078100070207810007010783000700078107008100070107810007020781
000784070007000701078100070b07810607010783060706070107830607060701078306
07060701078106070b078102070107830207020701078302070207010783020702070107
870207020702070207190781000701070100080781000711078100071107810007070781
000707078100070707810007100701001207810007070781000707078100070107810007
0007
02078100070307810007030703000107010082070007810700010003070100020702000e
0703068207060701078106078107060106010781060701078106070c0703028207020701
07810207810702010202070202020783020702071a0781000701078100077f070e078100
070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
020781000708078103077f07030781000701078100077f070e078100070007
0207810007080781030706078103077a07810007010781000703078100077f0708078100
070007
020781000708078103077f070307810007010781000703078100077f0708078100070007

02078100070307020301070303030701030e070205020702050107030501078105070107
8105070b0704040107020401078204070481040701070204330781000701078100070207
03000107820007008100070107020001070300020702006f078100070007
0207810007020781030701078303070307010781030702078103070c0781050701078305
070507010783050705070107830507050701078105070e07810407820704070107820407
048104078407040704070107810407310781000701078100070307810007020701000107
810007030783000700070107830007000701078100076d078100070007
0207810007020781030701078303070307010781030702078103070c0781050703078105
07010783050705070107830507050701078105070d078104070107040482070407030781
040701078104073107810007010781000703078100070207810007040703008207000701
078100078107008100076f078100070007
0207810007020781030701078303070307010781030702078103070c0781050703078105
0701078305070507010783050705078107058105070c0781040702078104070307810407
030781040701078104073107810007010781000703078100070207810007030781000701
078300070007010781000702078100076e078100070007
0207810007020781030701078303070307010781030702078103070c0781050701078305
070507010782050705020502070105820705070b07810407030781040701078304070407
030781040701078104073107810007010781000703078100078407000700070307810007
0107820007000200010781000701078100076d078100070007
020781000703070203010703030107810307820703070d07020502070205010781050707
078105070b07040401070204010781040704070204330781000701078100070407010001
078100070407030082070007040702006f078100070007
02078100070e078103078207030718078105070307810507010781050755078100070107
810007140781000777078100070007
02078100070f0701031a0781050704070205570781000701078100071407810007770781
00070007
02077f00110002077f0011000107
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
02077f00110002077f0011000107
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
020781000702070200010781000701078200070003008107000200020702001007810007
1b0781000781070003000207810007030781000702078100072907810007010781000702
070200010781000701078100078107000100010704000107020001078100070107810007
030781000781070001000107810007010781000701078100070107030010078100071a07
8100070307810007010704008107000300010781000705078100070007
020781000703078100070107010001078100070107810007010781000701078300070007
01078100070d078100071c07810007040781000781070081000702070100040781000728
078100070107810007010781000701078300070007010781000701078100070307810007
010781000701078300070007010781000703078300070007010783000700070107810007
8407000700078207000701078100070d078100071a070100030701000607810007030781
0007010781000704078100070007
020781000703078100070107010001078100070107810007010781000701078300070007
11078100071b070100040781000784070007000701078300070007030781000728078100
070107810007010781000703078100070107810007010781000703078100070107810007
030781000701078100070207810007820700070307810007010783000700070107830007
000701078100070d07810007190783000700070107830007000704078100070307810007
020781000704078100070007
020781000703078100070107850007000700070107810007010781000701078300070007
100781000702070100820700070107020001078100070107820007000300010783000700
070307810007020781000703078100070407810007270781000701078100070107810007
030781000701078100070107810007030781000701078100070307810007010781000702
07810007820700070307810007010783000700070107830007000701078100070c078100
070207010082070007010702000107810007010782000700030002078100070307810007
04078100070307810007030781000703078100070007
02078100070307810007010785000700070007010781000701070300020702000e078100
070207850007000700070307810007840700070007070783000700070207810007030781
000703078100070407810007270781000701078100070207020001078500070007000701
078100070307810007010781000703070400020781000702070200010787000700070007
000701078200070002000e07810007020785000700070007030781000784070007000708
07810007030781000703078100070307810007040781000703078100070007
020781000703078100070107810007810700810007010781000701078300070007050781
00070c078100070207850007000700078107000200020781000707078100078207000702
078100070307810007030781000704078100072707810007010781000705078700070007
000700070107810007030781000701078100070307810007010781000782070007060788
000700070007000700030082070007100781000702078500070007000781070002000207
8100070907810007030781000703078100070307810007040781000703078100070007
020781000703078100070107810007810700810007010781000701078100078207000704
078100070d07810007010787000700070007000701078100070107810007010704008107
000300010781000704078100070307810007030781000728078100070107810007050787
000700070007000701078100070307810007010781000703078100070107810007820700
070607890007000700070007000701078300070007110781000701078700070007000700
070107810007010781000701070400020781000703078100070207810007030781000704
0781000704078100070007
020781000703078100070107810007010781000701078100070107810007010783000700
0701078100070d0781000701078700070007000700070107810007840700070007090781
000701078100070407810007030781000703078100072807810007010781000701078100
070107820007008200070081000701078100070307810007010781000701078300070007
010783000700070307810007010782000700820007008300070007010783000700071107
810007010787000700070007000701078100078407000700070807810007030781000702
078100070307810007040781000704078100070007
020781000702070200010781000701078100070107810007010781000701078100078107
000100100781000782070007010781000781070002008207000701078100070807810007
010781000702070400810700030001078100072907810007010781000702070200010781
000701078100078107000100030781000702070200010781000701078300070007040702
000107810007010783000700070107830007000712078100078207000701078100078107
000200820700070107810007050704008107000300010781000703078100070307810007
05078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02077d00810600110002077f0011000107
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077b07810607100781000701078100077b0781000710078100070007
02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

02078100077a0783060706070f0781000701078100077a0783000700070f078100070007

0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007790781060701078106070e078100070107810007790781000701078100070e
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007780781060703078106070d078100070107810007780781000703078100070d
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c078100070107810007770781000705078100070c
078100070007
0207810007770781060705078106070c0781000701078100075307810007210781000705
078100070c078100070007
0207810007770781060705078106070c0781000701078100075307810007210781000705
078100070c078100070007
02078100072b07810607490781060705078106070c078100070107810007520783000700
07200781000705078100070c078100070007
02078100070d078106071b07810607490781060705078106070c07810007010781000752
078300070007200781000705078100070c078100070007
02078100070d078106071a0783060706072407810607210781060705078106070c078100
07010781000752078300070007200781000705078100070c078100070007
02078100070c078306070607190783060706072407810607210781060701078102070107
8106070c07810007010781000752078300070007200781000705078100070c0781000700
07
02078100070c078306070607190783060706072307830607060720078106070107810207
01078106070c078100070107810007510781000701078100071f0781000705078100070c
078100070007
020781000703078106070607830607060718078106070107810607220783060706072007
810607840702070207820706070c078100070107810007510781000701078100071f0781
000705078100070c078100070007
020781000703078106070507810607010781060717078106070107810607220781060782
0706071e078106070107830207020701078106070b07810007010781000703078100074b
0781000701078100071e0781000707078100070b078100070007
020781000702078306070607040781060701078106071707810607010781060721078106
07010781060719078106070207810607820702070107810207820706070b078100070107
81000702078300070007490781000703078100071d0781000707078100070b0781000700
07
020781000702078306070607040781060701078106071607810607030781060720078106
070107810607180783060706070107810607820702070107810207820706070b07810007
010781000702078300070007490781000703078100071d0781000707078100070b078100
070007
02078100070107810607010781060702078106070307810607150781060703078106071f
078106070307810607170783060706070107810607820702070107810207820706070207
810607060781000701078100070107810007010781000748078100070307810007180781
0007020781000707078100070b078100070007
0207810007010781060701078106070207810607030781060704078106070e0781060703
078106071f07810607030781060716078106070107810607840706070207030783020706
070107830607060705078100070107810007010781000701078100074807810007030781
00071707830007000701078100070707810007020781000706078100070007
020781000782070607820700078207060701078106070307810607030783060706070607
810607040781060703078106071f0781060703078106070e078106070407810607020781
060784070607020703078302070607010783060706070507810007010781000782070007
030781000722078100072107810007050781000715078100078207000701078100070707
8100070107830007000705078100070007
020781000788070607000700070607820706070507810607010781060701078106070407
8306070607020781060705078106071d0781060705078106070c07820607068106070107
810607010781000786070607060702070307830207060782070607010781060704078100
07010781000782070007030781000704078100071a078300070007200781000705078100
070d07010004078100070207810007820700070707810007820700070107810007040781
00070007
020785000706070007010785000706070607050781060782070607030781060702078106
0701078106070107810607010781000701078106071d0781060705078106070b07810607
020701068207060789070007000706070602070507840206070607820700078207060703
078100070107830007000705078100070207830007000710078100070507810007010781
00071f0781000705078100070c0781000781070081000782070007040783000700070707
8300070007030781000703078100070007
020785000706000702010285070006070607810700010001078106078207060703078106
070107810607030781060783070607008200070083000706070207020017078106078107
020102020781060709078206070001000207820607008100070107010001068102070507
810206820607008200070083000706070207810007010783000700070507810007810700
810007010701000d07010081070081000702078100070307810007030702000607020006
070200030781000705078100070a07010004070100070701000807830007000703078100
0703078100070007
020783000600028102070107010283000607008100070107010081070682060700030085
070607060700030081070681060081000203020100830607000603068100070207040604
070406010782060702810200010001028107060606020781060081000701070100010782
000702030281070681060781070003000107010681000203028200060702078100070107
010008070100060781000701070400020701000407010082070007050781000781070081
000701070100020701000207010002070100020701008207000707078100078107000300
02078100070f07010008070100060781000702078100070007
020783000602070507820206020702810602070281060207028106028102070307010202
06040204060402040604020206820200070307810002070202060b020407010281060081
000703070100810602810207030701028106070107810007010701000807810007070702
000407020008078100070707010006070200060702000607010008070200040702001207
8100070707810007070781000701078100070007
02078100077f070e0781000701078100067f060b0602078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100077f070e0781000701078100077f070e078100070007
02078100073a07010232070106030701061607810007010781000720078100076b078100
070007
020781000704078100070807810007270781020782070207820702072e07810607030781
060715078100070107810007150781000708078100071d078103072c078106071c078100
070007
02078100070f07810007270781020703078102072e078106070307810607150781000701
07810007150781000708078100074c078106071c078100070007
020781000703070100020782000700810007810700020001078200070081000701070200
0e070202020702020207810207020703020e070206010781060701078106078107060106
020702060207020603078106070307810607150781000701078100070307020002070200
01078100070107820007000200020702000107820007008100070d070203010781030701
078103078107038103070107820307038103070d07020601078106070107810607810706
0106010781060701078206070602061b078100070007
020781000704078100070107010001078100078207000702070100010783000700070107
8100070b0781020701078302070207010782020702020202078102070e07810607010783
060706070107830607060701078306070607010781060703078106070107810607030781
060715078100070107810007020781000701078300070007010783000700070107810007
820700070207810007010782000700810007820700070b07810307010783030703070107
81030701078103070107010301078103070b078106070107830607060701078306070607
010783060706070107810607820706071c078100070007
0207810007040781000701078100070107810007820700070207810007040701000f0701
02020781020701078102078207020703078102070f070106020781060701078106078107
068106070107810607040703060207810607030781060715078100070107810007020781
000704070100020785000700070007820700070207810007030781000701078100070c07
01030207850307030703070107810307010781030701078103070c070106020787060706
0706070607010783060706070107810607820706071c078100070007
020781000704078100070107810007010781000782070007020781000706078100070f07
810207820702070107810207820702070307810207110781060782070607810706810607
020781060782070607030781060701078106070107810607030781060715078100070107
810007020781000706078100078607000700070007820700070207810007030781000701
078100070e0781030786070307030703070107810307010781030701078103070e078106
0788070607060706070607010783060706070107810607820706071c078100070007
020781000704078100070107810007010781000782070007840700070007030781000701
078100070b07810207010783020702070107810207820702070307810207820702070b07
810607010781060781070685060706070607010783060706070107830607060701078106
070107810607030781060715078100070107810007020781000701078300070007010787
0007000700070007820700078407000700070107830007000701078100070b0781030701
078703070307030703070107810307010781030701078103070b07810607010789060706
0706070607060701078306070607810706810607820706078207060719078100070007
02078100070307020001078100070107810007010701000107810007040702000e070202
020702020207810207040701020e07020605078106078107060106020702060207030601
070206020702061507810007010781000703070200020702000207830007000702070100
02070200010781000701078100070c070203020783030703070107020301078103070107
8103070c07020602078306070607010702060207010682070607010701061b0781000700
07
020781000756078106070107810607310781000701078100077f070e078100070007
020781000757070206330781000701078100077f070e078100070007
02077f00110002077f0011000107
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
04070300190703007f077f070407
040781000701078100071807810007820700073c078100077f074307
040781000701078100071807810007820700073c078100070a078100077f073607
040781000701078100078107000100020702000207020008078100078207000781070001
000207020001070100820700070107020001078200070081000707070200020702000107
8100070107840007000700810007810700020002070200020702007f073607
040703000507830007000701078300070007010781000706078100078207000703078300
070007010789000700070007000700070107820007008100078207000705078100070107
830007000701078300070007010782000700810007820700078207000702078100070107
81000701078100077f073607
040781000704070300820700070107820007000300070781000782070007810700020081
070003008807000700070007000701078300070007010781000705078100070307810007
0107830007000701078300070007010781000782070007030701007f073d07
0407810007030781000701078300070007010783000700070a0781000784070007000701
078300070007030787000700070007000701078300070007010781000705078100070307
810007010783000700070107830007000701078100078207000705078100077f073b07
040781000703078100070107810007810700020082070007010781000706078100078407
000700070107830007000701078900070007000700070007010783000700070107810007
050781000701078300070007010783000700078107008300070007010781000782070007
840700070007010781000701078100077f073607
040781000704070300040781000781070001000707030002070300010702000107810007
010781000781070001000107810007010781000706070200020702000207010084070007
000701078100070107010002070200020702007f073607
100781000701078100075b078100077f073607
110702007f077f071607
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
160781000711078100072d0781000733078100077f071807
1607810007100783000700072b0783000700072507810007090783000700077f071707
16078100070f078100070107810007290781000701078100072407810007080781000701
078100077f071607
0a0781000701078100078107000100010781000782070007010702000107040082070007
01078100070b078200070081000701070200010781000701078100078107000100010704
008207000701078100070c07020001078100070107810007810700010001078100070107
820007000200010704008207000701078100077f071607
0a0781000701078300070007010785000700070007010781000701078100070507810007
01078100070b070100010783000700070107830007000701078300070007010781000705
0781000701078100070b0781000701078300070007010783000700070107830007000701
0781000782070007080781000701078100077f071607
0a0787000700070007000701078200070081000702070400060781000701078100070b07
81000703070400820700070107810007810700810007070781000701078100070c070100
020787000700070007000701078300070007010781000782070007080781000701078100
077f071607
0a0787000700070007000701078500070007000701078100070307040082070007010781
00070b078100070307810007040783000700070307810007810700030082070007010781
00070e078100078807000700070007000701078300070007010781000782070007020704
008207000701078100077f071607
0a0787000700070007000701078300070007820700078207000701078100070607830007
000702070100070781000703078100070107810007840700070007820700070107810007
060783000700070207010007078100070107890007000700070007000701078300070007
8107008100078207000782070007060783000700077f071707
0b0783000700070107020001078100070107810007810700010009078100070307810007
070781000704070200030781000702070200090781000703078100070807020002078300
0700070107020002070100820700070107010009078100077f071807
2f078100072d078100077f074907
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
30078100075107810007130781000735078100075607
2f0783000700074f078300070007120781000706078100072b0783000700075507
2e0781000701078100074d07810007010781000711078100073307810007010781000754
07
0b0702000207020002070200010782000700810007010702000107040082070007010781
00070c070200010782000700810007010702000107820007008100070707020002070200
0207020001078200070081000701070200010704008207000701078100070c0702000107
030003070100080702000207020002070200010782000700810007010702000107040082
07000701078100075407
0a0781000701078300070007010781000703078200070081000784070007000701078100
07050781000701078100070f078200070081000784070007000701078200070081000782
070007050781000701078300070007010781000703078200070081000784070007000701
07810007050781000701078100070b078100070107830007000701078100070207810007
060781000701078300070007010781000703078200070081000784070007000701078100
07050781000701078100075407
0b0701000207810007040703008207000701078100078107008100070707810007010781
00070c070300820700070107830007000701078300070007010781000706070100020781
000704070300820700070107810007810700810007070781000701078100070b07810007
010783000700070107810007020781000707070100020781000704070300820700070107
810007810700810007070781000701078100075407
0d0781000782070007030781000701078300070007010781000702078100078107000300
8207000701078100070b0781000701078300070007010783000700070107830007000701
078100070807810007820700070307810007010783000700070107810007020781000781
070003008207000701078100070b07810007010783000700070107810007020781000709
078100078207000703078100070107830007000701078100070207810007810700030082
07000701078100075407
0a0781000701078300070007010783000700070107830007000701078300070007010781
000706078300070007020701000707810007010783000700070107830007000701078300
070007010781000705078100070107830007000701078300070007010783000700070107
830007000701078100070607830007000702070100070781000701078300070007010781
000702078100070607810007010783000700070107830007000701078300070007010783
000700070107810007060783000700075507
0b0702000207020002070300820700070107810007810700010009078100070307810007
080703008207000701078100078107000100010781000701078100070607020002070200
020703008207000701078100078107000100090781000703078100070807020001070300
010781000782070007070702000207020002070300820700070107810007810700010009
078100075607
3507810007200704002b0781000714078100078207000781070003007f07
7f07210701007f070707
7f077f072b07
7f077f072b07
7f077f072b07
0a078100071d078100070f07010017078100070707810007230781000719078100077f07
0607
0a078100071c0783000700070d0781000782070007150781000706078300070007220781
00070107810007140783000700077f070507
0a078100071b0781000701078100070c0781000718078100070507810007010781000721
07810007170781000701078100077f070407
0a0703000107810007010781000781070001000107810007010782000700030082070007
01078100070c078100070207820007008100070107020002070200020703008107000300
8207000701078100070b0703000207020001078200070081000701070300010701000207
8200070081000701070200010704008207000701078100077f070407
0a0781000701078300070007010783000700070107830007000701078100070507810007
01078100070b070300010701000107830007000701078300070007010783000700070107
810007050781000701078100070b07810007010783000700070107820007008100078407
000700070107810007010781000701070100010783000700070107810007050781000701
078100077f070407
0a0781000701078300070007010781000781070081000701078100070107810007050781
000701078100070c07810007020781000703070400810700030082070007010781000705
0781000701078100070b0781000701078200070003008207000701078300070007010781
000701078100070107810007010783000700070107810007050781000701078100077f07
0407
0a0781000701078300070007010781000702078100078207000781070082000700030082
07000701078100070c078100070207810007030781000703078100070307810007010782
00070003008207000701078100070b078100070107830007000703078100070107830007
000701078100070107810007010781000701078300070007010782000700030082070007
01078100077f070407
0a0781000701078300070007810700830007000701078100078107008300070007060783
000700070207010008078100070207810007030781000701078300070007010783000700
070107810007060783000700070207010007070300010781000701078300070007010783
000700070107810007010781000701078100070107810007810700020007078300070007
7f070507
0a0703000207010082070007810700010005078100070707810007030781000708078100
070207810007040702000207020002070300080781000703078100070707810007040702
000107810007010781000781070002000107020001078100070107810007030781000707
078100077f070607
1c0781000701078100070c0781000733078100070807810007210781000701078100077f
071007
1d0702004f07810007220702007f071207
7f077f072b07
7f077f072b07
7f077f072b07
4e0781000711078100073d0781000745078100073e07
230781000704078100070e078100070f0783000700071007810007120781000704078100
070e078100070f07830007000731078100070f0783000700073d07
230781000715078100070e0781000701078100070f07810007120781000715078100070e
07810007010781000730078100070e0781000701078100073c07
0a0782000700810007010702000207020002070200010703000207010002078100070107
81000781070001000107030002070200010704008207000701078100070c070300010702
000207020002070200010703000207010002078100070107810007810700010001070300
02070200010704008207000701078100070b070300020702000207020002070200020702
000107810007010782000700020002070200010704008207000701078100073c07
0a0701000107830007000701078100070307830007000701078100078207000704078100
070107810007010781000703078100078207000702078100070107810007050781000701
078100070b07810007010783000700070107810007030783000700070107810007820700
070407810007010781000701078100070307810007820700070207810007010781000705
0781000701078100070b0781000701078100070307830007000701078300070007010783
000700070107830007000701078100078207000702078100070107810007050781000701
078100073c07
0a0781000703070400010703008207000704078100070407810007010781000701078100
078107000200010781000702070400060781000701078100070b07810007010782000700
030001070300820700070407810007040781000701078100070107810007810700020001
0781000702070400060781000701078100070b0781000701078100078107000200820700
070107820007000300820700070107830007000701078100078207000703070100080781
000701078100073c07
0a0781000703078100070307810007010783000700070407810007040781000702078300
070007820700070107810007820700070207810007030704008207000701078100070b07
810007010783000700070307810007010783000700070407810007040781000702078300
070007820700070107810007820700070207810007030704008207000701078100070b07
810007010783000700070107830007000701078300070007030781000701078300070007
010781000782070007050781000781070003008207000701078100073c07
0a0781000703078100070107830007000701078300070007010781000782070007820700
070107810007020783000700078207000701078100078207000784070007000701078100
070607830007000702070100070781000701078300070007010783000700070107830007
000701078100078207000782070007010781000702078300070007820700070107810007
820700078407000700070107810007060783000700070207010007070300010781000701
078100078107000200820700070107830007000701078300070007810700810007820700
078407000700070107810007060783000700073d07
0a0781000704070200020703000107020003070100020702000307810007020703000207
010002070200090781000703078100070807030001070200020703000107020003070100
020702000307810007020703000207010002070200090781000703078100070707810007
040703000407810007810700010002070200020701008207000701070100020702000907
8100073e07
530781000751078100070807810007090781000701078100076607
7f0732078100070a0702006807
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07
7f077f072b07

%
% Compression made this file 6.88% of the uncompressed size.
%


showpage

% stop using temporary dictionary
end

% restore original state
origstate restore

%%EndDocument
 @endspecial 3187 4907 V 1009 4910 2182 4 v 1004 5085
a(Figure)25 b(9.2:)30 b(A)25 b(screen)h(dump)d(of)i(the)g
Fm(xuvmstat)e Fs(program)p eop
%%Page: 206 226
206 225 bop 3751 100 a Fs(206)300 973 y Fp(Chapter)51
b(10)300 1448 y(Results)300 1930 y Fs(In)24 b(pre)n(vious)g(chapters)g
(we)h(described)f(the)g(design)g(and)g(implementation)e(of)i(ne)n(w)g
(VM)g(features)h(\002rst)300 2079 y(introduced)31 b(to)f(BSD)j(by)e
(UVM.)f(The)i(design)e(of)i(features)f(such)h(as)f(page)g(loanout,)h
(page)g(transfer)l(,)300 2229 y(and)d(map)g(entry)f(passing)g(pro)o
(vide)g(the)h(I/O)g(and)g(IPC)h(subsystems)d(with)h(multiple)f(data)i
(mo)o(v)o(ement)300 2378 y(options.)45 b(But)31 b(such)e(gains)h(in)f
(\003e)o(xibility)g(are)i(useful)e(only)h(if)g(the)o(y)f(are)i(more)f
(ef)n(\002cient)g(than)g(tradi-)300 2527 y(tional)e(data)h(cop)o(ying.)
43 b(In)30 b(this)e(chapter)h(we)h(describe)f(\002)n(v)o(e)g(sets)f(of)
h(tests)g(designed)f(to)h(measure)g(the)300 2677 y(performance)j(of)f
(UVM')-5 b(s)30 b(ne)n(w)h(features.)50 b(The)31 b(results)f(of)h
(these)g(measurements)f(sho)n(w)g(that)h(page)300 2826
y(loanout,)21 b(page)g(transfer)l(,)h(and)f(map)g(entry)g(passing)f
(can)i(signi\002cantly)e(impro)o(v)o(e)f(I/O)i(and)g(IPC)h(perfor)n(-)
300 2976 y(mance)29 b(o)o(v)o(er)f(traditional)g(systems.)41
b(W)-8 b(e)30 b(also)e(measure)h(the)g(ef)n(fects)g(of)g(UVM')-5
b(s)28 b(secondary)h(design)300 3125 y(elements.)39 b(Our)27
b(results)g(sho)n(w)g(that)g(due)h(to)f(our)h(secondary)f(design)g
(impro)o(v)o(ements)e(UVM)i(outper)n(-)300 3274 y(forms)i(BSD)g(VM)g
(in)g(se)n(v)o(eral)f(critical)h(areas,)h(e)n(v)o(en)e(when)h(our)g(ne)
n(w)g(data)g(mo)o(v)o(ement)d(mechanisms)300 3424 y(are)g(not)e(used.)
583 3573 y(All)f(our)g(tests)f(were)i(performed)f(on)g(200)g(MHz)g
(Pentium)f(Pro)i(processors)e(running)g(NetBSD)300 3723
y(1.3A)g(with)f(either)h(UVM)g(or)g(BSD)h(VM.)f(Our)g(Pentium)f(Pros)i
(ha)n(v)o(e)e(a)i(16K)f(le)n(v)o(el-one)f(cache,)i(a)g(256K)300
3872 y(le)n(v)o(el-tw)o(o)36 b(cache,)42 b(and)c(32MB)g(of)g(physical)e
(memory)-6 b(.)69 b(The)37 b(main)h(memory)f(bandwidth)f(of)i(our)300
4021 y(Pentium)23 b(Pros)i(is)e(225)h(MB/sec)g(for)g(reads,)h(82)f
(MB/sec)g(for)g(writes,)g(and)g(50)g(MB/sec)g(for)g(copies,)g(as)300
4171 y(reported)h(by)f(the)h Fm(lmbench)e Fs(memory)h(benchmarks)2210
4135 y Fj(1)2272 4171 y Fs([40].)300 4554 y Fg(10.1)143
b(P)o(age)34 b(Loanout)g(P)m(erf)l(ormance)300 4807 y
Fs(P)o(age)39 b(loanout)e(allo)n(ws)g(a)i(process)f(to)g(loan)h(a)f
(read-only)h(cop)o(y)f(of)g(its)g(pages)g(of)h(memory)f(out)f(to)300
4956 y(the)30 b(k)o(ernel)f(or)h(another)g(process,)g(thus)f(a)n(v)n
(oiding)g(costly)g(data)g(copies.)45 b(The)30 b(loaned)g(out)f(pages)g
(are)p 300 5046 1440 4 v 416 5107 a Fi(1)449 5137 y Fh(W)-7
b(e)22 b(used)e(v)o(ersion)f(1.2)g(of)h Fe(lmbench)p
Fh(')-5 b(s)20 b Fe(bw)p 1760 5137 25 4 v 29 w(mem)h
Fh(programs)d(to)i(mak)o(e)g(these)g(measurements.)p
eop
%%Page: 207 227
207 226 bop 3751 100 a Fs(207)300 249 y(mark)o(ed)25
b(cop)o(y-on-write)g(in)g(the)g(process)g(so)g(that)g(changes)h(made)f
(by)g(the)g(user)g(to)g(loaned)g(out)g(pages)300 398
y(do)g(not)f(interfere)h(with)f(the)h(loan.)583 548 y(A)g(con)l(v)o
(enient)e(place)i(to)f(measure)g(the)g(ef)n(fect)h(of)g(page)f(loanout)
g(on)g(I/O)g(is)g(in)g(the)g(transfer)h(of)300 697 y(data)31
b(from)g(a)g(user)g(process)g(to)f(a)i(de)n(vice.)48
b(In)31 b(a)h(traditional)d(system,)i(this)f(w)o(ould)h(in)l(v)n(olv)o
(e)e(cop)o(ying)300 847 y(the)g(data)g(from)g(the)g(user')-5
b(s)29 b(address)g(space)g(to)g(a)h(k)o(ernel)f(b)n(uf)n(fer)l(,)h(and)
f(then)g(performing)g(I/O)g(on)g(that)300 996 y(b)n(uf)n(fer)-5
b(.)34 b(W)l(ith)25 b(page)h(loanout,)f(such)h(an)g(I/O)g(operation)f
(could)g(be)h(done)g(by)g(loaning)f(the)g(pages)h(from)300
1145 y(the)f(user')-5 b(s)24 b(address)h(space)g(directly)f(to)h(the)f
(de)n(vice,)h(thus)e(a)n(v)n(oiding)h(the)h(data)g(cop)o(y)-6
b(.)583 1295 y(Netw)o(orking)21 b(de)n(vices)f(are)i(often)g(chosen)f
(for)g(such)g(measurements,)g(so)g(we)h(decided)f(to)g(mea-)300
1444 y(sure)28 b(the)f(ef)n(fect)h(of)g(page)g(loanout)f(on)g(the)h
(BSD)h(netw)o(orking)d(subsystem.)38 b(Our)28 b(goal)f(is)g(to)h
(\002nd)g(out)300 1594 y(what)g(ef)n(fect)h(page)f(loanout)g(has)g(on)g
(the)g(amount)g(of)g(data)h(we)f(can)h(pump)f(through)f(the)h(netw)o
(orking)300 1743 y(subsystem.)583 1892 y(The)23 b(BSD)g(netw)o(orking)e
(subsystem)g(consists)f(of)j(three)f(layers:)29 b(the)23
b(sock)o(et)e(layer)l(,)i(the)g(proto-)300 2042 y(col)k(layer)l(,)h
(and)f(the)g(netw)o(ork)g(interf)o(ace)g(layer)-5 b(.)38
b(The)27 b(sock)o(et)g(layer)g(is)g(responsible)f(for)h(queuing)f(and)
300 2191 y(transferring)c(data)f(between)h(user)g(memory)f(and)g(k)o
(ernel)h(netw)o(ork)f(b)n(uf)n(fers)h(\(mb)n(ufs\).)29
b(In)21 b(a)h(traditional)300 2341 y(k)o(ernel,)34 b(data)e(is)g
(transfered)h(between)f(the)g(user)g(and)g(k)o(ernel)h(through)e(data)h
(copies.)53 b(The)32 b(protocol)300 2490 y(layer)23 b(is)g(responsible)
f(for)i(taking)e(mb)n(ufs)g(from)h(the)g(sock)o(et)g(layer)l(,)h
(encapsulating)e(them)h(in)g(a)g(pack)o(et,)300 2639
y(and)35 b(passing)f(the)g(pack)o(et)h(to)g(the)g(netw)o(orking)f
(interf)o(ace)h(layer)g(for)g(transmission.)59 b(The)35
b(protocol)300 2789 y(layer)e(also)g(recei)n(v)o(es)f(inbound)g(pack)o
(et)h(in)g(mb)n(ufs)f(from)g(the)h(netw)o(ork)g(interf)o(ace)g(layer)-5
b(.)55 b(These)33 b(in-)300 2938 y(bound)d(pack)o(ets)h(are)h(check)o
(ed)f(and)g(either)g(discarded,)i(passed)d(up)h(to)g(the)f(sock)o(et)h
(layer)l(,)i(or)e(sent)f(to)300 3088 y(the)k(netw)o(ork)g(interf)o(ace)
g(layer)h(for)f(transmission)e(on)i(a)g(dif)n(ferent)g(netw)o(ork)g
(interf)o(ace)g(\(e.g.)59 b(if)34 b(the)300 3237 y(system)e(is)h
(acting)g(as)g(a)h(router\).)56 b(The)34 b(netw)o(ork)f(interf)o(ace)g
(layer)h(controls)e(the)i(netw)o(orking)e(hard-)300 3386
y(w)o(are)d(and)f(transmits)f(pack)o(ets)h(it)g(recei)n(v)o(es)f(from)h
(the)h(protocol)e(layer)h(and)h(stores)e(recei)n(v)o(ed)h(pack)o(ets)
300 3536 y(in)c(mb)n(ufs)g(that)h(it)f(passes)g(up)h(to)f(the)h
(protocol)f(layer)-5 b(.)583 3685 y(One)26 b(problem)e(with)h
(measuring)f(the)h(performance)h(of)g(page)f(loanout)f(with)h(the)g
(netw)o(orking)300 3835 y(subsystem)e(is)h(that)g(current)h(processors)
g(can)g(easily)f(generate)h(data)g(f)o(aster)g(than)g(current)f
(generation)300 3984 y(netw)o(ork)33 b(interf)o(aces)h(can)g(transmit)e
(it)1667 3948 y Fj(2)1704 3984 y Fs(.)57 b(F)o(or)33
b(e)o(xample,)i(the)f(Pentium)e(Pro)i(processor)g(on)f(our)h(test)300
4133 y(machine)j(can)g(easily)g(sw)o(amp)g(our)g(100Mbps)e(f)o(ast)j
(Ethernet)e(and)h(155Mbps)f(A)-11 b(TM)37 b(cards.)68
b(This)300 4283 y(results)25 b(in)g(either)h(the)g(transmitting)d
(process)j(being)f(stalled)h(until)e(the)i(netw)o(ork)f(interf)o(ace)i
(layer)f(can)300 4432 y(catch)34 b(up,)h(or)f(in)f(data)h(being)f
(discarded)g(at)h(the)f(netw)o(ork)g(interf)o(ace)h(layer)g(due)f(to)h
(a)g(full)f(netw)o(ork)300 4581 y(queue.)52 b(If)33 b(one)f(of)g(these)
g(netw)o(ork)g(interf)o(ace)g(cards)h(w)o(as)f(used)g(in)f(measuring)h
(page)g(loanout,)h(an)o(y)300 4731 y(positi)n(v)o(e)c(results)h(achie)n
(v)o(ed)h(by)g(page)g(loanout)f(w)o(ould)g(be)i(seen)f(as)g(a)h
(reduction)f(in)f(processor)h(load)300 4880 y(rather)25
b(than)g(increased)g(bandwidth.)p 300 4950 1440 4 v 416
5011 a Fi(2)449 5041 y Fh(Ne)o(xt-generation)15 b(netw)o(ork)h(interf)o
(aces)i(such)f(as)i(Gigabit)e(Ethernet)f(and)h(higher)n(-speed)f(A)-9
b(TM)17 b(interf)o(aces)g(can)h(trans-)300 5141 y(mit)j(data)f(at)g
(higher)f(speeds.)p eop
%%Page: 208 228
208 227 bop 3751 100 a Fs(208)300 249 y Ff(10.1.1)118
b(Sock)o(et)31 b(Lay)o(er)e(Modi\002cations)300 466 y
Fs(Measuring)37 b(bandwidth)f(is)h(both)g(easier)h(and)g(more)g
(accepted)g(than)f(measuring)g(processor)h(load.)300
615 y(Since)h(the)g(netw)o(ork)g(interf)o(ace)g(layer)g(introduces)f
(the)h(same)g(delays)g(irrespecti)n(v)o(e)e(of)i(the)g(use)g(of)300
764 y(page)33 b(loanout,)h(these)f(delays)g(can)g(be)g(safely)g(f)o
(actored)h(out)e(of)h(performance)h(measurements.)54
b(T)-8 b(o)300 914 y(achie)n(v)o(e)31 b(this,)h(a)g(ne)n(w)f
(\223null\224)h(protocol)e(layer)i(w)o(as)g(introduced)f(into)f(the)i
(BSD)g(k)o(ernel.)52 b(When)31 b(the)300 1063 y(null)23
b(protocol)f(layer)i(recei)n(v)o(es)f(data)g(from)g(the)h(sock)o(et)f
(layer)g(for)h(transmissions)d(it)i(discards)g(it)g(rather)300
1213 y(than)g(passing)g(it)g(on)g(to)h(a)g(netw)o(ork)f(interf)o(ace.)
31 b(This)23 b(allo)n(ws)f(the)i(data)f(transfer)h(o)o(v)o(erhead)f(of)
h(cop)o(ying)300 1362 y(v)o(erses)g(page)h(loanout)f(to)h(be)g
(measured)f(with)g(bandwidth)g(rather)h(than)f(processor)h(load.)583
1511 y(The)f(sock)o(et)e(layer)i(is)e(of)h(primary)g(interest)f(in)h
(the)g(conte)o(xt)f(of)h(UVM)g(because)g(it)g(handles)f(the)300
1661 y(transfer)33 b(of)f(data)h(between)f(user)h(memory)e(and)i(mb)n
(ufs.)53 b(W)-8 b(e)33 b(had)f(to)g(modify)f(the)i(sock)o(et)f(layer)g
(in)300 1810 y(order)25 b(to)g(test)f(the)g(page)h(loanout)f(function)g
(of)h(UVM.)583 1960 y(An)i(mb)n(uf)f(is)g(a)h(\002x)o(ed)f(sized)g
(structure)h(that)f(can)h(contain)e(either)i(a)g(small)e(amount)h(of)g
(data)h(or)300 2109 y(a)j(pointer)f(to)g(another)g(b)n(uf)n(fer)-5
b(.)44 b(Mb)n(ufs)29 b(that)g(contain)g(data)h(are)g(called)f(small)g
(mb)n(ufs.)44 b(Small)29 b(mb)n(ufs)300 2258 y(usually)21
b(hold)g(one)h(hundred)g(eight)f(bytes)g(of)h(data.)30
b(Mb)n(ufs)21 b(that)h(contain)f(a)h(pointer)g(to)f(another)h(b)n(uf)n
(fer)300 2408 y(are)35 b(called)f(lar)n(ge)g(mb)n(ufs)f(\(because)i
(the)f(b)n(uf)n(fer)f(is)h(usually)f(lar)n(ger)h(than)g(the)g(size)g
(of)g(data)g(a)g(small)300 2557 y(mb)n(uf)24 b(can)g(hold\).)30
b(A)25 b(lar)n(ge)f(mb)n(uf)5 b(')-5 b(s)24 b(b)n(uf)n(fer)g(cannot)g
(cross)g(a)h(page)f(boundary)-6 b(,)23 b(and)i(thus)e(is)h(limited)e
(in)300 2707 y(size)f(to)f(one)h(page.)30 b(Mb)n(ufs)20
b(can)h(be)g(link)o(ed)f(together)h(into)f(an)h(mb)n(uf)f(chain.)29
b(An)21 b(mb)n(uf)g(chain)f(typically)300 2856 y(stores)k(one)h(pack)o
(et.)31 b(Chains)25 b(of)f(mb)n(ufs)g(can)i(be)f(link)o(ed)f(together)g
(to)g(form)h(a)g(queue)g(of)g(pack)o(ets.)583 3005 y(There)34
b(are)f(tw)o(o)g(types)f(of)h(lar)n(ge)g(mb)n(ufs:)45
b(cluster)33 b(mb)n(ufs)f(and)h(e)o(xternal)f(mb)n(ufs.)54
b(A)32 b(cluster)300 3155 y(lar)n(ge)d(mb)n(uf)f(points)f(to)h(a)h
(memory)f(b)n(uf)n(fer)g(that)h(is)f(managed)g(by)g(the)h(k)o(ernel)f
(mb)n(uf)g(subsystem.)40 b(An)300 3304 y(e)o(xternal)30
b(mb)n(uf)f(points)g(to)g(an)h(area)h(of)f(memory)g(that)f(is)h(not)f
(managed)h(by)g(the)g(mb)n(uf)f(system.)45 b(Ex-)300
3454 y(ternal)32 b(mb)n(ufs)g(also)g(contain)g(a)h(pointer)f(to)g(a)h
(\223free\224)h(function)d(that)h(is)g(called)h(to)f(free)h(the)g(e)o
(xternal)300 3603 y(b)n(uf)n(fer)-5 b(.)41 b(External)29
b(mb)n(ufs)e(allo)n(w)h(netw)o(ork)g(hardw)o(are)h(de)n(vices)f(that)g
(ha)n(v)o(e)g(their)h(o)n(wn)e(pri)n(v)n(ate)h(mem-)300
3752 y(ory)e(to)g(\223loan\224)g(it)g(to)g(the)g(mb)n(uf)g(system)f
(for)h(short)g(periods)f(of)i(time.)34 b(W)-8 b(e)26
b(also)g(used)g(e)o(xternal)g(mb)n(ufs)300 3902 y(to)e(help)h(inte)o
(grate)f(UVM)g(page)h(loanout)f(in)g(the)h(sock)o(et)g(layer)-5
b(.)583 4051 y(Before)34 b(describing)d(the)h(modi\002cations)f(done)h
(to)g(the)g(sock)o(et)f(layer)i(to)f(add)g(page)g(loanout,)300
4201 y(it)e(is)f(important)g(to)g(understand)h(the)g(sock)o(et)f(layer)
i(data)f(transmission)d(code)k(path.)46 b(A)30 b(process)g(can)300
4350 y(request)25 b(that)h(data)f(be)h(transfered)g(o)o(v)o(er)f(a)h
(sock)o(et)f(by)g(passing)g(the)g(sock)o(et)h(\002le)g(descriptor)l(,)f
(a)h(pointer)300 4499 y(to)38 b(the)g(data)h(b)n(uf)n(fer)l(,)i(and)e
(the)f(b)n(uf)n(fer')-5 b(s)38 b(length)f(to)h(the)g
Fm(write)g Fs(system)f(call.)71 b(This)38 b(system)f(call)300
4649 y(causes)27 b(the)g Fm(sys)p 922 4649 30 4 v 35
w(write)f Fs(k)o(ernel)h(function)f(to)h(be)g(called.)38
b(This)26 b(function)g(does)h(tw)o(o)f(things.)36 b(First,)300
4798 y(it)d(wraps)g(the)g(speci\002ed)h(b)n(uf)n(fer)f(in)g(a)h
Fm(uio)f Fs(structure)2226 4762 y Fj(3)2263 4798 y Fs(.)56
b(Second,)36 b(it)d(looks)f(up)h(the)g(\002le)h(operations)300
4948 y(structure)i(\()p Fm(fileops)p Fs(\))g(associated)g(with)g(the)h
(\002le)g(descriptor)f(passed)h(to)f Fm(write)g Fs(and)h(calls)f(the)
300 5097 y(appropriate)28 b(\223write\224)h(\002le)g(operation)e(for)i
(that)f(\002le)h(descriptor)-5 b(.)40 b(There)29 b(are)g(currently)f
(tw)o(o)g(types)g(of)p 300 5187 1440 4 v 416 5248 a Fi(3)449
5278 y Fh(The)20 b Fe(uio)g Fh(structure)g(is)h(used)f(within)g(the)g
(k)o(ernel)f(to)i(describe)e(one)h(or)g(more)f(areas)h(in)h(an)f
(address)f(space.)p eop
%%Page: 209 229
209 228 bop 3751 100 a Fs(209)863 1625 y @beginspecial
0 @llx 0 @lly 424 @urx 253 @ury 2968 @rwi @setspecial
%%BeginDocument: ../figures/write.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-50.0 285.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4789 m 0 0 l 7936 0 l 7936 4789 l cp clip
 0.06000 0.06000 sc
% Polyline
7.500 slw
n 5100 1800 m 6900 1800 l 6900 3375 l 5100 3375 l cp gs col7 0.95 shd ef gr gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
3750 3495 m
gs 1 -1 sc (layer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3750 4350 m
gs 1 -1 sc (protocol) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3750 4695 m
gs 1 -1 sc (layer) dup sw pop neg 0 rm  col0 sh gr
% Polyline
gs  clippath
3738 1741 m 3622 1784 l 3704 1692 l 3571 1784 l 3605 1833 l cp
clip
n 4800 975 m 3600 1800 l gs col0 s gr gr

% arrowhead
n 3738 1741 m 3622 1784 l 3704 1692 l 3721 1717 l 3738 1741 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5896 1692 m 5977 1784 l 5862 1741 l 5995 1833 l 6029 1784 l cp
clip
n 4800 975 m 6000 1800 l gs col0 s gr gr

% arrowhead
n 5896 1692 m 5977 1784 l 5862 1741 l 5879 1717 l 5896 1692 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6030 2853 m 6000 2973 l 5970 2853 l 5970 3015 l 6030 3015 l cp
clip
n 6000 2175 m 6000 3000 l gs col0 s gr gr

% arrowhead
n 6030 2853 m 6000 2973 l 5970 2853 l 6000 2853 l 6030 2853 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5084 4133 m 4971 4183 l 5047 4086 l 4920 4186 l 4957 4233 l cp
clip
n 6000 3375 m 4950 4200 l gs col0 s gr gr

% arrowhead
n 5084 4133 m 4971 4183 l 5047 4086 l 5066 4109 l 5084 4133 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6953 4086 m 7028 4183 l 6916 4133 l 7043 4233 l 7080 4186 l cp
clip
n 6000 3375 m 7050 4200 l gs col0 s gr gr

% arrowhead
n 6953 4086 m 7028 4183 l 6916 4133 l 6934 4109 l 6953 4086 l  cp gs 0.00 setgray ef gr  col0 s
/Courier ff 300.00 scf sf
3600 2100 m
gs 1 -1 sc (vn_write) dup sw pop 2 div neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
6000 2100 m
gs 1 -1 sc (soo_write) dup sw pop 2 div neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
4800 900 m
gs 1 -1 sc (sys_write) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 750 m
gs 1 -1 sc (system) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 1125 m
gs 1 -1 sc (call layer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 1950 m
gs 1 -1 sc (fileops) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 2295 m
gs 1 -1 sc (layer) dup sw pop neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
6000 3300 m
gs 1 -1 sc (sosend) dup sw pop 2 div neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
4950 4500 m
gs 1 -1 sc (tcp_usrreq) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3750 3150 m
gs 1 -1 sc (socket) dup sw pop neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
7050 4500 m
gs 1 -1 sc (udp_usrreq) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1829 a(Figure)40 b(10.1:)59 b(Sock)o(et)40
b Fm(write)f Fs(code)h(path.)75 b(The)39 b(code)h(in)f(the)h(box)f(has)
h(been)f(duplicated)g(and)300 1949 y(modi\002ed)27 b(to)g(use)h(page)f
(loanout)g(for)h(our)f(measurements.)38 b(The)28 b(modi\002ed)f(code)g
(is)h(accessed)g(by)f(an)300 2069 y(alternate)e(write)g(system)e(call.)
300 2465 y(\002le)e(descriptors:)28 b(sock)o(ets)21 b(and)g(vnodes.)28
b(The)21 b(write)g(\002le)h(operation)e(for)h(sock)o(ets)g(is)f(the)h
Fm(soo)p 3572 2465 30 4 v 35 w(write)300 2614 y Fs(function.)30
b(The)25 b(write)f(operation)g(for)i(vnodes)e(is)g Fm(vn)p
2164 2614 V 35 w(write)p Fs(.)583 2763 y(The)k Fm(soo)p
952 2763 V 35 w(write)e Fs(function)h(is)g(a)g(one)h(line)f(function)f
(that)h(translates)g(the)g(write)g(call)g(into)g(a)300
2913 y Fm(sosend)f Fs(call.)39 b(The)27 b Fm(sosend)g
Fs(function)f(does)h(the)h(lion')-5 b(s)26 b(share)i(of)f(the)h(w)o
(ork)f(of)g(the)h(sock)o(et)f(layer)300 3062 y(including)d(handling)f
(all)i(the)g(numerous)f(options)g(supported)g(by)h(the)g(sock)o(et)g
(layer)-5 b(.)31 b(If)25 b(the)g Fm(sosend)300 3212 y
Fs(function)i(determines)g(that)g(it)g(ok)g(to)g(send)h(data)f(on)h
(the)f(sock)o(et)g(it)g(will)g(allocate)h(an)f(mb)n(uf)g(chain)h(for)
300 3361 y(the)e(data,)g(cop)o(y)g(the)g(data)g(from)f(the)h(user)g(b)n
(uf)n(fer)g(pointed)f(to)h(by)g(the)f Fm(uio)h Fs(structure)f(into)g
(the)h(chain,)300 3510 y(and)d(then)f(pass)g(the)g(ne)n(wly)g(created)h
(mb)n(uf)f(chain)h(to)f(the)g(protocol)g(layer')-5 b(s)22
b(user)h(request)f(function)g(for)300 3660 y(transmission)806
3624 y Fj(4)841 3660 y Fs(.)49 b(Once)31 b(the)g(sock)o(et)g(layer)g
(has)g(passed)g(the)f(data)h(to)g(the)g(protocol)f(layer)l(,)i(its)f
(role)f(in)300 3809 y(the)25 b(transmit)e(process)i(is)f(complete.)30
b(The)25 b(code)g(path)f(for)i(a)f Fm(write)e Fs(is)i(sho)n(wn)e(in)i
(Figure)g(10.1.)583 3959 y(T)-8 b(o)37 b(enable)f(the)g(sock)o(et)g
(layer)h(to)f(use)g(page)h(loanout)e(rather)i(than)f(data)g(cop)o(ying)
f(for)i(data)300 4108 y(transmission)25 b(a)i(second)f
Fm(write)g Fs(system)g(call)h(w)o(as)f(added)h(to)g(the)f(k)o(ernel.)37
b(Ha)n(ving)26 b(tw)o(o)h(write)g(sys-)300 4257 y(tem)j(calls)g(in)g
(the)g(k)o(ernel)g(allo)n(ws)f(us)h(to)g(easily)g(switch)f(between)i
(data)f(cop)o(ying)f(and)i(page)f(loanout)300 4407 y(when)49
b(taking)f(measurements.)101 b(The)49 b(ne)n(w)g(write)f(system)g(call)
h(calls)f(a)h(modi\002ed)f(v)o(ersion)g(of)300 4556 y
Fm(soo)p 486 4556 V 35 w(write)36 b Fs(when)h(a)h(write)f(to)g(a)g
(sock)o(et)g(is)g(detected.)68 b(The)37 b(alternate)h
Fm(soo)p 3203 4556 V 35 w(write)e Fs(function)300 4706
y(calls)28 b Fm(xsosend)p Fs(.)41 b(The)29 b Fm(xsosend)f
Fs(function)f(is)i(a)g(modi\002ed)f(v)o(ersion)g(of)g
Fm(sosend)g Fs(that)g(looks)g(for)300 4855 y(lar)n(ge)d(user)g(b)n(uf)n
(fers.)583 5004 y(When)f Fm(xsosend)e Fs(detects)i(a)g(lar)n(ge)g(user)
f(b)n(uf)n(fer)l(,)h(it)f(uses)h(UVM')-5 b(s)22 b(page)i(loanout)f(to)g
(loan)g(the)300 5154 y(user')-5 b(s)31 b(pages)g(out)f(to)h(k)o(ernel)g
(pages.)50 b(It)31 b(then)f(maps)h(those)f(pages)i(into)e(the)h(k)o
(ernel)g(address)g(space,)p 300 5243 1440 4 v 416 5305
a Fi(4)449 5335 y Fh(This)21 b(is)g(the)f Fe(PRU)p 971
5335 25 4 v 29 w(SEND)g Fh(request.)p eop
%%Page: 210 230
210 229 bop 3751 100 a Fs(210)300 249 y(and)32 b(allocates)f(an)h(e)o
(xternal)f(mb)n(uf)g(for)g(each)i(one.)51 b(Each)31 b(e)o(xternal)g(mb)
n(uf)g(points)g(to)g(a)h(special)f(free)300 398 y(function)24
b(that)g(will)g(drop)h(the)f(loan)h(once)g(the)g(pages)f(ha)n(v)o(e)h
(been)g(transmitted.)300 730 y Ff(10.1.2)118 b(P)o(age)30
b(Loanout)g(Measur)n(ements)300 946 y Fs(T)-8 b(o)28
b(measure)h(the)f(ef)n(fect)h(of)f(page)h(loanout)e(we)i(wrote)f(a)h
(test)f(program)g(that)g(uses)g(the)g(null)g(protocol)300
1096 y(to)33 b(transmit)f(lar)n(ge)i(chunks)e(of)i(data)f(through)f
(the)h(sock)o(et)g(layer)-5 b(.)56 b(The)33 b(actions)g(performed)g(by)
g(the)300 1245 y(test)c(program)g(are)i(similar)d(to)h(programs)g(such)
h(as)f(ftp,)i(web,)f(and)g(video)f(serv)o(ers.)45 b(Such)30
b(programs)300 1394 y(operate)25 b(by)g(opening)f(data)g(\002les)h(and)
g(transmit)f(the)g(\002le')-5 b(s)25 b(content)f(o)o(v)o(er)g(the)h
(netw)o(ork.)583 1544 y(The)k(test)e(program)h(transmits)f(data)h(in)g
(one)g(of)h(tw)o(o)f(w)o(ays.)40 b(It)29 b(can)f(use)g(the)h(normal)e
Fm(write)300 1693 y Fs(system)c(call,)g(in)h(which)f(case)i(the)e(data)
h(will)f(be)h(copied)f(from)h(user)g(space)g(into)f(k)o(ernel)h(b)n(uf)
n(fers.)30 b(Or)24 b(it)300 1843 y(can)e(use)f(the)g(modi\002ed)g
Fm(write)f Fs(system,)h(in)g(which)g(case)h(the)f Fm(xsosend)f
Fs(function)g(will)h(use)g(UVM')-5 b(s)300 1992 y(page)25
b(loanout)f(to)g(mo)o(v)o(e)f(the)i(data.)583 2141 y(The)g(test)g
(program)f(operates)h(as)g(follo)n(ws:)420 2374 y(1.)49
b(The)25 b(parameters)g(are)g(parsed.)420 2606 y(2.)49
b(A)25 b(null)f(sock)o(et)g(is)g(created)i(for)f(program)f(output.)420
2839 y(3.)49 b(A)25 b(b)n(uf)n(fer)g(is)f(allocated.)420
3071 y(4.)49 b(The)25 b(entire)g(b)n(uf)n(fer)h(is)e(written)h(to)g
(the)g(null)f(sock)o(et)h(in)g(\002x)o(ed)g(sized)g(chunks)g(\(the)g
(\223write)h(size\224\))544 3220 y(a)f(speci\002ed)g(number)f(of)h
(times.)300 3453 y(The)h(test)g(program)f(tak)o(es)h(as)g(parameters)g
(the)g(size)g(of)h(the)e(b)n(uf)n(fer)l(,)i(the)f(number)f(of)h(times)f
(the)h(b)n(uf)n(fer)300 3602 y(is)e(transmitted,)f(and)i(the)g(amount)f
(of)h(data)f(to)h(pass)f(to)h(the)f Fm(write)g Fs(system)g(call)h
(\(the)f(write)h(size\).)583 3752 y(The)32 b(test)g(program)f(w)o(as)h
(run)g(using)f(a)h(tw)o(o)f(me)o(gabyte)f(b)n(uf)n(fer)i(that)g(w)o(as)
f(transmitted)g(1024)300 3901 y(times.)41 b(Thus,)28
b(tw)o(o)g(gigabyte)g(of)g(data)h(w)o(as)f(transmitted)f(for)i(each)g
(run)g(of)f(the)g(test)g(program.)42 b(Each)300 4050
y(run)22 b(of)h(the)f(program)h(w)o(as)f(timed)g(so)g(that)g(the)g
(bandwidth)f(of)i(the)f(null)g(sock)o(et)g(could)g(be)h(determined.)300
4200 y(The)f(write)f(size)h(w)o(as)g(v)n(aried)f(from)g(1K)h(to)f
(2048K.)g(The)h(results)e(of)i(the)g(test)f(using)g(cop)o(ying)f(and)i
(page)300 4349 y(loanout)i(are)h(sho)n(wn)f(in)g(Figure)h(10.2.)583
4499 y(F)o(or)39 b(write)e(sizes)h(that)g(are)h(less)e(than)h(the)g
(hardw)o(are)h(page)f(size)g(\(4K\),)g(cop)o(ying)f(the)h(data)300
4648 y(produces)f(a)g(higher)f(bandwidth)g(than)h(using)e(page)i
(loanout.)66 b(This)37 b(is)f(due)h(to)f(the)h(page)g(loanout)300
4797 y(mechanism)g(being)h(used)h(to)f(loan)g(out)g(pages)g(that)g(are)
i(only)d(partially)h(full)g(of)h(v)n(alid)e(data.)72
b(F)o(or)300 4947 y(e)o(xample,)37 b(when)e(the)g(write)g(size)g(is)g
(1K)g(for)h(each)g(page)f(loaned)g(out)g(there)g(is)g(3K)g(of)g(data)g
(in)g(the)300 5096 y(page)j(that)g(is)f(not)h(being)f(used.)70
b(Once)38 b(the)g(write)g(size)g(reaches)g(the)g(page)g(size,)k(page)c
(loanout')-5 b(s)300 5246 y(bandwidth)21 b(o)o(v)o(ertak)o(es)g(data)i
(cop)o(ying.)29 b(As)22 b(the)h(write)f(size)g(is)g(increased)h(to)f
(allo)n(w)f(multiple)g(pages)h(to)300 5395 y(be)h(transmitted)f(in)h(a)
h(single)e Fm(write)g Fs(call,)i(the)f(data)g(cop)o(ying)g(bandwidth)f
(increases)h(until)f(the)h(write)p eop
%%Page: 211 231
211 230 bop 3751 100 a Fs(211)685 2430 y @beginspecial
43 @llx 43 @lly 528 @urx 434 @ury 3395 @rwi @setspecial
%%BeginDocument: ../plots/plot1/Plot1.eps
80 dict begin
/languagelevel where
{pop /gs_languagelevel languagelevel def}
{/gs_languagelevel 1 def} ifelse
gs_languagelevel 1 gt {
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<0000000000000000000000000000000000000000000000000000000000000000>} image end }
			>> 	matrix makepattern /Pat0 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111000044440000111100004444000011110000444400001111000044440000>} image end }
			>> 	matrix makepattern /Pat1 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111444411114444111144441111444411114444111144441111444411114444>} image end }
			>> 	matrix makepattern /Pat2 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555>} image end }
			>> 	matrix makepattern /Pat3 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbb>} image end }
			>> 	matrix makepattern /Pat4 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffff>} image end }
			>> 	matrix makepattern /Pat5 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<f77dffffbeeffffff77dffffbeeffffff77dffffbeeffffff77dffffbeefffff>} image end }
			>> 	matrix makepattern /Pat6 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff>} image end }
			>> 	matrix makepattern /Pat7 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<e1e1f0f078783c3c1e1e0f0f8787c3c3e1e1f0f078783c3c1e1e0f0f8787c3c3>} image end }
			>> 	matrix makepattern /Pat8 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<87870f0f1e1e3c3c7878f0f0e1e1c3c387870f0f1e1e3c3c7878f0f0e1e1c3c3>} image end }
			>> 	matrix makepattern /Pat9 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc>} image end }
			>> 	matrix makepattern /Pat10 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffff>} image end }
			>> 	matrix makepattern /Pat11 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e>} image end }
			>> 	matrix makepattern /Pat12 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebf>} image end }
			>> 	matrix makepattern /Pat13 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7e>} image end }
			>> 	matrix makepattern /Pat14 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fffffbdff3dfebdfdbdfbbdf7bdffbdefbddfbdbfbd7fbcffbdfffffffffffff>} image end }
			>> 	matrix makepattern /Pat15 exch def 
}{
/Pat0 { 0.000000 setgray } def
/Pat1 { 0.062500 setgray } def
/Pat2 { 0.125000 setgray } def
/Pat3 { 0.187500 setgray } def
/Pat4 { 0.250000 setgray } def
/Pat5 { 0.312500 setgray } def
/Pat6 { 0.375000 setgray } def
/Pat7 { 0.437500 setgray } def
/Pat8 { 0.500000 setgray } def
/Pat9 { 0.562500 setgray } def
/Pat10 { 0.625000 setgray } def
/Pat11 { 0.687500 setgray } def
/Pat12 { 0.750000 setgray } def
/Pat13 { 0.812500 setgray } def
/Pat14 { 0.875000 setgray } def
/Pat15 { 0.937500 setgray } def
/setpattern { } def
} ifelse
/m {moveto} bind def
/l {lineto} bind def
/s {stroke} bind def
% Symbol fill
/f { gsave fill grestore stroke } bind def
% Opaque symbol
/o { gsave 1.000000 1.000000 1.000000 setrgbcolor
     fill grestore stroke } bind def
% Circle symbol
/a { 3 -1 roll 0 360 arc } bind def
/da { a s } bind def
/fa { a f } bind def
/oa { a o } bind def
% Square symbol
/sq { moveto dup dup rmoveto 2 mul
      dup neg 0 rlineto dup neg 0 exch rlineto
      0 rlineto closepath } bind def
/dsq { sq s } bind def
/fsq { sq f } bind def
/osq { sq o } bind def
% Triangle symbols
/t1 { moveto dup 0 exch rmoveto
      dup neg dup 2 mul rlineto 2 mul 0 rlineto
      closepath } bind def
/dt1 { t1 s } bind def
/ft1 { t1 f } bind def
/ot1 { t1 o } bind def
/t2 { moveto dup neg 0 rmoveto
      dup dup 2 mul exch neg rlineto
      2 mul 0 exch rlineto closepath } bind def
/dt2 { t2 s } bind def
/ft2 { t2 f } bind def
/ot2 { t2 o } bind def
/t3 { moveto dup neg 0 exch rmoveto
      dup dup 2 mul rlineto neg 2 mul 0 rlineto
      closepath } bind def
/dt3 { t3 s } bind def
/ft3 { t3 f } bind def
/ot3 { t3 o } bind def
/t4 { moveto dup 0 rmoveto
      dup dup -2 mul exch rlineto
      -2 mul 0 exch rlineto closepath } bind def
/dt4 { t4 s } bind def
/ft4 { t4 f } bind def
/ot4 { t4 o } bind def
% Diamond symbol
/di { moveto dup 0 exch rmoveto
      dup neg dup rlineto dup dup neg rlineto
      dup dup rlineto closepath } bind def
/ddi { di s } bind def
/fdi { di f } bind def
/odi { di o } bind def
% Plus symbol
/pl { dup 0 rmoveto dup -2 mul 0 rlineto
      dup dup rmoveto -2 mul 0 exch rlineto
    } bind def
/dpl { m pl s } bind def
% x symbol
/x { dup dup rmoveto dup -2 mul dup rlineto
     2 mul dup 0 rmoveto dup neg exch rlineto
   } bind def
/dx { m x s } bind def
% Splat symbol
/dsp { m dup pl dup 0 exch rmoveto 0.707 mul x s
     } bind def
/RJ {
 stringwidth neg exch neg exch
 rmoveto
} bind def
/CS {
 stringwidth
 2 div neg exch 2 div neg exch
 rmoveto
} bind def
0.24 0.24 scale
1 setlinecap

	mark             
	/ISOLatin1Encoding 
	  8#000 1 8#054 {StandardEncoding exch get} for 
	  /minus 
	  8#056 1 8#217 {StandardEncoding exch get} for 
	  /dotlessi 
	  8#301 1 8#317 {StandardEncoding exch get} for 
	  /space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
	  /dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen 
	  /registered /macron /degree /plusminus /twosuperior /threesuperior /acute 
	  /mu /paragraph /periodcentered /cedilla /onesuperior /ordmasculine 
	  /guillemotright /onequarter /onehalf /threequarters /questiondown /Agrave 
	  /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute
	  /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde
	  /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave 
	  /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls /agrave /aacute 
	  /acircumflex /atilde /adieresis /aring /ae /ccedilla /egrave /eacute 
	  /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde
	  /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave 
	  /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
	  /ISOLatin1Encoding where not {256 array astore def} if 
	 cleartomark 

	/makeISOEncoded 
	{ findfont /curfont exch def 
	  /newfont curfont maxlength dict def  
	  /ISOLatin1 (-ISOLatin1) def
	  /curfontname curfont /FontName get dup length string cvs def 
	  /newfontname curfontname length ISOLatin1 length add string 
    	 dup 0                  curfontname putinterval 
    	 dup curfontname length ISOLatin1   putinterval 
	  def 
	  curfont   
	  { exch dup /FID ne  
    	{ dup /Encoding eq  
    	  { exch pop ISOLatin1Encoding exch }  
    	  if  
    	  dup /FontName eq  
    	  { exch pop newfontname exch }  
    	  if  
    	  exch newfont 3 1 roll put  
    	}  
    	{ pop pop }  
    	ifelse  
	  }  
	  forall 
	  newfontname newfont definefont 
	} def 

	/Times-Roman makeISOEncoded pop 
	/Times-Bold makeISOEncoded pop 
	/Times-Italic makeISOEncoded pop 
	/Times-BoldItalic makeISOEncoded pop 
	/Helvetica makeISOEncoded pop 
	/Helvetica-Bold makeISOEncoded pop 
	/Helvetica-Oblique makeISOEncoded pop 
	/Helvetica-BoldOblique makeISOEncoded pop 
s
0.000000 0.000000 0.000000 setrgbcolor
1 setlinewidth
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
[] 0 setdash
435 375 m
435 385 l
561 375 m
561 385 l
635 375 m
635 385 l
687 375 m
687 385 l
728 375 m
728 385 l
761 375 m
761 385 l
789 375 m
789 385 l
814 375 m
814 385 l
835 375 m
835 385 l
854 375 m
854 385 l
981 375 m
981 385 l
1055 375 m
1055 385 l
1107 375 m
1107 385 l
1148 375 m
1148 385 l
1181 375 m
1181 385 l
1209 375 m
1209 385 l
1234 375 m
1234 385 l
1255 375 m
1255 385 l
1275 375 m
1275 385 l
1401 375 m
1401 385 l
1475 375 m
1475 385 l
1527 375 m
1527 385 l
1568 375 m
1568 385 l
1601 375 m
1601 385 l
1629 375 m
1629 385 l
1654 375 m
1654 385 l
1675 375 m
1675 385 l
1694 375 m
1694 385 l
1821 375 m
1821 385 l
1895 375 m
1895 385 l
1947 375 m
1947 385 l
1988 375 m
1988 385 l
2021 375 m
2021 385 l
2049 375 m
2049 385 l
2074 375 m
2074 385 l
2095 375 m
2095 385 l
2115 375 m
2115 385 l
435 1775 m
435 1765 l
561 1775 m
561 1765 l
635 1775 m
635 1765 l
687 1775 m
687 1765 l
728 1775 m
728 1765 l
761 1775 m
761 1765 l
789 1775 m
789 1765 l
814 1775 m
814 1765 l
835 1775 m
835 1765 l
854 1775 m
854 1765 l
981 1775 m
981 1765 l
1055 1775 m
1055 1765 l
1107 1775 m
1107 1765 l
1148 1775 m
1148 1765 l
1181 1775 m
1181 1765 l
1209 1775 m
1209 1765 l
1234 1775 m
1234 1765 l
1255 1775 m
1255 1765 l
1275 1775 m
1275 1765 l
1401 1775 m
1401 1765 l
1475 1775 m
1475 1765 l
1527 1775 m
1527 1765 l
1568 1775 m
1568 1765 l
1601 1775 m
1601 1765 l
1629 1775 m
1629 1765 l
1654 1775 m
1654 1765 l
1675 1775 m
1675 1765 l
1694 1775 m
1694 1765 l
1821 1775 m
1821 1765 l
1895 1775 m
1895 1765 l
1947 1775 m
1947 1765 l
1988 1775 m
1988 1765 l
2021 1775 m
2021 1765 l
2049 1775 m
2049 1765 l
2074 1775 m
2074 1765 l
2095 1775 m
2095 1765 l
2115 1775 m
2115 1765 l
s
435 375 m
435 395 l
854 375 m
854 395 l
1275 375 m
1275 395 l
1694 375 m
1694 395 l
2115 375 m
2115 395 l
435 1775 m
435 1755 l
854 1775 m
854 1755 l
1275 1775 m
1275 1755 l
1694 1775 m
1694 1755 l
2115 1775 m
2115 1755 l
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
435 325 m
gsave
435 325 translate
0 rotate
0 -20  m
(1) CS
(1) show
grestore
newpath
854 325 m
gsave
854 325 translate
0 rotate
0 -20  m
(10) CS
(10) show
grestore
newpath
1275 325 m
gsave
1275 325 translate
0 rotate
0 -20  m
(100) CS
(100) show
grestore
newpath
1694 325 m
gsave
1694 325 translate
0 rotate
0 -20  m
(1000) CS
(1000) show
grestore
newpath
2115 325 m
gsave
2115 325 translate
0 rotate
0 -20  m
(10000) CS
(10000) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1275 225 m
gsave
1275 225 translate
0 rotate
0 0  m
(write size \(kbytes\)) CS
(write size \(kbytes\)) show
grestore
newpath
435 375 m
445 375 l
435 550 m
445 550 l
435 725 m
445 725 l
435 900 m
445 900 l
435 1075 m
445 1075 l
435 1250 m
445 1250 l
435 1425 m
445 1425 l
435 1600 m
445 1600 l
435 1775 m
445 1775 l
2115 375 m
2105 375 l
2115 550 m
2105 550 l
2115 725 m
2105 725 l
2115 900 m
2105 900 l
2115 1075 m
2105 1075 l
2115 1250 m
2105 1250 l
2115 1425 m
2105 1425 l
2115 1600 m
2105 1600 l
2115 1775 m
2105 1775 l
s
435 375 m
455 375 l
435 725 m
455 725 l
435 1075 m
455 1075 l
435 1425 m
455 1425 l
435 1775 m
455 1775 l
2115 375 m
2095 375 l
2115 725 m
2095 725 l
2115 1075 m
2095 1075 l
2115 1425 m
2095 1425 l
2115 1775 m
2095 1775 l
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
397 375 m
gsave
397 375 translate
0 rotate
0 -20  m
(0) RJ
(0) show
grestore
newpath
397 725 m
gsave
397 725 translate
0 rotate
0 -20  m
(200) RJ
(200) show
grestore
newpath
397 1075 m
gsave
397 1075 translate
0 rotate
0 -20  m
(400) RJ
(400) show
grestore
newpath
397 1425 m
gsave
397 1425 translate
0 rotate
0 -20  m
(600) RJ
(600) show
grestore
newpath
397 1775 m
gsave
397 1775 translate
0 rotate
0 -20  m
(800) RJ
(800) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
246 1075 m
gsave
246 1075 translate
90 rotate
0 0  m
(bandwidth \(MB/sec\)) CS
(bandwidth \(MB/sec\)) show
grestore
newpath
435 529 m
561 586 l
687 616 l
814 641 l
940 660 l
1067 668 l
1193 671 l
1320 672 l
1446 671 l
1572 675 l
1699 675 l
1825 675 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 435 529 fa
14 561 586 fa
14 687 616 fa
14 814 641 fa
14 940 660 fa
14 1067 668 fa
14 1193 671 fa
14 1320 672 fa
14 1446 671 fa
14 1572 675 fa
14 1699 675 fa
14 1825 675 fa
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
435 457 m
561 539 l
687 694 l
814 877 l
940 1122 l
1067 1354 l
1193 1570 l
1320 1633 l
1446 1669 l
1572 1679 l
1699 1688 l
1825 1693 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
12 435 457 fsq
12 561 539 fsq
12 687 694 fsq
12 814 877 fsq
12 940 1122 fsq
12 1067 1354 fsq
12 1193 1570 fsq
12 1320 1633 fsq
12 1446 1669 fsq
12 1572 1679 fsq
12 1699 1688 fsq
12 1825 1693 fsq
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
435 375 m
435 1775 l
2115 1775 l
2115 375 l
435 375 l
s
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1694 1513 m
1834 1513 l
s
14 1694 1513 fa
14 1834 1513 fa
1869 1513 m
gsave
1869 1513 translate
0 rotate
0 -20  m
(copy) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
1694 1439 m
1834 1439 l
s
12 1694 1439 fsq
12 1834 1439 fsq
0.000000 0.000000 0.000000 setrgbcolor
1869 1439 m
gsave
1869 1439 translate
0 rotate
0 -20  m
(loan) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
687 550 m
gsave
687 550 translate
0 rotate
0 -20  m
(4K) CS
(4K) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
end
showpage
%%EndDocument
 @endspecial 479 2634 a(Figure)25 b(10.2:)30 b(Comparison)24
b(of)h(cop)o(y)g(and)f(loan)h(procedures)g(for)g(writing)f(to)g(a)h
(null)f(sock)o(et)300 3029 y(size)32 b(reaches)h(32K.)e(The)h(data)g
(cop)o(y)f(bandwidth)g(ne)n(v)o(er)g(e)o(xceeds)h(172)f(MB/sec.)52
b(Meanwhile,)33 b(the)300 3178 y(loanout)26 b(bandwidth)g(rises)g
(sharply)g(as)h(the)g(write)g(size)g(is)f(increased.)38
b(When)27 b(the)f(write)h(size)g(is)f(32K)300 3328 y(the)33
b(loanout)g(bandwidth)f(is)h(560)g(MB/sec.)57 b(The)33
b(loanout)g(bandwidth)f(le)n(v)o(els)g(of)n(f)h(at)h(750)f(MB/sec)300
3477 y(when)f(the)g(write)f(size)h(is)g(512K.)f(Clearly)-6
b(,)33 b(page)g(loanout)d(impro)o(v)o(ed)g(the)i(I/O)g(performance)g
(of)g(the)300 3626 y(test)24 b(program)h(by)f(reducing)h(data)g(cop)o
(y)f(o)o(v)o(erhead.)583 3776 y(Note)29 b(that)g(the)f(high)h
(bandwidth)e(achie)n(v)o(ed)i(by)f(page)h(loanout)f(is)h(through)f
(virtual)g(memory)300 3925 y(based)h(operations)f(rather)h(than)g
(through)f(data)h(cop)o(ying.)42 b(The)29 b(results)g(of)g(the)f
Fm(lmbench)g Fs(memory)300 4075 y(bandwidth)23 b(benchmarks)g(sho)n(w)g
(that)h(such)g(high)f(bandwidths)f(cannot)i(be)g(achie)n(v)o(ed)g(if)g
(each)g(byte)g(of)300 4224 y(the)d(data)g(is)g(read)h(or)f(copied.)29
b(Not)21 b(all)g(applications)f(require)h(the)g(data)h(to)e(be)i
(accessed.)30 b(F)o(or)21 b(e)o(xample,)300 4373 y(the)g(multimedia)d
(video)i(serv)o(er)h(described)g(in)f([12])h(transmits)e(data)h(read)i
(from)e(disk)g(without)f(reading)300 4523 y(or)25 b(touching)e(it)i
(and)g(thus)f(could)g(bene\002t)h(from)f(page)h(loanout.)300
4906 y Fg(10.2)143 b(P)o(age)34 b(T)-11 b(ransfer)34
b(P)m(erf)l(ormance)300 5159 y Fs(P)o(age)27 b(transfer)f(allo)n(ws)f
(a)i(process)f(to)g(recei)n(v)o(e)h(pages)f(of)g(data)h(from)f(the)g(k)
o(ernel)h(or)f(another)g(process.)300 5308 y(P)o(ages)d(recei)n(v)o(ed)
f(with)f(page)i(transfer)g(are)g(mapped)f(into)g(the)g(recei)n(ving)g
(process')h(page)f(transfer)h(area)p eop
%%Page: 212 232
212 231 bop 3751 100 a Fs(212)300 249 y(of)25 b(virtual)g(memory)-6
b(.)31 b(Once)26 b(a)f(page)h(is)f(transfered)h(into)e(a)i(process')f
(address)g(space)h(it)f(becomes)g(part)300 398 y(of)g(that)f(process')h
(anon)o(ymous)e(memory)h(and)h(requires)f(no)h(further)g(special)f
(treatment.)583 548 y(P)o(age)30 b(transfer)f(mo)o(v)o(es)e(data)i(in)f
(the)h(opposite)f(direction)g(that)g(page)h(loanout)f(does.)43
b(In)29 b(page)300 697 y(loanout,)24 b(a)g(process)h(loans)f(its)g
(data)g(out)g(to)h(some)f(other)g(process)h(or)f(the)h(k)o(ernel.)30
b(In)25 b(page)g(transfer)l(,)g(a)300 847 y(process)j(recei)n(v)o(es)g
(pages)g(from)g(other)g(processes)g(or)g(the)g(k)o(ernel.)41
b(The)28 b(pages)h(recei)n(v)o(ed)e(may)h(either)300
996 y(be)21 b(loaned)g(from)g(another)g(process)h(or)f(their)g(o)n
(wnership)f(may)h(be)g(donated)g(to)g(the)g(recei)n(ving)f(process.)300
1145 y(The)31 b(bene\002t)g(of)h(using)e(page)h(transfer)h(is)e(that)h
(the)g(transferred)g(data)h(is)e(mo)o(v)o(ed)g(into)g(the)h(recei)n
(ving)300 1295 y(process')25 b(virtual)f(address)h(space)g(without)e
(the)i(o)o(v)o(erhead)f(of)h(a)g(data)g(cop)o(y)-6 b(.)583
1444 y(The)23 b(ef)n(fect)g(of)g(page)f(transfer)h(on)g(the)f(o)o(v)o
(erhead)g(of)h(I/O)f(operations)g(can)h(be)g(measured)f(using)300
1594 y(the)g(k)o(ernel')-5 b(s)21 b(netw)o(orking)f(subsystem)g(in)i(a)
g(w)o(ay)f(that)h(is)f(similar)f(to)i(the)f(procedure)h(used)g(to)f
(measure)300 1743 y(the)33 b(ef)n(fect)g(of)g(page)h(loanout.)54
b(In)33 b(a)g(traditional)f(system,)i(when)f(data)g(is)g(read)g(from)g
(a)g(sock)o(et)g(it)g(is)300 1892 y(copied)h(from)g(a)h(k)o(ernel)g(mb)
n(uf)f(into)f(the)i(recei)n(ving)e(process')i(virtual)f(address)g
(space.)60 b(W)l(ith)34 b(page)300 2042 y(transfer)l(,)h(the)d(netw)o
(ork)g(read)h(operation)e(on)h(lar)n(ger)h(chunks)f(of)h(data)f(can)h
(be)f(done)g(by)h(using)e(page)300 2191 y(transfer)39
b(to)g(transfer)g(a)h(lar)n(ge)f(mb)n(uf)5 b(')-5 b(s)39
b(data)g(area)h(from)e(the)h(k)o(ernel)g(directly)g(into)f(the)h(recei)
n(ving)300 2341 y(process')24 b(virtual)g(address)g(pace,)h(bypassing)e
(the)h(cop)o(y)-6 b(.)30 b(F)o(or)24 b(this)f(to)h(be)h(feasible,)f
(the)g(k)o(ernel)g(should)300 2490 y(be)h(con\002gured)g(so)f(that)h
(the)f(b)n(uf)n(fer)h(size)g(of)g(a)g(cluster)g(mb)n(uf)f(is)g(equal)h
(to)f(the)h(system)f(page)h(size)3700 2454 y Fj(5)3737
2490 y Fs(.)583 2639 y(Unfortunately)-6 b(,)22 b(the)g(measurement)f
(of)h(the)g(performance)h(of)f(page)g(transfer)h(on)f(netw)o(ork)f(I/O)
300 2789 y(operations)31 b(is)g(ef)n(fected)h(by)g(a)g(similar)f
(problem)g(to)g(the)h(one)g(that)f(that)g(ef)n(fected)h(the)g(page)g
(loanout)300 2938 y(measurements,)41 b(namely)c(that)h(current)h
(processors)e(can)i(pass)f(recei)n(v)o(ed)g(data)g(to)g(user)g
(processes)300 3088 y(f)o(aster)32 b(than)f(the)h(current)g(generation)
f(of)h(netw)o(ork)g(interf)o(aces)g(can)g(recei)n(v)o(e)f(it.)51
b(Thus)31 b(an)o(y)g(positi)n(v)o(e)300 3237 y(ef)n(fects)24
b(produced)g(by)g(page)h(transfer)g(will)e(result)h(in)g(a)g(reduction)
g(of)g(processor)g(load)g(rather)h(than)f(an)300 3386
y(increased)h(in-bound)f(data)h(bandwidth.)583 3536 y(F)o(ortunately)-6
b(,)35 b(this)e(problem)g(can)h(be)g(w)o(ork)o(ed)g(around.)58
b(Since)34 b(the)g(k)o(ernel')-5 b(s)33 b(protocol)g(and)300
3685 y(netw)o(ork)23 b(interf)o(ace)h(layers)g(ha)n(v)o(e)f(the)g(same)
h(o)o(v)o(erhead)f(re)o(gardless)f(of)i(whether)f(or)h(not)f(page)h
(transfer)300 3835 y(is)30 b(used,)i(their)e(o)o(v)o(erhead)g(can)h(be)
g(safely)f(f)o(actored)h(out)f(of)h(the)f(page)h(transfer)g
(performance)g(band-)300 3984 y(width.)55 b(This)32 b(w)o(as)h(achie)n
(v)o(ed)g(by)g(introducing)e(a)j(ne)n(w)f(\223null\224)f(sock)o(et)h
(read)h(into)e(the)h(BSD)h(k)o(ernel.)300 4133 y(When)22
b(the)g(sock)o(et)f(layer)i(detects)e(a)h(null)g(sock)o(et)f(read,)i
(it)f(allocates)f(an)h(mb)n(uf)g(chain)f(of)h(the)g(requested)300
4283 y(size)k(\(containing)f(random)g(data\))h(and)g(uses)f(it)g(to)h
(satisfy)f(the)h(sock)o(et)f(read)h(request.)34 b(This)25
b(allo)n(ws)f(us)300 4432 y(to)f(directly)h(measure)g(the)f(ef)n(fect)i
(of)f(page)g(transfer)g(on)f(I/O)h(o)o(v)o(erhead)f(by)h(observing)f
(the)g(bandwidth)300 4581 y(of)i(null)f(sock)o(et)g(reads.)p
300 4651 1440 4 v 416 4712 a Fi(5)449 4742 y Fh(The)30
b(current)f(def)o(ault)g(cluster)g(mb)n(uf)h(size)g(on)g(the)f(i386)h
(is)g(2048)f(bytes,)j(or)d(half)h(a)g(page.)53 b(This)31
b(v)n(alue)e(must)h(be)300 4842 y(doubled)18 b(in)j(order)e(to)h(be)g
(able)g(to)g(use)h(page)e(transfer)h(on)f(cluster)i(mb)n(ufs.)p
eop
%%Page: 213 233
213 232 bop 3751 100 a Fs(213)1035 1625 y @beginspecial
0 @llx 0 @lly 365 @urx 253 @ury 2555 @rwi @setspecial
%%BeginDocument: ../figures/read.eps
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
-50.0 285.0 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
n 0 4789 m 0 0 l 6952 0 l 6952 4789 l cp clip
 0.06000 0.06000 sc
% Polyline
7.500 slw
n 5100 1800 m 6900 1800 l 6900 3375 l 5100 3375 l cp gs col7 0.95 shd ef gr gs col0 s gr 
/Helvetica-Bold ff 300.00 scf sf
3750 3495 m
gs 1 -1 sc (layer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3750 4350 m
gs 1 -1 sc (protocol) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3750 4695 m
gs 1 -1 sc (layer) dup sw pop neg 0 rm  col0 sh gr
% Polyline
gs  clippath
3738 1741 m 3622 1784 l 3704 1692 l 3571 1784 l 3605 1833 l cp
clip
n 4800 975 m 3600 1800 l gs col0 s gr gr

% arrowhead
n 3738 1741 m 3622 1784 l 3704 1692 l 3721 1717 l 3738 1741 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
5896 1692 m 5977 1784 l 5862 1741 l 5995 1833 l 6029 1784 l cp
clip
n 4800 975 m 6000 1800 l gs col0 s gr gr

% arrowhead
n 5896 1692 m 5977 1784 l 5862 1741 l 5879 1717 l 5896 1692 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6030 2853 m 6000 2973 l 5970 2853 l 5970 3015 l 6030 3015 l cp
clip
n 6000 2175 m 6000 3000 l gs col0 s gr gr

% arrowhead
n 6030 2853 m 6000 2973 l 5970 2853 l 6000 2853 l 6030 2853 l  cp gs 0.00 setgray ef gr  col0 s
% Polyline
gs  clippath
6030 4053 m 6000 4173 l 5970 4053 l 5970 4215 l 6030 4215 l cp
clip
n 6000 3375 m 6000 4200 l gs col0 s gr gr

% arrowhead
n 6030 4053 m 6000 4173 l 5970 4053 l 6000 4053 l 6030 4053 l  cp gs 0.00 setgray ef gr  col0 s
/Courier ff 300.00 scf sf
3600 2100 m
gs 1 -1 sc (vn_read) dup sw pop 2 div neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
6000 2100 m
gs 1 -1 sc (soo_read) dup sw pop 2 div neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
4800 900 m
gs 1 -1 sc (sys_read) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 750 m
gs 1 -1 sc (system) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 1125 m
gs 1 -1 sc (call layer) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 1950 m
gs 1 -1 sc (fileops) dup sw pop neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
2100 2295 m
gs 1 -1 sc (layer) dup sw pop neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
6000 3300 m
gs 1 -1 sc (soreceive) dup sw pop 2 div neg 0 rm  col0 sh gr
/Helvetica-Bold ff 300.00 scf sf
3750 3150 m
gs 1 -1 sc (socket) dup sw pop neg 0 rm  col0 sh gr
/Courier ff 300.00 scf sf
6000 4500 m
gs 1 -1 sc (tcp_usrreq) dup sw pop 2 div neg 0 rm  col0 sh gr
$F2psEnd
rs
%%EndDocument
 @endspecial 300 1829 a(Figure)20 b(10.3:)28 b(Sock)o(et)20
b Fm(read)f Fs(code)h(path.)29 b(The)20 b(code)g(in)g(the)f(box)h(has)g
(been)g(duplicated)f(and)h(modi\002ed)300 1949 y(to)28
b(use)f(page)h(transfer)h(for)f(our)g(measurements.)39
b(The)28 b(modi\002ed)f(code)h(is)g(accessed)g(by)g(an)g(alternate)300
2069 y(read)d(system)f(call.)300 2465 y Ff(10.2.1)118
b(Sock)o(et)31 b(Lay)o(er)e(Modi\002cations)300 2681
y Fs(The)c(sock)o(et)h(layer)f(of)h(the)f(BSD)i(k)o(ernel)e(had)g(to)h
(be)f(modi\002ed)g(to)g(support)f(the)i(ne)n(w)f(null)f(sock)o(et)i
(read)300 2831 y(system)i(call.)42 b(The)29 b(null)f(sock)o(et)g(read)h
(system)f(call)h(mo)o(v)o(es)e(data)i(either)f(by)h(cop)o(ying)f(it)g
(or)h(by)f(using)300 2980 y(page)e(transfer)-5 b(.)35
b(The)26 b(code)g(path)g(for)g(a)g(sock)o(et)g(read)h(is)e(sho)n(wn)g
(in)h(Figure)g(10.3.)34 b(When)26 b(the)g(protocol)300
3129 y(layer)e(recei)n(v)o(es)f(data)g(for)h(a)f(sock)o(et)g(from)h
(the)f(netw)o(ork)g(interf)o(ace)h(layer)f(it)g(enqueues)g(the)h(data)f
(on)g(the)300 3279 y(sock)o(et')-5 b(s)25 b(recei)n(v)o(e)g(sock)o(et)g
(b)n(uf)n(fer)h(mb)n(uf)f(queue.)33 b(This)25 b(data)h(w)o(aits)f(in)g
(the)h(sock)o(et)f(b)n(uf)n(fer)h(queue)f(until)300 3428
y(either)i(a)g(process)g(issues)f(a)h(read)h(for)f(the)g(data)g(or)g
(the)f(sock)o(et)h(is)g(closed)f(\(in)h(which)f(case)i(the)f(data)g(is)
300 3578 y(discarded\).)583 3727 y(When)g(a)g(process)f(issues)g(a)h
(read)g(on)g(a)g(sock)o(et,)f(the)h Fm(sys)p 2616 3727
30 4 v 35 w(read)f Fs(k)o(ernel)g(function)g(is)g(called.)300
3876 y(This)i(function)h(does)g(tw)o(o)g(things.)42 b(First,)30
b(it)f(wraps)h(the)f(pointer)f(to)h(the)g(user')-5 b(s)29
b(b)n(uf)n(fer)g(up)g(in)g(a)h Fm(uio)300 4026 y Fs(structure.)f
(Second,)23 b(it)e(looks)f(up)i(the)f(\002le)h(operations)f(structure)g
(associated)g(with)g(the)h(\002le)g(descriptor)300 4175
y(passed)27 b(to)f Fm(read)g Fs(and)h(calls)f(the)h(appropriate)f
(\223read\224)i(\002le)g(operation)e(for)h(that)f(\002le)h(descriptor)
-5 b(.)36 b(The)300 4325 y(tw)o(o)29 b(read)i(\002le)f(operations)f
(functions)g(are)i Fm(soo)p 2021 4325 V 35 w(read)e Fs(and)h
Fm(vn)p 2619 4325 V 35 w(read)f Fs(\(for)i(sock)o(ets)e(and)h(vnodes,)
300 4474 y(respecti)n(v)o(ely\).)583 4623 y(The)i Fm(soo)p
956 4623 V 35 w(read)f Fs(function)g(is)g(a)h(one)g(line)f(function)f
(that)i(translates)f(the)g(write)g(call)h(into)f(a)300
4773 y Fm(soreceive)21 b Fs(call.)30 b(The)23 b Fm(soreceive)d
Fs(function')-5 b(s)22 b(job)g(is)g(to)h(mo)o(v)o(e)e(data)i(from)f(a)h
(sock)o(et')-5 b(s)22 b(recei)n(v)o(e)300 4922 y(b)n(uf)n(fer)j(queue)g
(to)g(the)f(address)h(space)h(of)f(the)f(user)i(who)e(issued)g(the)h
(recei)n(v)o(e)g(request.)31 b(If)25 b(not)g(enough)300
5072 y(data)e(is)g(a)n(v)n(ailable,)g(the)g Fm(soreceive)e
Fs(function)i(may)f(suspend)h(the)g(requesting)f(process)h(until)f
(more)300 5221 y(data)28 b(is)g(a)n(v)n(ailable.)39 b(Once)29
b(the)f Fm(soreceive)e Fs(function)h(has)h(mo)o(v)o(ed)e(the)i(data,)h
(it)f(may)f(issue)h(a)g(user)300 5370 y(request)j(to)g(the)g(protocol)g
(layer)g(of)g(the)h(sock)o(et)f(to)f(inform)h(the)g(protocol)g(that)f
(the)h(user)h(read)g(some)p eop
%%Page: 214 234
214 233 bop 3751 100 a Fs(214)300 249 y(data.)42 b(Sliding)27
b(windo)n(w)g(protocols)h(such)g(as)h(TCP)g(require)g(this)e(callback)i
(so)f(that)g(the)o(y)g(can)g(update)300 398 y(their)23
b(windo)n(w)g(sizes)g(as)h(data)g(is)f(read)i(out)e(of)h(the)f(sock)o
(et)h(b)n(uf)n(fer)-5 b(.)30 b(Other)23 b(protocols)g(such)g(as)h(UDP)g
(do)300 548 y(not)g(require)h(this)f(callback.)583 697
y(T)-8 b(o)29 b(implement)e(the)h(null)f(sock)o(et)i(read)g(operation)e
(a)i(second)g(read)g(system)e(call)h(\(\223)p Fm(xread)p
Fs(\224\))300 847 y(w)o(as)23 b(added)g(to)f(the)h(BSD)g(k)o(ernel.)30
b(This)23 b(system)e(call)i(detects)g(null)e(read)j(operations)e(by)g
(checking)h(for)300 996 y(a)29 b(special)e(in)l(v)n(alid)g(\002le)i
(descriptor)-5 b(.)39 b(If)29 b(detected,)g(the)f Fm(xread)f
Fs(function)h(calls)f(a)i(special)f(v)o(ersion)f(of)300
1145 y Fm(soreceive)22 b Fs(to)h(handle)h(the)f(null)g(read)i(request.)
30 b(Otherwise,)23 b Fm(xread)g Fs(uses)g(its)g(normal)g(code)h(path)
300 1295 y(to)j(handle)h(the)g(read)g(request.)40 b(The)28
b Fm(xread)f Fs(system)g(call)g(returns)h(both)f(the)h(number)f(of)h
(bytes)g(read)300 1444 y(and)i(a)g(pointer)f(to)g(the)h(virtual)f
(address)g(where)h(the)g(pages)g(were)g(transfered)g(\(if)g(page)g
(transfer)g(w)o(as)300 1594 y(used\).)583 1743 y(The)21
b(special)g(null-read)g(v)o(ersion)f(of)h Fm(soreceive)e
Fs(allocates)h(an)h(mb)n(uf)g(chain)f(\(with)h(random)300
1892 y(data\))j(lar)n(ge)g(enough)f(to)g(satisfy)g(the)h(read)g
(request,)f(and)h(then)f(mo)o(v)o(es)f(the)i(data)f(to)g(the)h(user)g
(using)e(the)300 2042 y(technique)30 b(requested)f(by)h(the)g(user)g
(\(either)h(data)f(cop)o(ying)f(or)h(page)g(transfer\).)47
b(If)31 b(page)f(transfer)h(is)300 2191 y(speci\002ed,)21
b(a)g(ne)n(w)e(function)g(called)h Fm(so)p 1684 2191
30 4 v 36 w(mcl)p 1900 2191 V 35 w(steal)f Fs(is)h(called)g(to)f(remo)o
(v)o(e)g(the)h(page)g(from)g(a)g(cluster)300 2341 y(mb)n(uf.)30
b(It)25 b(performs)f(the)h(follo)n(wing)e(actions:)420
2554 y(1.)49 b(Unused)24 b(portions)g(of)h(the)f(cluster)h(mb)n(uf)5
b(')-5 b(s)24 b(data)h(area)g(are)h(zeroed)f(to)g(ensure)g(data)g
(security)-6 b(.)420 2781 y(2.)49 b(A)25 b(ne)n(w)f(anon)h(and)f(ne)n
(w)h(page)g(are)g(allocated.)420 3007 y(3.)49 b(The)21
b(ne)n(w)f(page)h(is)f(mapped)h(into)e(the)i(cluster)g(mb)n(uf)5
b(')-5 b(s)20 b(data)g(area)i(and)f(the)g(old)f(page)h(is)f(attached)
544 3156 y(to)k(the)h(ne)n(w)f(anon.)420 3382 y(4.)49
b(The)31 b(ne)n(w)g(anon)g(is)g(returned)g(\(it)g(is)g(ready)h(to)f(be)
g(transfered)h(into)e(the)h(recei)n(ving)g(processes')544
3532 y(address)25 b(space\).)300 3745 y(Once)37 b(the)f(data)h(pages)f
(ha)n(v)o(e)g(been)h(remo)o(v)o(ed)e(from)i(the)f(cluster)g(mb)n(ufs)g
(and)g(placed)h(into)f(anons,)300 3895 y(the)31 b(anons)g(can)h(be)f
(transferred)h(into)f(the)g(user')-5 b(s)31 b(address)g(space)h(using)e
(the)h(normal)g(page)h(transfer)300 4044 y(functions.)300
4372 y Ff(10.2.2)118 b(P)o(age)30 b(T)-9 b(ransfer)29
b(Measur)n(ements)300 4589 y Fs(T)-8 b(o)27 b(measure)h(the)f(ef)n
(fect)h(of)f(page)h(transfer)g(we)g(wrote)f(a)h(test)f(program)g(that)g
(uses)g(null)g(sock)o(et)g(reads)300 4738 y(to)h(recei)n(v)o(e)g(lar)n
(ge)h(chunks)f(of)g(data)h(through)e(the)h(sock)o(et)g(layer)-5
b(.)42 b(Thus,)28 b(the)g(test)g(program)g(is)g(similar)300
4887 y(to)c(programs)h(that)f(recei)n(v)o(e)g(lar)n(ge)i(chunks)e(of)h
(data)g(from)f(the)h(netw)o(ork)f(or)h(from)g(other)f(processes.)583
5037 y(The)f(test)f(program)h(can)g(request)f(that)h(the)f(k)o(ernel)h
(use)g(either)f(data)h(cop)o(ying)f(or)h(page)g(transfer)300
5186 y(to)h(mo)o(v)o(e)g(the)g(data.)31 b(The)25 b(test)f(program)h
(operates)g(as)f(follo)n(ws:)420 5400 y(1.)49 b(The)25
b(parameters)g(are)g(parsed.)p eop
%%Page: 215 235
215 234 bop 3751 100 a Fs(215)685 2430 y @beginspecial
43 @llx 43 @lly 528 @urx 434 @ury 3395 @rwi @setspecial
%%BeginDocument: ../plots/plot2/Plot2.eps
80 dict begin
/languagelevel where
{pop /gs_languagelevel languagelevel def}
{/gs_languagelevel 1 def} ifelse
gs_languagelevel 1 gt {
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<0000000000000000000000000000000000000000000000000000000000000000>} image end }
			>> 	matrix makepattern /Pat0 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111000044440000111100004444000011110000444400001111000044440000>} image end }
			>> 	matrix makepattern /Pat1 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111444411114444111144441111444411114444111144441111444411114444>} image end }
			>> 	matrix makepattern /Pat2 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555>} image end }
			>> 	matrix makepattern /Pat3 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbb>} image end }
			>> 	matrix makepattern /Pat4 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffff>} image end }
			>> 	matrix makepattern /Pat5 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<f77dffffbeeffffff77dffffbeeffffff77dffffbeeffffff77dffffbeefffff>} image end }
			>> 	matrix makepattern /Pat6 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff>} image end }
			>> 	matrix makepattern /Pat7 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<e1e1f0f078783c3c1e1e0f0f8787c3c3e1e1f0f078783c3c1e1e0f0f8787c3c3>} image end }
			>> 	matrix makepattern /Pat8 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<87870f0f1e1e3c3c7878f0f0e1e1c3c387870f0f1e1e3c3c7878f0f0e1e1c3c3>} image end }
			>> 	matrix makepattern /Pat9 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc>} image end }
			>> 	matrix makepattern /Pat10 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffff>} image end }
			>> 	matrix makepattern /Pat11 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e>} image end }
			>> 	matrix makepattern /Pat12 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebf>} image end }
			>> 	matrix makepattern /Pat13 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7e>} image end }
			>> 	matrix makepattern /Pat14 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fffffbdff3dfebdfdbdfbbdf7bdffbdefbddfbdbfbd7fbcffbdfffffffffffff>} image end }
			>> 	matrix makepattern /Pat15 exch def 
}{
/Pat0 { 0.000000 setgray } def
/Pat1 { 0.062500 setgray } def
/Pat2 { 0.125000 setgray } def
/Pat3 { 0.187500 setgray } def
/Pat4 { 0.250000 setgray } def
/Pat5 { 0.312500 setgray } def
/Pat6 { 0.375000 setgray } def
/Pat7 { 0.437500 setgray } def
/Pat8 { 0.500000 setgray } def
/Pat9 { 0.562500 setgray } def
/Pat10 { 0.625000 setgray } def
/Pat11 { 0.687500 setgray } def
/Pat12 { 0.750000 setgray } def
/Pat13 { 0.812500 setgray } def
/Pat14 { 0.875000 setgray } def
/Pat15 { 0.937500 setgray } def
/setpattern { } def
} ifelse
/m {moveto} bind def
/l {lineto} bind def
/s {stroke} bind def
% Symbol fill
/f { gsave fill grestore stroke } bind def
% Opaque symbol
/o { gsave 1.000000 1.000000 1.000000 setrgbcolor
     fill grestore stroke } bind def
% Circle symbol
/a { 3 -1 roll 0 360 arc } bind def
/da { a s } bind def
/fa { a f } bind def
/oa { a o } bind def
% Square symbol
/sq { moveto dup dup rmoveto 2 mul
      dup neg 0 rlineto dup neg 0 exch rlineto
      0 rlineto closepath } bind def
/dsq { sq s } bind def
/fsq { sq f } bind def
/osq { sq o } bind def
% Triangle symbols
/t1 { moveto dup 0 exch rmoveto
      dup neg dup 2 mul rlineto 2 mul 0 rlineto
      closepath } bind def
/dt1 { t1 s } bind def
/ft1 { t1 f } bind def
/ot1 { t1 o } bind def
/t2 { moveto dup neg 0 rmoveto
      dup dup 2 mul exch neg rlineto
      2 mul 0 exch rlineto closepath } bind def
/dt2 { t2 s } bind def
/ft2 { t2 f } bind def
/ot2 { t2 o } bind def
/t3 { moveto dup neg 0 exch rmoveto
      dup dup 2 mul rlineto neg 2 mul 0 rlineto
      closepath } bind def
/dt3 { t3 s } bind def
/ft3 { t3 f } bind def
/ot3 { t3 o } bind def
/t4 { moveto dup 0 rmoveto
      dup dup -2 mul exch rlineto
      -2 mul 0 exch rlineto closepath } bind def
/dt4 { t4 s } bind def
/ft4 { t4 f } bind def
/ot4 { t4 o } bind def
% Diamond symbol
/di { moveto dup 0 exch rmoveto
      dup neg dup rlineto dup dup neg rlineto
      dup dup rlineto closepath } bind def
/ddi { di s } bind def
/fdi { di f } bind def
/odi { di o } bind def
% Plus symbol
/pl { dup 0 rmoveto dup -2 mul 0 rlineto
      dup dup rmoveto -2 mul 0 exch rlineto
    } bind def
/dpl { m pl s } bind def
% x symbol
/x { dup dup rmoveto dup -2 mul dup rlineto
     2 mul dup 0 rmoveto dup neg exch rlineto
   } bind def
/dx { m x s } bind def
% Splat symbol
/dsp { m dup pl dup 0 exch rmoveto 0.707 mul x s
     } bind def
/RJ {
 stringwidth neg exch neg exch
 rmoveto
} bind def
/CS {
 stringwidth
 2 div neg exch 2 div neg exch
 rmoveto
} bind def
0.24 0.24 scale
1 setlinecap

	mark             
	/ISOLatin1Encoding 
	  8#000 1 8#054 {StandardEncoding exch get} for 
	  /minus 
	  8#056 1 8#217 {StandardEncoding exch get} for 
	  /dotlessi 
	  8#301 1 8#317 {StandardEncoding exch get} for 
	  /space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
	  /dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen 
	  /registered /macron /degree /plusminus /twosuperior /threesuperior /acute 
	  /mu /paragraph /periodcentered /cedilla /onesuperior /ordmasculine 
	  /guillemotright /onequarter /onehalf /threequarters /questiondown /Agrave 
	  /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute
	  /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde
	  /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave 
	  /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls /agrave /aacute 
	  /acircumflex /atilde /adieresis /aring /ae /ccedilla /egrave /eacute 
	  /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde
	  /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave 
	  /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
	  /ISOLatin1Encoding where not {256 array astore def} if 
	 cleartomark 

	/makeISOEncoded 
	{ findfont /curfont exch def 
	  /newfont curfont maxlength dict def  
	  /ISOLatin1 (-ISOLatin1) def
	  /curfontname curfont /FontName get dup length string cvs def 
	  /newfontname curfontname length ISOLatin1 length add string 
    	 dup 0                  curfontname putinterval 
    	 dup curfontname length ISOLatin1   putinterval 
	  def 
	  curfont   
	  { exch dup /FID ne  
    	{ dup /Encoding eq  
    	  { exch pop ISOLatin1Encoding exch }  
    	  if  
    	  dup /FontName eq  
    	  { exch pop newfontname exch }  
    	  if  
    	  exch newfont 3 1 roll put  
    	}  
    	{ pop pop }  
    	ifelse  
	  }  
	  forall 
	  newfontname newfont definefont 
	} def 

	/Times-Roman makeISOEncoded pop 
	/Times-Bold makeISOEncoded pop 
	/Times-Italic makeISOEncoded pop 
	/Times-BoldItalic makeISOEncoded pop 
	/Helvetica makeISOEncoded pop 
	/Helvetica-Bold makeISOEncoded pop 
	/Helvetica-Oblique makeISOEncoded pop 
	/Helvetica-BoldOblique makeISOEncoded pop 
s
0.000000 0.000000 0.000000 setrgbcolor
1 setlinewidth
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
[] 0 setdash
435 375 m
435 385 l
561 375 m
561 385 l
635 375 m
635 385 l
687 375 m
687 385 l
728 375 m
728 385 l
761 375 m
761 385 l
789 375 m
789 385 l
814 375 m
814 385 l
835 375 m
835 385 l
854 375 m
854 385 l
981 375 m
981 385 l
1055 375 m
1055 385 l
1107 375 m
1107 385 l
1148 375 m
1148 385 l
1181 375 m
1181 385 l
1209 375 m
1209 385 l
1234 375 m
1234 385 l
1255 375 m
1255 385 l
1275 375 m
1275 385 l
1401 375 m
1401 385 l
1475 375 m
1475 385 l
1527 375 m
1527 385 l
1568 375 m
1568 385 l
1601 375 m
1601 385 l
1629 375 m
1629 385 l
1654 375 m
1654 385 l
1675 375 m
1675 385 l
1694 375 m
1694 385 l
1821 375 m
1821 385 l
1895 375 m
1895 385 l
1947 375 m
1947 385 l
1988 375 m
1988 385 l
2021 375 m
2021 385 l
2049 375 m
2049 385 l
2074 375 m
2074 385 l
2095 375 m
2095 385 l
2115 375 m
2115 385 l
435 1775 m
435 1765 l
561 1775 m
561 1765 l
635 1775 m
635 1765 l
687 1775 m
687 1765 l
728 1775 m
728 1765 l
761 1775 m
761 1765 l
789 1775 m
789 1765 l
814 1775 m
814 1765 l
835 1775 m
835 1765 l
854 1775 m
854 1765 l
981 1775 m
981 1765 l
1055 1775 m
1055 1765 l
1107 1775 m
1107 1765 l
1148 1775 m
1148 1765 l
1181 1775 m
1181 1765 l
1209 1775 m
1209 1765 l
1234 1775 m
1234 1765 l
1255 1775 m
1255 1765 l
1275 1775 m
1275 1765 l
1401 1775 m
1401 1765 l
1475 1775 m
1475 1765 l
1527 1775 m
1527 1765 l
1568 1775 m
1568 1765 l
1601 1775 m
1601 1765 l
1629 1775 m
1629 1765 l
1654 1775 m
1654 1765 l
1675 1775 m
1675 1765 l
1694 1775 m
1694 1765 l
1821 1775 m
1821 1765 l
1895 1775 m
1895 1765 l
1947 1775 m
1947 1765 l
1988 1775 m
1988 1765 l
2021 1775 m
2021 1765 l
2049 1775 m
2049 1765 l
2074 1775 m
2074 1765 l
2095 1775 m
2095 1765 l
2115 1775 m
2115 1765 l
s
435 375 m
435 395 l
854 375 m
854 395 l
1275 375 m
1275 395 l
1694 375 m
1694 395 l
2115 375 m
2115 395 l
435 1775 m
435 1755 l
854 1775 m
854 1755 l
1275 1775 m
1275 1755 l
1694 1775 m
1694 1755 l
2115 1775 m
2115 1755 l
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
435 325 m
gsave
435 325 translate
0 rotate
0 -20  m
(1) CS
(1) show
grestore
newpath
854 325 m
gsave
854 325 translate
0 rotate
0 -20  m
(10) CS
(10) show
grestore
newpath
1275 325 m
gsave
1275 325 translate
0 rotate
0 -20  m
(100) CS
(100) show
grestore
newpath
1694 325 m
gsave
1694 325 translate
0 rotate
0 -20  m
(1000) CS
(1000) show
grestore
newpath
2115 325 m
gsave
2115 325 translate
0 rotate
0 -20  m
(10000) CS
(10000) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1275 225 m
gsave
1275 225 translate
0 rotate
0 0  m
(read size \(kbytes\)) CS
(read size \(kbytes\)) show
grestore
newpath
435 375 m
445 375 l
435 550 m
445 550 l
435 725 m
445 725 l
435 900 m
445 900 l
435 1075 m
445 1075 l
435 1250 m
445 1250 l
435 1425 m
445 1425 l
435 1600 m
445 1600 l
435 1775 m
445 1775 l
2115 375 m
2105 375 l
2115 550 m
2105 550 l
2115 725 m
2105 725 l
2115 900 m
2105 900 l
2115 1075 m
2105 1075 l
2115 1250 m
2105 1250 l
2115 1425 m
2105 1425 l
2115 1600 m
2105 1600 l
2115 1775 m
2105 1775 l
s
435 375 m
455 375 l
435 725 m
455 725 l
435 1075 m
455 1075 l
435 1425 m
455 1425 l
435 1775 m
455 1775 l
2115 375 m
2095 375 l
2115 725 m
2095 725 l
2115 1075 m
2095 1075 l
2115 1425 m
2095 1425 l
2115 1775 m
2095 1775 l
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
397 375 m
gsave
397 375 translate
0 rotate
0 -20  m
(0) RJ
(0) show
grestore
newpath
397 725 m
gsave
397 725 translate
0 rotate
0 -20  m
(200) RJ
(200) show
grestore
newpath
397 1075 m
gsave
397 1075 translate
0 rotate
0 -20  m
(400) RJ
(400) show
grestore
newpath
397 1425 m
gsave
397 1425 translate
0 rotate
0 -20  m
(600) RJ
(600) show
grestore
newpath
397 1775 m
gsave
397 1775 translate
0 rotate
0 -20  m
(800) RJ
(800) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
246 1075 m
gsave
246 1075 translate
90 rotate
0 0  m
(bandwidth \(MB/sec\)) CS
(bandwidth \(MB/sec\)) show
grestore
newpath
687 926 m
814 765 l
940 773 l
1067 775 l
1193 756 l
1320 595 l
1446 475 l
1572 467 l
1699 464 l
1825 463 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 687 926 fa
14 814 765 fa
14 940 773 fa
14 1067 775 fa
14 1193 756 fa
14 1320 595 fa
14 1446 475 fa
14 1572 467 fa
14 1699 464 fa
14 1825 463 fa
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
687 714 m
814 875 l
940 1109 l
1067 1313 l
1193 1468 l
1320 1578 l
1446 1637 l
1572 1655 l
1699 1665 l
1825 1578 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
12 687 714 fsq
12 814 875 fsq
12 940 1109 fsq
12 1067 1313 fsq
12 1193 1468 fsq
12 1320 1578 fsq
12 1446 1637 fsq
12 1572 1655 fsq
12 1699 1665 fsq
12 1825 1578 fsq
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
435 375 m
435 1775 l
2115 1775 l
2115 375 l
435 375 l
s
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1694 1425 m
1834 1425 l
s
14 1694 1425 fa
14 1834 1425 fa
1869 1425 m
gsave
1869 1425 translate
0 rotate
0 -20  m
(copy) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
1694 1351 m
1834 1351 l
s
12 1694 1351 fsq
12 1834 1351 fsq
0.000000 0.000000 0.000000 setrgbcolor
1869 1351 m
gsave
1869 1351 translate
0 rotate
0 -20  m
(transfer) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
687 637 m
gsave
687 637 translate
0 rotate
0 -20  m
(4K) CS
(4K) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
end
showpage
%%EndDocument
 @endspecial 349 2634 a(Figure)25 b(10.4:)30 b(Comparison)24
b(of)h(cop)o(y)g(and)g(transfer)g(procedures)g(for)g(reading)f(from)h
(a)g(null)f(sock)o(et)420 3029 y(2.)49 b(A)26 b(b)n(uf)n(fer)g(is)g
(allocated)g(if)g(data)h(cop)o(ying)e(is)h(being)g(used.)34
b(This)26 b(b)n(uf)n(fer)g(will)f(be)i(used)f(with)f(the)544
3178 y Fm(read)k Fs(system)f(call)i(\(its)f(size)g(is)g(called)h(the)g
(\223read)g(size\224\).)45 b(If)31 b(page)e(transfer)h(is)f(being)g
(used,)544 3328 y(then)24 b(the)h(operating)f(system)g(will)g(pro)o
(vide)g(the)g(b)n(uf)n(fer)-5 b(.)420 3560 y(3.)49 b(The)25
b(data)g(is)f(read)h(using)f(null)g(sock)o(et)g(reads)i(in)e(\002x)o
(ed)h(sized)f(chunks.)420 3792 y(4.)49 b(If)23 b(page)g(transfer)g(is)f
(used,)g(the)h(transfered)g(chunk)f(of)g(memory)g(is)g(freed)i(using)d
(the)i Fm(anflush)544 3942 y Fs(system)h(call)g(after)i(the)e(read)i
(operation.)300 4174 y(The)i(test)f(program)g(tak)o(es)g(as)h(input)f
(parameters)g(the)h(amount)f(of)g(data)h(to)f(read,)i(and)e(the)h
(number)f(of)300 4324 y(bytes)d(the)h(program)f(should)g(read)h(in)g
(one)f(system)g(call)h(\(the)g(read)g(size\).)583 4473
y(The)f(test)f(program)h(w)o(as)g(used)f(to)h(transfer)g(1GB)g(of)g
(data)f(\002rst)h(using)f(data)h(cop)o(ying)f(and)g(then)300
4622 y(using)36 b(page)h(transfer)-5 b(.)68 b(The)37
b(read)g(sized)g(w)o(as)g(v)n(aried)g(from)g(4K)g(\(one)g(page\))g(to)g
(2048K,)f(and)h(the)300 4772 y(bandwidth)24 b(w)o(as)g(measured.)31
b(The)25 b(results)f(of)h(the)f(test)h(are)g(sho)n(wn)f(in)g(Figure)h
(10.4.)583 4921 y(When)33 b(cop)o(ying)f(data,)j(smaller)d(reads)h
(produce)g(a)g(greater)g(bandwidth.)54 b(As)32 b(the)h(read)g(size)300
5071 y(increases,)28 b(the)f(null)f(sock)o(et)g(read)i(bandwidth)e
(decreases)i(from)e(315)h(MB/sec)g(to)g(50)f(MB/sec.)38
b(This)300 5220 y(decrease)e(is)e(due)h(to)f(data)h(caching)g(on)f(the)
h(Pentium)f(Pro.)61 b(Memory)34 b(accesses)h(to)f(the)h(cache)g(are)p
eop
%%Page: 216 236
216 235 bop 3751 100 a Fs(216)300 249 y(signi\002cantly)29
b(f)o(aster)i(than)f(memory)g(accesses)g(to)g(main)g(memory)-6
b(.)46 b(If)31 b(an)g(application')-5 b(s)28 b(b)n(uf)n(fer)j(en-)300
398 y(tirely)26 b(\002ts)h(within)e(a)j(cache)f(then)g(memory)f
(references)i(to)e(it)g(will)g(be)h(f)o(aster)g(than)g(the)g(bandwidth)
e(of)300 548 y(main)31 b(memory)-6 b(.)50 b(F)o(or)31
b(e)o(xample,)i(when)e(the)h(test)f(program)g(uses)g(4K)h(b)n(uf)n
(fers)f(both)g(the)g(source)h(and)300 697 y(destination)d(b)n(uf)n
(fers)h(of)h(the)g(data)f(cop)o(y)h(\002t)g(within)e(the)i(le)n(v)o
(el-one)e(cache)j(producing)d(a)i(bandwidth)300 847 y(of)h(315)f
(MB/sec.)51 b(When)32 b(the)f(size)h(of)f(the)h(test)f(program')-5
b(s)30 b(b)n(uf)n(fers)i(are)g(increased)g(to)f(8K)h(the)o(y)e(no)300
996 y(longer)23 b(\002t)g(within)e(the)i(le)n(v)o(el-one)f(cache,)i(b)n
(ut)e(the)o(y)g(do)h(\002t)g(within)f(the)g(le)n(v)o(el-tw)o(o)g
(cache.)31 b(This)22 b(results)300 1145 y(in)j(a)g(bandwidth)f(drop)h
(to)g(225)f(MB/sec.)32 b(The)25 b(bandwidth)f(remains)h(nearly)g
(constant)f(for)i(read)f(sizes)300 1295 y(from)33 b(8K)f(to)g(64K.)h
(Ho)n(we)n(v)o(er)l(,)g(between)g(128K)f(and)h(256K)f(the)h(bandwidth)e
(drops)h(to)h(50)f(MB/sec)300 1444 y(as)d(the)f(size)h(of)g(the)g(data)
f(b)n(uf)n(fers)h(becomes)f(lar)n(ger)i(than)e(the)h(le)n(v)o(el-tw)o
(o)e(cache.)43 b(Finally)-6 b(,)29 b(the)f(band-)300
1594 y(width)20 b(e)n(v)o(entually)g(le)n(v)o(els)f(out)i(at)g(50)g
(MB/sec)g(\(the)g(same)g(v)n(alue)g(we)g(got)g(from)g
Fm(lmbench)p Fs(')-5 b(s)19 b(memory)300 1743 y(cop)o(y)26
b(benchmark\).)33 b(The)26 b(4K)f(read)i(size)f(gets)f(the)h(full)f
(bene\002t)h(of)g(the)f(high)g(bandwidth)g(of)h(the)f(Pen-)300
1892 y(tium)k(Pro')-5 b(s)31 b(le)n(v)o(el-one)f(cache)h(since)g(it)f
(w)o(as)h(the)f(only)g(process)h(running)e(on)i(the)f(system)g(when)g
(the)300 2042 y(measurements)24 b(were)h(tak)o(en)g(\(so)g(its)f(data)h
(w)o(as)f(al)o(w)o(ays)h(fresh)g(in)f(the)h(cache\).)583
2191 y(On)36 b(the)f(other)g(hand,)i(the)e(cache)h(does)f(not)g(play)g
(as)g(great)g(a)h(role)f(in)g(page)g(transfer)-5 b(.)62
b(The)300 2341 y(bandwidth)37 b(starts)g(around)h(190)f(MB/sec)h(for)h
(page)f(sized)g(transfers,)j(and)d(then)g(increases)g(up)f(to)300
2490 y(730)d(MB/sec)g(for)g(a)g(1MB)g(page)h(transfer)-5
b(.)58 b(The)34 b(\002nal)g(dip)g(in)f(the)h(page)h(transfer)f(curv)o
(e)g(is)f(due)h(to)300 2639 y(the)26 b(cache.)34 b(As)26
b(the)g(transfer)g(size)g(gets)f(lar)n(ger)l(,)i(the)f(page)g(transfer)
g(code)g(touches)f(more)h(k)o(ernel)g(data)300 2789 y(structures,)k
(and)g(at)g(some)f(point)g(this)g(causes)h(touched)f(data)h(structures)
f(to)h(e)o(xceed)g(the)g(size)f(of)h(the)300 2938 y(le)n(v)o(el)24
b(one)g(cache.)583 3088 y(Note)37 b(that)f(the)h(high)f(bandwidth)g
(achie)n(v)o(ed)g(by)g(page)h(transfer)g(is)g(through)f(virtual)g(mem-)
300 3237 y(ory)c(based)g(operations)f(rather)h(than)g(through)f(data)h
(cop)o(ying.)51 b(Such)33 b(high)e(bandwidths)f(cannot)i(be)300
3386 y(achie)n(v)o(ed)26 b(if)i(each)f(byte)g(of)h(the)f(data)g(is)g
(read)g(or)h(copied.)37 b(Not)27 b(all)g(applications)f(require)h(the)g
(data)g(to)300 3536 y(be)h(accessed.)40 b(F)o(or)27 b(e)o(xample,)h
(the)f(multimedia)f(video)h(recorder)h(used)g(in)f(our)h(video)f(serv)o
(er)g(project)300 3685 y(recei)n(v)o(es)i(data)h(from)f(an)h(A)-11
b(TM)29 b(netw)o(ork)h(and)f(immediately)f(writes)i(it)f(to)g(disk)g
(without)f(reading)i(or)300 3835 y(touching)24 b(the)g(data)h([12].)300
4218 y Fg(10.3)143 b(Using)34 b(UVM)i(to)f(T)-11 b(ransfer)34
b(Data)h(Between)f(Pr)m(ocesses)300 4471 y Fs(In)20 b(the)f(pre)n
(vious)f(tw)o(o)h(sections)g(we)h(discussed)e(the)h(ef)n(fect)h(of)g
(page)g(loanout)e(and)h(page)h(transfer)g(on)f(the)300
4620 y(mo)o(v)o(ement)24 b(of)j(data)g(between)g(a)g(process)g(and)f(a)
h(netw)o(ork)g(interf)o(ace.)37 b(In)27 b(this)e(section,)i(we)g(e)o
(xamine)300 4769 y(using)d(UVM)g(to)h(mo)o(v)o(e)e(data)i(between)g(tw)
o(o)f(processes)h(using)e(a)j(pipe.)583 4919 y(In)g(a)g(traditional)e
(system,)g(a)i(pipe)f(is)g(implemented)f(as)i(a)f(pair)h(of)f
(connected)h(sock)o(ets.)32 b(Thus,)300 5068 y(when)f(data)h(is)f
(written)g(to)g(a)h(pipe)f(the)g(k)o(ernel)h(uses)f(the)h
Fm(sosend)e Fs(function)g(to)i(transmit)e(the)h(data.)300
5218 y(The)k Fm(sosend)f Fs(function)g(copies)h(the)g(data)g(being)g
(written)f(into)g(an)i(mb)n(uf)e(chain)h(and)g(places)h(that)300
5367 y(chain)29 b(on)g(the)g(recei)n(v)o(e)g(sock)o(et)g(b)n(uf)n(fer)h
(of)f(the)g(sock)o(et)g(associated)g(with)f(the)i(other)f(end)g(of)g
(the)h(pipe.)p eop
%%Page: 217 237
217 236 bop 3751 100 a Fs(217)300 249 y(When)27 b(the)f(data)g(is)h
(read)g(from)f(the)g(pipe)g(with)g(the)g Fm(read)g Fs(system)g(call)g
(the)g Fm(soreceive)f Fs(function)300 398 y(remo)o(v)o(es)k(the)h(mb)n
(uf)g(chain)g(from)g(the)g(recei)n(v)o(e)g(sock)o(et)g(b)n(uf)n(fer)l
(,)h(copies)f(the)g(data)g(from)g(the)g(chain)g(to)300
548 y(the)g(recei)n(v)o(er')-5 b(s)30 b(memory)-6 b(,)30
b(and)h(then)f(frees)h(the)f(mb)n(uf)g(chain.)48 b(Thus,)31
b(each)g(byte)f(of)g(data)h(written)e(to)300 697 y(the)f(pipe)f(is)h
(copied)f(twice.)40 b(UVM')-5 b(s)27 b(page)h(loanout)f(and)h(page)g
(transfer)g(mechanisms)f(can)h(be)g(used)300 847 y(to)c(reduce)i(k)o
(ernel)f(o)o(v)o(erhead)f(by)g(eliminating)f(both)h(these)h(copies.)300
1178 y Ff(10.3.1)118 b(Sock)o(et)31 b(Lay)o(er)e(Modi\002cations)300
1394 y Fs(The)f(k)o(ernel')-5 b(s)27 b(sock)o(et)h(layer)g(must)f(be)h
(further)g(modi\002ed)f(in)h(order)g(to)f(use)h(UVM)g(to)f(eliminate)g
(data)300 1544 y(copies)22 b(when)g(using)f(pipes.)30
b(While)22 b(the)g(page)g(loanout)g(modi\002cations)f(described)h(in)g
(Section)g(10.1.1)300 1693 y(are)f(suf)n(\002cient)e(for)h(use)f(with)h
(a)g(pipe,)g(the)g(page)g(transfer)g(modi\002cations)e(described)i(in)f
(Section)h(10.2.1)300 1843 y(for)25 b(the)g(null)f(sock)o(et)g(read)h
(operation)g(are)g(not.)583 1992 y(In)f(order)f(to)g(support)f(page)i
(transfer)f(for)h(pipes,)f(the)g Fm(xread)f Fs(system)g(call)h(w)o(as)g
(further)h(mod-)300 2141 y(i\002ed)31 b(to)f(support)f(a)i(ne)n(w)f
(read)g(operation)g(function)g(that)g(w)o(as)g(added)g(to)g(the)h
Fm(fileops)e Fs(structure.)300 2291 y(When)20 b(page)h(transfer)g(is)f
(used,)h(the)f(virtual)g(address)g(to)g(which)g(the)g(data)h(pages)f
(ha)n(v)o(e)g(been)h(transfered)300 2440 y(must)30 b(be)i(returned)f
(to)g(the)h(process)f(performing)g(the)g Fm(xread)f Fs(system)h(call.)
50 b(The)32 b(interf)o(ace)g(of)f(the)300 2590 y(traditional)26
b(read)i(operation)f(function)g(has)g(no)h(w)o(ay)f(to)g(return)h(this)
f(address,)h(b)n(ut)f(the)g(ne)n(w)g(read)h(op-)300 2739
y(eration)f(does.)36 b(W)-8 b(e)27 b(decided)g(that)f(for)h(testing)f
(adding)g(a)h(second)g(read)g(operation)f(to)h(the)g
Fm(fileops)300 2888 y Fs(structure)c(w)o(ould)f(be)h(less)f(disrupti)n
(v)o(e)e(to)j(the)g(system)e(than)i(modifying)e(the)i(original)e(read)j
(operation.)583 3038 y(The)35 b Fm(xread)f Fs(system)g(call)h(uses)g
(the)g(ne)n(w)f(read)i(operation)e(function)g(only)h(if)g(the)f(\002le)
i(de-)300 3187 y(scriptor)29 b(being)g(read)h(supports)e(it)h(and)h(if)
f(page)h(transfer)g(w)o(as)f(requested.)45 b(The)30 b(ne)n(w)f(read)h
(function)300 3337 y(for)25 b(sock)o(ets)f(is)h Fm(soo)p
1036 3337 30 4 v 35 w(read2)p Fs(.)k(This)c(function)e(operates)i(as)g
(follo)n(ws:)420 3569 y(1.)49 b(The)28 b(parameters)h(are)g(check)o(ed)
g(to)f(see)h(if)f(the)o(y)g(are)h(f)o(a)n(v)n(orable)g(to)f(page)g
(transfer)-5 b(.)42 b(If)29 b(the)o(y)e(are)544 3718
y(not,)d(then)g Fm(soo)p 1103 3718 V 36 w(read2)f Fs(uses)i(the)g
(traditional)e Fm(soo)p 2420 3718 V 35 w(read)h Fs(function)g(to)h(mo)o
(v)o(e)e(the)i(data.)420 3951 y(2.)49 b(If)20 b(there)g(is)g(no)g(data)
g(to)f(recei)n(v)o(e,)i(then)e(the)h Fm(soo)p 2188 3951
V 35 w(read2)f Fs(function)g(causes)h(the)g(calling)f(process)544
4100 y(to)27 b(sleep)g(until)g(data)g(arri)n(v)o(es)g(\(unless)g(the)g
(sock)o(et)g(is)g(in)g(non-blocking)f(mode,)h(in)g(which)h(case)544
4250 y(an)d(error)g(is)g(returned\).)420 4482 y(3.)49
b(Once)31 b Fm(soo)p 971 4482 V 35 w(read2)f Fs(has)g(data,)i(the)f(mb)
n(uf)f(chain)h(the)f(data)h(resides)f(in)g(is)h(check)o(ed)g(to)f(see)h
(if)544 4631 y(its)h(data)h(can)g(be)g(transferred)h(using)e(page)h
(transfer)-5 b(.)55 b(In)33 b(order)g(to)g(do)f(this,)i(the)f(mb)n(uf)f
(chain)544 4781 y(must)24 b(consist)g(of)i(either)f(cluster)g(mb)n(ufs)
g(or)g(of)h(e)o(xternal)f(mb)n(ufs)f(whose)h(data)h(areas)g(are)g
(pages)544 4930 y(loaned)31 b(out)g(from)g(some)g(other)h(process.)51
b(If)32 b(the)f(mb)n(uf)g(chain)h(is)f(not)g(a)h(candidate)f(for)h
(page)544 5080 y(transfer)l(,)25 b(then)f Fm(soo)p 1276
5080 V 36 w(read2)f Fs(uses)i(a)g(traditional)e(data)i(cop)o(y)g(to)f
(deli)n(v)o(er)g(the)h(data.)p eop
%%Page: 218 238
218 237 bop 3751 100 a Fs(218)420 249 y(4.)49 b(F)o(or)27
b(mb)n(uf)f(chains)h(that)f(can)h(be)g(used)g(with)f(page)h(transfer)l
(,)h(the)e Fm(soo)p 3003 249 30 4 v 36 w(read2)f Fs(function)h(calls)
544 398 y(the)j Fm(so)p 821 398 V 36 w(transfer)f Fs(function)g(to)h
(transfer)h(the)g(data)f(to)h(the)f(user)h(process.)45
b(It)29 b(then)g(returns)544 548 y(the)c(address)f(to)h(which)f(the)h
(pages)f(were)i(transfered)f(to)g(the)f Fm(xread)g Fs(function.)583
780 y(The)d Fm(so)p 885 780 V 36 w(transfer)e Fs(function)h(handles)g
(the)g(page)h(transfer)g(of)g(an)g(mb)n(uf)f(chain.)29
b(It)21 b(operates)300 930 y(as)k(follo)n(ws:)420 1162
y(1.)49 b(Space)26 b(in)e(the)h(recei)n(ving)f(process')h(page)g
(transfer)g(area)h(is)e(reserv)o(ed)h(for)g(the)g(data.)420
1394 y(2.)49 b(The)26 b(mb)n(uf)f(chain)h(is)f(then)g(tra)n(v)o(ersed.)
34 b(Each)26 b(mb)n(uf)5 b(')-5 b(s)25 b(data)h(area)h(is)e(loaded)h
(into)f(an)h(anon.)33 b(F)o(or)544 1544 y(cluster)25
b(mb)n(ufs,)f Fm(so)p 1258 1544 V 35 w(mcl)p 1473 1544
V 35 w(steal)h Fs(is)f(used)h(\(see)h(Section)f(10.2.1\).)30
b(F)o(or)25 b(e)o(xternal)g(mb)n(ufs,)f(the)544 1693
y Fm(so)p 670 1693 V 35 w(mextloan)p 1185 1693 V 34 w(reloan)g
Fs(function)g(is)g(used)h(\(see)g(belo)n(w\).)420 1926
y(3.)49 b(Finally)-6 b(,)24 b(the)g(anons)h(are)g(inserted)f(into)g
(the)h(recei)n(ving)f(process')h(address)g(space.)583
2158 y(The)38 b(reloan)g(function)f(is)h(used)f(for)h(e)o(xternal)g(mb)
n(ufs)f(whose)g(data)h(area)h(is)e(on)h(loan)f(from)300
2308 y(a)f(process')f(address)g(space)h(due)f(to)g(page)g(loanout)f
(caused)i(by)f(the)g Fm(xwrite)f Fs(system)g(call.)62
b(This)300 2457 y(function)31 b(looks)g(up)h(the)g(page)h(associated)e
(with)h(the)g(mb)n(uf.)52 b(If)32 b(the)g(page)h(is)e(attached)h(to)g
(an)g(anon,)300 2606 y(then)24 b(the)f(anon')-5 b(s)24
b(reference)h(count)f(is)f(incremented.)30 b(Otherwise,)24
b(a)g(ne)n(w)f(anon)h(is)g(allocated)f(and)h(the)300
2756 y(page)h(is)f(attached)h(to)g(it.)30 b(The)25 b(reloan)g(function)
e(returns)i(the)g(anon.)583 2905 y(These)g(changes)g(allo)n(w)f(a)h
(process)g(to)f(recei)n(v)o(e)h(data)g(from)f(a)h(pipe)g(using)e(page)i
(transfer)-5 b(.)300 3236 y Ff(10.3.2)118 b(Pr)n(ocess)29
b(Data)h(T)-9 b(ransfer)29 b(Measur)n(ements)300 3453
y Fs(T)-8 b(o)20 b(measure)h(the)f(ef)n(fect)h(of)g(both)e(page)i
(loanout)f(and)g(page)h(transfer)f(on)h(the)f(transfer)h(of)f(data)h
(between)300 3602 y(tw)o(o)j(processes)h(o)o(v)o(er)f(a)h(pipe,)f(we)i
(wrote)e(a)h(test)g(program)f(that)h(operates)f(as)h(follo)n(ws:)420
3835 y(1.)49 b(The)25 b(parameters)g(are)g(parsed)g(and)g(a)g(pipe)g
(is)f(created.)420 4067 y(2.)49 b(A)25 b(child)f(process)h(is)f(fork)o
(ed)h(of)n(f.)420 4300 y(3.)49 b(The)24 b(child)f(process)h(writes)g(a)
g(speci\002ed)g(amount)f(of)h(data)g(into)f(the)h(pipe,)g(using)f(page)
h(loanout)544 4449 y(if)h(requested.)30 b(Once)25 b(the)g(data)g(is)f
(written)g(the)h(child)f(process)h(closes)f(the)h(pipe)f(and)h(e)o
(xits.)420 4681 y(4.)49 b(The)25 b(parent)h(process)f(reads)g(data)h
(out)e(of)i(the)f(pipe,)g(using)f(page)i(transfer)f(if)h(requested.)32
b(After)544 4831 y(a)27 b(read)g(operation,)f(the)g(data)h(is)f
(released)h(using)e(the)h Fm(anflush)f Fs(system)h(call.)35
b(Once)27 b(all)f(data)544 4980 y(is)e(read,)h(the)g(parent)g(process)g
(e)o(xits.)300 5213 y(The)k(test)f(program)g(tak)o(es)h(as)g
(parameters)g(the)f(amount)g(of)h(data)f(to)h(transfer)g(o)o(v)o(er)f
(the)g(pipe)h(and)f(the)300 5362 y(read)d(and)g(write)g(sizes.)p
eop
%%Page: 219 239
219 238 bop 3751 100 a Fs(219)685 2430 y @beginspecial
43 @llx 43 @lly 528 @urx 434 @ury 3395 @rwi @setspecial
%%BeginDocument: ../plots/plot3/Plot3.eps
80 dict begin
/languagelevel where
{pop /gs_languagelevel languagelevel def}
{/gs_languagelevel 1 def} ifelse
gs_languagelevel 1 gt {
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<0000000000000000000000000000000000000000000000000000000000000000>} image end }
			>> 	matrix makepattern /Pat0 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111000044440000111100004444000011110000444400001111000044440000>} image end }
			>> 	matrix makepattern /Pat1 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111444411114444111144441111444411114444111144441111444411114444>} image end }
			>> 	matrix makepattern /Pat2 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555>} image end }
			>> 	matrix makepattern /Pat3 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbb>} image end }
			>> 	matrix makepattern /Pat4 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffff>} image end }
			>> 	matrix makepattern /Pat5 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<f77dffffbeeffffff77dffffbeeffffff77dffffbeeffffff77dffffbeefffff>} image end }
			>> 	matrix makepattern /Pat6 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff>} image end }
			>> 	matrix makepattern /Pat7 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<e1e1f0f078783c3c1e1e0f0f8787c3c3e1e1f0f078783c3c1e1e0f0f8787c3c3>} image end }
			>> 	matrix makepattern /Pat8 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<87870f0f1e1e3c3c7878f0f0e1e1c3c387870f0f1e1e3c3c7878f0f0e1e1c3c3>} image end }
			>> 	matrix makepattern /Pat9 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc>} image end }
			>> 	matrix makepattern /Pat10 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffff>} image end }
			>> 	matrix makepattern /Pat11 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e>} image end }
			>> 	matrix makepattern /Pat12 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebf>} image end }
			>> 	matrix makepattern /Pat13 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7e>} image end }
			>> 	matrix makepattern /Pat14 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fffffbdff3dfebdfdbdfbbdf7bdffbdefbddfbdbfbd7fbcffbdfffffffffffff>} image end }
			>> 	matrix makepattern /Pat15 exch def 
}{
/Pat0 { 0.000000 setgray } def
/Pat1 { 0.062500 setgray } def
/Pat2 { 0.125000 setgray } def
/Pat3 { 0.187500 setgray } def
/Pat4 { 0.250000 setgray } def
/Pat5 { 0.312500 setgray } def
/Pat6 { 0.375000 setgray } def
/Pat7 { 0.437500 setgray } def
/Pat8 { 0.500000 setgray } def
/Pat9 { 0.562500 setgray } def
/Pat10 { 0.625000 setgray } def
/Pat11 { 0.687500 setgray } def
/Pat12 { 0.750000 setgray } def
/Pat13 { 0.812500 setgray } def
/Pat14 { 0.875000 setgray } def
/Pat15 { 0.937500 setgray } def
/setpattern { } def
} ifelse
/m {moveto} bind def
/l {lineto} bind def
/s {stroke} bind def
% Symbol fill
/f { gsave fill grestore stroke } bind def
% Opaque symbol
/o { gsave 1.000000 1.000000 1.000000 setrgbcolor
     fill grestore stroke } bind def
% Circle symbol
/a { 3 -1 roll 0 360 arc } bind def
/da { a s } bind def
/fa { a f } bind def
/oa { a o } bind def
% Square symbol
/sq { moveto dup dup rmoveto 2 mul
      dup neg 0 rlineto dup neg 0 exch rlineto
      0 rlineto closepath } bind def
/dsq { sq s } bind def
/fsq { sq f } bind def
/osq { sq o } bind def
% Triangle symbols
/t1 { moveto dup 0 exch rmoveto
      dup neg dup 2 mul rlineto 2 mul 0 rlineto
      closepath } bind def
/dt1 { t1 s } bind def
/ft1 { t1 f } bind def
/ot1 { t1 o } bind def
/t2 { moveto dup neg 0 rmoveto
      dup dup 2 mul exch neg rlineto
      2 mul 0 exch rlineto closepath } bind def
/dt2 { t2 s } bind def
/ft2 { t2 f } bind def
/ot2 { t2 o } bind def
/t3 { moveto dup neg 0 exch rmoveto
      dup dup 2 mul rlineto neg 2 mul 0 rlineto
      closepath } bind def
/dt3 { t3 s } bind def
/ft3 { t3 f } bind def
/ot3 { t3 o } bind def
/t4 { moveto dup 0 rmoveto
      dup dup -2 mul exch rlineto
      -2 mul 0 exch rlineto closepath } bind def
/dt4 { t4 s } bind def
/ft4 { t4 f } bind def
/ot4 { t4 o } bind def
% Diamond symbol
/di { moveto dup 0 exch rmoveto
      dup neg dup rlineto dup dup neg rlineto
      dup dup rlineto closepath } bind def
/ddi { di s } bind def
/fdi { di f } bind def
/odi { di o } bind def
% Plus symbol
/pl { dup 0 rmoveto dup -2 mul 0 rlineto
      dup dup rmoveto -2 mul 0 exch rlineto
    } bind def
/dpl { m pl s } bind def
% x symbol
/x { dup dup rmoveto dup -2 mul dup rlineto
     2 mul dup 0 rmoveto dup neg exch rlineto
   } bind def
/dx { m x s } bind def
% Splat symbol
/dsp { m dup pl dup 0 exch rmoveto 0.707 mul x s
     } bind def
/RJ {
 stringwidth neg exch neg exch
 rmoveto
} bind def
/CS {
 stringwidth
 2 div neg exch 2 div neg exch
 rmoveto
} bind def
0.24 0.24 scale
1 setlinecap

	mark             
	/ISOLatin1Encoding 
	  8#000 1 8#054 {StandardEncoding exch get} for 
	  /minus 
	  8#056 1 8#217 {StandardEncoding exch get} for 
	  /dotlessi 
	  8#301 1 8#317 {StandardEncoding exch get} for 
	  /space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
	  /dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen 
	  /registered /macron /degree /plusminus /twosuperior /threesuperior /acute 
	  /mu /paragraph /periodcentered /cedilla /onesuperior /ordmasculine 
	  /guillemotright /onequarter /onehalf /threequarters /questiondown /Agrave 
	  /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute
	  /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde
	  /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave 
	  /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls /agrave /aacute 
	  /acircumflex /atilde /adieresis /aring /ae /ccedilla /egrave /eacute 
	  /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde
	  /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave 
	  /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
	  /ISOLatin1Encoding where not {256 array astore def} if 
	 cleartomark 

	/makeISOEncoded 
	{ findfont /curfont exch def 
	  /newfont curfont maxlength dict def  
	  /ISOLatin1 (-ISOLatin1) def
	  /curfontname curfont /FontName get dup length string cvs def 
	  /newfontname curfontname length ISOLatin1 length add string 
    	 dup 0                  curfontname putinterval 
    	 dup curfontname length ISOLatin1   putinterval 
	  def 
	  curfont   
	  { exch dup /FID ne  
    	{ dup /Encoding eq  
    	  { exch pop ISOLatin1Encoding exch }  
    	  if  
    	  dup /FontName eq  
    	  { exch pop newfontname exch }  
    	  if  
    	  exch newfont 3 1 roll put  
    	}  
    	{ pop pop }  
    	ifelse  
	  }  
	  forall 
	  newfontname newfont definefont 
	} def 

	/Times-Roman makeISOEncoded pop 
	/Times-Bold makeISOEncoded pop 
	/Times-Italic makeISOEncoded pop 
	/Times-BoldItalic makeISOEncoded pop 
	/Helvetica makeISOEncoded pop 
	/Helvetica-Bold makeISOEncoded pop 
	/Helvetica-Oblique makeISOEncoded pop 
	/Helvetica-BoldOblique makeISOEncoded pop 
s
0.000000 0.000000 0.000000 setrgbcolor
1 setlinewidth
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
[] 0 setdash
435 375 m
435 385 l
561 375 m
561 385 l
635 375 m
635 385 l
687 375 m
687 385 l
728 375 m
728 385 l
761 375 m
761 385 l
789 375 m
789 385 l
814 375 m
814 385 l
835 375 m
835 385 l
854 375 m
854 385 l
981 375 m
981 385 l
1055 375 m
1055 385 l
1107 375 m
1107 385 l
1148 375 m
1148 385 l
1181 375 m
1181 385 l
1209 375 m
1209 385 l
1234 375 m
1234 385 l
1255 375 m
1255 385 l
1275 375 m
1275 385 l
1401 375 m
1401 385 l
1475 375 m
1475 385 l
1527 375 m
1527 385 l
1568 375 m
1568 385 l
1601 375 m
1601 385 l
1629 375 m
1629 385 l
1654 375 m
1654 385 l
1675 375 m
1675 385 l
1694 375 m
1694 385 l
1821 375 m
1821 385 l
1895 375 m
1895 385 l
1947 375 m
1947 385 l
1988 375 m
1988 385 l
2021 375 m
2021 385 l
2049 375 m
2049 385 l
2074 375 m
2074 385 l
2095 375 m
2095 385 l
2115 375 m
2115 385 l
435 1775 m
435 1765 l
561 1775 m
561 1765 l
635 1775 m
635 1765 l
687 1775 m
687 1765 l
728 1775 m
728 1765 l
761 1775 m
761 1765 l
789 1775 m
789 1765 l
814 1775 m
814 1765 l
835 1775 m
835 1765 l
854 1775 m
854 1765 l
981 1775 m
981 1765 l
1055 1775 m
1055 1765 l
1107 1775 m
1107 1765 l
1148 1775 m
1148 1765 l
1181 1775 m
1181 1765 l
1209 1775 m
1209 1765 l
1234 1775 m
1234 1765 l
1255 1775 m
1255 1765 l
1275 1775 m
1275 1765 l
1401 1775 m
1401 1765 l
1475 1775 m
1475 1765 l
1527 1775 m
1527 1765 l
1568 1775 m
1568 1765 l
1601 1775 m
1601 1765 l
1629 1775 m
1629 1765 l
1654 1775 m
1654 1765 l
1675 1775 m
1675 1765 l
1694 1775 m
1694 1765 l
1821 1775 m
1821 1765 l
1895 1775 m
1895 1765 l
1947 1775 m
1947 1765 l
1988 1775 m
1988 1765 l
2021 1775 m
2021 1765 l
2049 1775 m
2049 1765 l
2074 1775 m
2074 1765 l
2095 1775 m
2095 1765 l
2115 1775 m
2115 1765 l
s
435 375 m
435 395 l
854 375 m
854 395 l
1275 375 m
1275 395 l
1694 375 m
1694 395 l
2115 375 m
2115 395 l
435 1775 m
435 1755 l
854 1775 m
854 1755 l
1275 1775 m
1275 1755 l
1694 1775 m
1694 1755 l
2115 1775 m
2115 1755 l
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
435 325 m
gsave
435 325 translate
0 rotate
0 -20  m
(1) CS
(1) show
grestore
newpath
854 325 m
gsave
854 325 translate
0 rotate
0 -20  m
(10) CS
(10) show
grestore
newpath
1275 325 m
gsave
1275 325 translate
0 rotate
0 -20  m
(100) CS
(100) show
grestore
newpath
1694 325 m
gsave
1694 325 translate
0 rotate
0 -20  m
(1000) CS
(1000) show
grestore
newpath
2115 325 m
gsave
2115 325 translate
0 rotate
0 -20  m
(10000) CS
(10000) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1275 225 m
gsave
1275 225 translate
0 rotate
0 0  m
(transfer size \(kbytes\)) CS
(transfer size \(kbytes\)) show
grestore
newpath
435 375 m
445 375 l
435 515 m
445 515 l
435 655 m
445 655 l
435 795 m
445 795 l
435 935 m
445 935 l
435 1075 m
445 1075 l
435 1215 m
445 1215 l
435 1355 m
445 1355 l
435 1495 m
445 1495 l
435 1635 m
445 1635 l
435 1775 m
445 1775 l
2115 375 m
2105 375 l
2115 515 m
2105 515 l
2115 655 m
2105 655 l
2115 795 m
2105 795 l
2115 935 m
2105 935 l
2115 1075 m
2105 1075 l
2115 1215 m
2105 1215 l
2115 1355 m
2105 1355 l
2115 1495 m
2105 1495 l
2115 1635 m
2105 1635 l
2115 1775 m
2105 1775 l
s
435 375 m
455 375 l
435 655 m
455 655 l
435 935 m
455 935 l
435 1215 m
455 1215 l
435 1495 m
455 1495 l
435 1775 m
455 1775 l
2115 375 m
2095 375 l
2115 655 m
2095 655 l
2115 935 m
2095 935 l
2115 1215 m
2095 1215 l
2115 1495 m
2095 1495 l
2115 1775 m
2095 1775 l
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
397 375 m
gsave
397 375 translate
0 rotate
0 -20  m
(0) RJ
(0) show
grestore
newpath
397 655 m
gsave
397 655 translate
0 rotate
0 -20  m
(100) RJ
(100) show
grestore
newpath
397 935 m
gsave
397 935 translate
0 rotate
0 -20  m
(200) RJ
(200) show
grestore
newpath
397 1215 m
gsave
397 1215 translate
0 rotate
0 -20  m
(300) RJ
(300) show
grestore
newpath
397 1495 m
gsave
397 1495 translate
0 rotate
0 -20  m
(400) RJ
(400) show
grestore
newpath
397 1775 m
gsave
397 1775 translate
0 rotate
0 -20  m
(500) RJ
(500) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
246 1075 m
gsave
246 1075 translate
90 rotate
0 0  m
(bandwidth \(MB/sec\)) CS
(bandwidth \(MB/sec\)) show
grestore
newpath
687 486 m
814 508 l
940 523 l
1067 515 l
1193 480 l
1320 452 l
1446 447 l
1572 446 l
1699 447 l
1825 446 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 687 486 fa
14 814 508 fa
14 940 523 fa
14 1067 515 fa
14 1193 480 fa
14 1320 452 fa
14 1446 447 fa
14 1572 446 fa
14 1699 447 fa
14 1825 446 fa
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
687 466 m
814 495 l
940 518 l
1067 535 l
1193 539 l
1320 508 l
1446 495 l
1572 494 l
1699 494 l
1825 494 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
12 687 466 fsq
12 814 495 fsq
12 940 518 fsq
12 1067 535 fsq
12 1193 539 fsq
12 1320 508 fsq
12 1446 495 fsq
12 1572 494 fsq
12 1699 494 fsq
12 1825 494 fsq
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
0.000000 1.000000 0.000000 setrgbcolor
687 500 m
814 559 l
940 624 l
1067 678 l
1193 680 l
1320 539 l
1446 496 l
1572 494 l
1699 494 l
1825 494 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 687 500 fdi
14 814 559 fdi
14 940 624 fdi
14 1067 678 fdi
14 1193 680 fdi
14 1320 539 fdi
14 1446 496 fdi
14 1572 494 fdi
14 1699 494 fdi
14 1825 494 fdi
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
0.000000 0.000000 1.000000 setrgbcolor
687 569 m
814 739 l
940 912 l
1067 1069 l
1193 1354 l
1320 1500 l
1446 1518 l
1572 1508 l
1699 1508 l
1825 1491 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 687 569 ft1
14 814 739 ft1
14 940 912 ft1
14 1067 1069 ft1
14 1193 1354 ft1
14 1320 1500 ft1
14 1446 1518 ft1
14 1572 1508 ft1
14 1699 1508 ft1
14 1825 1491 ft1
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
435 375 m
435 1775 l
2115 1775 l
2115 375 l
435 375 l
s
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1654 1215 m
1794 1215 l
s
14 1654 1215 fa
14 1794 1215 fa
1829 1215 m
gsave
1829 1215 translate
0 rotate
0 -20  m
(copy) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
1654 1141 m
1794 1141 l
s
12 1654 1141 fsq
12 1794 1141 fsq
0.000000 0.000000 0.000000 setrgbcolor
1829 1141 m
gsave
1829 1141 translate
0 rotate
0 -20  m
(transfer) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 1.000000 0.000000 setrgbcolor
1654 1067 m
1794 1067 l
s
14 1654 1067 fdi
14 1794 1067 fdi
0.000000 0.000000 0.000000 setrgbcolor
1829 1067 m
gsave
1829 1067 translate
0 rotate
0 -20  m
(loan) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 1.000000 setrgbcolor
1654 993 m
1794 993 l
s
14 1654 993 ft1
14 1794 993 ft1
0.000000 0.000000 0.000000 setrgbcolor
1829 993 m
gsave
1829 993 translate
0 rotate
0 -20  m
(both) show
grestore
newpath
end
showpage
%%EndDocument
 @endspecial 300 2634 a(Figure)24 b(10.5:)29 b(Comparison)23
b(of)h(cop)o(y)-6 b(,)24 b(transfer)l(,)g(loan,)f(and)h(both)f
(procedures)h(for)g(mo)o(ving)e(data)i(o)o(v)o(er)300
2754 y(a)h(pipe)583 3130 y(W)-8 b(e)38 b(used)e(the)h(test)g(program)f
(to)h(produce)g(four)g(sets)f(of)h(data.)68 b(F)o(or)36
b(each)i(set)f(of)g(data)g(we)300 3279 y(transfered)29
b(1GB)f(of)g(data)g(v)n(arying)f(the)h(read)h(and)f(write)g(sizes)g
(from)g(4K)g(to)f(2048K.)h(The)g(four)g(data)300 3429
y(sets)c(are:)300 3632 y Fo(copy:)49 b Fs(Data)25 b(w)o(as)g(copied)g
(on)f(both)g(the)h(sending)f(and)g(recei)n(ving)g(ends)h(of)g(the)g
(pipe.)300 3855 y Fo(transfer:)50 b Fs(Data)33 b(w)o(as)g(copied)g(on)f
(the)h(sending)f(side)g(and)h(mo)o(v)o(ed)f(with)g(page)h(transfer)g
(on)g(the)f(re-)544 4004 y(cei)n(ving)24 b(side)g(of)h(the)g(pipe.)300
4227 y Fo(loan:)49 b Fs(Data)21 b(w)o(as)h(loaned)g(out)f(on)g(the)g
(sending)g(side)g(and)h(copied)f(on)h(the)f(recei)n(ving)g(side)g(of)h
(the)g(pipe.)300 4450 y Fo(both:)50 b Fs(Data)32 b(w)o(as)g(loaned)g
(out)g(on)g(the)g(sending)f(side)h(and)g(mo)o(v)o(ed)e(with)i(page)g
(transfer)h(on)e(the)h(re-)544 4599 y(cei)n(ving)24 b(side)g(of)h(the)g
(pipe.)300 4802 y(The)g(results)f(of)h(this)f(test)g(are)h(sho)n(wn)f
(in)g(Figure)h(10.5.)583 4952 y(F)o(or)36 b(page)g(sized)f(data)h
(transfers)f(\(4K\))h(cop)o(ying)f(produces)g(a)h(bandwidth)e(of)i(40)f
(MB/sec,)300 5101 y(while)30 b(page)i(transfer)f(and)g(page)g(loanout)f
(produce)h(bandwidths)f(of)h(33)f(MB/sec)h(and)g(45)g(MB/sec,)300
5251 y(respecti)n(v)o(ely)-6 b(.)41 b(Using)28 b(both)g(page)h
(transfer)h(and)e(page)i(loanout)d(at)i(the)g(same)g(time)f(with)g
(page)h(sized)300 5400 y(transfers)c(produces)f(a)i(bandwidth)d(of)i
(70)g(MB/sec.)p eop
%%Page: 220 240
220 239 bop 3751 100 a Fs(220)583 249 y(As)24 b(the)g(transfer)h(size)f
(is)f(increased,)i(the)f(bandwidth)f(of)h(data)g(cop)o(ying)f(drops)h
(and)g(le)n(v)o(els)e(of)n(f)300 398 y(at)30 b(26)h(MB/sec)f(due)g(to)g
(the)h(ef)n(fects)f(of)h(the)f(cache.)48 b(Meanwhile,)31
b(the)f(bandwidth)g(of)g(both)g(transfer)300 548 y(and)c(loanout)e(le)n
(v)o(els)h(of)n(f)g(at)h(43)g(MB/sec)f(as)h(the)g(transfer)g(size)g(is)
f(increased.)34 b(Since)26 b(both)f(these)h(tests)300
697 y(still)33 b(ha)n(v)o(e)i(data)g(cop)o(ying)f(at)g(one)h(end)g(of)g
(the)f(pipe,)j(the)o(y)d(are)i(ef)n(fected)f(by)g(caching)f(in)h(the)f
(same)300 847 y(w)o(ay)f(as)g(data)g(cop)o(ying,)h(ho)n(we)n(v)o(er)d
(their)i(bandwidth)e(is)i(almost)e(double)h(that)h(of)g(cop)o(ying)f
(because)300 996 y(the)o(y)d(are)h(only)f(touching)f(the)i(data)f(on)h
(one)f(end.)45 b(The)30 b(page)g(loanout)e(curv)o(e)i(rises)f(higher)g
(than)g(the)300 1145 y(page)22 b(transfer)g(curv)o(e)g(in)f(mid-range)h
(transfer)g(sizes)f(because)i(page)f(loanout)e(has)i(less)f(o)o(v)o
(erhead)g(than)300 1295 y(page)27 b(transfer)-5 b(.)36
b(P)o(age)27 b(transfer)h(has)e(the)h(added)g(complication)e(of)i(ha)n
(ving)f(to)g(replace)h(the)g(data)g(page)300 1444 y(remo)o(v)o(ed)i
(from)h(cluster)g(mb)n(ufs)f(with)h(another)g(page.)48
b(The)30 b(bandwidth)f(of)h(the)g(test)g(in)g(which)g(both)300
1594 y(loanout)e(and)h(transfer)h(are)f(used)g(rises)g(sharply)f(and)i
(le)n(v)o(els)d(of)n(f)i(at)g(400)g(MB/sec)g(for)g(lar)n(ge)h(transfer)
300 1743 y(sizes.)g(In)25 b(this)f(case)h(the)g(data)f(is)h(not)f
(touched)g(or)h(copied)f(at)h(all,)f(instead)g(a)h(cop)o(y-on-write)f
(mapping)300 1892 y(to)g(the)h(sending)f(process')h(page)g(is)f(added)h
(to)f(the)h(recei)n(ving)f(process.)300 2276 y Fg(10.4)143
b(Map)35 b(Entry)g(P)o(assing)f(P)m(erf)l(ormance)300
2528 y Fs(Map)e(entry)g(passing)g(allo)n(ws)f(a)i(process)f(to)g(send)g
(a)h(part)f(of)h(its)e(virtual)h(address)g(space)h(to)f(another)300
2678 y(process.)e(The)24 b(recei)n(ving)e(process)i(can)f(share)h(the)f
(recei)n(v)o(ed)g(virtual)g(space)h(with)e(the)i(parent,)f(recei)n(v)o
(e)300 2827 y(a)31 b(cop)o(y-on-write)g(cop)o(y)g(of)g(the)g(virtual)f
(space)h(from)g(the)g(parent,)h(or)g(tak)o(e)f(o)o(v)o(er)f(full)g(o)n
(wnership)g(of)300 2977 y(the)25 b(virtual)f(space.)583
3126 y(Map)40 b(entry)f(passing)f(is)h(achie)n(v)o(ed)g(using)f(the)h
(e)o(xport/import)e(system)h(call)i(interf)o(ace)g(de-)300
3275 y(scribed)27 b(in)g(Section)h(7.3.1.)38 b(No)27
b(further)h(k)o(ernel)f(changes)h(are)g(necessary)g(to)f(test)g(it.)38
b(In)27 b(this)g(section)300 3425 y(we)f(compare)h(the)f(performance)h
(of)f(using)f(map)h(entry)g(passing)f(to)h(mo)o(v)o(e)f(data)h(to)g
(using)f(data)h(cop)o(y-)300 3574 y(ing.)300 3905 y Ff(10.4.1)118
b(Data)30 b(Exchange)g(W)n(ith)g(Map)g(Entry)g(P)o(assing)f(Measur)n
(ements)300 4122 y Fs(Data)i(passing)f(between)i(programs)e(is)h(quite)
f(common)g(on)h(Unix-lik)o(e)f(systems.)49 b(Man)o(y)30
b(programs)300 4271 y(communicate)h(through)g(pipes)g(or)h(sock)o(ets.)
51 b(If)32 b(an)g(application)f(passes)g(lar)n(ge)h(amounts)f(of)h
(data)g(is)300 4421 y(o)o(v)o(er)d(a)h(pipe,)g(it)f(might)g(bene\002t)g
(from)h(map)f(entry)h(passing.)44 b(T)-8 b(o)29 b(measure)h(the)f(ef)n
(fect)h(of)g(map)f(entry)300 4570 y(passing,)37 b(we)e(wrote)g(tw)o(o)g
(test)g(programs)f(that)h(pass)g(a)g(\002x)o(ed-sized)g(chunk)g(of)g
(data)g(between)h(tw)o(o)300 4720 y(processes)d(a)g(speci\002ed)g
(number)f(of)h(times.)53 b(One)33 b(test)f(program)g(passes)h(data)f
(between)h(processes)300 4869 y(by)26 b(sending)f(it)h(o)o(v)o(er)f(a)h
(local)g(sock)o(et.)35 b(This)25 b(causes)h(the)g(k)o(ernel)g(to)g(cop)
o(y)g(the)g(data)g(from)g(the)g(sending)300 5018 y(process)c(into)g(a)g
(mb)n(uf)g(chain,)h(and)f(then)g(to)g(cop)o(y)g(it)g(from)g(the)g(mb)n
(uf)f(chain)i(to)f(the)g(recei)n(ving)f(process.)300
5168 y(The)h(other)g(test)g(program)g(passes)g(data)h(between)f
(processes)g(by)g(using)f(map)h(entry)g(passing.)29 b(The)23
b(test)300 5317 y(program)h(can)i(optionally)d(\223touch\224)h(the)h
(data)g(after)g(it)g(arri)n(v)o(es)f(to)g(simulate)g(data)g
(processing.)p eop
%%Page: 221 241
221 240 bop 3751 100 a Fs(221)583 249 y(The)25 b(test)g(programs)f
(operate)h(as)g(follo)n(ws:)420 481 y(1.)49 b(The)25
b(parameters)g(are)g(parsed)g(and)g(b)n(uf)n(fers)f(are)i(allocated.)
420 714 y(2.)49 b(A)25 b(pair)g(of)f(connected)h(sock)o(ets)f(is)h
(created.)420 946 y(3.)49 b(A)25 b(child)f(process)h(is)f(fork)o(ed)h
(of)n(f.)420 1179 y(4.)49 b(F)o(or)22 b(the)g(test)g(program)g(that)g
(uses)g(cop)o(ying)g(to)g(mo)o(v)o(e)f(the)h(data,)h(the)f(parent)g
(process)h(initializes)544 1328 y(the)g(b)n(uf)n(fer)g(\(if)h(data)f
(\223touching\224)f(is)h(requested\),)h(and)f(writes)g(the)g(b)n(uf)n
(fer)g(into)f(the)h(sock)o(et.)30 b(The)544 1478 y(child)25
b(process)g(then)h(reads)g(the)f(data)h(from)g(the)f(sock)o(et.)33
b(If)26 b(data)g(touching)f(is)g(requested,)g(then)544
1627 y(the)h(child)g(process)g(modi\002es)g(the)h(data.)35
b(Then)27 b(the)f(child)g(process)g(writes)g(the)h(data)f(back)h(into)
544 1776 y(its)c(end)i(of)f(the)g(sock)o(et.)31 b(The)24
b(parent)g(process)h(reads)f(the)g(b)n(uf)n(fer)h(back.)30
b(This)24 b(entire)g(process)h(is)544 1926 y(repeated)g(for)g(the)g
(speci\002ed)g(number)f(of)h(times.)420 2158 y(5.)49
b(F)o(or)28 b(the)h(test)f(program)g(that)g(uses)g(map)g(entry)h
(passing)e(to)h(mo)o(v)o(e)f(the)i(data,)g(the)g(procedure)g(is)544
2308 y(similar)c(to)h(the)g(data)h(cop)o(ying)e(procedure)i(e)o(xcept)f
(that)g(the)g(e)o(xport)g(and)g(import)f(system)g(calls)544
2457 y(are)h(used.)k(The)25 b(parent)g(process)g(initializes)e(the)i
(data)g(\(if)g(touching\),)f(e)o(xports)g(the)g(b)n(uf)n(fer)l(,)h(and)
544 2606 y(writes)k(the)h(e)o(xport)f(tag)g(to)h(the)f(sock)o(et.)45
b(The)30 b(child)f(process)h(reads)g(the)f(e)o(xport)g(tag)h(from)f
(the)544 2756 y(sock)o(et)i(and)g(uses)f(that)h(to)f(import)g(the)h(b)n
(uf)n(fer)g(from)g(the)g(parent)g(process)g(\(thus)f(remo)o(ving)g(it)
544 2905 y(from)35 b(the)g(parent')-5 b(s)35 b(address)g(space\).)63
b(The)36 b(child)e(process)i(then)f(modi\002es)f(the)i(data)f(b)n(uf)n
(fer)544 3054 y(\(if)29 b(touching\),)f(e)o(xports)f(the)i(b)n(uf)n
(fer)l(,)g(and)g(writes)f(the)g(e)o(xport)g(tag)g(to)g(the)h(sock)o
(et.)41 b(The)29 b(parent)544 3204 y(reads)d(the)f(tag)h(from)f(the)g
(sock)o(et)h(and)f(imports)f(the)i(b)n(uf)n(fer)f(back)h(from)g(the)f
(child.)32 b(This)25 b(entire)544 3353 y(process)g(is)f(repeated)h(for)
g(the)g(speci\002ed)g(number)f(of)h(times.)300 3586 y(Both)j(test)g
(programs)f(tak)o(e)h(as)h(parameters)f(the)g(size)g(of)g(the)g(b)n(uf)
n(fer)g(to)g(transfer)g(and)g(the)g(number)g(of)300 3735
y(times)c(the)g(b)n(uf)n(fer)h(should)f(be)h(transfered.)583
3884 y(Each)39 b(test)e(program)g(w)o(as)h(run)g(using)f(transfer)h
(sizes)f(ranging)g(from)h(4K)g(to)f(4096K.)g(The)300
4034 y(number)19 b(of)g(times)f(the)h(data)g(w)o(as)g(transferred)h
(from)e(parent)i(to)e(child)h(process)g(and)g(back)g(w)o(as)g(adjusted)
300 4183 y(so)26 b(that)g(the)g(test)f(program)h(ran)g(for)h(at)f
(least)g(thirty)f(seconds.)34 b(Each)27 b(run)f(of)g(the)g(program)g(w)
o(as)g(timed)300 4333 y(so)e(that)h(the)f(bandwidth)g(could)g(be)h
(determined.)583 4482 y(As)k(sho)n(wn)f(in)h(Figure)g(10.6,)h(the)f
(bandwidth)e(curv)o(es)i(for)g(the)g(test)g(program)g(that)f(uses)h
(data)300 4631 y(cop)o(ying)36 b(via)i(the)f(sock)o(et)g(pair)g(start)g
(of)n(f)g(near)h(35)f(MB/sec)h(for)f(a)h(one)f(page)h(transfer)g(size.)
68 b(The)300 4781 y(bandwidth)28 b(decreases)j(as)f(the)f(transfer)i
(size)e(increases)h(due)g(to)f(caching)h(ef)n(fects.)46
b(The)29 b(bandwidth)300 4930 y(of)21 b(the)g(data-cop)o(ying)f(tests)g
(le)n(v)o(el)f(of)n(f)i(at)g(12)f(MB/sec.)30 b(On)20
b(the)h(other)g(hand,)g(the)g(bandwidth)e(curv)o(e)i(for)300
5080 y(the)k(map)f(entry)g(passing)g(test)g(program)g(peaks)h(around)f
(96)h(MB/sec)f(for)h(a)g(transfer)g(size)g(of)g(64K)f(and)300
5229 y(then)c(caching)h(ef)n(fects)g(on)f(k)o(ernel)h(VM)g(data)f
(structures)h(cause)g(it)f(to)g(f)o(all)h(and)g(le)n(v)o(el)e(of)n(f)i
(at)g(34)f(MB/sec.)p eop
%%Page: 222 242
222 241 bop 3751 100 a Fs(222)685 2430 y @beginspecial
43 @llx 43 @lly 528 @urx 434 @ury 3395 @rwi @setspecial
%%BeginDocument: ../plots/plot4/Plot4a.eps
80 dict begin
/languagelevel where
{pop /gs_languagelevel languagelevel def}
{/gs_languagelevel 1 def} ifelse
gs_languagelevel 1 gt {
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<0000000000000000000000000000000000000000000000000000000000000000>} image end }
			>> 	matrix makepattern /Pat0 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111000044440000111100004444000011110000444400001111000044440000>} image end }
			>> 	matrix makepattern /Pat1 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111444411114444111144441111444411114444111144441111444411114444>} image end }
			>> 	matrix makepattern /Pat2 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555>} image end }
			>> 	matrix makepattern /Pat3 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbb>} image end }
			>> 	matrix makepattern /Pat4 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffff>} image end }
			>> 	matrix makepattern /Pat5 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<f77dffffbeeffffff77dffffbeeffffff77dffffbeeffffff77dffffbeefffff>} image end }
			>> 	matrix makepattern /Pat6 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff>} image end }
			>> 	matrix makepattern /Pat7 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<e1e1f0f078783c3c1e1e0f0f8787c3c3e1e1f0f078783c3c1e1e0f0f8787c3c3>} image end }
			>> 	matrix makepattern /Pat8 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<87870f0f1e1e3c3c7878f0f0e1e1c3c387870f0f1e1e3c3c7878f0f0e1e1c3c3>} image end }
			>> 	matrix makepattern /Pat9 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc>} image end }
			>> 	matrix makepattern /Pat10 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffff>} image end }
			>> 	matrix makepattern /Pat11 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e>} image end }
			>> 	matrix makepattern /Pat12 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebf>} image end }
			>> 	matrix makepattern /Pat13 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7e>} image end }
			>> 	matrix makepattern /Pat14 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fffffbdff3dfebdfdbdfbbdf7bdffbdefbddfbdbfbd7fbcffbdfffffffffffff>} image end }
			>> 	matrix makepattern /Pat15 exch def 
}{
/Pat0 { 0.000000 setgray } def
/Pat1 { 0.062500 setgray } def
/Pat2 { 0.125000 setgray } def
/Pat3 { 0.187500 setgray } def
/Pat4 { 0.250000 setgray } def
/Pat5 { 0.312500 setgray } def
/Pat6 { 0.375000 setgray } def
/Pat7 { 0.437500 setgray } def
/Pat8 { 0.500000 setgray } def
/Pat9 { 0.562500 setgray } def
/Pat10 { 0.625000 setgray } def
/Pat11 { 0.687500 setgray } def
/Pat12 { 0.750000 setgray } def
/Pat13 { 0.812500 setgray } def
/Pat14 { 0.875000 setgray } def
/Pat15 { 0.937500 setgray } def
/setpattern { } def
} ifelse
/m {moveto} bind def
/l {lineto} bind def
/s {stroke} bind def
% Symbol fill
/f { gsave fill grestore stroke } bind def
% Opaque symbol
/o { gsave 1.000000 1.000000 1.000000 setrgbcolor
     fill grestore stroke } bind def
% Circle symbol
/a { 3 -1 roll 0 360 arc } bind def
/da { a s } bind def
/fa { a f } bind def
/oa { a o } bind def
% Square symbol
/sq { moveto dup dup rmoveto 2 mul
      dup neg 0 rlineto dup neg 0 exch rlineto
      0 rlineto closepath } bind def
/dsq { sq s } bind def
/fsq { sq f } bind def
/osq { sq o } bind def
% Triangle symbols
/t1 { moveto dup 0 exch rmoveto
      dup neg dup 2 mul rlineto 2 mul 0 rlineto
      closepath } bind def
/dt1 { t1 s } bind def
/ft1 { t1 f } bind def
/ot1 { t1 o } bind def
/t2 { moveto dup neg 0 rmoveto
      dup dup 2 mul exch neg rlineto
      2 mul 0 exch rlineto closepath } bind def
/dt2 { t2 s } bind def
/ft2 { t2 f } bind def
/ot2 { t2 o } bind def
/t3 { moveto dup neg 0 exch rmoveto
      dup dup 2 mul rlineto neg 2 mul 0 rlineto
      closepath } bind def
/dt3 { t3 s } bind def
/ft3 { t3 f } bind def
/ot3 { t3 o } bind def
/t4 { moveto dup 0 rmoveto
      dup dup -2 mul exch rlineto
      -2 mul 0 exch rlineto closepath } bind def
/dt4 { t4 s } bind def
/ft4 { t4 f } bind def
/ot4 { t4 o } bind def
% Diamond symbol
/di { moveto dup 0 exch rmoveto
      dup neg dup rlineto dup dup neg rlineto
      dup dup rlineto closepath } bind def
/ddi { di s } bind def
/fdi { di f } bind def
/odi { di o } bind def
% Plus symbol
/pl { dup 0 rmoveto dup -2 mul 0 rlineto
      dup dup rmoveto -2 mul 0 exch rlineto
    } bind def
/dpl { m pl s } bind def
% x symbol
/x { dup dup rmoveto dup -2 mul dup rlineto
     2 mul dup 0 rmoveto dup neg exch rlineto
   } bind def
/dx { m x s } bind def
% Splat symbol
/dsp { m dup pl dup 0 exch rmoveto 0.707 mul x s
     } bind def
/RJ {
 stringwidth neg exch neg exch
 rmoveto
} bind def
/CS {
 stringwidth
 2 div neg exch 2 div neg exch
 rmoveto
} bind def
0.24 0.24 scale
1 setlinecap

	mark             
	/ISOLatin1Encoding 
	  8#000 1 8#054 {StandardEncoding exch get} for 
	  /minus 
	  8#056 1 8#217 {StandardEncoding exch get} for 
	  /dotlessi 
	  8#301 1 8#317 {StandardEncoding exch get} for 
	  /space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
	  /dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen 
	  /registered /macron /degree /plusminus /twosuperior /threesuperior /acute 
	  /mu /paragraph /periodcentered /cedilla /onesuperior /ordmasculine 
	  /guillemotright /onequarter /onehalf /threequarters /questiondown /Agrave 
	  /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute
	  /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde
	  /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave 
	  /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls /agrave /aacute 
	  /acircumflex /atilde /adieresis /aring /ae /ccedilla /egrave /eacute 
	  /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde
	  /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave 
	  /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
	  /ISOLatin1Encoding where not {256 array astore def} if 
	 cleartomark 

	/makeISOEncoded 
	{ findfont /curfont exch def 
	  /newfont curfont maxlength dict def  
	  /ISOLatin1 (-ISOLatin1) def
	  /curfontname curfont /FontName get dup length string cvs def 
	  /newfontname curfontname length ISOLatin1 length add string 
    	 dup 0                  curfontname putinterval 
    	 dup curfontname length ISOLatin1   putinterval 
	  def 
	  curfont   
	  { exch dup /FID ne  
    	{ dup /Encoding eq  
    	  { exch pop ISOLatin1Encoding exch }  
    	  if  
    	  dup /FontName eq  
    	  { exch pop newfontname exch }  
    	  if  
    	  exch newfont 3 1 roll put  
    	}  
    	{ pop pop }  
    	ifelse  
	  }  
	  forall 
	  newfontname newfont definefont 
	} def 

	/Times-Roman makeISOEncoded pop 
	/Times-Bold makeISOEncoded pop 
	/Times-Italic makeISOEncoded pop 
	/Times-BoldItalic makeISOEncoded pop 
	/Helvetica makeISOEncoded pop 
	/Helvetica-Bold makeISOEncoded pop 
	/Helvetica-Oblique makeISOEncoded pop 
	/Helvetica-BoldOblique makeISOEncoded pop 
s
0.000000 0.000000 0.000000 setrgbcolor
1 setlinewidth
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
[] 0 setdash
435 375 m
435 385 l
561 375 m
561 385 l
635 375 m
635 385 l
687 375 m
687 385 l
728 375 m
728 385 l
761 375 m
761 385 l
789 375 m
789 385 l
814 375 m
814 385 l
835 375 m
835 385 l
854 375 m
854 385 l
981 375 m
981 385 l
1055 375 m
1055 385 l
1107 375 m
1107 385 l
1148 375 m
1148 385 l
1181 375 m
1181 385 l
1209 375 m
1209 385 l
1234 375 m
1234 385 l
1255 375 m
1255 385 l
1275 375 m
1275 385 l
1401 375 m
1401 385 l
1475 375 m
1475 385 l
1527 375 m
1527 385 l
1568 375 m
1568 385 l
1601 375 m
1601 385 l
1629 375 m
1629 385 l
1654 375 m
1654 385 l
1675 375 m
1675 385 l
1694 375 m
1694 385 l
1821 375 m
1821 385 l
1895 375 m
1895 385 l
1947 375 m
1947 385 l
1988 375 m
1988 385 l
2021 375 m
2021 385 l
2049 375 m
2049 385 l
2074 375 m
2074 385 l
2095 375 m
2095 385 l
2115 375 m
2115 385 l
435 1775 m
435 1765 l
561 1775 m
561 1765 l
635 1775 m
635 1765 l
687 1775 m
687 1765 l
728 1775 m
728 1765 l
761 1775 m
761 1765 l
789 1775 m
789 1765 l
814 1775 m
814 1765 l
835 1775 m
835 1765 l
854 1775 m
854 1765 l
981 1775 m
981 1765 l
1055 1775 m
1055 1765 l
1107 1775 m
1107 1765 l
1148 1775 m
1148 1765 l
1181 1775 m
1181 1765 l
1209 1775 m
1209 1765 l
1234 1775 m
1234 1765 l
1255 1775 m
1255 1765 l
1275 1775 m
1275 1765 l
1401 1775 m
1401 1765 l
1475 1775 m
1475 1765 l
1527 1775 m
1527 1765 l
1568 1775 m
1568 1765 l
1601 1775 m
1601 1765 l
1629 1775 m
1629 1765 l
1654 1775 m
1654 1765 l
1675 1775 m
1675 1765 l
1694 1775 m
1694 1765 l
1821 1775 m
1821 1765 l
1895 1775 m
1895 1765 l
1947 1775 m
1947 1765 l
1988 1775 m
1988 1765 l
2021 1775 m
2021 1765 l
2049 1775 m
2049 1765 l
2074 1775 m
2074 1765 l
2095 1775 m
2095 1765 l
2115 1775 m
2115 1765 l
s
435 375 m
435 395 l
854 375 m
854 395 l
1275 375 m
1275 395 l
1694 375 m
1694 395 l
2115 375 m
2115 395 l
435 1775 m
435 1755 l
854 1775 m
854 1755 l
1275 1775 m
1275 1755 l
1694 1775 m
1694 1755 l
2115 1775 m
2115 1755 l
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
435 325 m
gsave
435 325 translate
0 rotate
0 -20  m
(1) CS
(1) show
grestore
newpath
854 325 m
gsave
854 325 translate
0 rotate
0 -20  m
(10) CS
(10) show
grestore
newpath
1275 325 m
gsave
1275 325 translate
0 rotate
0 -20  m
(100) CS
(100) show
grestore
newpath
1694 325 m
gsave
1694 325 translate
0 rotate
0 -20  m
(1000) CS
(1000) show
grestore
newpath
2115 325 m
gsave
2115 325 translate
0 rotate
0 -20  m
(10000) CS
(10000) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1275 225 m
gsave
1275 225 translate
0 rotate
0 0  m
(transfer size \(kbytes\)) CS
(transfer size \(kbytes\)) show
grestore
newpath
435 375 m
445 375 l
435 515 m
445 515 l
435 655 m
445 655 l
435 795 m
445 795 l
435 935 m
445 935 l
435 1075 m
445 1075 l
435 1215 m
445 1215 l
435 1355 m
445 1355 l
435 1495 m
445 1495 l
435 1635 m
445 1635 l
435 1775 m
445 1775 l
2115 375 m
2105 375 l
2115 515 m
2105 515 l
2115 655 m
2105 655 l
2115 795 m
2105 795 l
2115 935 m
2105 935 l
2115 1075 m
2105 1075 l
2115 1215 m
2105 1215 l
2115 1355 m
2105 1355 l
2115 1495 m
2105 1495 l
2115 1635 m
2105 1635 l
2115 1775 m
2105 1775 l
s
435 375 m
455 375 l
435 655 m
455 655 l
435 935 m
455 935 l
435 1215 m
455 1215 l
435 1495 m
455 1495 l
435 1775 m
455 1775 l
2115 375 m
2095 375 l
2115 655 m
2095 655 l
2115 935 m
2095 935 l
2115 1215 m
2095 1215 l
2115 1495 m
2095 1495 l
2115 1775 m
2095 1775 l
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
397 375 m
gsave
397 375 translate
0 rotate
0 -20  m
(0) RJ
(0) show
grestore
newpath
397 655 m
gsave
397 655 translate
0 rotate
0 -20  m
(20) RJ
(20) show
grestore
newpath
397 935 m
gsave
397 935 translate
0 rotate
0 -20  m
(40) RJ
(40) show
grestore
newpath
397 1215 m
gsave
397 1215 translate
0 rotate
0 -20  m
(60) RJ
(60) show
grestore
newpath
397 1495 m
gsave
397 1495 translate
0 rotate
0 -20  m
(80) RJ
(80) show
grestore
newpath
397 1775 m
gsave
397 1775 translate
0 rotate
0 -20  m
(100) RJ
(100) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
246 1075 m
gsave
246 1075 translate
90 rotate
0 0  m
(bandwidth \(MB/sec\)) CS
(bandwidth \(MB/sec\)) show
grestore
newpath
687 842 m
814 754 l
940 728 l
1067 726 l
1193 692 l
1320 613 l
1446 554 l
1572 546 l
1699 545 l
1825 545 l
1952 545 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 687 842 fa
14 814 754 fa
14 940 728 fa
14 1067 726 fa
14 1193 692 fa
14 1320 613 fa
14 1446 554 fa
14 1572 546 fa
14 1699 545 fa
14 1825 545 fa
14 1952 545 fa
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
687 699 m
814 920 l
940 1218 l
1067 1499 l
1193 1718 l
1320 1338 l
1446 1070 l
1572 861 l
1699 857 l
1825 855 l
1952 855 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
12 687 699 fsq
12 814 920 fsq
12 940 1218 fsq
12 1067 1499 fsq
12 1193 1718 fsq
12 1320 1338 fsq
12 1446 1070 fsq
12 1572 861 fsq
12 1699 857 fsq
12 1825 855 fsq
12 1952 855 fsq
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
435 375 m
435 1775 l
2115 1775 l
2115 375 l
435 375 l
s
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1694 1635 m
1834 1635 l
s
14 1694 1635 fa
14 1834 1635 fa
1869 1635 m
gsave
1869 1635 translate
0 rotate
0 -20  m
(copy) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
1694 1561 m
1834 1561 l
s
12 1694 1561 fsq
12 1834 1561 fsq
0.000000 0.000000 0.000000 setrgbcolor
1869 1561 m
gsave
1869 1561 translate
0 rotate
0 -20  m
(m.e.p.) show
grestore
newpath
end
showpage
%%EndDocument
 @endspecial 300 2634 a(Figure)37 b(10.6:)52 b(Comparison)36
b(of)g(cop)o(y)g(and)h(map)e(entry)i(passing)e(\(m.e.p.\))65
b(transferring)36 b(memory)300 2754 y(between)25 b(tw)o(o)f(processes)
583 3149 y(If)33 b(the)f(application)f(does)h(not)f(touch)h(the)f(data)
i(after)f(it)g(is)f(transfered)i(then)e(the)h(bandwidth)300
3299 y(for)c(data)g(cop)o(ying)f(le)n(v)o(els)f(of)n(f)i(at)f(18)h
(MB/sec)g(rather)g(than)f(12)h(MB/sec.)39 b(On)28 b(the)g(other)f
(hand,)i(if)e(the)300 3448 y(map)i(entry)f(passing)g(test)h(program)f
(does)h(not)f(touch)h(the)g(data,)h(then)e(the)h(bandwidth)f(rises)g
(rapidly)-6 b(,)300 3597 y(reaching)27 b(18500)f(MB/sec)h(for)g(a)g
(transfer)g(size)g(of)f(4096K.)g(This)g(high)g(bandwidth)g(occurs)h
(because)300 3747 y(the)g(data)g(being)g(transfered)h(is)f(accessed)g
(neither)g(by)g(the)g(application)g(program)f(nor)i(the)f(k)o(ernel,)g
(so)300 3896 y(the)e(data)g(is)f(ne)n(v)o(er)g(loaded)h(into)f(the)g
(processor)h(from)f(main)h(memory)-6 b(.)300 4227 y Ff(10.4.2)118
b(Data)30 b(Pipeline)i(W)n(ith)e(Map)g(Entry)f(P)o(assing)g(and)i(P)o
(age)e(Loanout)300 4444 y Fs(Another)d(test)g(program)g(we)h(wrote)f
(combines)f(the)i(use)f(of)g(map)g(entry)h(passing)e(with)h(page)g
(loanout.)300 4593 y(The)32 b(test)f(program)g(consists)f(of)i(three)g
(processes.)51 b(The)31 b(\002rst)h(process)g(allocates)f(and)h
(initializes)e(a)300 4743 y(data)24 b(b)n(uf)n(fer)f(of)h(a)g
(speci\002ed)g(sized)g(and)f(then)g(sends)h(it)f(to)g(the)h(second)f
(process.)30 b(The)24 b(second)f(process)300 4892 y(modi\002es)36
b(the)g(data)h(and)g(then)f(sends)g(it)g(to)g(the)g(third)g(process.)66
b(The)37 b(third)f(process)g(recei)n(v)o(es)g(the)300
5042 y(data)g(and)h(writes)f(it)g(to)f(a)i(null)f(protocol)f(sock)o
(et.)65 b(Once)37 b(the)f(data)g(has)h(been)f(written)g(to)g(the)g
(null)300 5191 y(protocol)e(sock)o(et,)j(then)e(the)g(\002rst)g
(process)g(can)g(generate)h(another)f(b)n(uf)n(fers)g(w)o(orth)f(of)h
(data.)62 b(Such)p eop
%%Page: 223 243
223 242 bop 3751 100 a Fs(223)720 2430 y @beginspecial
55 @llx 43 @lly 528 @urx 434 @ury 3311 @rwi @setspecial
%%BeginDocument: ../plots/plot5/Plot5.eps
80 dict begin
/languagelevel where
{pop /gs_languagelevel languagelevel def}
{/gs_languagelevel 1 def} ifelse
gs_languagelevel 1 gt {
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<0000000000000000000000000000000000000000000000000000000000000000>} image end }
			>> 	matrix makepattern /Pat0 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111000044440000111100004444000011110000444400001111000044440000>} image end }
			>> 	matrix makepattern /Pat1 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111444411114444111144441111444411114444111144441111444411114444>} image end }
			>> 	matrix makepattern /Pat2 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555>} image end }
			>> 	matrix makepattern /Pat3 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbb>} image end }
			>> 	matrix makepattern /Pat4 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffff>} image end }
			>> 	matrix makepattern /Pat5 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<f77dffffbeeffffff77dffffbeeffffff77dffffbeeffffff77dffffbeefffff>} image end }
			>> 	matrix makepattern /Pat6 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff>} image end }
			>> 	matrix makepattern /Pat7 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<e1e1f0f078783c3c1e1e0f0f8787c3c3e1e1f0f078783c3c1e1e0f0f8787c3c3>} image end }
			>> 	matrix makepattern /Pat8 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<87870f0f1e1e3c3c7878f0f0e1e1c3c387870f0f1e1e3c3c7878f0f0e1e1c3c3>} image end }
			>> 	matrix makepattern /Pat9 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc>} image end }
			>> 	matrix makepattern /Pat10 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffff>} image end }
			>> 	matrix makepattern /Pat11 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e>} image end }
			>> 	matrix makepattern /Pat12 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebf>} image end }
			>> 	matrix makepattern /Pat13 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7e>} image end }
			>> 	matrix makepattern /Pat14 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fffffbdff3dfebdfdbdfbbdf7bdffbdefbddfbdbfbd7fbcffbdfffffffffffff>} image end }
			>> 	matrix makepattern /Pat15 exch def 
}{
/Pat0 { 0.000000 setgray } def
/Pat1 { 0.062500 setgray } def
/Pat2 { 0.125000 setgray } def
/Pat3 { 0.187500 setgray } def
/Pat4 { 0.250000 setgray } def
/Pat5 { 0.312500 setgray } def
/Pat6 { 0.375000 setgray } def
/Pat7 { 0.437500 setgray } def
/Pat8 { 0.500000 setgray } def
/Pat9 { 0.562500 setgray } def
/Pat10 { 0.625000 setgray } def
/Pat11 { 0.687500 setgray } def
/Pat12 { 0.750000 setgray } def
/Pat13 { 0.812500 setgray } def
/Pat14 { 0.875000 setgray } def
/Pat15 { 0.937500 setgray } def
/setpattern { } def
} ifelse
/m {moveto} bind def
/l {lineto} bind def
/s {stroke} bind def
% Symbol fill
/f { gsave fill grestore stroke } bind def
% Opaque symbol
/o { gsave 1.000000 1.000000 1.000000 setrgbcolor
     fill grestore stroke } bind def
% Circle symbol
/a { 3 -1 roll 0 360 arc } bind def
/da { a s } bind def
/fa { a f } bind def
/oa { a o } bind def
% Square symbol
/sq { moveto dup dup rmoveto 2 mul
      dup neg 0 rlineto dup neg 0 exch rlineto
      0 rlineto closepath } bind def
/dsq { sq s } bind def
/fsq { sq f } bind def
/osq { sq o } bind def
% Triangle symbols
/t1 { moveto dup 0 exch rmoveto
      dup neg dup 2 mul rlineto 2 mul 0 rlineto
      closepath } bind def
/dt1 { t1 s } bind def
/ft1 { t1 f } bind def
/ot1 { t1 o } bind def
/t2 { moveto dup neg 0 rmoveto
      dup dup 2 mul exch neg rlineto
      2 mul 0 exch rlineto closepath } bind def
/dt2 { t2 s } bind def
/ft2 { t2 f } bind def
/ot2 { t2 o } bind def
/t3 { moveto dup neg 0 exch rmoveto
      dup dup 2 mul rlineto neg 2 mul 0 rlineto
      closepath } bind def
/dt3 { t3 s } bind def
/ft3 { t3 f } bind def
/ot3 { t3 o } bind def
/t4 { moveto dup 0 rmoveto
      dup dup -2 mul exch rlineto
      -2 mul 0 exch rlineto closepath } bind def
/dt4 { t4 s } bind def
/ft4 { t4 f } bind def
/ot4 { t4 o } bind def
% Diamond symbol
/di { moveto dup 0 exch rmoveto
      dup neg dup rlineto dup dup neg rlineto
      dup dup rlineto closepath } bind def
/ddi { di s } bind def
/fdi { di f } bind def
/odi { di o } bind def
% Plus symbol
/pl { dup 0 rmoveto dup -2 mul 0 rlineto
      dup dup rmoveto -2 mul 0 exch rlineto
    } bind def
/dpl { m pl s } bind def
% x symbol
/x { dup dup rmoveto dup -2 mul dup rlineto
     2 mul dup 0 rmoveto dup neg exch rlineto
   } bind def
/dx { m x s } bind def
% Splat symbol
/dsp { m dup pl dup 0 exch rmoveto 0.707 mul x s
     } bind def
/RJ {
 stringwidth neg exch neg exch
 rmoveto
} bind def
/CS {
 stringwidth
 2 div neg exch 2 div neg exch
 rmoveto
} bind def
0.24 0.24 scale
1 setlinecap

	mark             
	/ISOLatin1Encoding 
	  8#000 1 8#054 {StandardEncoding exch get} for 
	  /minus 
	  8#056 1 8#217 {StandardEncoding exch get} for 
	  /dotlessi 
	  8#301 1 8#317 {StandardEncoding exch get} for 
	  /space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
	  /dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen 
	  /registered /macron /degree /plusminus /twosuperior /threesuperior /acute 
	  /mu /paragraph /periodcentered /cedilla /onesuperior /ordmasculine 
	  /guillemotright /onequarter /onehalf /threequarters /questiondown /Agrave 
	  /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute
	  /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde
	  /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave 
	  /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls /agrave /aacute 
	  /acircumflex /atilde /adieresis /aring /ae /ccedilla /egrave /eacute 
	  /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde
	  /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave 
	  /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
	  /ISOLatin1Encoding where not {256 array astore def} if 
	 cleartomark 

	/makeISOEncoded 
	{ findfont /curfont exch def 
	  /newfont curfont maxlength dict def  
	  /ISOLatin1 (-ISOLatin1) def
	  /curfontname curfont /FontName get dup length string cvs def 
	  /newfontname curfontname length ISOLatin1 length add string 
    	 dup 0                  curfontname putinterval 
    	 dup curfontname length ISOLatin1   putinterval 
	  def 
	  curfont   
	  { exch dup /FID ne  
    	{ dup /Encoding eq  
    	  { exch pop ISOLatin1Encoding exch }  
    	  if  
    	  dup /FontName eq  
    	  { exch pop newfontname exch }  
    	  if  
    	  exch newfont 3 1 roll put  
    	}  
    	{ pop pop }  
    	ifelse  
	  }  
	  forall 
	  newfontname newfont definefont 
	} def 

	/Times-Roman makeISOEncoded pop 
	/Times-Bold makeISOEncoded pop 
	/Times-Italic makeISOEncoded pop 
	/Times-BoldItalic makeISOEncoded pop 
	/Helvetica makeISOEncoded pop 
	/Helvetica-Bold makeISOEncoded pop 
	/Helvetica-Oblique makeISOEncoded pop 
	/Helvetica-BoldOblique makeISOEncoded pop 
s
0.000000 0.000000 0.000000 setrgbcolor
1 setlinewidth
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
[] 0 setdash
435 375 m
435 385 l
561 375 m
561 385 l
635 375 m
635 385 l
687 375 m
687 385 l
728 375 m
728 385 l
761 375 m
761 385 l
789 375 m
789 385 l
814 375 m
814 385 l
835 375 m
835 385 l
854 375 m
854 385 l
981 375 m
981 385 l
1055 375 m
1055 385 l
1107 375 m
1107 385 l
1148 375 m
1148 385 l
1181 375 m
1181 385 l
1209 375 m
1209 385 l
1234 375 m
1234 385 l
1255 375 m
1255 385 l
1275 375 m
1275 385 l
1401 375 m
1401 385 l
1475 375 m
1475 385 l
1527 375 m
1527 385 l
1568 375 m
1568 385 l
1601 375 m
1601 385 l
1629 375 m
1629 385 l
1654 375 m
1654 385 l
1675 375 m
1675 385 l
1694 375 m
1694 385 l
1821 375 m
1821 385 l
1895 375 m
1895 385 l
1947 375 m
1947 385 l
1988 375 m
1988 385 l
2021 375 m
2021 385 l
2049 375 m
2049 385 l
2074 375 m
2074 385 l
2095 375 m
2095 385 l
2115 375 m
2115 385 l
435 1775 m
435 1765 l
561 1775 m
561 1765 l
635 1775 m
635 1765 l
687 1775 m
687 1765 l
728 1775 m
728 1765 l
761 1775 m
761 1765 l
789 1775 m
789 1765 l
814 1775 m
814 1765 l
835 1775 m
835 1765 l
854 1775 m
854 1765 l
981 1775 m
981 1765 l
1055 1775 m
1055 1765 l
1107 1775 m
1107 1765 l
1148 1775 m
1148 1765 l
1181 1775 m
1181 1765 l
1209 1775 m
1209 1765 l
1234 1775 m
1234 1765 l
1255 1775 m
1255 1765 l
1275 1775 m
1275 1765 l
1401 1775 m
1401 1765 l
1475 1775 m
1475 1765 l
1527 1775 m
1527 1765 l
1568 1775 m
1568 1765 l
1601 1775 m
1601 1765 l
1629 1775 m
1629 1765 l
1654 1775 m
1654 1765 l
1675 1775 m
1675 1765 l
1694 1775 m
1694 1765 l
1821 1775 m
1821 1765 l
1895 1775 m
1895 1765 l
1947 1775 m
1947 1765 l
1988 1775 m
1988 1765 l
2021 1775 m
2021 1765 l
2049 1775 m
2049 1765 l
2074 1775 m
2074 1765 l
2095 1775 m
2095 1765 l
2115 1775 m
2115 1765 l
s
435 375 m
435 395 l
854 375 m
854 395 l
1275 375 m
1275 395 l
1694 375 m
1694 395 l
2115 375 m
2115 395 l
435 1775 m
435 1755 l
854 1775 m
854 1755 l
1275 1775 m
1275 1755 l
1694 1775 m
1694 1755 l
2115 1775 m
2115 1755 l
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
435 325 m
gsave
435 325 translate
0 rotate
0 -20  m
(1) CS
(1) show
grestore
newpath
854 325 m
gsave
854 325 translate
0 rotate
0 -20  m
(10) CS
(10) show
grestore
newpath
1275 325 m
gsave
1275 325 translate
0 rotate
0 -20  m
(100) CS
(100) show
grestore
newpath
1694 325 m
gsave
1694 325 translate
0 rotate
0 -20  m
(1000) CS
(1000) show
grestore
newpath
2115 325 m
gsave
2115 325 translate
0 rotate
0 -20  m
(10000) CS
(10000) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1275 225 m
gsave
1275 225 translate
0 rotate
0 0  m
(transfer size \(kbytes\)) CS
(transfer size \(kbytes\)) show
grestore
newpath
435 375 m
445 375 l
435 515 m
445 515 l
435 655 m
445 655 l
435 795 m
445 795 l
435 935 m
445 935 l
435 1075 m
445 1075 l
435 1215 m
445 1215 l
435 1355 m
445 1355 l
435 1495 m
445 1495 l
435 1635 m
445 1635 l
435 1775 m
445 1775 l
2115 375 m
2105 375 l
2115 515 m
2105 515 l
2115 655 m
2105 655 l
2115 795 m
2105 795 l
2115 935 m
2105 935 l
2115 1075 m
2105 1075 l
2115 1215 m
2105 1215 l
2115 1355 m
2105 1355 l
2115 1495 m
2105 1495 l
2115 1635 m
2105 1635 l
2115 1775 m
2105 1775 l
s
435 375 m
455 375 l
435 655 m
455 655 l
435 935 m
455 935 l
435 1215 m
455 1215 l
435 1495 m
455 1495 l
435 1775 m
455 1775 l
2115 375 m
2095 375 l
2115 655 m
2095 655 l
2115 935 m
2095 935 l
2115 1215 m
2095 1215 l
2115 1495 m
2095 1495 l
2115 1775 m
2095 1775 l
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
397 375 m
gsave
397 375 translate
0 rotate
0 -20  m
(0) RJ
(0) show
grestore
newpath
397 655 m
gsave
397 655 translate
0 rotate
0 -20  m
(10) RJ
(10) show
grestore
newpath
397 935 m
gsave
397 935 translate
0 rotate
0 -20  m
(20) RJ
(20) show
grestore
newpath
397 1215 m
gsave
397 1215 translate
0 rotate
0 -20  m
(30) RJ
(30) show
grestore
newpath
397 1495 m
gsave
397 1495 translate
0 rotate
0 -20  m
(40) RJ
(40) show
grestore
newpath
397 1775 m
gsave
397 1775 translate
0 rotate
0 -20  m
(50) RJ
(50) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
293 1075 m
gsave
293 1075 translate
90 rotate
0 0  m
(bandwidth \(MB/sec\)) CS
(bandwidth \(MB/sec\)) show
grestore
newpath
687 923 m
814 915 l
940 921 l
1067 896 l
1193 854 l
1320 734 l
1446 689 l
1572 678 l
1699 681 l
1825 681 l
1952 681 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 687 923 fa
14 814 915 fa
14 940 921 fa
14 1067 896 fa
14 1193 854 fa
14 1320 734 fa
14 1446 689 fa
14 1572 678 fa
14 1699 681 fa
14 1825 681 fa
14 1952 681 fa
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
687 692 m
814 924 l
940 1165 l
1067 1382 l
1193 1509 l
1320 1324 l
1446 1189 l
1572 1124 l
1699 1090 l
1825 1092 l
1952 1094 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
12 687 692 fsq
12 814 924 fsq
12 940 1165 fsq
12 1067 1382 fsq
12 1193 1509 fsq
12 1320 1324 fsq
12 1446 1189 fsq
12 1572 1124 fsq
12 1699 1090 fsq
12 1825 1092 fsq
12 1952 1094 fsq
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
435 375 m
435 1775 l
2115 1775 l
2115 375 l
435 375 l
s
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1694 1635 m
1834 1635 l
s
14 1694 1635 fa
14 1834 1635 fa
1869 1635 m
gsave
1869 1635 translate
0 rotate
0 -20  m
(copy) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
1694 1561 m
1834 1561 l
s
12 1694 1561 fsq
12 1834 1561 fsq
0.000000 0.000000 0.000000 setrgbcolor
1869 1561 m
gsave
1869 1561 translate
0 rotate
0 -20  m
(pipeline) show
grestore
newpath
end
showpage
%%EndDocument
 @endspecial 533 2634 a(Figure)25 b(10.7:)30 b(Comparison)24
b(of)h(cop)o(y)f(and)h(map)f(entry)h(passing/page)f(loanout)f(pipeline)
300 3029 y(a)29 b(data)g(pipeline)f(application)f(is)i(similar)e(to)h
(the)h(multimedia)e(\223I/O-pipeline)h(model\224)g(described)g(in)300
3178 y([53].)583 3328 y(In)35 b(the)g(test)f(program)g(the)h(data)f
(can)h(be)g(e)o(xchanged)g(between)f(the)h(processes)f(either)h(with)
300 3477 y(data)22 b(cop)o(ying)f(or)h(with)f(map)h(entry)g(passing.)29
b(The)22 b(\002nal)g(process)g(can)g(write)g(the)g(data)g(out)f(with)g
(either)300 3626 y(data)32 b(cop)o(ying)f(or)g(page)h(loanout.)50
b(W)-8 b(e)33 b(ran)f(the)f(test)g(program)h(with)f(transfer)h(sizes)f
(from)g(4K)h(\(one)300 3776 y(page\))e(to)g(4096K.)f(The)i(number)e(of)
h(transfers)g(w)o(as)h(adjusted)e(so)h(that)f(the)h(test)g(program)f
(ran)i(for)f(at)300 3925 y(least)25 b(thirty)e(seconds.)31
b(The)24 b(results)g(of)h(the)g(the)g(tests)f(are)h(sho)n(wn)f(in)g
(Figure)h(10.7.)583 4075 y(When)35 b(using)f(data)h(cop)o(ying,)h(the)f
(bandwidth)e(started)h(at)h(20)g(MB/sec)f(and)h(then)g(dropped)300
4224 y(and)d(le)n(v)o(eled)f(of)n(f)i(at)f(11)g(MB/sec)g(once)h(the)f
(cache)h(size)g(w)o(as)f(e)o(xceeded.)54 b(When)32 b(using)f(map)h
(entry)300 4373 y(passing)24 b(and)i(page)f(loanout,)f(the)h(bandwidth)
f(starts)h(at)h(11)f(MB/sec)g(for)g(a)h(page-sized)f(transfer)l(,)h
(and)300 4523 y(increases)f(to)f(a)h(peak)g(of)g(40)f(MB/sec)h(for)g(a)
g(64K)g(transfer)g(size.)30 b(It)25 b(then)f(le)n(v)o(els)g(of)n(f)g
(at)h(26)f(MB/sec)h(as)300 4672 y(the)g(k)o(ernel)g(data)f(structures)h
(e)o(xceed)g(the)f(size)h(of)g(the)g(cache.)p eop
%%Page: 224 244
224 243 bop 3751 100 a Fs(224)300 249 y Fg(10.5)143 b(Secondary)33
b(Design)h(Element)g(P)m(erf)l(ormance)300 502 y Fs(In)i(this)e
(section)h(we)h(e)o(xamine)f(the)g(ef)n(fect)h(of)g(some)f(of)h(UVM')-5
b(s)34 b(secondary)i(design)f(elements)f(on)300 651 y(the)e
(performance)i(of)e(the)h(BSD)g(k)o(ernel.)54 b(W)-8
b(e)34 b(discuss)d(process)i(creation)f(and)h(deletion,)g(clustered)300
800 y(pageout,)24 b(resident)h(page)g(f)o(aulting,)e(and)i(map)g(entry)
f(fragmentation.)300 1126 y Ff(10.5.1)118 b(Pr)n(ocess)29
b(Cr)n(eation)i(and)f(Deletion)300 1343 y Fs(When)25
b(a)g(process)g(is)f(created,)i(the)e(virtual)g(memory)g(system)g(must)
g(allocate)g(and)h(initialize)f(a)h(virtual)300 1492
y(address)33 b(space)h(for)f(the)g(ne)n(w)g(process.)56
b(A)34 b(process)f(can)g(create)i(a)e(child)g(process)g(by)g(using)f
(either)300 1641 y(the)c Fm(fork)g Fs(or)h Fm(vfork)f
Fs(system)f(calls.)42 b(In)29 b(a)g Fm(fork)f Fs(system)f(call,)j(the)e
(child)g(process')h(ne)n(w)f(address)300 1791 y(space)23
b(is)f(created)h(immediately)-6 b(.)27 b(In)c(a)f Fm(vfork)g
Fs(system)f(call,)h(the)h(child)e(process)h(borro)n(ws)g(the)g(parent)
300 1940 y(process')39 b(address)h(space.)75 b(The)39
b(parent)h(process)f(is)g(suspended)g(until)f(the)h(child)g(process)g
(either)300 2090 y(creates)27 b(a)f(ne)n(w)g(address)g(space)h(by)f(e)o
(x)o(ecuting)e(another)j(program)e(or)i(e)o(xits.)33
b(The)27 b Fm(vfork)e Fs(operation)300 2239 y(is)g(more)h(ef)n
(\002cient)g(for)g(programs)f(such)g(as)h(shells)f(that)g(fork)h(of)n
(f)g(child)f(processes)h(that)f(immediately)300 2388
y(e)o(x)o(ecute)f(another)h(program)g(because)g(cop)o(y-on-write)g
(operations)f(for)h(the)g(parent)g(process')g(address)300
2538 y(space)g(are)h(bypassed.)k(Address)24 b(spaces)h(are)h(freed)f
(when)g(a)g(process)g(e)o(xits.)583 2687 y(A)h(lar)n(ge)h(part)f(of)g
(the)g(o)o(v)o(erhead)f(associated)h(with)f(creating)h(and)g(deleting)f
(processes)h(can)g(be)300 2837 y(attrib)n(uted)c(to)h(the)h(virtual)e
(memory)h(system.)29 b(F)o(or)23 b(e)o(xample,)g(ne)n(w)g(processes)g
(must)f(ha)n(v)o(e)i(their)f(maps)300 2986 y(initialized)33
b(based)h(on)g(the)g(inheritance)g(v)n(alues)f(of)h(the)h(parent)f
(process')g(map.)59 b(F)o(or)34 b(re)o(gions)f(with)300
3135 y(cop)o(y)22 b(inheritance,)g(all)g(mappings)f(in)g(the)h(parent)h
(process')f(address)g(space)g(must)f(be)h(write)g(protected)300
3285 y(to)i(ensure)h(proper)g(cop)o(y-on-write)g(semantics.)583
3434 y(T)-8 b(o)24 b(compare)g(the)g(o)o(v)o(erhead)g(of)g(BSD)h(VM)e
(and)h(UVM)g(in)f(the)h(area)h(of)f(process)g(creation)g(and)300
3584 y(deletion)g(we)h(wrote)g(a)g(small)f(test)g(program.)30
b(The)25 b(test)f(program)h(operates)g(as)g(follo)n(ws:)420
3785 y(1.)49 b(The)25 b(parameters)g(are)g(parsed.)420
4007 y(2.)49 b(A)25 b(\002x)o(ed)f(size)h(chunk)g(of)f(anon)o(ymous)f
(memory)h(is)h(allocated)f(and)h(zeroed.)420 4229 y(3.)49
b(The)21 b(test)g(program)g(then)g(repeatedly)h(uses)f
Fm(fork)f Fs(or)i Fm(vfork)e Fs(to)h(create)h(a)g(child)f(process.)29
b(The)544 4379 y(child)24 b(process)h(immediately)e(e)o(xits.)420
4601 y(4.)49 b(The)25 b(time)f(a)h(single)f(fork)h(tak)o(es)f(is)h
(computed.)300 4802 y(The)j(test)f(program)g(tak)o(es)h(as)g
(parameters)g(the)f(size)h(of)g(anon)o(ymous)e(memory)g(to)i(allocate,)
g(whether)300 4952 y(to)k(use)h Fm(fork)f Fs(or)g Fm(vfork)p
Fs(,)i(and)e(whether)h(or)g(not)f(to)g(touch)g(the)h(anon)o(ymous)d
(memory)i(after)h(each)300 5101 y Fm(fork)24 b Fs(operation.)583
5251 y(The)30 b(test)f(program)g(w)o(as)h(run)f(under)g(both)g(BSD)h
(VM)f(and)h(UVM)f(for)h(memory)e(allocations)300 5400
y(of)f(0MB)h(to)f(16MB.)g(W)-8 b(e)28 b(had)f(the)g(test)g(program)g
(perform)g(10,000)g(forks)g(for)h(each)g(allocation)e(size.)p
eop
%%Page: 225 245
225 244 bop 3751 100 a Fs(225)659 2430 y @beginspecial
22 @llx 43 @lly 516 @urx 434 @ury 3458 @rwi @setspecial
%%BeginDocument: ../plots/xplotA/XplotA.eps
80 dict begin
/languagelevel where
{pop /gs_languagelevel languagelevel def}
{/gs_languagelevel 1 def} ifelse
gs_languagelevel 1 gt {
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<0000000000000000000000000000000000000000000000000000000000000000>} image end }
			>> 	matrix makepattern /Pat0 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111000044440000111100004444000011110000444400001111000044440000>} image end }
			>> 	matrix makepattern /Pat1 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111444411114444111144441111444411114444111144441111444411114444>} image end }
			>> 	matrix makepattern /Pat2 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555>} image end }
			>> 	matrix makepattern /Pat3 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbb>} image end }
			>> 	matrix makepattern /Pat4 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffff>} image end }
			>> 	matrix makepattern /Pat5 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<f77dffffbeeffffff77dffffbeeffffff77dffffbeeffffff77dffffbeefffff>} image end }
			>> 	matrix makepattern /Pat6 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff>} image end }
			>> 	matrix makepattern /Pat7 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<e1e1f0f078783c3c1e1e0f0f8787c3c3e1e1f0f078783c3c1e1e0f0f8787c3c3>} image end }
			>> 	matrix makepattern /Pat8 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<87870f0f1e1e3c3c7878f0f0e1e1c3c387870f0f1e1e3c3c7878f0f0e1e1c3c3>} image end }
			>> 	matrix makepattern /Pat9 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc>} image end }
			>> 	matrix makepattern /Pat10 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffff>} image end }
			>> 	matrix makepattern /Pat11 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e>} image end }
			>> 	matrix makepattern /Pat12 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebf>} image end }
			>> 	matrix makepattern /Pat13 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7e>} image end }
			>> 	matrix makepattern /Pat14 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fffffbdff3dfebdfdbdfbbdf7bdffbdefbddfbdbfbd7fbcffbdfffffffffffff>} image end }
			>> 	matrix makepattern /Pat15 exch def 
}{
/Pat0 { 0.000000 setgray } def
/Pat1 { 0.062500 setgray } def
/Pat2 { 0.125000 setgray } def
/Pat3 { 0.187500 setgray } def
/Pat4 { 0.250000 setgray } def
/Pat5 { 0.312500 setgray } def
/Pat6 { 0.375000 setgray } def
/Pat7 { 0.437500 setgray } def
/Pat8 { 0.500000 setgray } def
/Pat9 { 0.562500 setgray } def
/Pat10 { 0.625000 setgray } def
/Pat11 { 0.687500 setgray } def
/Pat12 { 0.750000 setgray } def
/Pat13 { 0.812500 setgray } def
/Pat14 { 0.875000 setgray } def
/Pat15 { 0.937500 setgray } def
/setpattern { } def
} ifelse
/m {moveto} bind def
/l {lineto} bind def
/s {stroke} bind def
% Symbol fill
/f { gsave fill grestore stroke } bind def
% Opaque symbol
/o { gsave 1.000000 1.000000 1.000000 setrgbcolor
     fill grestore stroke } bind def
% Circle symbol
/a { 3 -1 roll 0 360 arc } bind def
/da { a s } bind def
/fa { a f } bind def
/oa { a o } bind def
% Square symbol
/sq { moveto dup dup rmoveto 2 mul
      dup neg 0 rlineto dup neg 0 exch rlineto
      0 rlineto closepath } bind def
/dsq { sq s } bind def
/fsq { sq f } bind def
/osq { sq o } bind def
% Triangle symbols
/t1 { moveto dup 0 exch rmoveto
      dup neg dup 2 mul rlineto 2 mul 0 rlineto
      closepath } bind def
/dt1 { t1 s } bind def
/ft1 { t1 f } bind def
/ot1 { t1 o } bind def
/t2 { moveto dup neg 0 rmoveto
      dup dup 2 mul exch neg rlineto
      2 mul 0 exch rlineto closepath } bind def
/dt2 { t2 s } bind def
/ft2 { t2 f } bind def
/ot2 { t2 o } bind def
/t3 { moveto dup neg 0 exch rmoveto
      dup dup 2 mul rlineto neg 2 mul 0 rlineto
      closepath } bind def
/dt3 { t3 s } bind def
/ft3 { t3 f } bind def
/ot3 { t3 o } bind def
/t4 { moveto dup 0 rmoveto
      dup dup -2 mul exch rlineto
      -2 mul 0 exch rlineto closepath } bind def
/dt4 { t4 s } bind def
/ft4 { t4 f } bind def
/ot4 { t4 o } bind def
% Diamond symbol
/di { moveto dup 0 exch rmoveto
      dup neg dup rlineto dup dup neg rlineto
      dup dup rlineto closepath } bind def
/ddi { di s } bind def
/fdi { di f } bind def
/odi { di o } bind def
% Plus symbol
/pl { dup 0 rmoveto dup -2 mul 0 rlineto
      dup dup rmoveto -2 mul 0 exch rlineto
    } bind def
/dpl { m pl s } bind def
% x symbol
/x { dup dup rmoveto dup -2 mul dup rlineto
     2 mul dup 0 rmoveto dup neg exch rlineto
   } bind def
/dx { m x s } bind def
% Splat symbol
/dsp { m dup pl dup 0 exch rmoveto 0.707 mul x s
     } bind def
/RJ {
 stringwidth neg exch neg exch
 rmoveto
} bind def
/CS {
 stringwidth
 2 div neg exch 2 div neg exch
 rmoveto
} bind def
0.24 0.24 scale
1 setlinecap

	mark             
	/ISOLatin1Encoding 
	  8#000 1 8#054 {StandardEncoding exch get} for 
	  /minus 
	  8#056 1 8#217 {StandardEncoding exch get} for 
	  /dotlessi 
	  8#301 1 8#317 {StandardEncoding exch get} for 
	  /space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
	  /dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen 
	  /registered /macron /degree /plusminus /twosuperior /threesuperior /acute 
	  /mu /paragraph /periodcentered /cedilla /onesuperior /ordmasculine 
	  /guillemotright /onequarter /onehalf /threequarters /questiondown /Agrave 
	  /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute
	  /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde
	  /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave 
	  /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls /agrave /aacute 
	  /acircumflex /atilde /adieresis /aring /ae /ccedilla /egrave /eacute 
	  /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde
	  /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave 
	  /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
	  /ISOLatin1Encoding where not {256 array astore def} if 
	 cleartomark 

	/makeISOEncoded 
	{ findfont /curfont exch def 
	  /newfont curfont maxlength dict def  
	  /ISOLatin1 (-ISOLatin1) def
	  /curfontname curfont /FontName get dup length string cvs def 
	  /newfontname curfontname length ISOLatin1 length add string 
    	 dup 0                  curfontname putinterval 
    	 dup curfontname length ISOLatin1   putinterval 
	  def 
	  curfont   
	  { exch dup /FID ne  
    	{ dup /Encoding eq  
    	  { exch pop ISOLatin1Encoding exch }  
    	  if  
    	  dup /FontName eq  
    	  { exch pop newfontname exch }  
    	  if  
    	  exch newfont 3 1 roll put  
    	}  
    	{ pop pop }  
    	ifelse  
	  }  
	  forall 
	  newfontname newfont definefont 
	} def 

	/Times-Roman makeISOEncoded pop 
	/Times-Bold makeISOEncoded pop 
	/Times-Italic makeISOEncoded pop 
	/Times-BoldItalic makeISOEncoded pop 
	/Helvetica makeISOEncoded pop 
	/Helvetica-Bold makeISOEncoded pop 
	/Helvetica-Oblique makeISOEncoded pop 
	/Helvetica-BoldOblique makeISOEncoded pop 
s
0.000000 0.000000 0.000000 setrgbcolor
1 setlinewidth
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
[] 0 setdash
435 375 m
435 385 l
645 375 m
645 385 l
854 375 m
854 385 l
1065 375 m
1065 385 l
1275 375 m
1275 385 l
1484 375 m
1484 385 l
1694 375 m
1694 385 l
1905 375 m
1905 385 l
2115 375 m
2115 385 l
435 1775 m
435 1765 l
645 1775 m
645 1765 l
854 1775 m
854 1765 l
1065 1775 m
1065 1765 l
1275 1775 m
1275 1765 l
1484 1775 m
1484 1765 l
1694 1775 m
1694 1765 l
1905 1775 m
1905 1765 l
2115 1775 m
2115 1765 l
s
435 375 m
435 395 l
854 375 m
854 395 l
1275 375 m
1275 395 l
1694 375 m
1694 395 l
2115 375 m
2115 395 l
435 1775 m
435 1755 l
854 1775 m
854 1755 l
1275 1775 m
1275 1755 l
1694 1775 m
1694 1755 l
2115 1775 m
2115 1755 l
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
435 325 m
gsave
435 325 translate
0 rotate
0 -20  m
(0) CS
(0) show
grestore
newpath
854 325 m
gsave
854 325 translate
0 rotate
0 -20  m
(5) CS
(5) show
grestore
newpath
1275 325 m
gsave
1275 325 translate
0 rotate
0 -20  m
(10) CS
(10) show
grestore
newpath
1694 325 m
gsave
1694 325 translate
0 rotate
0 -20  m
(15) CS
(15) show
grestore
newpath
2115 325 m
gsave
2115 325 translate
0 rotate
0 -20  m
(20) CS
(20) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1275 225 m
gsave
1275 225 translate
0 rotate
0 0  m
(allocation \(MB\)) CS
(allocation \(MB\)) show
grestore
newpath
435 375 m
445 375 l
435 515 m
445 515 l
435 655 m
445 655 l
435 795 m
445 795 l
435 935 m
445 935 l
435 1075 m
445 1075 l
435 1215 m
445 1215 l
435 1355 m
445 1355 l
435 1495 m
445 1495 l
435 1635 m
445 1635 l
435 1775 m
445 1775 l
2115 375 m
2105 375 l
2115 515 m
2105 515 l
2115 655 m
2105 655 l
2115 795 m
2105 795 l
2115 935 m
2105 935 l
2115 1075 m
2105 1075 l
2115 1215 m
2105 1215 l
2115 1355 m
2105 1355 l
2115 1495 m
2105 1495 l
2115 1635 m
2105 1635 l
2115 1775 m
2105 1775 l
s
435 375 m
455 375 l
435 655 m
455 655 l
435 935 m
455 935 l
435 1215 m
455 1215 l
435 1495 m
455 1495 l
435 1775 m
455 1775 l
2115 375 m
2095 375 l
2115 655 m
2095 655 l
2115 935 m
2095 935 l
2115 1215 m
2095 1215 l
2115 1495 m
2095 1495 l
2115 1775 m
2095 1775 l
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
397 375 m
gsave
397 375 translate
0 rotate
0 -20  m
(0) RJ
(0) show
grestore
newpath
397 655 m
gsave
397 655 translate
0 rotate
0 -20  m
(2000) RJ
(2000) show
grestore
newpath
397 935 m
gsave
397 935 translate
0 rotate
0 -20  m
(4000) RJ
(4000) show
grestore
newpath
397 1215 m
gsave
397 1215 translate
0 rotate
0 -20  m
(6000) RJ
(6000) show
grestore
newpath
397 1495 m
gsave
397 1495 translate
0 rotate
0 -20  m
(8000) RJ
(8000) show
grestore
newpath
397 1775 m
gsave
397 1775 translate
0 rotate
0 -20  m
(10000) RJ
(10000) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
155 1075 m
gsave
155 1075 translate
90 rotate
0 0  m
(fork+exit time \(usec\)) CS
(fork+exit time \(usec\)) show
grestore
newpath
435 540 m
519 612 l
602 663 l
687 712 l
771 767 l
854 825 l
939 882 l
1022 950 l
1106 1014 l
1191 1086 l
1275 1149 l
1358 1220 l
1442 1305 l
1527 1366 l
1610 1437 l
1694 1515 l
1779 1587 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 435 540 fa
14 519 612 fa
14 602 663 fa
14 687 712 fa
14 771 767 fa
14 854 825 fa
14 939 882 fa
14 1022 950 fa
14 1106 1014 fa
14 1191 1086 fa
14 1275 1149 fa
14 1358 1220 fa
14 1442 1305 fa
14 1527 1366 fa
14 1610 1437 fa
14 1694 1515 fa
14 1779 1587 fa
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
435 518 m
519 551 l
602 567 l
687 590 l
771 602 l
854 662 l
939 675 l
1022 685 l
1106 701 l
1191 773 l
1275 790 l
1358 808 l
1442 832 l
1527 847 l
1610 863 l
1694 883 l
1779 902 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
12 435 518 fsq
12 519 551 fsq
12 602 567 fsq
12 687 590 fsq
12 771 602 fsq
12 854 662 fsq
12 939 675 fsq
12 1022 685 fsq
12 1106 701 fsq
12 1191 773 fsq
12 1275 790 fsq
12 1358 808 fsq
12 1442 832 fsq
12 1527 847 fsq
12 1610 863 fsq
12 1694 883 fsq
12 1779 902 fsq
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
0.000000 1.000000 0.000000 setrgbcolor
435 541 m
519 547 l
602 556 l
687 565 l
771 571 l
854 580 l
939 590 l
1022 600 l
1106 612 l
1191 623 l
1275 633 l
1358 649 l
1442 665 l
1527 678 l
1610 699 l
1694 718 l
1779 733 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 435 541 fdi
14 519 547 fdi
14 602 556 fdi
14 687 565 fdi
14 771 571 fdi
14 854 580 fdi
14 939 590 fdi
14 1022 600 fdi
14 1106 612 fdi
14 1191 623 fdi
14 1275 633 fdi
14 1358 649 fdi
14 1442 665 fdi
14 1527 678 fdi
14 1610 699 fdi
14 1694 718 fdi
14 1779 733 fdi
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
0.000000 0.000000 1.000000 setrgbcolor
435 518 m
519 519 l
602 519 l
687 518 l
771 519 l
854 520 l
939 519 l
1022 519 l
1106 519 l
1191 520 l
1275 520 l
1358 520 l
1442 520 l
1527 520 l
1610 520 l
1694 520 l
1779 521 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 435 518 ft1
14 519 519 ft1
14 602 519 ft1
14 687 518 ft1
14 771 519 ft1
14 854 520 ft1
14 939 519 ft1
14 1022 519 ft1
14 1106 519 ft1
14 1191 520 ft1
14 1275 520 ft1
14 1358 520 ft1
14 1442 520 ft1
14 1527 520 ft1
14 1610 520 ft1
14 1694 520 ft1
14 1779 521 ft1
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
0.580392 0.000000 0.827451 setrgbcolor
435 405 m
519 405 l
602 405 l
687 405 l
771 405 l
854 405 l
939 405 l
1022 405 l
1106 405 l
1191 405 l
1275 405 l
1358 405 l
1442 405 l
1527 405 l
1610 405 l
1694 405 l
1779 405 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
10 435 405 dx
10 519 405 dx
10 602 405 dx
10 687 405 dx
10 771 405 dx
10 854 405 dx
10 939 405 dx
10 1022 405 dx
10 1106 405 dx
10 1191 405 dx
10 1275 405 dx
10 1358 405 dx
10 1442 405 dx
10 1527 405 dx
10 1610 405 dx
10 1694 405 dx
10 1779 405 dx
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
0.737255 0.560784 0.560784 setrgbcolor
435 404 m
519 404 l
602 404 l
687 404 l
771 404 l
854 404 l
939 404 l
1022 404 l
1106 404 l
1191 404 l
1275 404 l
1358 404 l
1442 404 l
1527 404 l
1610 404 l
1694 404 l
1779 404 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 435 404 da
14 519 404 da
14 602 404 da
14 687 404 da
14 771 404 da
14 854 404 da
14 939 404 da
14 1022 404 da
14 1106 404 da
14 1191 404 da
14 1275 404 da
14 1358 404 da
14 1442 404 da
14 1527 404 da
14 1610 404 da
14 1694 404 da
14 1779 404 da
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
435 375 m
435 1775 l
2115 1775 l
2115 375 l
435 375 l
s
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
519 1635 m
659 1635 l
s
14 519 1635 fa
14 659 1635 fa
694 1635 m
gsave
694 1635 translate
0 rotate
0 -20  m
(BSD+fork+touch) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
519 1561 m
659 1561 l
s
12 519 1561 fsq
12 659 1561 fsq
0.000000 0.000000 0.000000 setrgbcolor
694 1561 m
gsave
694 1561 translate
0 rotate
0 -20  m
(UVM+fork+touch) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 1.000000 0.000000 setrgbcolor
519 1487 m
659 1487 l
s
14 519 1487 fdi
14 659 1487 fdi
0.000000 0.000000 0.000000 setrgbcolor
694 1487 m
gsave
694 1487 translate
0 rotate
0 -20  m
(BSD+fork) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 1.000000 setrgbcolor
519 1413 m
659 1413 l
s
14 519 1413 ft1
14 659 1413 ft1
0.000000 0.000000 0.000000 setrgbcolor
694 1413 m
gsave
694 1413 translate
0 rotate
0 -20  m
(UVM+fork) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.580392 0.000000 0.827451 setrgbcolor
519 1339 m
659 1339 l
s
10 519 1339 dx
10 659 1339 dx
0.000000 0.000000 0.000000 setrgbcolor
694 1339 m
gsave
694 1339 translate
0 rotate
0 -20  m
(BSD+vfork) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.737255 0.560784 0.560784 setrgbcolor
519 1265 m
659 1265 l
s
14 519 1265 da
14 659 1265 da
0.000000 0.000000 0.000000 setrgbcolor
694 1265 m
gsave
694 1265 translate
0 rotate
0 -20  m
(UVM+vfork) show
grestore
newpath
end
showpage
%%EndDocument
 @endspecial 524 2634 a(Figure)25 b(10.8:)30 b(Process)25
b(creation)g(and)g(deletion)f(o)o(v)o(erhead)g(under)h(BSD)g(VM)g(and)f
(UVM)300 3029 y(F)o(or)29 b(the)f Fm(fork)g Fs(operation,)h(we)g(ran)g
(the)g(test)f(program)g(with)g(and)h(without)e(touching)h(the)g
(allocated)300 3178 y(memory)c(area.)32 b(The)24 b(results)g(of)h(this)
f(test)h(are)g(sho)n(wn)f(in)g(Figure)h(10.8.)583 3328
y(F)o(or)39 b Fm(vfork)e Fs(operations,)k(the)e(time)f(it)g(took)f(for)
i(a)g(process)f(to)h(fork)f(and)h(e)o(xit)e(remained)300
3477 y(constant)31 b(re)o(gardless)f(of)i(the)g(memory)f(allocation)f
(for)i(both)f(BSD)i(VM)e(\(218)g(microseconds\))g(and)300
3626 y(UVM)21 b(\(210)g(microseconds\).)29 b(This)21
b(w)o(as)g(e)o(xpected)g(because)h(with)f Fm(vfork)f
Fs(the)i(child)e(process)i(ne)n(v)o(er)300 3776 y(gets)e(an)g(address)f
(space)i(of)f(its)f(o)n(wn.)28 b(Note)20 b(that)f(a)i(normal)e
Fm(fork)g Fs(operation)g(tak)o(es)h(at)g(least)g(\002)n(v)o(e)f(times)
300 3925 y(as)25 b(much)f(time)g(to)h(complete)f(as)h(a)g
Fm(vfork)f Fs(operation.)583 4075 y(F)o(or)i Fm(fork)f
Fs(operations)f(where)i(the)g(allocated)f(data)h(is)f(not)g(touched)g
(for)h(each)g Fm(fork)f Fs(opera-)300 4224 y(tion)i(there)g(is)g(a)h
(major)f(dif)n(ference)h(between)f(BSD)h(VM)f(and)h(UVM.)f(F)o(or)g
(UVM,)g(the)g(fork)h(and)f(e)o(xit)300 4373 y(time)i(remained)h
(constant)f(at)h(1035)g(microseconds.)45 b(On)30 b(the)g(other)g(hand,)
h(the)f(time)f(for)i(BSD)g(VM)300 4523 y(gro)n(ws)c(with)g(the)h(size)g
(of)g(the)g(memory)f(allocation.)39 b(UVM')-5 b(s)27
b(beha)n(vior)h(is)g(easy)g(to)f(e)o(xplain.)40 b(At)27
b(the)300 4672 y(time)d(of)h(the)f(\002rst)h Fm(fork)f
Fs(operation,)g(the)h(map)f(entry)h(in)f(the)h(parent')-5
b(s)24 b(map)g(that)h(maps)f(the)g(allocated)300 4822
y(area)d(of)g(memory)e(is)h(write)g(protected)h(and)f(mark)o(ed)g
(\223needs-cop)o(y)-6 b(.)f(\224)29 b(Since)21 b(the)f(parent)g
(process)h(ne)n(v)o(er)300 4971 y(writes)30 b(to)g(the)g(allocated)g
(area)h(memory)f(between)g Fm(fork)f Fs(operations,)i(the)f
(\223needs-cop)o(y\224)h(\003ag)f(re-)300 5120 y(mains)20
b(set.)30 b(This)20 b(indicates)h(that)g(the)g(allocated)g(area)h(of)g
(memory)e(is)h(already)h(set)f(for)h(cop)o(y-on-write.)300
5270 y(As)k(e)o(xplained)f(in)h(Section)h(4.6)f(and)g(Section)g(4.7,)h
(the)f(UVM)g Fm(fork)f Fs(code)i(tak)o(es)f(adv)n(antage)g(of)g(this)p
eop
%%Page: 226 246
226 245 bop 3751 100 a Fs(226)300 249 y(to)28 b(a)n(v)n(oid)g
(repeating)g(the)g(cop)o(y-on-write)f(setup)h(operation,)h(thus)e
(bypassing)g(the)h(o)o(v)o(erhead)f(associ-)300 398 y(ated)c(with)f
(the)h(memory)f(allocation.)29 b(On)22 b(the)h(other)g(hand,)g(the)f
(BSD)i(VM)e(code)h(appears)h(to)e(perform)300 548 y(some)k(shado)n
(w-object)f(chain)h(related)h(operations)f(re)o(gardless)f(of)h(the)h
(needs-cop)o(y)f(state)g(of)h(its)e(map)300 697 y(entry)-6
b(,)24 b(thus)g(contrib)n(uting)f(to)h(the)h(o)o(v)o(erhead)f(of)h(the)
g(fork)g(operation.)583 847 y(If)39 b(the)f(allocated)g(data)h(is)e
(touched)h(between)g Fm(fork)g Fs(operations,)j(then)c(needs-cop)o(y)i
(gets)300 996 y(cleared)27 b(and)f(both)g(virtual)f(memory)g(systems)g
(are)i(forced)g(to)f(do)g(all)f(cop)o(y-on-write)h(related)h(opera-)300
1145 y(tions)f(on)h(the)g(allocated)g(memory)g(each)h(time)e(through)g
(the)h(loop.)38 b(In)27 b(this)f(case)i(the)f(time)g(for)g(a)h(fork)300
1295 y(and)34 b(e)o(xit)f(for)h(both)f(BSD)i(VM)f(and)g(UVM)f
(increases)h(with)f(the)h(size)g(of)g(the)g(memory)f(allocation.)300
1444 y(F)o(or)g(an)g(allocation)f(of)i(zero,)h(the)e(times)f(for)i(BSD)
g(VM)e(and)h(UVM)g(are)h(1177)e(microseconds)g(and)300
1594 y(1025)26 b(microseconds,)g(respecti)n(v)o(ely)-6
b(.)35 b(F)o(or)27 b(an)g(allocation)f(of)h(16MB,)f(the)h(loop)f(times)
g(for)h(BSD)h(VM)300 1743 y(and)36 b(UVM)f(rise)g(to)g(8652)g
(microseconds)g(and)g(3764)g(microseconds,)j(respecti)n(v)o(ely)-6
b(.)61 b(BSD)36 b(VM')-5 b(s)300 1892 y(fork)22 b(processing)f(time)g
(increases)i(more)e(rapidly)h(than)f(UVM')-5 b(s)21 b(due)h(to)g(the)f
(e)o(xpense)h(of)g(maintaining)300 2042 y(object)i(chains.)300
2373 y Ff(10.5.2)118 b(Cluster)n(ed)31 b(P)o(ageout)300
2590 y Fs(W)-8 b(e)27 b(also)e(measured)i(the)f(performance)g(of)h
(UVM')-5 b(s)25 b(clustered)h(anon)o(ymous)e(memory)h(pageout)h(rou-)
300 2739 y(tines)i(\(described)i(earlier)f(in)g(Section)g(8.2\).)44
b(The)29 b(performance)h(of)f(anon)o(ymous)e(memory)i(pageout)300
2888 y(ef)n(fects)34 b(ho)n(w)g(quickly)f(an)h(operating)g(system)f
(responds)h(to)f(sudden)h(demands)f(for)i(memory)e(from)300
3038 y(applications)d(that)i(mak)o(e)f(hea)n(vy)h(use)f(of)h(virtual)f
(memory)g(such)g(as)h(Lisp)f(programs.)51 b(W)-8 b(e)32
b(wrote)g(a)300 3187 y(test)26 b(program)g(that)g(allocates)g(a)h(lar)n
(ge)f(\002x)o(ed-sized)h(memory)e(b)n(uf)n(fer)i(and)f(then)g(writes)g
(to)g(each)h(page)300 3337 y(of)h(the)g(b)n(uf)n(fer)-5
b(.)40 b(W)-8 b(e)29 b(then)e(timed)g(ho)n(w)h(long)f(it)h(took)f(for)h
(the)g(program)g(to)f(completely)g(initialize)g(the)300
3486 y(b)n(uf)n(fer)-5 b(.)583 3635 y(F)o(or)31 b(our)f(test)f(runs,)j
(the)e(program')-5 b(s)29 b(b)n(uf)n(fer)h(size)g(w)o(as)h(v)n(aried)e
(from)h(one)g(me)o(gabyte)f(to)h(\002fty)300 3785 y(me)o(gabytes.)58
b(Each)35 b(test)f(w)o(as)h(run)f(on)h(a)g(freshly)f(booted)g(system)f
(with)h(thirty-tw)o(o)f(me)o(gabytes)g(of)300 3934 y(RAM)25
b(that)g(w)o(as)h(running)e(only)h(an)g(X)h(serv)o(er)f(with)g(minimal)
f(applications.)31 b(The)25 b(results)g(of)g(our)h(test)300
4084 y(are)g(sho)n(wn)d(in)i(Figure)g(10.9.)583 4233
y(Since)39 b(our)f(test)f(system)g(had)h(thirty-tw)o(o)e(me)o(gabytes)g
(of)i(RAM,)g(it)g(did)f(not)g(start)h(paging)300 4382
y(until)31 b(the)i(memory)f(allocation)g(reached)h(twenty)f(me)o
(gabytes.)53 b(As)32 b(can)h(be)g(seen)g(from)f(the)h(\002gure,)300
4532 y(UVM)39 b(tak)o(es)g(signi\002cantly)f(less)h(time)f(to)h
(pageout)g(memory)f(than)h(BSD)i(VM.)d(F)o(or)i(e)o(xample,)i(it)300
4681 y(took)31 b(the)g(test)g(program)g(sixty-\002)n(v)o(e)f(seconds)h
(to)g(zero)h(a)f(\002fty)h(me)o(gabyte)e(b)n(uf)n(fer)l(,)j(where)f(as)
f(it)g(took)300 4830 y(UVM)23 b(only)f(ele)n(v)o(en)h(seconds.)30
b(One)23 b(reason)g(BSD)i(VM)e(performs)g(so)g(poorly)f(is)h(because)h
(it)f(does)g(not)300 4980 y(cluster)28 b(pageout,)g(where)g(as)g(UVM)f
(can)h(al)o(w)o(ays)g(cluster)g(by)f(dynamically)g(relocating)g(anon)o
(ymous)300 5129 y(memory)i(on)g(backing)g(store)h(as)f(needed)h(to)f
(form)h(lar)n(ge)g(clusters.)45 b(If)30 b(BSD)g(VM)f(had)h(object)f
(based)p eop
%%Page: 227 247
227 246 bop 3751 100 a Fs(227)755 2430 y @beginspecial
55 @llx 43 @lly 516 @urx 434 @ury 3227 @rwi @setspecial
%%BeginDocument: ../plots/xplotB/XplotB.eps
80 dict begin
/languagelevel where
{pop /gs_languagelevel languagelevel def}
{/gs_languagelevel 1 def} ifelse
gs_languagelevel 1 gt {
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<0000000000000000000000000000000000000000000000000000000000000000>} image end }
			>> 	matrix makepattern /Pat0 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111000044440000111100004444000011110000444400001111000044440000>} image end }
			>> 	matrix makepattern /Pat1 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<1111444411114444111144441111444411114444111144441111444411114444>} image end }
			>> 	matrix makepattern /Pat2 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555aaaa5555>} image end }
			>> 	matrix makepattern /Pat3 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbbeeeebbbb>} image end }
			>> 	matrix makepattern /Pat4 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<eeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffffeeeeffffbbbbffff>} image end }
			>> 	matrix makepattern /Pat5 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<f77dffffbeeffffff77dffffbeeffffff77dffffbeeffffff77dffffbeefffff>} image end }
			>> 	matrix makepattern /Pat6 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff>} image end }
			>> 	matrix makepattern /Pat7 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<e1e1f0f078783c3c1e1e0f0f8787c3c3e1e1f0f078783c3c1e1e0f0f8787c3c3>} image end }
			>> 	matrix makepattern /Pat8 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<87870f0f1e1e3c3c7878f0f0e1e1c3c387870f0f1e1e3c3c7878f0f0e1e1c3c3>} image end }
			>> 	matrix makepattern /Pat9 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc>} image end }
			>> 	matrix makepattern /Pat10 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffff>} image end }
			>> 	matrix makepattern /Pat11 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e7e7ebdbddbdbe7e7e7e7dbdbbdbd7e7e>} image end }
			>> 	matrix makepattern /Pat12 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebfbfdfdfefeff7f7fbfbfdfd7e7ebf>} image end }
			>> 	matrix makepattern /Pat13 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7efbfdf7fbeff7dfefbfdf7ebffd7e>} image end }
			>> 	matrix makepattern /Pat14 exch def 
<</PaintType 1 /PatternType 1 /TilingType 1
			/BBox [0 0 12 12] /XStep 12 /YStep 12 /PaintProc{ begin 
			12 12 scale 16 16 1 [16 0 0 16 0 0] 
{<fffffbdff3dfebdfdbdfbbdf7bdffbdefbddfbdbfbd7fbcffbdfffffffffffff>} image end }
			>> 	matrix makepattern /Pat15 exch def 
}{
/Pat0 { 0.000000 setgray } def
/Pat1 { 0.062500 setgray } def
/Pat2 { 0.125000 setgray } def
/Pat3 { 0.187500 setgray } def
/Pat4 { 0.250000 setgray } def
/Pat5 { 0.312500 setgray } def
/Pat6 { 0.375000 setgray } def
/Pat7 { 0.437500 setgray } def
/Pat8 { 0.500000 setgray } def
/Pat9 { 0.562500 setgray } def
/Pat10 { 0.625000 setgray } def
/Pat11 { 0.687500 setgray } def
/Pat12 { 0.750000 setgray } def
/Pat13 { 0.812500 setgray } def
/Pat14 { 0.875000 setgray } def
/Pat15 { 0.937500 setgray } def
/setpattern { } def
} ifelse
/m {moveto} bind def
/l {lineto} bind def
/s {stroke} bind def
% Symbol fill
/f { gsave fill grestore stroke } bind def
% Opaque symbol
/o { gsave 1.000000 1.000000 1.000000 setrgbcolor
     fill grestore stroke } bind def
% Circle symbol
/a { 3 -1 roll 0 360 arc } bind def
/da { a s } bind def
/fa { a f } bind def
/oa { a o } bind def
% Square symbol
/sq { moveto dup dup rmoveto 2 mul
      dup neg 0 rlineto dup neg 0 exch rlineto
      0 rlineto closepath } bind def
/dsq { sq s } bind def
/fsq { sq f } bind def
/osq { sq o } bind def
% Triangle symbols
/t1 { moveto dup 0 exch rmoveto
      dup neg dup 2 mul rlineto 2 mul 0 rlineto
      closepath } bind def
/dt1 { t1 s } bind def
/ft1 { t1 f } bind def
/ot1 { t1 o } bind def
/t2 { moveto dup neg 0 rmoveto
      dup dup 2 mul exch neg rlineto
      2 mul 0 exch rlineto closepath } bind def
/dt2 { t2 s } bind def
/ft2 { t2 f } bind def
/ot2 { t2 o } bind def
/t3 { moveto dup neg 0 exch rmoveto
      dup dup 2 mul rlineto neg 2 mul 0 rlineto
      closepath } bind def
/dt3 { t3 s } bind def
/ft3 { t3 f } bind def
/ot3 { t3 o } bind def
/t4 { moveto dup 0 rmoveto
      dup dup -2 mul exch rlineto
      -2 mul 0 exch rlineto closepath } bind def
/dt4 { t4 s } bind def
/ft4 { t4 f } bind def
/ot4 { t4 o } bind def
% Diamond symbol
/di { moveto dup 0 exch rmoveto
      dup neg dup rlineto dup dup neg rlineto
      dup dup rlineto closepath } bind def
/ddi { di s } bind def
/fdi { di f } bind def
/odi { di o } bind def
% Plus symbol
/pl { dup 0 rmoveto dup -2 mul 0 rlineto
      dup dup rmoveto -2 mul 0 exch rlineto
    } bind def
/dpl { m pl s } bind def
% x symbol
/x { dup dup rmoveto dup -2 mul dup rlineto
     2 mul dup 0 rmoveto dup neg exch rlineto
   } bind def
/dx { m x s } bind def
% Splat symbol
/dsp { m dup pl dup 0 exch rmoveto 0.707 mul x s
     } bind def
/RJ {
 stringwidth neg exch neg exch
 rmoveto
} bind def
/CS {
 stringwidth
 2 div neg exch 2 div neg exch
 rmoveto
} bind def
0.24 0.24 scale
1 setlinecap

	mark             
	/ISOLatin1Encoding 
	  8#000 1 8#054 {StandardEncoding exch get} for 
	  /minus 
	  8#056 1 8#217 {StandardEncoding exch get} for 
	  /dotlessi 
	  8#301 1 8#317 {StandardEncoding exch get} for 
	  /space /exclamdown /cent /sterling /currency /yen /brokenbar /section 
	  /dieresis /copyright /ordfeminine /guillemotleft /logicalnot /hyphen 
	  /registered /macron /degree /plusminus /twosuperior /threesuperior /acute 
	  /mu /paragraph /periodcentered /cedilla /onesuperior /ordmasculine 
	  /guillemotright /onequarter /onehalf /threequarters /questiondown /Agrave 
	  /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla /Egrave /Eacute
	  /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde
	  /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave 
	  /Uacute /Ucircumflex /Udieresis /Yacute /Thorn /germandbls /agrave /aacute 
	  /acircumflex /atilde /adieresis /aring /ae /ccedilla /egrave /eacute 
	  /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis /eth /ntilde
	  /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave 
	  /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis 
	  /ISOLatin1Encoding where not {256 array astore def} if 
	 cleartomark 

	/makeISOEncoded 
	{ findfont /curfont exch def 
	  /newfont curfont maxlength dict def  
	  /ISOLatin1 (-ISOLatin1) def
	  /curfontname curfont /FontName get dup length string cvs def 
	  /newfontname curfontname length ISOLatin1 length add string 
    	 dup 0                  curfontname putinterval 
    	 dup curfontname length ISOLatin1   putinterval 
	  def 
	  curfont   
	  { exch dup /FID ne  
    	{ dup /Encoding eq  
    	  { exch pop ISOLatin1Encoding exch }  
    	  if  
    	  dup /FontName eq  
    	  { exch pop newfontname exch }  
    	  if  
    	  exch newfont 3 1 roll put  
    	}  
    	{ pop pop }  
    	ifelse  
	  }  
	  forall 
	  newfontname newfont definefont 
	} def 

	/Times-Roman makeISOEncoded pop 
	/Times-Bold makeISOEncoded pop 
	/Times-Italic makeISOEncoded pop 
	/Times-BoldItalic makeISOEncoded pop 
	/Helvetica makeISOEncoded pop 
	/Helvetica-Bold makeISOEncoded pop 
	/Helvetica-Oblique makeISOEncoded pop 
	/Helvetica-BoldOblique makeISOEncoded pop 
s
0.000000 0.000000 0.000000 setrgbcolor
1 setlinewidth
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
[] 0 setdash
435 375 m
435 385 l
602 375 m
602 385 l
771 375 m
771 385 l
939 375 m
939 385 l
1106 375 m
1106 385 l
1275 375 m
1275 385 l
1442 375 m
1442 385 l
1610 375 m
1610 385 l
1779 375 m
1779 385 l
1946 375 m
1946 385 l
2115 375 m
2115 385 l
435 1775 m
435 1765 l
602 1775 m
602 1765 l
771 1775 m
771 1765 l
939 1775 m
939 1765 l
1106 1775 m
1106 1765 l
1275 1775 m
1275 1765 l
1442 1775 m
1442 1765 l
1610 1775 m
1610 1765 l
1779 1775 m
1779 1765 l
1946 1775 m
1946 1765 l
2115 1775 m
2115 1765 l
s
435 375 m
435 395 l
771 375 m
771 395 l
1106 375 m
1106 395 l
1442 375 m
1442 395 l
1779 375 m
1779 395 l
2115 375 m
2115 395 l
435 1775 m
435 1755 l
771 1775 m
771 1755 l
1106 1775 m
1106 1755 l
1442 1775 m
1442 1755 l
1779 1775 m
1779 1755 l
2115 1775 m
2115 1755 l
/Times-Italic-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
435 325 m
gsave
435 325 translate
0 rotate
0 -20  m
(0) CS
(0) show
grestore
newpath
771 325 m
gsave
771 325 translate
0 rotate
0 -20  m
(10) CS
(10) show
grestore
newpath
1106 325 m
gsave
1106 325 translate
0 rotate
0 -20  m
(20) CS
(20) show
grestore
newpath
1442 325 m
gsave
1442 325 translate
0 rotate
0 -20  m
(30) CS
(30) show
grestore
newpath
1779 325 m
gsave
1779 325 translate
0 rotate
0 -20  m
(40) CS
(40) show
grestore
newpath
2115 325 m
gsave
2115 325 translate
0 rotate
0 -20  m
(50) CS
(50) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1275 225 m
gsave
1275 225 translate
0 rotate
0 0  m
(memory allocation \(MB\)) CS
(memory allocation \(MB\)) show
grestore
newpath
435 375 m
445 375 l
435 550 m
445 550 l
435 725 m
445 725 l
435 900 m
445 900 l
435 1075 m
445 1075 l
435 1250 m
445 1250 l
435 1425 m
445 1425 l
435 1600 m
445 1600 l
435 1775 m
445 1775 l
2115 375 m
2105 375 l
2115 550 m
2105 550 l
2115 725 m
2105 725 l
2115 900 m
2105 900 l
2115 1075 m
2105 1075 l
2115 1250 m
2105 1250 l
2115 1425 m
2105 1425 l
2115 1600 m
2105 1600 l
2115 1775 m
2105 1775 l
s
435 375 m
455 375 l
435 725 m
455 725 l
435 1075 m
455 1075 l
435 1425 m
455 1425 l
435 1775 m
455 1775 l
2115 375 m
2095 375 l
2115 725 m
2095 725 l
2115 1075 m
2095 1075 l
2115 1425 m
2095 1425 l
2115 1775 m
2095 1775 l
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
s
397 375 m
gsave
397 375 translate
0 rotate
0 -20  m
(0) RJ
(0) show
grestore
newpath
397 725 m
gsave
397 725 translate
0 rotate
0 -20  m
(20) RJ
(20) show
grestore
newpath
397 1075 m
gsave
397 1075 translate
0 rotate
0 -20  m
(40) RJ
(40) show
grestore
newpath
397 1425 m
gsave
397 1425 translate
0 rotate
0 -20  m
(60) RJ
(60) show
grestore
newpath
397 1775 m
gsave
397 1775 translate
0 rotate
0 -20  m
(80) RJ
(80) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
293 1075 m
gsave
293 1075 translate
90 rotate
0 0  m
(time \(seconds\)) CS
(time \(seconds\)) show
grestore
newpath
468 375 m
602 377 l
771 379 l
939 380 l
1106 590 l
1275 561 l
1442 832 l
1610 991 l
1779 1125 l
1946 1387 l
2115 1520 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
14 468 375 fa
14 602 377 fa
14 771 379 fa
14 939 380 fa
14 1106 590 fa
14 1275 561 fa
14 1442 832 fa
14 1610 991 fa
14 1779 1125 fa
14 1946 1387 fa
14 2115 1520 fa
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
468 376 m
602 377 l
771 378 l
939 380 l
1106 407 l
1275 409 l
1442 433 l
1610 473 l
1779 497 l
1946 516 l
2115 564 l
/Helvetica-ISOLatin1 findfont 44 scalefont setfont
s
12 468 376 fsq
12 602 377 fsq
12 771 378 fsq
12 939 380 fsq
12 1106 407 fsq
12 1275 409 fsq
12 1442 433 fsq
12 1610 473 fsq
12 1779 497 fsq
12 1946 516 fsq
12 2115 564 fsq
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
0.000000 0.000000 0.000000 setrgbcolor
435 375 m
435 1775 l
2115 1775 l
2115 375 l
435 375 l
s
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
602 1600 m
742 1600 l
s
14 602 1600 fa
14 742 1600 fa
777 1600 m
gsave
777 1600 translate
0 rotate
0 -20  m
(BSD VM) show
grestore
newpath
/Helvetica-ISOLatin1 findfont 60 scalefont setfont
1.000000 0.000000 0.000000 setrgbcolor
602 1526 m
742 1526 l
s
12 602 1526 fsq
12 742 1526 fsq
0.000000 0.000000 0.000000 setrgbcolor
777 1526 m
gsave
777 1526 translate
0 rotate
0 -20  m
(UVM) show
grestore
newpath
end
showpage
%%EndDocument
 @endspecial 819 2634 a(Figure)25 b(10.9:)30 b(Memory)24
b(allocation)f(time)h(under)h(BSD)h(VM)e(and)h(UVM)300
3029 y(clustering)20 b(its)g(performance)h(w)o(ould)f(impro)o(v)o(e,)g
(pro)o(vided)g(that)g(the)h(pagedaemon)f(found)h(contiguous)300
3178 y(dirty)j(pages)h(to)f(b)n(uild)g(clusters)g(around.)300
3509 y Ff(10.5.3)118 b(Resident)31 b(P)o(age)f(F)m(aulting)300
3726 y Fs(The)h(number)g(of)g(times)f(the)h(f)o(ault)g(routine)f(is)h
(called)g(under)g(UVM)g(is)f(less)h(than)g(under)g(BSD)h(VM.)300
3875 y(In)j(Section)f(5.1.5)g(we)g(described)h(ho)n(w)e(the)i(UVM)f(f)o
(ault)g(routine)g(maps)f(in)i(neighboring)e(resident)300
4025 y(pages)h(to)f(reduce)h(the)f(number)g(of)h(page)g(f)o(aults)f
(that)g(a)h(program)f(tak)o(es.)57 b(On)33 b(the)g(other)h(hand,)h(the)
300 4174 y(BSD)h(VM)e(f)o(ault)h(routine)g(ne)n(v)o(er)f(maps)g(in)h
(an)o(y)f(additional)g(pages.)61 b(Furthermore,)38 b(the)d(BSD)h(VM)300
4324 y(f)o(ault)23 b(routine)f(is)h(also)g(used)f(to)h(f)o(ault)g(user)
n(-le)n(v)o(el)f(page)h(tables)g(into)f(a)h(process')g(address)g(space)
h(for)f(the)300 4473 y(old)29 b(i386)g(pmap)f(module.)44
b(T)-8 b(able)30 b(10.1)e(sho)n(ws)h(some)f(f)o(ault)i(counts)e(for)i
(a)g(fe)n(w)f(small)g(applications.)300 4622 y(Note)j(that)g(UVM)g
(currently)g(only)f(reduces)i(the)f(page)h(f)o(ault)f(count)f(for)i
(pages)f(that)g(are)h(already)f(in)300 4772 y(memory)25
b(\(resident\).)33 b(Once)25 b(the)h(BSD)g(I/O)g(system)e(is)h
(modi\002ed)g(to)g(support)g(asynchronous)f(pagein)300
4921 y(UVM)31 b(could)g(be)h(easily)f(modi\002ed)g(to)g(start)h(pagein)
f(I/O)h(operations)e(for)i(non-resident)f(pages)h(that)300
5071 y(are)26 b(e)o(xpected)e(to)g(be)h(needed)g(soon.)p
eop
%%Page: 228 248
228 247 bop 3751 100 a Fs(228)390 300 y(T)-8 b(able)25
b(10.1:)30 b(P)o(age)25 b(f)o(ault)f(counts.)30 b(The)25
b Fm(cc)g Fs(command)e(w)o(as)i(run)g(on)f(a)i(\223hello)e(w)o
(orld\224)h(program.)p 980 432 2215 4 v 978 553 4 121
v 1030 517 a Fo(Command)p 1795 553 V 369 w(BSD)g(VM)g(F)n(aults)p
2568 553 V 99 w(UVM)g(F)n(aults)p 3193 553 V 980 556
2215 4 v 978 676 4 121 v 1030 640 a Fm(ls)59 b(/)p 1795
676 V 864 w Fs(59)p 2568 676 V 599 w(33)p 3193 676 V
980 680 2215 4 v 978 800 4 121 v 1030 764 a Fm(finger)f(chuck)p
1795 800 V 360 w Fs(128)p 2568 800 V 574 w(74)p 3193
800 V 980 804 2215 4 v 978 924 4 121 v 1030 888 a Fm(cc)p
1795 924 V 934 w Fs(1086)p 2568 924 V 523 w(590)p 3193
924 V 980 927 2215 4 v 978 1048 4 121 v 1030 1011 a Fm(man)h(csh)p
1795 1048 V 659 w Fs(114)p 2568 1048 V 574 w(64)p 3193
1048 V 980 1051 2215 4 v 978 1171 4 121 v 1030 1135 a
Fm(newaliases)p 1795 1171 V 478 w Fs(229)p 2568 1171
V 549 w(127)p 3193 1171 V 980 1175 2215 4 v 300 1548
a Ff(10.5.4)118 b(Map)30 b(Entry)g(Fragmentation)300
1765 y Fs(In)j(Section)h(8.8)f(and)g(Section)h(8.9)f(we)g(discussed)g
(ho)n(w)f(UVM)h(a)n(v)n(oids)g(map)g(entry)g(fragmentation)300
1914 y(in)28 b(k)o(ernel)h(maps)e(and)i(for)f(wired)h(memory)-6
b(.)40 b(Map)28 b(entry)h(fragmentation)e(is)h(undesirable)g(because)h
(it)300 2064 y(w)o(astes)i(k)o(ernel)g(memory)f(and)h(increases)g
(virtual)f(address)h(lookup)e(time)h(in)h(VM)f(maps.)49
b(T)-8 b(o)31 b(v)o(erify)300 2213 y(that)22 b(UVM)f(reduces)i(map)e
(entry)h(fragmentation,)g(we)g(modi\002ed)g(both)f(UVM)h(and)g(BSD)h
(VM)e(to)h(k)o(eep)300 2362 y(count)k(of)g(the)g(number)g(of)h(map)f
(entries)g(currently)g(allocated.)35 b(W)-8 b(e)26 b(counted)g(both)g
(the)g(total)g(number)300 2512 y(of)31 b(allocated)f(map)g(entries,)i
(and)f(the)f(number)g(of)h(statically)f(allocated)g(map)g(entries)h
(that)f(are)h(used)300 2661 y(e)o(xclusi)n(v)o(ely)22
b(by)j(the)f(k)o(ernel.)583 2811 y(W)-8 b(e)40 b(measured)g(the)f
(number)g(of)g(allocated)g(map)g(entries)g(in)h(\002)n(v)o(e)e(cases,)
44 b(with)38 b(a)i(v)n(arying)300 2960 y(number)24 b(of)h(acti)n(v)o(e)
f(processes.)31 b(These)24 b(cases)h(are:)420 3192 y(1.)49
b(in)24 b(single)g(user)h(mode)f(\227)h(four)g(processes.)420
3425 y(2.)49 b(after)25 b(booting)f(multiuser)l(,)f(before)i(logging)f
(in)g(\227)h(eighteen)f(processes.)420 3657 y(3.)49 b(after)25
b(logging)f(in)g(and)h(starting)f(X)g(\227)h(twenty-se)n(v)o(en)e
(processes.)420 3890 y(4.)49 b(running)24 b(a)h(single)f(\223)p
Fm(cat)p Fs(\224)g(process)h(from)g(X)g(\227)f(twenty-eight)g
(processes.)420 4122 y(5.)49 b(running)24 b(ten)g(\223)p
Fm(cat)p Fs(\224)h(processes)g(from)f(X)h(\227)g(thirty-se)n(v)o(en)e
(processes.)300 4355 y(When)h(measuring)f(the)g(number)h(of)f(map)h
(entries)f(under)h(BSD)h(VM,)e(we)h(did)f(not)g(count)h(the)f(map)h
(en-)300 4504 y(tries)d(allocated)h(for)g(the)g(\223b)n(uf)n(fer)g
(map\224)g(\(see)g(Section)g(8.10.1\).)29 b(The)21 b(results)h(of)f
(these)h(measurements)300 4653 y(are)k(sho)n(wn)d(in)i(T)-8
b(able)24 b(10.2.)583 4803 y(The)g(number)f(of)h(statically)f
(allocated)g(map)h(entries)f(under)h(UVM)f(remains)g(nearly)h(constant)
300 4952 y(\(se)n(v)o(enteen)k(or)g(eighteen\))h(as)f(the)h(number)f
(of)g(processes)h(on)f(the)g(system)f(increases.)43 b(On)28
b(the)g(other)300 5101 y(hand,)21 b(the)g(number)f(of)g(statically)g
(allocated)g(map)g(entries)h(under)f(BSD)i(VM)e(gro)n(ws)f(with)h(the)h
(number)300 5251 y(of)30 b(processes,)h(reaching)e(ninety-four)h
(entries)f(when)h(there)g(are)g(thirty-se)n(v)o(en)e(processes)i(acti)n
(v)o(e)e(on)p eop
%%Page: 229 249
229 248 bop 3751 100 a Fs(229)300 300 y(T)-8 b(able)25
b(10.2:)k(Comparison)24 b(of)h(the)f(number)g(of)h(allocated)f(map)g
(entries)g(\(the)h(BSD)g(VM)g(numbers)e(do)300 421 y(not)h(include)g
(859)h(dynamically)e(allocated)i(map)f(entries)h(used)f(for)h(the)g(b)n
(uf)n(fer)g(map\))p 526 553 3124 4 v 524 673 4 121 v
576 637 a Fo(System)g(State)p 1824 673 V 755 w(Number)h(of)p
2386 673 V 450 w(Number)g(of)p 3647 673 V 524 794 V 1824
794 V 1905 757 a(Pr)n(ocesses)p 2386 794 V 230 w(Allocated)f(Map)g
(Entries)p 3647 794 V 2387 797 1262 4 v 524 914 4 121
v 1824 914 V 2386 914 V 2581 878 a(Static)p 3017 914
V 401 w(T)-9 b(otal)p 3647 914 V 524 1034 V 1824 1034
V 2386 1034 V 2437 998 a(BSD)p 2679 1034 V 100 w(UVM)p
3017 1034 V 100 w(BSD)p 3310 1034 V 100 w(UVM)p 3647
1034 V 526 1038 3124 4 v 524 1158 4 121 v 576 1122 a
Fs(Single-user)24 b(prompt)p 1824 1158 V 739 w(4)p 2386
1158 V 352 w(28)p 2679 1158 V 216 w(14)p 3017 1158 V
215 w(50)p 3310 1158 V 216 w(26)p 3647 1158 V 526 1161
3124 4 v 524 1282 4 121 v 576 1246 a(multiuser)l(,)f(no)i(logins)e(yet)
p 1824 1282 V 544 w(18)p 2386 1282 V 327 w(57)p 2679
1282 V 216 w(17)p 3017 1282 V 190 w(400)p 3310 1282 V
166 w(242)p 3647 1282 V 526 1285 3124 4 v 524 1405 4
121 v 576 1369 a(after)i(starting)f(X)p 1824 1405 V 878
w(27)p 2386 1405 V 327 w(74)p 2679 1405 V 216 w(18)p
3017 1405 V 190 w(675)p 3310 1405 V 166 w(428)p 3647
1405 V 526 1409 3124 4 v 524 1529 4 121 v 576 1493 a(running)g(1)g
(\223)p Fm(cat)p Fs(\224)p 1824 1529 V 804 w(28)p 2386
1529 V 327 w(76)p 2679 1529 V 216 w(17)p 3017 1529 V
190 w(686)p 3310 1529 V 166 w(433)p 3647 1529 V 526 1532
3124 4 v 524 1653 4 121 v 576 1617 a(running)g(10)g(\223)p
Fm(cat)p Fs(\224)p 1824 1653 V 754 w(37)p 2386 1653 V
327 w(94)p 2679 1653 V 216 w(17)p 3017 1653 V 190 w(785)p
3310 1653 V 166 w(487)p 3647 1653 V 526 1656 3124 4 v
300 2030 a(the)32 b(system.)53 b(This)31 b(is)h(due)h(to)f(the)g(w)o
(ay)h(BSD)g(VM)f(wires)g(each)h(process')g(\223)p Fm(user)p
Fs(\224)f(structure)g(into)300 2179 y(k)o(ernel)25 b(memory)-6
b(.)583 2329 y(The)25 b(total)e(number)h(of)g(allocated)g(map)g
(entries)g(rises)g(with)f(the)h(number)g(of)g(acti)n(v)o(e)f(processes)
300 2478 y(for)34 b(both)e(BSD)j(VM)e(and)g(UVM,)g(with)g(BSD)h(VM')-5
b(s)33 b(map)g(entry)g(allocation)g(rising)f(more)i(rapidly)300
2627 y(than)28 b(UVM')-5 b(s.)39 b(F)o(or)28 b(e)o(xample,)g(for)g
(thirty-se)n(v)o(en)e(processes)i(BSD)h(VM)e(requires)h(785)g(map)f
(entries,)300 2777 y(while)d(UVM)h(requires)f(only)g(487.)300
3160 y Fg(10.6)143 b(UVM)35 b(Compar)m(ed)f(to)h(Related)f(W)-11
b(ork)300 3413 y Fs(Comparing)22 b(the)h(performance)g(of)f(UVM)h(data)
f(mo)o(v)o(ement)f(mechanisms)g(with)h(related)h(w)o(ork)f(is)g(dif-)
300 3562 y(\002cult)29 b(due)g(to)g(the)g(wide)g(v)n(ariety)f(of)h
(hardw)o(are)h(platforms)e(and)h(dif)n(ferent)g(testing)f(procedures)h
(used)300 3712 y(across)e(projects.)35 b(Ho)n(we)n(v)o(er)l(,)25
b(we)i(can)g(mak)o(e)f(some)g(rough)g(estimates)g(of)g(relati)n(v)o(e)g
(performance)h(im-)300 3861 y(pro)o(v)o(ements)i(based)i(on)g(our)f
(results)h(and)g(results)f(published)f(in)i(the)g(literature.)49
b(F)o(or)31 b(e)o(xample,)g(the)300 4010 y(Solaris)h(zero-cop)o(y)g
(TCP)g(mechanism)f(with)g(checksum)g(in)h(hardw)o(are)g([14])g
(produces)g(a)g(f)o(actor)g(of)300 4160 y(1.4)g(impro)o(v)o(ement)d(o)o
(v)o(er)i(data)h(cop)o(ying.)52 b(UVM')-5 b(s)31 b(page)h(loanout)f(f)o
(acility)g(\(without)g(the)h(o)o(v)o(erhead)300 4309
y(of)h(protocol)f(processing\))g(produces)h(a)g(f)o(actor)g(of)g(2.6)f
(impro)o(v)o(ement)f(for)i(the)f(same)h(transfer)g(size.)300
4459 y(In)c(the)h(Container)f(Shipping)f(project)i([3])f(the)g
(performance)h(of)g(an)f(IPC)i(pipe)e(using)f(the)h(container)300
4608 y(shipping)c(mechanism)g(to)h(send,)h(recei)n(v)o(e,)g(and)f(both)
g(send)g(and)h(recei)n(v)o(e)f(w)o(as)h(compared)f(to)g(the)h(per)n(-)
300 4757 y(formance)k(of)f(using)f(data)i(cop)o(ying.)46
b(The)30 b(reported)h(impro)o(v)o(ement)c(f)o(actors)k(are)g(1.2,)g
(1.6,)g(and)g(8.3,)300 4907 y(respecti)n(v)o(ely)-6 b(.)69
b(A)39 b(comparable)f(e)o(xperiment)f(under)h(UVM)g(using)f(page)i
(loanout,)h(page)f(transfer)l(,)300 5056 y(and)28 b(both)f(mechanisms)f
(at)i(the)g(same)f(time)g(produced)h(impro)o(v)o(ement)d(f)o(actors)j
(of)g(2.1,)g(1.7,)g(and)f(14.)300 5206 y(Other)j(projects)g(report)h
(results)f(that)g(appear)h(to)f(be)h(comparable.)47 b(Our)31
b(rough)f(comparisons)f(sho)n(w)300 5355 y(that)24 b(UVM)h(produces)f
(impro)o(v)o(ements)e(on)j(the)f(same)h(order)g(of)g(magnitude)f(as)g
(the)h(related)g(w)o(ork.)p eop
%%Page: 230 250
230 249 bop 3751 100 a Fs(230)300 249 y Fg(10.7)143 b(Summary)300
502 y Fs(In)36 b(this)f(chapter)h(we)g(ha)n(v)o(e)f(described)h(a)g
(set)g(of)f(tests)g(that)h(sho)n(w)e(the)i(impro)o(v)o(ed)e
(performance)i(of)300 651 y(UVM.)g(W)-8 b(e)36 b(sho)n(wed)f(that)h
(page)g(loanout)f(and)h(transfer)h(tests)e(using)g(null)h(sock)o(ets)f
(and)h(protocols)300 800 y(can)31 b(achie)n(v)o(e)e(greater)i
(bandwidth)e(when)i(mo)o(ving)d(page-sized)i(chunks)g(of)g(data.)48
b(W)-8 b(e)30 b(sho)n(wed)g(that)300 950 y(page)37 b(loanout)e(and)h
(page)h(transfer)g(can)f(be)h(used)f(to)g(impro)o(v)o(e)e(the)j
(performance)f(of)h(a)g(pipe.)65 b(W)-8 b(e)300 1099
y(sho)n(wed)35 b(that)g(map)g(entry)h(passing)e(can)j(be)e(used)h(to)f
(quickly)g(transfer)h(part)f(of)h(a)g(virtual)f(address)300
1249 y(space)30 b(between)f(processes,)h(and)f(that)g(map)g(entry)g
(passing)f(can)i(be)f(combined)f(with)h(page)g(loanout)300
1398 y(in)e(a)g(data)g(pipeline.)37 b(W)-8 b(e)28 b(also)f(sho)n(wed)f
(ho)n(w)g(UVM')-5 b(s)26 b(secondary)h(design)g(elements)f(impro)o(v)o
(e)f(BSD)300 1547 y(k)o(ernel)g(performance)g(for)g(forking,)f
(clustered)h(pageout,)f(f)o(aulting,)g(and)h(map)f(entry)h(allocation.)
583 1697 y(Applications)32 b(that)h(mo)o(v)o(e)f(lar)n(ge)j(chunks)d
(of)i(data)g(can)g(bene\002t)g(by)f(using)f(one)i(or)g(more)f(of)300
1846 y(UVM')-5 b(s)20 b(three)h(data)g(mo)o(v)o(ement)d(mechanisms)h
(instead)i(of)f(data)h(cop)o(ying.)29 b(The)20 b(page)h(loanout)f
(mech-)300 1996 y(anism)f(can)h(be)f(used)g(without)f(an)i(API)g
(change)g(if)f(the)h(k)o(ernel)f(is)h(modi\002ed)e(to)i(automatically)d
(use)j(page)300 2145 y(loanout)h(rather)h(than)f(a)h(data)g(cop)o(y)g
(for)g(lar)n(ge)g(requests.)29 b(The)22 b(page)g(transfer)g(mechanism)f
(can)h(also)f(be)300 2294 y(used)28 b(without)e(an)j(API)f(change)g
(when)g(the)g(data)g(b)n(uf)n(fer)g(is)g(properly)g(aligned.)39
b(T)-8 b(o)28 b(tak)o(e)g(full)g(bene\002t)300 2444 y(of)22
b(all)f(three)h(mechanisms)e(ne)n(w)h(system)g(calls)g(should)f(be)i
(added)f(to)h(the)f(k)o(ernel)h(that)f(allo)n(w)f(a)i(process)300
2593 y(to)i(e)o(xplicitly)f(control)h(its)g(data)h(mo)o(v)o(ement.)583
2742 y(T)-8 b(o)33 b(deri)n(v)o(e)e(maximum)g(bene\002t)i(from)f(UVM')
-5 b(s)31 b(ne)n(w)h(mechanisms)f(applications)g(program-)300
2892 y(mers)25 b(should)e(note)i(the)f(follo)n(wing)f(guidelines:)445
3124 y Fr(\017)49 b Fs(Because)31 b(applications)e(using)g(UVM')-5
b(s)29 b(data)h(mo)o(v)o(ement)d(mechanisms)i(bene\002t)h(most)f(when)
544 3274 y(the)34 b(size)g(of)f(the)h(data)g(being)g(transferred)g(is)f
(lar)n(ger)i(than)e(the)h(cache,)j(we)d(recommend)g(that)544
3423 y(applications)22 b(that)g(use)h(UVM')-5 b(s)22
b(mechanisms)g(use)h(lar)n(ge)g(multi-page)f(b)n(uf)n(fers.)30
b(F)o(or)23 b(e)o(xample,)544 3572 y(consider)28 b(a)g(video)g(serv)o
(er)g(application)f(that)h(transmits)e(a)j(memory)e(mapped)h(video)f
(\002le)i(o)o(v)o(er)544 3722 y(the)c(netw)o(ork)g(using)f(page)i
(loanout.)31 b(Rather)26 b(than)f(transmitting)e(the)i(\002le)h(one)f
(page)h(at)f(a)h(time,)544 3871 y(the)h(application)f(should)h
(transmit)f(it)h(in)g(lar)n(ge)h(multi-page)e(chunks)h(so)g(that)g(UVM)
g(will)f(loan)544 4021 y(out)g(multiple)f(pages)i(at)f(the)h(same)f
(time.)36 b(On)26 b(the)h(other)f(hand,)h(applications)e(that)i(do)f
(not)g(use)544 4170 y(UVM')-5 b(s)29 b(ne)n(w)h(mechanisms)e(\(and)i
(therefore)h(must)e(cop)o(y)h(data\))g(should)f(choose)h(data)g(b)n(uf)
n(fer)544 4319 y(sizes)k(so)g(that)g(both)f(the)h(source)h(and)f
(destination)f(b)n(uf)n(fers)h(are)h(small)e(enough)h(to)g(\002t)g(in)g
(the)544 4469 y(cache.)d(This)24 b(allo)n(ws)g(programs)g(to)h(tak)o(e)
f(adv)n(antage)h(of)g(the)f(speed)h(of)g(cache)h(memory)-6
b(.)445 4701 y Fr(\017)49 b Fs(Map)22 b(entry)g(passing)g(should)f(be)i
(used)f(for)g(interprocess)g(communication,)f(and)i(not)e(for)i(trans-)
544 4851 y(ferring)e(memory)g(to)f(hardw)o(are)i(de)n(vices.)29
b(Map)21 b(entry)g(passing)f(is)h(preferable)h(to)f(page)g(loanout)544
5000 y(and)k(page)f(transfer)i(when)e(memory)g(is)g(to)h(be)g(shared)f
(or)h(when)g(the)f(re)o(gion)g(being)h(transferred)544
5149 y(is)f(v)o(ery)h(lar)n(ge)g(\(multi-me)o(gabyte\))d(or)j(contains)
f(unmapped)g(areas.)p eop
%%Page: 231 251
231 250 bop 3751 100 a Fs(231)445 249 y Fr(\017)49 b
Fs(P)o(age)26 b(loanout)f(and)g(page)h(transfer)h(should)d(be)i(used)g
(when)f(passing)g(copies)g(of)h(data)g(between)544 398
y(processes)38 b(or)h(when)f(passing)f(copies)h(of)h(data)f(between)h
(processes)f(and)g(de)n(vices.)71 b(These)544 548 y(mechanisms)28
b(should)f(be)j(used)f(for)g(interprocess)f(communication)f(when)i(the)
g(re)o(gion)g(being)544 697 y(transferred)c(is)g(a)g(medium-sized)e
(contiguous)g(re)o(gion)h(of)h(virtual)f(memory)-6 b(.)p
eop
%%Page: 232 252
232 251 bop 3751 100 a Fs(232)300 973 y Fp(Chapter)51
b(11)300 1448 y(Conclusions)i(and)f(Futur)l(e)f(Resear)l(ch)300
1930 y Fs(In)29 b(this)g(dissertation)f(we)h(ha)n(v)o(e)g(presented)g
(the)h(design)e(and)i(implementation)c(of)k(the)f(UVM)g(virtual)300
2079 y(memory)c(system.)35 b(UVM)25 b(w)o(as)i(designed)e(to)h(meet)g
(the)g(needs)h(of)f(ne)n(w)g(computer)g(applications)f(that)300
2229 y(require)j(data)f(to)g(be)h(mo)o(v)o(ed)e(in)h(b)n(ulk)f(through)
h(the)g(k)o(ernel')-5 b(s)27 b(I/O)g(system.)38 b(Our)27
b(no)o(v)o(el)f(approach)i(fo-)300 2378 y(cuses)j(on)g(allo)n(wing)e
(processes)i(to)f(pass)h(memory)f(to)h(and)g(from)g(other)f(processes)h
(and)g(the)g(k)o(ernel,)300 2527 y(and)25 b(to)f(share)h(memory)-6
b(.)29 b(The)c(memory)f(passed)g(or)h(shared)g(may)f(be)h(a)g(block)f
(of)h(pages,)g(or)f(it)h(may)f(be)300 2677 y(a)j(chunk)f(of)h(virtual)e
(memory)h(space)h(that)f(may)g(not)g(be)h(entirely)f(mapped.)35
b(This)26 b(approach)h(reduces)300 2826 y(or)d(eliminates)e(the)i(need)
g(to)f(cop)o(y)h(data)f(thus)g(reducing)h(the)f(time)g(spent)g(within)g
(the)h(k)o(ernel)f(and)h(free-)300 2976 y(ing)k(up)h(c)o(ycles)f(for)i
(application)d(processing.)43 b(Unlik)o(e)28 b(the)h(approaches)g(that)
f(focus)h(e)o(xclusi)n(v)o(ely)d(on)300 3125 y(the)f(netw)o(orking)g
(subsystem,)e(our)j(approach)g(pro)o(vides)e(a)i(general)f(solution)f
(that)h(can)h(impro)o(v)o(e)e(ef)n(\002-)300 3274 y(cienc)o(y)29
b(of)g(the)f(entire)h(I/O)g(subsystem.)42 b(UVM)28 b(also)h(impro)o(v)o
(es)e(the)h(k)o(ernel')-5 b(s)29 b(o)o(v)o(erall)f(performance)300
3424 y(in)i(other)g(k)o(e)o(y)g(areas.)49 b(In)30 b(this)g(chapter)g
(we)h(describe)g(the)f(contrib)n(utions)e(of)j(the)f(UVM)g(project)g
(and)300 3573 y(directions)24 b(for)h(future)g(research.)300
3957 y Fg(11.1)143 b(Contrib)m(utions)300 4209 y Fs(UVM)36
b(pro)o(vides)f(the)i(BSD)g(k)o(ernel)g(with)f(three)h(ne)n(w)f
(mechanisms)f(that)h(allo)n(w)g(processes)g(to)g(e)o(x-)300
4359 y(change)f(and)f(share)h(paged-sized)f(chunks)g(of)h(memory)e
(without)g(data)i(copies.)59 b(These)35 b(three)g(ne)n(w)300
4508 y(mechanisms)29 b(are)i(page)f(loanout,)h(page)f(transfer)l(,)i
(and)e(map)g(entry)g(passing.)46 b(The)30 b(design)g(of)g(these)300
4657 y(mechanisms)h(w)o(as)h(based)g(on)g(se)n(v)o(eral)f(k)o(e)o(y)h
(principles)f(that)g(we)i(belie)n(v)o(e)e(should)g(be)h(applicable)f
(to)300 4807 y(other)25 b(operating)f(systems:)445 5039
y Fr(\017)49 b Fs(First,)30 b(although)d(traditional)h(virtual)g
(memory)g(systems)g(operate)h(at)g(a)g(mapping-le)n(v)o(el)e(gran-)544
5189 y(ularity)-6 b(,)36 b(we)f(belie)n(v)o(e)e(that)h(page)h(granular)
g(operations)f(are)h(also)g(important)e(and)h(should)g(be)544
5338 y(pro)o(vided.)29 b(This)23 b(gi)n(v)o(es)g(k)o(ernel)h
(subsystems)e(such)h(as)h(the)g(I/O)g(and)g(IPC)h(system)e(the)h
(ability)e(to)p eop
%%Page: 233 253
233 252 bop 3751 100 a Fs(233)544 249 y(add)25 b(and)f(e)o(xtract)h
(pages)f(from)h(a)g(process')g(address)f(space)h(without)e(disrupting)g
(or)i(fragment-)544 398 y(ing)f(the)h(high-le)n(v)o(el)e(address)h
(space)i(mappings.)445 618 y Fr(\017)49 b Fs(Second,)44
b(a)c(virtual)f(memory)g(system)f(should)h(be)h(designed)f(to)g(a)n(v)n
(oid)g(comple)o(x)g(memory)544 767 y(lookup)19 b(mechanisms.)28
b(Simple)19 b(memory)h(lookup)f(mechanisms)g(are)i(more)f(ef)n
(\002cient)g(and)h(ease)544 917 y(implementation)34 b(of)j(VM-based)g
(data)g(mo)o(v)o(ement)e(mechanisms.)65 b(F)o(or)37 b(e)o(xample,)i
(UVM')-5 b(s)544 1066 y(tw)o(o-le)n(v)o(el)28 b(memory)h(mapping)f
(scheme)i(impro)o(v)o(es)e(performance)i(o)o(v)o(er)f(BSD)h(object)f
(chains)544 1216 y(and)d(simpli\002es)e(traditional)g(functions)h(such)
g(as)h(the)g(f)o(ault)f(routine.)33 b(It)26 b(also)f(eased)h(the)g
(imple-)544 1365 y(mentation)d(of)i(UVM')-5 b(s)24 b(page)h(granulary)g
(data)g(mo)o(v)o(ement)d(mechanisms.)445 1585 y Fr(\017)49
b Fs(Third,)35 b(a)f(virtual)f(memory)g(system)f(should)h(be)h
(designed)f(in)g(such)g(a)h(w)o(ay)g(that)f(the)o(y)g(allo)n(w)544
1734 y(their)38 b(pages)g(to)g(be)g(shared)g(easily)g(between)g
(processes,)k(the)c(virtual)f(memory)g(layer)l(,)42 b(and)544
1883 y(k)o(ernel)32 b(subsystems.)51 b(This)32 b(allo)n(ws)f(data)h(to)
g(be)g(mo)o(v)o(ed)f(throughout)f(the)j(operating)e(system)544
2033 y(without)22 b(it)g(ha)n(ving)h(to)f(be)i(copied.)30
b(While,)22 b(BSD)i(VM)f(assumes)g(that)f(it)h(al)o(w)o(ays)g(has)g
(complete)544 2182 y(control)h(o)o(v)o(er)g(virtual)g(memory)g(pages,)h
(UVM)f(does)g(not.)583 2376 y(While)h(it)g(w)o(ould)g(be)h(foolish)e
(to)h(use)g(UVM')-5 b(s)25 b(data)g(mo)o(v)o(ement)e(mechanisms)h(on)i
(small)e(data)300 2526 y(chunks,)30 b(our)g(measurements)e(clearly)i
(sho)n(w)f(that)g(for)h(lar)n(ger)g(chunks)f(of)h(data)f(the)o(y)g(pro)
o(vide)g(a)h(sig-)300 2675 y(ni\002cant)25 b(reduction)f(in)g(k)o
(ernel)h(o)o(v)o(erhead)f(as)h(compared)g(to)f(data)h(cop)o(ying.)30
b(F)o(or)25 b(e)o(xample:)445 2869 y Fr(\017)49 b Fs(UVM')-5
b(s)27 b(page)h(loanout)e(mechanism)h(pro)o(vides)g(processes)g(with)g
(the)h(ability)e(to)i(a)n(v)n(oid)f(costly)544 3019 y(data)34
b(copies)g(by)g(loaning)g(a)g(cop)o(y-on-write)g(cop)o(y)g(of)g(their)g
(memory)g(out)g(to)f(the)i(k)o(ernel)f(or)544 3168 y(other)d
(processes.)49 b(Our)31 b(measurements)f(sho)n(w)f(that)i(loaning)f(a)h
(single)f(4K)h(page')-5 b(s)31 b(w)o(orth)f(of)544 3317
y(data)c(out)g(to)g(the)g(k)o(ernel)h(rather)g(than)f(cop)o(ying)f(it)h
(can)h(increase)g(bandwidth)e(by)h(35\045.)35 b(Lar)n(ger)544
3467 y(sized)28 b(chunks)f(of)h(data)g(pro)o(vide)f(an)h(e)n(v)o(en)g
(greater)g(performance)h(impro)o(v)o(ement.)38 b(F)o(or)28
b(e)o(xam-)544 3616 y(ple,)35 b(loaning)d(out)g(a)h(2MB)g(b)n(uf)n(fer)
g(rather)g(than)g(cop)o(ying)f(it)g(increases)i(the)e(bandwidth)g(by)h
(a)544 3766 y(f)o(actor)25 b(of)g(4.5.)445 3985 y Fr(\017)49
b Fs(UVM')-5 b(s)33 b(page)i(transfer)g(mechanism)f(allo)n(ws)f(a)i
(process)f(to)h(recei)n(v)o(e)f(anon)o(ymous)e(pages)j(of)544
4135 y(memory)25 b(from)i(other)f(processes)g(or)h(the)f(k)o(ernel)g
(without)f(ha)n(ving)h(to)g(cop)o(y)g(the)g(data.)36
b(Once)27 b(a)544 4284 y(page)j(has)f(been)h(recei)n(v)o(ed)f(with)f
(page)i(transfer)g(it)f(becomes)g(a)h(normal)f(page)h(of)f(anon)o
(ymous)544 4433 y(memory)35 b(and)h(requires)g(no)f(further)h(special)g
(treatment)f(from)h(UVM.)f(Our)h(measurements)544 4583
y(sho)n(w)30 b(that)g(page)h(transfer)h(pays)e(when)h(transferring)g
(tw)o(o)f(or)i(more)e(pages)h(of)g(data.)49 b(A)31 b(tw)o(o-)544
4732 y(page)36 b(page)h(transfer)g(increases)f(the)h(bandwidth)e(o)o(v)
o(er)g(cop)o(ying)h(by)g(28\045.)65 b(Increasing)36 b(the)544
4882 y(page)e(transfer)g(size)g(to)f(1MB)g(\(256)h(pages\))g(yields)e
(a)i(bandwidth)f(that)g(is)g(14)h(times)e(greater)544
5031 y(than)24 b(the)h(data)g(cop)o(ying)f(bandwidth.)445
5251 y Fr(\017)49 b Fs(In)39 b(addition)e(to)i(being)f(used)h
(separately)-6 b(,)42 b(we)d(ha)n(v)o(e)g(sho)n(wn)e(that)i(page)g
(transfer)g(and)g(page)544 5400 y(loanout)e(can)i(be)g(used)f(together)
g(to)g(impro)o(v)o(e)f(the)i(bandwidth)e(deli)n(v)o(ered)g(by)h(a)h
(pipe)g(by)f(a)p eop
%%Page: 234 254
234 253 bop 3751 100 a Fs(234)544 249 y(f)o(actor)37
b(of)g(1.7)g(for)g(page-sized)g(chunks)f(of)h(data,)j(and)d(by)g(a)g(f)
o(actor)g(of)g(16)g(for)g(1MB-sized)544 398 y(chunks)24
b(of)h(data.)445 625 y Fr(\017)49 b Fs(UVM')-5 b(s)34
b(map)g(entry)h(passing)f(mechanism)f(allo)n(ws)h(processes)g(to)h
(easily)f(cop)o(y)-6 b(,)37 b(share,)g(and)544 775 y(e)o(xchange)29
b(chunks)g(of)h(virtual)f(memory)g(from)h(their)f(address)h(space.)45
b(Measurements)29 b(sho)n(w)544 924 y(that)22 b(map)h(entry)g(passing)f
(between)h(tw)o(o)g(processes)f(is)h(more)g(ef)n(\002cient)g(than)g
(data)g(cop)o(ying)f(for)544 1073 y(tw)o(o)34 b(or)g(more)g(pages.)59
b(F)o(or)34 b(a)h(tw)o(o-page)f(e)o(xchange,)j(map)c(entry)i(passing)e
(pro)o(vides)g(a)h(44\045)544 1223 y(impro)o(v)o(ement)28
b(o)o(v)o(er)j(data)g(cop)o(ying.)49 b(F)o(or)31 b(a)g(512K)g(\(128)f
(page\))i(data)f(e)o(xchange,)i(map)d(entry)544 1372
y(passing)24 b(outperforms)g(data)g(cop)o(ying)g(by)h(f)o(actor)g(of)g
(2.8.)445 1599 y Fr(\017)49 b Fs(W)-8 b(e)31 b(ha)n(v)o(e)f(also)h(sho)
n(wn)e(that)i(map)f(entry)g(passing)g(can)h(be)g(combined)f(with)g
(page)h(loanout)e(to)544 1748 y(impro)o(v)o(e)34 b(the)i(performance)g
(of)g(a)g(data)g(pipeline)f(application.)62 b(Our)36
b(measurements)f(sho)n(w)544 1898 y(that)24 b(the)g(pipeline)f(using)h
(map)g(entry)g(passing)f(and)i(page)f(loanout)g(performs)g(better)g
(than)g(data)544 2047 y(cop)o(ying)30 b(for)h(data)g(chunks)f(of)h(tw)o
(o)f(or)h(more)f(pages.)49 b(While)30 b(map)h(entry)f(passing)g(and)h
(page)544 2197 y(loanout)23 b(yield)h(a)h(modest)e(2\045)h(impro)o(v)o
(ement)e(for)j(data)f(chunks)g(of)g(tw)o(o)g(pages,)g(the)o(y)g(impro)o
(v)o(e)544 2346 y(performance)h(by)g(a)g(f)o(actor)g(of)g(2.4)f(for)i
(sixteen-page)e(data)h(chunks.)300 2562 y(Our)g(measurements)f(also)h
(clearly)h(sho)n(w)e(the)h(ef)n(fects)g(of)g(the)h(k)o(ernel)f(cop)o
(ying)f(lar)n(ge)i(b)n(uf)n(fers)f(of)g(data)300 2711
y(multiple)18 b(times)g(on)h(the)h(cache.)29 b(These)20
b(data)f(copies)g(ef)n(fecti)n(v)o(ely)f(\003ush)i(all)f(the)g(data)h
(out)e(of)i(a)g(system')-5 b(s)300 2861 y(cache,)22 b(thus)d(causing)g
(it)h(to)f(ha)n(v)o(e)h(to)g(be)g(reloaded.)29 b(UVM')-5
b(s)19 b(ne)n(w)h(mechanisms)e(eliminate)h(this)g(cache-)300
3010 y(\003ushing)24 b(ef)n(fect.)583 3159 y(In)f(addition)f(to)g(pro)o
(viding)f(ne)n(w)h(features,)i(UVM)e(also)g(impro)o(v)o(es)f(the)i(BSD)
g(k)o(ernel')-5 b(s)22 b(perfor)n(-)300 3309 y(mance)j(in)f
(traditional)g(areas.)31 b(These)25 b(areas)h(include)e(the)g(follo)n
(wing:)445 3524 y Fr(\017)49 b Fs(F)o(orking)28 b(time)f(has)i(been)f
(reduced)h(under)g(UVM.)f(The)g Fm(vfork)g Fs(system)f(call)i(time)e
(has)i(been)544 3674 y(reduced)37 b(by)f(4\045.)66 b(The)36
b Fm(fork)g Fs(system)f(call)h(time)g(has)g(been)h(reduced)g(by)f
(13\045)g(for)h(small)544 3823 y(processes.)30 b(As)22
b(the)g(process)h(size)f(increases,)i(UVM')-5 b(s)21
b(impro)o(v)o(ement)f(increases)j(as)g(well.)29 b(F)o(or)544
3973 y(e)o(xample,)36 b(a)g(process)e(with)h(a)g(16MB)f(re)o(gion)h
(forks)f(56\045)h(f)o(aster)g(under)g(UVM)g(than)f(under)544
4122 y(BSD)26 b(VM.)445 4349 y Fr(\017)49 b Fs(P)o(ageout)27
b(time)f(has)h(been)h(reduced)f(under)g(UVM.)g(F)o(or)g(e)o(xample,)g
(on)g(our)g(32MB)g(system)f(the)544 4498 y(time)e(to)g(satisfy)g(a)h
(memory)f(allocation)g(of)h(50MB)g(has)f(been)h(reduced)h(by)e(83\045.)
445 4725 y Fr(\017)49 b Fs(The)28 b(number)g(of)g(calls)g(to)g(the)g
(pagef)o(ault)g(routine)g(has)g(been)g(reduced)h(under)f(UVM.)g(F)o(or)
g(e)o(x-)544 4874 y(ample,)23 b(when)g(compiling)f(a)i(\223hello)f(w)o
(orld\224)g(program)g(the)g(page)h(f)o(ault)f(routine)g(is)g(called)g
(46\045)544 5024 y(less)h(often)h(under)g(UVM.)445 5251
y Fr(\017)49 b Fs(Map)19 b(entry)h(fragmentation)f(has)h(been)g
(greatly)f(reduced)h(under)g(UVM.)g(Static)f(k)o(ernel)h(map)g(en-)544
5400 y(tries)k(are)g(no)g(longer)g(allocated)g(each)g(time)f(a)i
(process)f(is)f(created)i(under)f(UVM.)f(And)h(UVM')-5
b(s)p eop
%%Page: 235 255
235 254 bop 3751 100 a Fs(235)544 249 y(impro)o(v)o(ed)22
b(handling)g(of)i(wired)g(memory)f(reduces)i(the)e(number)h(of)g(map)f
(entries)h(required)g(for)544 398 y(traditional)30 b(processes.)51
b(F)o(or)31 b(e)o(xample,)i(a)f(system)e(freshly)h(booted)g(multiuser)f
(under)i(UVM)544 548 y(uses)24 b(40\045)h(fe)n(wer)g(map)f(entries)h
(than)f(it)h(w)o(ould)f(under)g(BSD)i(VM.)300 754 y(UVM)j(also)g
(includes)g(numerous)g(design)f(impro)o(v)o(ements)f(o)o(v)o(er)i(BSD)h
(VM.)f(These)h(impro)o(v)o(ements)300 903 y(include:)j(the)26
b(remo)o(v)n(al)f(of)h(object)g(chaining)f(and)i(\002ctitious)e(pages,)
h(the)g(mer)n(ging)g(of)g(the)g(vnode)g(and)300 1053
y(VM)j(object)g(cache,)j(the)d(remo)o(v)n(al)f(of)i(deadlock)f
(conditions)e(in)j(the)f(pmap,)h(the)f(elimination)f(of)h(the)300
1202 y(troublesome)i(\223ptdi\224)h(panic)h(condition,)g(a)g(uni\002ed)
f(mechanism)g(to)g(re)o(gister)g(the)g(con\002guration)g(of)300
1351 y(physical)24 b(memory)h(with)g(the)h(VM)f(system,)g(and)h(ne)n(w)
f(unpri)n(vile)o(ged)e(system)i(calls)g(that)h(allo)n(w)e(users)300
1501 y(to)g(obtain)g(VM)h(status)f(without)f(the)i(need)g(for)g
(\223root\224)g(access.)583 1650 y(In)i(addition,)e(UVM')-5
b(s)25 b(well)h(documented)f(implementation)f(methods)h(sho)n(w)g(ho)n
(w)h(a)g(project)300 1800 y(of)f(this)f(size)h(can)g(be)g(accomplished)
e(by)i(a)g(single)f(person.)583 1949 y(UVM)29 b(is)g(no)n(w)g(part)g
(of)g(the)h(standard)f(NetBSD)h(distrib)n(ution)c(and)k(is)f(scheduled)
f(to)h(replace)300 2098 y(the)20 b(BSD)i(VM)e(system)f(for)i(NetBSD)g
(release)h(1.4.)28 b(UVM)20 b(already)h(runs)f(on)h(almost)e(all)h(of)h
(NetBSD')-5 b(s)300 2248 y(platforms)28 b(and)h(is)f(e)o(xpected)h(to)f
(run)h(on)f(e)n(v)o(ery)h(NetBSD)g(platform)f(soon.)42
b(A)29 b(port)g(to)f(OpenBSD)i(is)300 2397 y(also)24
b(e)o(xpected.)300 2776 y Fg(11.2)143 b(Futur)m(e)34
b(Resear)m(ch)300 3028 y Fs(UVM)22 b(represents)g(a)h(major)f(step)g
(forw)o(ard)h(from)f(the)g(BSD)h(VM)f(system.)29 b(Although)21
b(much)h(has)g(been)300 3178 y(accomplished,)30 b(there)g(are)h(still)d
(plenty)h(of)h(tasks)f(that)h(need)g(attention.)45 b(Future)30
b(research)h(could)e(be)300 3327 y(done)c(in)f(the)h(follo)n(wing)e
(areas:)445 3533 y Fr(\017)49 b Fs(The)25 b(k)o(ernel)h(could)e(be)i
(modi\002ed)e(to)h(dynamically)f(decide)i(if)f(page)h(loanout)e(or)h
(page)h(transfer)544 3682 y(w)o(ould)g(be)h(more)g(ef)n(\002cient)g
(than)f(data)i(cop)o(ying)e(based)g(on)h(the)g(size)g(of)g(the)g(data)g
(being)f(trans-)544 3832 y(fered)g(and)f(the)g(a)n(v)n(ailable)g
(memory)f(resources.)32 b(P)o(age)26 b(loanout)e(and)h(page)g(transfer)
h(should)e(be)544 3981 y(con\002gured)29 b(in)g(such)f(a)i(w)o(ay)f
(that)f(the)o(y)h(are)g(options)f(that)g(the)h(k)o(ernel)g(can)h
(choose)e(if)h(there)h(is)544 4131 y(an)25 b(adv)n(antage)f(to)h(be)f
(gained.)445 4354 y Fr(\017)49 b Fs(The)34 b(performance)g(of)f(page)h
(loanout)f(and)g(page)h(transfer)g(on)g(systems)e(that)h(ha)n(v)o(e)g
(virtually)544 4504 y(addressed)j(caches)h(\(V)-13 b(A)l(Cs\))36
b(should)f(be)h(e)n(v)n(aluated.)64 b(V)-13 b(A)l(Cs)36
b(cache)h(data)f(based)g(on)g(virtual)544 4653 y(address)e(rather)h
(than)f(physical)f(address.)59 b(The)35 b(adv)n(antage)e(of)i(a)g(V)-13
b(A)l(C)34 b(is)g(that)g(data)g(can)h(be)544 4802 y(fetched)j(from)g
(the)f(cache)i(without)d(ha)n(ving)h(the)h(MMU)f(perform)h(an)g
(address)f(translation.)544 4952 y(Ho)n(we)n(v)o(er)l(,)23
b(a)i(major)g(dra)o(wback)f(of)h(using)f(V)-13 b(A)l(Cs)25
b(is)f(that)g(ambiguous)g(situations)e(can)k(de)n(v)o(elop)544
5101 y(if)21 b(a)h(single)e(page)i(of)f(memory)g(is)g(mapped)g(to)g
(more)g(than)g(one)g(physical)f(address.)30 b(In)21 b(this)g(case,)544
5251 y(the)29 b(V)-13 b(A)l(C)30 b(may)f(cache)i(the)e(same)h(data)g
(from)f(the)h(physical)e(page)i(of)g(memory)f(in)g(more)g(than)544
5400 y(one)c(place.)p eop
%%Page: 236 256
236 255 bop 3751 100 a Fs(236)544 249 y(On)28 b(systems)g(with)g(V)-13
b(A)l(Cs)28 b(the)h(VM)f(system)f(must)h(do)g(e)o(xtra)h(w)o(ork)f(to)h
(ensure)f(that)h(such)f(am-)544 398 y(biguous)22 b(situations)f(do)i
(not)f(occur)-5 b(.)30 b(Sometimes)22 b(this)g(problem)h(can)g(be)g(a)n
(v)n(oided)g(by)g(ensuring)544 548 y(that)j(all)h(of)g(a)h(page')-5
b(s)27 b(mappings)e(are)j(aligned)f(to)f(a)i(V)-13 b(A)l(C)27
b(boundary)-6 b(,)26 b(b)n(ut)h(for)g(other)g(cases)g(the)544
697 y(only)g(solution)f(is)h(to)g(either)h(uncache)g(all)g(mappings)e
(of)i(a)g(page)g(or)f(to)h(kick)f(out)g(all)h(the)f(map-)544
847 y(pings)j(e)o(xcept)h(one.)51 b(Since)32 b(page)g(loanout)e(and)h
(page)h(transfer)g(can)g(cause)g(a)f(single)g(page)g(to)544
996 y(ha)n(v)o(e)24 b(multiple)f(mappings)h(a)h(V)-13
b(A)l(C)25 b(could)f(ef)n(fect)h(the)g(performance)g(of)g(these)g
(mechanisms.)544 1187 y(As)f(we)g(e)o(xpect)f(operating)h(system)e
(softw)o(are)j(to)e(mak)o(e)h(more)g(use)g(of)g(multiply-mapped)d(page)
544 1336 y(as)28 b(time)g(goes)g(on,)h(we)f(hope)h(that)e(systems)g
(with)h(V)-13 b(A)l(Cs)28 b(become)g(less)g(common)f(because)i(of)544
1486 y(the)c(b)n(urden)f(the)o(y)g(place)h(on)g(the)f(VM)h(system.)445
1718 y Fr(\017)49 b Fs(Applications)26 b(should)g(be)i(adapted)g(to)f
(tak)o(e)g(adv)n(antage)h(of)f(ne)n(w)h(UVM)f(features)h(to)f(impro)o
(v)o(e)544 1868 y(their)21 b(performance.)30 b(Some)21
b(features)g(such)g(as)g(page)h(loanout)e(can)h(be)h(used)e(without)g
(ha)n(ving)g(to)544 2017 y(change)29 b(the)f(system)f(call)i(API.)g(Ho)
n(we)n(v)o(er)l(,)f(features)h(such)f(as)h(page)g(transfer)g(and)f(map)
g(entry)544 2166 y(passing)22 b(require)h(the)g(use)g(of)g(ne)n(w)f(or)
h(modi\002ed)f(system)g(calls.)30 b(W)-8 b(e)23 b(belie)n(v)o(e)f(that)
h(such)f(system)544 2316 y(call)31 b(API)g(changes)g(can)g(be)g(hidden)
f(behind)h(a)g(properly)f(designed)g(middle)n(w)o(are)g(layer)h(such)
544 2465 y(as)25 b(the)f(A)l(CE)i(wrappers)f([60)o(],)g(although)f
(this)g(has)h(yet)f(to)h(be)g(seen.)445 2698 y Fr(\017)49
b Fs(UVM)38 b(currently)h(operates)g(in)g(a)g(k)o(ernel)g(that)g(has)f
(separate)i(\002x)o(ed)f(sized)g(VM)f(and)h(b)n(uf)n(fer)544
2847 y(cache.)58 b(These)34 b(tw)o(o)f(caches)i(need)e(to)h(be)g(mer)n
(ged)g(to)f(pro)o(vide)g(the)g(operating)g(system)g(with)544
2996 y(more)j(\003e)o(xibility)-6 b(.)62 b(Mer)n(ging)35
b(the)h(tw)o(o)f(caches)i(will)e(require)h(a)g(ne)n(w)g(I/O)g(layer)g
(in)g(the)g(VM)544 3146 y(system.)445 3378 y Fr(\017)49
b Fs(UVM)25 b(should)g(be)h(ported)g(to)g(a)g(multiprocessor)f(system)f
(so)i(that)g(its)f(\002ne-grain)h(locking)g(sys-)544
3528 y(tem)e(can)h(be)g(fully)f(tested.)583 3760 y(The)37
b(UVM)e(system)g(is)h(well)g(or)n(ganized)g(and)g(documented,)i(thus)d
(making)g(it)h(well)g(suited)300 3909 y(for)j(additional)e
(enhancements.)71 b(Gi)n(v)o(en)37 b(the)h(w)o(ork)g(we')-5
b(v)o(e)39 b(already)g(accomplished)e(with)h(UVM,)300
4059 y(taking)29 b(on)g(these)h(tasks)f(for)h(future)g(research)h
(should)d(be)i(an)g(interesting,)g(b)n(ut)f(not)g(insurmountable)300
4208 y(challenge.)45 b(Additional)28 b(ef)n(forts)h(in)g(this)g(area)h
(will)f(allo)n(w)g(applications)f(to)h(tak)o(e)h(full)f(adv)n(antage)g
(of)300 4358 y(the)c(bene\002ts)f(of)h(UVM.)p eop
%%Page: 237 257
237 256 bop 3751 100 a Fs(237)300 973 y Fp(A)-5 b(ppendix)51
b(A)300 1448 y(Glossary)300 1930 y Fo(addr)n(ess)26 b(space:)49
b Fs(a)25 b(numeric)g(range)g(that)f(identi\002es)g(a)h(portion)f(of)h
(physical)f(or)g(virtual)g(memory)-6 b(.)300 2162 y Fo(aobj:)49
b Fs(a)25 b Fm(uvm)p 825 2162 30 4 v 35 w(object)f Fs(that)g(contains)g
(anon)o(ymous)f(memory)-6 b(.)300 2395 y Fo(amap:)49
b Fs(a)35 b(data)g(structure)f(also)g(kno)n(wn)g(as)g(an)h(anon)o
(ymous)e(map.)60 b(An)34 b(amap)h(structure)f(contains)544
2544 y(pointers)24 b(to)g(a)h(set)g(of)g(anons)f(that)g(are)i(mapped)e
(together)h(in)f(virtual)g(memory)-6 b(.)300 2777 y Fo(anonymous)25
b(memory:)49 b Fs(memory)34 b(that)h(is)f(freed)i(as)f(soon)f(as)h(it)g
(is)f(no)h(longer)f(referenced.)63 b(This)544 2926 y(memory)25
b(is)h(referred)h(to)e(as)i(anon)o(ymous)d(because)i(it)f(is)h(not)f
(associated)h(with)f(a)i(\002le)f(and)g(thus)544 3075
y(does)21 b(not)f(ha)n(v)o(e)h(a)h(\002le)f(name.)29
b(Anon)o(ymous)19 b(memory)i(is)f(paged)h(out)g(to)g(the)g(\223sw)o
(ap\224)g(area)h(when)544 3225 y(memory)i(is)g(scarce.)300
3457 y Fo(anon:)49 b Fs(a)34 b(data)f(structure)h(that)e(describes)i(a)
f(single)g(page)g(of)h(anon)o(ymous)d(memory)-6 b(.)55
b(Information)544 3607 y(contained)22 b(in)g(an)h(anon)f(includes)g(a)h
(reference)i(counter)d(and)h(the)f(current)h(location)f(of)h(the)f
(data)544 3756 y(\(i.e.)31 b(in)24 b(RAM)h(or)g(in)f(backing)h
(store\).)300 3988 y Fo(ar)n(ef:)50 b Fs(a)27 b(data)h(structure)f
(that)f(is)h(part)h(of)f(a)h(map)e(entry)i(structure)f(and)g(contains)f
(a)i(reference)h(and)e(an)544 4138 y(of)n(fset)d(to)h(an)g(amap)f
(structure.)300 4370 y Fo(BSD)i(VM:)49 b Fs(the)24 b(VM)h(system)e
(imported)h(into)g(4.4BSD)h(from)g(the)f(Mach)h(operating)f(system.)300
4603 y Fo(backing)i(stor)n(e:)49 b Fs(a)21 b(non-v)n(olatile)e(area)j
(of)e(memory)-6 b(,)20 b(typically)g(on)g(disk,)g(where)h(data)g(is)f
(stored)g(when)544 4752 y(it)h(is)g(not)g(resident.)29
b(Examples)20 b(of)i(backing)f(store)g(include)g(plain)g(\002les)h(and)
f(the)g(system')-5 b(s)20 b(sw)o(ap)544 4901 y(area.)300
5134 y Fo(bss)25 b(ar)n(ea:)49 b Fs(the)29 b(area)i(of)e(a)h(process')g
(virtual)e(address)i(space)g(where)g(un-initialized)d(data)j(is)f
(placed.)544 5283 y(The)c(VM)f(system)g(\002lls)g(this)g(area)i(with)e
(zeroed)h(pages)g(as)g(it)f(is)h(referenced.)p eop
%%Page: 238 258
238 257 bop 3751 100 a Fs(238)300 249 y Fo(b)n(usy)25
b(page:)49 b Fs(a)26 b(page)f(that)f(should)g(not)g(be)h(accessed)g
(because)g(it)g(is)f(being)g(read)i(or)f(written.)300
479 y Fo(center)h(page:)50 b Fs(the)24 b(page)h(around)g(which)f(a)h
(cluster)g(is)f(b)n(uilt.)300 709 y Fo(chunking,)j(amap:)48
b Fs(the)35 b(process)f(of)h(breaking)f(up)h(the)f(allocation)g(of)h
(lar)n(ge)g(amaps)f(into)g(smaller)544 859 y(allocations.)300
1089 y Fo(clean)25 b(page:)49 b Fs(a)26 b(page)f(whose)f(data)h(has)g
(not)f(been)h(modi\002ed.)300 1319 y Fo(cluster)n(ed)h(I/O:)48
b Fs(I/O)32 b(in)g(which)g(operations)f(on)h(smaller)g(contiguous)e(re)
o(gions)h(are)i(mer)n(ged)f(into)g(a)544 1468 y(single)24
b(lar)n(ge)h(I/O)g(operation.)300 1698 y Fo(copy-on-write:)50
b Fs(a)28 b(w)o(ay)g(of)g(using)f(the)h(VM)f(system)g(to)h(minimize)e
(the)i(amount)f(of)h(data)g(that)f(must)544 1848 y(be)g(copied.)36
b(The)27 b(actual)f(cop)o(y)h(of)g(each)g(page)g(of)g(data)g(is)f
(deferred)i(until)d(it)h(is)h(\002rst)f(written)g(in)544
1997 y(hopes)e(that)g(it)g(will)g(not)g(be)h(written)f(at)h(all.)30
b(There)25 b(are)g(tw)o(o)g(forms)f(of)g(cop)o(y-on-write:)30
b(pri)n(v)n(ate)544 2146 y(cop)o(y-on-write)24 b(and)h(cop)o(y)g(cop)o
(y-on-write.)300 2376 y Fo(copy)g(copy-on-write:)50 b
Fs(a)26 b(form)f(of)h(cop)o(y-on-write)f(where)h(the)g(cop)o(y)f(is)g
(a)h(complete)f(snapshot)f(of)i(a)544 2526 y(memory)d(object)h(at)h
(the)f(time)f(of)i(the)f(cop)o(y)-6 b(.)30 b(Changes)24
b(made)g(to)g(the)h(backing)e(object)h(after)h(the)544
2675 y(cop)o(y)f(are)i(ne)n(v)o(er)e(seen.)300 2905 y
Fo(copy)h(object:)50 b Fs(in)29 b(the)h(BSD)h(VM,)e(an)h(anon)o(ymous)d
(memory)i(object)g(that)h(stores)f(the)g(original)g(v)o(er)n(-)544
3055 y(sion)k(of)h(a)h(changed)f(page)h(in)e(a)i(copied)f(object.)58
b(Cop)o(y)34 b(objects)g(are)h(necessary)f(to)g(support)544
3204 y(the)26 b(non-standard)f(cop)o(y)h(cop)o(y-on-write)f(semantics.)
33 b(A)26 b(list)f(of)h(objects)g(connected)g(by)f(their)544
3353 y(cop)o(y)f(object)h(pointers)f(is)g(called)h(a)g
Fo(copy)g(object)h(chain)p Fs(.)300 3583 y Fo(data)f(ar)n(ea:)49
b Fs(the)36 b(area)h(of)f(a)g(process')g(virtual)f(address)h(space)h
(where)f(initialized)f(data)h(is)f(placed.)544 3733 y(The)29
b(data)h(area)g(comes)f(from)g(the)g(\002le)h(containing)e(the)h
(program)g(being)g(run)g(and)h(is)f(mapped)544 3882 y(cop)o
(y-on-write.)300 4112 y Fo(dirty)c(page:)49 b Fs(a)36
b(page)f(whose)f(data)i(has)e(been)i(modi\002ed.)60 b(Dirty)34
b(pages)h(must)f(be)h(cleaned)h(before)544 4262 y(the)o(y)24
b(can)h(be)g(paged)g(out.)300 4492 y Fo(faultinf)n(o:)49
b Fs(a)25 b(data)g(structure)f(used)h(to)f(store)h(the)f(state)h(of)g
(a)g(page)g(f)o(ault.)300 4722 y Fo(\002ctitious)g(page:)49
b Fs(a)22 b Fm(vm)p 1163 4722 30 4 v 35 w(page)e Fs(structure)h(used)f
(by)h(the)g(BSD)h(VM)e(system)g(to)g(refer)i(to)f(de)n(vice)g(mem-)544
4871 y(ory)-6 b(.)300 5101 y Fo(hard)o(war)n(e)26 b(exception:)50
b Fs(when)23 b(a)i(running)e(program)g(encounters)h(a)g(condition)f
(\227)g(which)h(it)f(may)h(or)544 5251 y(may)34 b(not)g(ha)n(v)o(e)h
(caused)f(\227)h(that)f(pre)n(v)o(ents)f(it)h(from)h(continuing)e(to)h
(run.)60 b(The)35 b(k)o(ernel)f(must)544 5400 y(resolv)o(e)24
b(the)h(problem)f(or)h(kill)e(the)i(process.)31 b(This)24
b(is)g(also)g(referred)i(to)f(as)g(a)g(trap.)p eop
%%Page: 239 259
239 258 bop 3751 100 a Fs(239)300 249 y Fo(heap:)50 b
Fs(the)19 b(area)h(of)f(a)g(process')g(virtual)f(address)h(space)g
(from)g(which)g(dynamic)f(memory)g(is)g(allocated)544
398 y(\(e.g.)53 b(with)31 b Fm(malloc)p Fs(\).)52 b(The)32
b(heap)h(is)f(an)g(e)o(xtension)f(of)h(the)g(bss)g(area)h(and)f(it)g
(gro)n(ws)f(as)h(the)544 548 y(process)25 b(allocates)f(more)h(memory)
-6 b(.)300 780 y Fo(k)o(er)o(nel:)50 b Fs(the)38 b(program)g(that)h
(controls)e(a)i(computer')-5 b(s)38 b(hardw)o(are)h(and)g(softw)o(are)g
(resources.)72 b(The)544 930 y(k)o(ernel)36 b(has)g(se)n(v)o(eral)g
(subsystems)e(including)h(netw)o(orking,)i(I/O,)f(process)g
(scheduling,)i(and)544 1079 y(virtual)25 b(memory)-6
b(.)31 b(In)25 b(a)h(Unix-lik)o(e)e(operating)h(system)f(the)i(k)o
(ernel)f(is)g(stored)g(in)g(a)h(\002le)g(such)f(as)544
1228 y Fm(/vmunix)p Fs(,)e(or)i Fm(/netbsd)p Fs(.)k(The)c(k)o(ernel)g
(is)f(part)h(of)g(an)g(operating)f(system.)300 1461 y
Fo(Mach:)49 b Fs(an)22 b(operating)g(system)e(de)n(v)o(eloped)h(at)h
(Carne)o(gie-Mellon)f(Uni)n(v)o(ersity)-6 b(.)27 b(Mach')-5
b(s)21 b(VM)g(system)544 1610 y(w)o(as)k(imported)e(into)h(BSD.)300
1843 y Fo(memory)h(management)h(unit)f(\(MMU\):)50 b
Fs(the)19 b(part)h(of)g(a)g(computer')-5 b(s)19 b(hardw)o(are)i(that)e
(translates)g(vir)n(-)544 1992 y(tual)24 b(addresses)h(to)f(physical)g
(addresses.)300 2224 y Fo(memory)h(mapped)h(object:)50
b Fs(a)38 b(memory)f(object)h(that)f(has)h(pages)g(which)f(are)i
(currently)f(mapped)544 2374 y(into)27 b(a)i(user')-5
b(s)28 b(address)g(space.)42 b(Examples)27 b(of)i(memory)f(mapped)f
(objects)h(include)g Fo(memory)544 2523 y(mapped)e(\002les)f
Fs(and)g Fo(memory)g(mapped)h(de)o(vices)p Fs(.)300 2756
y Fo(memory)f(object:)50 b Fs(an)o(y)29 b(k)o(ernel)h(data)g(structure)
f(that)h(represents)f(data)h(that)g(can)g(be)g(mapped)f(into)g(a)544
2905 y(virtual)24 b(address)h(space.)300 3137 y Fo(object)h(collapse)e
(pr)n(oblem:)50 b Fs(a)36 b(problem)e(with)g(the)h(BSD)h(VM)e(system)g
(where)h(memory)g(remains)544 3287 y(allocated)j(e)n(v)o(en)f(though)g
(it)g(can)i(no)e(longer)h(be)g(accessed.)71 b(This)38
b(e)n(v)o(entually)e(leads)i(to)f(the)544 3436 y(k)o(ernel)25
b(running)f(out)g(of)h(sw)o(ap)f(space.)300 3669 y Fo(operating)h
(system:)49 b Fs(the)25 b(k)o(ernel)g(and)g(associated)g(system)f
(programs)h(that)f(come)h(with)g(it)g(\(e.g.)32 b(sys-)544
3818 y(tem)24 b(utilities,)f(windo)n(wing)g(system,)g(etc.\).)300
4051 y Fo(page)i(fault:)49 b Fs(a)23 b(hardw)o(are)f(e)o(xception)f
(triggered)h(by)f(the)h(MMU)f(when)h(virtual)f(memory)g(is)h(accessed)
544 4200 y(in)32 b(a)g(w)o(ay)h(that)f(is)f(inconsistent)g(with)g(ho)n
(w)h(it)f(is)h(mapped.)53 b(P)o(age)32 b(f)o(aults)g(may)g(be)g
(triggered,)544 4349 y(for)c(e)o(xample,)g(by)g(accessing)g(a)g
(virtual)g(address)g(that)f(is)h(not)f(currently)h(mapped)g(to)f
(physical)544 4499 y(memory)-6 b(,)19 b(or)h(by)g(writing)f(to)h(a)g
(virtual)f(address)h(that)f(is)h(mapped)f(read-only)-6
b(.)29 b(There)20 b(are)h(se)n(v)o(eral)544 4648 y(kinds)35
b(of)g(page)h(f)o(aults.)63 b(A)36 b Fo(r)n(ead)g(fault)g
Fs(occurs)g(when)g(an)f(unmapped)g(area)i(of)f(memory)f(is)544
4797 y(read.)f(A)26 b Fo(write)g(fault)g Fs(occurs)g(when)f(an)h
(unmapped)f(or)h(write-protected)f(area)i(of)f(memory)f(is)544
4947 y(written.)300 5179 y Fo(panic:)49 b Fs(a)26 b(system)d(crash)i
(due)g(to)g(a)g(f)o(atal)g(error)g(within)f(the)g(k)o(ernel.)p
eop
%%Page: 240 260
240 259 bop 3751 100 a Fs(240)300 249 y Fo(ph)o(ysical)24
b(addr)n(ess)i(space:)49 b Fs(the)e(address)f(space)h(where)g(physical)
e(memory)h(resides.)96 b(Physical)544 398 y(memory)32
b(need)g(not)g(be)h(contiguous)e(in)h(the)g(physical)g(address)g
(space,)j(although)c(it)h(is)g(more)544 548 y(ef)n(\002cient)25
b(for)g(the)f(VM)h(system)f(if)g(it)h(is.)300 780 y Fo(ph)o(ysical)f
(memory:)49 b Fs(the)25 b(system')-5 b(s)23 b(RAM)i(or)g(memory)f
(chips.)300 1013 y Fo(r)n(eleased)i(page:)49 b Fs(a)24
b(page)g(that)f(needs)h(to)f(be)h(freed)g(b)n(ut)f(cannot)h(be)g(freed)
g(because)g(it)f(is)h(b)n(usy)-6 b(.)29 b(Such)24 b(a)544
1162 y(page)h(is)f(mark)o(ed)h(released)g(and)g(will)f(be)h(freed)g
(when)g(it)f(is)h(no)f(longer)h(b)n(usy)-6 b(.)300 1394
y Fo(r)n(esident)26 b(memory:)49 b Fs(memory)24 b(that)h(is)f(in)g(RAM)
h(rather)g(than)g(on)f(backing)h(store.)300 1627 y Fo(shar)n(e)h(map:)
49 b Fs(a)19 b(map)g(which)f(de\002nes)h(a)h(range)f(of)g(shared)g
(virtual)f(address)h(space.)29 b(Mapping)18 b(changes)544
1776 y(in)24 b(a)h(share)h(map)e(are)i(seen)e(by)h(all)g(processes)f
(sharing)g(the)h(map.)300 2009 y Fo(shar)n(ed)h(mapping:)49
b Fs(a)27 b(mapping)e(in)h(which)g(changes)h(made)f(to)g(memory)g(are)h
(re\003ected)h(back)e(to)g(the)544 2158 y(backing)e(object.)30
b(Thus)25 b(these)f(changes)h(are)h(shared)f(by)f(an)o(y)g(process)h
(mapping)f(the)g(object.)300 2391 y Fo(shado)o(w)h(object:)50
b Fs(in)34 b(the)g(BSD)i(VM,)e(an)g(object)g(that)g(stores)g(the)h
(changed)f(v)o(ersion)f(of)i(an)g(object)544 2540 y(mapped)29
b(cop)o(y-on-write.)44 b(A)30 b(list)e(of)i(objects)f(connected)g(by)g
(their)g(shado)n(w)g(object)g(pointers)544 2689 y(is)24
b(called)h(a)g Fo(shado)o(w)g(object)h(chain)p Fs(.)300
2922 y Fo(stack)f(ar)n(ea:)50 b Fs(the)21 b(area)j(of)e(a)g(process')g
(virtual)g(address)g(space)g(where)h(the)f(program)g(e)o(x)o(ecution)e
(stack)544 3071 y(is)k(placed.)31 b(This)24 b(area)i(is)e(\002lled)h
(with)f(zeroed)h(pages)g(by)g(the)f(VM)h(system)e(as)i(it)g(is)f
(referenced.)300 3304 y Fo(submap:)50 b Fs(a)25 b(map)f(used)h(by)f
(the)h(k)o(ernel)g(to)f(break)h(up)g(its)f(address)h(space)g(into)f
(smaller)g(chunks.)300 3536 y Fo(swap)h(space:)49 b Fs(the)34
b(area)h(of)e(backing)h(store)f(where)i(anon)o(ymous)c(memory)i(is)h
(paged)g(out)f(to)g(when)544 3685 y(physical)23 b(memory)h(is)h
(scarce.)300 3918 y Fo(swap)g(memory)g(leak:)49 b Fs(in)34
b(the)g(BSD)h(VM,)e(when)i(anon)o(ymous)d Fm(vm)p 2763
3918 30 4 v 35 w(object)h Fs(structures)h(contain)544
4067 y(memory)28 b(that)g(is)g(not)h(accessible)f(by)h(an)o(y)f
(process,)i(those)e(pages)g(e)n(v)o(entually)f(get)i(paged)g(out)544
4217 y(to)22 b(sw)o(ap)h(space.)31 b(Sw)o(ap)23 b(space)h(e)n(v)o
(entually)d(gets)h(\002lled,)h(and)g(the)g(operating)g(system)e(can)j
(dead-)544 4366 y(lock.)300 4598 y Fo(text)h(ar)n(ea:)50
b Fs(the)33 b(area)h(of)f(a)h(process')f(virtual)f(address)h(space)h
(where)g(the)f(e)o(x)o(ecutable)f(instructions)544 4748
y(of)e(a)g(program)g(are)h(placed.)47 b(The)30 b(te)o(xt)f(area)i
(comes)f(from)f(the)h(\002le)h(containing)e(the)g(program)544
4897 y(being)24 b(run)h(and)g(is)f(mapped)g(read-only)-6
b(.)300 5130 y Fo(virtual)25 b(addr)n(ess)g(space:)50
b Fs(an)27 b(address)h(space)f(in)g(which)g(virtual)g(memory)g
(resides.)38 b(In)27 b(a)h(Unix-lik)o(e)544 5279 y(operating)18
b(system)h(each)g(process)g(on)g(the)g(system)f(has)i(its)e(o)n(wn)g
(pri)n(v)n(ate)g(virtual)h(address)g(space.)p eop
%%Page: 241 261
241 260 bop 3751 100 a Fs(241)300 249 y Fo(virtual)25
b(memory:)49 b Fs(memory)24 b(that)h(must)f(be)h(mapped)g(to)f(a)i
(page)f(of)h(physical)d(memory)i(by)g(the)g(VM)544 398
y(system)f(before)h(it)f(can)h(be)g(referenced.)300 631
y Fd(vm)p 426 631 30 4 v 35 w(object)p Fo(:)48 b Fs(a)31
b(data)g(structure)g(that)f(describes)h(a)g(\002le,)i(de)n(vice,)f(or)f
(zero-\002ll)g(area)h(which)f(can)g(be)544 780 y(mapped)24
b(into)g(virtual)g(address)h(space.)300 1013 y Fo(vnode:)50
b Fs(a)25 b(k)o(ernel)g(data)f(structure)h(that)f(describes)h(a)g
(\002le.)300 1245 y Fo(UVM:)49 b Fs(a)25 b(ne)n(w)f(virtual)g(memory)g
(system)g(introduced)g(in)g(this)g(dissertation.)300
1478 y Fo(wanted)i(page:)49 b Fs(a)30 b(page)g(that)f(is)g(needed)h(b)n
(ut)f(currently)g(b)n(usy)-6 b(.)44 b(A)30 b(process)g(can)g(mark)f(a)h
(b)n(usy)f(page)544 1627 y(w)o(anted)c(and)f(then)h(w)o(ait)f(for)h(it)
g(to)f(become)h(un-b)n(usy)-6 b(.)300 1859 y Fo(wir)n(ed)26
b(page:)49 b Fs(a)25 b(page)g(of)g(virtual)f(memory)g(that)g(is)h(al)o
(w)o(ays)f(resident)g(in)h(physical)e(memory)-6 b(.)300
2092 y Fo(zer)n(o-\002lled)26 b(memory:)49 b Fs(memory)27
b(that)h(is)f(allocated)h(and)g(\002lled)g(with)f(zeros)i(only)e(when)h
(it)f(is)h(refer)n(-)544 2241 y(enced.)p eop
%%Page: 242 262
242 261 bop 3751 100 a Fs(242)300 973 y Fp(Refer)l(ences)350
1455 y Fs([1])49 b(V)-13 b(.)25 b(Abrossimo)o(v)-6 b(,)23
b(M.)i(Rozier)l(,)h(and)f(M.)g(Gien.)38 b(V)-6 b(irtual)24
b(memory)h(management)g(in)g(Chorus.)37 b(In)515 1604
y Fq(Pr)l(oceedings)30 b(of)i(the)g(Pr)l(o)o(gr)l(ess)f(in)g(Distrib)n
(uted)g(Oper)o(ating)f(Systems)h(and)h(Distrib)n(uted)e(Sys-)515
1754 y(tems)24 b(Mana)o(g)o(ement)g(W)-9 b(orkshop)p
Fs(,)24 b(April)g(1989.)350 1986 y([2])49 b(V)-13 b(.)37
b(Abrossimo)o(v)-6 b(,)37 b(M.)f(Rozier)l(,)41 b(and)c(M)f(Shapiro.)74
b(Generic)38 b(virtual)e(memory)g(management)515 2135
y(for)j(operating)g(system)f(k)o(ernels.)82 b(In)39 b
Fq(Pr)l(oceedings)f(of)h(the)g(T)-7 b(welfth)39 b(A)m(CM)h(Symposium)e
(on)515 2285 y(Oper)o(ating)23 b(Systems)h(Principles)p
Fs(,)f(December)j(1989.)350 2517 y([3])49 b(E.)37 b(Anderson.)76
b Fq(Container)36 b(Shipping:)55 b(A)37 b(Uniform)f(Interface)i(for)e
(F)-7 b(ast,)40 b(Ef)n(\002cient,)g(High-)515 2667 y(Bandwidth)23
b(I/O)p Fs(.)36 b(PhD)25 b(thesis,)f(Uni)n(v)o(ersity)e(of)j
(California,)g(San)g(Die)o(go,)f(1995.)350 2899 y([4])49
b(J.)23 b(Barrera.)36 b(A)23 b(f)o(ast)h(Mach)g(netw)o(ork)f(IPC)i
(implementation.)31 b(In)24 b Fq(Pr)l(oceedings)f(of)g(the)h(USENIX)515
3048 y(Mac)o(h)g(Symposium)p Fs(,)g(pages)g(1\22611,)g(No)o(v)o(ember)g
(1991.)350 3281 y([5])49 b(B.)27 b(Bershad,)h(T)-7 b(.)27
b(Anderson,)g(E.)g(Lazo)n(wska,)g(and)g(H.)g(Le)n(vy)-6
b(.)42 b(Lightweight)25 b(remote)i(procedure)515 3430
y(call.)35 b Fq(A)m(CM)26 b(T)-5 b(r)o(ansactions)22
b(on)i(Computer)h(Systems)p Fs(,)f(8\(1\):37\22655,)g(February)h(1990.)
350 3663 y([6])49 b(B.)32 b(Bershad,)i(T)-7 b(.)32 b(Anderson,)h(E.)e
(Lazo)n(wska,)i(and)f(H.)g(Le)n(vy)-6 b(.)57 b(User)n(-le)n(v)o(el)31
b(interprocess)g(com-)515 3812 y(munication)38 b(for)i(shared-memory)e
(multiprocessors.)81 b Fq(A)m(CM)40 b(T)-5 b(r)o(ansactions)37
b(on)i(Computer)515 3961 y(Systems)p Fs(,)24 b(9\(2\):175\226198,)f
(May)i(1991.)350 4194 y([7])49 b(B.)33 b(Bershad,)i(C.)e(Chambers,)h
(S.)f(Eggers,)h(C.)f(Maeda,)i(D.)e(McNamee,)h(P)-11 b(.)33
b(P)o(ardyak,)h(S.)f(Sa)n(v-)515 4343 y(age,)28 b(and)e(E.)h(Sirer)-5
b(.)43 b(Spin)27 b(-)g(an)g(e)o(xtensible)f(microk)o(ernel)g(for)h
(application-speci\002c)g(operating)515 4493 y(system)j(services.)57
b(T)-7 b(echnical)31 b(Report)g(94-03-03,)i(Department)d(of)i(Computer)
f(Science)h(and)515 4642 y(Engineering,)24 b(Uni)n(v)o(ersity)e(of)j(W)
-8 b(ashington,)23 b(February)j(1994.)350 4874 y([8])49
b(B.)26 b(Bershad,)h(S.)f(Sa)n(v)n(age,)h(P)-11 b(.)26
b(P)o(ardyak,)g(E.)g(Sirer)l(,)h(M.)e(Fiuczynski,)h(D.)f(Beck)o(er)l(,)
j(C.)e(Chambers,)515 5024 y(and)k(S.)g(Eggers.)52 b(Extensibility)-6
b(,)28 b(safety)i(and)f(performance)i(in)e(the)h(SPIN)h(operating)e
(system.)515 5173 y(In)c Fq(Pr)l(oceedings)e(of)i(the)f(F)l(ifteenth)f
(Symposium)h(on)h(Oper)o(ating)e(System)h(Principles)p
Fs(,)f(1996.)p eop
%%Page: 243 263
243 262 bop 3751 100 a Fs(243)350 249 y([9])49 b(D.)23
b(Bobro)n(w)h(et)f(al.)33 b(TENEX,)23 b(a)h(paged)g(time)f(sharing)g
(system)f(for)i(the)g(PDP-10.)33 b Fq(Communica-)515
398 y(tions)23 b(of)i(the)f(A)m(CM)p Fs(,)i(15\(3\),)e(March)h(1972.)
300 631 y([10])49 b(J.)27 b(Brustoloni.)42 b Fq(Ef)n(fects)27
b(of)g(Data)f(P)-8 b(assing)26 b(Semantics)h(and)f(Oper)o(ating)g
(System)h(Structur)l(e)f(on)515 780 y(Network)d(I/O)g(P)-8
b(erformance)p Fs(.)31 b(PhD)24 b(thesis,)e(Carne)o(gie)h(Mellon)f(Uni)
n(v)o(ersity)-6 b(,)21 b(September)i(1997.)300 1013 y([11])49
b(J.)34 b(Brustoloni)f(and)h(P)-11 b(.)35 b(Steenkiste.)65
b(Cop)o(y)34 b(emulation)f(in)h(checksummed,)i(multiple-pack)o(et)515
1162 y(communication.)46 b(In)29 b Fq(Pr)l(oceedings)f(of)g(IEEE)h
(INFOCOM)h(1997)p Fs(,)f(pages)g(1124\2261132,)f(April)515
1311 y(1997.)300 1544 y([12])49 b(M.)29 b(Buddhik)o(ot,)h(X.)f(Chen,)i
(D.)f(W)-5 b(u,)31 b(and)f(G.)f(P)o(arulkar)-5 b(.)51
b(Enhancements)29 b(to)g(4.4)g(BSD)i(UNIX)515 1693 y(for)37
b(netw)o(ork)o(ed)f(multimedia)f(in)h(project)h(MARS.)74
b(In)37 b Fq(Pr)l(oceedings)f(of)g(IEEE)h(Multimedia)515
1843 y(Systems'98)p Fs(,)24 b(June)g(1998.)300 2075 y([13])49
b(H.)36 b(Chartock)h(and)f(P)-11 b(.)37 b(Sn)o(yder)-5
b(.)72 b(V)-6 b(irtual)36 b(sw)o(ap)g(space)h(in)f(SunOS.)74
b(In)36 b Fq(Pr)l(oceedings)f(of)h(the)515 2224 y(A)n(utumn)24
b(1991)g(Eur)l(opean)f(UNIX)i(User)o(s)g(Gr)l(oup)e(Confer)l(ence)p
Fs(,)j(September)f(1991.)300 2457 y([14])49 b(H.)23 b(Chu.)32
b(Zero-cop)o(y)23 b(TCP)h(in)e(Solaris.)32 b(In)23 b
Fq(Pr)l(oceedings)f(of)g(the)h(USENIX)g(Confer)l(ence)p
Fs(,)h(pages)515 2606 y(253\226264.)f(USENIX,)i(1996.)300
2839 y([15])49 b(C.)24 b(Cranor)g(and)f(G.)g(P)o(arulkar)-5
b(.)32 b(Uni)n(v)o(ersal)22 b(continuous)g(media)h(I/O:)f(Design)h(and)
g(implementa-)515 2988 y(tion.)35 b(T)-7 b(echnical)24
b(Report)h(WUCS-94-34,)h(W)-8 b(ashington)23 b(Uni)n(v)o(ersity)-6
b(,)22 b(1994.)300 3221 y([16])49 b(C.)22 b(Cranor)h(and)f(G.)g(P)o
(arulkar)-5 b(.)29 b(Design)21 b(of)h(uni)n(v)o(ersal)e(continuous)h
(media)g(I/O.)29 b(In)22 b Fq(Pr)l(oceedings)515 3370
y(of)35 b(the)h(5th)f(International)f(W)-9 b(orkshop)35
b(on)h(Network)g(and)g(Oper)o(ating)e(Systems)h(Support)g(for)515
3519 y(Digital)23 b(A)n(udio)h(and)g(V)-7 b(ideo)p Fs(,)24
b(pages)h(83\22686,)f(1995.)300 3752 y([17])49 b(R.)33
b(Dean)g(and)g(F)-8 b(.)34 b(Armand.)61 b(Data)33 b(mo)o(v)o(ement)e
(in)i(k)o(ernelized)g(systems.)60 b(T)-7 b(echnical)33
b(Report)515 3901 y(CS-TR-92-51,)26 b(Chorus)e(Syst)6
b(\036)-39 b(emes,)24 b(1992.)300 4134 y([18])49 b(P)-11
b(.)38 b(Denning.)79 b(V)-6 b(irtual)37 b(memory)-6 b(.)78
b Fq(A)m(CM)39 b(Computing)e(Surve)m(ys)p Fs(,)42 b(2\(3\):153\22689,)e
(September)515 4283 y(1970.)300 4515 y([19])49 b(P)-11
b(.)25 b(Denning.)35 b(V)-6 b(irtual)24 b(memory)-6 b(.)34
b Fq(A)m(CM)26 b(Computing)d(Surve)m(ys)p Fs(,)i(28\(1\),)g(March)f
(1996.)300 4748 y([20])49 b(Z.)32 b(Dittia,)i(J.)f(Cox,)h(and)f(G.)g(P)
o(arulkar)-5 b(.)61 b(Design)32 b(of)h(the)f(APIC:)i(A)e(high)g
(performance)i(A)-11 b(TM)515 4897 y(host-netw)o(ork)34
b(interf)o(ace)i(chip.)69 b(In)36 b Fq(The)g(Pr)l(oceedings)e(of)h
(IEEE)g(INFOCOM)i(1995)p Fs(,)g(pages)515 5047 y(179\226187,)23
b(1995.)p eop
%%Page: 244 264
244 263 bop 3751 100 a Fs(244)300 249 y([21])49 b(Z.)23
b(Dittia,)g(J.)g(Cox,)h(and)f(G.)h(P)o(arulkar)-5 b(.)32
b(Design)23 b(and)h(implementation)d(of)i(a)h(v)o(ersatile)f(multime-)
515 398 y(dia)g(netw)o(ork)g(interf)o(ace)h(and)g(I/O)g(chip.)32
b(In)24 b Fq(Pr)l(oceedings)e(of)h(the)h(6th)f(International)e(W)-9
b(orkshop)515 548 y(on)24 b(Network)g(and)g(Oper)o(ating)e(Systems)i
(Support)f(for)g(Digital)g(A)n(udio)g(and)h(V)-7 b(ideo)p
Fs(,)23 b(April)h(1996.)300 780 y([22])49 b(Z.)26 b(Dittia,)h(G.)f(P)o
(arulkar)l(,)h(and)g(J.)g(Cox.)42 b(The)26 b(APIC)i(approach)f(to)f
(high)g(performance)i(netw)o(ork)515 930 y(interf)o(ace)f(design:)34
b(Protected)28 b(DMA)e(and)h(other)g(techniques.)42 b(In)27
b Fq(The)h(Pr)l(oceedings)e(of)g(IEEE)515 1079 y(INFOCOM)f(1997)p
Fs(,)g(1997.)300 1311 y([23])49 b(P)-11 b(.)38 b(Druschel.)79
b Fq(Oper)o(ating)36 b(System)i(Support)f(for)g(High-Speed)h
(Networking)p Fs(.)79 b(PhD)38 b(thesis,)515 1461 y(Uni)n(v)o(ersity)22
b(of)j(Arizona,)g(August)f(1994.)300 1693 y([24])49 b(P)-11
b(.)25 b(Druschel)f(and)g(L.)h(Peterson.)35 b(Fb)n(ufs:)30
b(A)25 b(high-bandwidth)d(cross-domain)h(transfer)i(f)o(acility)-6
b(.)515 1843 y(In)26 b Fq(Pr)l(oceedings)e(of)h(the)h(F)-10
b(ourteenth)24 b(A)m(CM)i(Symposium)f(on)g(Oper)o(ating)f(Systems)i
(Principles)p Fs(,)515 1992 y(December)f(1993.)300 2224
y([25])49 b(J.)87 b(Dyson,)101 b(D.)88 b(Greenman,)102
b(et)87 b(al.)235 b(The)88 b(FreeBSD)h(VM)d(system.)234
b(See)515 2374 y Fm(http://www.freebsd.org)20 b Fs(for)25
b(more)f(information.)300 2606 y([26])49 b(K.)21 b(F)o(all.)29
b Fq(A)22 b(P)-8 b(eer)n(-to-P)g(eer)22 b(I/O)f(System)h(in)f(Support)f
(of)i(I/O)f(Intensive)h(W)-9 b(orkloads)p Fs(.)27 b(PhD)22
b(thesis,)515 2756 y(Uni)n(v)o(ersity)g(of)j(California,)g(San)g(Die)o
(go,)f(1994.)300 2988 y([27])49 b(K.)32 b(F)o(all)g(and)g(J.)h(P)o
(asquale.)59 b(Exploiting)31 b(in-k)o(ernel)h(data)g(paths)g(to)g
(impro)o(v)o(e)e(I/O)j(throughput)515 3137 y(and)23 b(CPU)h(a)n(v)n
(ailability)-6 b(.)29 b(In)24 b Fq(Pr)l(oceedings)d(of)i(USENIX)g(W)-5
b(inter)22 b(Confer)l(ence)p Fs(,)i(pages)f(327\226333.)515
3287 y(USENIX,)i(January)g(1993.)300 3519 y([28])49 b(R.)32
b(Gingell,)h(J.)f(Moran,)h(and)f(W)-9 b(.)32 b(Shannon.)58
b(V)-6 b(irtual)32 b(memory)f(architecture)h(in)g(SunOS.)59
b(In)515 3669 y Fq(Pr)l(oceedings)23 b(of)i(USENIX)g(Summer)f(Confer)l
(ence)p Fs(,)h(pages)g(81\22694.)f(USENIX,)h(June)g(1987.)300
3901 y([29])49 b(R.)20 b(Gopalakrishnan)f(and)h(G.)g(P)o(arulkar)-5
b(.)26 b(Bringing)19 b(real-time)h(scheduling)f(theory)h(and)g
(practice)515 4051 y(closer)25 b(for)g(multimedia)d(computing.)34
b(In)25 b Fq(Pr)l(oceedings)f(A)m(CM)h(SIGMETRICS)p Fs(,)g(May)g(1996.)
300 4283 y([30])49 b(The)24 b(Open)h(Group.)35 b Fq(The)25
b(Single)f(UNIX)h(Speci\002cation,)e(V)-11 b(er)o(sion)23
b(2)p Fs(.)36 b(The)24 b(Open)h(Group,)f(1998.)515 4432
y(See)i Fm(http://www.UNIX-systems.org)o(/onli)o(ne.h)o(tml)p
Fs(.)300 4665 y([31])49 b(G.)30 b(Hamilton)e(and)i(P)-11
b(.)31 b(K)m(ougiouris.)50 b(The)30 b(Spring)g(nucleus:)40
b(A)30 b(microk)o(ernel)g(for)g(objects.)52 b(In)515
4814 y Fq(Pr)l(oceedings)23 b(of)i(USENIX)g(Summer)f(Confer)l(ence)p
Fs(,)h(pages)g(147\226160.)f(USENIX,)h(June)f(1993.)300
5047 y([32])49 b(J.)38 b(Hennessy)g(and)g(D.)h(P)o(atterson.)78
b Fq(Computer)39 b(Ar)l(c)o(hitectur)l(e:)57 b(A)38 b(Quantitative)f
(Appr)l(oac)o(h)p Fs(.)515 5196 y(Mor)n(gan)24 b(Kaufmann,)g(San)h
(Francisco,)h(CA,)f(2nd)f(edition,)g(1996.)p eop
%%Page: 245 265
245 264 bop 3751 100 a Fs(245)300 249 y([33])49 b(Berk)o(ele)o(y)80
b(Softw)o(are)h(Design)f(Inc.)214 b(The)80 b(BSD/OS)h(operating)f
(system.)212 b(See)515 398 y Fm(http://www.bsdi.com)20
b Fs(for)25 b(more)g(information.)300 631 y([34])49 b(M.)25
b(Kaashoek,)h(D.)g(Engler)l(,)f(G.)h(Ganger)l(,)g(M.)f(Brice)8
b(\230)-41 b(no,)27 b(R.)f(Hunt,)f(D.)h(Mazi)6 b(\036)-39
b(eres,)26 b(T)-7 b(.)25 b(Pinckne)o(y)-6 b(,)515 780
y(R.)24 b(Grimm,)f(J.)g(Jannotti,)g(and)g(K.)h(Mack)o(enzie.)33
b(Application)23 b(performance)h(and)g(\003e)o(xibility)d(on)515
930 y(e)o(xok)o(ernel)k(systems.)39 b(In)26 b Fq(Pr)l(oceedings)e(of)i
(the)g(Sixteenth)f(Symposium)g(on)h(Oper)o(ating)e(System)515
1079 y(Principles)p Fs(,)f(October)i(1997.)300 1311 y([35])49
b(Y)-13 b(.)36 b(Khalidi)f(and)g(M.)h(Nelson.)70 b(The)36
b(Spring)g(virtual)f(memory)g(system.)70 b(T)-7 b(echnical)36
b(Report)515 1461 y(SMLI)25 b(TR-93-09,)f(Sun)h(Microsystems)e
(Laboratories,)i(Inc.,)f(February)i(1993.)300 1693 y([36])49
b(S.)28 b(Lef)n(\003er)l(,)g(M.)f(McK)o(usick,)g(M.)g(Karels,)h(and)g
(J.)f(Quarterman.)44 b Fq(The)28 b(Design)f(and)g(Implemen-)515
1843 y(tation)c(of)i(the)f(4.3BSD)g(Oper)o(ating)f(System)p
Fs(.)36 b(Addison-W)-8 b(esle)o(y)i(,)22 b(1989.)300
2075 y([37])49 b(J.)27 b(Liedtk)o(e.)45 b(Impro)o(ving)26
b(IPC)j(by)f(k)o(ernel)g(design.)45 b(In)28 b Fq(Pr)l(oceedings)e(of)i
(the)f(F)-10 b(ourteenth)27 b(A)m(CM)515 2224 y(Symposium)c(on)i(Oper)o
(ating)e(Systems)h(Principles)p Fs(,)g(pages)g(175\226188,)g(1993.)300
2457 y([38])49 b(J.)e(Liedtk)o(e,)52 b(K.)c(Elphinstone,)j(S.)d(Sch)8
b(\250)-41 b(onber)n(g,)53 b(H.)48 b(H)6 b(\250)-39 b(artig,)52
b(H.)c(Gernot,)k(N.)c(Islam,)k(and)515 2606 y(T)-7 b(.)33
b(Jae)o(ger)-5 b(.)62 b(Achie)n(v)o(ed)33 b(IPC)h(performance.)64
b(In)33 b Fq(Pr)l(oceedings)f(of)h(Hot)g(T)-9 b(opics)33
b(in)g(Oper)o(ating)515 2756 y(Systems)24 b(\(HotOS\))h(1997)p
Fs(,)f(pages)g(28\22631,)g(1997.)300 2988 y([39])49 b(M.)26
b(McK)o(usick,)h(K.)f(Bostic,)i(M.)e(Karels,)i(and)f(J.)g(Quarterman.)
42 b Fq(The)28 b(Design)e(and)h(Implemen-)515 3137 y(tation)c(of)i(the)
f(4.4BSD)g(Oper)o(ating)f(System)p Fs(.)36 b(Addison)23
b(W)-8 b(esle)o(y)i(,)24 b(1996.)300 3370 y([40])49 b(L.)38
b(McV)-13 b(o)o(y)38 b(and)h(C.)g(Staelin.)79 b(lmbench:)57
b(Portable)39 b(tools)e(for)i(performance)g(analysis.)79
b(In)515 3519 y Fq(Pr)l(oceedings)23 b(of)i(USENIX)g(Confer)l(ence)p
Fs(,)g(pages)g(279\226294.)e(USENIX,)i(1996.)300 3752
y([41])49 b(F)-8 b(.)39 b(Miller)-5 b(.)78 b Fq(Input/Output)37
b(System)h(Design)g(F)-10 b(or)37 b(Str)l(eaming)p Fs(.)79
b(PhD)39 b(thesis,)i(Uni)n(v)o(ersity)36 b(of)515 3901
y(Maryland,)24 b(1998.)300 4134 y([42])49 b(F)-8 b(.)22
b(Miller)e(and)i(S.)g(T)m(ripathi.)27 b(An)21 b(inte)o(grated)g
(input/output)e(system)h(for)i(k)o(ernel)g(data)f(streaming.)515
4283 y Fq(Multimedia)i(Computing)h(and)g(Networking)p
Fs(,)h(1998.)300 4515 y([43])49 b(R.)32 b(Minnich.)55
b(Mether)n(-NFS:)32 b(A)g(modi\002ed)f(NFS)h(which)f(supports)f
(virtual)h(shared)h(memory)-6 b(.)515 4665 y(In)23 b
Fq(Pr)l(oceedings)f(of)g(USENIX)i(Experiences)f(with)f(Distrib)n(uted)f
(and)i(Multipr)l(ocessor)e(Systems)515 4814 y(\(SEDMS)j(IV\))p
Fs(,)h(September)g(1993.)300 5047 y([44])49 b(J.)21 b(Mitchell,)g(J.)h
(Gibbons,)f(G.)h(Hamilton,)f(P)-11 b(.)22 b(K)n(essler)l(,)g(Y)-13
b(.)22 b(Khalidi,)f(P)-11 b(.)22 b(K)m(ougiouris,)e(P)-11
b(.)23 b(Madan)o(y)-6 b(,)515 5196 y(M.)24 b(Nelson,)g(M.)g(Po)n(well,)
g(and)h(S.)g(Radia.)35 b(An)25 b(o)o(v)o(ervie)n(w)e(of)i(the)f(Spring)
g(system.)35 b(In)24 b Fq(Pr)l(oceed-)515 5345 y(ings)g(of)g(Compcon)h
(Spring)f(1994)p Fs(,)g(February)h(1994.)p eop
%%Page: 246 266
246 265 bop 3751 100 a Fs(246)300 249 y([45])49 b(A.)37
b(Montz,)i(D.)f(Mosber)n(ger)l(,)i(S.)d(O'Malle)o(y)-6
b(,)39 b(L.)e(Peterson,)k(and)c(T)-7 b(.)37 b(Proebsting.)75
b(Scout:)55 b(A)515 398 y(communications-oriented)22
b(operating)j(system.)35 b(In)25 b Fq(Pr)l(oceedings)f(of)g(Hot)h(T)-9
b(opics)24 b(in)h(Oper)o(at-)515 548 y(ing)f(Systems)g(\(HotOS\))h
(1995)p Fs(,)f(1995.)300 780 y([46])49 b(J.)22 b(Moran.)30
b(SunOS)23 b(virtual)f(memory)g(implementation.)28 b(In)23
b Fq(Pr)l(oceedings)e(of)h(the)g(Spring)g(1988)515 930
y(Eur)l(opean)h(UNIX)i(User)o(s)g(Gr)l(oup)e(Confer)l(ence)p
Fs(,)j(April)e(1988.)300 1162 y([47])49 b(D.)27 b(Mosber)n(ger)f(and)h
(L.)g(Peterson.)42 b(Making)26 b(paths)h(e)o(xplicit)e(in)h(the)h
(Scout)g(operating)f(system.)515 1311 y(In)f Fq(OSDI)f(1996)p
Fs(,)g(pages)h(153\226168,)f(1996.)300 1544 y([48])49
b(M.)43 b(Nelson.)96 b(V)-6 b(irtual)43 b(memory)g(for)i(the)e(Sprite)h
(operating)f(system.)96 b(T)-7 b(echnical)44 b(Report)515
1693 y(UCB/CSD)f(86/301,)h(Computer)d(Science)h(Di)n(vision,)i(EECS)e
(Department,)j(Uni)n(v)o(ersity)39 b(of)515 1843 y(California,)25
b(Berk)o(ele)o(y)-6 b(,)24 b(June)h(1986.)300 2075 y([49])49
b(M.)28 b(Nelson)g(and)g(J.)g(Ousterhout.)47 b(Cop)o(y-on-write)28
b(for)h(Sprite.)47 b(In)29 b Fq(Pr)l(oceedings)e(of)h(USENIX)515
2224 y(Summer)c(Confer)l(ence)p Fs(.)i(USENIX,)f(June)f(1988.)300
2457 y([50])49 b(J.)30 b(Ousterhout.)54 b(Why)30 b(aren')n(t)h
(operating)f(systems)g(getting)f(f)o(aster)i(as)g(f)o(ast)g(as)g(hardw)
o(are?)73 b(In)515 2606 y Fq(Pr)l(oceedings)23 b(of)i(USENIX)g(Summer)f
(Confer)l(ence)p Fs(,)h(pages)g(247\226256.)f(USENIX,)h(1990.)300
2839 y([51])49 b(J.)29 b(Ousterhout,)h(A.)f(Cherenson,)i(F)-8
b(.)30 b(Douglis,)g(M.)f(Nelson,)h(and)f(B.)h(W)-8 b(elch.)52
b(The)29 b(Sprite)h(net-)515 2988 y(w)o(ork)24 b(operating)h(system.)34
b Fq(Computer)p Fs(,)24 b(21\(2\):23\22636,)g(February)h(1988.)300
3221 y([52])49 b(V)-13 b(.)22 b(P)o(ai,)g(P)-11 b(.)23
b(Druschel,)f(and)g(W)-9 b(.)22 b(Zw)o(aenepoel.)30 b(IO-Lite:)f(A)22
b(uni\002ed)g(I/O)g(b)n(uf)n(fering)f(and)h(caching)515
3370 y(system.)31 b(T)-7 b(echnical)23 b(Report)g(TR97-294,)g
(Department)g(of)g(Computer)g(Science,)h(Rice)g(Uni)n(v)o(er)n(-)515
3519 y(sity)-6 b(,)23 b(1997.)300 3752 y([53])49 b(J.)26
b(P)o(asquale,)h(E.)f(Anderson,)g(and)g(P)-11 b(.)27
b(Muller)-5 b(.)40 b(Container)26 b(Shipping:)33 b(Operating)26
b(system)f(sup-)515 3901 y(port)f(for)h(I/O)g(intensi)n(v)o(e)e
(applications.)34 b Fq(Computer)p Fs(,)24 b(27\(3\),)h(March)g(1994.)
300 4134 y([54])49 b(The)119 b(NetBSD)h(Project.)337
b(The)120 b(NetBSD)f(operating)g(system.)336 b(See)515
4283 y Fm(http://www.netbsd.org)20 b Fs(for)25 b(more)g(information.)
300 4515 y([55])49 b(The)106 b(OpenBSD)h(Project.)298
b(The)106 b(OpenBSD)h(operating)f(system.)296 b(See)515
4665 y Fm(http://www.openbsd.org)20 b Fs(for)25 b(more)f(information.)
300 4897 y([56])49 b(S.)25 b(Rago.)36 b Fq(Unix)25 b(System)f(V)h
(Network)g(Pr)l(o)o(gr)o(amming)p Fs(.)33 b(Addison-W)-8
b(esle)o(y)i(,)23 b(1993.)300 5130 y([57])49 b(R.)30
b(Rashid,)h(A.)e(T)-7 b(e)n(v)n(anian,)30 b(M.)f(Y)-11
b(oung,)30 b(D.)g(Golub,)g(R.)g(Baron,)h(D.)f(Black,)h(W)-9
b(.)30 b(Bolosk)o(y)-6 b(,)29 b(and)515 5279 y(J.)e(Che)n(w)-6
b(.)45 b(Machine-independent)26 b(virtual)h(memory)g(management)g(for)h
(paged)g(uniprocessor)p eop
%%Page: 247 267
247 266 bop 3751 100 a Fs(247)515 249 y(and)32 b(multiprocessor)f
(architectures.)59 b Fq(IEEE)32 b(T)-5 b(r)o(ansactions)30
b(on)i(Computing)p Fs(,)h(37\(8\),)h(August)515 398 y(1988.)300
629 y([58])49 b(D.)19 b(Ritchie.)24 b(A)19 b(stream)h(input-output)d
(system.)23 b Fq(A)l(T&T)d(Bell)f(Labor)o(atories)e(T)-9
b(ec)o(hnical)19 b(J)n(ournal)p Fs(,)515 778 y(63\(8\):1897\2261910,)j
(October)j(1984.)300 1008 y([59])49 b(C.)36 b(Schimmel.)70
b Fq(Unix)35 b(System)h(for)f(Modern)g(Ar)l(c)o(hitectur)l(es:)52
b(Symmetric)35 b(Multipr)l(ocessing)515 1157 y(and)24
b(Cac)o(hing)g(for)g(K)m(ernel)h(Pr)l(o)o(gr)o(ammer)o(s)p
Fs(.)33 b(Addison-W)-8 b(esle)o(y)i(,)23 b(1994.)300
1387 y([60])49 b(D.)36 b(Schmidt.)71 b(The)36 b(adapti)n(v)o(e)f
(communications)e(en)l(vironment:)52 b(Object-oriented)36
b(netw)o(ork)515 1537 y(programming)28 b(components)h(for)h(de)n(v)o
(eloping)e(client/serv)o(er)h(applications.)50 b(In)30
b Fq(Pr)l(oceedings)515 1686 y(of)24 b(the)h(12th)f(Sun)h(User)o(s)f
(Gr)l(oup)p Fs(,)g(June)h(1994.)35 b(An)25 b(earlier)h(v)o(ersion)d(of)
j(this)e(paper)h(appeared)g(in)515 1836 y(the)f(11th)g(Sun)h(Users)g
(Group)g(conference.)300 2066 y([61])49 b(M.)25 b(Schroeder)h(and)f(M.)
g(Burro)n(ws.)37 b(The)26 b(performance)g(of)f(Fire\003y)h(RPC.)39
b Fq(A)m(CM)26 b(T)-5 b(r)o(ansactions)515 2215 y(on)24
b(Computer)h(Systems)p Fs(,)f(8\(1\):1\22617,)g(February)h(1990.)300
2445 y([62])49 b(D.)27 b(Solomon.)44 b Fq(Inside)27 b(W)-5
b(indows)27 b(NT)p Fs(.)45 b(Microsoft)27 b(Press,)h(2nd)g(edition,)f
(1998.)44 b(Based)28 b(on)f(the)515 2594 y(\002rst)e(edition)e(by)i
(Helen)g(Custer)-5 b(.)300 2825 y([63])49 b(R.)24 b(Stallman)g(and)g
(Cygnus)g(Support.)34 b Fq(Deb)n(ug)o(ging)23 b(with)h(GDB)p
Fs(.)35 b(The)24 b(Free)h(Softw)o(are)g(F)o(ounda-)515
2974 y(tion,)f(1994.)300 3204 y([64])49 b(A.)21 b(T)-7
b(e)n(v)n(anian.)28 b Fq(Ar)l(c)o(hitectur)l(e-Independent)21
b(V)-7 b(irtual)20 b(Memory)i(Mana)o(g)o(ement)f(for)g(P)-8
b(ar)o(allel)20 b(and)515 3353 y(Distrib)n(uted)28 b(En)l(vir)l
(onments:)40 b(The)31 b(Mac)o(h)f(Appr)l(oac)o(h)p Fs(.)52
b(PhD)31 b(thesis,)f(Carne)o(gie)h(Mellon)e(Uni-)515
3503 y(v)o(ersity)-6 b(,)23 b(December)i(1987.)300 3733
y([65])49 b(M.)20 b(Thadani)g(and)g(Y)-13 b(.)21 b(Khalidi.)k(An)20
b(ef)n(\002cient)h(zero-cop)o(y)f(I/O)h(frame)n(w)o(ork)f(for)h(Unix.)k
(T)-7 b(echnical)515 3882 y(Report)25 b(SMLI)g(TR-95-39,)f(Sun)h
(Microsystems)e(Laboratories,)i(May)f(1995.)300 4112
y([66])49 b(L.)24 b(T)-8 b(orv)n(alds)22 b(et)i(al.)34
b(The)24 b(Linux)f(operating)h(system.)32 b(See)25 b
Fm(http://www.linux.org)20 b Fs(for)515 4262 y(more)k(information.)300
4492 y([67])49 b(S.)27 b(Tzou)f(and)h(D.)f(Anderson.)41
b(The)26 b(performance)h(of)g(message-passing)e(using)h(restricted)g
(vir)n(-)515 4641 y(tual)e(memory)g(remapping.)34 b Fq(Softwar)l(e)25
b(-)f(Pr)o(actice)g(and)g(Experience)p Fs(,)h(21\(3\):251\226267,)e
(March)515 4791 y(1991.)300 5021 y([68])49 b(USL.)66
b Fq(Unix)35 b(System)f(V)g(Release)g(4.2)g(STREAMS)h(Modules)e(and)h
(Driver)o(s)p Fs(.)66 b(Prentice-Hall,)515 5170 y(1992.)300
5400 y([69])49 b(U.)24 b(V)-11 b(ahalia.)36 b Fq(Unix)25
b(Internals:)k(the)c(Ne)o(w)h(F)-5 b(r)l(ontier)o(s)p
Fs(.)33 b(Prentice-Hall,)25 b(1996.)p eop
%%Page: 248 268
248 267 bop 3751 100 a Fs(248)300 249 y([70])49 b(L.)30
b(W)-8 b(all,)33 b(T)-7 b(.)30 b(Christiansen,)h(and)g(R.)h(Schw)o
(artz.)55 b Fq(Pr)l(o)o(gr)o(amming)28 b(P)-8 b(erl)p
Fs(.)55 b(O'Reilly)31 b(and)g(Asso-)515 398 y(ciates,)24
b(Inc.,)h(2nd)g(edition,)e(1996.)300 631 y([71])49 b(M.)70
b(Y)-11 b(oung.)183 b Fq(Exporting)70 b(a)h(User)g(Interface)f(to)h
(Memory)g(Mana)o(g)o(ement)f(fr)l(om)g(a)515 780 y
(Communication-Oriented)32 b(Oper)o(ating)g(System)p
Fs(.)65 b(PhD)34 b(thesis,)i(Carne)o(gie)e(Mellon)f(Uni)n(v)o(er)n(-)
515 930 y(sity)-6 b(,)23 b(No)o(v)o(ember)g(1989.)300
1162 y([72])49 b(M.)38 b(Y)-11 b(oung,)41 b(A.)d(T)-7
b(e)n(v)n(anian,)41 b(R.)e(Rashid,)i(D.)e(Golub,)i(J.)d(Eppinger)l(,)j
(J.)d(Che)n(w)-6 b(,)42 b(W)-9 b(.)38 b(Bolosk)o(y)-6
b(,)515 1311 y(D.)32 b(Black,)k(and)c(R.)i(Baron.)61
b(The)33 b(duality)f(of)h(memory)e(and)i(communication)e(in)h(the)h
(imple-)515 1461 y(mentation)21 b(of)i(a)g(multiprocessor)e(operating)h
(system.)30 b(In)23 b Fq(Pr)l(oceedings)e(of)h(the)h(Ele)o(venth)f(A)m
(CM)515 1610 y(Symposium)h(on)i(Oper)o(ating)e(Systems)h(Principles)p
Fs(,)g(pages)g(63\22676,)g(No)o(v)o(ember)g(1987.)300
1843 y([73])49 b(W)-9 b(.)24 b(Zw)o(aenepoel)h(and)g(D.)g(Johnson.)34
b(The)25 b(Pere)o(grine)g(high-performance)f(RPC)i(system.)35
b Fq(Soft-)515 1992 y(war)l(e)25 b(-)g(Pr)o(actice)f(and)h(Experience)p
Fs(,)g(23\(2\):201\226221,)e(February)i(1993.)p eop
%%Page: 249 269
249 268 bop 3751 100 a Fs(249)1915 292 y Fp(V)-8 b(ita)1663
512 y Fl(Charles)30 b(D.)g(Cranor)417 732 y Fo(Date)25
b(of)g(Birth)321 b Fs(June)25 b(14,)f(1967)417 1038 y
Fo(Place)h(of)g(Birth)293 b Fs(Camden,)25 b(South)g(Carolina)417
1344 y Fo(Degr)n(ees)544 b Fs(B.S.,)26 b(Electrical)e(Engineering,)g
(May)h(1989)1296 1477 y(M.S.)g(Computer)f(Science,)i(May)f(1992)1296
1609 y(D.Sc.)h(Computer)e(Science,)i(August)d(1998)417
1916 y Fo(Pr)n(ofessional)417 2048 y(Societies)1296 1916
y Fs(Association)h(for)h(Computing)e(Machines)1296 2048
y(Institute)h(of)h(Electrical)f(and)h(Electronics)f(Engineers)417
2354 y Fo(Publications)353 b Fs(Gigabit)30 b(CORB)m(A)h(\227)g
(High-Performance)g(Distrib)n(uted)e(Object)i(Com-)1396
2487 y(puting,)43 b(Gigabit)c(Netw)o(orking)g(W)-8 b(orkshop)39
b(\(GBN'96\),)45 b(24)40 b(March)1396 2619 y(1996,)23
b(San)h(Francisco,)h(in)e(conjunction)f(with)h(INFOCOM)h('96)g(\(with)
1396 2752 y(D.)h(Schmidt)f(and)g(G.)h(P)o(arulkar\).)1296
3016 y(Half-Sync/Half-Async:)42 b(A)31 b(Architectural)f(P)o(attern)g
(for)h(Ef)n(\002cient)f(and)1396 3149 y(W)-8 b(ell-structured)31
b(Concurrent)h(I/O,)f(in)g Fq(P)-8 b(attern)31 b(Langua)o(g)o(es)g(of)g
(Pr)l(o-)1396 3281 y(gr)o(am)h(Design)p Fs(,)j(\(Coplien,)g(Vlissides,)
f(and)f(K)n(erth,)i(eds.\),)g(Addison-)1396 3414 y(W)-8
b(esle)o(y)i(,)24 b(Reading,)g(MA,)h(1996)f(\(with)g(D.)h(Schmidt\).)
1296 3679 y(Design)e(of)h(Uni)n(v)o(ersal)e(Continuous)g(Media)h(I/O,)h
(in)f Fq(Pr)l(oceedings)f(of)h(the)1396 3811 y(5th)d(International)f(W)
-9 b(orkshop)19 b(on)i(Network)g(and)g(Oper)o(ating)e(Systems)1396
3943 y(Support)26 b(for)i(Digital)e(A)n(udio)h(and)h(V)-7
b(ideo)27 b Fs(\(NOSSD)l(A)-13 b(V)28 b('95\),)h(pp)f(83\226)1396
4076 y(86,)c(April)h(1995)f(\(with)g(G.)h(P)o(arulkar\).)1296
4341 y(The)33 b(3M)g(Project:)47 b(Multipoint)30 b(Multimedia)h
(Applications)h(on)g(Multi-)1396 4473 y(processor)38
b(W)-8 b(orkstations)36 b(and)i(Serv)o(ers,)j(in)c Fq(Pr)l(oceedings)g
(of)g(IEEE)1396 4605 y(W)-9 b(orkshop)18 b(on)i(High)f(P)-8
b(erformance)19 b(Communication)f(Systems)p Fs(,)i(Sept.)1396
4738 y(1993)f(\(with)g(M.)g(Buddhik)o(ot,)g(Z.)g(Dittia,)h(G.)f(P)o
(arulkar)l(,)i(C.)f(P)o(apadopou-)1396 4870 y(los\).)1296
5135 y(An)25 b(Implementation)f(Model)g(for)i(Connection-Oriented)e
(Internet)h(Pro-)1396 5268 y(tocols,)40 b(in)e Fq(J)n(ournal)f(of)g
(Internetworking:)57 b(Resear)l(c)o(h)38 b(and)f(Experi-)1396
5400 y(ence)p Fs(,)25 b(V)-13 b(ol.)31 b(4.,)24 b(pp)h(133\226157,)e
(Sept.)31 b(1993)24 b(\(with)g(G.)h(P)o(arulkar\).)p
eop
%%Page: 250 270
250 269 bop 3751 100 a Fs(250)1296 249 y(An)25 b(Implementation)f
(Model)g(for)i(Connection-Oriented)e(Internet)h(Pro-)1396
381 y(tocols,)i Fq(Pr)l(oceedings)e(of)i(IEEE)g(INFOCOM)h('93)p
Fs(,)g(V)-13 b(ol.)37 b(3,)28 b(pp)f(1135\226)1396 514
y(1143,)d(April)g(1993)g(\(with)h(G.)f(P)o(arulkar\).)1296
779 y(An)h(Implementation)f(Model)g(for)i(Connection-Oriented)e
(Internet)h(Pro-)1396 911 y(tocols,)c(M.S.)f(thesis,)h(Department)f(of)
h(Computer)g(Science,)h(Se)n(v)o(er)f(In-)1396 1044 y(stitute)29
b(of)h(T)-7 b(echnology)h(,)30 b(W)-8 b(ashington)29
b(Uni)n(v)o(ersity)-6 b(,)29 b(St.)47 b(Louis,)31 b(Mis-)1396
1176 y(souri,)24 b(May)g(1992.)3388 1416 y(August)g(1998)p
eop
%%Trailer
end
userdict /end-hook known{end-hook}if
%%EOF
